---
id: prd-okr-validation-integration
version: 1.0.0
created: 2026-02-22
updated: 2026-02-22
changelog:
  - 1.0.0: 初始版本
---

# PRD: OKR Validator 接入主链路 + CI

## 背景

v1.60.0 完成了 L0 验证器模块（validate-okr-structure.js），但还没接入任何实际流程。
需要将 validator 接入两个位置：
1. **运行时**：decomposition-checker 入库前调用，BLOCK → 阻止创建
2. **CI**：GitHub Actions workflow 加 check-okr-structure.mjs 步骤

## 目标

1. decomposition-checker.js 的 `createDecompositionTask()` 调用 validator → BLOCK 时 skip
2. GitHub Actions CI workflow 添加 OKR 结构检查步骤

## 设计

### 运行时接入（decomposition-checker.js）

在 `createDecompositionTask()` 调用前，对目标 KR 执行 scope='kr' 验证：

```js
// 在 createDecompositionTask 之前
const validation = await validateOkrStructure(pool, { scope: 'kr', rootId: krId });
if (!validation.ok) {
  console.log(`[DECOMP] OKR 结构验证失败 (${validation.issues.filter(i=>i.level==='BLOCK').length} blocks), 跳过拆解`);
  return null;
}
```

位置：每个 Check (1-7) 的创建路径前。
策略：只在真正要创建 decomp task 时才验证（避免无谓的 DB 查询）。

### CI 接入（GitHub Actions）

在 `.github/workflows/brain.yml` 中添加步骤：

```yaml
- name: OKR Structure Check
  run: node scripts/devgate/check-okr-structure.mjs
  env:
    DATABASE_URL: ${{ env.DATABASE_URL }}
  continue-on-error: true  # 初期 WARNING only，不阻止 CI
```

初期使用 `continue-on-error: true`，等数据质量稳定后再改为 hard gate。

## 功能描述

1. decomposition-checker.js 在每次 runDecompositionChecks 开头运行全量验证，收集 BLOCK 实体 ID
2. createDecompositionTask 检查 goalId 是否被 BLOCK → 跳过创建
3. CI workflow 添加 OKR 结构检查步骤（初期 continue-on-error）

## 成功标准

- BLOCK 实体的拆解任务不会被创建
- validator 异常时不阻止主流程
- CI 中可以看到 OKR 结构检查的输出

## 不做

- 不修改 validator 本身的逻辑
- 不改变现有 check 的判断逻辑（capacity gate 等）
- 不做 L1/L2 语义检查
