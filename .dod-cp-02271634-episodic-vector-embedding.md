---
id: dod-episodic-vector-embedding
version: 1.0.0
created: 2026-02-27
changelog:
  - 1.0.0: 初始版本
---

# DoD：情景记忆向量化融合

## 验收清单

- [ ] D1: Migration 084 存在且正确
  - Test: `084_memory_stream_embedding.sql` 包含 `ALTER TABLE memory_stream ADD COLUMN IF NOT EXISTS embedding vector(1536)`
  - Test: migration 自动应用后 selfcheck schema 版本为 084

- [ ] D2: embedding-service.js 新增 `generateMemoryStreamEmbeddingAsync(recordId, text, pool)`
  - Test: 函数调用 `generateEmbedding(text)` 并 UPDATE memory_stream SET embedding

- [ ] D3: reflection.js 写入 memory_stream 后 fire-and-forget 生成 embedding
  - Test: INSERT 成功后有 `generateMemoryStreamEmbeddingAsync(id, content, pool)` 调用

- [ ] D4: searchEpisodicMemory() 优先向量搜索
  - Test: 当 `embedding IS NOT NULL` 记录存在时，使用 `<=>` pgvector 运算符
  - Test: 无 embedding 时自动降级到现有 Jaccard 逻辑

- [ ] D5: selfcheck.js EXPECTED_SCHEMA_VERSION = '084'

- [ ] D6: 3 个测试文件中的 schema 版本更新为 084

- [ ] D7: memory-retriever.test.js 新增 searchEpisodicMemory 向量搜索测试
  - Test: mock 返回有 embedding 的记录 → 走向量路径
  - Test: mock 返回无 embedding 记录 → 降级 Jaccard

- [ ] D8: `npm test` 全部通过
