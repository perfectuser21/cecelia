---
id: prd-episodic-vector-embedding
version: 1.0.0
created: 2026-02-27
changelog:
  - 1.0.0: 初始版本
---

# PRD：情景记忆向量化融合

## 背景

v1.115.0 为 memory_stream 添加了 L0/L1 分层检索，但使用 Jaccard 关键词匹配。
系统已有完整向量基础设施（pgvector、openai-client.js、similarity.js），
但 memory_stream 从未接入向量搜索，导致：
- 跨语义命中不可能（"感悟"无法命中"聪慧的瘫痪"洞察）
- 只靠前3条兜底机制而非真正相关性

## 目标

将 memory_stream 接入现有向量基础设施，实现 OpenViking 级别的语义情景记忆检索。

## 范围

### 1. Migration 084：memory_stream 加 embedding 列
- 添加 `embedding vector(1536)` 列
- 为历史数据的高重要性记录异步回填（可选，后台任务）

### 2. 写入时自动生成 embedding（fire-and-forget）
- `reflection.js`：写入 memory_stream 时异步生成 embedding
- `learning.js`：写入 learnings 时异步生成 embedding（已有列，未用）
- 不阻塞写入主流程（用 .then().catch() 异步）

### 3. searchEpisodicMemory() 改为向量搜索
- 优先用向量搜索（embedding IS NOT NULL 的记录）
- 降级：无 embedding 时用现有 Jaccard 兜底
- 使用已有 openai-client.generateEmbedding() + pgvector <=> 运算符

## 成功标准

- 问"你有什么深层感悟" → 能命中"聪慧的瘫痪"洞察（语义相近，词不同）
- 新写入的 memory_stream 记录在5秒内有 embedding
- 无 OpenAI key 时优雅降级到 Jaccard
- 所有现有测试通过
