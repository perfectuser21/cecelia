---
id: prd-ws-origin-fix
version: 1.0.0
created: 2026-02-26
updated: 2026-02-26
changelog:
  - 1.0.0: 初始版本
---

# PRD: WebSocket Origin 修复 + Frontend Proxy 架构升级

## 背景

CeceliaPage 显示"离线"状态，用户从 Mac 通过 Tailscale (`http://perfect21:5211`) 访问时 WebSocket 连接建立后 ~1 秒即断开。

## 根因分析

1. **WebSocket Origin 被拒绝**：Brain 的 `ALLOWED_ORIGINS` 只包含 `localhost:5211/5212` 和公网域名，不包含 `http://perfect21:5211`（Tailscale hostname）。frontend-proxy.js 的 TCP tunnel 转发 WS 升级请求时保留了原始 Origin header，Brain 检查后返回 `1008 Unauthorized origin` 关闭连接。

2. **server.ts ws:true 冲突**：`orchestratorProxy` 配置了 `ws: true`，http-proxy-middleware v3 会自动注册 `server.on('upgrade')` 监听器，拦截所有 WS 升级请求（包括 `/api/brain/ws`），导致 400 Bad Request。

3. **Frontend Proxy 架构过时**：原先 frontend-proxy.js 在 5212 端口作为静态文件服务器，API 走 PM2 cecelia-core（5211）。迁移到 monorepo 后 PM2 启动路径已过时，需要简化为 frontend-proxy 直接代理到 Brain（5221）。

## 修复方案

### frontend-proxy.js 重写
- 端口从 5212 改为 5211（取代 PM2 成为唯一入口）
- 直接代理到 Brain 5221（不再经过 PM2）
- WS 升级时改写 Origin/Host header 为 localhost，通过 Brain origin 检查
- 支持 /api/brain/* 直接转发 + /api/* 路径改写

### server.ts 修复
- 移除 orchestratorProxy 的 `ws: true`，避免自动注册 upgrade 监听器
- WebSocket 升级完全由手动 `server.on('upgrade')` 处理

## 成功标准

- 用户从 `http://perfect21:5211` 访问时 WebSocket 持续连接不断开
- CeceliaPage 显示"在线"状态
- Brain 日志不再出现 "Rejected connection from unauthorized origin"
