---
id: prd-fix-desires-type-check
version: 1.0.0
created: 2026-03-01
updated: 2026-03-01
changelog:
  - 1.0.0: 初始版本
---

# PRD: 修复 desires_type_check 约束缺少 act/follow_up/explore

## 背景

PR #189（三环意识架构）在 `desire-formation.js` 中新增了 `explore` 欲望类型，
但 `desires` 表的 `desires_type_check` CHECK 约束未同步更新。
同时发现 `act` 和 `follow_up` 也早已存在于 VALID_TYPES 但从未加入约束。

**现象**：Brain 日志持续报错：
```
[desire-formation] insert error: new row for relation "desires" violates check constraint "desires_type_check"
```

## 目标

添加 migration 094，将 `desires_type_check` 约束更新为与代码 VALID_TYPES 完全对齐：
`inform`, `propose`, `warn`, `celebrate`, `question`, `act`, `follow_up`, `explore`

## 范围

- 新增 `packages/brain/migrations/094_fix_desires_type_check.sql`
- 更新 `packages/brain/src/selfcheck.js` EXPECTED_SCHEMA_VERSION：093 → 094
- 更新相关测试文件中的 schema 版本断言（3 个文件）
- 更新 DEFINITION.md Brain 版本和 Schema 版本
- 更新版本文件（package.json patch bump）

## 不在范围

- 不改 desire-formation.js（类型已正确）
- 不改其他任何逻辑代码

## 成功标准

- migration 094 应用后，desires 表可以插入 act/follow_up/explore 类型记录
- facts-check 通过（schema_version=094 与 DEFINITION.md 一致）
- version-sync 通过
- Brain CI 通过
