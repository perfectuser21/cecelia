# DoD - RNA KR 进度自动回写闭环

## 验收标准

### 功能验收
- [ ] Task 完成时自动触发 KR 进度计算
      Test: packages/brain/src/__tests__/kr-progress-task-callback.test.js
- [ ] KR 进度基于 Initiative 完成率正确计算（completed initiatives / countable initiatives * 100）
      Test: packages/brain/src/__tests__/kr-progress-task-callback.test.js
- [ ] 进度更新写入 PostgreSQL `goals.progress` 字段
      Test: packages/brain/src/__tests__/kr-progress-task-callback.test.js
- [ ] execution-callback API 调用 kr-progress.updateKrProgress()
      Test: packages/brain/src/__tests__/kr-progress-task-callback.test.js
- [ ] 移除旧的基于 task.goal_id 的 KR 进度计算逻辑
      Test: manual:grep -n "task.goal_id" packages/brain/src/routes.js | grep -v "comment" | wc -l  # 应为 0

### 测试验收
- [ ] npm run qa 通过（所有现有测试保持通过）
      Test: contract:C2-001
- [ ] 新增单元测试覆盖 Task → KR 进度回写逻辑
      Test: packages/brain/src/__tests__/kr-progress-task-callback.test.js
- [ ] 测试覆盖完整数据链路：Task (project_id) → Initiative (parent_id) → Project → KR (project_kr_links)
      Test: packages/brain/src/__tests__/kr-progress-task-callback.test.js

### 集成验收
- [ ] 实际 Task 执行完成后，关联 KR 的 progress 字段自动更新
      Test: manual:curl -s http://localhost:5221/api/brain/execution-callback -X POST -H "Content-Type: application/json" -d '{"task_id":"<test_task_id>","status":"AI Done"}' && curl -s http://localhost:5221/api/okr/goals/<kr_id> | jq -e '.progress > 0'
- [ ] RNA KR 从 0% 更新到基于实际完成任务数的真实进度
      Test: manual:查询 RNA KR 的 progress 字段，确认不再是 0%

### 代码质量
- [ ] 复用现有 kr-progress.js 模块，不重复实现
      Test: manual:grep -r "updateKrProgress" packages/brain/src/routes.js
- [ ] 不破坏现有 execution-callback 的其他逻辑（事务完整性、WebSocket 通知等）
      Test: contract:C2-001（现有所有测试通过）
