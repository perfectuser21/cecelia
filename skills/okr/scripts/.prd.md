---
id: validate-okr-info-gate
version: 1.0.0
created: 2026-02-24
updated: 2026-02-24
changelog:
  - 1.0.0: 初始版本
---

# PRD: validate-okr.py 信息收集门禁扩展

## 背景

OKR 拆解时存在一个根本问题：AI 没有收集到足够信息就开始拆解，导致产出全是基于假设的垃圾。需要在 validate-okr.py 里加入硬性门禁，确保 output.json 中每个关键字段：
1. 存在且有值（不是 null / 空字符串 / "未知" / "待定"）
2. 来源是 user_confirmed 或 ai_explored，不能是 assumed

## 功能描述/需求（成功标准）

### 新增：信息完整性检查（Information Gate）

在现有验证之前新增一层检查。

**output.json 的字段来源标注格式**：

每个关键字段旁边需要有对应的 `_source` 字段：
- `user_confirmed` — 用户明确告知
- `ai_explored` — AI 从代码/DB 探索获得
- `assumed` — AI 假设的（**不允许**）

**按层级检查不同的必填字段**：

```json
// Layer 3: KR 时必须有
{
  "identified_layer": "kr",
  "metric_from": 60,
  "metric_from_source": "user_confirmed",
  "metric_to": 85,
  "metric_to_source": "user_confirmed",
  "measurement_method": "每日统计任务完成率",
  "measurement_method_source": "user_confirmed",
  "repos_involved": ["cecelia-core", "cecelia-brain"],
  "repos_involved_source": "ai_explored"
}

// Layer 4: Project 时必须有
{
  "identified_layer": "project",
  "current_state": "Brain 目前没有 code_review 任务类型的 callback handler...",
  "current_state_source": "ai_explored",
  "repos": ["/home/xx/perfect21/cecelia/core"],
  "repos_source": "ai_explored",
  "out_of_scope": "不包含 Dashboard 展示层的修改",
  "out_of_scope_source": "user_confirmed"
}

// Layer 5: Initiative 时必须有
{
  "identified_layer": "initiative",
  "target_repo": "/home/xx/perfect21/cecelia/core",
  "target_repo_source": "user_confirmed",
  "current_implementation": "routes.js 目前处理 task_type=review 但不处理 code_review",
  "current_implementation_source": "ai_explored"
}
```

**验证规则**：
1. 检查 `identified_layer` 字段判断是哪层
2. 根据层级加载对应的必填字段清单
3. 对每个必填字段检查：
   - 字段存在 → 否则 exit code 2
   - 字段有值（不是 null、""、"未知"、"待定"、"TBD"、"TODO"）→ 否则 exit code 2
   - 对应的 `_source` 字段存在 → 否则 exit code 2
   - `_source` 值不是 `"assumed"` → 否则 exit code 2（这是最关键的）

**Exit codes**：
- `0` = 通过
- `1` = 质量不够（现有逻辑）
- `2` = 硬性约束违反（信息门禁或已有的 constraint check）

## 不做的事

- 不改现有的 form validation 逻辑
- 不改 capability 检查逻辑
- 只在现有流程最前面加一层 info gate check

## 交付物

1. `validate-okr.py` — 新增 `check_information_gate()` 函数
2. `tests/test_validate_okr_info_gate.py` — 单元测试
