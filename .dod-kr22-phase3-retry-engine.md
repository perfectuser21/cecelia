# DoD - Phase 3: 重试引擎与状态管理 - KR2.2

QA: docs/QA-DECISION.md

## 验收标准

### 功能验收

#### 1. RetryEngine（重试引擎）
- [ ] RetryEngine 能够检测可重试错误并执行指数退避重试
      Test: tests/services/retry/RetryEngine.test.ts
- [ ] 重试次数和间隔可配置（环境变量或配置文件）
      Test: tests/services/retry/RetryEngine.test.ts
- [ ] 重试失败时记录详细日志（错误类型、重试次数、间隔时间）
      Test: tests/services/retry/RetryEngine.test.ts

#### 2. 状态管理 API
- [ ] GET /api/publish/status/:taskId - 查询任务状态返回正确数据
      Test: tests/routes/publish.test.ts
- [ ] GET /api/publish/tasks - 列出所有发布任务
      Test: tests/routes/publish.test.ts
- [ ] POST /api/publish/retry/:taskId - 手动触发重试功能正常
      Test: tests/routes/publish.test.ts
- [ ] PATCH /api/publish/cancel/:taskId - 取消发布任务功能正常
      Test: tests/routes/publish.test.ts
- [ ] WebSocket 能够推送状态变更事件
      Test: tests/routes/publish.test.ts

#### 3. BullMQ 集成
- [ ] BullMQ 队列正确配置，任务持久化到 Redis
      Test: tests/queues/publish-queue.test.ts
- [ ] 并发控制生效：同时最多执行 N 个发布任务（N 可配置）
      Test: tests/queues/publish-queue.test.ts
- [ ] 任务优先级设置生效（P0 > P1 > P2）
      Test: tests/queues/publish-queue.test.ts
- [ ] 队列异常恢复：Redis 重启后任务不丢失
      Test: tests/queues/publish-queue.test.ts

### 测试验收
- [ ] 所有单元测试通过，覆盖率 > 80%
      Test: npm run test:coverage
- [ ] 回归契约测试通过
      Test: contract:RCI-KR22-001, contract:RCI-KR22-002, contract:RCI-KR22-003
- [ ] TypeScript 类型检查通过
      Test: npm run type-check
- [ ] 代码 lint 检查通过
      Test: npm run lint

### 文档验收
- [ ] API 文档更新（OpenAPI/Swagger）
      Test: manual:检查 docs/api/publish.yaml
- [ ] README 更新（如有新增依赖或配置）
      Test: manual:检查 README.md
