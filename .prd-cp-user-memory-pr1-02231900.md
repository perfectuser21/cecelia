---
id: prd-user-memory-pr1
version: 1.0.0
created: 2026-02-23
updated: 2026-02-23
changelog:
  - 1.0.0: 初始版本
---

# PRD：Cecelia 用户记忆系统 PR1 — 知道你是谁 + 从对话里学习

## 功能描述

让 Cecelia 具备主人画像能力：知道在跟谁说话，并从每次对话中学习用户信息。

## 成功标准

- Cecelia 对话时能注入用户姓名和重点方向
- 对话结束后自动提取并更新用户画像
- API 端点支持读写用户画像

## 背景

Cecelia 前台目前是"只读问答壳子"：
- 三层系统记忆（Semantic/Episodic/Profile）已完整建设
- 但 Profile 层只有"系统画像"（OKR/Capabilities），没有"主人画像"
- 每次对话，Cecelia 都不知道她在跟谁说话
- 对话结束后，什么也不会写入记忆

## 目标

让 Cecelia 具备两个基础管家能力：
1. **知道你是谁**：在对话开始时注入用户画像（名字、关注方向、偏好）
2. **从对话里学习**：对话结束后，自动提取关键事实更新用户画像

## 范围

**在 cecelia/core（Brain API）实现，不涉及 workspace 前端代码。**

---

## 功能需求

### F1：user_profiles 表（migration 065）

新建一张表存储用户长期画像：

```sql
CREATE TABLE user_profiles (
  id              SERIAL PRIMARY KEY,
  user_id         TEXT NOT NULL UNIQUE DEFAULT 'owner',
  display_name    TEXT,                    -- "徐啸 / Alex Xu"
  focus_area      TEXT,                    -- "Cecelia", "ZenithJoy"
  preferred_style TEXT DEFAULT 'detailed', -- "brief" | "detailed"
  timezone        TEXT DEFAULT 'Asia/Shanghai',
  raw_facts       JSONB DEFAULT '{}',      -- 扩展 KV 事实
  created_at      TIMESTAMP DEFAULT NOW(),
  updated_at      TIMESTAMP DEFAULT NOW()
);
```

初始种子数据：
```sql
INSERT INTO user_profiles (user_id, display_name, focus_area, preferred_style, timezone)
VALUES ('owner', '徐啸 / Alex Xu', 'Cecelia', 'detailed', 'Asia/Shanghai')
ON CONFLICT (user_id) DO NOTHING;
```

### F2：对话开始时注入用户画像

在 `buildMemoryContext()` 的 Profile 层中，加载 `user_profiles`：

- 将用户画像格式化为文本片段
- 注入到 LLM 的 system prompt 中
- 格式示例：
  ```
  你正在和 徐啸 (Alex Xu) 对话。
  TA 目前的重点方向是：Cecelia。
  TA 偏好的回答风格是：详细。
  ```

### F3：对话结束后异步提取事实（Chat Learning Hook）

在 `orchestrator-chat.js` 的 `handleChat()` 结束后，fire-and-forget 触发提取：

**提取逻辑**：
- 使用 MiniMax（已有凭据）调用一个小 prompt
- 分析本次对话内容，提取以下类型的事实：
  - `display_name`：用户提到自己的名字
  - `focus_area`：用户提到自己在关注/做什么
  - `preferred_style`：用户喜欢的回复风格（简洁/详细）
  - `raw_facts`：其他值得记住的事实（KV 格式）
- 只提取"稳定的、长期的事实"，不提取一次性话题
- 如果没有新事实，不做任何写入

**更新逻辑**：
- `upsertUserProfile(userId, extractedFacts)` — 合并更新，不覆盖已有数据
- `raw_facts` 用 JSON merge，不是替换

### F4：API 端点

新增两个端点：
- `GET /api/brain/user/profile` — 查询当前用户画像
- `PUT /api/brain/user/profile` — 手动更新用户画像

---

## 技术约束

- **单用户**：user_id 硬编码为 `'owner'`，不引入认证系统
- **模型**：用 MiniMax M2.5-highspeed 做事实提取（已有凭据，不加新依赖）
- **异步**：提取钩子 fire-and-forget，不阻塞 chat 响应
- **降级**：提取失败不影响主流程

---

## 不在此 PR 范围内

- user_id 多用户认证系统
- 前端界面（在 workspace 做）
- PR2 Action 执行能力
