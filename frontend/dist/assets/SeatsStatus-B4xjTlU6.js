import{r as l,j as e,L as j,aa as K,R as z,ab as Q,ac as W,m as A,a1 as Y,ag as Z,bz as S,T as ee,e as B,a9 as o,a8 as g,bx as se}from"./index-BhHU9tw7.js";function ae(a){const h=new Date(a).getTime(),r=Date.now(),n=Math.max(0,Math.floor((r-h)/1e3)),i=Math.floor(n/3600),c=Math.floor(n%3600/60),d=n%60;return i>0?`${i}h ${c}m ${d}s`:c>0?`${c}m ${d}s`:`${d}s`}function re(a){return a==="P0"?"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400":a==="P1"?"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400"}function de(){var T,$,P,R,L,M,E,I;const[a,h]=l.useState(null),[r,n]=l.useState(null),[i,c]=l.useState(null),[d,H]=l.useState(null),[u,f]=l.useState(!0),[N,v]=l.useState(""),[w,k]=l.useState(!1),[,F]=l.useState(0),b=l.useRef(null),x=async()=>{try{f(!0);const[s,t,D,q]=await Promise.all([fetch("/api/brain/tick/status"),fetch("/api/brain/status"),fetch("/api/brain/vps-slots"),fetch("/api/brain/execution-history?limit=10")]);s.ok&&h(await s.json()),t.ok&&n(await t.json()),D.ok&&c(await D.json()),q.ok&&H(await q.json()),v("")}catch{v("加载失败")}finally{f(!1)}};l.useEffect(()=>{x();const s=setInterval(x,5e3);return b.current=setInterval(()=>F(t=>t+1),1e3),()=>{clearInterval(s),b.current&&clearInterval(b.current)}},[]);const O=async()=>{if(a){k(!0);try{const s=a.enabled?"/api/brain/tick/disable":"/api/brain/tick/enable";await fetch(s,{method:"POST"}),await x()}finally{k(!1)}}};if(u&&!a)return e.jsx("div",{className:"p-6 flex items-center justify-center",children:e.jsx(j,{className:"w-6 h-6 animate-spin text-gray-400"})});const U=(a==null?void 0:a.max_concurrent)||6,_=(a==null?void 0:a.reserved_slots)||1,C=(a==null?void 0:a.auto_dispatch_max)||5,V=(($=(T=r==null?void 0:r.task_digest)==null?void 0:T.stats)==null?void 0:$.queued)||0,m=(i==null?void 0:i.used)||0,y=(i==null?void 0:i.slots)||[],X=Array.from({length:U},(s,t)=>t<m?"occupied":t>=C?"reserved":"empty"),p=(d==null?void 0:d.executions)||[],G=p.filter(s=>s.status==="success").length,J=p.filter(s=>s.status==="failed"||s.status==="error").length;return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(K,{className:"w-6 h-6 text-blue-500"}),e.jsx("h1",{className:"text-xl font-semibold",children:"Seats 状态"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:x,className:"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800",children:e.jsx(z,{className:`w-4 h-4 ${u?"animate-spin":""}`})}),e.jsxs("button",{onClick:O,disabled:w,className:`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition
              ${a!=null&&a.enabled?"bg-red-100 text-red-700 hover:bg-red-200 dark:bg-red-900/30 dark:text-red-400":"bg-green-100 text-green-700 hover:bg-green-200 dark:bg-green-900/30 dark:text-green-400"}`,children:[w?e.jsx(j,{className:"w-4 h-4 animate-spin"}):a!=null&&a.enabled?e.jsx(Q,{className:"w-4 h-4"}):e.jsx(W,{className:"w-4 h-4"}),a!=null&&a.enabled?"暂停派发":"启动派发"]})]})]}),N&&e.jsx("div",{className:"p-3 bg-red-50 text-red-600 rounded-lg dark:bg-red-900/20",children:N}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700",children:[e.jsxs("h2",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-4",children:["席位状态 (",m,"/",C," 自动派发，",_," 预留人工)"]}),e.jsx("div",{className:"flex gap-3 flex-wrap",children:X.map((s,t)=>e.jsx("div",{className:`w-16 h-16 rounded-xl flex items-center justify-center transition-all
                ${s==="occupied"?"bg-blue-500 text-white shadow-lg shadow-blue-500/30":s==="reserved"?"bg-amber-100 text-amber-600 border-2 border-dashed border-amber-300 dark:bg-amber-900/30 dark:border-amber-600":"bg-gray-100 text-gray-400 dark:bg-gray-700"}`,children:s==="occupied"?e.jsx(A,{className:"w-6 h-6"}):s==="reserved"?e.jsx(Y,{className:"w-6 h-6"}):e.jsx("span",{className:"text-lg font-medium",children:t+1})},t))}),e.jsxs("div",{className:"flex gap-6 mt-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-blue-500"}),e.jsxs("span",{className:"text-gray-600 dark:text-gray-400",children:["运行中 (",m,")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-gray-200 dark:bg-gray-600"}),e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"空闲"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded border-2 border-dashed border-amber-400 bg-amber-100"}),e.jsxs("span",{className:"text-gray-600 dark:text-gray-400",children:["预留人工 (",_,")"]})]})]})]}),y.length>0&&e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden",children:[e.jsx("div",{className:"px-5 py-4 border-b border-gray-100 dark:border-gray-700",children:e.jsxs("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4 text-blue-500"}),"运行中的执行 (",y.length,")"]})}),e.jsx("div",{className:"divide-y divide-gray-100 dark:divide-gray-700/50",children:y.map(s=>e.jsx("div",{className:"px-5 py-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.taskPriority&&e.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded ${re(s.taskPriority)}`,children:s.taskPriority}),e.jsx("span",{className:"font-medium text-gray-900 dark:text-white truncate",children:s.taskTitle||`PID ${s.pid}`}),s.taskType&&e.jsx("span",{className:"text-xs text-gray-400 dark:text-gray-500",children:s.taskType})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-500 dark:text-gray-400",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Z,{className:"w-3 h-3"}),s.cpu]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(S,{className:"w-3 h-3"}),s.memory]}),e.jsxs("span",{className:"text-gray-400",children:["PID ",s.pid]})]})]}),e.jsx("div",{className:"text-right ml-4",children:s.startedAt?e.jsxs("div",{className:"flex items-center gap-1.5 text-sm font-mono text-blue-600 dark:text-blue-400",children:[e.jsx(ee,{className:"w-3.5 h-3.5"}),ae(s.startedAt)]}):e.jsxs("div",{className:"flex items-center gap-1.5 text-sm text-gray-400",children:[e.jsx(B,{className:"w-3.5 h-3.5"}),s.startTime]})})]})},s.pid))})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400 mb-1",children:[e.jsx(B,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"队列等待"})]}),e.jsx("div",{className:"text-2xl font-semibold",children:V})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400 mb-1",children:[e.jsx(j,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"Claude 进程"})]}),e.jsx("div",{className:"text-2xl font-semibold",children:m})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400 mb-1",children:[e.jsx(z,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"Tick 间隔"})]}),e.jsxs("div",{className:"text-2xl font-semibold",children:[((a==null?void 0:a.dispatch_cooldown_ms)||5e3)/1e3,"s"]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 dark:text-gray-400 mb-1",children:[a!=null&&a.loop_running?e.jsx(o,{className:"w-4 h-4 text-green-500"}):e.jsx(g,{className:"w-4 h-4 text-red-500"}),e.jsx("span",{className:"text-sm",children:"Tick Loop"})]}),e.jsx("div",{className:`text-2xl font-semibold ${a!=null&&a.loop_running?"text-green-600":"text-red-600"}`,children:a!=null&&a.loop_running?"运行中":"已停止"})]})]}),(a==null?void 0:a.last_dispatch)&&e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-700",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-2",children:"最近派发"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.last_dispatch.task_title}),e.jsx("div",{className:"text-sm text-gray-500",children:new Date(a.last_dispatch.dispatched_at).toLocaleString("zh-CN")})]}),a.last_dispatch.success?e.jsx(o,{className:"w-5 h-5 text-green-500"}):e.jsx(g,{className:"w-5 h-5 text-red-500"})]})]}),d&&d.today>0&&e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden",children:[e.jsxs("div",{className:"px-5 py-4 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between",children:[e.jsxs("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 flex items-center gap-2",children:[e.jsx(se,{className:"w-4 h-4"}),"今日执行记录 (",d.today,")"]}),e.jsxs("div",{className:"flex items-center gap-3 text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1 text-green-600",children:[e.jsx(o,{className:"w-3 h-3"}),G]}),e.jsxs("span",{className:"flex items-center gap-1 text-red-500",children:[e.jsx(g,{className:"w-3 h-3"}),J]})]})]}),e.jsx("div",{className:"divide-y divide-gray-50 dark:divide-gray-700/50",children:p.slice(0,8).map(s=>{var t;return e.jsxs("div",{className:"px-5 py-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[s.status==="success"?e.jsx(o,{className:"w-4 h-4 text-green-500 flex-shrink-0"}):e.jsx(g,{className:"w-4 h-4 text-red-500 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:s.summary||s.trigger})]}),e.jsxs("div",{className:"flex items-center gap-3 text-xs text-gray-400 flex-shrink-0 ml-3",children:[((t=s.result)==null?void 0:t.duration_ms)&&e.jsxs("span",{children:[Math.round(s.result.duration_ms/1e3),"s"]}),e.jsx("span",{children:new Date(s.timestamp).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})})]})]},s.id)})})]}),(R=(P=r==null?void 0:r.task_digest)==null?void 0:P.p0)!=null&&R.length||(M=(L=r==null?void 0:r.task_digest)==null?void 0:L.p1)!=null&&M.length?e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-700",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-3",children:"待处理任务"}),e.jsx("div",{className:"space-y-2",children:[...((E=r==null?void 0:r.task_digest)==null?void 0:E.p0)||[],...((I=r==null?void 0:r.task_digest)==null?void 0:I.p1)||[]].map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded
                    ${s.priority==="P0"?"bg-red-100 text-red-700":"bg-blue-100 text-blue-700"}`,children:s.priority}),e.jsx("span",{children:s.title})]}),e.jsx("span",{className:`text-sm
                  ${s.status==="queued"?"text-gray-500":s.status==="in_progress"?"text-blue-500":"text-green-500"}`,children:s.status==="queued"?"排队中":s.status==="in_progress"?"执行中":s.status})]},s.id))})]}):null]})}export{de as default};
