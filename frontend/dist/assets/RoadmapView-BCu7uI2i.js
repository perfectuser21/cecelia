import{r as c,j as e,R as b,a8 as _,aP as A,ac as P,b5 as R,b6 as S,F as N,aR as E,b7 as H,C as G,$ as L,aQ as I,Z as J,n as f}from"./index-BhHU9tw7.js";import{a as C}from"./index-B9ygI19o.js";function W(){const[r,x]=c.useState(null),[u,w]=c.useState(!0),[o,h]=c.useState(null),[$,F]=c.useState(new Set),[Z,B]=c.useState(new Set),[d,K]=c.useState([]),j=async()=>{try{const s=await C.get("/api/panorama/planner");if(s.data.success){x(s.data.data),h(null);const a=s.data.data.repositories.filter(t=>t.feature_count>0).map(t=>t.name);F(new Set(a))}else h(s.data.error)}catch(s){h(s.message)}finally{w(!1)}};c.useEffect(()=>{j()},[]);const M=s=>{F(a=>{const t=new Set(a);return t.has(s)?t.delete(s):t.add(s),t})},Q=s=>{B(a=>{const t=new Set(a);return t.has(s)?t.delete(s):t.add(s),t})},V=(s,a)=>r?r.pending_work.filter(t=>t.repo===s.name&&t.feature_hint.includes(a.id)):[],k=async s=>{x(a=>a&&{...a,pending_work:a.pending_work.map(t=>t.path!==s.path?t:{...t,parsing:!0})});try{const a=await C.post("/api/panorama/roadmap/parse-prd",{prd_path:s.path});if(a.data.success){const t=a.data.data.tasks||[];x(l=>l&&{...l,pending_work:l.pending_work.map(m=>m.path!==s.path?m:{...m,parsing:!1,parsed:t})})}}catch{x(t=>t&&{...t,pending_work:t.pending_work.map(l=>l.path!==s.path?l:{...l,parsing:!1})})}},D=s=>{K(a=>a.find(t=>t.id===s.id)?a.filter(t=>t.id!==s.id):[...a,s])},[v,T]=c.useState(!1),[p,g]=c.useState(null),X=async s=>{T(!0),g("启动中...");try{const a=await C.post("/api/panorama/execute",{prd_path:s,priority:"P1"});a.data.success?(g(`任务 ${a.data.data.task_id} 已启动`),setTimeout(()=>j(),2e3)):g(`启动失败: ${a.data.error}`)}catch(a){g(`错误: ${a.message}`)}finally{T(!1)}};return u?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(b,{className:"w-8 h-8 text-blue-500 animate-spin"})}):o?e.jsxs("div",{className:"bg-red-900/20 border border-red-800 rounded-xl p-6 text-center",children:[e.jsx(_,{className:"w-12 h-12 text-red-500 mx-auto mb-3"}),e.jsxs("p",{className:"text-red-400",children:["加载失败: ",o]}),e.jsx("button",{onClick:j,className:"mt-4 px-4 py-2 bg-red-900/30 text-red-400 rounded-lg",children:"重试"})]}):r?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"p-3 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl",children:e.jsx(A,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Roadmap"}),e.jsxs("p",{className:"text-gray-400",children:[r.summary.total_repos," Projects · ",r.summary.total_features," Features ·"," ",r.summary.pending_prds," PRDs"]})]})]}),e.jsx("button",{onClick:j,className:"p-2 text-gray-400 hover:text-white hover:bg-slate-700 rounded-lg",children:e.jsx(b,{className:`w-5 h-5 ${u?"animate-spin":""}`})})]}),p&&e.jsxs("div",{className:`p-3 rounded-lg flex items-center gap-2 ${p.includes("错误")||p.includes("失败")?"bg-red-500/20 text-red-400":p.includes("启动")?"bg-green-500/20 text-green-400":"bg-blue-500/20 text-blue-400"}`,children:[v?e.jsx(b,{className:"w-4 h-4 animate-spin"}):e.jsx(P,{className:"w-4 h-4"}),p,e.jsx("button",{onClick:()=>g(null),className:"ml-auto text-gray-400 hover:text-white",children:e.jsx(_,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(y,{icon:e.jsx(R,{className:"w-5 h-5"}),label:"Projects",value:r.summary.total_repos,color:"blue"}),e.jsx(y,{icon:e.jsx(S,{className:"w-5 h-5"}),label:"Features",value:r.summary.total_features,color:"purple"}),e.jsx(y,{icon:e.jsx(N,{className:"w-5 h-5"}),label:"PRDs",value:r.summary.pending_prds,color:"amber"}),e.jsx(y,{icon:e.jsx(E,{className:"w-5 h-5"}),label:"容量",value:`${r.capacity.used}/${r.capacity.max}`,color:r.capacity.available>0?"green":"red",subtitle:`剩余 ${r.capacity.available}`})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("h2",{className:"text-lg font-semibold text-white flex items-center gap-2",children:[e.jsx(H,{className:"w-5 h-5 text-blue-400"}),"Project → Feature → Task"]}),e.jsx("div",{className:"space-y-3",children:r.repositories.filter(s=>s.feature_count>0).map(s=>e.jsxs("div",{className:"bg-slate-800 rounded-xl border border-slate-700 overflow-hidden",children:[e.jsxs("div",{className:"p-4 flex items-center justify-between cursor-pointer hover:bg-slate-700/50",onClick:()=>M(s.name),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[$.has(s.name)?e.jsx(G,{className:"w-5 h-5 text-gray-400"}):e.jsx(L,{className:"w-5 h-5 text-gray-400"}),e.jsx(R,{className:"w-5 h-5 text-blue-400"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-white",children:s.name}),e.jsx("span",{className:"ml-2 text-sm text-gray-500",children:"(Project)"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-400",children:[e.jsx(I,{className:"w-3 h-3"}),s.branch]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"px-2 py-1 text-sm bg-purple-500/20 text-purple-400 rounded-lg",children:[s.feature_count," Features"]}),s.has_session&&e.jsx("span",{className:"px-2 py-1 text-sm bg-green-500/20 text-green-400 rounded-lg",children:"运行中"})]})]}),$.has(s.name)&&e.jsx("div",{className:"border-t border-slate-700 p-4 space-y-2",children:s.features.map(a=>{const t=`${s.name}:${a.id}`,l=V(s,a),m=Z.has(t);return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-900/50 rounded-lg cursor-pointer hover:bg-slate-900",onClick:()=>Q(t),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[m?e.jsx(G,{className:"w-4 h-4 text-gray-500"}):e.jsx(L,{className:"w-4 h-4 text-gray-500"}),e.jsx(S,{className:"w-4 h-4 text-purple-400"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-white text-sm font-medium",children:a.name}),e.jsxs("span",{className:"ml-2 text-xs text-gray-500",children:["v",a.version]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"text-gray-500",children:[a.pages_count," pages"]}),l.length>0&&e.jsxs("span",{className:"px-1.5 py-0.5 bg-amber-500/20 text-amber-400 rounded",children:[l.length," PRD"]})]})]}),m&&e.jsx("div",{className:"ml-8 space-y-2",children:l.length>0?l.map(n=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 bg-slate-800 rounded-lg border border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{className:"w-4 h-4 text-amber-400"}),e.jsx("span",{className:"text-sm text-white",children:n.title})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>k(n),disabled:n.parsing,className:`px-2 py-1 text-xs rounded flex items-center gap-1 ${n.parsing?"bg-slate-700 text-gray-400":n.parsed?"bg-green-500/20 text-green-400":"bg-cyan-500/20 text-cyan-400 hover:bg-cyan-500/30"}`,children:n.parsing?e.jsx(b,{className:"w-3 h-3 animate-spin"}):n.parsed?e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"w-3 h-3"}),n.parsed.length," Tasks"]}):e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-3 h-3"}),"解析"]})}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),X(n.path)},disabled:v||(r==null?void 0:r.capacity.available)===0,className:`px-2 py-1 text-xs rounded flex items-center gap-1 ${v||(r==null?void 0:r.capacity.available)===0?"bg-slate-700 text-gray-500":"bg-green-500/20 text-green-400 hover:bg-green-500/30"}`,title:(r==null?void 0:r.capacity.available)===0?"无可用槽位":"执行此 PRD",children:[e.jsx(P,{className:"w-3 h-3"}),"执行"]})]})]}),n.parsed&&n.parsed.length>0&&e.jsx("div",{className:"ml-4 space-y-1",children:n.parsed.map(i=>{const q=d.find(z=>z.id===i.id);return e.jsxs("div",{onClick:()=>D(i),className:`flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-all ${q?"bg-cyan-500/20 border border-cyan-500":"bg-slate-900/30 border border-transparent hover:border-slate-600"}`,children:[e.jsx(f,{className:"w-3 h-3 text-gray-500"}),e.jsx("span",{className:`px-1 py-0.5 text-xs rounded ${i.priority==="P0"?"bg-red-500/20 text-red-400":i.priority==="P1"?"bg-amber-500/20 text-amber-400":"bg-blue-500/20 text-blue-400"}`,children:i.priority}),e.jsx("span",{className:"text-sm text-white flex-1",children:i.title}),e.jsx("span",{className:"text-xs text-gray-500",children:i.estimated_time})]},i.id)})})]},n.path)):e.jsx("div",{className:"text-sm text-gray-500 p-2",children:"该 Feature 暂无 PRD"})})]},a.id)})})]},s.name))}),r.pending_work.filter(s=>!s.feature_hint).length>0&&e.jsxs("div",{className:"bg-slate-800 rounded-xl border border-slate-700 p-4",children:[e.jsxs("h3",{className:"text-white font-medium mb-3 flex items-center gap-2",children:[e.jsx(N,{className:"w-4 h-4 text-gray-400"}),"未关联 Feature 的 PRDs"]}),e.jsx("div",{className:"space-y-2",children:r.pending_work.filter(s=>!s.feature_hint).map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-slate-900/50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-white",children:s.title}),e.jsx("span",{className:"ml-2 text-xs text-gray-500",children:s.repo})]}),e.jsx("button",{onClick:()=>k(s),disabled:s.parsing,className:"px-2 py-1 text-xs bg-cyan-500/20 text-cyan-400 rounded",children:"解析"})]},s.path))})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-slate-800 rounded-xl border border-slate-700 p-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4 flex items-center gap-2",children:[e.jsx(f,{className:"w-5 h-5 text-cyan-400"}),"待执行 Tasks",e.jsxs("span",{className:"ml-auto text-sm text-gray-400",children:[d.length," 个"]})]}),d.length>0?e.jsx("div",{className:"space-y-2 mb-4",children:d.map((s,a)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-slate-900/50 rounded-lg",children:[e.jsxs("span",{className:"text-gray-500 text-sm w-5",children:[a+1,"."]}),e.jsx("span",{className:`px-1.5 py-0.5 text-xs rounded ${s.priority==="P0"?"bg-red-500/20 text-red-400":s.priority==="P1"?"bg-amber-500/20 text-amber-400":"bg-blue-500/20 text-blue-400"}`,children:s.priority}),e.jsx("span",{className:"text-white text-sm flex-1 truncate",children:s.title}),e.jsx("button",{onClick:()=>D(s),className:"text-gray-500 hover:text-red-400",children:e.jsx(_,{className:"w-4 h-4"})})]},s.id))}):e.jsxs("div",{className:"text-center py-6 text-gray-500",children:[e.jsx(f,{className:"w-8 h-8 mx-auto mb-2 opacity-30"}),e.jsx("p",{className:"text-sm",children:"点击左侧 Task 添加到队列"})]}),e.jsxs("button",{disabled:d.length===0,className:`w-full py-2 rounded-lg flex items-center justify-center gap-2 ${d.length===0?"bg-slate-700 text-gray-500":"bg-gradient-to-r from-green-500 to-emerald-500 text-white hover:from-green-600 hover:to-emerald-600"}`,children:[e.jsx(P,{className:"w-4 h-4"}),"执行选中的 Tasks"]})]}),e.jsxs("div",{className:"bg-slate-800 rounded-xl border border-slate-700 p-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"层级统计"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-gray-400 flex items-center gap-2",children:[e.jsx(R,{className:"w-4 h-4"}),"Projects"]}),e.jsx("span",{className:"text-white font-medium",children:r.summary.total_repos})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-gray-400 flex items-center gap-2",children:[e.jsx(S,{className:"w-4 h-4"}),"Features"]}),e.jsx("span",{className:"text-white font-medium",children:r.summary.total_features})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-gray-400 flex items-center gap-2",children:[e.jsx(N,{className:"w-4 h-4"}),"PRDs"]}),e.jsx("span",{className:"text-white font-medium",children:r.summary.pending_prds})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-gray-400 flex items-center gap-2",children:[e.jsx(f,{className:"w-4 h-4"}),"Selected Tasks"]}),e.jsx("span",{className:"text-cyan-400 font-medium",children:d.length})]})]})]})]})]})]}):null}function y({icon:r,label:x,value:u,color:w,subtitle:o}){const h={blue:"from-blue-500 to-blue-600",purple:"from-purple-500 to-purple-600",amber:"from-amber-500 to-amber-600",green:"from-green-500 to-green-600",red:"from-red-500 to-red-600"};return e.jsx("div",{className:"bg-slate-800 rounded-xl border border-slate-700 p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-10 h-10 bg-gradient-to-br ${h[w]} rounded-xl flex items-center justify-center text-white`,children:r}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-400",children:x}),e.jsx("div",{className:"text-xl font-bold text-white",children:u}),o&&e.jsx("div",{className:"text-xs text-gray-500",children:o})]})]})})}export{W as default};
