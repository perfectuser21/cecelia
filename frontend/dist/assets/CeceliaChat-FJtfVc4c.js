import{r as s,u as q,j as t,B as Q,M as X,V as Z,C as ee,E as te,S as re,N as se,R as ae,P as oe,a as ne,b as ce,c as le}from"./index-BhHU9tw7.js";function ie($={}){const{onToolCall:i,onUserSpeech:U,onAssistantSpeech:B}=$,[L,v]=s.useState(!1),[K,F]=s.useState(!1),[z,u]=s.useState(!1),[M,_]=s.useState(null),g=s.useRef(null),D=s.useRef(null),d=s.useRef(null),J=s.useRef(null),w=s.useRef(null),T=s.useRef(0),A=s.useRef(""),O=s.useRef(null),N=s.useRef(!1),H=s.useRef(i),c=s.useRef(U),I=s.useRef(B);s.useEffect(()=>{H.current=i,c.current=U,I.current=B},[i,U,B]);const r=s.useCallback(async()=>{const o=await(await fetch("/api/orchestrator/realtime/config")).json();if(!o.success)throw new Error("Failed to get config");return o.config},[]),a=s.useCallback(()=>{w.current&&(w.current.close(),w.current=null),T.current=0,u(!1),N.current=!1},[]),S=s.useCallback(async e=>{try{w.current||(w.current=new AudioContext({sampleRate:24e3}),T.current=0);const o=w.current;o.state==="suspended"&&await o.resume();const h=atob(e),n=new Uint8Array(h.length);for(let R=0;R<h.length;R++)n[R]=h.charCodeAt(R);const m=new Int16Array(n.buffer),l=new Float32Array(m.length);for(let R=0;R<m.length;R++)l[R]=m[R]/32768;const C=o.createBuffer(1,l.length,24e3);C.copyToChannel(l,0);const k=o.currentTime,j=Math.max(k,T.current);T.current=j+C.duration;const V=o.createBufferSource();V.buffer=C,V.connect(o.destination),V.start(j),u(!0)}catch(o){console.error("[Realtime] Audio playback error:",o)}},[]),y=s.useCallback(e=>{var o,h,n;switch(e.type){case"session.created":console.log("[Realtime] Session created");break;case"session.updated":console.log("[Realtime] Session updated");break;case"input_audio_buffer.speech_started":console.log("[Realtime] User speech started"),a();break;case"input_audio_buffer.speech_stopped":console.log("[Realtime] User speech stopped");break;case"conversation.item.input_audio_transcription.completed":console.log("[Realtime] User transcript:",e.transcript),e.transcript&&c.current&&c.current(e.transcript);break;case"response.created":console.log("[Realtime] Response created:",(o=e.response)==null?void 0:o.id),O.current=(h=e.response)==null?void 0:h.id,A.current="";break;case"response.audio.delta":e.delta&&S(e.delta);break;case"response.audio_transcript.delta":e.delta&&(A.current+=e.delta,I.current&&I.current(A.current,!1));break;case"response.audio_transcript.done":console.log("[Realtime] AI transcript done:",e.transcript),I.current&&e.transcript&&I.current(e.transcript,!0);break;case"response.done":console.log("[Realtime] Response done"),O.current=null;break;case"response.audio.done":console.log("[Realtime] Audio stream done");break;case"error":console.error("[Realtime] Server error:",e.error),_(((n=e.error)==null?void 0:n.message)||"Server error");break;case"response.function_call_arguments.done":console.log("[Realtime] Function call:",e.name,e.arguments),f(e.call_id,e.name,e.arguments);break;default:e.type.includes("delta")||console.log("[Realtime] Event:",e.type)}},[S,a]),f=s.useCallback(async(e,o,h)=>{try{const n=JSON.parse(h||"{}");console.log("[Realtime] Executing tool:",o,n);const l=await(await fetch("/api/orchestrator/realtime/tool",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tool_name:o,arguments:n})})).json();console.log("[Realtime] Tool result:",l),H.current&&H.current(o,l.success?l.result:null),g.current&&g.current.readyState===WebSocket.OPEN&&(g.current.send(JSON.stringify({type:"conversation.item.create",item:{type:"function_call_output",call_id:e,output:JSON.stringify(l.success?l.result:{error:l.error})}})),N.current=!0,new Promise(k=>{const j=setInterval(()=>{(!N.current||!O.current)&&(clearInterval(j),k())},100);setTimeout(()=>{clearInterval(j),k()},5e3)}).then(()=>{if(!N.current){console.log("[Realtime] Response creation cancelled by user interrupt");return}const k=w.current,j=k?Math.max(0,(T.current-k.currentTime)*1e3):0;setTimeout(()=>{g.current&&g.current.readyState===WebSocket.OPEN&&!O.current&&N.current&&(N.current=!1,g.current.send(JSON.stringify({type:"response.create"})))},j+100)}))}catch(n){console.error("[Realtime] Tool call error:",n)}},[]),x=s.useCallback(async e=>{try{const o=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:24e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0}});D.current=o;const h=new AudioContext({sampleRate:24e3});d.current=h;const n=h.createMediaStreamSource(o),m=h.createScriptProcessor(4096,1,1);J.current=m,m.onaudioprocess=l=>{if(!e||e.readyState!==WebSocket.OPEN)return;const C=l.inputBuffer.getChannelData(0),k=new Int16Array(C.length);for(let E=0;E<C.length;E++){const G=Math.max(-1,Math.min(1,C[E]));k[E]=G<0?G*32768:G*32767}const j=new Uint8Array(k.buffer);let V="";for(let E=0;E<j.length;E++)V+=String.fromCharCode(j[E]);const R=btoa(V);e.send(JSON.stringify({type:"input_audio_buffer.append",audio:R}))},n.connect(m),m.connect(h.destination),F(!0),console.log("[Realtime] Recording started")}catch(o){console.error("[Realtime] Failed to start recording:",o),_("Microphone access denied")}},[]),P=s.useCallback(()=>{J.current&&(J.current.disconnect(),J.current=null),d.current&&(d.current.close(),d.current=null),D.current&&(D.current.getTracks().forEach(e=>e.stop()),D.current=null),F(!1),console.log("[Realtime] Recording stopped")},[]),b=s.useCallback(async()=>{try{_(null);const e=await r(),h=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/api/orchestrator/realtime/ws`;console.log("[Realtime] Connecting to:",h);const n=new WebSocket(h);n.onopen=async()=>{var l;console.log("[Realtime] WebSocket connected"),v(!0);const m={modalities:["text","audio"],instructions:e.instructions,voice:e.voice,input_audio_format:"pcm16",output_audio_format:"pcm16",input_audio_transcription:{model:"whisper-1"},turn_detection:{type:"server_vad",threshold:.6,prefix_padding_ms:400,silence_duration_ms:800}};((l=e.tools)==null?void 0:l.length)>0&&(m.tools=e.tools),n.send(JSON.stringify({type:"session.update",session:m}));try{await x(n)}catch(C){console.error("[Realtime] Auto-start recording failed:",C)}},n.onmessage=m=>{const l=JSON.parse(m.data);y(l)},n.onerror=m=>{console.error("[Realtime] WebSocket error:",m),_("WebSocket connection error")},n.onclose=()=>{console.log("[Realtime] WebSocket closed"),v(!1),P()},g.current=n}catch(e){console.error("[Realtime] Connection failed:",e),_(e instanceof Error?e.message:"Connection failed")}},[r,y,x,P]),p=s.useCallback(()=>{P(),g.current&&(g.current.close(),g.current=null),w.current&&(w.current.close(),w.current=null),v(!1),u(!1),_(null),A.current="",O.current=null,N.current=!1},[P]);return s.useEffect(()=>()=>{p()},[p]),{isConnected:L,isRecording:K,isPlaying:z,error:M,connect:b,disconnect:p}}const W={expand:/(expand|å±•å¼€)\s+(.+)/i,collapse:/(collapse|æ”¶èµ·|æŠ˜å )\s+(.+)/i,toggle:/(toggle|åˆ‡æ¢)\s+(.+)/i,refresh:/(refresh|åˆ·æ–°)/i,whereAmI:/(where am i|current page|what page|æˆ‘åœ¨å“ª|å½“å‰é¡µé¢|å“ªä¸ªé¡µé¢|åœ¨å“ªä¸ª?é¡µ)/i,filter:/(filter|ç­›é€‰|è¿‡æ»¤)\s+(.+)/i},ue={okr:"/okr",okrs:"/okr",objectives:"/okr",ç›®æ ‡:"/okr",okrç›®æ ‡:"/okr",å·¥ä½œç›®æ ‡:"/okr",projects:"/projects",project:"/projects",é¡¹ç›®:"/projects",é¡¹ç›®åˆ—è¡¨:"/projects",orchestrator:"/orchestrator","command center":"/orchestrator",commandcenter:"/orchestrator",command:"/orchestrator",opcenter:"/orchestrator","op center":"/orchestrator","control center":"/orchestrator",controlcenter:"/orchestrator",è°ƒåº¦:"/orchestrator",ä»»åŠ¡è°ƒåº¦:"/orchestrator",è°ƒåº¦å™¨:"/orchestrator",ç¼–æŽ’:"/orchestrator",æŒ‡æŒ¥ä¸­å¿ƒ:"/orchestrator",æŽ§åˆ¶ä¸­å¿ƒ:"/orchestrator",tasks:"/tasks",task:"/tasks",ä»»åŠ¡:"/tasks",ä»»åŠ¡åˆ—è¡¨:"/tasks",planner:"/planner",è§„åˆ’:"/planner",å·¥ä½œè§„åˆ’:"/planner",è®¡åˆ’:"/planner",brain:"/brain",å¤§è„‘:"/brain",home:"/",dashboard:"/",é¦–é¡µ:"/",ä¸»é¡µ:"/",ä»ªè¡¨ç›˜:"/"},Y={"/okr":"OKR ç›®æ ‡","/projects":"é¡¹ç›®åˆ—è¡¨","/orchestrator":"Command Center","/tasks":"ä»»åŠ¡åˆ—è¡¨","/planner":"å·¥ä½œè§„åˆ’","/brain":"å¤§è„‘","/":"é¦–é¡µ"};function pe(){const{messages:$,addMessage:i,updateMessage:U,chatOpen:B,setChatOpen:L,input:v,setInput:K,sending:F,setSending:z,generateId:u,currentStreamingIdRef:M,currentRoute:_,pageState:g,frontendTools:D,executeFrontendTool:d,getPageContext:J,showNavigationToast:w}=q(),T=s.useRef(null),A=s.useCallback(async r=>{const a=r.toLowerCase().trim();if(console.log("[Cecelia] Checking frontend command:",a),W.whereAmI.test(a))return console.log("[Cecelia] Matched: whereAmI"),{handled:!0,result:await d("get_current_page",{})};if(W.refresh.test(a))return console.log("[Cecelia] Matched: refresh"),{handled:!0,result:await d("refresh_page",{})};if(/æ‰“å¼€|åŽ»|è½¬|çœ‹|è¿›å…¥|åˆ‡æ¢|è·³è½¬|navigate|open|go/i.test(a)){console.log("[Cecelia] Has navigation intent, checking routes...");const b=Object.entries(ue).sort((p,e)=>e[0].length-p[0].length);for(const[p,e]of b)if(a.includes(p))return console.log("[Cecelia] Found route alias:",p,"â†’",e),await d("navigate_to",{path:e}),{handled:!0,result:`ðŸ§­ æ­£åœ¨å‰å¾€ã€Œ${Y[e]||p}ã€`}}const y=r.match(W.expand);if(y){const b=y[2].trim();return{handled:!0,result:await d("expand_item",{id:b})}}const f=r.match(W.collapse);if(f){const b=f[2].trim();return{handled:!0,result:await d("collapse_item",{id:b})}}const x=r.match(W.toggle);if(x){const b=x[2].trim();return{handled:!0,result:await d("toggle_item",{id:b})}}const P=r.match(W.filter);if(P){const p=P[2].trim().split(/\s+/);if(p.length>=2)return{handled:!0,result:await d("set_filter",{filterName:p[0],value:p.slice(1).join(" ")})}}return{handled:!1}},[d]),O=s.useCallback(async(r,a)=>{if(console.log("[CeceliaChat] Tool:",r,a),r==="navigate_to_page"&&(a!=null&&a.page)){const y={okr:"/okr",projects:"/projects",tasks:"/tasks",orchestrator:"/orchestrator",planner:"/planner",brain:"/brain",home:"/"}[a.page];if(y){await d("navigate_to",{path:y});const f=Y[y]||a.page;i({id:u(),role:"assistant",content:`ðŸ§­ æ­£åœ¨å‰å¾€ã€Œ${f}ã€`,toolCall:{name:"navigate",result:y}})}}},[d,i,u]),N=s.useCallback(async r=>{console.log("[Cecelia] User speech received:",r),i({id:u(),role:"user",content:r,isVoice:!0});const a=await A(r);a.handled&&(console.log("[Cecelia] Frontend command handled:",a.result),i({id:u(),role:"assistant",content:a.result||"å¥½çš„",toolCall:{name:"frontend_action",result:a.result}}))},[i,u,A]),H=s.useCallback((r,a)=>{if(M.current)U(M.current,{content:r,isStreaming:!a}),a&&(M.current=null);else{const S=u();M.current=a?null:S,i({id:S,role:"assistant",content:r,isVoice:!0,isStreaming:!a})}},[i,U,u,M]),c=ie({onUserSpeech:N,onAssistantSpeech:H,onToolCall:O});s.useEffect(()=>{var r;(r=T.current)==null||r.scrollIntoView({behavior:"smooth"})},[$]);const I=async()=>{if(!v.trim()||F)return;const r=v.trim();K(""),z(!0),i({id:u(),role:"user",content:r});try{const a=await A(r);if(a.handled){i({id:u(),role:"assistant",content:a.result||"Done",toolCall:{name:"frontend_action",result:a.result}}),z(!1);return}const S=J(),f=await(await fetch("/api/orchestrator/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:r,context:{currentRoute:_,pageContext:S,availableTools:D.map(x=>({name:x.name,description:x.description,parameters:x.parameters}))}})})).json();if(f.success&&f.response)if(f.response.frontendTool){const x=await d(f.response.frontendTool.name,f.response.frontendTool.args);i({id:u(),role:"assistant",content:f.response.message||x,toolCall:{name:f.response.frontendTool.name,result:x}})}else i({id:u(),role:"assistant",content:f.response.message})}catch{i({id:u(),role:"assistant",content:"An error occurred"})}finally{z(!1)}};return B?t.jsxs("div",{className:"fixed w-80 flex flex-col bg-slate-900/95 backdrop-blur-xl rounded-2xl border border-slate-700/50 shadow-2xl shadow-purple-500/10 z-50 overflow-hidden",style:{bottom:"24px",right:"24px",height:"480px",maxHeight:"480px",minHeight:"480px"},children:[t.jsx("div",{className:"absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-purple-400/50 to-transparent"}),t.jsxs("div",{className:"flex items-center gap-2 px-4 py-3 border-b border-slate-700/50 flex-shrink-0 bg-slate-800/50",children:[t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:"absolute inset-0 bg-purple-500/30 rounded-lg blur-sm"}),t.jsx("div",{className:"relative p-1.5 bg-gradient-to-br from-slate-600 via-purple-600/20 to-slate-800 rounded-lg border border-slate-600/50",children:t.jsx(Q,{className:"w-4 h-4 text-purple-300"})})]}),t.jsx("span",{className:"font-medium text-sm text-slate-100",children:"Cecelia"}),c.isConnected&&t.jsxs("span",{className:"flex items-center gap-1 text-xs text-emerald-500",children:[t.jsx("span",{className:"w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"}),c.isRecording&&t.jsx(X,{className:"w-3 h-3"}),c.isPlaying&&t.jsx(Z,{className:"w-3 h-3"})]}),t.jsx("button",{onClick:()=>L(!1),className:"ml-auto p-1.5 hover:bg-slate-700/50 rounded-lg transition-colors",children:t.jsx(ee,{className:"w-4 h-4 text-slate-400"})})]}),g&&t.jsx("div",{className:"px-4 py-1.5 bg-slate-800/30 border-b border-slate-700/30 flex-shrink-0",children:t.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-slate-400",children:[t.jsx(te,{className:"w-3 h-3 text-purple-400/60"}),t.jsx("span",{className:"truncate",children:g.title}),t.jsx("span",{className:"text-slate-600",children:"â€¢"}),t.jsx("span",{className:"text-slate-500",children:g.pageType})]})}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3 min-h-0",children:[$.length===0&&t.jsxs("div",{className:"text-center py-8",children:[t.jsx(re,{className:"w-6 h-6 mx-auto text-purple-400/40 mb-2"}),t.jsx("p",{className:"text-xs text-slate-400",children:"Say something"}),t.jsx("p",{className:"text-xs text-slate-500 mt-1",children:'Try: "go to projects" or "where am I"'})]}),$.map(r=>t.jsx("div",{className:`flex ${r.role==="user"?"justify-end":"justify-start"}`,children:t.jsxs("div",{className:`max-w-[85%] rounded-xl text-sm break-words ${r.role==="user"?"bg-gradient-to-br from-purple-600 to-purple-700 text-white px-3 py-2 shadow-lg shadow-purple-500/20":"bg-slate-800/80 text-slate-200 px-3 py-2 border border-slate-700/50"} ${r.isStreaming?"animate-pulse":""}`,children:[r.toolCall&&t.jsxs("div",{className:"flex items-center gap-1.5 text-xs opacity-70 mb-1",children:[t.jsx(se,{className:"w-3 h-3"}),t.jsx("span",{children:r.toolCall.name})]}),r.content]})},r.id)),F&&t.jsx("div",{className:"flex justify-start",children:t.jsx("div",{className:"px-3 py-2 bg-slate-800/80 rounded-xl border border-slate-700/50",children:t.jsx(ae,{className:"w-4 h-4 animate-spin text-purple-400"})})}),t.jsx("div",{ref:T})]}),t.jsxs("div",{className:"p-3 border-t border-slate-700/50 flex-shrink-0 bg-slate-800/30",children:[c.error&&t.jsx("p",{className:"text-xs text-red-400 mb-2 truncate",children:c.error}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:c.isConnected?c.disconnect:c.connect,className:`p-2 rounded-lg transition-all ${c.isConnected?"bg-red-500/80 hover:bg-red-500":"bg-emerald-600/80 hover:bg-emerald-600"} text-white`,children:c.isConnected?t.jsx(oe,{className:"w-4 h-4"}):t.jsx(ne,{className:"w-4 h-4"})}),t.jsx("input",{value:v,onChange:r=>K(r.target.value),onKeyDown:r=>r.key==="Enter"&&I(),placeholder:"Type a message...",disabled:c.isConnected,className:"flex-1 px-3 py-2 bg-slate-800/80 border border-slate-700/50 rounded-lg text-sm text-slate-200 placeholder-slate-500 disabled:opacity-50 focus:outline-none focus:border-purple-500/50"}),t.jsx("button",{onClick:I,disabled:!v.trim()||F||c.isConnected,className:"p-2 bg-purple-600 hover:bg-purple-500 disabled:bg-slate-700 disabled:text-slate-500 text-white rounded-lg transition-all",children:t.jsx(ce,{className:"w-4 h-4"})})]})]})]}):t.jsxs("button",{onClick:()=>L(!0),className:"fixed p-4 bg-gradient-to-br from-slate-800 via-purple-900/50 to-slate-900 text-white rounded-full shadow-lg shadow-purple-500/20 hover:shadow-xl hover:shadow-purple-500/30 hover:scale-105 transition-all z-50 border border-slate-600/50 group",style:{bottom:"24px",right:"24px"},children:[t.jsx("div",{className:"absolute inset-0 rounded-full bg-purple-500/20 blur-md opacity-0 group-hover:opacity-100 transition-opacity"}),t.jsx(le,{className:"w-6 h-6 relative z-10"}),c.isConnected&&t.jsx("span",{className:"absolute -top-1 -right-1 w-3 h-3 bg-emerald-500 rounded-full animate-pulse"})]})}export{pe as CeceliaChat,pe as default};
