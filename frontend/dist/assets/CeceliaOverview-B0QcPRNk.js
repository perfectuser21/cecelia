import{am as E,r as j,j as e,L as k,B as M,R,ab as O,ac as q,e as H,a9 as T,a8 as D,m as B,a1 as f,aE as I,ad as U,ae as A,af as W,ag as z,ah as F}from"./index-BhHU9tw7.js";function G({server:a,onClick:s}){const g=a.status==="online",d=a.resources&&a.resources.cpu_pct>80,u=a.resources&&a.resources.mem_used_pct>80,c=a.slots.processes.filter(l=>{var r;return(r=l.command)==null?void 0:r.includes("-p")}),w=a.slots.processes.filter(l=>l.command&&!l.command.includes("-p")),m=c.length,v=w.length,o=a.slots.dynamic_max||0,i=a.slots.max;return e.jsxs("div",{onClick:s,className:`bg-white dark:bg-slate-800 rounded-xl p-5 shadow-sm border cursor-pointer transition-all hover:shadow-lg hover:border-blue-400 ${g?"border-slate-200 dark:border-slate-700":"border-red-300 dark:border-red-800"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(U,{className:`w-5 h-5 ${g?"text-emerald-500":"text-red-500"}`}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold",children:[a.location," ",a.name]}),e.jsx("span",{className:"text-xs text-slate-500 font-mono",children:a.ip})]})]}),g?e.jsx(A,{className:"w-4 h-4 text-green-500"}):e.jsx(W,{className:"w-4 h-4 text-red-500"})]}),a.resources?e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-500 mb-1",children:[e.jsx(z,{className:"w-3 h-3"}),e.jsx("span",{children:"CPU"})]}),e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsxs("span",{className:`text-xl font-bold ${d?"text-red-500":""}`,children:[a.resources.cpu_pct,"%"]}),e.jsxs("span",{className:"text-xs text-slate-400",children:[a.resources.cpu_load,"/",a.resources.cpu_cores,"核"]})]}),e.jsx("div",{className:"mt-1 h-1.5 bg-slate-200 dark:bg-slate-600 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full transition-all ${d?"bg-red-500":"bg-blue-500"}`,style:{width:`${Math.min(100,a.resources.cpu_pct)}%`}})})]}),e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-500 mb-1",children:[e.jsx(F,{className:"w-3 h-3"}),e.jsx("span",{children:"内存"})]}),e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsxs("span",{className:`text-xl font-bold ${u?"text-red-500":""}`,children:[a.resources.mem_used_pct,"%"]}),e.jsxs("span",{className:"text-xs text-slate-400",children:[a.resources.mem_free_gb,"GB 可用"]})]}),e.jsx("div",{className:"mt-1 h-1.5 bg-slate-200 dark:bg-slate-600 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full transition-all ${u?"bg-red-500":"bg-emerald-500"}`,style:{width:`${a.resources.mem_used_pct}%`}})})]})]}):e.jsx("div",{className:"bg-slate-50 dark:bg-slate-700/50 rounded-lg p-4 mb-4 text-center text-slate-500",children:"无法获取资源数据"}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm text-slate-500 mb-2",children:[e.jsxs("span",{children:["席位 (",a.slots.used,"/",i,")"]}),e.jsxs("span",{className:"text-xs",children:["可用 ",o-a.slots.used-a.slots.reserved," / 资源限制 ",i-o]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:Array.from({length:i},(l,r)=>{const N=r+1,h=r<m,n=r>=m&&r<m+v,p=h||n,x=!p&&r>=i-a.slots.reserved,b=!p&&!x&&N>o;return e.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center transition-all text-sm
                  ${h?"bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-md shadow-blue-500/30":n?"bg-gradient-to-br from-emerald-500 to-emerald-600 text-white shadow-md shadow-emerald-500/30":x?"bg-amber-50 text-amber-500 border-2 border-dashed border-amber-300 dark:bg-amber-900/20":b?"bg-slate-100 dark:bg-slate-800 border border-dashed border-slate-300 dark:border-slate-600 text-slate-300 dark:text-slate-600":"bg-slate-100 text-slate-400 dark:bg-slate-700"}`,title:h?"无头任务 (auto)":n?"有头会话 (manual)":x?"预留给手动会话":b?"资源不足，暂不可用":"可用",children:h?e.jsx(B,{className:"w-4 h-4"}):n?e.jsx(f,{className:"w-4 h-4"}):x?e.jsx(f,{className:"w-4 h-4"}):b?e.jsx("span",{className:"text-xs",children:"×"}):N},r)})})]}),a.slots.processes.length>0&&e.jsxs("div",{className:"border-t border-slate-200 dark:border-slate-700 pt-3 mt-3",children:[e.jsx("div",{className:"text-xs text-slate-500 mb-2",children:"运行中的进程"}),e.jsx("div",{className:"space-y-1.5 max-h-32 overflow-y-auto",children:a.slots.processes.map((l,r)=>e.jsxs("div",{className:"flex items-center justify-between text-xs bg-slate-50 dark:bg-slate-700/50 rounded px-2 py-1.5",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsxs("span",{className:"font-mono text-slate-400 shrink-0",children:["PID ",l.pid]}),e.jsx("span",{className:"truncate text-slate-600 dark:text-slate-300",title:l.command,children:l.command.length>40?l.command.slice(0,40)+"...":l.command})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0 text-slate-500",children:[e.jsxs("span",{children:["CPU ",l.cpu]}),e.jsxs("span",{children:["MEM ",l.memory]})]})]},r))})]}),e.jsx("div",{className:"mt-3 pt-3 border-t border-slate-200 dark:border-slate-700",children:e.jsx("div",{className:"flex gap-1.5 flex-wrap",children:a.task_types.map(l=>e.jsx("span",{className:"px-2 py-0.5 bg-slate-100 dark:bg-slate-700 rounded text-xs text-slate-600 dark:text-slate-300",children:l},l))})})]})}function J(){var p,x,b,y,_,C;const a=E(),[s,g]=j.useState(null),[d,u]=j.useState(null),[c,w]=j.useState(null),[m,v]=j.useState(!0),[o,i]=j.useState(!1),l=async()=>{try{const[t,$,P]=await Promise.all([fetch("/api/brain/tick/status"),fetch("/api/brain/status"),fetch("/api/brain/cluster/status")]);if(t.ok&&g(await t.json()),$.ok&&u(await $.json()),P.ok){const L=await P.json();L.success&&w(L.cluster)}}catch(t){console.error("Fetch error:",t)}finally{v(!1)}};j.useEffect(()=>{l();const t=setInterval(l,5e3);return()=>clearInterval(t)},[]);const r=async()=>{if(s){i(!0);try{const t=s.enabled?"/api/brain/tick/disable":"/api/brain/tick/enable";await fetch(t,{method:"POST"}),await l()}finally{i(!1)}}};if(m&&!s)return e.jsx("div",{className:"p-6 flex items-center justify-center min-h-[60vh]",children:e.jsx(k,{className:"w-6 h-6 animate-spin text-slate-400"})});const N=((x=(p=d==null?void 0:d.task_digest)==null?void 0:p.stats)==null?void 0:x.queued)||0,h=((y=(b=d==null?void 0:d.task_digest)==null?void 0:b.stats)==null?void 0:y.in_progress)||0,n=[...((_=d==null?void 0:d.task_digest)==null?void 0:_.p0)||[],...((C=d==null?void 0:d.task_digest)==null?void 0:C.p1)||[]];return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(M,{className:"w-6 h-6 text-blue-500"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Cecelia 总览"}),c&&e.jsxs("span",{className:"text-sm text-slate-500",children:[c.total_used,"/",c.total_slots," 席位使用中"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:l,className:"p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800",children:e.jsx(R,{className:`w-4 h-4 ${m?"animate-spin":""}`})}),e.jsxs("button",{onClick:r,disabled:o,className:`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition
              ${s!=null&&s.enabled?"bg-red-100 text-red-700 hover:bg-red-200 dark:bg-red-900/30 dark:text-red-400":"bg-emerald-100 text-emerald-700 hover:bg-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-400"}`,children:[o?e.jsx(k,{className:"w-4 h-4 animate-spin"}):s!=null&&s.enabled?e.jsx(O,{className:"w-4 h-4"}):e.jsx(q,{className:"w-4 h-4"}),s!=null&&s.enabled?"暂停派发":"启动派发"]})]})]}),c&&e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:c.servers.map(t=>e.jsx(G,{server:t,onClick:()=>a(`/brain/server/${t.id}`)},t.id))}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl p-4 shadow-sm border border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2 text-slate-500 dark:text-slate-400 mb-1",children:[e.jsx(H,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"队列等待"})]}),e.jsx("div",{className:"text-2xl font-semibold",children:N})]}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl p-4 shadow-sm border border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2 text-slate-500 dark:text-slate-400 mb-1",children:[e.jsx(k,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"运行中"})]}),e.jsx("div",{className:"text-2xl font-semibold",children:h})]}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl p-4 shadow-sm border border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2 text-slate-500 dark:text-slate-400 mb-1",children:[e.jsx(R,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"Tick 间隔"})]}),e.jsxs("div",{className:"text-2xl font-semibold",children:[((s==null?void 0:s.dispatch_cooldown_ms)||5e3)/1e3,"s"]})]}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl p-4 shadow-sm border border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2 text-slate-500 dark:text-slate-400 mb-1",children:[s!=null&&s.loop_running?e.jsx(T,{className:"w-4 h-4 text-green-500"}):e.jsx(D,{className:"w-4 h-4 text-red-500"}),e.jsx("span",{className:"text-sm",children:"Tick Loop"})]}),e.jsx("div",{className:`text-2xl font-semibold ${s!=null&&s.loop_running?"text-emerald-600":"text-red-600"}`,children:s!=null&&s.loop_running?"运行中":"已停止"})]})]}),e.jsxs("div",{className:"flex gap-6 text-sm text-slate-600 dark:text-slate-400",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 rounded bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center",children:e.jsx(B,{className:"w-3 h-3 text-white"})}),e.jsx("span",{children:"无头 (auto)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 rounded bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center",children:e.jsx(f,{className:"w-3 h-3 text-white"})}),e.jsx("span",{children:"有头 (manual)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 rounded bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-xs text-slate-400",children:"1"}),e.jsx("span",{children:"可用"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 rounded border-2 border-dashed border-amber-400 bg-amber-50 flex items-center justify-center",children:e.jsx(f,{className:"w-3 h-3 text-amber-500"})}),e.jsx("span",{children:"预留"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 rounded bg-slate-100 border border-dashed border-slate-300 flex items-center justify-center text-xs text-slate-300",children:"×"}),e.jsx("span",{children:"资源不足"})]})]}),(s==null?void 0:s.last_dispatch)&&e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl p-4 shadow-sm border border-slate-200 dark:border-slate-700",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-500 dark:text-slate-400 mb-2",children:"最近派发"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.last_dispatch.task_title}),e.jsx("div",{className:"text-sm text-slate-500",children:new Date(s.last_dispatch.dispatched_at).toLocaleString("zh-CN")})]}),s.last_dispatch.success?e.jsx(T,{className:"w-5 h-5 text-green-500"}):e.jsx(D,{className:"w-5 h-5 text-red-500"})]})]}),n.length>0&&e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl p-4 shadow-sm border border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(I,{className:"w-4 h-4 text-slate-400"}),e.jsx("h3",{className:"text-sm font-medium text-slate-500 dark:text-slate-400",children:"待处理任务"})]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:n.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded
                    ${t.priority==="P0"?"bg-red-100 text-red-700":"bg-blue-100 text-blue-700"}`,children:t.priority}),e.jsx("span",{className:"text-sm",children:t.title})]}),e.jsx("span",{className:`text-sm
                  ${t.status==="queued"?"text-slate-500":t.status==="in_progress"?"text-blue-500":t.status==="failed"?"text-red-500":"text-emerald-500"}`,children:t.status==="queued"?"排队中":t.status==="in_progress"?"执行中":t.status==="failed"?"失败":t.status})]},t.id))})]})]})}export{J as default};
