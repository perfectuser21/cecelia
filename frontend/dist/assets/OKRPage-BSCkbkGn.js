import{r as l,aU as G,j as e,n as b,R as H,C as J,$ as D,aO as f,ao as Q,e as E,ak as V,a9 as X}from"./index-BhHU9tw7.js";function N({progress:s,size:c="md"}){const n=c==="sm"?"h-1.5":"h-2",a=s>=80?"bg-emerald-500":s>=50?"bg-blue-500":s>0?"bg-amber-500":"bg-slate-300 dark:bg-slate-600";return e.jsx("div",{className:`w-full ${n} bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden`,children:e.jsx("div",{className:`${n} ${a} rounded-full transition-all duration-500`,style:{width:`${s}%`}})})}function A({status:s}){switch(s){case"completed":return e.jsx(X,{className:"w-4 h-4 text-emerald-500"});case"in_progress":return e.jsx(E,{className:"w-4 h-4 text-blue-500"});case"cancelled":return e.jsx(V,{className:"w-4 h-4 text-red-500"});default:return e.jsx(E,{className:"w-4 h-4 text-slate-400"})}}function T({priority:s}){const c=s==="P0"?"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400":s==="P1"?"bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400":"bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-400";return e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium ${c}`,children:s})}function Y({focus:s,loading:c}){if(c)return e.jsx("div",{className:"bg-gradient-to-r from-violet-500/10 to-purple-500/10 dark:from-violet-500/20 dark:to-purple-500/20 rounded-xl p-6 border border-violet-200 dark:border-violet-800",children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-6 bg-violet-200 dark:bg-violet-800 rounded w-1/3"}),e.jsx("div",{className:"h-4 bg-violet-200 dark:bg-violet-800 rounded w-2/3"})]})});if(!s||!s.focus)return e.jsx("div",{className:"bg-slate-50 dark:bg-slate-800/50 rounded-xl p-6 border border-slate-200 dark:border-slate-700",children:e.jsxs("div",{className:"flex items-center gap-3 text-slate-500",children:[e.jsx(b,{className:"w-6 h-6"}),e.jsx("span",{children:"No active objectives"})]})});const{objective:n,key_results:a}=s.focus;return e.jsxs("div",{className:"bg-gradient-to-r from-violet-500/10 to-purple-500/10 dark:from-violet-500/20 dark:to-purple-500/20 rounded-xl p-6 border border-violet-200 dark:border-violet-800",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-violet-500 rounded-lg",children:e.jsx(b,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900 dark:text-white",children:"Today's Focus"}),e.jsxs("p",{className:"text-sm text-violet-600 dark:text-violet-400",children:[s.reason,s.is_manual&&e.jsx("span",{className:"ml-2 text-xs",children:"(manual)"})]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-2xl font-bold text-violet-600 dark:text-violet-400",children:[n.progress,"%"]}),e.jsx(T,{priority:n.priority})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-xl font-semibold text-slate-900 dark:text-white mb-2",children:n.title}),n.description&&e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400",children:n.description})]}),e.jsx(N,{progress:n.progress}),a.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:a.map(i=>e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsx(A,{status:i.status}),e.jsx("span",{className:"flex-1 text-slate-700 dark:text-slate-300",children:i.title}),e.jsxs("span",{className:"text-slate-500 dark:text-slate-400 w-12 text-right",children:[i.progress,"%"]})]},i.id))})]})}function Z({tree:s,expanded:c,onToggle:n}){return e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden",children:[e.jsx("button",{onClick:n,className:"w-full p-4 text-left hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors",children:e.jsxs("div",{className:"flex items-center gap-3",children:[s.children.length>0||s.linkedProjects&&s.linkedProjects.length>0?c?e.jsx(J,{className:"w-5 h-5 text-slate-400"}):e.jsx(D,{className:"w-5 h-5 text-slate-400"}):e.jsx("div",{className:"w-5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h3",{className:"font-semibold text-slate-900 dark:text-white truncate",children:s.title}),e.jsx(T,{priority:s.priority})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-slate-500 dark:text-slate-400",children:[e.jsxs("span",{children:[s.children.length," KRs"]}),s.linkedProjects&&s.linkedProjects.length>0&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(f,{className:"w-3 h-3"}),s.linkedProjects.length," Projects"]}),e.jsxs("span",{children:[s.progress,"%"]})]})]}),e.jsx("div",{className:"w-32",children:e.jsx(N,{progress:s.progress,size:"sm"})})]})}),c&&e.jsxs("div",{className:"border-t border-slate-200 dark:border-slate-700 px-4 py-3 bg-slate-50 dark:bg-slate-800/50",children:[s.children.length>0&&e.jsx("div",{className:"space-y-3",children:s.children.map(a=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(A,{status:a.status}),e.jsx("span",{className:"flex-1 text-sm text-slate-700 dark:text-slate-300",children:a.title}),e.jsx("div",{className:"w-20",children:e.jsx(N,{progress:a.progress,size:"sm"})}),e.jsxs("span",{className:"text-xs text-slate-500 dark:text-slate-400 w-10 text-right",children:[a.progress,"%"]})]},a.id))}),s.linkedProjects&&s.linkedProjects.length>0&&e.jsxs("div",{className:s.children.length>0?"mt-4 pt-4 border-t border-slate-200 dark:border-slate-700":"",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(f,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"Linked Projects"})]}),e.jsx("div",{className:"space-y-2",children:s.linkedProjects.map(a=>e.jsxs(Q,{to:`/projects/${a.id}`,className:"flex items-center gap-3 p-2 rounded-lg hover:bg-white dark:hover:bg-slate-700 transition-colors group",children:[e.jsx(f,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"flex-1 text-sm text-slate-700 dark:text-slate-300 group-hover:text-blue-600 dark:group-hover:text-blue-400",children:a.name}),e.jsx("span",{className:`text-xs px-2 py-0.5 rounded ${a.status==="active"?"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400":a.status==="completed"?"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400":"bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400"}`,children:a.status}),e.jsx(D,{className:"w-4 h-4 text-slate-400 group-hover:text-blue-500"})]},a.id))})]})]})]})}function se(){const[s,c]=l.useState([]),[n,a]=l.useState([]),[i,_]=l.useState(null),[h,k]=l.useState(!0),[j,w]=l.useState(!0),[p,o]=l.useState(new Set),[y,z]=l.useState(null),C=l.useCallback(t=>{o(d=>new Set([...d,t]))},[]),P=l.useCallback(t=>{o(d=>{const r=new Set(d);return r.delete(t),r})},[]),R=l.useCallback(t=>{o(d=>{const r=new Set(d);return r.has(t)?r.delete(t):r.add(t),r})},[]),S=l.useCallback(()=>{o(new Set(s.map(t=>t.id)))},[s]),$=l.useCallback(()=>{o(new Set)},[]),K=l.useRef(()=>{}),B=l.useMemo(()=>({refresh:()=>K.current(),expandItem:C,collapseItem:P,toggleItem:R,expandAll:S,collapseAll:$}),[C,P,R,S,$]),{register:O,unregisterPage:F}=G("okr","OKR Dashboard",()=>s,()=>({expandedIds:Array.from(p),loading:h,focusLoading:j}),B,()=>{const t=s.length,d=s.reduce((x,m)=>x+m.children.length,0),r=s.length>0?Math.round(s.reduce((x,m)=>x+m.progress,0)/s.length):0;return`${t} OKRs, ${d} KRs, ${r}% avg progress`});l.useEffect(()=>(O(),()=>F()),[O,F,s,p,h,j]);const g=l.useCallback(async()=>{try{const[t,d]=await Promise.all([fetch("/api/okr/trees"),fetch("/api/tasks/projects")]),[r,x]=await Promise.all([t.json(),d.json()]);a(x);const m=await Promise.all(r.trees.map(async v=>{const L=await fetch(`/api/okr/trees/${v.id}`),W=L.ok?await L.json():{...v,children:[]},U=x.filter(q=>q.goal_id===v.id);return{...W,linkedProjects:U}}));c(m),z(new Date)}catch(t){console.error("Failed to fetch data:",t)}finally{k(!1)}},[]),u=l.useCallback(async()=>{try{const t=await fetch("/api/brain/focus");if(!t.ok)throw new Error("Failed to fetch focus");const d=await t.json();_(d)}catch(t){console.error("Failed to fetch focus:",t)}finally{w(!1)}},[]);l.useEffect(()=>{g(),u();const t=setInterval(()=>{g(),u()},6e4);return()=>clearInterval(t)},[g,u]);const I=()=>{k(!0),w(!0),g(),u()};K.current=I;const M=t=>{o(d=>{const r=new Set(d);return r.has(t)?r.delete(t):r.add(t),r})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl",children:e.jsx(b,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:"OKR Dashboard"}),e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400",children:"Objectives & Key Results"})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[y&&e.jsxs("span",{className:"text-xs text-slate-400",children:["Last: ",y.toLocaleTimeString("zh-CN")]}),e.jsx("button",{onClick:I,disabled:h,className:"p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors disabled:opacity-50",children:e.jsx(H,{className:`w-5 h-5 text-slate-500 ${h?"animate-spin":""}`})})]})]}),e.jsx(Y,{focus:i,loading:j}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900 dark:text-white mb-4",children:"All OKRs"}),h?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[1,2,3].map(t=>e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700 animate-pulse",children:[e.jsx("div",{className:"h-5 bg-slate-200 dark:bg-slate-700 rounded w-2/3 mb-3"}),e.jsx("div",{className:"h-3 bg-slate-200 dark:bg-slate-700 rounded w-1/3"})]},t))}):s.length===0?e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800/50 rounded-xl p-8 text-center border border-slate-200 dark:border-slate-700",children:[e.jsx(b,{className:"w-12 h-12 text-slate-300 dark:text-slate-600 mx-auto mb-3"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400",children:"No OKRs yet"})]}):e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:s.map(t=>e.jsx(Z,{tree:t,expanded:p.has(t.id),onToggle:()=>M(t.id)},t.id))})]})]})}export{se as default};
