import{r as d,j as e,R as h,B as w,Z as u,aK as P,n as C,e as q,a9 as S,y as g,ac as p,ab as _,b as $}from"./index-BhHU9tw7.js";import{a as j}from"./index-B9ygI19o.js";function Z(){const[t,i]=d.useState({mode:"manual",running:!1,queue:[],scheduled:[],executing:[],completed:[],capacity:{max:3,used:0,available:3}}),[o,x]=d.useState(null),[c,b]=d.useState(!0),[A,B]=d.useState(new Set),m=async()=>{try{const s=await j.get("/api/panorama/planner");if(s.data.success){x(s.data.data);const l=s.data.data.pending_work.map((a,n)=>({id:`prd-${n}`,repo:a.repo,prd_file:a.file,title:a.title,priority:"P1",status:"queued",estimated_time:"30min"})),r=(s.data.data.active_work||[]).map((a,n)=>({id:`exec-${n}`,repo:a.project,prd_file:"current",title:`Running in ${a.project}`,priority:"P0",status:a.status==="active"?"running":"scheduled",estimated_time:a.runtime}));i(a=>({...a,queue:l,executing:r,capacity:s.data.data.capacity}))}}catch(s){console.error("Failed to load data:",s)}finally{b(!1)}};d.useEffect(()=>{m();const s=setInterval(m,15e3);return()=>clearInterval(s)},[]);const N=(s,l)=>{i(r=>({...r,queue:r.queue.map(a=>a.id===s?{...a,priority:l}:a)}))},y=s=>{const l=t.queue.find(r=>r.id===s);l&&t.capacity.available>0&&i(r=>({...r,queue:r.queue.filter(a=>a.id!==s),scheduled:[...r.scheduled,{...l,status:"scheduled"}]}))},f=async s=>{try{(await j.post("/n8n/webhook/cecelia-start",{project:s.repo,prd_path:s.prd_file})).data&&(alert(`任务已触发: ${s.title}`),m())}catch(l){alert(`触发失败: ${l.message}`)}},v=()=>{i(s=>({...s,mode:s.mode==="auto"?"manual":"auto"}))};return c?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(h,{className:"w-8 h-8 text-blue-500 animate-spin"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"p-3 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl",children:e.jsx(w,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"任务调度器"}),e.jsx("p",{className:"text-gray-400",children:"智能分配 · 优先级管理 · 容量规划"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:v,className:`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors ${t.mode==="auto"?"bg-green-600 text-white":"bg-slate-700 text-gray-300"}`,children:[t.mode==="auto"?e.jsx(u,{className:"w-4 h-4"}):e.jsx(P,{className:"w-4 h-4"}),t.mode==="auto"?"自动模式":"手动模式"]}),e.jsx("button",{onClick:m,className:"p-2 text-gray-400 hover:text-white hover:bg-slate-700 rounded-lg",children:e.jsx(h,{className:"w-5 h-5"})})]})]}),e.jsxs("div",{className:"bg-slate-800 rounded-xl border border-slate-700 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold text-white flex items-center gap-2",children:[e.jsx(C,{className:"w-5 h-5 text-cyan-400"}),"容量状态"]}),e.jsx("div",{className:"text-sm",children:e.jsx("span",{className:t.capacity.available>0?"text-green-400":"text-red-400",children:t.capacity.available>0?`可调度 ${t.capacity.available} 个`:"已满载"})})]}),e.jsx("div",{className:"flex gap-2",children:[...Array(t.capacity.max)].map((s,l)=>{const r=l<t.capacity.used,a=l<t.executing.filter(n=>n.status==="running").length;return e.jsx("div",{className:`flex-1 h-12 rounded-lg flex items-center justify-center font-medium ${a?"bg-green-500 text-white":r?"bg-amber-500 text-white":"bg-slate-700 text-gray-400"}`,children:a?"运行中":r?"占用":"空闲"},l)})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"bg-slate-800 rounded-xl border border-slate-700 p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold text-white mb-4 flex items-center gap-2",children:[e.jsx(q,{className:"w-5 h-5 text-amber-400"}),"待调度队列",e.jsx("span",{className:"ml-auto text-sm text-gray-400",children:t.queue.length})]}),e.jsx("div",{className:"space-y-3 max-h-[500px] overflow-y-auto",children:t.queue.length>0?t.queue.map(s=>e.jsx(T,{task:s,onPriorityChange:l=>N(s.id,l),onSchedule:()=>y(s.id),canSchedule:t.capacity.available>0},s.id)):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(S,{className:"w-12 h-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{children:"队列为空"})]})})]}),e.jsxs("div",{className:"bg-slate-800 rounded-xl border border-cyan-500/30 p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold text-white mb-4 flex items-center gap-2",children:[e.jsx(g,{className:"w-5 h-5 text-cyan-400"}),"已调度",e.jsx("span",{className:"ml-auto text-sm text-gray-400",children:t.scheduled.length})]}),e.jsx("div",{className:"space-y-3 max-h-[500px] overflow-y-auto",children:t.scheduled.length>0?t.scheduled.map(s=>e.jsxs("div",{className:"p-4 rounded-lg border border-cyan-500/30 bg-cyan-500/5",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-white",children:s.title}),e.jsx("div",{className:"text-sm text-gray-400",children:s.repo})]}),e.jsx("button",{onClick:()=>f(s),className:"p-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg transition-colors",title:"立即执行",children:e.jsx(p,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx(R,{priority:s.priority}),e.jsx("span",{className:"text-xs text-gray-500",children:s.estimated_time})]})]},s.id)):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(g,{className:"w-12 h-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{children:"没有待执行的任务"}),e.jsx("p",{className:"text-sm mt-1",children:"从队列中选择任务"})]})})]}),e.jsxs("div",{className:"bg-slate-800 rounded-xl border border-green-500/30 p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold text-white mb-4 flex items-center gap-2",children:[e.jsx(p,{className:"w-5 h-5 text-green-400"}),"执行中",e.jsx("span",{className:"ml-auto text-sm text-gray-400",children:t.executing.length})]}),e.jsx("div",{className:"space-y-3 max-h-[500px] overflow-y-auto",children:t.executing.length>0?t.executing.map(s=>e.jsxs("div",{className:`p-4 rounded-lg border ${s.status==="running"?"border-green-500/30 bg-green-500/5":"border-slate-700 bg-slate-900/50"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.status==="running"?e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full animate-pulse"}):e.jsx("div",{className:"w-3 h-3 bg-amber-500 rounded-full"}),e.jsx("span",{className:"font-medium text-white",children:s.repo})]}),e.jsx("div",{className:"text-sm text-gray-400 mt-1",children:s.title}),e.jsxs("div",{className:"text-xs text-gray-500 mt-2",children:["运行时间: ",s.estimated_time]})]},s.id)):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(_,{className:"w-12 h-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{children:"没有执行中的任务"})]})})]})]}),t.mode==="auto"&&e.jsx("div",{className:"bg-green-900/20 border border-green-500/30 rounded-xl p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(u,{className:"w-6 h-6 text-green-400"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-green-400",children:"自动调度已启用"}),e.jsx("p",{className:"text-sm text-green-300/70",children:"系统将自动按优先级调度任务，当有空闲容量时自动执行队列中的 P0 任务"})]})]})}),e.jsxs("div",{className:"bg-slate-800 rounded-xl border border-slate-700 p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-white mb-4",children:"使用说明"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-medium text-cyan-400",children:"1. 设置优先级"}),e.jsxs("p",{className:"text-gray-400",children:["P0 = 紧急必须",e.jsx("br",{}),"P1 = 重要",e.jsx("br",{}),"P2 = 可延后"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-medium text-cyan-400",children:"2. 调度任务"}),e.jsx("p",{className:"text-gray-400",children:"从队列选择任务，点击「调度」按钮移到待执行"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-medium text-cyan-400",children:"3. 执行任务"}),e.jsx("p",{className:"text-gray-400",children:"在「已调度」中点击播放按钮，触发 Cecelia 执行"})]})]})]})]})}function T({task:t,onPriorityChange:i,onSchedule:o,canSchedule:x}){return e.jsxs("div",{className:"p-4 rounded-lg border border-slate-700 bg-slate-900/50",children:[e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-white truncate",children:t.title}),e.jsx("div",{className:"text-sm text-gray-400",children:t.repo}),e.jsx("div",{className:"text-xs text-gray-500 font-mono mt-1",children:t.prd_file})]})}),e.jsxs("div",{className:"flex items-center justify-between mt-3",children:[e.jsx("div",{className:"flex gap-1",children:["P0","P1","P2"].map(c=>e.jsx("button",{onClick:()=>i(c),className:`px-2 py-1 text-xs rounded ${t.priority===c?c==="P0"?"bg-red-500 text-white":c==="P1"?"bg-amber-500 text-white":"bg-slate-500 text-white":"bg-slate-700 text-gray-400 hover:bg-slate-600"}`,children:c},c))}),e.jsxs("button",{onClick:o,disabled:!x,className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm transition-colors ${x?"bg-cyan-600 hover:bg-cyan-700 text-white":"bg-slate-700 text-gray-500 cursor-not-allowed"}`,children:[e.jsx($,{className:"w-3 h-3"}),"调度"]})]})]})}function R({priority:t}){const i={P0:"bg-red-500/20 text-red-400 border-red-500/30",P1:"bg-amber-500/20 text-amber-400 border-amber-500/30",P2:"bg-slate-500/20 text-slate-400 border-slate-500/30"};return e.jsx("span",{className:`px-2 py-0.5 text-xs rounded border ${i[t]}`,children:t})}export{Z as default};
