# DoD - 蓝绿部署脚本（Rolling Update）

## 验收标准

### 功能验收

- [ ] 脚本成功构建新镜像（基于 brain/package.json version）
      Test: manual:执行脚本，检查 docker images 输出

- [ ] green 容器在 5222 端口启动成功
      Test: manual:执行脚本，检查 docker ps 输出

- [ ] 健康检查通过（200 OK from localhost:5222/api/brain/health）
      Test: manual:执行脚本，观察健康检查输出

- [ ] 流量切换后，5221 端口返回正确响应
      Test: manual:curl http://localhost:5221/api/brain/health

- [ ] 旧容器成功停止和删除
      Test: manual:执行脚本后，docker ps 中没有旧容器

- [ ] 新容器以正确名称运行（cecelia-node-brain）
      Test: manual:docker ps | grep cecelia-node-brain

### 安全验收

- [ ] 健康检查失败时自动回滚（停止 green，保留 blue）
      Test: manual:模拟健康检查失败，验证回滚

- [ ] 回滚后旧容器仍在运行（5221 端口正常）
      Test: manual:回滚后 curl http://localhost:5221/api/brain/health

- [ ] Migration 失败时阻止部署（继承 brain-deploy.sh 逻辑）
      Test: manual:检查脚本代码包含 migration 步骤

### 性能验收

- [ ] 双容器运行时间 < 5 分钟
      Test: manual:执行脚本，计时从启动 green 到停止 blue

- [ ] 停机窗口 < 5 秒（容器切换瞬间）
      Test: manual:执行脚本，计时从停止 blue 到启动 blue

- [ ] green 容器内存峰值 < 500 MB
      Test: manual:docker stats 观察 green 容器内存

### 兼容性验收

- [ ] 继承 ENV_REGION 环境变量
      Test: manual:检查脚本代码包含 ENV_REGION 传递

- [ ] 与现有 CI/CD 流程兼容（不破坏 brain-deploy.sh）
      Test: manual:检查 brain-deploy.sh 仍能正常使用

- [ ] Docker 配置与 docker-compose.yml 一致（--network host, --env-file, --restart）
      Test: manual:检查脚本代码与 docker-compose.yml 对比

### 代码质量

- [ ] 脚本可执行（chmod +x）
      Test: manual:ls -la scripts/rolling-update.sh

- [ ] 脚本输出清晰（每步骤有明确提示）
      Test: manual:执行脚本，检查输出格式

- [ ] 错误处理完善（set -euo pipefail）
      Test: manual:检查脚本第一行包含 set -euo pipefail

### 文档验收

- [ ] 脚本头部包含使用说明（注释）
      Test: manual:检查脚本头部注释

- [ ] LEARNINGS.md 记录开发经验
      Test: contract:RCI-dev-learning

## 测试策略

由于蓝绿部署脚本涉及容器操作和网络切换，主要采用 **手动验证** 方式：

1. **本地测试环境**：在开发机器上执行脚本，观察容器切换过程
2. **健康检查验证**：确认脚本能正确检测容器健康状态
3. **回滚测试**：模拟健康检查失败，验证自动回滚逻辑
4. **性能测试**：使用 docker stats 监控资源占用

**自动化测试限制**：
- 脚本需要实际 Docker 环境和运行中的 Brain 容器
- CI 环境可能无法完整模拟生产环境的容器切换
- 优先保证脚本的健壮性（错误处理、回滚机制）

## 验收流程

### 1. 代码审查
- [ ] 检查脚本逻辑（构建 → 启动 → 健康检查 → 切换 → 停止）
- [ ] 检查错误处理（每个关键步骤都有失败处理）
- [ ] 检查回滚逻辑（健康检查失败时的回滚代码）

### 2. 手动测试
```bash
# 1. 确保 Brain 正在运行
docker ps | grep cecelia-node-brain

# 2. 执行滚动更新脚本
bash scripts/rolling-update.sh

# 3. 观察输出，确认每个步骤成功
# [1/6] Building...
# [2/6] Starting green...
# [3/6] Health check...
# [4/6] Waiting tick...
# [5/6] Switching...
# [6/6] Restarting...

# 4. 验证新容器正常运行
curl http://localhost:5221/api/brain/health
docker ps | grep cecelia-node-brain
```

### 3. 回滚测试
```bash
# 模拟健康检查失败（修改脚本临时注释掉健康检查）
# 执行脚本，观察是否自动回滚
# 验证旧容器仍在运行
```

### 4. CI 验证
- [ ] PR 创建后，CI 通过（不运行部署脚本，只检查代码质量）
- [ ] Facts Check 通过
- [ ] Version Check 通过

## 完成条件

**所有验收标准勾选完成 + CI 通过 + PR 合并到 develop**
