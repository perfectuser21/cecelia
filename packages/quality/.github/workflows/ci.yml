name: CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check structure
        run: |
          echo "Checking Quality Platform structure..."
          test -d hooks
          test -d scripts/devgate
          test -d skills
          test -f VERSION
          echo "✅ Structure check passed"

      - name: Validate scripts
        run: |
          echo "Validating scripts..."
          for script in hooks/*.sh scripts/*.sh scripts/devgate/*.sh; do
            if [ -f "$script" ]; then
              bash -n "$script" || exit 1
            fi
          done
          echo "✅ Script validation passed"

      - name: Check version
        run: |
          VERSION=$(cat VERSION)
          echo "Version: $VERSION"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "❌ Invalid version format"
            exit 1
          fi
          echo "✅ Version check passed"

      - name: Validate skills
        run: |
          echo "Validating skills..."
          test -f skills/audit/SKILL.md
          test -f skills/qa/SKILL.md
          test -f skills/assurance/SKILL.md
          echo "✅ Skills validation passed"

      - name: Check contracts
        run: |
          echo "Checking contract templates..."
          test -f contracts/gate-contract.template.yaml
          test -f contracts/regression-contract.template.yaml
          echo "✅ Contract templates check passed"

  test:
    runs-on: ubuntu-latest
    needs: quality-check
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run tests (if exists)
        run: |
          if [ -f package.json ]; then
            npm install
            npm test || echo "No tests configured yet"
          else
            echo "No package.json found, skipping tests"
          fi

  lint:
    runs-on: ubuntu-latest
    needs: quality-check
    steps:
      - uses: actions/checkout@v4

      - name: Shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          echo "Running shellcheck on all shell scripts..."
          find . -name "*.sh" -type f -exec shellcheck {} + || echo "Shellcheck found issues (non-blocking)"

  docs:
    runs-on: ubuntu-latest
    needs: quality-check
    steps:
      - uses: actions/checkout@v4

      - name: Check documentation
        run: |
          echo "Checking documentation..."
          test -f README.md
          test -f CHANGELOG.md
          test -f docs/INTEGRATION.md
          test -f docs/ARCHITECTURE.md
          test -f docs/CUSTOMIZATION.md
          echo "✅ Documentation check passed"
