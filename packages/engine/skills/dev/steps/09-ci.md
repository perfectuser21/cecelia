# Step 9: CI ç›‘æ§ä¸åˆå¹¶

> ç­‰å¾… CI é€šè¿‡ï¼Œç„¶ååˆå¹¶ PR
> **Stop Hook æ§åˆ¶ï¼šCI æœªé€šè¿‡æˆ– PR æœªåˆå¹¶æ—¶é˜»æ­¢ä¼šè¯ç»“æŸï¼ˆexit 2ï¼‰**

**Task Checkpoint**: `TaskUpdate({ taskId: "9", status: "in_progress" })`

---

## æµç¨‹

```
PR åˆ›å»º â†’ ç­‰å¾… CI â†’ CI å¤±è´¥ï¼Ÿä¿®å¤ â†’ CI é€šè¿‡ â†’ åˆå¹¶ PR â†’ å®Œæˆ
                          â†‘                              â†“
                    Stop Hook exit 2              Stop Hook exit 0
                    ï¼ˆç»§ç»­æ‰§è¡Œï¼‰                  ï¼ˆå…è®¸ç»“æŸï¼‰
```

---

## 9.1 æ£€æŸ¥ CI çŠ¶æ€

```bash
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

# ç­‰å¾… CI å¯åŠ¨
sleep 30

# æŸ¥è¯¢ CI çŠ¶æ€
RUN_INFO=$(gh run list --branch "$BRANCH_NAME" --limit 1 --json status,conclusion,databaseId)
CI_STATUS=$(echo "$RUN_INFO" | jq -r '.[0].status')
CI_CONCLUSION=$(echo "$RUN_INFO" | jq -r '.[0].conclusion')

echo "CI çŠ¶æ€: $CI_STATUS"
echo "CI ç»“è®º: $CI_CONCLUSION"
```

---

## 9.2 CI çŠ¶æ€å¤„ç†

| CI çŠ¶æ€ | åŠ¨ä½œ |
|---------|------|
| queued / in_progress | ç­‰å¾…ï¼Œç»§ç»­æ£€æŸ¥ |
| failure | æŸ¥çœ‹æ—¥å¿—ï¼Œä¿®å¤ä»£ç ï¼Œpush |
| success | ç»§ç»­åˆå¹¶ PR |

### CI å¤±è´¥ä¿®å¤

```bash
# è·å–å¤±è´¥æ—¥å¿—
RUN_ID=$(echo "$RUN_INFO" | jq -r '.[0].databaseId')
FAIL_LOG=$(gh run view "$RUN_ID" --log-failed 2>&1 | head -50)
echo "$FAIL_LOG"

# âš ï¸ å¿…é¡»ç«‹å³è®°å½• incidentï¼ˆåœ¨åˆ†æå’Œä¿®å¤ä¹‹å‰ï¼‰
INCIDENT_FILE=".dev-incident-log.json"
FAILED_CHECKS=$(gh run view "$RUN_ID" --json jobs -q '[.jobs[] | select(.conclusion == "failure") | .name] | join(", ")' 2>/dev/null || echo "unknown")
ENTRY=$(jq -n \
    --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
    --arg checks "$FAILED_CHECKS" \
    --arg log "$(echo "$FAIL_LOG" | head -20)" \
    '{timestamp: $ts, step: "9-ci", type: "ci_failure", description: ("CI å¤±è´¥: " + $checks), error: $log, resolution: ""}')
if [[ -f "$INCIDENT_FILE" ]]; then
    jq --argjson e "$ENTRY" '. += [$e]' "$INCIDENT_FILE" > /tmp/incident_tmp.json && mv /tmp/incident_tmp.json "$INCIDENT_FILE"
else
    jq -n --argjson e "$ENTRY" '[$e]' > "$INCIDENT_FILE"
fi
echo "ğŸ“ CI å¤±è´¥å·²è®°å½•åˆ° .dev-incident-log.json"

# åˆ†æå¤±è´¥åŸå› å¹¶ä¿®å¤ä»£ç 
# ...

# æäº¤ä¿®å¤
git add -A
git commit -m "fix: CI å¤±è´¥ä¿®å¤

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

git push origin HEAD

# âš ï¸ ä¿®å¤å®Œæˆåï¼Œæ›´æ–°åˆšæ‰è®°å½•çš„ incident çš„ resolution å­—æ®µ
# ï¼ˆç”¨ jq æ‰¾åˆ°æœ€åä¸€æ¡ step=9-ci çš„è®°å½•ï¼Œè¡¥å¡« resolutionï¼‰
RESOLUTION="ä¿®å¤è¯´æ˜ï¼ˆåœ¨æ­¤å¡«å†™å®é™…ä¿®å¤å†…å®¹ï¼‰"
jq --arg res "$RESOLUTION" '
    (to_entries | reverse | map(select(.value.step == "9-ci" and .value.resolution == "")) | first).key as $idx
    | .[$idx].resolution = $res
' "$INCIDENT_FILE" > /tmp/incident_tmp.json && mv /tmp/incident_tmp.json "$INCIDENT_FILE"
```

**ä¿®å¤åç»§ç»­ç­‰å¾… CI**ï¼ŒStop Hook ä¼šåœ¨ä¼šè¯å°è¯•ç»“æŸæ—¶æ£€æŸ¥æ¡ä»¶ã€‚

---

## 9.3 åˆå¹¶ PR

CI é€šè¿‡åï¼Œåˆå¹¶ PRï¼š

```bash
PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --state open --json number -q '.[0].number')

gh pr merge "$PR_NUMBER" --squash --delete-branch

echo "âœ… PR #$PR_NUMBER å·²åˆå¹¶"
```

---

## 9.4 Stop Hook å®Œæˆæ¡ä»¶

Stop Hook æ£€æŸ¥ä»¥ä¸‹æ¡ä»¶å†³å®šæ˜¯å¦å…è®¸ä¼šè¯ç»“æŸï¼š

| æ¡ä»¶ | çŠ¶æ€ | Stop Hook è¡Œä¸º |
|------|------|---------------|
| PR æœªåˆ›å»º | âŒ | exit 2ï¼ˆç»§ç»­åˆ›å»º PRï¼‰|
| CI å¤±è´¥ | âŒ | exit 2ï¼ˆç»§ç»­ä¿®å¤ï¼‰|
| CI è¿›è¡Œä¸­ | â³ | exit 2ï¼ˆç»§ç»­ç­‰å¾…ï¼‰|
| CI é€šè¿‡ä½†æœªåˆå¹¶ | âŒ | exit 2ï¼ˆç»§ç»­åˆå¹¶ï¼‰|
| **PR å·²åˆå¹¶** | âœ… | exit 0ï¼ˆå®Œæˆï¼ï¼‰|

**åªæœ‰ PR åˆå¹¶åï¼ŒStop Hook æ‰å…è®¸ä¼šè¯ç»“æŸã€‚**

---

## ç¦æ­¢è¡Œä¸º

- âŒ CI å¤±è´¥ååœæ­¢ä¸ç®¡
- âŒ PR åˆ›å»ºåå°±ç»“æŸ
- âŒ ç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨å¤„ç†

## æ­£ç¡®è¡Œä¸º

- âœ… CI å¤±è´¥ â†’ æŸ¥çœ‹æ—¥å¿— â†’ ä¿®å¤ä»£ç  â†’ push â†’ ç»§ç»­ç­‰å¾…
- âœ… CI é€šè¿‡ â†’ åˆå¹¶ PR
- âœ… PR åˆå¹¶ â†’ ç»§ç»­ Step 10/11

---

## å®Œæˆå

**æ ‡è®°æ­¥éª¤å®Œæˆ**ï¼š

```bash
# æ›´æ–° .dev-mode ä¸­çš„ Step 9 çŠ¶æ€
sed -i 's/^step_9_ci: pending/step_9_ci: done/' .dev-mode
echo "âœ… Step 9 å®Œæˆæ ‡è®°å·²å†™å…¥ .dev-mode"
```

**Task Checkpoint**: `TaskUpdate({ taskId: "9", status: "completed" })`

**ç»§ç»­ â†’ Step 10 (Learning)**

è®°å½•å¼€å‘è¿‡ç¨‹ä¸­çš„ç»éªŒæ•™è®­ã€‚
