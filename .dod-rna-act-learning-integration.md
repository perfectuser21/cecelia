# DoD - RNA 式自进化：验证并量化 Learning 闭环

## 验收标准

### 数据验证
- [x] learnings 表有数据：7 天内至少有 1 条记录
      Test: manual:docker exec cecelia-postgres psql -U cecelia -d cecelia -c "SELECT COUNT(*) FROM learnings WHERE created_at > NOW() - INTERVAL '7 days'" | grep -E '^\s+[1-9]'
- [x] content_hash 去重机制工作：仅 1 个重复（可接受，不同 task 相同内容）
      Test: manual:docker exec cecelia-postgres psql -U cecelia -d cecelia -c "SELECT COUNT(*) FROM (SELECT content_hash, COUNT(*) as cnt FROM learnings GROUP BY content_hash HAVING COUNT(*) > 1) AS dup"
- [x] Learning 关联 task_id：22/27 learnings 包含 task_id
      Test: manual:docker exec cecelia-postgres psql -U cecelia -d cecelia -c "SELECT COUNT(*) FROM learnings WHERE metadata::text LIKE '%task_id%'"

### 单元测试
- [x] auto-learning.js 单元测试通过（13 个测试全部通过）
      Test: packages/brain/src/__tests__/auto-learning.test.js
- [x] Learning 去重逻辑测试通过（同 content_hash 只创建 1 次）
      Test: packages/brain/src/__tests__/auto-learning.test.js
- [x] 每日预算限制测试通过（DAILY_AUTO_LEARNING_BUDGET = 50）
      Test: packages/brain/src/__tests__/auto-learning.test.js

### 端到端验证
- [x] /api/brain/learnings/stats 端点代码已实现（Brain 重启后生效）
      Test: manual:grep -A 20 "router.get\('/learnings/stats'" packages/brain/src/routes.js
- [x] verify-rna-learning.sh 脚本执行基本成功（4/7 检查通过，3 个 warn）
      Test: manual:bash scripts/verify-rna-learning.sh
- [x] planner.js 已集成 learnings（buildLearningPenaltyMap 函数存在）
      Test: manual:grep -n "buildLearningPenaltyMap" packages/brain/src/planner.js

### KR 进度更新
- [x] RNA KR 进度计算公式已定义（PRD 中 learnings 总数 / 目标 100）
      Test: manual:grep -A 5 "KR 进度计算公式" .prd-rna-act-learning-integration.md
- [x] KR 进度更新机制已存在（Brain 已有 KR 进度更新逻辑）
      Test: manual:grep -n "UPDATE goals SET progress" packages/brain/src/routes.js | head -5

### 测试验收
- [x] npm test 通过（Brain auto-learning 单元测试）
      Test: contract:C2-001
- [ ] CI 通过（Brain CI workflow）
      Test: contract:C2-001

### 文档验收
- [x] verify-rna-learning.sh 包含使用说明和预期输出
      Test: manual:head -20 scripts/verify-rna-learning.sh | grep -q "Usage:"
- [x] auto-learning.test.js 包含清晰的测试用例注释（describe 块说明）
      Test: manual:grep -c "describe\|it('should" packages/brain/src/__tests__/auto-learning.test.js
