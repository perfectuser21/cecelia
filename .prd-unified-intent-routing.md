# PRD - 统一意图路由层

## 需求来源

用户通过 `/decomp` 描述：
> 三条意图路径（欲望/聊天/Cortex）完全独立，无共用路由逻辑。目标：统一意图路由层，所有意图过 /plan 识别层级，存 task_layer，按层级路由到秋米拆解或 /dev。

**KR**: Cecelia 真正 24/7 自主运行

## 问题现状

当前系统有三条完全独立的意图路径：

1. **欲望路径** (Desire Act)：用户欲望 → desires 表 → 直接执行
2. **聊天路径**：用户输入 → 意图识别 → 某种路由
3. **Cortex 路径**：Brain 自主决策 → 某种路由

问题：
- 三条路径没有共用的路由层
- 缺乏统一的层级识别机制（Layer 1-6）
- 无法保证所有意图都经过 /plan 识别
- task_layer 字段未被充分利用

## 目标功能

### 核心改造

**统一意图路由层架构**：
```
任何意图（欲望/聊天/Cortex）
    ↓
/plan 识别层级（Layer 1-6）
    ↓
存储 task_layer 字段
    ↓
按层级路由：
  - Layer 1-3 (OKR/KR) → 秋米拆解 (/autumnrice)
  - Layer 4 (Project) → 秋米拆解 (多 PR)
  - Layer 5-6 (Initiative/Task) → /dev 直接执行
```

### 涉及改动

#### 1. desires 表增加 task_layer 字段
```sql
ALTER TABLE desires ADD COLUMN task_layer VARCHAR(20);
-- 欲望形成时，通过 /plan 识别层级并写入
```

#### 2. 欲望路径改造
- `desire-act.js` 或相关文件
- 欲望形成时调用 /plan 识别层级
- 将识别结果存入 `desires.task_layer`

#### 3. 聊天路径改走统一路由
- 当前聊天路径的意图识别逻辑
- 改为调用 /plan 识别层级
- 根据 task_layer 路由

#### 4. 三路汇聚的统一路由函数
```javascript
function routeByTaskLayer(intent, taskLayer) {
  switch(taskLayer) {
    case 'Layer 1':
    case 'Layer 2':
    case 'Layer 3':
    case 'Layer 4':
      return callAutumnrice(intent);  // 秋米拆解
    case 'Layer 5':
    case 'Layer 6':
      return callDev(intent);  // 直接 /dev
    default:
      return defaultRoute(intent);
  }
}
```

## 涉及仓库

**cecelia monorepo**
- `packages/brain/src/` - Brain 核心逻辑
- `packages/brain/migrations/` - 数据库 schema 变更

## 成功标准

1. ✅ desires 表有 task_layer 字段
2. ✅ 欲望形成时自动识别层级并存储
3. ✅ 聊天路径改为统一路由
4. ✅ 三条路径都经过同一个 `routeByTaskLayer()` 函数
5. ✅ 通过测试验证：
   - 欲望输入 → 正确识别层级 → 正确路由
   - 聊天输入 → 正确识别层级 → 正确路由
   - Cortex 决策 → 正确识别层级 → 正确路由

## 非目标

- ❌ 不改变 /plan 本身的识别逻辑（复用现有）
- ❌ 不改变秋米和 /dev 的内部实现
- ❌ 不涉及前端 UI 改动（纯后端路由层）

## 技术方案提示

- `/plan` Skill 已存在于 `~/.claude/skills/plan/`
- Brain 可能已有调用 Skills 的机制（查看 task-router.js 等）
- desires 相关代码可能在 `packages/brain/src/desire-act.js` 或类似文件
- 需要创建数据库 migration 添加字段

## 优先级

**P0** - 这是 Cecelia 24/7 自主运行的核心基础设施
