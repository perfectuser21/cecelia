---
id: dashboard-api-integration
version: 1.0.0
created: 2026-01-27
updated: 2026-01-27
changelog:
  - 1.0.0: 初始版本 - Core Dashboard API 集成
---

# PRD - Core Dashboard API Integration

## 需求来源

Core 网站（cecelia-frontend）需要显示 Cecelia Quality Platform 的实时状态，成为生命体的"前台意识界面"。

## 核心目标

让 Core 网站通过 API 实时显示 4 块核心内容：
1. **全局 Health** - 绿/黄/红 + 最近一次 run
2. **Queue** - 队列长度 + 前 10 个待执行任务
3. **Runs** - 最近 20 次运行（成功/失败/耗时/摘要）
4. **Top Failures** - 失败清单（可点击详情）

## 架构设计

```
Core 网站 (Next.js)
    │
    │ Fetch API
    ▼
Dashboard API (Express.js, Port 5681)
    │
    │ Read
    ▼
state/queue/runs/db (VPS 本地数据)
```

---

## 功能需求

### 1. Dashboard API Server (P0)

**技术栈**: Express.js + Node.js

**端口**: 5681

**P0 端点**（只读，无需鉴权）:

1. `GET /api/state`
   - 返回: 全局系统状态（health, queueLength, lastRun, stats）
   - 数据源: `state/state.json` + `db/cecelia.db`

2. `GET /api/queue?limit=10`
   - 返回: 队列状态 + 前 N 个任务
   - 数据源: `queue/queue.jsonl`

3. `GET /api/runs?limit=20&status=`
   - 返回: 最近运行列表
   - 数据源: `runs/` 目录

4. `GET /api/runs/:runId`
   - 返回: 单次运行详情（task, summary, result, evidence, logs）
   - 数据源: `runs/<runId>/`

5. `GET /api/runs/:runId/evidence/:filename`
   - 返回: 证据文件下载
   - 数据源: `runs/<runId>/evidence/`

6. `GET /api/failures?limit=10`
   - 返回: 最近失败的运行
   - 数据源: `runs/` 目录（筛选 status=failed）

7. `GET /api/health`
   - 返回: API 健康检查

**P1 端点**（写入，需要鉴权）:

8. `POST /api/enqueue`
   - 功能: 从 Dashboard 下发任务
   - 鉴权: `x-cecelia-token` header
   - 调用: `gateway/gateway.sh add`

**配置**:
- 环境变量: `CECELIA_API_PORT`, `CECELIA_API_HOST`, `CECELIA_API_TOKEN`
- CORS: 允许所有来源（生产环境需限制）
- 日志: 输出到 `/tmp/cecelia-api.log`

---

### 2. API 客户端代码 (TypeScript)

**文件**: 创建参考代码在 `api/README.md` 中

**功能**:
- 类型定义（SystemState, QueueStatus, Run, RunDetail, etc.）
- API 函数（getSystemState, getQueueStatus, getRecentRuns, etc.）
- 错误处理

**使用方式**:
```typescript
import { getSystemState } from '@/lib/cecelia-api';

const state = await getSystemState();
```

---

### 3. 启动脚本

**文件**: `scripts/start-all.sh`

**功能**:
1. 检查依赖（Node.js, SQLite3, jq）
2. 初始化数据库（如果不存在）
3. 启动 Gateway HTTP（Port 5680）
4. 启动 Dashboard API（Port 5681）
5. 测试服务健康

**停止脚本**: `scripts/stop-all.sh`

---

### 4. 文档

1. **API README** (`api/README.md`)
   - API 端点说明
   - 请求/响应示例
   - 部署指南（PM2, systemd）
   - 安全建议
   - 测试脚本

2. **集成指南** (`docs/CORE_DASHBOARD_INTEGRATION.md`)
   - Core 网站环境变量配置
   - TypeScript 代码示例（完整）
   - Dashboard 页面示例（Overview, Run Detail）
   - 故障排查

3. **快速上手** (`CORE_DASHBOARD_QUICKSTART.md`)
   - 3 步快速集成
   - 最简 Dashboard 页面代码
   - 常见问题

---

## 数据格式

### GET /api/state 响应

```json
{
  "health": "ok",
  "queueLength": 3,
  "priorityCounts": {
    "P0": 1,
    "P1": 1,
    "P2": 1
  },
  "lastRun": {
    "taskId": "uuid",
    "completedAt": "2026-01-27T10:30:00Z",
    "status": "succeeded"
  },
  "stats": {
    "totalTasks": 142,
    "successRate": 0.95
  },
  "systemHealth": {
    "inbox_count": 0,
    "todo_count": 2,
    "doing_count": 1,
    "done_count": 139,
    "failed_24h": 3
  }
}
```

### GET /api/queue 响应

```json
{
  "total": 5,
  "byPriority": {
    "P0": 1,
    "P1": 2,
    "P2": 2
  },
  "tasks": [
    {
      "taskId": "uuid",
      "source": "cloudcode",
      "intent": "runQA",
      "priority": "P0",
      "payload": {...},
      "createdAt": "2026-01-27T10:00:00Z"
    }
  ]
}
```

### GET /api/runs 响应

```json
{
  "runs": [
    {
      "runId": "run-uuid",
      "createdAt": "2026-01-27T10:30:00Z",
      "task": {
        "taskId": "task-uuid",
        "intent": "runQA",
        "priority": "P0",
        "source": "cloudcode"
      },
      "status": "succeeded",
      "duration": 123,
      "exitCode": 0
    }
  ],
  "stats": {
    "total": 100,
    "succeeded": 95,
    "failed": 3,
    "running": 2
  }
}
```

---

## 技术实现

### API Server 实现

**核心逻辑**:

1. **读取 state.json**:
```javascript
const state = readJSON(STATE_FILE, defaultState);
```

2. **读取 queue.jsonl**:
```javascript
const queue = readJSONL(QUEUE_FILE);
```

3. **读取 runs 目录**:
```javascript
const runDirs = fs.readdirSync(RUNS_DIR)
  .filter(name => fs.statSync(path.join(RUNS_DIR, name)).isDirectory())
  .map(name => {
    const taskFile = path.join(RUNS_DIR, name, 'task.json');
    const summaryFile = path.join(RUNS_DIR, name, 'summary.json');
    // ...
  });
```

4. **查询 SQLite**:
```javascript
const { stdout } = await execPromise(`sqlite3 -json "${DB_FILE}" "${sql}"`);
return JSON.parse(stdout || '[]');
```

**依赖**:
```json
{
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5"
  }
}
```

---

## 验收标准

### P0 - API Server

- [ ] `api/server.js` 已创建，包含 7 个 P0 端点
- [ ] `api/package.json` 已创建，依赖正确
- [ ] 启动后端口 5681 可访问
- [ ] `GET /api/health` 返回 200
- [ ] `GET /api/state` 返回正确的系统状态
- [ ] `GET /api/queue` 返回队列数据
- [ ] `GET /api/runs` 返回运行列表
- [ ] `GET /api/runs/:runId` 返回运行详情
- [ ] `GET /api/failures` 返回失败列表
- [ ] CORS 配置正确，允许跨域请求

### P0 - 启动脚本

- [ ] `scripts/start-all.sh` 已创建，可执行
- [ ] 运行后自动启动 Gateway HTTP 和 Dashboard API
- [ ] 自动检测服务健康
- [ ] `scripts/stop-all.sh` 已创建，可停止所有服务

### P0 - 文档

- [ ] `api/README.md` 包含完整的 API 文档
- [ ] `docs/CORE_DASHBOARD_INTEGRATION.md` 包含集成指南
- [ ] `CORE_DASHBOARD_QUICKSTART.md` 包含快速上手指南
- [ ] 所有文档包含代码示例和故障排查

### P1 - 写入端点

- [ ] `POST /api/enqueue` 已实现
- [ ] Token 鉴权正确（`x-cecelia-token`）
- [ ] 调用 `gateway/gateway.sh add` 成功

---

## 测试方案

### 单元测试

```bash
# 测试 API 健康
curl http://localhost:5681/api/health | jq .

# 测试 state 端点
curl http://localhost:5681/api/state | jq .

# 测试 queue 端点
curl http://localhost:5681/api/queue | jq .

# 测试 runs 端点
curl http://localhost:5681/api/runs?limit=5 | jq .

# 测试 failures 端点
curl http://localhost:5681/api/failures | jq .
```

### 集成测试

```bash
# 1. 提交任务
bash gateway/gateway.sh add cloudcode runQA P0 '{"project":"cecelia-quality"}'

# 2. 执行任务
bash worker/worker.sh

# 3. 查看 API 返回
curl http://localhost:5681/api/state | jq .
curl http://localhost:5681/api/runs?limit=1 | jq .
```

### 手动测试

- [ ] Core 网站能成功调用 API
- [ ] Dashboard 页面正确显示数据
- [ ] 点击 Run ID 跳转到详情页
- [ ] 详情页显示 Evidence 链接
- [ ] 下载 Evidence 文件成功

---

## 部署方案

### VPS 端

**方式 1: 后台运行**
```bash
nohup node api/server.js > /tmp/cecelia-api.log 2>&1 &
```

**方式 2: PM2**
```bash
npm install -g pm2
pm2 start api/server.js --name cecelia-api
pm2 save
pm2 startup
```

**方式 3: Systemd**
```ini
[Unit]
Description=Cecelia Quality API
After=network.target

[Service]
Type=simple
User=xx
WorkingDirectory=/home/xx/dev/cecelia-quality/api
ExecStart=/usr/bin/node server.js
Restart=always
Environment=CECELIA_API_PORT=5681

[Install]
WantedBy=multi-user.target
```

### Nginx 反向代理（可选）

```nginx
server {
    listen 80;
    server_name api-cecelia.zenjoymedia.media;

    location /api/ {
        proxy_pass http://127.0.0.1:5681/api/;
        proxy_set_header Host $host;

        # CORS
        add_header Access-Control-Allow-Origin *;
    }
}
```

---

## 安全考虑

### P0（只读端点）

- ✅ 只返回运行状态，无敏感数据
- ✅ 可以公开暴露
- ⚠️ 建议 Nginx 限流（防止滥用）

### P1（写入端点）

- ⚠️ POST /api/enqueue 需要 Token 鉴权
- ✅ 环境变量 `CECELIA_API_TOKEN` 配置
- ✅ 或使用 Nginx IP 白名单

---

## 性能要求

- API 响应时间 < 500ms
- 支持并发 10+ 请求
- 内存占用 < 100MB
- CPU 占用 < 5%

---

## 依赖关系

**前置条件**:
- Gateway System MVP (已完成)
- Worker System (已完成)
- State System (已完成)
- Database (SQLite, 已完成)

**后续功能**:
- Core 网站 Dashboard 页面
- 实时刷新机制
- 图表可视化

---

## 风险和缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| API 性能问题 | 响应慢 | 使用缓存（state.json），避免重复读文件 |
| CORS 问题 | 前端无法调用 | 正确配置 CORS，测试跨域请求 |
| 大量 runs 目录 | 读取慢 | 只读取最近 N 个，定期清理旧数据 |
| 服务崩溃 | 数据不可见 | 使用 PM2 或 systemd 自动重启 |

---

## 里程碑

- **Day 1**: API Server 开发完成，本地测试通过
- **Day 2**: 部署到 VPS，Core 网站集成测试
- **Day 3**: 文档完善，故障排查，优化性能

---

## 参考资料

- Express.js 文档: https://expressjs.com/
- CORS 配置: https://github.com/expressjs/cors
- PM2 文档: https://pm2.keymetrics.io/

---

**优先级**: P0
**预计工时**: 已完成（所有代码已生成）
**责任人**: AI (Claude)
**验收人**: User
