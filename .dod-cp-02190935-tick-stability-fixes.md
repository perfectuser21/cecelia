---
id: dod-cp-02190935-tick-stability-fixes
version: 1.0.0
created: 2026-02-19
updated: 2026-02-19
changelog:
  - 1.0.0: 初始版本
---

# DoD: Tick 系统稳定性修复

## 验收清单

### P0-1: 冷启动 ramp 限制
- [ ] tick.js getRampedDispatchMax() 冷启动时返回 min(2, effectiveDispatchMax) 而非 effectiveDispatchMax
- [ ] 测试：冷启动 ramp 验证（新增测试用例）

### P0-2: getDailyFocus null fallback
- [ ] getDailyFocus() 返回 null 时，executeTick() 不再直接 return
- [ ] null 时继续执行 dispatch（从所有 queued tasks 中派发）
- [ ] 测试：getDailyFocus null 时 tick 继续执行

### P0-3: layers_triggered undefined bug
- [ ] tick.js:1144 移除对 decompSummary.layers_triggered 的引用，或返回值中包含该字段
- [ ] decomposition check 失败时有清晰的错误日志

### P0-4: Check 6 cancelled 拼写
- [ ] decomposition-checker.js Check 6 SQL 包含 'canceled' 和 'cancelled' 两种拼写
- [ ] 测试：canceled 状态任务被正确识别为已存在，不再重复创建

### P1-1: CPU 阈值放宽
- [ ] slot-allocator.js CPU 阈值系数从 0.85 → 0.95，或 Pool C 保底 1 slot（pressure < 1.5 时）
- [ ] 8 核机器运行 5-6 个任务时 dispatch_allowed 仍为 true

### P1-2: --max-turns 限制
- [ ] /home/xx/bin/cecelia-run 的 claude -p 命令加入 --max-turns 参数
- [ ] 默认值合理（建议 10 turns）

### P1-3: execution-callback 冷却期
- [ ] routes.js execution-callback 触发下一个 tick 时有延迟（5-30s）
- [ ] 防止任务连续完成时瞬间填满所有 slots

### P1-4: Migration 040
- [ ] brain/migrations/040_fix_initiative_kr_links.sql 创建
- [ ] initiative 的 kr_id 更新为正确的 KR
- [ ] project_kr_links 有 cecelia-core → KR1/2/3 关联
- [ ] selfcheck.js EXPECTED_SCHEMA_VERSION 更新为 '040'
- [ ] schema_version 表有 migration 040 记录

### 通用
- [ ] brain/package.json 版本 bump（patch: 1.50.7 → 1.50.8）
- [ ] brain/package-lock.json 同步
- [ ] .brain-versions 同步
- [ ] 所有现有测试通过（vitest）
- [ ] facts-check.mjs 通过

## Test Mapping（CI 检查项）

| DoD 条目 | 测试文件 |
|---------|---------|
| P0-1 冷启动 ramp | brain/src/__tests__/tick-stability.test.js（新建）|
| P0-2 getDailyFocus null | brain/src/__tests__/tick-stability.test.js |
| P0-4 cancelled dedup | brain/src/__tests__/decomp-checker-dedup.test.js（更新）|
| P1-1 CPU 阈值 | brain/src/__tests__/slot-allocator.test.js（更新）|
| Migration 040 | brain/src/__tests__/migrations.test.js（更新）|
