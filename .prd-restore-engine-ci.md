---
id: prd-restore-engine-ci
version: 1.0.0
created: 2026-02-25
updated: 2026-02-25
changelog:
  - 1.0.0: 初始版本
---

# PRD: 恢复 Engine CI 严格检查到 Monorepo

## 背景

Cecelia monorepo 迁移后，原 Engine CI（1070 行，14 个 job）被简化为 49 行仅含 npm test + shell syntax。
95% 的质量门禁丢失，包括 DevGate、RCI 覆盖率、Known-Failures 保护、Config Audit、Impact Check 等。

## 目标

1. 将 Engine CI 的严格检查恢复到 monorepo 级别
2. 统一 Brain CI、Engine CI、Workspace CI 的触发和 gate 模式
3. 确保所有代码变更都过 DevGate 质量门禁

## 范围

### 需要恢复的检查（从原 engine CI）

| 检查 | 优先级 | 说明 |
|------|--------|------|
| TypeCheck | L1 | npm run typecheck |
| Known-Failures 白名单 | P0 | 严格校验，防止恶意修改 |
| Build | L1 | npm run build |
| PRD/DoD Gate | L2A | 阻止工作文档进入 main |
| DevGate 四重检查 | P0-P1 | 脚本存在性 + DoD映射 + P0/P1 RCI + RCI覆盖率 |
| Evidence Gate | L2A | 质量证据生成和校验 |
| Known-Failures Protection | P0 | [INFRA] 标记 + JSON 合法性 |
| Config Audit | P1 | 关键配置变更审计 |
| Impact Check | P0-1 | 能力变更强制登记 |
| Contract Drift Check | - | 派生视图同步 |

### 需要适配的路径

- `scripts/devgate/` → `packages/engine/scripts/devgate/`
- `ci/scripts/` → `packages/engine/ci/scripts/`
- `ci/known-failures.json` → `packages/engine/ci/known-failures.json`

### 统一 CI 触发模式

所有 3 个 CI workflow 统一为：
- PR 无条件触发（去掉 paths filter）
- 内部用 `dorny/paths-filter` 检测变更
- 各自 gate job 统一命名

## 不在范围

- Auto-merge workflow（后续任务）
- AI Review L2C（依赖外部 API，后续任务）
- Notion 通知（依赖 Secrets，后续任务）
- Release Check（单分支模式无 develop→main，需重新设计）

## 成功标准

1. Engine CI 恢复到 ≥12 个检查 job
2. Brain CI + Engine CI + Workspace CI 统一触发模式
3. 非相关变更 PR 快速跳过（< 30s）
4. 所有必需 check 在 required_status_checks 中
