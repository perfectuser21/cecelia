---
id: prd-inbox-heartbeat
version: 1.1.0
created: 2026-02-22
updated: 2026-02-22
changelog:
  - 1.1.0: èåˆå®¡æŸ¥åé¦ˆï¼ˆå»é‡èŠ‚æµã€ç¡¬çº¦æŸã€äº‹åŠ¡ã€æˆªæ–­ã€sourceåˆ—ã€ç´¢å¼•ã€options schemaã€expiredçŠ¶æ€ï¼‰
  - 1.0.0: åˆå§‹ç‰ˆæœ¬
---

# PRD: æ”¶ä»¶ç®± + ææ¡ˆç³»ç»Ÿ + çµæ´»å·¡æ£€

## èƒŒæ™¯

### é—®é¢˜

Cecelia å½“å‰ä¸ç”¨æˆ·çš„æ²Ÿé€šæ˜¯**å•å‘çš„**ï¼š

```
Cecelia å¹²æ´» â”€â”€â†’ æ—¥æŠ¥/çŠ¶æ€ â”€â”€â†’ ç”¨æˆ·çœ‹ä¸€çœ¼ï¼ˆè¢«åŠ¨ï¼‰
ç”¨æˆ· â”€â”€â†’ curl API / Dashboard â”€â”€â†’ Cecelia æ‰§è¡Œï¼ˆæŠ€æœ¯é—¨æ§›é«˜ï¼‰
```

**ç¼ºå¤±çš„ç¯èŠ‚**ï¼šCecelia é‡åˆ°ä¸ç¡®å®šçš„äº‹æ—¶ï¼Œæ²¡æœ‰æ¸ é“ä¸»åŠ¨é—®ç”¨æˆ·ã€‚ç”¨æˆ·ä¹Ÿçœ‹ä¸åˆ° Cecelia åœ¨æ£€æŸ¥ä»€ä¹ˆã€æƒ³åšä»€ä¹ˆã€ä¸ºä»€ä¹ˆè¿™ä¹ˆå†³ç­–ã€‚

### ç°çŠ¶

| æœºåˆ¶ | æ–¹å‘ | é—®é¢˜ |
|------|------|------|
| Dashboard çŠ¶æ€é¡µ | Cecelia â†’ ç”¨æˆ· | åªèƒ½çœ‹ï¼Œä¸èƒ½å› |
| æ—¥æŠ¥ (daily_logs) | Cecelia â†’ ç”¨æˆ· | äº‹åæ€»ç»“ï¼Œä¸æ˜¯å®æ—¶ |
| pending_actions | Cecelia â†” ç”¨æˆ· | **å·²æœ‰ä½†åªç”¨äº 3 ç§å±é™©æ“ä½œ**ï¼Œæ— å‰ç«¯ç•Œé¢ |
| API æäº¤ä»»åŠ¡ | ç”¨æˆ· â†’ Cecelia | çº¯æŠ€æœ¯æ¥å£ |
| tick.js æ£€æŸ¥é€»è¾‘ | å†…éƒ¨ | ç¡¬ç¼–ç ï¼Œç”¨æˆ·çœ‹ä¸åˆ°ä¹Ÿæ”¹ä¸äº† |

### å·²æœ‰åŸºç¡€

**pending_actions è¡¨**ï¼ˆmigration 007ï¼‰å·²ç»å®ç°äº†ï¼š
- å®Œæ•´çš„ schemaï¼ˆid, action_type, params, context, status, expires_at, reviewed_by...ï¼‰
- ä¸¤é˜¶æ®µæäº¤ï¼ˆenqueueDangerousAction â†’ approve/rejectï¼‰
- æ‚²è§‚é”é˜²å¹¶å‘
- 24h è‡ªåŠ¨è¿‡æœŸ
- 3 ä¸ª API ç«¯ç‚¹ï¼ˆGET åˆ—è¡¨ / POST æ‰¹å‡† / POST æ‹’ç»ï¼‰

**ç¼ºå°‘çš„**ï¼š
- åªæœ‰ 3 ç§ action_type ä¼šè¿›å…¥ pending_actionsï¼ˆquarantine_task, request_human_review, adjust_strategyï¼‰
- æ—  WebSocket æ¨é€ï¼ˆå‰ç«¯ä¸çŸ¥é“æœ‰æ–°ææ¡ˆï¼‰
- æ— å‰ç«¯ UIï¼ˆç”¨æˆ·çœ‹ä¸åˆ° pending_actionsï¼‰
- æ— å¯¹è¯èƒ½åŠ›ï¼ˆåªèƒ½æ‰¹å‡†/æ‹’ç»ï¼Œä¸èƒ½è¿½é—®ï¼‰
- æ—  HEARTBEAT.md çµæ´»å·¡æ£€

---

## ç›®æ ‡

**è®© Cecelia å’Œç”¨æˆ·ä¹‹é—´æœ‰ä¸€ä¸ª"æ”¶ä»¶ç®±"â€”â€”Cecelia ä¸»åŠ¨æé—®ã€ç”¨æˆ·è½»æ¾å›å¤ã€å†³ç­–ç•™ç—•ã€‚**

### é‡åŒ–ç›®æ ‡

| æŒ‡æ ‡ | ç°çŠ¶ | ç›®æ ‡ |
|------|------|------|
| ç”¨æˆ·èƒ½çœ‹åˆ°çš„ Cecelia å†³ç­– | 0ï¼ˆçœ‹ä¸åˆ°ï¼‰ | æ‰€æœ‰é‡è¦å†³ç­–å¯è§ |
| ç”¨æˆ·å›å¤æ–¹å¼ | curl API | Dashboard ç‚¹å‡» |
| OKR æ‹†è§£ç¡®è®¤ | è‡ªåŠ¨æ‰§è¡Œï¼ˆç”¨æˆ·ä¸çŸ¥é“ï¼‰ | æ‹†å®Œåææ¡ˆç¡®è®¤ |
| å¼‚å¸¸å¤„ç†æ–¹å¼ | Cecelia è‡ªå·±å†³å®š | ä¸¥é‡å¼‚å¸¸ææ¡ˆç»™ç”¨æˆ·é€‰æ‹© |
| tick æ£€æŸ¥å¯é…ç½®æ€§ | æ”¹ä»£ç  | æ”¹ Markdown æ–‡ä»¶ |

---

## æ¶æ„

### ä¸¤ä¸ªå­ç³»ç»Ÿ

```
å­ç³»ç»Ÿ Aï¼šæ”¶ä»¶ç®± + ææ¡ˆï¼ˆæ‰©å±• pending_actionsï¼‰
  â”œâ”€â”€ æ‰©å±•ææ¡ˆç±»å‹ï¼ˆä» 3 ç§ â†’ 7+ ç§ï¼‰
  â”œâ”€â”€ æ·»åŠ å¯¹è¯èƒ½åŠ›ï¼ˆcomments å­—æ®µï¼‰
  â”œâ”€â”€ WebSocket å®æ—¶æ¨é€
  â””â”€â”€ Dashboard æ”¶ä»¶ç®± UI

å­ç³»ç»Ÿ Bï¼šHEARTBEAT.md çµæ´»å·¡æ£€ï¼ˆäº§å‡ºææ¡ˆï¼‰
  â”œâ”€â”€ HEARTBEAT.md è‡ªç„¶è¯­è¨€æ£€æŸ¥æ¸…å•
  â”œâ”€â”€ tick.js å®šæœŸè¯»å– â†’ å‘ç»™ L1 ä¸˜è„‘
  â”œâ”€â”€ å·¡æ£€ç»“æœ â†’ è‡ªåŠ¨æ‰§è¡Œ æˆ– åˆ›å»ºææ¡ˆ
  â””â”€â”€ Dashboard å¯ç¼–è¾‘æ£€æŸ¥æ¸…å•
```

**å…³ç³»**ï¼šB äº§å‡ºææ¡ˆ â†’ A å±•ç¤ºå’Œå¤„ç†ã€‚

```
HEARTBEAT.mdï¼ˆç”¨æˆ·å†™çš„è§„åˆ™ï¼‰
  â†“
tick.js æ¯ N æ¬¡è¯»å–
  â†“
L1 ä¸˜è„‘ï¼ˆHaikuï¼‰åˆ¤æ–­
  â†“
è¾“å‡º Decision
  â”œâ”€â”€ ç¡®å®šçš„äº‹ â†’ decision-executor ç›´æ¥æ‰§è¡Œ
  â””â”€â”€ ä¸ç¡®å®šçš„äº‹ â†’ åˆ›å»ºææ¡ˆ â†’ æ”¶ä»¶ç®± â†’ ç”¨æˆ·å†³å®š
```

---

## æ–¹æ¡ˆè®¾è®¡

### Phase 1: ææ¡ˆç³»ç»Ÿæ‰©å±• + WebSocket æ¨é€ï¼ˆåç«¯ï¼‰

**æ ¸å¿ƒç›®æ ‡**ï¼šè®© pending_actions ä»"å±é™©æ“ä½œå®¡æ‰¹"å‡çº§ä¸º"é€šç”¨ææ¡ˆç³»ç»Ÿ"ï¼ŒåŠ  WebSocket æ¨é€ã€‚

#### 1.1 æ‰©å±•ææ¡ˆç±»å‹

**ä¿®æ”¹æ–‡ä»¶**ï¼š`decision-executor.js`

åœ¨ç°æœ‰ ACTION_WHITELIST ä¸­æ–°å¢ææ¡ˆç±»å‹ï¼š

```javascript
// æ–°å¢ææ¡ˆç±»å‹ï¼ˆå…¨éƒ¨ dangerous: trueï¼Œè¿›å…¥ pending_actionsï¼‰
const PROPOSAL_TYPES = {
  // åŸæœ‰
  'quarantine_task':      { dangerous: true, description: 'éš”ç¦»ä»»åŠ¡' },
  'request_human_review': { dangerous: true, description: 'è¯·æ±‚äººå·¥ç¡®è®¤' },
  'adjust_strategy':      { dangerous: true, description: 'è°ƒæ•´ç³»ç»Ÿç­–ç•¥' },

  // æ–°å¢
  'propose_decomposition': { dangerous: true, description: 'OKR/Initiative æ‹†è§£ç»“æœç¡®è®¤' },
  'propose_weekly_plan':   { dangerous: true, description: 'æœ¬å‘¨è®¡åˆ’ç¡®è®¤' },
  'propose_priority_change': { dangerous: true, description: 'ä¼˜å…ˆçº§è°ƒæ•´å»ºè®®' },
  'propose_anomaly_action': { dangerous: true, description: 'å¼‚å¸¸å¤„ç†æ–¹æ¡ˆé€‰æ‹©' },
  'propose_milestone_review': { dangerous: true, description: 'Initiative å®ŒæˆéªŒæ”¶' },
  'heartbeat_finding':     { dangerous: true, description: 'å·¡æ£€å‘ç°å¼‚å¸¸' },
};
```

#### 1.2 pending_actions è¡¨æ‰©å±•

**æ–°å»º Migration 054**ï¼š

```sql
-- Migration 054: extend_pending_actions_for_inbox
ALTER TABLE pending_actions ADD COLUMN IF NOT EXISTS
  category TEXT DEFAULT 'approval';
  -- 'approval'ï¼ˆåŸæœ‰å®¡æ‰¹ï¼‰, 'proposal'ï¼ˆææ¡ˆï¼‰, 'info'ï¼ˆé€šçŸ¥ï¼‰

ALTER TABLE pending_actions ADD COLUMN IF NOT EXISTS
  comments JSONB DEFAULT '[]'::jsonb;
  -- å¯¹è¯è®°å½•ï¼š[{role: "cecelia"|"user", text: "...", ts: "..."}]

ALTER TABLE pending_actions ADD COLUMN IF NOT EXISTS
  options JSONB DEFAULT NULL;
  -- é€‰é¡¹ç»“æ„ï¼ˆå¼‚å¸¸å¤„ç†æ—¶ç”¨ï¼‰ï¼š
  -- [{id: "a", label: "å°†æ­¤ä»»åŠ¡æ ‡è®°ä¸ºå¤±è´¥å¹¶é‡è¯•", action: {type: "retry_task", params: {task_id: 123}}, recommended: true}, ...]
  -- executeSelectedOption ç›´æ¥å– option.action èµ° executeDecision()

ALTER TABLE pending_actions ADD COLUMN IF NOT EXISTS
  priority TEXT DEFAULT 'normal';
  -- 'urgent'ï¼ˆçº¢è‰²ï¼Œ24h å†…å†³ç­–ï¼‰: å¼‚å¸¸å¤„ç†ã€åœæœºé£é™©
  -- 'normal'ï¼ˆé»„è‰²ï¼Œ72h å†…å†³ç­–ï¼‰: ç­–ç•¥ç±»ã€è®¡åˆ’ç±»
  -- 'info'ï¼ˆç°è‰²ï¼‰: çº¯é€šçŸ¥

ALTER TABLE pending_actions ADD COLUMN IF NOT EXISTS
  source TEXT DEFAULT 'system';
  -- æ¥æºï¼šheartbeat_inspection / cortex / planner / okr_decomposer / initiative_closer / manual
  -- ç”¨äºå‰ç«¯ç­›é€‰å’Œåç«¯ç»Ÿè®¡

ALTER TABLE pending_actions ADD COLUMN IF NOT EXISTS
  signature TEXT DEFAULT NULL;
  -- å»é‡ç­¾åï¼šentity_type:entity_id:action_typeï¼ˆä¾‹å¦‚ "initiative:abc123:propose_milestone_review"ï¼‰
  -- åŒä¸€ signature çš„ pending_approval ææ¡ˆ 24h å†…åªå…è®¸ 1 æ¡

-- ç´¢å¼•ï¼ˆInbox åˆ—è¡¨æŸ¥è¯¢ä¼˜åŒ–ï¼‰
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_pending_actions_inbox
  ON pending_actions (status, priority, category, created_at DESC);

CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_pending_actions_signature
  ON pending_actions (signature, status, created_at DESC)
  WHERE signature IS NOT NULL;
```

**options ç»“æ„çº¦å®š**ï¼š

```json
{
  "id": "a",
  "label": "å°†æ­¤ä»»åŠ¡æ ‡è®°ä¸ºå¤±è´¥å¹¶é‡è¯•ä¸€æ¬¡",
  "action": {
    "type": "retry_task",
    "params": { "task_id": 123, "max_retries": 1 }
  },
  "dangerous": false,
  "recommended": true
}
```

`executeSelectedOption` åªéœ€æ ¡éªŒ `action.type` åœ¨ whitelist â†’ è°ƒç”¨ `executeDecision({ actions: [option.action] })`ã€‚

#### 1.2.1 ææ¡ˆå»é‡/èŠ‚æµå±‚ï¼ˆCRITICALï¼‰

**åœ¨ `enqueueDangerousAction()` å†…éƒ¨**ï¼Œåˆ›å»ºææ¡ˆå‰åšå»é‡æ£€æŸ¥ï¼š

```javascript
// proposal-throttle: åŒä¸€ signature çš„ pending_approval ææ¡ˆ 24h å†…åªå…è®¸ 1 æ¡
async function shouldThrottleProposal(pool, signature) {
  if (!signature) return false;
  const result = await pool.query(`
    SELECT id FROM pending_actions
    WHERE signature = $1
      AND status = 'pending_approval'
      AND created_at > NOW() - INTERVAL '24 hours'
    LIMIT 1
  `, [signature]);
  return result.rowCount > 0;
}
```

**ç­¾åç”Ÿæˆè§„åˆ™**ï¼š

| ææ¡ˆç±»å‹ | signature æ ¼å¼ | æ•ˆæœ |
|---------|---------------|------|
| propose_decomposition | `kr:{kr_id}:propose_decomposition` | åŒä¸€ KR 24h å†…åªæä¸€æ¬¡ |
| propose_milestone_review | `initiative:{id}:propose_milestone_review` | åŒä¸€ Initiative ä¸é‡å¤ |
| propose_priority_change | `kr:{kr_id}:propose_priority_change` | åŒä¸€ KR 24h å†…åªå»ºè®®ä¸€æ¬¡ |
| heartbeat_finding | `heartbeat:{finding_hash}:heartbeat_finding` | åŒä¸€å‘ç°ä¸é‡å¤ |
| propose_weekly_plan | `weekly_plan:{week_iso}` | æ¯å‘¨åªç”Ÿæˆä¸€ä¸ª |

#### 1.2.2 è¿‡æœŸçŠ¶æ€

ææ¡ˆè¿‡æœŸåä¸åˆ é™¤ï¼Œæ”¹ä¸º `expired` çŠ¶æ€ï¼š

```sql
-- å·²æœ‰çš„ 24h è¿‡æœŸé€»è¾‘æ”¹ä¸ºï¼š
UPDATE pending_actions
SET status = 'expired'
WHERE status = 'pending_approval'
  AND expires_at < NOW();
```

è¿‡æœŸææ¡ˆå‡ºç°åœ¨"å·²å¤„ç†"åˆ—è¡¨ï¼Œæ ‡è®°ä¸º"è‡ªåŠ¨è¿‡æœŸ"ã€‚å¦‚æœä¸‹æ¬¡å·¡æ£€/planner ä»è®¤ä¸ºé—®é¢˜å­˜åœ¨ï¼Œå¯ç”Ÿæˆæ–°ææ¡ˆï¼ˆsignature å»é‡åªçœ‹ pending_approvalï¼Œä¸çœ‹ expiredï¼‰ã€‚

#### 1.3 å¯¹è¯ API

**ä¿®æ”¹æ–‡ä»¶**ï¼š`routes.js`

æ–°å¢ç«¯ç‚¹ï¼š

```javascript
// POST /api/brain/pending-actions/:id/comment
// ç”¨æˆ·è¿½é—®æˆ– Cecelia å›å¤
router.post('/pending-actions/:id/comment', async (req, res) => {
  const { id } = req.params;
  const { text, role = 'user' } = req.body;

  // æ£€æŸ¥ææ¡ˆçŠ¶æ€ + è¿‡æœŸ
  const check = await pool.query(
    'SELECT status, expires_at FROM pending_actions WHERE id = $1', [id]
  );
  if (check.rowCount === 0) return res.status(404).json({ error: 'Not found' });
  if (check.rows[0].status !== 'pending_approval') return res.status(400).json({ error: 'Already processed' });
  if (check.rows[0].expires_at && new Date(check.rows[0].expires_at) < new Date()) {
    return res.status(410).json({ error: 'Proposal expired' });
  }

  // è¿½åŠ  comment
  const result = await pool.query(`
    UPDATE pending_actions
    SET comments = comments || $1::jsonb
    WHERE id = $2 AND status = 'pending_approval'
    RETURNING id, comments, action_type, params
  `, [JSON.stringify([{ role, text, ts: new Date().toISOString() }]), id]);

  // å¦‚æœæ˜¯ç”¨æˆ·è¿½é—®ï¼Œè§¦å‘ L1 ä¸˜è„‘ç”Ÿæˆå›å¤
  if (role === 'user') {
    const action = result.rows[0];
    scheduleProposalReply(id, action, text); // å¼‚æ­¥ï¼Œä¸é˜»å¡å“åº”
  }

  // WebSocket å¹¿æ’­
  broadcast('proposal:comment', { id, comment: { role, text } });

  res.json({ success: true });
});
```

```javascript
// POST /api/brain/pending-actions/:id/select
// ç”¨æˆ·é€‰æ‹©é€‰é¡¹ï¼ˆå¼‚å¸¸å¤„ç†åœºæ™¯ï¼‰
// CRITICAL: æ•´ä¸ª FOR UPDATE + execute + UPDATE å¿…é¡»åœ¨åŒä¸€äº‹åŠ¡å†…
router.post('/pending-actions/:id/select', async (req, res) => {
  const { id } = req.params;
  const { option_id, reviewer = 'dashboard-user' } = req.body;
  const client = await pool.connect();

  try {
    await client.query('BEGIN');

    // æ‚²è§‚é”è¯»å–
    const action = await client.query(
      'SELECT * FROM pending_actions WHERE id = $1 AND status = $2 FOR UPDATE',
      [id, 'pending_approval']
    );
    if (action.rows.length === 0) {
      await client.query('ROLLBACK');
      return res.status(404).json({ error: 'Not found or already processed' });
    }

    const options = action.rows[0].options || [];
    const selected = options.find(o => o.id === option_id);
    if (!selected) {
      await client.query('ROLLBACK');
      return res.status(400).json({ error: 'Invalid option' });
    }

    // æ ¡éªŒ action.type åœ¨ whitelist â†’ executeDecision
    const executionResult = await executeSelectedOption(selected, action.rows[0]);

    // æ ‡è®°ä¸º approvedï¼ˆåŒä¸€äº‹åŠ¡å†…ï¼‰
    await client.query(`
      UPDATE pending_actions
      SET status = 'approved', reviewed_by = $1, reviewed_at = NOW(),
          execution_result = $2
      WHERE id = $3
    `, [reviewer, JSON.stringify({ selected_option: option_id, ...executionResult }), id]);

    await client.query('COMMIT');
    broadcast('proposal:resolved', { id, option_id });
    res.json({ success: true, execution_result: executionResult });
  } catch (err) {
    await client.query('ROLLBACK');
    throw err;
  } finally {
    client.release();
  }
});
```

#### 1.4 WebSocket æ¨é€

**ä¿®æ”¹æ–‡ä»¶**ï¼š`websocket.js`

```javascript
// æ–°å¢äº‹ä»¶ç±»å‹
export const WS_EVENTS = {
  // ... åŸæœ‰
  PROPOSAL_CREATED: 'proposal:created',
  PROPOSAL_COMMENT: 'proposal:comment',
  PROPOSAL_RESOLVED: 'proposal:resolved',
};
```

**ä¿®æ”¹æ–‡ä»¶**ï¼š`decision-executor.js`

```javascript
// enqueueDangerousAction() æœ«å°¾åŠ ï¼š
broadcast('proposal:created', {
  id: result.rows[0].id,
  action_type: action.type,
  category: action.category || 'approval',
  priority: action.priority || 'normal',
  params: action.params,
  created_at: new Date().toISOString(),
});
```

#### 1.5 ææ¡ˆè‡ªåŠ¨å›å¤ï¼ˆè¿½é—®æ—¶ï¼‰

**æ–°å»ºå‡½æ•°**ï¼š`decision-executor.js` å†…

```javascript
const MAX_COMMENT_HISTORY = 10; // prompt é‡Œåªå¸¦æœ€è¿‘ N æ¡å¯¹è¯ï¼Œé˜²æ­¢æˆæœ¬çˆ†ç‚¸

async function scheduleProposalReply(actionId, action, userQuestion) {
  // æˆªæ–­å¯¹è¯å†å²ï¼šåªå–æœ€è¿‘ MAX_COMMENT_HISTORY æ¡
  const recentComments = (action.comments || []).slice(-MAX_COMMENT_HISTORY);

  const prompt = `ç”¨æˆ·å¯¹ä»¥ä¸‹ææ¡ˆè¿½é—®äº†é—®é¢˜ï¼Œè¯·å›å¤ã€‚
ææ¡ˆç±»å‹ï¼š${action.action_type}
ææ¡ˆå†…å®¹ï¼š${JSON.stringify(action.params).substring(0, 500)}
å¯¹è¯å†å²ï¼š${JSON.stringify(recentComments).substring(0, 1000)}
ç”¨æˆ·é—®é¢˜ï¼š${userQuestion}

å›å¤è¦ç®€æ´ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹ææ¡ˆå†…å®¹ï¼Œè¾“å‡º JSON actionã€‚å¦åˆ™è¾“å‡ºçº¯æ–‡æœ¬å›å¤ã€‚`;

  const rawReply = await callHaiku(prompt);

  // å¼ºæ ¡éªŒï¼šå°è¯•è§£æ JSONï¼Œåªæ¥å—åˆæ³•çš„ action schema
  let replyText = rawReply;
  try {
    const parsed = JSON.parse(rawReply);
    if (parsed && parsed.type && typeof parsed.params === 'object') {
      // åˆæ³•çš„ action JSON â†’ å¯ç”¨äºæ›´æ–°ææ¡ˆ paramsï¼ˆåç»­æ‰©å±•ï¼‰
      replyText = `å·²ç†è§£ï¼Œå»ºè®®æ‰§è¡Œ: ${parsed.type}`;
    }
    // ä¸æ˜¯ action schema â†’ å½“ä½œçº¯æ–‡æœ¬
  } catch {
    // ä¸æ˜¯ JSON â†’ æ­£å¸¸çº¯æ–‡æœ¬å›å¤
  }

  await pool.query(`
    UPDATE pending_actions
    SET comments = comments || $1::jsonb
    WHERE id = $2
  `, [JSON.stringify([{ role: 'cecelia', text: replyText, ts: new Date().toISOString() }]), actionId]);

  broadcast('proposal:comment', { id: actionId, comment: { role: 'cecelia', text: replyText } });
}
```

#### 1.6 è§¦å‘ææ¡ˆçš„é›†æˆç‚¹

åœ¨ç°æœ‰ä»£ç ä¸­ï¼Œä»¥ä¸‹ä½ç½®åˆ›å»ºææ¡ˆï¼š

| è§¦å‘ç‚¹ | ææ¡ˆç±»å‹ | æ–‡ä»¶ |
|--------|---------|------|
| ç§‹ç±³å®Œæˆ OKR æ‹†è§£å›è°ƒ | propose_decomposition | tick.jsï¼ˆexecution-callback å¤„ç†ï¼‰ |
| æ¯å‘¨ä¸€ç¬¬ä¸€ä¸ª tick | propose_weekly_plan | tick.js |
| Cortex RCA ç»“æœæœ‰å¤šä¸ªé€‰é¡¹ | propose_anomaly_action | cortex.js |
| Initiative ä¸‹æ‰€æœ‰ task completed | propose_milestone_review | initiative-closer.js |
| planner å»ºè®®æ”¹ä¼˜å…ˆçº§ | propose_priority_change | planner.js |
| HEARTBEAT.md å·¡æ£€å‘ç°å¼‚å¸¸ | heartbeat_finding | tick.jsï¼ˆPhase 2ï¼‰ |

**å®ç°æ–¹å¼**ï¼šåœ¨è¿™äº›ä½ç½®è°ƒç”¨å·²æœ‰çš„ `enqueueDangerousAction()`ï¼Œåªæ˜¯ action_type ä¸åŒã€‚

---

### Phase 2: HEARTBEAT.md çµæ´»å·¡æ£€ï¼ˆåç«¯ï¼‰

**æ ¸å¿ƒç›®æ ‡**ï¼šè®© tick.js æ”¯æŒè‡ªç„¶è¯­è¨€æ£€æŸ¥æ¸…å•ï¼Œç”¨ L1 ä¸˜è„‘æ‰§è¡Œï¼Œç»“æœèµ° Decision æµç¨‹ã€‚

#### 2.1 æ–°å»º HEARTBEAT.md

**ä½ç½®**ï¼š`/home/xx/perfect21/cecelia/core/HEARTBEAT.md`

**åˆå§‹å†…å®¹**ï¼š

```markdown
# Cecelia å·¡æ£€æ¸…å•

## è‡ªä¸»æƒè¾¹ç•Œ

### å¿…é¡»é—®æˆ‘çš„ï¼ˆåˆ›å»ºææ¡ˆï¼‰
- OKR æ‹†è§£ç»“æœ
- æ¯å‘¨è®¡åˆ’
- P0/P1 ä¼˜å…ˆçº§å˜æ›´
- è¿ç»­å¤±è´¥ 3 æ¬¡ä»¥ä¸Šçš„ä»»åŠ¡å¤„ç†æ–¹æ¡ˆ
- Initiative å®ŒæˆéªŒæ”¶

### å¯ä»¥è‡ªå·±å†³å®šï¼Œä½†è®°å½•æ—¥å¿—
- å•ä¸ªä»»åŠ¡é‡è¯•
- Initiative è‡ªåŠ¨å…³é—­
- æ—¥å¸¸æ´¾å‘è°ƒæ•´

### å®Œå…¨è‡ªä¸»ï¼ˆä¸ç”¨é€šçŸ¥ï¼‰
- çœ‹é—¨ç‹— kill è¿›ç¨‹
- ç†”æ–­å™¨å¼€å…³
- æ—¥å¸¸ tick æ£€æŸ¥

## å®šæ—¶æ£€æŸ¥

### æ¯æ¬¡å·¡æ£€ï¼ˆçº¦ 30 åˆ†é’Ÿï¼‰
- æœ‰æ²¡æœ‰ä»»åŠ¡å¡åœ¨ in_progress è¶…è¿‡ 2 å°æ—¶ï¼Ÿå¦‚æœæœ‰ï¼Œæ ‡è®°å¤±è´¥å¹¶é‡è¯•
- ä»Šå¤©æ´¾å‘äº†å¤šå°‘ä¸ªä»»åŠ¡ï¼Ÿå¦‚æœæ˜¯ 0 ä¸ªï¼Œæ£€æŸ¥ tick æ˜¯å¦æ­£å¸¸
- æœ‰æ²¡æœ‰ pending_approval è¶…è¿‡ 12 å°æ—¶æœªå¤„ç†çš„ææ¡ˆï¼Ÿå¦‚æœæœ‰ï¼Œé€šè¿‡é£ä¹¦æé†’æˆ‘

### æ¯å¤©æ—©ä¸Šï¼ˆ08:00-09:00 ä¹‹é—´çš„ç¬¬ä¸€æ¬¡å·¡æ£€ï¼‰
- æ€»ç»“æ˜¨å¤©çš„è¿›åº¦ï¼šå“ªäº› KR æ¨è¿›äº†ï¼Œå“ªäº›æ²¡åŠ¨
- å¦‚æœæœ‰ KR è¿ç»­ 3 å¤©æ²¡è¿›å±•ï¼Œåˆ›å»ºææ¡ˆå»ºè®®è°ƒæ•´ä¼˜å…ˆçº§
- ç”Ÿæˆæ¯æ—¥ç„¦ç‚¹

### æ¯å‘¨ä¸€
- ç”Ÿæˆæœ¬å‘¨ OKR è¿›åº¦æŠ¥å‘Š
- åˆ›å»ºæœ¬å‘¨è®¡åˆ’ææ¡ˆï¼ˆpropose_weekly_planï¼‰
```

#### 2.2 tick.js é›†æˆ

**ä¿®æ”¹æ–‡ä»¶**ï¼š`tick.js`

```javascript
// åœ¨ executeTick() çš„æœ«å°¾ï¼Œæ‰€æœ‰ç¡¬é€»è¾‘æ‰§è¡Œå®Œåï¼š

// === è½¯é€»è¾‘ï¼šHEARTBEAT.md å·¡æ£€ï¼ˆæŒ‰æ—¶é—´è§¦å‘ï¼Œä¸ä¾èµ– tick è®¡æ•°ï¼‰===
const HEARTBEAT_INTERVAL_MS = 30 * 60 * 1000; // 30 åˆ†é’Ÿ
const lastHeartbeat = await getWorkingMemory('last_heartbeat_at') || 0;
const elapsed = Date.now() - lastHeartbeat;

if (elapsed >= HEARTBEAT_INTERVAL_MS) {
  await setWorkingMemory('last_heartbeat_at', Date.now());
  await runHeartbeatInspection();
}
// ç”¨æ—¶é—´æˆ³è€Œéè®¡æ•°å™¨ï¼štick é¢‘ç‡å˜åŒ–æ—¶å¿ƒè·³é—´éš”ä¸å—å½±å“
```

#### 2.3 å·¡æ£€æ‰§è¡Œå‡½æ•°

**æ–°å»ºæ–‡ä»¶**ï¼š`brain/src/heartbeat-inspector.js`

```javascript
import fs from 'fs';
import path from 'path';

const HEARTBEAT_PATH = path.join(__dirname, '../../HEARTBEAT.md');

/**
 * è¯»å– HEARTBEAT.mdï¼Œç»“åˆç³»ç»ŸçŠ¶æ€ï¼Œå‘ç»™ L1 ä¸˜è„‘åˆ¤æ–­
 */
export async function runHeartbeatInspection(pool) {
  // 1. è¯»å– HEARTBEAT.md
  let heartbeatContent;
  try {
    heartbeatContent = fs.readFileSync(HEARTBEAT_PATH, 'utf-8');
  } catch (err) {
    console.log('[heartbeat] HEARTBEAT.md not found, skipping');
    return;
  }

  // 2. æ”¶é›†å½“å‰ç³»ç»Ÿå¿«ç…§ï¼ˆç»™ Haiku å‚è€ƒæ•°æ®ï¼‰
  const snapshot = await collectSystemSnapshot(pool);

  // 3. æ„å»º prompt
  const prompt = buildHeartbeatPrompt(heartbeatContent, snapshot);

  // 4. è°ƒç”¨ L1 ä¸˜è„‘ï¼ˆHaikuï¼‰
  const decision = await callHaiku(prompt);

  // 5. å¤„ç†ç»“æœ
  if (!decision || decision.action === 'no_action') {
    // ä¸€åˆ‡æ­£å¸¸ï¼Œé™é»˜
    return;
  }

  // 6. ç¡¬çº¦æŸï¼šV1 å·¡æ£€åªå…è®¸ propose_* å’Œ no_actionï¼Œç¦æ­¢ç›´æ¥æ‰§è¡Œå±é™©åŠ¨ä½œ
  //    ä¸é  Prompt è‡ªè§‰ï¼Œä»£ç å±‚é¢å¼ºåˆ¶
  const HEARTBEAT_ALLOWED_ACTIONS = [
    'no_action', 'log_event',
    'propose_priority_change', 'propose_weekly_plan',
    'heartbeat_finding', 'request_human_review',
  ];
  const actions = decision.actions || [decision];
  for (const act of actions) {
    if (!HEARTBEAT_ALLOWED_ACTIONS.includes(act.type || act.action)) {
      console.warn(`[heartbeat] BLOCKED action "${act.type || act.action}" â€” not in whitelist, converting to heartbeat_finding`);
      act.type = 'heartbeat_finding';
      act.params = { ...act.params, original_action: act.type, blocked_reason: 'heartbeat_whitelist' };
    }
  }

  // é€šè¿‡ decision-executor æ‰§è¡Œï¼ˆå’Œæ­£å¸¸ thalamus è¾“å‡ºä¸€æ ·çš„æµç¨‹ï¼‰
  await executeDecision(decision, {
    source: 'heartbeat_inspection',
    timestamp: new Date().toISOString(),
  });

  // 7. è®°å½•å·¡æ£€äº‹ä»¶
  await pool.query(`
    INSERT INTO cecelia_events (type, payload)
    VALUES ('heartbeat_inspection', $1)
  `, [JSON.stringify({
    actions: decision.actions?.length || 0,
    findings: decision.rationale?.substring(0, 200),
  })]);
}
```

#### 2.4 ç³»ç»Ÿå¿«ç…§æ”¶é›†

```javascript
async function collectSystemSnapshot(pool) {
  const [tasks, events, proposals, focus] = await Promise.all([
    pool.query(`
      SELECT status, COUNT(*) as count
      FROM tasks WHERE status IN ('in_progress', 'queued', 'failed')
      GROUP BY status
    `),
    pool.query(`
      SELECT type, COUNT(*) as count
      FROM cecelia_events
      WHERE created_at > NOW() - INTERVAL '24 hours'
      GROUP BY type
      ORDER BY count DESC LIMIT 5
    `),
    pool.query(`
      SELECT COUNT(*) as count FROM pending_actions
      WHERE status = 'pending_approval'
        AND (expires_at IS NULL OR expires_at > NOW())
    `),
    pool.query(`
      SELECT title, progress FROM goals
      WHERE status = 'in_progress'
      ORDER BY priority ASC LIMIT 3
    `),
  ]);

  return {
    tasks_in_progress: tasks.rows.find(r => r.status === 'in_progress')?.count || 0,
    tasks_queued: tasks.rows.find(r => r.status === 'queued')?.count || 0,
    tasks_failed: tasks.rows.find(r => r.status === 'failed')?.count || 0,
    top_events_24h: events.rows,
    pending_proposals: parseInt(proposals.rows[0]?.count || 0),
    active_okrs: focus.rows,
    current_hour: new Date().getHours(),
    day_of_week: new Date().getDay(), // 0=å‘¨æ—¥, 1=å‘¨ä¸€
  };
}
```

#### 2.5 Haiku Prompt æ¨¡æ¿

```javascript
function buildHeartbeatPrompt(heartbeatMd, snapshot) {
  return `ä½ æ˜¯ Cecelia çš„å·¡æ£€æ¨¡å—ã€‚æ ¹æ®ç”¨æˆ·å®šä¹‰çš„æ£€æŸ¥æ¸…å•å’Œå½“å‰ç³»ç»ŸçŠ¶æ€ï¼Œåˆ¤æ–­éœ€è¦é‡‡å–ä»€ä¹ˆè¡ŒåŠ¨ã€‚

## ç”¨æˆ·å®šä¹‰çš„æ£€æŸ¥æ¸…å•

${heartbeatMd}

## å½“å‰ç³»ç»ŸçŠ¶æ€

- è¿›è¡Œä¸­ä»»åŠ¡: ${snapshot.tasks_in_progress}
- æ’é˜Ÿä»»åŠ¡: ${snapshot.tasks_queued}
- å¤±è´¥ä»»åŠ¡: ${snapshot.tasks_failed}
- å¾…å¤„ç†ææ¡ˆ: ${snapshot.pending_proposals}
- å½“å‰æ—¶é—´: ${snapshot.current_hour}:00, æ˜ŸæœŸ${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][snapshot.day_of_week]}
- æ´»è·ƒ OKR: ${snapshot.active_okrs.map(g => `${g.title}(${g.progress}%)`).join(', ') || 'æ— '}
- 24h äº‹ä»¶ TOP5: ${snapshot.top_events_24h.map(e => `${e.type}:${e.count}`).join(', ') || 'æ— '}

## è¾“å‡ºæ ¼å¼

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œè¾“å‡ºï¼š
\`\`\`json
{"action": "no_action", "rationale": "ä¸€åˆ‡æ­£å¸¸"}
\`\`\`

å¦‚æœéœ€è¦è¡ŒåŠ¨ï¼Œè¾“å‡ºæ ‡å‡† Decision æ ¼å¼ï¼š
\`\`\`json
{
  "actions": [
    {"type": "action_type", "params": {...}}
  ],
  "rationale": "åŸå› è¯´æ˜",
  "confidence": 0.8
}
\`\`\`

å¯ç”¨çš„ action typeï¼š
- ç¡®å®šçš„äº‹ï¼ˆç›´æ¥æ‰§è¡Œï¼‰ï¼šdispatch_task, retry_task, mark_task_failed, log_event, no_action
- ä¸ç¡®å®šçš„äº‹ï¼ˆåˆ›å»ºææ¡ˆï¼‰ï¼špropose_priority_change, propose_weekly_plan, heartbeat_finding, request_human_review

ä¸¥æ ¼éµå®ˆ"è‡ªä¸»æƒè¾¹ç•Œ"ç« èŠ‚çš„è§„åˆ™ï¼šæ ‡è®°ä¸º"å¿…é¡»é—®æˆ‘çš„"äº‹é¡¹ï¼Œå¿…é¡»åˆ›å»ºææ¡ˆï¼ˆpropose_* æˆ– heartbeat_findingï¼‰ï¼Œä¸è¦è‡ªè¡Œå†³å®šã€‚`;
}
```

---

### Phase 3: Dashboard æ”¶ä»¶ç®± UIï¼ˆå‰ç«¯ï¼‰

**æ ¸å¿ƒç›®æ ‡**ï¼šåœ¨ Dashboard ä¸Šå±•ç¤ºæ”¶ä»¶ç®±ï¼Œç”¨æˆ·å¯ä»¥æ‰¹å‡†/æ‹’ç»/è¿½é—®/é€‰æ‹©ã€‚

#### 3.1 æ–°å»º Feature: inbox

**ä½ç½®**ï¼š`apps/core/features/inbox/`

```
apps/core/features/inbox/
â”œâ”€â”€ index.ts                    # Feature manifest
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ InboxPage.tsx           # æ”¶ä»¶ç®±ä¸»é¡µé¢
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ProposalCard.tsx        # å•ä¸ªææ¡ˆå¡ç‰‡
â”‚   â”œâ”€â”€ ProposalChat.tsx        # ææ¡ˆå¯¹è¯åŒº
â”‚   â”œâ”€â”€ ProposalOptions.tsx     # é€‰é¡¹é€‰æ‹©ï¼ˆå¼‚å¸¸å¤„ç†ï¼‰
â”‚   â””â”€â”€ InboxBadge.tsx          # å¯¼èˆªæ æœªè¯»æ•°è§’æ ‡
â””â”€â”€ hooks/
    â””â”€â”€ useProposals.ts         # ææ¡ˆæ•°æ® hookï¼ˆWebSocket + è½®è¯¢ fallbackï¼‰
```

#### 3.2 WebSocket é›†æˆ

**æ–°å»º**ï¼š`apps/core/features/shared/hooks/useWebSocket.ts`

```typescript
export function useWebSocket(url: string) {
  const [socket, setSocket] = useState<WebSocket | null>(null);
  const [connected, setConnected] = useState(false);

  useEffect(() => {
    const ws = new WebSocket(url);
    ws.onopen = () => setConnected(true);
    ws.onclose = () => {
      setConnected(false);
      // è‡ªåŠ¨é‡è¿ï¼ˆæŒ‡æ•°é€€é¿ï¼Œæœ€å¤§ 30sï¼‰
      setTimeout(() => reconnect(), Math.min(retryCount * 2000, 30000));
    };
    setSocket(ws);
    return () => ws.close();
  }, [url]);

  return { socket, connected };
}
```

#### 3.3 useProposals Hook

```typescript
export function useProposals() {
  const [proposals, setProposals] = useState<Proposal[]>([]);
  const { socket, connected } = useWebSocket('ws://localhost:5221/ws');

  // åˆå§‹åŠ è½½
  useEffect(() => {
    fetch('/api/brain/pending-actions')
      .then(r => r.json())
      .then(data => setProposals(data.actions || []));
  }, []);

  // WebSocket å®æ—¶æ›´æ–°
  useEffect(() => {
    if (!socket) return;
    socket.onmessage = (e) => {
      const { event, data } = JSON.parse(e.data);
      switch (event) {
        case 'proposal:created':
          setProposals(prev => [data, ...prev]);
          break;
        case 'proposal:comment':
          setProposals(prev => prev.map(p =>
            p.id === data.id
              ? { ...p, comments: [...(p.comments || []), data.comment] }
              : p
          ));
          break;
        case 'proposal:resolved':
          setProposals(prev => prev.filter(p => p.id !== data.id));
          break;
      }
    };
  }, [socket]);

  // Fallback: WebSocket æ–­å¼€æ—¶æ¯ 10s è½®è¯¢
  useEffect(() => {
    if (connected) return;
    const poll = setInterval(() => {
      fetch('/api/brain/pending-actions')
        .then(r => r.json())
        .then(data => setProposals(data.actions || []));
    }, 10000);
    return () => clearInterval(poll);
  }, [connected]);

  return { proposals, pendingCount: proposals.length };
}
```

#### 3.4 InboxPage å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ”¶ä»¶ç®±                           ç­›é€‰: å…¨éƒ¨ â–¼   â”‚
â”‚                                                  â”‚
â”‚  å¾…å¤„ç† (3)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ”´ å¼‚å¸¸æŠ¥å‘Š              30 åˆ†é’Ÿå‰        â”‚    â”‚
â”‚  â”‚ Caramel è¿ç»­ 3 æ¬¡åœ¨ cecelia-core å¤±è´¥     â”‚    â”‚
â”‚  â”‚ [é€‰é¡¹ A] [é€‰é¡¹ B] [é€‰é¡¹ C] [ğŸ’¬ è¿½é—®]     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸŸ¡ OKR æ‹†è§£ç¡®è®¤            2 å°æ—¶å‰       â”‚    â”‚
â”‚  â”‚ ç§‹ç±³æŠŠ "Task Intelligence" æ‹†æˆäº† 3 ä¸ª... â”‚    â”‚
â”‚  â”‚ [âœ… æ‰¹å‡†] [âœï¸ ä¿®æ”¹] [âŒ æ‹’ç»] [ğŸ’¬ è¿½é—®]  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸŸ¡ æœ¬å‘¨è®¡åˆ’ç¡®è®¤            ä»Šå¤© 9:00      â”‚    â”‚
â”‚  â”‚ å»ºè®®æœ¬å‘¨é‡ç‚¹æ¨è¿› Quality Monitor...       â”‚    â”‚
â”‚  â”‚ [âœ… å°±è¿™æ ·] [âœï¸ è°ƒæ•´] [ğŸ’¬ è®¨è®º]          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                  â”‚
â”‚  å·²å¤„ç† (47)                          å±•å¼€ â–¸     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.5 ProposalChat å¯¹è¯ç»„ä»¶

ç‚¹å‡»"è¿½é—®"å±•å¼€å¯¹è¯åŒºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ¡ OKR æ‹†è§£ç¡®è®¤                          â”‚
â”‚                                          â”‚
â”‚ ğŸ¤– ç§‹ç±³æŠŠ "Task Intelligence" æ‹†æˆï¼š    â”‚
â”‚    1. Parser API (2h)                    â”‚
â”‚    2. Scheduler (3h)                     â”‚
â”‚    3. Dashboard é›†æˆ (2h)                â”‚
â”‚                                          â”‚
â”‚ ğŸ‘¤ Scheduler çš„ä¼˜å…ˆçº§åº”è¯¥æœ€é«˜ï¼Œ           â”‚
â”‚    èƒ½ä¸èƒ½å…ˆåšè¿™ä¸ªï¼Ÿ                       â”‚
â”‚                                          â”‚
â”‚ ğŸ¤– æ”¶åˆ°ã€‚å·²è°ƒæ•´é¡ºåºï¼š                    â”‚
â”‚    1. Scheduler (3h) â† æå‡ä¸ºç¬¬ä¸€ä¸ª      â”‚
â”‚    2. Parser API (2h)                    â”‚
â”‚    3. Dashboard é›†æˆ (2h)                â”‚
â”‚    éœ€è¦æˆ‘æŒ‰è¿™ä¸ªé¡ºåºæ‰§è¡Œå—ï¼Ÿ              â”‚
â”‚                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” [å‘é€]      â”‚
â”‚ â”‚ è¾“å…¥å›å¤...              â”‚             â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                          â”‚
â”‚ [âœ… æ‰¹å‡†ä¿®æ”¹åçš„æ–¹æ¡ˆ] [âŒ å†æƒ³æƒ³]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.6 å¯¼èˆªæ è§’æ ‡

**ä¿®æ”¹æ–‡ä»¶**ï¼šDashboard å¯¼èˆªé…ç½®

```typescript
// navigation.config.ts æ–°å¢
{
  label: 'æ”¶ä»¶ç®±',
  path: '/inbox',
  icon: 'Inbox',
  badge: 'pendingProposals', // åŠ¨æ€è§’æ ‡
}
```

**InboxBadge ç»„ä»¶**ï¼š

```typescript
function InboxBadge() {
  const { pendingCount } = useProposals();
  if (pendingCount === 0) return null;
  return (
    <span className="bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5">
      {pendingCount}
    </span>
  );
}
```

#### 3.7 HEARTBEAT.md ç¼–è¾‘å™¨ï¼ˆDashboardï¼‰

**è·¯å¾„**ï¼š`/settings/heartbeat`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·¡æ£€è®¾ç½®                       [ä¿å­˜] [é‡ç½®]    â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ï¼ˆMarkdown ç¼–è¾‘å™¨ï¼Œå’Œç¼–è¾‘ Notion ç±»ä¼¼ï¼‰   â”‚    â”‚
â”‚  â”‚                                          â”‚    â”‚
â”‚  â”‚  # Cecelia å·¡æ£€æ¸…å•                      â”‚    â”‚
â”‚  â”‚                                          â”‚    â”‚
â”‚  â”‚  ## è‡ªä¸»æƒè¾¹ç•Œ                           â”‚    â”‚
â”‚  â”‚  ### å¿…é¡»é—®æˆ‘çš„                          â”‚    â”‚
â”‚  â”‚  - OKR æ‹†è§£ç»“æœ                         â”‚    â”‚
â”‚  â”‚  - æ¯å‘¨è®¡åˆ’                             â”‚    â”‚
â”‚  â”‚  ...                                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                  â”‚
â”‚  æœ€è¿‘å·¡æ£€è®°å½•ï¼š                                   â”‚
â”‚  09:30  âœ“ ä¸€åˆ‡æ­£å¸¸                               â”‚
â”‚  10:00  âš  å‘ç° 1 ä¸ªè¶…æ—¶ä»»åŠ¡ï¼Œå·²è‡ªåŠ¨é‡è¯•           â”‚
â”‚  10:30  âœ“ ä¸€åˆ‡æ­£å¸¸                               â”‚
â”‚  11:00  ğŸ“‹ åˆ›å»ºææ¡ˆï¼šå»ºè®®è°ƒæ•´ KR ä¼˜å…ˆçº§            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¿å­˜é€»è¾‘**ï¼š

```typescript
async function saveHeartbeat(content: string) {
  await fetch('/api/brain/heartbeat', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ content }),
  });
}
```

**åç«¯**ï¼š`routes.js` æ–°å¢ GET/PUT `/api/brain/heartbeat`ï¼Œè¯»å†™ `HEARTBEAT.md` æ–‡ä»¶ã€‚

---

## ä¸åšçš„äº‹ï¼ˆæ˜ç¡®æ’é™¤ï¼‰

| æ’é™¤é¡¹ | åŸå›  |
|--------|------|
| é£ä¹¦/Telegram æ¶ˆæ¯æ¸ é“ | ç‹¬ç«‹éœ€æ±‚ï¼Œå½“å‰ Dashboard è¶³å¤Ÿ |
| ææ¡ˆè‡ªåŠ¨æ‰¹å‡†ï¼ˆè¶…æ—¶åæ‰§è¡Œï¼‰ | å®‰å…¨é£é™©ï¼Œå®å¯è¿‡æœŸä¹Ÿä¸è‡ªåŠ¨æ‰§è¡Œ |
| å‰ç«¯ç›´æ¥ç¼–è¾‘ OKR/ä»»åŠ¡ | å·²æœ‰ Work é¡µé¢ï¼Œæ”¶ä»¶ç®±åªè´Ÿè´£"å†³ç­–" |
| HEARTBEAT.md çš„ AI ç”Ÿæˆ | ç”¨æˆ·æ‰‹å†™æ›´å¯æ§ï¼ŒAI è¾…åŠ©å¯åç»­åŠ  |
| å¤æ‚çš„æƒé™ç³»ç»Ÿ | å•ç”¨æˆ·ç³»ç»Ÿï¼Œreviewed_by å­—ç¬¦ä¸²è¶³å¤Ÿ |
| ç§»åŠ¨ç«¯åŸç”Ÿ App | PWA å·²æ”¯æŒæ‰‹æœºè®¿é—® |

---

## å½±å“èŒƒå›´

| æ–‡ä»¶ | Phase | æ”¹åŠ¨ | é£é™© |
|------|-------|------|------|
| **migration 054** | 1 | æ–°å»ºï¼špending_actions åŠ åˆ— | ä½ |
| brain/src/decision-executor.js | 1 | æ‰©å±• PROPOSAL_TYPES + æ–°å¢ handler | ä¸­ |
| brain/src/routes.js | 1 | æ–°å¢ comment/select API + heartbeat API | ä¸­ |
| brain/src/websocket.js | 1 | æ–°å¢ proposal äº‹ä»¶ | ä½ |
| brain/src/tick.js | 1+2 | è§¦å‘ææ¡ˆ + å¿ƒè·³å·¡æ£€é›†æˆ | ä¸­ |
| brain/src/cortex.js | 1 | propose_anomaly_action æ›¿ä»£éƒ¨åˆ†è‡ªåŠ¨æ‰§è¡Œ | ä½ |
| brain/src/initiative-closer.js | 1 | propose_milestone_review | ä½ |
| brain/src/planner.js | 1 | propose_priority_change | ä½ |
| **brain/src/heartbeat-inspector.js** | 2 | **æ–°å»º**ï¼šå·¡æ£€æ‰§è¡Œå™¨ | ä½ |
| **core/HEARTBEAT.md** | 2 | **æ–°å»º**ï¼šæ£€æŸ¥æ¸…å• | ä½ |
| **apps/core/features/inbox/** | 3 | **æ–°å»º**ï¼šæ”¶ä»¶ç®± Feature | ä¸­ |
| apps/core/features/shared/hooks/ | 3 | æ–°å¢ useWebSocket | ä½ |
| dashboard å¯¼èˆªé…ç½® | 3 | æ–°å¢æ”¶ä»¶ç®±å…¥å£ + è§’æ ‡ | ä½ |

---

## éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰

### Phase 1: ææ¡ˆç³»ç»Ÿæ‰©å±• + WebSocket

- [ ] pending_actions æ–°å¢åˆ— migration æˆåŠŸï¼ˆå« sourceã€signatureã€ç´¢å¼•ï¼‰
- [ ] 7+ ç§ææ¡ˆç±»å‹å¯åˆ›å»º
- [ ] ææ¡ˆå»é‡/èŠ‚æµï¼šåŒä¸€ signature 24h å†…ä¸é‡å¤åˆ›å»º
- [ ] comment API å¯è¿½åŠ å¯¹è¯ï¼ˆå«è¿‡æœŸæ£€æŸ¥ 410ï¼‰
- [ ] comment å¯¹è¯æˆªæ–­ï¼šprompt åªå–æœ€è¿‘ 10 æ¡
- [ ] Haiku å›å¤è¾“å‡ºå¼ºæ ¡éªŒï¼ˆJSON parse + schema checkï¼‰
- [ ] select API å¯é€‰æ‹©é€‰é¡¹ï¼ˆæ•´ä¸ªæµç¨‹åœ¨åŒä¸€äº‹åŠ¡å†…ï¼‰
- [ ] options ç»“æ„å« action å­—æ®µï¼ŒexecuteSelectedOption èµ° executeDecision
- [ ] WebSocket æ¨é€ proposal:created/comment/resolved
- [ ] è¿‡æœŸææ¡ˆ â†’ expired çŠ¶æ€ï¼ˆä¸åˆ é™¤ï¼Œå¯è¿½æº¯ï¼‰
- [ ] ç§‹ç±³ OKR æ‹†è§£åè‡ªåŠ¨åˆ›å»º propose_decomposition
- [ ] Cortex RCA æœ‰å¤šé€‰é¡¹æ—¶åˆ›å»º propose_anomaly_action
- [ ] Initiative å®Œæˆæ—¶åˆ›å»º propose_milestone_review
- [ ] åŸæœ‰ 3 ç§å±é™©æ“ä½œä¸å—å½±å“

### Phase 2: HEARTBEAT.md å·¡æ£€

- [ ] HEARTBEAT.md æ–‡ä»¶å­˜åœ¨ï¼Œå†…å®¹åˆç†
- [ ] tick.js æŒ‰æ—¶é—´è§¦å‘å·¡æ£€ï¼ˆ30min é—´éš”ï¼Œä¸ä¾èµ– tick è®¡æ•°ï¼‰
- [ ] Haiku è¯»å– HEARTBEAT.md + ç³»ç»Ÿå¿«ç…§ï¼Œè¾“å‡º Decision
- [ ] ç¡¬çº¦æŸ whitelistï¼šå·¡æ£€åªå…è®¸ propose_*/no_action/log_eventï¼Œç¦æ­¢ç›´æ¥ dispatch/retry
- [ ] éç™½åå• action è‡ªåŠ¨é™çº§ä¸º heartbeat_finding ææ¡ˆ
- [ ] å·¡æ£€äº‹ä»¶è®°å½•åˆ° cecelia_events
- [ ] HEARTBEAT.md ä¿®æ”¹åä¸‹æ¬¡å·¡æ£€è‡ªåŠ¨ç”Ÿæ•ˆï¼ˆæ— éœ€é‡å¯ï¼‰
- [ ] GET/PUT /api/brain/heartbeat API æ­£å¸¸

### Phase 3: Dashboard æ”¶ä»¶ç®±

- [ ] æ”¶ä»¶ç®±é¡µé¢å±•ç¤ºæ‰€æœ‰ pending_approval ææ¡ˆ
- [ ] ææ¡ˆå¡ç‰‡æ˜¾ç¤ºç±»å‹ã€æ—¶é—´ã€å†…å®¹æ‘˜è¦
- [ ] æ‰¹å‡†/æ‹’ç»/é€‰æ‹©æ“ä½œå¯ç”¨
- [ ] è¿½é—®å¯¹è¯å¯ç”¨ï¼ˆå‘é€ â†’ Haiku å›å¤ â†’ æ˜¾ç¤ºï¼‰
- [ ] WebSocket å®æ—¶æ›´æ–°ï¼ˆæ–°ææ¡ˆã€æ–°è¯„è®ºã€å·²å¤„ç†ï¼‰
- [ ] WebSocket æ–­å¼€æ—¶è‡ªåŠ¨ fallback åˆ° 10s è½®è¯¢
- [ ] å¯¼èˆªæ æœªè¯»æ•°è§’æ ‡
- [ ] HEARTBEAT.md ç¼–è¾‘å™¨å¯ä¿å­˜
- [ ] å·¡æ£€æ—¥å¿—å¯æŸ¥çœ‹
- [ ] æ‰‹æœº PWA è®¿é—®æ­£å¸¸

### å›å½’æµ‹è¯•ï¼ˆæ¯ä¸ª Phaseï¼‰

- [ ] åŸæœ‰ 3 ç§ pending_actions æµç¨‹ä¸å—å½±å“
- [ ] thalamus å†³ç­–ä¸æŠ¥é”™
- [ ] tick å¾ªç¯æ­£å¸¸ï¼ˆå·¡æ£€ä¸é˜»å¡ç¡¬é€»è¾‘ï¼‰
- [ ] WebSocket ç°æœ‰äº‹ä»¶ï¼ˆtask:created ç­‰ï¼‰ä¸å—å½±å“

---

## é‡Œç¨‹ç¢‘

| Phase | å†…å®¹ | PR æ•° |
|-------|------|-------|
| Phase 1 | ææ¡ˆç³»ç»Ÿæ‰©å±• + WebSocket + é›†æˆè§¦å‘ç‚¹ | 1 PRï¼ˆåç«¯ï¼Œå« migrationï¼‰ |
| Phase 2 | HEARTBEAT.md + heartbeat-inspector + tick é›†æˆ | 1 PRï¼ˆåç«¯ï¼‰ |
| Phase 3 | Dashboard æ”¶ä»¶ç®± UI + WebSocket é›†æˆ + Heartbeat ç¼–è¾‘å™¨ | 1 PRï¼ˆå‰ç«¯ï¼‰ |
| æ€»è®¡ | | 3 PR |
