---
id: fix-stop-hook-cleanup
version: 1.0.0
created: 2026-01-30
updated: 2026-01-30
changelog:
  - 1.0.0: 初始版本
---

# PRD: 修复 Stop Hook 跳过 Cleanup 的 Bug

## 问题描述

当前 Stop Hook (`~/.claude/hooks/stop.sh`) 在检测到 PR 已合并时，直接删除 `.dev-mode` 并退出，导致 Step 11 (Cleanup) 从未执行，分支遗留。

## 当前错误流程

```
PR 合并 → Stop Hook 检测到 merged
        → 直接 rm -f .dev-mode
        → exit 0（会话结束）
        → Step 11 从未执行
        → 分支遗留
```

## 期望正确流程

```
PR 合并 → Stop Hook 检测到 merged
        → exit 2（继续执行）
        → Claude 执行 Step 11 (Cleanup)
        → cleanup.sh 删除分支
        → cleanup.sh 删除 .dev-mode
        → 下次 Stop Hook 检测无 .dev-mode
        → exit 0（会话结束）
```

## 修改内容

### 1. 修改 Stop Hook (`~/.claude/hooks/stop.sh`)

**位置**：第 105-116 行

**原代码**：
```bash
if [[ "$PR_STATE" == "merged" ]]; then
    echo "  ✅ 条件 2: CI 通过（PR 已合并）" >&2
    echo "  ✅ 条件 3: PR 已合并" >&2
    # ...
    rm -f "$DEV_MODE_FILE"
    exit 0
fi
```

**修改为**：
```bash
if [[ "$PR_STATE" == "merged" ]]; then
    echo "  ✅ 条件 2: CI 通过（PR 已合并）" >&2
    echo "  ✅ 条件 3: PR 已合并" >&2
    echo "" >&2
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
    echo "  ➡️  下一步: 执行 Step 11 (Cleanup)" >&2
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
    exit 2  # 继续执行，让 Claude 执行 cleanup
fi
```

### 2. 添加 cleanup 完成标记检测

在 Stop Hook 开头添加对 cleanup 完成状态的检测：

```bash
# 如果 .dev-mode 包含 cleanup_done: true，允许退出
if grep -q "cleanup_done: true" "$DEV_MODE_FILE" 2>/dev/null; then
    rm -f "$DEV_MODE_FILE"
    exit 0
fi
```

### 3. 修改 cleanup.sh

在 cleanup.sh 最后，删除 .dev-mode 之前，先标记完成：

```bash
# 标记 cleanup 完成
echo "cleanup_done: true" >> "$DEV_MODE_FILE"
```

## 成功标准

1. PR 合并后，Stop Hook 输出 "下一步: 执行 Step 11 (Cleanup)"
2. Claude 执行 cleanup.sh
3. 本地和远程分支被删除
4. .dev-mode 文件被删除
5. 会话正常结束

## 测试方法

1. 创建一个简单的测试 PR
2. 合并 PR
3. 观察 Stop Hook 输出
4. 确认分支被删除
