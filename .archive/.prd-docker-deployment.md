---
id: cecelia-docker-24x7-deployment
version: 1.0.0
created: 2026-02-01
---

# PRD: Cecelia 24/7 Docker 自主运行部署

## 背景

当前 Cecelia 系统：
- ✅ 架构已统一（Node Brain + Python Intelligence Service）
- ⚠️ 运行模式混乱（手动启动 vs systemd vs Docker）
- ⚠️ 不是真正的 24/7 自主运行
- ⚠️ 配置分散，缺少统一管理

**目标任务量**：每天 100+ 任务

## 功能描述

### 目标
将 Cecelia 部署为 Docker Compose 管理的 24/7 自主运行系统，支持：
1. 自动启动和重启
2. 健康检查和自愈
3. 统一配置管理
4. 日志聚合
5. 资源限制

### 核心需求

#### 1. Docker Compose 统一部署
- [ ] 停止所有手动启动的进程
- [ ] 停止 systemd 服务（如果存在）
- [ ] 通过 Docker Compose 启动所有服务
- [ ] 配置自动重启策略（restart: unless-stopped）

#### 2. 服务配置
```yaml
services:
  - semantic-brain (Python Intelligence Service, 5220)
  - node-brain (决策中心, 5221)
```

**依赖关系**：
- node-brain 依赖 semantic-brain
- 两者都依赖 PostgreSQL（已有容器 social-metrics-postgres）

#### 3. 健康检查
- semantic-brain: `GET /health` (30s 间隔)
- node-brain: `GET /api/brain/tick/status` (30s 间隔)
- 失败重试：3 次，每次 10s 超时
- 启动等待：40s

#### 4. 配置管理
- [ ] 使用 `.env.docker` 文件（包含凭据）
- [ ] 挂载必要的目录：
  - `/home/xx/dev` → 代码库（只读）
  - `/home/xx/.claude` → Skills（只读）
  - `/home/xx/bin` → cecelia-run（只读）
  - `./data/chroma` → 向量数据库（持久化）
  - `./logs` → 日志目录

#### 5. 资源限制和日志
- 日志驱动：json-file
- 单文件大小：10MB
- 保留文件数：3 个
- 网络模式：host（访问本地 PostgreSQL）

#### 6. Tick 循环配置
```env
CECELIA_TICK_ENABLED=true
CECELIA_TICK_INTERVAL_MS=120000  # 2 分钟
MAX_CONCURRENT_TASKS=3           # 并发任务数
DISPATCH_TIMEOUT_MINUTES=60      # 超时限制
```

## 成功标准

### 功能验证
1. [ ] `docker compose ps` 显示所有服务 healthy
2. [ ] `curl http://localhost:5221/api/brain/tick/status` 返回成功
3. [ ] Tick 循环正常运行（enabled=true, loop_running=true）
4. [ ] Circuit Breaker 状态 CLOSED
5. [ ] 创建测试任务，能自动执行

### 稳定性验证
6. [ ] 服务崩溃后自动重启（模拟 kill 容器）
7. [ ] 健康检查失败后自动重启
8. [ ] 服务器重启后自动启动（docker compose 配置 restart policy）

### 监控验证
9. [ ] 可以查看实时日志：`docker compose logs -f`
10. [ ] 可以查看服务状态：`docker compose ps`
11. [ ] 日志轮转正常工作（不会无限增长）

### 性能验证
12. [ ] CPU 使用率 < 50%（空闲时）
13. [ ] 内存使用 < 2GB（空闲时）
14. [ ] 并发 3 个任务时系统稳定

## 技术实现

### 文件清单
- `docker-compose.yml` - 已更新（包含健康检查、依赖关系）
- `.env.docker` - 已创建（包含凭据）
- `.dockerignore` - 需要创建（排除不需要的文件）
- `Dockerfile` - 需要检查并优化

### 部署步骤
1. 停止现有进程
2. 构建镜像：`docker compose build`
3. 启动服务：`docker compose up -d`
4. 验证健康检查：`docker compose ps`
5. 查看日志：`docker compose logs -f --tail=50`
6. 测试自动重启：`docker compose restart node-brain`
7. 验证 Tick 循环：`curl http://localhost:5221/api/brain/tick/status`

### 回滚计划
如果 Docker 部署失败：
```bash
# 停止 Docker
docker compose down

# 恢复手动启动
cd /home/xx/dev/cecelia-core/brain
nohup node server.js > /tmp/brain.log 2>&1 &
```

## 验收清单

### 部署成功
- [ ] 所有服务状态 healthy
- [ ] Tick 循环运行
- [ ] 无 Circuit Breaker 告警
- [ ] 测试任务正常执行

### 24/7 运行能力
- [ ] 服务自动重启（测试过）
- [ ] 日志自动轮转
- [ ] 配置统一管理
- [ ] 监控接口可用

### 文档完备
- [ ] 更新 README.md（启动命令）
- [ ] 更新 ARCHITECTURE.md（Docker 架构）
- [ ] 创建 DOCKER.md（运维手册）

## 风险和缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| Docker 镜像构建失败 | 中 | 高 | 提前测试，准备回滚脚本 |
| 健康检查配置错误 | 低 | 中 | 使用经过验证的配置 |
| 凭据文件权限问题 | 中 | 高 | 检查文件权限 600 |
| 网络连接问题 | 低 | 高 | 使用 host 网络模式 |
| 磁盘空间不足 | 低 | 中 | 日志轮转限制大小 |

## 下一步

部署成功后：
1. 监控运行 24 小时，验证稳定性
2. 添加 Prometheus metrics（可选）
3. 添加 Grafana 监控面板（可选）
4. 考虑引入 BullMQ 替代 Tick Loop（未来优化）
