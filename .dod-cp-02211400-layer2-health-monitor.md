---
id: dod-cp-02211400-layer2-health-monitor
version: 1.0.0
created: 2026-02-21
updated: 2026-02-21
changelog:
  - 1.0.0: 初始版本
---

# DoD：Layer 2 运行健康监控

## 验收清单

- [ ] D1: `health-monitor.js` 导出 `runLayer2HealthCheck(pool)` 函数
- [ ] D2: `runLayer2HealthCheck` 执行 4 项 SQL 检查（dispatched_1h, stuck_tasks, last_success_ago_min, queue_depth）
- [ ] D3: `calculateHealthLevel(checks)` 正确计算等级（healthy/warning/critical）
- [ ] D4: 结果写入 `cecelia_events` 表，type='layer2_health'
- [ ] D5: tick.js 每小时调用一次（`_lastHealthCheckTime` 跟踪，测试重置函数导出）
- [ ] D6: 异常时 catch + log，不影响主 tick 流程
- [ ] D7: `vitest run` 全部通过，新增测试 >= 6 个
- [ ] D8: facts-check.mjs 通过（DEFINITION.md 同步）
- [ ] D9: check-version-sync.sh 通过（版本号同步）

## RCI 映射（回归契约）

- `health-monitor.js::runLayer2HealthCheck` → D1, D2, D4
- `health-monitor.js::calculateHealthLevel` → D3
- `tick.js::Section 0.7` → D5, D6
