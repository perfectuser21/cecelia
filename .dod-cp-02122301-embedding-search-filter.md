---
id: dod-embedding-search-filter
version: 1.0.0
created: 2026-02-12
changelog:
  - 1.0.0: 初始版本 - Embedding 搜索过滤功能 DoD
---

# DoD - Embedding 搜索过滤功能

## 验收标准

### 功能验收

- [ ] getAllActiveEntities() 方法支持可选的 filters 参数对象
      Test: manual:检查方法签名和 JSDoc

- [ ] LIMIT 100 限制被移除，改为可配置参数（默认 1000）
      Test: manual:查看 SQL 查询中的 LIMIT 子句

- [ ] 支持按 repo 过滤（metadata->>'repo'）
      Test: manual:curl 测试 filters.repo 参数

- [ ] 支持按 project_id 过滤
      Test: manual:curl 测试 filters.project_id 参数

- [ ] 支持按日期范围过滤（date_from / date_to）
      Test: manual:curl 测试 filters.date_from 和 filters.date_to 参数

- [ ] API 端点 /api/brain/search-similar 接受 filters 参数
      Test: manual:curl 测试完整请求格式

- [ ] 过滤逻辑在 SQL WHERE 子句中实现（不是内存过滤）
      Test: manual:检查 SQL 查询构建逻辑

- [ ] 向后兼容 - 不传 filters 时保持原有行为
      Test: manual:curl 测试不带 filters 参数的请求

- [ ] 使用参数化查询防止 SQL 注入
      Test: manual:检查 SQL 查询是否使用 $1, $2 等占位符

### API 测试验收

- [ ] API 请求格式正确处理
      Test: manual:使用 curl 测试以下请求格式
      ```json
      {
        "query": "search text",
        "top_k": 5,
        "filters": {
          "repo": "cecelia-workspace",
          "project_id": 123,
          "date_from": "2026-01-01",
          "date_to": "2026-02-12"
        }
      }
      ```

- [ ] 只传部分 filters 参数能正常工作
      Test: manual:curl 测试只传 repo 或只传 project_id

- [ ] filters 参数验证（repo 必须是字符串，project_id 必须是数字）
      Test: manual:curl 测试无效参数格式

### 代码质量验收

- [ ] JSDoc 文档说明 filters 参数格式
      Test: manual:检查 getAllActiveEntities 方法的 JSDoc

- [ ] routes.js 中添加参数提取和验证逻辑
      Test: manual:检查 /search-similar 路由代码

- [ ] 没有修改 Jaccard 算法本身
      Test: manual:确认 Jaccard 相关代码未变更

### 测试验收

- [ ] npm run qa 通过（如果存在）
      Test: contract:C2-001
