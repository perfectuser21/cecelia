---
id: prd-usage-aware-scheduling
version: 1.0.0
created: 2026-02-27
updated: 2026-02-27
changelog:
  - 1.0.0: 初始版本
---

# PRD：Claude Max 账号用量感知调度

## 背景

Cecelia 现有4个无头执行账号：
- account1 (alexperfectapi01@gmail.com) — Claude Max
- account2 (chalexlch@gmail.com) — Claude Max
- account3 (zenithjoy21xx@gmail.com) — Claude Max
- MiniMax — 第三方 API（无限额）

每个 Claude Max 账号有 5小时窗口用量限制。目前调度时固定使用某个账号，没有根据剩余额度智能选择。

## 目标

实现用量感知的账号调度，优先选用量最低的账号，避免单一账号耗尽。

## 功能需求

### 1. 用量查询 API

**端点**：`GET https://api.anthropic.com/api/oauth/usage`
**Headers**：
- `Authorization: Bearer {accessToken}`
- `User-Agent: claude-code/2.0.31`
- `anthropic-beta: oauth-2025-04-20`

**响应**：
```json
{
  "five_hour": { "utilization": 26.0, "resets_at": "..." },
  "seven_day": { "utilization": 8.0, "resets_at": "..." },
  "extra_usage": { "utilization": null, ... }
}
```

### 2. 用量缓存（PostgreSQL）

新增表 `account_usage_cache`：
```sql
CREATE TABLE account_usage_cache (
  account_id TEXT PRIMARY KEY,  -- 'account1', 'account2', 'account3'
  five_hour_pct FLOAT,          -- 5小时用量百分比
  seven_day_pct FLOAT,          -- 本周用量百分比
  resets_at TIMESTAMPTZ,        -- 5小时重置时间
  extra_used BOOLEAN,           -- 是否超额用了 extra
  fetched_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 3. 定期刷新

- 每次派发任务前自动刷新用量
- 缓存有效期：10分钟（避免频繁调用）

### 4. 智能账号选择

Brain 派发任务时的账号选择逻辑：

```
1. 获取所有账号当前用量（含缓存）
2. 过滤掉 five_hour_pct >= 80% 的账号
3. 按 five_hour_pct 升序排序
4. 选用量最低的账号
5. 若所有 Claude Max 账号都 >= 80%，自动降级到 MiniMax
```

### 5. Brain API 端点

新增：
- `GET /api/brain/account-usage` — 查看当前所有账号用量
- `POST /api/brain/account-usage/refresh` — 手动刷新用量缓存

## 成功标准

1. Brain 派发任务时，自动选择用量最低的 Claude Max 账号
2. 账号用量 >= 80% 时自动跳过，切换到下一个
3. 所有 Claude Max 账号满载时，自动切换到 MiniMax
4. `/api/brain/account-usage` 返回实时用量数据

## 技术约束

- 不影响现有 cecelia-run 运行逻辑
- 用量查询失败时，降级为随机选择（不阻塞调度）
- 凭据路径：`~/.claude-accountN/.credentials.json`
