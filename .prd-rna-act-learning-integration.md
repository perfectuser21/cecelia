# PRD - RNA 式自进化：验证并量化 Learning 闭环

## 需求来源

欲望驱动任务（desire ID: e894dae3-39f0-4248-8d0e-05207998cd94）
- KR: "Cecelia 实现 RNA 式自进化 — 行动产生学习、自我修复、主动巡检"
- 状态: needs_info, 0% 进度, 94 小时停滞
- 系统执行层满载（派发 95%、安全 89%），条件就绪

**探索发现：Act → Learning 核心功能已实现！**

- ✅ `auto-learning.js` 已实现 Learning 自动提取
- ✅ `execution-callback` (routes.js:3144-3166) 已集成
- ✅ `learnings` 表已存在 (migrations/012)
- ✅ `planner.js` 已实现 learnings 检索 (buildLearningPenaltyMap)

**问题根源：功能已实现但未被量化和验证，导致 KR 进度停滞在 0%**

## 功能描述

**验证并量化现有 RNA Learning 闭环，证明其有效运行**

1. **端到端测试**：执行真实任务 → 验证 Learning 自动生成 → 验证决策时自动应用
2. **可观测性增强**：添加指标统计和日志，量化 Learning 闭环的实际效果
3. **KR 进度计算**：基于 learnings 表数据，计算 RNA KR 的实际进度（从 0% → 实际值）

### 核心验证流程

```
1. 查询现有 learnings 数据
   ↓ SELECT COUNT(*) FROM learnings
   ↓ 已有 N 条 Learning 记录

2. 执行测试任务（触发 auto-learning）
   ↓ POST /api/brain/tick
   ↓ 观察 execution-callback 日志

3. 验证 Learning 生成
   ↓ 检查 learnings 表新增记录
   ↓ 验证 content_hash 去重机制

4. 验证决策时检索
   ↓ planner.js buildLearningPenaltyMap
   ↓ 日志中能看到 "Retrieved N learnings"

5. 量化效果
   ↓ learnings 表统计
   ↓ 更新 RNA KR 进度
```

## 涉及文件

**验证和统计**：
- `packages/brain/tests/auto-learning.test.js` - 单元测试（新建）
- `packages/brain/src/routes.js` - 添加 `/api/brain/learnings/stats` 端点
- `scripts/verify-rna-learning.sh` - 端到端验证脚本（新建）

**可选增强**：
- `packages/brain/src/auto-learning.js` - 增强日志输出（如需要）
- `packages/brain/src/planner.js` - 增强 learnings 检索日志（如需要）

## 成功标准

1. ✅ 单元测试通过：`npm test` 覆盖 auto-learning.js 核心逻辑
2. ✅ 端到端验证：`bash scripts/verify-rna-learning.sh` 通过所有检查点
3. ✅ learnings 表有数据：`SELECT COUNT(*) FROM learnings WHERE created_at > NOW() - INTERVAL '7 days'` > 0
4. ✅ Learning 应用有日志：planner.js 日志中能看到 "learning penalty applied"
5. ✅ KR 进度更新：RNA KR 进度从 0% → 基于实际 learnings 数据的量化值
6. ✅ CI 通过（Brain CI）

## 非目标

- ❌ 不改变现有 auto-learning 核心逻辑（已验证正确）
- ❌ 不实现 Cortex (L2) 深度分析（后续 PR）
- ❌ 不实现自我修复（后续 PR）
- ❌ 不实现主动巡检（后续 PR）
- ❌ 不调整前端 UI（本 PR 纯后端验证）

## 验收要点

**数据验证**：
```sql
-- 1. learnings 表有数据
SELECT COUNT(*), category, trigger_event
FROM learnings
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY category, trigger_event;

-- 2. content_hash 去重机制工作
SELECT content_hash, COUNT(*)
FROM learnings
GROUP BY content_hash
HAVING COUNT(*) > 1;  -- 应该为空

-- 3. Learning 关联 task_id
SELECT l.id, l.title, l.created_at, t.title as task_title
FROM learnings l
JOIN tasks t ON (l.metadata->>'task_id')::uuid = t.id
LIMIT 10;
```

**日志验证**：
```bash
# planner.js 应用 learnings 的日志
docker logs cecelia-node-brain 2>&1 | grep "learning penalty"

# execution-callback 创建 learnings 的日志
docker logs cecelia-node-brain 2>&1 | grep "Auto-learning created"
```

**KR 进度计算公式**：
```
RNA KR 进度 = (learnings 总数 / 目标 learnings 数) * 权重 + 其他维度
目标 learnings 数 = 100（初步设定，7 天内累积）
```

## 优先级

P0 - RNA KR 的第一个 PR，从"功能未实现"认知 → "功能已实现但未量化"认知 → 量化并更新 KR 进度
