---
id: prd-okr-validation-spec
version: 1.0.0
created: 2026-02-22
updated: 2026-02-22
changelog:
  - 1.0.0: 初始版本
---

# PRD: OKR Validation Spec + Validator (L0)

## 背景

当前 OKR 拆解体系（decomposition-checker.js）只检查"有没有子节点"，完全缺乏：
- 结构完整性校验（必须字段、类型一致、数量范围）
- 关联关系校验（孤儿节点、parent 不存在）
- 依赖图校验（pr_plan.depends_on 环检测）
- 文本质量校验（空标题、废话标题）

需要一套统一的 Validation Spec + Validator，作为三层验证架构的 L0（结构层）。

## 目标

1. 创建 `config/okr-validation-spec.yml` — 统一验证标准（三层共享）
2. 创建 `brain/src/validate-okr-structure.js` — 验证器模块
3. 集成到运行时：decomposition-checker 入库前调用
4. 集成到 CI：新增 DevGate 脚本

## 设计约束

### DB Schema 对齐（CRITICAL）

Spec 必须使用真实 DB 字段名：

| 概念 | 实际表 | 区分字段 |
|------|--------|---------|
| global_okr / global_kr / area_okr / area_kr | `goals` 表 | `type` 字段 |
| project / initiative | `projects` 表 | `type` 字段 |
| pr_plan | `pr_plans` 表 | - |
| task | `tasks` 表 | - |
| KR→Project 关系 | `project_kr_links` 表 | 多对多 |

### Validator 接口

```js
// 两种调用方式
// 1. 运行时：传 pool，scope 查询
const result = await validateOkrStructure(pool, { scope: 'kr', rootId: krId });

// 2. CI 模式：传 pool，全量查询
const result = await validateOkrStructure(pool, { scope: 'full' });

// 返回值
// { ok: boolean, issues: ValidationIssue[] }
```

### 检查清单

| 检查类型 | 覆盖实体 | severity |
|----------|---------|----------|
| 必须字段非空 | 全部 | BLOCK |
| parent 存在性 | goals, projects | BLOCK |
| parent type 一致 | goals (area_okr parent 必须是 global_kr) | BLOCK |
| children 数量范围 | 全部有子实体的 | WARNING(min) / WARNING(max) |
| 孤儿节点 | tasks, initiatives | BLOCK |
| 依赖环检测 | pr_plans.depends_on | BLOCK |
| 文本长度 | title, description | WARNING |
| 禁词检测 | task.title | BLOCK |

## 不做

- L1 语义自检（LLM）— 后续 PR
- L2 独立审计 — 后续 PR
- 修改 decomposition-checker.js 流程 — 本 PR 只加模块，不改主链路
