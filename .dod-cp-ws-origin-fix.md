---
id: dod-ws-origin-fix
version: 1.0.0
created: 2026-02-26
updated: 2026-02-26
changelog:
  - 1.0.0: 初始版本
---

# DoD: WebSocket Origin 修复 + Frontend Proxy 架构升级

## 验收清单

- [x] **D1**: frontend-proxy.js 端口改为 5211（取代 PM2）
  - Test: 容器启动后 `curl http://localhost:5211/` 返回 HTML

- [x] **D2**: frontend-proxy.js 直接代理到 Brain 5221（不再经过 PM2）
  - Test: `curl http://localhost:5211/api/brain/health` 返回 Brain 健康状态

- [x] **D3**: frontend-proxy.js /api/* 路径改写为 /api/brain/*
  - Test: `curl http://localhost:5211/api/orchestrator/health` 正确代理到 Brain

- [x] **D4**: WS 升级时改写 Origin header 为 localhost
  - Test: 使用 `origin: http://perfect21:5211` 连接 WS 不被拒绝

- [x] **D5**: server.ts 移除 orchestratorProxy 的 ws:true
  - Test: server.ts 中 orchestratorProxy 不包含 `ws: true`

- [x] **D6**: Brain 日志不再出现 "Rejected connection from unauthorized origin"
  - Test: WebSocket 连接后检查 Brain 日志无 reject 记录
