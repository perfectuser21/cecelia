# DoD: Final Cleanup - Migration 035

## 验收清单

### Migration 035
- [ ] Migration 文件创建：`035_final_cleanup_orphans_and_types.sql`
- [ ] 删除 features 表
- [ ] 删除 key_results 表
- [ ] 修正 goal type 值（objective → global_okr/area_okr）
- [ ] 添加 goal type CHECK 约束
- [ ] Schema version 更新到 035

### Code Updates
- [ ] selfcheck.js: EXPECTED_SCHEMA_VERSION = '035'
- [ ] selfcheck.test.js: 测试期望更新
- [ ] DEFINITION.md: Schema 版本 035
- [ ] MEMORY.md: Schema 版本 035

### Documentation Updates
- [ ] .env.docker: 配置清理提交
- [ ] BRAIN_CAPABILITIES_REPORT.md: 版本更新提交
- [ ] PRODUCTION_LAUNCH.md: 版本更新提交
- [ ] docs/TASK-SYSTEM-DEFINITION.md: v2.0.0 提交
- [ ] 其他文档更新提交

### Testing & Validation
- [ ] facts-check 通过
- [ ] version-sync 通过
- [ ] npm test 通过
- [ ] 数据库 Schema 验证
  - [ ] features 表不存在
  - [ ] key_results 表不存在
  - [ ] goals.type 只包含 (global_okr, area_okr, kr)
  - [ ] goals 表有 type CHECK 约束

### Version & Release
- [ ] Version bump: 1.40.2 → 1.40.3
- [ ] VERSION 文件同步
- [ ] .brain-versions 同步
- [ ] package.json 同步
- [ ] package-lock.json 同步

### PR & CI
- [ ] PR 创建
- [ ] CI 通过
- [ ] PR 合并到 main

## 测试映射

| DoD 项 | 测试方法 |
|--------|----------|
| Migration 035 | 手动执行后查询 schema_version |
| 删除表 | `SELECT table_name FROM information_schema.tables WHERE table_name IN ('features', 'key_results')` |
| Goal type 修正 | `SELECT DISTINCT type FROM goals` |
| Type 约束 | `INSERT INTO goals (title, type) VALUES ('test', 'invalid')` 应失败 |
| EXPECTED_SCHEMA_VERSION | selfcheck.test.js |
| facts-check | `node scripts/facts-check.mjs` |
| version-sync | `bash scripts/check-version-sync.sh` |
