# PRD: 修复 Embeddings 生成无限重试导致 Brain 崩溃

## 问题背景

**严重性**: P0 - 阻塞性问题（导致 Brain 崩溃）

**事件时间线**：
- 2026-02-14 10:30: 后台任务启动 Migration 031 + 生成 embeddings
- 12:05-12:56: PostgreSQL 大量认证超时错误（持续 1 小时）
- 12:57: 系统检测到 CPU 105% 持续高负载
- 13:00: Brain 容器崩溃 (exit 1)

**根本原因**：
1. OpenAI API quota 超限
2. `generate-capability-embeddings.mjs` 对每个 capability 重试 3 次
3. 23 个 capabilities × 3 次 = 69 次 API 调用
4. 后台任务失败后被重新调度
5. 循环：失败 → 重试 → 失败 → 重新调度 → 持续 1 小时高负载
6. PostgreSQL 连接池耗尽 → Brain 崩溃

## 需求描述

### 核心需求

修复 `generate-capability-embeddings.mjs` 和 `openai-client.js`，防止无限重试导致系统崩溃。

### 功能需求

1. **添加全局失败计数**
   - 限制总失败次数（不是单个 API 调用的重试）
   - 连续失败 3 次 → 立即退出，不继续其他 capabilities

2. **OpenAI Quota 快速检测**
   - 检测 quota exceeded 错误 → 立即退出（不重试）
   - 记录清晰的错误信息，便于排查

3. **改进错误处理**
   - 区分临时错误（网络）vs 永久错误（quota）
   - 临时错误：重试
   - 永久错误：立即失败

4. **添加保护机制**
   - 最大运行时间限制（5 分钟）
   - 超时自动退出

## 涉及文件

1. `brain/src/generate-capability-embeddings.mjs` - 主脚本
2. `brain/src/openai-client.js` - API 客户端
3. `brain/src/__tests__/openai-client.test.js` - 测试（可能需要更新）

## 验收标准

### 1. Quota 超限时快速失败
- OpenAI quota exceeded → 脚本立即退出（exit 1）
- 不尝试处理剩余 capabilities
- 清晰的错误信息

### 2. 连续失败限制
- 连续 3 个 capabilities 失败 → 脚本退出
- 不会无限循环处理所有 23 个

### 3. 正常成功场景
- OpenAI API 正常 → 所有 capabilities 成功生成 embeddings
- exit 0

### 4. 部分成功场景
- 前 5 个成功，第 6 个开始失败 → 处理完第 8 个后退出
- 成功的 embeddings 已保存到数据库

## 成功指标

- ✅ 模拟 OpenAI quota exceeded → 脚本 <5 秒内退出
- ✅ CPU 不会超过 50%（不会无限重试）
- ✅ PostgreSQL 连接正常（不会耗尽连接池）
- ✅ 现有测试仍然通过

## 技术方案（参考）

### 方案 1：全局失败计数器

```javascript
// generate-capability-embeddings.mjs
let consecutiveFailures = 0;
const MAX_CONSECUTIVE_FAILURES = 3;

for (const capability of capabilities) {
  try {
    const embedding = await generateEmbedding(text);
    consecutiveFailures = 0; // 成功则重置
    successCount++;
  } catch (error) {
    consecutiveFailures++;
    failCount++;

    // 检查是否 quota 错误
    if (error.message.includes('insufficient_quota') ||
        error.message.includes('rate_limit_exceeded')) {
      console.error('OpenAI quota exceeded, stopping immediately');
      process.exit(1);
    }

    // 连续失败过多
    if (consecutiveFailures >= MAX_CONSECUTIVE_FAILURES) {
      console.error(`${MAX_CONSECUTIVE_FAILURES} consecutive failures, stopping`);
      process.exit(1);
    }
  }
}
```

### 方案 2：运行时间限制

```javascript
const MAX_RUNTIME_MS = 5 * 60 * 1000; // 5 分钟
const startTime = Date.now();

// 在循环中检查
if (Date.now() - startTime > MAX_RUNTIME_MS) {
  console.error('Max runtime exceeded, stopping');
  process.exit(1);
}
```

## 非功能需求

- 代码可读性：清晰的变量命名，注释说明
- 日志：记录失败原因、已处理数量
- 向后兼容：不影响正常使用场景

## 风险

- **低风险**：只修改 embeddings 生成脚本，不影响 Brain 核心功能
- **测试覆盖**：有现有测试 `openai-client.test.js`，需要确保通过

## 依赖

- OpenAI API（外部依赖，不在控制范围内）
- PostgreSQL（capabilities 表）

## 里程碑

- P0 修复完成 → Brain 稳定性恢复
- 后续可以安全地运行 OKR 拆解
