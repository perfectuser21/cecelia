---
id: dod-cp-02182200-dispatch-stats
version: 1.1.0
created: 2026-02-18
updated: 2026-02-18
changelog:
  - 1.0.0: 初始版本
  - 1.1.0: 新增 startup_errors 可观测 API 验收项
---

# DoD: 实现派发成功率统计

## 验收清单

- [ ] tick.js dispatchNextTask 函数在每次派发后更新 working_memory dispatch_stats
  - Test: `test/unit/dispatch-stats.test.js` - "成功派发后更新 dispatch_stats"
- [ ] 失败时记录具体 reason 分类
  - Test: `test/unit/dispatch-stats.test.js` - "失败派发记录正确的 reason"
- [ ] 支持 1 小时滚动窗口（超过 1h 的条目自动过期/不计入）
  - Test: `test/unit/dispatch-stats.test.js` - "1小时滚动窗口过滤"
- [ ] 多种失败原因各一个测试用例
  - Test: `test/unit/dispatch-stats.test.js` - "多种失败原因统计"
- [ ] 不影响现有派发逻辑（纯监控，不改变行为）
  - Test: 现有所有 tick 单元测试通过

## initTickLoop 重试机制

- [ ] initTickLoop 启动失败时，记录 startup_errors 到 working_memory
  - Test: `test/unit/init-tick-retry.test.js` - "启动失败时记录到 startup_errors"
- [ ] 默认重试3次，间隔10s（CECELIA_INIT_RETRY_COUNT 可配置）
  - Test: `test/unit/init-tick-retry.test.js` - "重试3次后放弃"
- [ ] 重试耗尽后发出 init_failed critical 事件
  - Test: `test/unit/init-tick-retry.test.js` - "重试耗尽发出 critical 事件"
- [ ] 如果某次重试成功，正常启动（不发 critical 事件）
  - Test: `test/unit/init-tick-retry.test.js` - "第二次重试成功时正常启动"

## startup_errors 可观测 API

- [ ] GET /api/brain/tick/startup-errors 返回 { errors, total_failures, last_error_at }
  - Test: `brain/src/__tests__/routes/tick-startup-errors.test.js` - "返回正确格式"
- [ ] 无错误时 errors 为空数组，total_failures 为 0
  - Test: `brain/src/__tests__/routes/tick-startup-errors.test.js` - "无错误时返回空数组"
- [ ] GET /api/brain/tick/status 响应包含 startup_ok 字段
  - Test: `brain/src/__tests__/routes/tick-startup-errors.test.js` - "tick/status 包含 startup_ok"
- [ ] startup_ok=false 当 total_failures > 0
  - Test: `brain/src/__tests__/routes/tick-startup-errors.test.js` - "startup_ok=false 当有失败记录"
