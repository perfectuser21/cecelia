---
id: prd-cp-02280916-memory-closure-chain
version: 1.0.0
created: 2026-02-28
updated: 2026-02-28
changelog:
  - 1.0.0: 初始版本
---

# PRD：memory_stream → learning → task 三段闭环链条

## 背景

Cecelia 的记忆系统目前存在"已修复故障污染检索"的问题：
- memory_stream 记录了大量历史故障（~1345 条），但没有"已解决"状态
- rumination 生成的 learning 没有指向源故障记录
- PR 合并后，对应的故障记忆没有自动标记为 resolved
- 导致 Cecelia 对话检索时，已修复的旧 bug 和当前有效知识混在一起

## 目标

实现故障记录 → 知识提炼 → 修复任务的完整因果闭环，让已修复的故障从检索中自动退出。

## 功能需求

### 1. memory_stream 加 status 字段
- 新增 `status VARCHAR(20) DEFAULT 'active'`（active / resolved）
- 新增 `resolved_by_task_id UUID`（指向完成修复的 task）
- 新增 `resolved_at TIMESTAMPTZ`

### 2. learnings 加 source_memory_id
- 新增 `source_memory_id UUID`（指向触发该 learning 的原始 memory_stream 记录）
- rumination 生成 learning 时，携带 source_memory_id

### 3. rumination.js 更新
- 生成 learning 时，将反刍来源的 memory_stream.id 写入 source_memory_id

### 4. execution-callback 回写 resolved
- dev 任务完成（status=completed）后：
  - 找到该 task 关联的 learning（通过 learnings 的 title/content 语义匹配，或直接通过 task_id 关联）
  - 通过 learning.source_memory_id 找到对应的 memory_stream 记录
  - 将 memory_stream.status 更新为 resolved，resolved_by_task_id = task.id，resolved_at = NOW()

## 成功标准

1. migration 跑通，memory_stream 有 status/resolved_by_task_id/resolved_at 三个新字段
2. learnings 有 source_memory_id 字段
3. rumination 生成 learning 时 source_memory_id 有值
4. dev 任务完成后，execution-callback 能找到并标记相关 memory_stream 为 resolved
5. 所有相关单元测试通过
