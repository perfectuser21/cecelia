---
id: prd-cp-02211300-codex-immune-trigger
version: 1.0.0
created: 2026-02-21
updated: 2026-02-21
changelog:
  - 1.0.0: 初始版本
---

# PRD — cecelia-core 接入 Codex 免疫检查触发点

## 背景

cecelia/quality 已实现 Codex 免疫检查器（codex-checker.js），
能够自动跑 cecelia-core 测试 + Codex 分析 + 结构化诊断。
现在需要在 cecelia-core Brain 侧加入触发逻辑，
让 Cecelia 能自动派发 codex_qa 任务。

## 功能描述

在 cecelia-core Brain 接入 Codex 免疫检查触发点，让 Brain 能每日自动派发 `codex_qa` 任务调用 Codex 检查器，形成 Cecelia 自身免疫闭环。

## 成功标准

- task-router.js 正确路由 codex_qa 任务到 US 节点
- tick.js 每日（>20h 间隔）自动创建 codex_qa 任务
- 全量测试通过

## 目标

1. Brain 能识别并路由 `codex_qa` 类型任务
2. 每日自动触发一次免疫检查（距上次 >20h）

## 功能需求

### FR-1：task-router.js 加路由

在 LOCATION_MAP 中加入：
```
'codex_qa': 'us'
```

### FR-2：tick.js 加每日触发

在 tick 执行阶段（ensureTaskInventory 或等价位置）加入：
- 查询最近一条 codex_qa 任务的 created_at
- 若超过 20 小时（或从未有过），创建新任务：
  ```
  title: 'Codex 免疫检查 - cecelia-core'
  task_type: 'codex_qa'
  priority: 'P1'
  description: '/home/xx/perfect21/cecelia/quality/scripts/run-codex-immune.sh'
  ```

## 边界

- 不修改 executor.js（执行路径不变）
- 不修改 immune-system.js（现有失败签名追踪不变）
- 改动范围：task-router.js + tick.js 各几行
