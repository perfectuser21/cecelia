## PRD - Thalamus.js 路由决策事件记录

**需求来源**: 用户需求 - 实现路由指标覆盖率从 0% 到 100%
**功能描述**: 在 processEvent() 函数的每个路由路径（quickRoute / Sonnet LLM / Cortex / fallback）中添加事件记录，将路由类型、置信度、事件类型等写入 cecelia_events 表
**涉及文件**:
- brain/thalamus.js（主要修改）
- brain/tests/thalamus-routing-events.test.js（新增测试）
**成功标准**:
- quickRoute 命中时记录 routing_decision 事件（event_type=quick_route）
- Sonnet 调用时记录 routing_decision 事件（event_type=llm_route）
- Cortex 升级时记录 routing_decision 事件（event_type=cortex_route）
- fallback 降级时记录 routing_decision 事件（event_type=fallback_route）
- 每个事件包含：route_type, event_type, confidence, level, actions_count, latency_ms
- 不阻塞主路径（fire and forget）
- 测试覆盖 thalamus.js 的路由记录逻辑
**非目标**:
- 不修改 cecelia_events 表结构（使用现有表）
- 不修改路由决策逻辑本身
- 不实现路由指标的查询/展示 API（这属于 Workspace）

---

## quickRoute 覆盖率分析
> 分析时间：2026-02-17 | 基于 brain/src/thalamus.js 当前代码

当前：14 种事件类型中，quickRoute 直接覆盖 6 种（42.9%），另有 1 种（TASK_FAILED）部分快速路由。

### 已覆盖（quickRoute 直接处理，不调用 Sonnet）

| 事件类型 | 条件 | 路由动作 | 置信度 |
|----------|------|----------|--------|
| `HEARTBEAT` | 无条件 | `no_action` | 1.0 |
| `TICK` | `!event.has_anomaly` | `fallback_to_tick` | 1.0 |
| `TASK_COMPLETED` | `!event.has_issues` | `dispatch_task` | 1.0 |
| `TASK_FAILED` | `!complex_reason && retry_count < 3` | `retry_task` | 0.9 |
| `TASK_FAILED` | `!complex_reason && retry_count >= 3` | `cancel_task` | 0.9 |
| `TASK_TIMEOUT` | 无条件 | `log_event + retry_task(backoff)` | 0.85 |
| `TASK_CREATED` | 无条件 | `no_action` | 1.0 |

**注：TASK_FAILED 当 `complex_reason=true` 时返回 null，走 Sonnet。**

### 未覆盖（需要 Sonnet LLM）

| 事件类型 | 典型决策逻辑 | 是否可快速化 | 价值评估 |
|----------|-------------|-------------|----------|
| `TICK`（有异常） | 分析异常类型，决定升级策略 | 中等（需区分异常类型） | 中 |
| `TASK_COMPLETED`（有问题） | 分析问题严重性，决定是否补救 | 中等（需理解问题内容） | 中 |
| `TASK_FAILED`（复杂原因） | RCA 分析，制定恢复策略 | 低（需 LLM 理解） | — |
| `USER_MESSAGE` | 理解用户意图，路由到合适 agent | 低（需 NLU） | — |
| `USER_COMMAND` | 解析命令，映射到系统操作 | 中等（已知命令可白名单化） | 中高 |
| `RESOURCE_LOW` | 评估资源紧张程度，决定限流/暂停策略 | **高**（阈值判断） | 高 |
| `OKR_CREATED` | 记录事件，触发秋米拆解 | **高**（固定逻辑） | 高 |
| `OKR_PROGRESS_UPDATE` | 更新进度，检查是否达成 | **高**（数值判断） | 高 |
| `OKR_BLOCKED` | 记录阻塞，通知用户 | **高**（固定逻辑） | 高 |
| `DEPARTMENT_REPORT` | 解析汇报内容，提取关键信息 | 低（需 LLM 理解） | — |
| `EXCEPTION_REPORT` | 分析异常，决定处理优先级 | 中等（可按异常类型分级） | 中 |

### 推荐扩展顺序

**第一优先级：OKR 事件（固定逻辑，零歧义）**
1. `OKR_CREATED` → `assign_to_autumnrice + log_event`（新 OKR 一律交给秋米拆解）
2. `OKR_PROGRESS_UPDATE` → `update_okr_progress + log_event`（直接更新，无需思考）
3. `OKR_BLOCKED` → `notify_user + mark_task_blocked`（固定响应）

**第二优先级：系统资源（阈值驱动，可纯代码）**
4. `RESOURCE_LOW` → 根据 `event.severity` 阈值分级：
   - `severity < 0.7` → `log_event`
   - `0.7 ≤ severity < 0.9` → `pause_task + log_event`
   - `severity ≥ 0.9` → `escalate_to_brain`

**第三优先级：异常 Tick 和有问题的 TASK_COMPLETED（部分可快速化）**
5. `TICK`（has_anomaly）→ 按 `event.anomaly_type` 白名单化常见异常
6. `TASK_COMPLETED`（has_issues）→ 按 `event.issue_severity` 分级处理

**第四优先级：命令路由白名单化**
7. `USER_COMMAND` → 维护命令 → action 映射表，已知命令直接路由

### 可观测性现状

**已实现（本 PR 实现）**：
- ✅ `quick_route` 命中时记录 `routing_decision` 事件
- ✅ `llm_route`（Sonnet 处理）记录 `routing_decision` 事件
- ✅ `cortex_route`（Opus 升级）记录 `routing_decision` 事件
- ✅ `fallback_route`（Sonnet 失败降级）记录 `routing_decision` 事件
- ✅ LLM 错误分类记录（`llm_api_error` / `llm_bad_output` / `llm_timeout`）
- ✅ Token 消耗记录（`token_usage` 事件）

**仍缺失**：
- ❌ 各事件类型的路由分布统计（哪些事件最频繁走 Sonnet？）
- ❌ quickRoute 未命中率分析（需要查询 API，属于 Workspace）

### 结论

建议将 quickRoute 覆盖率从当前 **6/14 = 42.9%** 提升到 **9/14 = 64.3%**（加入 OKR 三件套）。
加入 RESOURCE_LOW 后可达 **10/14 = 71.4%**。

**最高价值 Quick Win**：OKR 三种事件（OKR_CREATED / OKR_PROGRESS_UPDATE / OKR_BLOCKED）——决策逻辑完全固定，预计可节省 ~30% Sonnet 调用成本。
