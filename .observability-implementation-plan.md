---
id: observability-implementation-plan
version: 1.0.0
created: 2026-02-12
updated: 2026-02-12
changelog:
  - 1.0.0: åˆå§‹ç‰ˆæœ¬ - åŸºäºç”¨æˆ·è¯Šæ–­çš„å¯è§‚æµ‹æ€§è½åœ°æ–¹æ¡ˆ
---

# Cecelia Core å¯è§‚æµ‹æ€§å®æ–½æ–¹æ¡ˆ

## é—®é¢˜è¯Šæ–­

**æ ¸å¿ƒé—®é¢˜ä¸æ˜¯"è¦ä¸è¦åš Dashboard"ï¼Œè€Œæ˜¯"æ•°æ®æ¨¡å‹æ²¡æƒ³æ¸…æ¥š"ã€‚**

å½“å‰ç³»ç»Ÿç¼ºä¹**è¿è¡Œæ€äº‹å®å±‚**ï¼Œæ— æ³•å›ç­” 3 ä¸ªå…³é”®é—®é¢˜ï¼š
1. **æˆ‘ç°åœ¨å¡åœ¨å“ªä¸€å±‚/å“ªä¸€æ­¥ï¼Ÿ**
2. **ä¸ºä»€ä¹ˆå¡ï¼Ÿè¾“å…¥/è¾“å‡º/è¯æ®æ˜¯ä»€ä¹ˆï¼Ÿ**
3. **å“ªäº›æ˜¯å·²åºŸå¼ƒ/åƒåœ¾ï¼Œå“ªäº›æ˜¯æ´»è·ƒä¸»çº¿ï¼Ÿ**

## è§£å†³æ–¹æ¡ˆï¼šå¯è§‚æµ‹çš„çŠ¶æ€æœºè¿è¡Œå¹³å°

æŠŠç³»ç»Ÿï¼ˆN8N + å¤šæœº + Cecelia + å¤š repoï¼‰å˜æˆä¸€ä¸ª**å¯è¿½è¸ªã€å¯å›æ”¾ã€å¯é’»å–**çš„å¹³å°ã€‚

---

## Phase 1: æ•°æ®æ¨¡å‹ - run_events è¡¨

### è¿ç§»æ–‡ä»¶

å·²åˆ›å»ºï¼š`brain/migrations/023_add_run_events_observability.sql`

### æ ¸å¿ƒæ¦‚å¿µ

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `run_id` | ç«¯åˆ°ç«¯æ‰§è¡ŒIDï¼ˆä¸€æ¬¡å®Œæ•´çš„ä»»åŠ¡ï¼‰ | `550e8400-e29b-41d4-a716-446655440000` |
| `span_id` | æ­¥éª¤IDï¼ˆrun å†…çš„å•ä¸ªæ­¥éª¤ï¼‰ | `6ba7b810-9dad-11d1-80b4-00c04fd430c8` |
| `parent_span_id` | çˆ¶æ­¥éª¤IDï¼ˆæ”¯æŒåµŒå¥—ï¼‰ | `7c9e6679-7425-40de-944b-e07fc1f90ae7` |
| `layer` | æ‰§è¡Œå±‚çº§ | `L0_orchestrator`, `L1_brain`, `L2_executor`, `L3_browser`, `L4_artifact` |
| `step_name` | æ­¥éª¤åç§° | `connect_cdp`, `upload_file`, `fill_title` |
| `status` | çŠ¶æ€ | `queued`, `running`, `blocked`, `retrying`, `success`, `failed`, `canceled` |
| `reason_code` | å¤±è´¥åŸå› ï¼ˆå¯æšä¸¾ï¼‰ | `MISSING_FILE`, `SELECTOR_NOT_FOUND`, `AUTH_EXPIRED`, `TIMEOUT` |
| `artifacts` | è¯æ®æŒ‡é’ˆ | `{"screenshot": "/path.png", "log": "/log.txt"}` |
| `heartbeat_ts` | å¿ƒè·³æ—¶é—´ï¼ˆåˆ¤æ–­å¡æ­»ï¼‰ | `2026-02-12 10:30:45+00` |

### å…³é”®è§†å›¾

| è§†å›¾ | ç”¨é€” |
|------|------|
| `v_active_runs` | å½“å‰æ­£åœ¨è¿è¡Œçš„ runsï¼ˆå¸¦å¥åº·çŠ¶æ€ï¼‰ |
| `v_run_summary` | æŒ‰ run_id èšåˆçš„ç»Ÿè®¡ |
| `v_top_failure_reasons` | æœ€è¿‘24hæœ€å¸¸è§å¤±è´¥åŸå›  |

### è¾…åŠ©å‡½æ•°

| å‡½æ•° | ç”¨é€” |
|------|------|
| `update_run_heartbeat(span_id)` | æ›´æ–°å¿ƒè·³ |
| `detect_stuck_runs()` | æ£€æµ‹å¡æ­»çš„ runsï¼ˆ5åˆ†é’Ÿæ— å¿ƒè·³ï¼‰ |

---

## Phase 2: SDK - traceStep()

### Node.js SDK (`brain/src/trace.js`)

```javascript
import { withSpan } from './trace.js';

// è‡ªåŠ¨ wrapper - æ¨èæ–¹å¼
await withSpan({
  run_id: 'xxx',
  layer: 'L2_executor',
  step_name: 'upload_video',
  task_id: 'yyy'
}, async (span) => {
  // è®°å½•è¾“å…¥
  span.setInput({ file: 'video.mp4', size: 1024000 });

  // ä½ çš„ä¸šåŠ¡é€»è¾‘
  const result = await uploadToServer('video.mp4');

  // æ·»åŠ è¯æ®
  span.addArtifact('screenshot', '/tmp/upload_success.png');
  span.addArtifact('log', '/tmp/upload.log');

  return result; // è‡ªåŠ¨è®°å½•ä¸º output_summary
});

// æ‰‹åŠ¨æ§åˆ¶æ–¹å¼
const span = await traceStep.start({
  run_id: 'xxx',
  layer: 'L3_browser',
  step_name: 'fill_form'
});

try {
  await page.fill('#title', 'My Video');
  await traceStep.heartbeat(span.span_id); // ä¿æŒå¿ƒè·³
  await page.click('#submit');
  await traceStep.end(span.span_id, 'success');
} catch (err) {
  await traceStep.end(span.span_id, 'failed', 'SELECTOR_NOT_FOUND', err.message);
  throw err;
}
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… è‡ªåŠ¨å¿ƒè·³ï¼ˆæ¯30ç§’ï¼‰
- âœ… è‡ªåŠ¨åˆ†ç±»é”™è¯¯ï¼ˆTIMEOUT, MISSING_FILE, NETWORK_ERROR...ï¼‰
- âœ… è‡ªåŠ¨è®°å½•è¾“å…¥/è¾“å‡º
- âœ… æ”¯æŒåµŒå¥— spanï¼ˆparent_span_idï¼‰

### Python SDK (`brain/src/trace.py`)

```python
from trace import with_span, trace_step
import uuid

# è‡ªåŠ¨ wrapper
@with_span(
    run_id=str(uuid.uuid4()),
    layer='L1_brain',
    step_name='decide_next_task'
)
async def decide_next_task(span):
    span.set_input({'queue_size': 10, 'priority': 'P0'})

    # ä½ çš„ä¸šåŠ¡é€»è¾‘
    decision = await llm.decide(...)

    span.add_artifact('reasoning', '/tmp/decision_log.txt')

    return decision

# æ‰‹åŠ¨æ§åˆ¶
span = await trace_step.start(
    run_id=run_id,
    layer='L2_executor',
    step_name='git_commit'
)

try:
    result = subprocess.run(['git', 'commit', '-m', 'msg'])
    await trace_step.end(span['span_id'], 'success', output_summary={'commit': result.stdout})
except Exception as e:
    await trace_step.end(span['span_id'], 'failed', 'GIT_ERROR', str(e))
    raise
```

---

## Phase 3: Brain API ç«¯ç‚¹

### æ–°å¢ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | ç”¨é€” |
|------|------|------|
| `/api/brain/trace/runs/active` | GET | è·å–å½“å‰è¿è¡Œä¸­çš„ runs |
| `/api/brain/trace/runs/:run_id` | GET | è·å–å•ä¸ª run çš„å®Œæ•´æ—¶é—´çº¿ |
| `/api/brain/trace/runs/:run_id/graph` | GET | è·å–èŠ‚ç‚¹å›¾æ•°æ®ï¼ˆD3.jsæ ¼å¼ï¼‰ |
| `/api/brain/trace/failures/top` | GET | è·å–æœ€å¸¸è§å¤±è´¥åŸå›  |
| `/api/brain/trace/stuck` | GET | è·å–å¡æ­»çš„ runs |
| `/api/brain/trace/layers/:layer` | GET | æŒ‰å±‚çº§èšåˆç»Ÿè®¡ |

### ç¤ºä¾‹ç«¯ç‚¹å®ç° (`brain/src/routes/trace.js`)

```javascript
import express from 'express';
import {
  getActiveRuns,
  getRunTimeline,
  getRunSummary,
  getTopFailureReasons,
  getStuckRuns
} from '../trace.js';

const router = express.Router();

// GET /api/brain/trace/runs/active
router.get('/runs/active', async (req, res) => {
  const runs = await getActiveRuns();
  res.json(runs);
});

// GET /api/brain/trace/runs/:run_id
router.get('/runs/:run_id', async (req, res) => {
  const { run_id } = req.params;
  const [timeline, summary] = await Promise.all([
    getRunTimeline(run_id),
    getRunSummary(run_id)
  ]);

  res.json({
    run_id,
    summary,
    timeline
  });
});

// GET /api/brain/trace/runs/:run_id/graph
router.get('/runs/:run_id/graph', async (req, res) => {
  const { run_id } = req.params;
  const spans = await getRunTimeline(run_id);

  // è½¬æ¢ä¸º D3.js èŠ‚ç‚¹å›¾æ ¼å¼
  const nodes = spans.map(s => ({
    id: s.span_id,
    label: s.step_name,
    layer: s.layer,
    status: s.status,
    duration: s.duration_seconds
  }));

  const links = spans
    .filter(s => s.parent_span_id)
    .map(s => ({
      source: s.parent_span_id,
      target: s.span_id
    }));

  res.json({ nodes, links });
});

// GET /api/brain/trace/failures/top
router.get('/failures/top', async (req, res) => {
  const failures = await getTopFailureReasons();
  res.json(failures);
});

// GET /api/brain/trace/stuck
router.get('/stuck', async (req, res) => {
  const stuck = await getStuckRuns();
  res.json(stuck);
});

export default router;
```

### é›†æˆåˆ° server.js

```javascript
import traceRouter from './routes/trace.js';
app.use('/api/brain/trace', traceRouter);
```

---

## Phase 4: Dashboard ç»„ä»¶

### 4.1 å…¨å±€æ€»è§ˆé¡µ (`RunsOverview.tsx`)

```typescript
import { useApi } from '../shared/hooks/useApi';

function RunsOverview() {
  const { data: active } = useApi('/api/brain/trace/runs/active', { pollInterval: 5000 });
  const { data: failures } = useApi('/api/brain/trace/failures/top');
  const { data: stuck } = useApi('/api/brain/trace/stuck');

  return (
    <div className="grid grid-cols-3 gap-4">
      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <StatCard title="è¿è¡Œä¸­" value={active?.length || 0} color="blue" />
      <StatCard title="æœ€è¿‘å¤±è´¥" value={failures?.length || 0} color="red" />
      <StatCard title="å¡æ­»ä»»åŠ¡" value={stuck?.length || 0} color="yellow" />

      {/* å¡æ­»ä»»åŠ¡åˆ—è¡¨ï¼ˆæœ€é‡è¦ï¼ï¼‰ */}
      {stuck && stuck.length > 0 && (
        <div className="col-span-3 bg-yellow-50 border border-yellow-200 p-4 rounded">
          <h3 className="text-lg font-semibold text-yellow-800 mb-2">
            âš ï¸ å¡æ­»ä»»åŠ¡ï¼ˆ5åˆ†é’Ÿæ— å¿ƒè·³ï¼‰
          </h3>
          {stuck.map(s => (
            <div key={s.span_id} className="mb-2">
              <Link to={`/trace/runs/${s.run_id}`}>
                <span className="font-mono">{s.layer}</span> &gt; {s.step_name}
                <span className="text-sm text-gray-500 ml-2">
                  å¡äº† {Math.floor(s.stuck_duration_seconds / 60)} åˆ†é’Ÿ
                </span>
              </Link>
            </div>
          ))}
        </div>
      )}

      {/* æœ€å¸¸è§å¤±è´¥åŸå›  */}
      <div className="col-span-2">
        <h3 className="text-lg font-semibold mb-2">æœ€å¸¸è§å¤±è´¥åŸå› ï¼ˆ24hï¼‰</h3>
        <table className="w-full">
          <thead>
            <tr>
              <th>åŸå› </th>
              <th>å±‚çº§</th>
              <th>æ¬¡æ•°</th>
              <th>æœ€è¿‘ä¸€æ¬¡</th>
            </tr>
          </thead>
          <tbody>
            {failures?.map(f => (
              <tr key={`${f.reason_code}-${f.layer}`}>
                <td className="font-mono">{f.reason_code}</td>
                <td>{f.layer}</td>
                <td>{f.failure_count}</td>
                <td>{new Date(f.last_occurrence).toLocaleString()}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
```

### 4.2 Run è¯¦æƒ…é¡µ (`RunDetailPage.tsx`)

```typescript
import { useParams } from 'react-router-dom';
import { useApi } from '../shared/hooks/useApi';
import RunTimeline from '../components/RunTimeline';
import RunGraph from '../components/RunGraph';

function RunDetailPage() {
  const { run_id } = useParams();
  const { data: runData } = useApi(`/api/brain/trace/runs/${run_id}`);
  const { data: graphData } = useApi(`/api/brain/trace/runs/${run_id}/graph`);

  if (!runData) return <LoadingState />;

  const { summary, timeline } = runData;

  return (
    <div>
      {/* Summary Header */}
      <div className="bg-white p-4 rounded shadow mb-4">
        <h1 className="text-2xl font-bold mb-2">Run: {run_id}</h1>
        <div className="grid grid-cols-4 gap-4">
          <div>
            <span className="text-gray-500">çŠ¶æ€:</span>
            <StatusBadge status={summary.overall_status} />
          </div>
          <div>
            <span className="text-gray-500">æ€»æ­¥éª¤:</span> {summary.total_spans}
          </div>
          <div>
            <span className="text-gray-500">æˆåŠŸ:</span> {summary.success_spans}
          </div>
          <div>
            <span className="text-gray-500">å¤±è´¥:</span> {summary.failed_spans}
          </div>
        </div>
        <div className="mt-2">
          <span className="text-gray-500">æ¶‰åŠå±‚çº§:</span>{' '}
          {summary.layers_involved.join(' â†’ ')}
        </div>
      </div>

      {/* Tabs: Timeline vs Graph */}
      <Tabs defaultValue="timeline">
        <TabsList>
          <TabsTrigger value="timeline">æ—¶é—´çº¿</TabsTrigger>
          <TabsTrigger value="graph">èŠ‚ç‚¹å›¾</TabsTrigger>
        </TabsList>

        <TabsContent value="timeline">
          <RunTimeline timeline={timeline} />
        </TabsContent>

        <TabsContent value="graph">
          <RunGraph data={graphData} />
        </TabsContent>
      </Tabs>
    </div>
  );
}
```

### 4.3 æ—¶é—´çº¿ç»„ä»¶ (`RunTimeline.tsx`)

```typescript
function RunTimeline({ timeline }) {
  return (
    <div className="space-y-4">
      {timeline.map((span, idx) => {
        const isLastAlive = span.status === 'running' && idx === timeline.length - 1;

        return (
          <div
            key={span.span_id}
            className={`border-l-4 pl-4 py-2 ${
              isLastAlive ? 'border-yellow-500 bg-yellow-50' : 'border-gray-300'
            }`}
          >
            {isLastAlive && (
              <div className="text-yellow-700 font-semibold mb-1">
                âš ï¸ æœ€åä¸€ä¸ªæ´»è·ƒæ­¥éª¤ï¼ˆå¯èƒ½å¡åœ¨è¿™é‡Œï¼‰
              </div>
            )}

            <div className="flex items-start justify-between">
              <div>
                <div className="font-mono text-sm text-gray-500">{span.layer}</div>
                <div className="font-semibold">{span.step_name}</div>
                <div className="text-sm text-gray-600">
                  {new Date(span.ts_start).toLocaleTimeString()} -{' '}
                  {span.ts_end ? new Date(span.ts_end).toLocaleTimeString() : 'è¿è¡Œä¸­...'}
                </div>
              </div>

              <div>
                <StatusBadge status={span.status} />
                {span.reason_code && (
                  <span className="ml-2 text-xs font-mono bg-red-100 px-2 py-1 rounded">
                    {span.reason_code}
                  </span>
                )}
              </div>
            </div>

            {/* è¾“å…¥/è¾“å‡ºæ‘˜è¦ */}
            {span.input_summary && (
              <details className="mt-2">
                <summary className="cursor-pointer text-sm text-gray-500">è¾“å…¥å‚æ•°</summary>
                <pre className="text-xs bg-gray-100 p-2 rounded mt-1">
                  {JSON.stringify(span.input_summary, null, 2)}
                </pre>
              </details>
            )}

            {span.output_summary && (
              <details className="mt-2">
                <summary className="cursor-pointer text-sm text-gray-500">è¾“å‡ºç»“æœ</summary>
                <pre className="text-xs bg-gray-100 p-2 rounded mt-1">
                  {JSON.stringify(span.output_summary, null, 2)}
                </pre>
              </details>
            )}

            {/* è¯æ®é“¾æ¥ */}
            {span.artifacts && (
              <div className="mt-2 flex gap-2">
                {Object.entries(span.artifacts).map(([key, value]) => (
                  <a
                    key={key}
                    href={value}
                    target="_blank"
                    className="text-xs bg-blue-100 px-2 py-1 rounded hover:bg-blue-200"
                  >
                    ğŸ“ {key}
                  </a>
                ))}
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
}
```

### 4.4 èŠ‚ç‚¹å›¾ç»„ä»¶ (`RunGraph.tsx`)

ä½¿ç”¨ D3.js æˆ– React Flow æ¸²æŸ“èŠ‚ç‚¹å›¾ï¼š

```typescript
import ReactFlow, { Background, Controls } from 'reactflow';
import 'reactflow/dist/style.css';

function RunGraph({ data }) {
  const nodes = data.nodes.map(n => ({
    id: n.id,
    data: {
      label: n.label,
      status: n.status,
      duration: n.duration
    },
    position: { x: 0, y: 0 }, // ä½¿ç”¨ dagre è‡ªåŠ¨å¸ƒå±€
    style: {
      background: n.status === 'success' ? '#d4edda' : n.status === 'failed' ? '#f8d7da' : '#fff3cd',
      border: '2px solid #ccc',
      borderRadius: 8,
      padding: 10
    }
  }));

  const edges = data.links.map((l, idx) => ({
    id: `e${idx}`,
    source: l.source,
    target: l.target,
    animated: true
  }));

  return (
    <div style={{ height: 600 }}>
      <ReactFlow nodes={nodes} edges={edges} fitView>
        <Background />
        <Controls />
      </ReactFlow>
    </div>
  );
}
```

---

## Phase 5: åƒåœ¾è¯†åˆ«ä¸æ¸…ç†

### 5.1 äº§ç‰©ç»‘å®š run_id

**è§„åˆ™ï¼šæ‰€æœ‰äº§ç‰©ï¼ˆè„šæœ¬/ä¸´æ—¶æ–‡ä»¶/å·¥ä½œç›®å½•ï¼‰å¿…é¡»ç»‘å®š run_id**

```bash
# ä¸´æ—¶æ–‡ä»¶å‘½åè§„èŒƒ
/tmp/cecelia-runs/${run_id}/screenshot.png
/tmp/cecelia-runs/${run_id}/upload.log
/tmp/cecelia-runs/${run_id}/workspace/
```

### 5.2 TTL æ¸…ç†ä»»åŠ¡

```javascript
// brain/src/jobs/gc-runs.js
import fs from 'fs/promises';
import path from 'path';
import db from '../db.js';

async function cleanupExpiredRuns() {
  // æŸ¥æ‰¾ 7 å¤©å‰å®Œæˆçš„ runs
  const result = await db.query(`
    SELECT DISTINCT run_id
    FROM run_events
    WHERE status IN ('success', 'failed', 'canceled')
      AND ts_end < now() - interval '7 days'
  `);

  for (const row of result.rows) {
    const runDir = `/tmp/cecelia-runs/${row.run_id}`;

    try {
      // å½’æ¡£åˆ° S3/NASï¼ˆå¯é€‰ï¼‰
      // await archiveToS3(runDir, row.run_id);

      // åˆ é™¤æœ¬åœ°æ–‡ä»¶
      await fs.rm(runDir, { recursive: true, force: true });

      // æ ‡è®°ä¸ºå·²æ¸…ç†
      await db.query(
        `UPDATE run_events SET metadata = jsonb_set(COALESCE(metadata, '{}'::jsonb), '{gc_at}', to_jsonb(now()))
         WHERE run_id = $1`,
        [row.run_id]
      );

      console.log(`[GC] Cleaned up run ${row.run_id}`);
    } catch (err) {
      console.error(`[GC] Failed to clean ${row.run_id}:`, err.message);
    }
  }
}

// æ¯å¤©è¿è¡Œä¸€æ¬¡
setInterval(cleanupExpiredRuns, 24 * 60 * 60 * 1000);
```

### 5.3 Dashboard åƒåœ¾è¯†åˆ«

```typescript
// åœ¨ Dashboard ä¸Šæ˜¾ç¤º"æœªå¼•ç”¨äº§ç‰©"
function GarbageList() {
  const { data } = useApi('/api/brain/trace/garbage');

  return (
    <div>
      <h3>ğŸ—‘ï¸ æœªå¼•ç”¨äº§ç‰©ï¼ˆ7å¤©å†…æ— æ´»åŠ¨ï¼‰</h3>
      <ul>
        {data?.map(item => (
          <li key={item.path}>
            {item.path} - {item.size_mb} MB
            <button onClick={() => deleteGarbage(item.path)}>åˆ é™¤</button>
          </li>
        ))}
      </ul>
    </div>
  );
}
```

---

## Phase 6: åˆ†å±‚æ ‡å‡†å®šä¹‰

### 6.1 Cecelia ç”Ÿæ€çš„å±‚çº§åˆ’åˆ†

| å±‚çº§ | åç§° | èŒè´£ | ç¤ºä¾‹æ­¥éª¤ | åœ¨å“ªå°æœºå™¨ |
|------|------|------|----------|-----------|
| **L0_orchestrator** | ç¼–æ’å™¨ | è§¦å‘/ç¼–æ’/ä¼ å‚ | `trigger_n8n`, `schedule_task`, `dispatch_to_executor` | N8N (Docker) |
| **L1_brain** | å†³ç­–å™¨ | åˆ†æ/å†³ç­–/é€‰æ–¹æ¡ˆ | `decide_next_task`, `classify_failure`, `adjust_priority` | Brain (Node.js) |
| **L2_executor** | æ‰§è¡Œå™¨ | å‘½ä»¤æ‰§è¡Œ/è°ƒç”¨ API | `git_commit`, `ssh_to_vps`, `call_llm`, `run_test` | VPS/Mac/PC |
| **L3_browser** | æµè§ˆå™¨è‡ªåŠ¨åŒ– | ç½‘é¡µæ“ä½œ | `navigate_to_url`, `fill_form`, `click_button`, `screenshot` | Playwright |
| **L4_artifact** | äº§ç‰©ç®¡ç† | æ–‡ä»¶/å­˜å‚¨ | `upload_to_s3`, `save_screenshot`, `archive_log` | å­˜å‚¨ç³»ç»Ÿ |

### 6.2 run_id è´¯ç©¿ç¤ºä¾‹

```
Task ID: 550e8400-e29b-41d4-a716-446655440000
  â”œâ”€ Run ID: 6ba7b810-9dad-11d1-80b4-00c04fd430c8
      â”œâ”€ Span 1: L0_orchestrator > trigger_n8n (parent: null)
      â”œâ”€ Span 2: L1_brain > decide_upload_params (parent: Span 1)
      â”œâ”€ Span 3: L2_executor > launch_browser (parent: Span 2)
      â”œâ”€ Span 4: L3_browser > navigate_to_toutiao (parent: Span 3)
      â”œâ”€ Span 5: L3_browser > fill_title (parent: Span 4)
      â”œâ”€ Span 6: L3_browser > upload_video (parent: Span 4) â† å‡è®¾å¡åœ¨è¿™é‡Œ
      â””â”€ Span 7: L4_artifact > save_screenshot (parent: Span 6)
```

**Dashboard ä¸Šçœ‹åˆ°**ï¼š
- Run 6ba7... å¡åœ¨ **L3_browser > upload_video**
- æœ€åå¿ƒè·³ï¼š2åˆ†é’Ÿå‰
- è¯æ®ï¼šscreenshot â†’ `/tmp/runs/6ba7.../error.png`
- åŸå› ç ï¼š`SELECTOR_NOT_FOUND`

---

## Phase 7: å®æ–½æ¸…å•

| ä»»åŠ¡ | Owner | è¾“å‡º | å®Œæˆæ ‡å‡† | ä¼˜å…ˆçº§ |
|------|-------|------|----------|--------|
| 1. æ‰§è¡Œ migration 023 | System | `run_events` è¡¨åˆ›å»ºå®Œæˆ | `\d run_events` æœ‰æ•°æ® | P0 |
| 2. å®ç° Node.js trace.js SDK | System | `brain/src/trace.js` | å•æµ‹é€šè¿‡ | P0 |
| 3. å®ç° Python trace.py SDK | System | `brain/src/trace.py` | å•æµ‹é€šè¿‡ | P1 |
| 4. Brain æ·»åŠ  trace API è·¯ç”± | System | `/api/brain/trace/*` | Postman å¯è®¿é—® | P0 |
| 5. æ”¹é€  executor.js ä½¿ç”¨ withSpan | System | æ‰€æœ‰ dispatch éƒ½å†™ run_events | æ—¥å¿—æœ‰è®°å½• | P0 |
| 6. æ”¹é€  N8N workflow ä¼  run_id | System | N8N èŠ‚ç‚¹åŠ  run_id å‚æ•° | è´¯ç©¿å…¨æµç¨‹ | P1 |
| 7. Dashboard æ·»åŠ  RunsOverview é¡µ | Frontend | `/trace/overview` | èƒ½çœ‹åˆ°å¡æ­»ä»»åŠ¡ | P0 |
| 8. Dashboard æ·»åŠ  RunDetailPage | Frontend | `/trace/runs/:id` | æ—¶é—´çº¿+èŠ‚ç‚¹å›¾ | P0 |
| 9. æ·»åŠ  GC å®šæ—¶ä»»åŠ¡ | System | `brain/src/jobs/gc-runs.js` | 7å¤©è‡ªåŠ¨æ¸…ç† | P1 |
| 10. æ–‡æ¡£æ›´æ–° DEFINITION.md | Docs | æ·»åŠ å¯è§‚æµ‹æ€§ç« èŠ‚ | DevGate é€šè¿‡ | P1 |

---

## Phase 8: å¿«é€ŸéªŒè¯ï¼ˆMVPï¼‰

### ç¬¬ä¸€ä¸ªå¯ç”¨ç‰ˆæœ¬ï¼ˆ2-3å¤©ï¼‰

1. âœ… æ‰§è¡Œ migration 023
2. âœ… å®ç° Node.js trace.js
3. âœ… Brain æ·»åŠ  `/api/brain/trace/runs/active` ç«¯ç‚¹
4. âœ… æ”¹é€  **1 ä¸ªå…³é”®æµç¨‹**ï¼ˆå¦‚ task dispatchï¼‰ä½¿ç”¨ withSpan
5. âœ… Dashboard æ·»åŠ ç®€å•çš„"è¿è¡Œä¸­ä»»åŠ¡"åˆ—è¡¨é¡µ

**éªŒè¯æ ‡å‡†**ï¼š
- æ‰‹åŠ¨ dispatch ä¸€ä¸ªä»»åŠ¡
- åœ¨ Dashboard ä¸Šèƒ½çœ‹åˆ°å®æ—¶çš„ span è®°å½•
- èƒ½çœ‹åˆ°"å¡æ­»ä»»åŠ¡"è­¦å‘Š

---

## Phase 9: ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ

### 9.1 tasks è¡¨å…³è”

```sql
-- tasks.id â†’ run_events.task_id (å·²æœ‰å¤–é”®)
-- ä¸€ä¸ª task å¯èƒ½æœ‰å¤šä¸ª runsï¼ˆå¦‚æœé‡è¯•ï¼‰
```

### 9.2 feedback å­—æ®µå¢å¼º

```javascript
// tasks.feedback ä¸­è®°å½• run_id
await db.query(
  `UPDATE tasks SET feedback = feedback || $1::jsonb WHERE id = $2`,
  [
    JSON.stringify([{
      id: uuidv4(),
      status: 'completed',
      summary: 'ä»»åŠ¡æˆåŠŸ',
      run_id: run_id, // â† å…³è” run_events
      received_at: new Date().toISOString()
    }]),
    task_id
  ]
);
```

### 9.3 Brain status ç«¯ç‚¹å¢å¼º

```javascript
// GET /api/brain/status (ç²¾ç®€å†³ç­–åŒ…)
// å¢åŠ å­—æ®µ
{
  observability: {
    active_runs: 5,
    stuck_runs: 1,
    last_failure_reason: 'SELECTOR_NOT_FOUND'
  }
}
```

---

## Phase 10: æˆæœ¬ä¸æ”¶ç›Š

### å­˜å‚¨æˆæœ¬

| é¡¹ç›® | ä¼°ç®— |
|------|------|
| æ¯ä¸ª span | ~500 bytes |
| æ¯å¤© 1000 ä¸ªä»»åŠ¡ï¼Œå¹³å‡ 10 spans | 5 MB/å¤© |
| 7 å¤© TTL | 35 MB |
| 1 å¹´ä¿ç•™å‹ç¼©æ—¥å¿— | ~200 MB |

**ç»“è®º**ï¼šå­˜å‚¨æˆæœ¬å¯å¿½ç•¥ä¸è®¡

### æ€§èƒ½æˆæœ¬

| æ“ä½œ | å»¶è¿Ÿ |
|------|------|
| `traceStep.start()` | ~1-2ms (å•æ¬¡ INSERT) |
| `traceStep.heartbeat()` | ~0.5ms (å•æ¬¡ UPDATE) |
| æŸ¥è¯¢ run timeline | ~5-10ms (æŒ‰ run_id ç´¢å¼•) |

**ç»“è®º**ï¼šå‡ ä¹æ— æ€§èƒ½å½±å“

### å¼€å‘æˆæœ¬

| é˜¶æ®µ | å·¥ä½œé‡ |
|------|--------|
| Phase 1-2 (æ•°æ®æ¨¡å‹ + SDK) | 1 å¤© |
| Phase 3-4 (API + Dashboard) | 2 å¤© |
| Phase 5-6 (åƒåœ¾æ¸…ç† + åˆ†å±‚) | 1 å¤© |
| æµ‹è¯• + æ–‡æ¡£ | 1 å¤© |
| **æ€»è®¡** | **5 å¤©** |

### æ”¶ç›Š

| é—®é¢˜ | ç°åœ¨ | å®æ–½å |
|------|------|--------|
| "ä»»åŠ¡å¡åœ¨å“ªé‡Œï¼Ÿ" | é çŒœ/çœ‹æ—¥å¿— | 1ç§’å®šä½åˆ°å…·ä½“ span |
| "ä¸ºä»€ä¹ˆå¤±è´¥ï¼Ÿ" | ç¿»æ—¥å¿—/é‡ç° | çœ‹ reason_code + æˆªå›¾ |
| "å“ªäº›æ˜¯åƒåœ¾ï¼Ÿ" | æ‰‹åŠ¨æ¸…ç† | è‡ªåŠ¨è¯†åˆ« + ä¸€é”®åˆ é™¤ |
| "å¤šå±‚æ¶æ„ç†è§£" | å®¹æ˜“åç¦» | å±‚çº§æ¸…æ™°å¯è§ |

**ROI**ï¼š5 å¤©æŠ•å…¥ â†’ æ°¸ä¹…æ¶ˆé™¤"è¿·èŒ«æ„Ÿ"

---

## é™„å½• A: reason_code æšä¸¾è¡¨

| reason_code | å«ä¹‰ | åˆ†ç±» | å»ºè®®æ“ä½œ |
|-------------|------|------|----------|
| `TIMEOUT` | è¶…æ—¶ | Transient | é‡è¯• |
| `MISSING_FILE` | æ–‡ä»¶ä¸å­˜åœ¨ | Persistent | æ£€æŸ¥ä¸Šæ¸¸ |
| `SELECTOR_NOT_FOUND` | ç½‘é¡µå…ƒç´ æ‰¾ä¸åˆ° | Persistent | æ›´æ–° selector |
| `AUTH_EXPIRED` | è®¤è¯è¿‡æœŸ | Transient | åˆ·æ–° token |
| `NETWORK_ERROR` | ç½‘ç»œé”™è¯¯ | Transient | é‡è¯• |
| `OUT_OF_MEMORY` | å†…å­˜ä¸è¶³ | Resource | æ‰©å®¹/ä¼˜åŒ– |
| `PERMISSION_DENIED` | æƒé™é”™è¯¯ | Config | æ£€æŸ¥æƒé™ |
| `DEADLOCK` | æ•°æ®åº“æ­»é” | Transient | é‡è¯• |
| `UNEXPECTED_ERROR` | æœªåˆ†ç±»é”™è¯¯ | Unknown | äººå·¥åˆ†æ |

---

## é™„å½• B: ä¸ä¸šå†…æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåœºæ™¯ |
|------|------|------|----------|
| **Temporal** | å¤©ç„¶çŠ¶æ€æœºï¼ŒUI å®Œå–„ | éœ€è¦é‡æ„æ¶æ„ | ç»¿åœ°é¡¹ç›® |
| **OpenTelemetry** | ä¸šç•Œæ ‡å‡†ï¼Œç”Ÿæ€ä¸°å¯Œ | å­¦ä¹ æ›²çº¿ | å¤šè¯­è¨€å¤§è§„æ¨¡ |
| **æœ¬æ–¹æ¡ˆï¼ˆrun_eventsï¼‰** | æœ€ä½æˆæœ¬ï¼Œå®Œå…¨æ§åˆ¶ | éœ€è¦è‡ªå·±å®ç° UI | å¿«é€Ÿè½åœ° |

**æ¨è**ï¼šå…ˆç”¨æœ¬æ–¹æ¡ˆå¿«é€Ÿè½åœ°ï¼ˆ5å¤©ï¼‰ï¼ŒéªŒè¯ä»·å€¼åï¼Œå†è€ƒè™‘è¿ç§»åˆ° Temporalï¼ˆå¦‚æœè§„æ¨¡æ‰©å¤§ï¼‰ã€‚

---

## é™„å½• C: WebSocket å®æ—¶æ¨é€å¢å¼º

```javascript
// brain/src/websocket.js
import { Server } from 'socket.io';

export function setupTraceWebSocket(server) {
  const io = new Server(server, { path: '/ws/trace' });

  io.on('connection', (socket) => {
    console.log('[trace-ws] Client connected:', socket.id);

    // å®¢æˆ·ç«¯è®¢é˜…ç‰¹å®š run_id
    socket.on('subscribe_run', (run_id) => {
      socket.join(`run:${run_id}`);
    });

    socket.on('unsubscribe_run', (run_id) => {
      socket.leave(`run:${run_id}`);
    });
  });

  return io;
}

// åœ¨ traceStep.start() å’Œ traceStep.end() ä¸­å‘é€äº‹ä»¶
export function emitTraceEvent(io, run_id, event) {
  io.to(`run:${run_id}`).emit('trace_event', event);
}
```

**å‰ç«¯é›†æˆ**ï¼š

```typescript
// Dashboard å®æ—¶æ›´æ–°
import { io } from 'socket.io-client';

function RunDetailPage({ run_id }) {
  const [timeline, setTimeline] = useState([]);

  useEffect(() => {
    const socket = io('http://localhost:5221', { path: '/ws/trace' });

    socket.emit('subscribe_run', run_id);

    socket.on('trace_event', (event) => {
      setTimeline(prev => [...prev, event]); // å®æ—¶è¿½åŠ 
    });

    return () => {
      socket.emit('unsubscribe_run', run_id);
      socket.disconnect();
    };
  }, [run_id]);

  return <RunTimeline timeline={timeline} />;
}
```

---

## æ€»ç»“

è¿™å¥—æ–¹æ¡ˆçš„æ ¸å¿ƒæ˜¯ï¼š**ç»Ÿä¸€çš„ run_events äº‹ä»¶æµ = å¯è§‚æµ‹æ€§çš„å•ä¸€äº‹å®æ¥æº**ã€‚

æ‰€æœ‰å±‚ï¼ˆN8N/Brain/Executor/Browserï¼‰éƒ½å¾€è¿™é‡Œå†™ï¼ŒDashboard åªç®¡è¯»å–å’Œå¯è§†åŒ–ã€‚

**5 å¤©è½åœ°ï¼Œæ°¸ä¹…æ¶ˆé™¤è¿·èŒ«ã€‚**
