---
id: prd-cp-02190935-tick-stability-fixes
version: 1.0.0
created: 2026-02-19
updated: 2026-02-19
changelog:
  - 1.0.0: 初始版本
---

# PRD: Tick 系统稳定性修复（冷启动爆炸 + 24/7 运行障碍 + Token 控制）

## 背景

通过 4 个并行调查 agent 的深度分析，发现 Tick 系统存在多个严重 Bug，导致：
1. Tick 重启后瞬间派发 9 个任务（Token 爆炸）
2. 垃圾任务被无限重复拆解（initiative kr_id 指向错误）
3. CPU 阈值太紧导致正常运行就锁死（dispatch_allowed=false）
4. getDailyFocus() null 时整个 tick 直接退出
5. 无任何 Token 成本控制机制

## 目标

修复所有 P0/P1 Bug，使系统能够 24/7 稳定有序运行，不再出现 Token 爆炸。

## P0 修复项

### P0-1: 冷启动 ramp 限制（tick.js）
**问题**：Brain 重启后第一个 tick，getRampedDispatchMax() 没有历史记录时直接返回 effectiveDispatchMax（最大值 9），导致一次性派发 9 个任务。
**修复**：冷启动时从 min(2, effectiveDispatchMax) 开始，而非直接用 max。
**文件**：brain/src/tick.js 约 line 978

### P0-2: getDailyFocus null fallback（tick.js）
**问题**：getDailyFocus() 返回 null（无活跃 OKR）时，executeTick() 直接 return，跳过所有 dispatch 步骤。
**修复**：null 时 fallback 到全局 dispatch（跳过 focus 限制），不能直接退出。
**文件**：brain/src/tick.js 约 line 1237-1253

### P0-3: layers_triggered undefined bug（tick.js）
**问题**：tick.js:1144 引用了 decompSummary.layers_triggered 但该属性不存在，导致 TypeError 被 catch 吞掉，decomposition step 报错但无感知。
**修复**：移除对不存在属性的引用，或在 runDecompositionChecks() 返回值中添加该属性。
**文件**：brain/src/tick.js 约 line 1144，brain/src/decomposition-checker.js

### P0-4: Check 6 'cancelled' 拼写不一致（decomposition-checker.js）
**问题**：Check 6 SQL 里检查 `NOT IN ('completed', 'cancelled')`，但数据库已统一为美式拼写 'canceled'，dedup 逻辑实际失效。
**修复**：改为 `NOT IN ('completed', 'cancelled', 'canceled')` 同时兼容两种拼写。
**文件**：brain/src/decomposition-checker.js 约 line 651

## P1 修复项

### P1-1: CPU 阈值放宽（slot-allocator.js）
**问题**：CPU threshold = CPU_CORES * 0.85 - RESERVE_CPU = 5.8（8 核机器），5 个正常任务就会触发 effectiveSlots=0，造成死锁。
**修复**：将系数从 0.85 改为 0.95，threshold 提高到 6.6，或 Pool C 保底 1 slot（当 pressure < 1.5 时不允许 Pool C = 0）。
**文件**：brain/src/slot-allocator.js

### P1-2: cecelia-run 加 --max-turns 限制
**问题**：派发的 Claude 进程没有任何 token 上限，一个任务可以无限消耗 token。
**修复**：在 cecelia-run 的 claude -p 命令中加入 --max-turns 参数（默认 10）。
**文件**：/home/xx/bin/cecelia-run

### P1-3: execution-callback 冷却期（routes.js）
**问题**：任务完成后 execution-callback 立即触发下一个 tick，没有冷却期，导致任务连续完成时系统无喘息时间，立刻填满 slots。
**修复**：添加 30 秒冷却期，或至少加 5 秒延迟，防止瞬间回填。
**文件**：brain/src/routes.js 约 line 2309

## P1 数据修复（Migration）

### P1-4: Migration 040 - 修复 initiative kr_id + 建立 project_kr_links
**问题**：
1. 5 个 initiative 的 kr_id 指向 area_okr（应指向具体 KR），导致 KR 容量限制被绕过，任务被无限重复拆解
2. project_kr_links 表为空，planner 无法通过 KR→Project 路径找到任务

**修复**：
- 查找当前数据库中正确的 KR UUID（KR1/KR2/KR3）
- 将 initiative 的 kr_id 更新指向正确 KR
- 建立 cecelia-core project → KR1/KR2/KR3 的关联记录
- schema version bump: 039 → 040

**文件**：brain/migrations/040_fix_initiative_kr_links.sql

## 验收标准

1. Brain 重启后第一个 tick，dispatch 数量 ≤ 2（不再爆炸到 9）
2. getDailyFocus() 返回 null 时，tick 继续执行 dispatch（不退出）
3. decomposition check 不再报 TypeError
4. Check 6 的 SQL 正确识别 'canceled' 状态的任务
5. 8 核机器上 6 个任务运行时不再触发 dispatch_allowed=false
6. initiative.kr_id 全部指向正确的 KR 记录
7. project_kr_links 有 cecelia-core → KR1/KR2/KR3 的关联
8. cecelia-run 启动的 Claude 进程带 --max-turns 限制
9. execution-callback 触发下一个 tick 有延迟保护
