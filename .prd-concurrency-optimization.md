---
id: concurrency-optimization
version: 1.0.0
created: 2026-02-01
---

# PRD: 并发配置优化和清理

## 背景

深度扫描发现的问题：
1. **并发配置不一致**：Brain (3) vs cecelia-run (8)，浪费 5 个槽位
2. **资源充足**：CPU 2.54/6.4 (40%)，内存 11GB 可用，可以安全提升并发
3. **环境变量重复**：.env 和 .env.docker 高度重复
4. **文档与实际不符**：文档推荐 Docker，实际用手动启动

## 功能描述

### 目标

1. 统一并发配置（Brain + cecelia-run）
2. 基于 VPS 资源评估，提升并发数到最优值
3. 清理重复的环境变量配置
4. 明确启动方式（更新文档或迁移 Docker）

### 核心需求

#### 1. 统一并发配置

**当前状态**：
```bash
Brain: CECELIA_MAX_CONCURRENT=3
cecelia-run: MAX_CONCURRENT=${MAX_CONCURRENT:-8}  # 默认 8
```

**问题**：Brain 最多派发 3 个，但 cecelia-run 允许 8 个，不匹配

**目标配置（性能优先）**：
```bash
CECELIA_MAX_CONCURRENT=5  # Brain 派发限制
MAX_CONCURRENT=5          # cecelia-run 并发锁
```

**理由**：
- VPS 资源充足（CPU 40%, 内存 11GB/15GB）
- 预计负载：CPU ~4.5/6.4 (70%)，内存余量仍充足
- 吞吐量提升：67% (3→5)

#### 2. 动态资源阈值调整

当前硬编码阈值在 `brain/src/executor.js`：
```javascript
cpuLoadThreshold: cpuCores * 0.8  // 6.4
memAvailableMinMB: totalMemMB * 0.2  // 3000MB
```

**可选优化**：环境变量配置
```bash
CPU_LOAD_THRESHOLD_PCT=80  # 80% of cores
MEM_AVAILABLE_MIN_PCT=20   # 20% of total
SWAP_USED_MAX_PCT=50       # 50% swap usage
```

#### 3. 环境变量清理

**合并 .env.example**：
```bash
# 当前
.env.example          # Python Intelligence Service 配置
brain/.env.example    # Node Brain 配置（不一致）

# 目标
.env.example          # 统一的完整模板
```

**统一 .env 和 .env.docker**：
- 移除 `.env.docker` 中的 `MAX_CONCURRENT_TASKS`（废弃）
- 统一使用 `CECELIA_MAX_CONCURRENT`

#### 4. 启动方式明确

**选项 A：保持手动启动（当前）**
- 更新 README.md 和 DOCKER.md
- 明确说明 Docker 为可选方式
- 优点：灵活，方便开发调试

**选项 B：迁移到 Docker**
- 停止手动进程
- 启动 `docker compose up -d`
- 优点：自动重启、健康检查、日志轮转

**推荐**：选项 A（保持手动），更新文档

## 成功标准

### 功能验证

1. [ ] 并发配置统一
   - Brain 读取 `CECELIA_MAX_CONCURRENT=5`
   - cecelia-run 读取 `MAX_CONCURRENT=5`
   - `/tmp/cecelia-locks/` 最多 5 个锁文件

2. [ ] 配置生效验证
   - `curl http://localhost:5221/api/brain/tick/status | jq .max_concurrent` 返回 5
   - Brain 能成功派发 5 个并发任务
   - 资源监控在 5 个任务时仍然健康

3. [ ] 环境变量清理
   - `.env.example` 包含完整配置（Brain + Intelligence）
   - `brain/.env.example` 已删除或标记为废弃
   - `.env.docker` 移除废弃变量

4. [ ] 文档更新
   - README.md 明确说明启动方式（手动为主，Docker 可选）
   - DOCKER.md 标记为"可选部署方式"
   - 更新快速开始指南

### 性能验证

5. [ ] 负载测试（5 个并发任务）
   - CPU Load < 6.4（阈值）
   - 可用内存 > 3GB（阈值）
   - Swap 使用 < 50%
   - 所有任务成功完成

6. [ ] 有头+无头并发测试
   - 2 个有头 Claude Code 会话 + 3 个无头任务
   - Brain 资源检查正常工作
   - 无冲突或崩溃

### 回归验证

7. [ ] 现有功能不受影响
   - Tick 循环正常运行
   - Circuit Breaker 正常工作
   - 任务派发和执行正常
   - 数据库连接正常

## 技术实现

### 文件清单

**修改文件**：
- `.env` - 添加 `CECELIA_MAX_CONCURRENT=5`, `MAX_CONCURRENT=5`
- `.env.docker` - 更新并发配置，移除废弃变量
- `.env.example` - 合并两个 example 文件
- `README.md` - 更新启动方式说明
- `DOCKER.md` - 标记为可选部署方式
- `brain/src/executor.js` - 可选：环境变量配置阈值

**删除文件**：
- `brain/.env.example` - 已合并到根目录

### 实施步骤

1. **更新配置文件**
   ```bash
   # .env 添加
   CECELIA_MAX_CONCURRENT=5
   MAX_CONCURRENT=5

   # .env.docker 更新
   CECELIA_MAX_CONCURRENT=5
   移除 MAX_CONCURRENT_TASKS（废弃）
   ```

2. **合并 .env.example**
   ```bash
   cat .env.example brain/.env.example > .env.example.new
   mv .env.example.new .env.example
   rm brain/.env.example
   ```

3. **更新文档**
   - README.md：快速开始改为手动启动
   - DOCKER.md：添加"可选部署方式"标题

4. **重启服务**
   ```bash
   pkill -f "node server.js"
   cd brain && node server.js &
   ```

5. **验证**
   ```bash
   curl -s http://localhost:5221/api/brain/tick/status | jq .max_concurrent
   # 预期输出: 5
   ```

## 验收清单

### 配置正确

- [ ] `.env` 包含 `CECELIA_MAX_CONCURRENT=5`
- [ ] `.env` 包含 `MAX_CONCURRENT=5`
- [ ] `.env.docker` 配置一致
- [ ] `.env.example` 完整且统一
- [ ] `brain/.env.example` 已删除

### 功能正常

- [ ] Brain 读取并发配置为 5
- [ ] 能同时运行 5 个任务
- [ ] 资源监控正常工作
- [ ] Circuit Breaker 正常

### 文档准确

- [ ] README.md 启动方式准确
- [ ] DOCKER.md 标记为可选
- [ ] 快速开始指南清晰

### 性能达标

- [ ] CPU Load < 6.4（5 个任务时）
- [ ] 可用内存 > 3GB（5 个任务时）
- [ ] 任务成功率 100%

## 风险和缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 5 个并发资源不足 | 低 | 中 | 保留 3 的配置，随时可回滚 |
| 配置错误导致服务崩溃 | 低 | 高 | 先在 .env 测试，确认后再更新 .env.docker |
| 文档更新不完整 | 中 | 低 | Code review 时仔细检查 |
| 现有任务中断 | 低 | 中 | 重启服务时确保无运行中任务 |

## 下一步

完成后考虑：
1. 添加动态并发调整（根据实时负载）
2. 添加资源监控 Dashboard（Grafana）
3. 实现自动扩缩容（Kubernetes）
