---
id: observability-v1.1-implementation
version: 1.1.0
created: 2026-02-12
updated: 2026-02-12
changelog:
  - 1.1.0: å‡çº§ç‰ˆæœ¬ - åŸºäºå·¥ç¨‹çº§å®¡é˜…çš„ 5 æ¡å…³é”®æ”¹è¿›
---

# Cecelia Core å¯è§‚æµ‹æ€§ v1.1 å®æ–½æ–‡æ¡£

## åŸºäºå·¥ç¨‹å®¡é˜…çš„æ”¹è¿›

æœ¬æ–‡æ¡£æ˜¯ v1.0 æ–¹æ¡ˆçš„å‡çº§ç‰ˆï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®æ”¹è¿›ï¼š

### P0 å¿…æ”¹ï¼ˆ5æ¡ï¼‰

1. âœ… **æ˜ç¡® task_id/run_id/span_id å…³ç³» + ç´¢å¼•**
   - task_id: ä¸šåŠ¡ä»»åŠ¡ï¼ˆtasks è¡¨ï¼‰
   - run_id: ä¸€æ¬¡æ‰§è¡Œå°è¯•ï¼ˆä¸€ä¸ª task å¯ä»¥å¤šæ¬¡ runï¼‰
   - span_id: ä¸€ä¸ª run çš„ä¸€ä¸ªæ­¥éª¤
   - å»ºç«‹å¤åˆç´¢å¼•ï¼š`idx_run_events_task_run`

2. âœ… **å¢åŠ  executor_host/agent/attempt/reason_kind å­—æ®µ**
   - executor_host: æ‰§è¡Œæœºå™¨ï¼ˆus-vps, hk-vps, mac-mini, node-pcï¼‰
   - agent: æ‰§è¡Œä»£ç†ï¼ˆcaramel, nobel, qa, auditï¼‰
   - attempt: é‡è¯•æ¬¡æ•°ï¼ˆ1=é¦–æ¬¡ï¼Œ2=ç¬¬ä¸€æ¬¡é‡è¯•ï¼‰
   - reason_kind: å¤±è´¥åˆ†ç±»ï¼ˆTRANSIENT/PERSISTENT/RESOURCE/CONFIGï¼‰

3. âœ… **artifacts æ”¹ä¸º artifact_id + åç«¯ä»£ç†**
   - æ–°è¡¨ï¼š`run_artifacts` å­˜å‚¨å…ƒæ•°æ®
   - artifacts å­—æ®µå­˜ artifact_idï¼Œä¸å­˜è·¯å¾„
   - åç«¯ç«¯ç‚¹ï¼š`GET /api/brain/trace/artifacts/:id` ç»Ÿä¸€ä»£ç†

4. âœ… **stuck æ£€æµ‹å‡çº§ï¼šrun çº§ + last_alive_span è§†å›¾**
   - æ–°è§†å›¾ï¼š`v_run_last_alive_span` æ‰¾æœ€åæ´»è·ƒçš„ span
   - `detect_stuck_runs()` è¿”å› last_alive_span çš„è¯¦ç»†ä¿¡æ¯

5. âœ… **GC æ”¹æˆå¤–éƒ¨è°ƒåº¦ + advisory lock é˜²å¹¶å‘**
   - åˆ é™¤ setInterval
   - æ–°å‡½æ•°ï¼š`cleanup_expired_runs(days_threshold)` ä½¿ç”¨ pg_advisory_lock
   - å¤–éƒ¨è°ƒåº¦ï¼šcron/systemd/n8n è°ƒç”¨

---

## æ–‡ä»¶æ¸…å•

### 1. Migration SQL (v1.1)

**æ–‡ä»¶**: `brain/migrations/023_add_run_events_observability_v1.1.sql`

**åŒ…å«**:
- âœ… run_events è¡¨ï¼ˆå¢å¼ºå­—æ®µï¼‰
- âœ… run_artifacts è¡¨ï¼ˆartifact å…ƒæ•°æ®ï¼‰
- âœ… v_active_runs è§†å›¾
- âœ… v_run_summary è§†å›¾ï¼ˆå¢åŠ  hosts_involvedï¼‰
- âœ… v_top_failure_reasons è§†å›¾ï¼ˆå¢åŠ  reason_kind, affected_hostsï¼‰
- âœ… v_run_last_alive_span è§†å›¾ï¼ˆæ–°å¢ï¼‰
- âœ… update_run_heartbeat() å‡½æ•°
- âœ… detect_stuck_runs() å‡½æ•°ï¼ˆå¢å¼ºç‰ˆï¼‰
- âœ… cleanup_expired_runs() å‡½æ•°ï¼ˆå¸¦ advisory lockï¼‰

**å…³é”®å­—æ®µå˜æ›´**:

```sql
-- run_events è¡¨æ–°å¢å­—æ®µ
ALTER TABLE run_events ADD COLUMN executor_host VARCHAR(100);
ALTER TABLE run_events ADD COLUMN agent VARCHAR(100);
ALTER TABLE run_events ADD COLUMN attempt INTEGER DEFAULT 1;
ALTER TABLE run_events ADD COLUMN reason_kind VARCHAR(20);

-- æ–°è¡¨ run_artifacts
CREATE TABLE run_artifacts (
    id uuid PRIMARY KEY,
    span_id uuid REFERENCES run_events(span_id),
    artifact_type VARCHAR(50),
    storage_backend VARCHAR(50),  -- local, s3, nas
    storage_key TEXT,
    content_type VARCHAR(100),
    size_bytes BIGINT,
    expires_at TIMESTAMP WITH TIME ZONE
);
```

---

### 2. Node.js SDK (v1.1)

**æ–‡ä»¶**: `brain/src/trace.js` (å®æ–½æ—¶æ›¿æ¢ä¸ºæ­¤å†…å®¹)

**åŒ…å«**:
- âœ… sanitize() - è„±æ•å‡½æ•°ï¼ˆredact secrets, truncateï¼‰
- âœ… classifyError() - è‡ªåŠ¨åˆ†ç±» reason_code + reason_kind
- âœ… storeArtifact() - å­˜å‚¨ artifact å…ƒæ•°æ®ï¼Œè¿”å› artifact_id
- âœ… withSpan() - è‡ªåŠ¨ wrapperï¼ˆåŒ…å« heartbeatï¼‰
- âœ… traceStep.start/heartbeat/end - æ‰‹åŠ¨æ§åˆ¶
- âœ… æŸ¥è¯¢å‡½æ•°ï¼šgetRunTimeline, getActiveRuns, getStuckRuns, getLastAliveSpan

**å…³é”®å®ç°**:

```javascript
// è„±æ•
const REDACT_KEYS = ['password', 'token', 'authorization', 'cookie', 'api_key', ...];
function sanitize(obj, maxDepth = 3) {
  // Redact sensitive keys
  // Truncate large values (4KB limit)
}

// é”™è¯¯åˆ†ç±»
function classifyError(error) {
  // TRANSIENT: timeout, network, deadlock
  // PERSISTENT: missing_file, selector_not_found
  // RESOURCE: out_of_memory, out_of_disk
  // CONFIG: permission, auth_expired
  return { reason_code, reason_kind };
}

// Artifact å­˜å‚¨
async function storeArtifact(span_id, artifact_type, file_path, content_type) {
  const artifact_id = uuidv4();
  // æ£€æµ‹ storage_backend: local/s3/nas
  // å­˜å‚¨åˆ° run_artifacts è¡¨
  // è¿”å› artifact_id
}

// è‡ªåŠ¨ wrapper
await withSpan({
  run_id,
  task_id,
  layer: 'L2_executor',
  step_name: 'upload_file',
  agent: 'caramel',
  attempt: 1
}, async (span) => {
  span.setInput({ file: 'video.mp4' });
  const result = await doWork();
  await span.addArtifact('screenshot', '/tmp/upload.png');
  return result;
});
```

---

### 3. Brain API ç«¯ç‚¹ (v1.1)

**æ–‡ä»¶**: `brain/src/routes/trace.js` (æ–°å»º)

**ç«¯ç‚¹æ¸…å•**:

| ç«¯ç‚¹ | æ–¹æ³• | ç”¨é€” | v1.1 å¢å¼º |
|------|------|------|----------|
| `/api/brain/trace/runs/active` | GET | å½“å‰è¿è¡Œä¸­çš„ runs | âœ… å¢åŠ  executor_host, agent |
| `/api/brain/trace/runs/:run_id` | GET | å•ä¸ª run çš„å®Œæ•´æ—¶é—´çº¿ | âœ… å¢åŠ  attempt, reason_kind |
| `/api/brain/trace/runs/:run_id/summary` | GET | run æ±‡æ€»ç»Ÿè®¡ | âœ… å¢åŠ  hosts_involved |
| `/api/brain/trace/runs/:run_id/last-alive` | GET | æœ€åæ´»è·ƒçš„ span | âœ… æ–°å¢ç«¯ç‚¹ |
| `/api/brain/trace/runs/:run_id/graph` | GET | èŠ‚ç‚¹å›¾æ•°æ®ï¼ˆD3.jsï¼‰ | âœ… åç«¯å¸ƒå±€ x/y |
| `/api/brain/trace/failures/top` | GET | æœ€å¸¸è§å¤±è´¥åŸå›  | âœ… å¢åŠ  reason_kind, affected_hosts |
| `/api/brain/trace/stuck` | GET | å¡æ­»çš„ runs | âœ… è¿”å› last_alive_span è¯¦æƒ… |
| `/api/brain/trace/artifacts/:id` | GET | ä¸‹è½½/ä»£ç† artifact | âœ… æ–°å¢ç«¯ç‚¹ |

**ç¤ºä¾‹å®ç°**:

```javascript
// GET /api/brain/trace/runs/:run_id/last-alive
router.get('/runs/:run_id/last-alive', async (req, res) => {
  const { run_id } = req.params;
  const lastAlive = await getLastAliveSpan(run_id);

  if (!lastAlive) {
    return res.status(404).json({ error: 'Run not found' });
  }

  res.json({
    run_id,
    last_alive_span: {
      span_id: lastAlive.span_id,
      layer: lastAlive.layer,
      step_name: lastAlive.step_name,
      status: lastAlive.status,
      executor_host: lastAlive.executor_host,
      seconds_since_activity: lastAlive.seconds_since_activity,
      is_stuck: lastAlive.seconds_since_activity > 300,
      input_summary: lastAlive.input_summary,
      artifacts: lastAlive.artifacts
    }
  });
});

// GET /api/brain/trace/artifacts/:id (ä»£ç†ä¸‹è½½)
router.get('/artifacts/:id', async (req, res) => {
  const { id } = req.params;
  const artifact = await getArtifactMetadata(id);

  if (!artifact) {
    return res.status(404).json({ error: 'Artifact not found' });
  }

  // æ£€æŸ¥è¿‡æœŸ
  if (artifact.expires_at && new Date(artifact.expires_at) < new Date()) {
    return res.status(410).json({ error: 'Artifact expired' });
  }

  // æ ¹æ® storage_backend ä»£ç†
  if (artifact.storage_backend === 'local') {
    res.sendFile(artifact.storage_key);
  } else if (artifact.storage_backend === 's3') {
    // ç”Ÿæˆç­¾å URL é‡å®šå‘
    const signedUrl = await generateS3SignedUrl(artifact.storage_key);
    res.redirect(signedUrl);
  } else if (artifact.storage_backend === 'nas') {
    res.sendFile(artifact.storage_key);
  }
});
```

---

### 4. Frontend Dashboard ç»„ä»¶ (v1.1)

**æ–‡ä»¶**: `workspace/apps/core/features/execution/pages/RunsOverview.tsx`

**v1.1 å¢å¼º**:

```typescript
function RunsOverview() {
  const { data: stuck } = useApi('/api/brain/trace/stuck', { pollInterval: 10000 });
  const { data: failures } = useApi('/api/brain/trace/failures/top');

  return (
    <div>
      {/* å¡æ­»ä»»åŠ¡è­¦å‘Š - æ˜¾ç¤º last_alive_span */}
      {stuck && stuck.length > 0 && (
        <Alert variant="warning">
          <h3>âš ï¸ å¡æ­»ä»»åŠ¡ï¼ˆ{stuck.length}ï¼‰</h3>
          {stuck.map(s => (
            <div key={s.run_id}>
              <Link to={`/trace/runs/${s.run_id}`}>
                <strong>{s.layer}</strong> &gt; {s.step_name}
              </Link>
              <div className="text-sm text-gray-500">
                æœºå™¨: {s.executor_host} |
                å¡äº†: {Math.floor(s.stuck_duration_seconds / 60)} åˆ†é’Ÿ |
                <a href={`/api/brain/trace/artifacts/${s.artifacts?.screenshot_id}`}>
                  ğŸ“¸ æˆªå›¾
                </a>
              </div>
            </div>
          ))}
        </Alert>
      )}

      {/* å¤±è´¥åŸå› ç»Ÿè®¡ - æŒ‰ reason_kind åˆ†ç»„ */}
      <div className="grid grid-cols-4 gap-4">
        {['TRANSIENT', 'PERSISTENT', 'RESOURCE', 'CONFIG'].map(kind => {
          const kindFailures = failures?.filter(f => f.reason_kind === kind) || [];
          const total = kindFailures.reduce((sum, f) => sum + f.failure_count, 0);

          return (
            <div key={kind} className={`p-4 rounded border ${kindColors[kind]}`}>
              <h4>{kind}</h4>
              <div className="text-2xl font-bold">{total}</div>
              <ul className="text-sm mt-2">
                {kindFailures.slice(0, 3).map(f => (
                  <li key={f.reason_code}>
                    {f.reason_code} ({f.failure_count})
                  </li>
                ))}
              </ul>
              {kind === 'TRANSIENT' && total > 0 && (
                <button onClick={() => retryTransient()}>
                  ğŸ”„ è‡ªåŠ¨é‡è¯•
                </button>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}

const kindColors = {
  TRANSIENT: 'bg-yellow-50 border-yellow-200',
  PERSISTENT: 'bg-red-50 border-red-200',
  RESOURCE: 'bg-orange-50 border-orange-200',
  CONFIG: 'bg-blue-50 border-blue-200'
};
```

**æ–‡ä»¶**: `workspace/apps/core/features/execution/pages/RunDetailPage.tsx`

**v1.1 å¢å¼º**:

```typescript
function RunDetailPage() {
  const { run_id } = useParams();
  const { data: timeline } = useApi(`/api/brain/trace/runs/${run_id}`);
  const { data: lastAlive } = useApi(`/api/brain/trace/runs/${run_id}/last-alive`);

  // æ—¶é—´çº¿å¼ºåˆ¶æ’åºï¼ˆä¿®å¤ bugï¼‰
  const sortedTimeline = timeline?.sort((a, b) =>
    new Date(a.heartbeat_ts || a.ts_start) - new Date(b.heartbeat_ts || b.ts_start)
  );

  return (
    <div>
      {/* Last Alive Span é«˜äº® */}
      {lastAlive && lastAlive.is_stuck && (
        <Alert variant="error">
          <h3>ğŸ”´ ä»»åŠ¡å¡åœ¨è¿™é‡Œï¼š</h3>
          <div className="font-mono">
            {lastAlive.layer} &gt; {lastAlive.step_name}
          </div>
          <div className="text-sm mt-2">
            æœºå™¨: {lastAlive.executor_host} |
            å¡äº†: {Math.floor(lastAlive.seconds_since_activity / 60)} åˆ†é’Ÿ
          </div>

          {/* è¾“å…¥å‚æ•° */}
          {lastAlive.input_summary && (
            <details>
              <summary>è¾“å…¥å‚æ•°</summary>
              <pre>{JSON.stringify(lastAlive.input_summary, null, 2)}</pre>
            </details>
          )}

          {/* Artifacts */}
          {lastAlive.artifacts && (
            <div className="flex gap-2 mt-2">
              {Object.entries(lastAlive.artifacts).map(([key, artifact_id]) => (
                <a
                  key={key}
                  href={`/api/brain/trace/artifacts/${artifact_id}`}
                  target="_blank"
                  className="btn btn-sm"
                >
                  ğŸ“ {key.replace('_id', '')}
                </a>
              ))}
            </div>
          )}
        </Alert>
      )}

      {/* Timeline */}
      <RunTimeline timeline={sortedTimeline} lastAliveSpanId={lastAlive?.span_id} />
    </div>
  );
}

function RunTimeline({ timeline, lastAliveSpanId }) {
  return (
    <div className="space-y-4">
      {timeline?.map((span) => {
        const isLastAlive = span.span_id === lastAliveSpanId;

        return (
          <div
            key={span.span_id}
            className={`border-l-4 pl-4 py-2 ${
              isLastAlive ? 'border-red-500 bg-red-50' : 'border-gray-300'
            }`}
          >
            {isLastAlive && (
              <div className="text-red-700 font-semibold mb-1">
                ğŸ”´ æœ€åæ´»è·ƒæ­¥éª¤ï¼ˆå¯èƒ½å¡åœ¨è¿™é‡Œï¼‰
              </div>
            )}

            <div className="flex justify-between">
              <div>
                <span className="font-mono text-xs text-gray-500">
                  {span.layer} @ {span.executor_host}
                </span>
                <div className="font-semibold">{span.step_name}</div>
                {span.attempt > 1 && (
                  <span className="text-xs bg-yellow-100 px-1 rounded">
                    é‡è¯• #{span.attempt}
                  </span>
                )}
              </div>

              <div>
                <StatusBadge status={span.status} />
                {span.reason_code && (
                  <span className={`ml-2 text-xs px-2 py-1 rounded ${
                    reasonKindColors[span.reason_kind]
                  }`}>
                    {span.reason_code}
                  </span>
                )}
              </div>
            </div>

            {/* Artifacts */}
            {span.artifacts && (
              <div className="flex gap-2 mt-2">
                {Object.entries(span.artifacts).map(([key, artifact_id]) => (
                  <a
                    key={key}
                    href={`/api/brain/trace/artifacts/${artifact_id}`}
                    target="_blank"
                    className="text-xs bg-blue-100 px-2 py-1 rounded hover:bg-blue-200"
                  >
                    ğŸ“ {key.replace('_id', '')}
                  </a>
                ))}
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
}

const reasonKindColors = {
  TRANSIENT: 'bg-yellow-100 text-yellow-800',
  PERSISTENT: 'bg-red-100 text-red-800',
  RESOURCE: 'bg-orange-100 text-orange-800',
  CONFIG: 'bg-blue-100 text-blue-800',
  UNKNOWN: 'bg-gray-100 text-gray-800'
};
```

---

## GC å¤–éƒ¨è°ƒåº¦ï¼ˆv1.1ï¼‰

### æ–¹æ¡ˆ 1: Systemd Timer (æ¨èç”¨äº Linux VPS)

**æ–‡ä»¶**: `/etc/systemd/system/cecelia-gc-runs.service`

```ini
[Unit]
Description=Cecelia Run Events Garbage Collection
After=postgresql.service

[Service]
Type=oneshot
User=cecelia
WorkingDirectory=/opt/cecelia/core
ExecStart=/usr/bin/node /opt/cecelia/core/brain/scripts/gc-runs.js
StandardOutput=journal
StandardError=journal
```

**æ–‡ä»¶**: `/etc/systemd/system/cecelia-gc-runs.timer`

```ini
[Unit]
Description=Run Cecelia GC daily at 3am

[Timer]
OnCalendar=daily
OnCalendar=*-*-* 03:00:00
Persistent=true

[Install]
WantedBy=timers.target
```

**å¯ç”¨**:

```bash
sudo systemctl enable cecelia-gc-runs.timer
sudo systemctl start cecelia-gc-runs.timer
sudo systemctl list-timers  # æŸ¥çœ‹
```

### æ–¹æ¡ˆ 2: Cron (ä¼ ç»Ÿæ–¹å¼)

```bash
# /etc/cron.d/cecelia-gc
0 3 * * * cecelia cd /opt/cecelia/core && /usr/bin/node brain/scripts/gc-runs.js >> /var/log/cecelia/gc.log 2>&1
```

### æ–¹æ¡ˆ 3: N8N Workflow (å·²æœ‰ N8N çš„è¯)

```javascript
// N8N Cron Node (æ¯å¤© 3am)
// â†’ Execute Command Node
{
  "command": "cd /opt/cecelia/core && node brain/scripts/gc-runs.js",
  "cwd": "/opt/cecelia/core"
}
```

### GC è„šæœ¬å®ç°

**æ–‡ä»¶**: `brain/scripts/gc-runs.js`

```javascript
#!/usr/bin/env node
import db from '../src/db.js';

async function main() {
  console.log('[GC] Starting run_events cleanup...');

  try {
    const result = await db.query(`SELECT * FROM cleanup_expired_runs(7)`);

    if (result.rows.length === 0) {
      console.log('[GC] No expired runs to clean');
      return;
    }

    console.log(`[GC] Marked ${result.rows.length} runs for cleanup:`);
    for (const run of result.rows) {
      console.log(`  - ${run.run_id} (${run.total_spans} spans, ended ${run.run_end})`);
    }

    // å¯é€‰ï¼šåˆ é™¤ artifacts æ–‡ä»¶
    // for (const run of result.rows) {
    //   await cleanupArtifacts(run.run_id);
    // }

  } catch (err) {
    console.error('[GC] Error:', err.message);
    process.exit(1);
  } finally {
    await db.end();
  }
}

main();
```

---

## v1.0 â†’ v1.1 å‡çº§æ£€æŸ¥æ¸…å•

### æ•°æ®åº“å±‚

- [ ] æ‰§è¡Œ migration 023 v1.1
- [ ] éªŒè¯è¡¨åˆ›å»ºï¼š`\d run_events`, `\d run_artifacts`
- [ ] éªŒè¯è§†å›¾ï¼š`SELECT * FROM v_run_last_alive_span LIMIT 1`
- [ ] éªŒè¯å‡½æ•°ï¼š`SELECT * FROM detect_stuck_runs()`
- [ ] æµ‹è¯• advisory lockï¼š`SELECT pg_try_advisory_lock(hashtext('test'))`

### SDK å±‚

- [ ] æ›¿æ¢ `brain/src/trace.js` ä¸º v1.1 ç‰ˆæœ¬
- [ ] æ·»åŠ  uuid ä¾èµ–ï¼š`npm install uuid` (å¦‚æœæ²¡æœ‰)
- [ ] æµ‹è¯• sanitizeï¼š`sanitize({ password: '123', normal: 'ok' })`
- [ ] æµ‹è¯• classifyErrorï¼š`classifyError(new Error('timeout'))`
- [ ] æµ‹è¯• storeArtifactï¼š`await storeArtifact(span_id, 'screenshot', '/tmp/test.png')`

### API å±‚

- [ ] åˆ›å»º `brain/src/routes/trace.js`
- [ ] åœ¨ `brain/src/server.js` ä¸­å¼•å…¥ï¼š`app.use('/api/brain/trace', traceRouter)`
- [ ] æµ‹è¯•ç«¯ç‚¹ï¼š`curl localhost:5221/api/brain/trace/runs/active`
- [ ] æµ‹è¯• artifact ä»£ç†ï¼š`curl localhost:5221/api/brain/trace/artifacts/{id}`

### Frontend å±‚

- [ ] åˆ›å»º `RunsOverview.tsx` (v1.1)
- [ ] æ›´æ–° `RunDetailPage.tsx` (v1.1)
- [ ] æ·»åŠ  reason_kind é¢œè‰²é…ç½®
- [ ] æµ‹è¯•"å¡æ­»è­¦å‘Š"æ˜¾ç¤º
- [ ] æµ‹è¯• artifact é“¾æ¥ç‚¹å‡»

### GC è°ƒåº¦

- [ ] åˆ›å»º `brain/scripts/gc-runs.js`
- [ ] é€‰æ‹©è°ƒåº¦æ–¹å¼ï¼ˆsystemd/cron/n8nï¼‰
- [ ] é…ç½®è°ƒåº¦
- [ ] æµ‹è¯•æ‰‹åŠ¨è¿è¡Œï¼š`node brain/scripts/gc-runs.js`
- [ ] éªŒè¯ advisory lock ç”Ÿæ•ˆï¼ˆå¹¶å‘è¿è¡Œä¸å†²çªï¼‰

---

## æœ€çŸ­å®æ–½è·¯å¾„ï¼ˆDay 1-5ï¼‰

### Day 1ï¼ˆå¿…æˆï¼‰- æ•°æ®åŸºç¡€

- [ ] æ‰§è¡Œ migration 023 v1.1
- [ ] æ›¿æ¢ trace.js ä¸º v1.1
- [ ] æ”¹é€  executor.jsï¼šdispatch æ—¶è°ƒç”¨ withSpan()
- [ ] éªŒè¯ï¼šæ•°æ®åº“æœ‰ run_events è®°å½•

**éªŒè¯æ ‡å‡†**ï¼š
```bash
# æ‰‹åŠ¨ dispatch ä¸€ä¸ªä»»åŠ¡
curl -X POST localhost:5221/api/brain/tick

# æŸ¥è¯¢ run_events
psql -U cecelia -d cecelia -c "SELECT run_id, layer, step_name, status FROM run_events LIMIT 5"
```

### Day 2ï¼ˆç«‹åˆ»è§æ•ˆï¼‰- API + Dashboard

- [ ] åˆ›å»º trace.js routes
- [ ] é›†æˆåˆ° server.js
- [ ] Dashboard æ·»åŠ  RunsOverview (ç®€å•ç‰ˆ)
- [ ] æµ‹è¯•"å¡æ­»è­¦å‘Š"æ˜¾ç¤º

**éªŒè¯æ ‡å‡†**ï¼š
- Dashboard ä¸Šèƒ½çœ‹åˆ°è¿è¡Œä¸­çš„ runs
- èƒ½çœ‹åˆ° last_alive_span è¯¦æƒ…
- ç‚¹å‡»å¯ä»¥è¿›å…¥ run è¯¦æƒ…é¡µ

### Day 3ï¼ˆä½“éªŒæå‡ï¼‰- èŠ‚ç‚¹å›¾ + Artifacts

- [ ] æ·»åŠ  ReactFlow ä¾èµ–
- [ ] å®ç°èŠ‚ç‚¹å›¾å¸ƒå±€ï¼ˆåç«¯ dagre æˆ–å‰ç«¯ auto-layoutï¼‰
- [ ] å®ç° artifact ä»£ç†ç«¯ç‚¹
- [ ] æµ‹è¯•æˆªå›¾/æ—¥å¿—ä¸‹è½½

**éªŒè¯æ ‡å‡†**ï¼š
- Run è¯¦æƒ…é¡µèƒ½çœ‹åˆ°èŠ‚ç‚¹å›¾
- ç‚¹å‡» artifact é“¾æ¥èƒ½ä¸‹è½½æ–‡ä»¶

### Day 4-5ï¼ˆé˜²è…ï¼‰- GC + è‡ªåŠ¨é‡è¯•

- [ ] åˆ›å»º gc-runs.js
- [ ] é…ç½®å¤–éƒ¨è°ƒåº¦ï¼ˆsystemd/cronï¼‰
- [ ] æµ‹è¯• advisory lock
- [ ] å®ç°è‡ªåŠ¨é‡è¯•ç­–ç•¥ï¼ˆæŒ‰ reason_kindï¼‰

**éªŒè¯æ ‡å‡†**ï¼š
- GC è„šæœ¬æ¯å¤©è¿è¡Œ
- 7å¤©å‰çš„ runs è¢«æ ‡è®° gc_at
- TRANSIENT å¤±è´¥è‡ªåŠ¨é‡è¯•

---

## å…³é”®å·®å¼‚å¯¹æ¯”ï¼šv1.0 vs v1.1

| ç»´åº¦ | v1.0 | v1.1 | æ”¹è¿› |
|------|------|------|------|
| **task/run/span å…³ç³»** | æ¨¡ç³Š | æ˜ç¡® + ç´¢å¼• | å¯ä»¥æŒ‰ task æŸ¥æ‰€æœ‰ runs |
| **æ‰§è¡Œæœºå™¨è¿½è¸ª** | æ—  | executor_host å­—æ®µ | çŸ¥é“åœ¨å“ªå°æœºå™¨è·‘ |
| **å¤±è´¥åŸå› åˆ†ç±»** | reason_code | reason_code + reason_kind | è‡ªåŠ¨/æ‰‹åŠ¨ä¿®å¤å†³ç­– |
| **Artifacts** | å­˜è·¯å¾„ | å­˜ artifact_id + ä»£ç† | è·¨æœºå™¨å¯è®¿é—® |
| **å¡æ­»æ£€æµ‹** | 5min æ— å¿ƒè·³ | last_alive_span è¯¦æƒ… | çŸ¥é“å¡åœ¨å“ªä¸ª span |
| **GC è°ƒåº¦** | setInterval | å¤–éƒ¨ + advisory lock | ç”Ÿäº§å¯é  |
| **è„±æ•** | æ—  | redactKeys + æˆªæ–­ | å®‰å…¨ |
| **é‡è¯•è¿½è¸ª** | æ—  | attempt å­—æ®µ | çŸ¥é“ç¬¬å‡ æ¬¡é‡è¯• |

---

## æ€»ç»“

v1.1 ç›¸æ¯” v1.0 çš„æ ¸å¿ƒæå‡ï¼š

**ä»"èƒ½ç”¨"åˆ°"ä¸ä¼šçƒ‚"**ï¼š
- âœ… æ•°æ®æ¨¡å‹æ¸…æ™°ï¼ˆtask/run/spanï¼‰
- âœ… å¤šæœºè¿½è¸ªï¼ˆexecutor_hostï¼‰
- âœ… å¤±è´¥åˆ†ç±»ï¼ˆreason_kindï¼‰
- âœ… å®‰å…¨å¯é ï¼ˆè„±æ• + GC lockï¼‰
- âœ… ç²¾å‡†å®šä½ï¼ˆlast_alive_spanï¼‰

**å®æ–½æˆæœ¬**ï¼š5å¤©ï¼ˆä¸ v1.0 ç›¸åŒï¼‰
**é¢å¤–æ”¶ç›Š**ï¼šé˜²æ­¢æ•°æ®è…çƒ‚ã€æ”¯æŒå¤šæœºéƒ¨ç½²ã€è‡ªåŠ¨é‡è¯•å†³ç­–
