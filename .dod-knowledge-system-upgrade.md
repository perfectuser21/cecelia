---
id: dod-knowledge-system-upgrade
version: 1.0.0
created: 2026-02-26
updated: 2026-02-26
changelog:
  - 1.0.0: 初始版本
---

# DoD: 知识系统全面升级

## 验收清单

### F1: 垃圾清理 + Learnings 去重
- [ ] Migration 081 归档 888 条重复 failure_pattern learnings
  - Test: migration 文件存在，SQL 语法正确
- [ ] learning.js recordLearning() 插入前计算 content_hash，重复时更新 version
  - Test: 相同 title+content 调用两次，只有 1 条记录（version=2）
- [ ] chat-action-dispatcher LEARN case 同样启用 content_hash 去重
  - Test: 相同学习内容插入两次不产生重复
- [ ] selfcheck.js EXPECTED_SCHEMA_VERSION = '081'
  - Test: selfcheck 测试文件同步更新

### F2: 反刍升级 — Opus + 批量
- [ ] model-registry.js rumination agent: recommended_model = claude-opus-4-6
  - Test: getAgentById('rumination').recommended_model === 'claude-opus-4-6'
- [ ] rumination.js 批量消化：取多条相似 learnings 一起处理
  - Test: digestLearnings 接收 3 条 learnings，生成 1 个综合洞察
- [ ] 反刍 Prompt 重写：深度思考模式
  - Test: buildRuminationPrompt 输出包含"模式发现"和"关联分析"
- [ ] DAILY_BUDGET = 20, MAX_PER_TICK = 5
  - Test: 常量值正确

### F3: memory_stream 去重
- [ ] reflection.js 取记忆前做 Jaccard 去重
  - Test: 50 条含 40 条重复的记忆，去重后 ≤15 条

### F4: 欲望多样性
- [ ] desire-formation.js prompt 增强：celebrate/propose 类型
  - Test: prompt 包含 celebrate 和 propose 的触发条件说明
- [ ] perception.js 新增 task_milestone 信号
  - Test: 完成率 > 80% 时产生 milestone 信号

### F5: 聊天异步研究流
- [ ] LEARN 意图异步处理：前台秒回 + 后台 NotebookLM 研究
  - Test: LEARN 执行后返回即时确认，后台 addSource 被调用
- [ ] 研究完成后写入 memory_stream（importance=7, long 类型）
  - Test: 研究结果写入 memory_stream

### 版本同步
- [ ] packages/brain/package.json version bump（minor）
- [ ] .brain-versions 同步
- [ ] DEFINITION.md schema version 同步
