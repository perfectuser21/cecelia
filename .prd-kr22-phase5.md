---
id: prd-kr22-phase5
version: 1.0.0
created: 2026-02-06
updated: 2026-02-06
changelog:
  - 1.0.0: Initial PRD for KR2.2 Phase 5
---

# PRD - KR2.2 Phase 5: 平台扩展与 E2E 测试

## 需求来源

**任务来源**: Brain 自动调度
**任务类型**: dev
**所属项目**: KR2.2 统一发布引擎
**Phase**: Phase 5 - 扩展和优化 (第 5 阶段，共 5 个阶段)

## 背景

根据 KR2.2 实现工作流 (docs/workflows/KR22_IMPLEMENTATION_WORKFLOW.md)，Phase 5 是最后一个阶段，专注于：
1. 扩展更多平台支持（小红书、微博）
2. 增强系统稳定性（死信队列）
3. 完善测试和部署流程（E2E 测试、部署自动化）

**前置条件**: Phase 1-4 已完成
- ✅ Phase 1: 数据库基础
- ✅ Phase 2: 接口实现（DouyinAdapter）
- ✅ Phase 3: API 层和任务队列
- ✅ Phase 4: 测试和监控

## 目标项目

**实现位置**: `/home/xx/dev/zenithjoy-autopilot`
**当前位置**: `cecelia-core` (worktree - 仅用于规划和协调)

**决策**: 本任务在 cecelia-core 创建**实施计划文档**，实际代码实现在后续任务中在 zenithjoy-autopilot 完成。

## 功能描述

Phase 5 包含 5 个子任务:

### Task 5.1: 小红书 Adapter 实现

实现 XiaohongshuAdapter，支持小红书平台的内容发布。

**核心功能**:
- 继承 PlatformAdapter 基类
- 实现小红书登录和鉴权
- 实现内容发布接口（图文、视频）
- 实现发布状态查询
- 错误处理和重试逻辑

**技术要点**:
- 使用小红书开放平台 API 或 Web 自动化
- 处理小红书特有的内容审核机制
- 支持多账号管理

### Task 5.2: 微博 Adapter 实现

实现 WeiboAdapter，支持微博平台的内容发布。

**核心功能**:
- 继承 PlatformAdapter 基类
- 实现微博登录和鉴权
- 实现微博发布接口（文字、图片、视频）
- 实现发布状态查询
- 错误处理和重试逻辑

**技术要点**:
- 使用微博开放平台 API
- 处理微博字数限制和内容格式
- 支持多账号管理

### Task 5.3: 死信队列 (Dead Letter Queue) 实现

实现死信队列机制，处理多次重试后仍失败的任务。

**核心功能**:
- 配置 BullMQ 死信队列
- 失败任务自动进入 DLQ
- DLQ 任务监控和告警
- 手动重试接口
- 失败原因分析和统计

**技术要点**:
- 使用 BullMQ 的内置 DLQ 功能
- 定义死信规则（重试次数、失败类型）
- 集成 Prometheus 监控

### Task 5.4: E2E 测试

编写端到端测试，覆盖完整的发布流程。

**测试场景**:
- 单平台发布（抖音、小红书、微博）
- 多平台同时发布
- 失败重试流程
- 死信队列流程
- 账号切换和管理
- 并发发布

**技术选型**:
- 使用 Playwright 或 Jest 进行 E2E 测试
- Mock 平台 API 响应
- 测试数据隔离

**验收标准**:
- E2E 测试覆盖率 > 80%
- 所有核心流程有测试用例
- CI/CD 集成，自动运行

### Task 5.5: 部署自动化

完善部署流程，支持一键部署到生产环境。

**部署内容**:
- 数据库迁移脚本
- 应用代码部署
- 依赖安装和配置
- 服务重启和健康检查
- 回滚机制

**技术实现**:
- 使用 deploy.sh 脚本（符合 CLAUDE.md 规范）
- Tailscale + rsync 同步代码
- 自动备份和回滚
- 部署后健康检查

## 涉及文件

### 在 cecelia-core 创建（本次任务）

```
cecelia-core/
├── docs/
│   └── planning/
│       └── KR22_PHASE5_IMPLEMENTATION_PLAN.md  # Phase 5 详细实施计划
```

### 在 zenithjoy-autopilot 实现（后续任务）

```
zenithjoy-autopilot/
├── src/
│   ├── adapters/
│   │   ├── XiaohongshuAdapter.ts  # 小红书 Adapter
│   │   └── WeiboAdapter.ts        # 微博 Adapter
│   ├── queue/
│   │   └── deadLetterQueue.ts     # 死信队列配置
│   └── config/
│       └── platforms.ts           # 平台配置（新增小红书、微博）
├── tests/
│   └── e2e/
│       ├── publish-flow.test.ts   # E2E 测试：发布流程
│       ├── retry-flow.test.ts     # E2E 测试：重试流程
│       └── dlq-flow.test.ts       # E2E 测试：死信队列流程
└── deploy/
    └── deploy.sh                  # 部署脚本
```

## 成功标准 (DoD)

### Task 5.1: 小红书 Adapter
- [ ] XiaohongshuAdapter 实现所有 PlatformAdapter 接口方法
- [ ] 支持图文和视频发布
- [ ] 登录和鉴权功能正常
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过

### Task 5.2: 微博 Adapter
- [ ] WeiboAdapter 实现所有 PlatformAdapter 接口方法
- [ ] 支持文字、图片、视频发布
- [ ] 登录和鉴权功能正常
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过

### Task 5.3: 死信队列
- [ ] BullMQ 死信队列配置完成
- [ ] 失败任务自动进入 DLQ
- [ ] DLQ 监控和告警功能正常
- [ ] 手动重试接口可用
- [ ] 失败统计和分析功能完整

### Task 5.4: E2E 测试
- [ ] E2E 测试覆盖率 > 80%
- [ ] 所有核心场景有测试用例
- [ ] 测试在 CI/CD 中自动运行
- [ ] 测试报告清晰易读

### Task 5.5: 部署自动化
- [ ] deploy.sh 脚本完成
- [ ] 支持备份和回滚
- [ ] 部署后健康检查通过
- [ ] 部署文档完整

### 整体验收
- [ ] 小红书、微博发布成功率 > 95%
- [ ] 死信队列正常工作
- [ ] E2E 测试全部通过
- [ ] 部署流程一键完成
- [ ] 所有代码通过 Audit（L1+L2=0）

## 技术约束

### 平台 Adapter 规范
- 必须继承 PlatformAdapter 基类
- 实现所有抽象方法
- 错误处理统一使用 PlatformError
- 日志格式统一

### 测试规范
- 使用 Jest 作为测试框架
- E2E 测试使用 Playwright
- Mock 外部 API 调用
- 测试数据隔离

### 部署规范
- 使用 Tailscale + rsync（符合 CLAUDE.md 规范）
- 不使用 CI/CD
- 部署前自动备份
- 部署后健康检查

## 非目标 (Not in Scope)

本次任务**不包括**:
- ❌ 其他平台的 Adapter（如 B站、快手等）
- ❌ 前端 UI 改动
- ❌ 数据库 Schema 变更
- ❌ 性能优化（后续单独任务）

**本次只做**:
- ✅ 小红书、微博 Adapter 实现
- ✅ 死信队列实现
- ✅ E2E 测试编写
- ✅ 部署自动化完善

## 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 平台 API 变更 | High | 使用稳定的 API 版本，添加版本检测 |
| 鉴权方式变化 | High | 支持多种鉴权方式，快速适配 |
| E2E 测试不稳定 | Medium | 添加重试机制，Mock 外部依赖 |
| 部署失败回滚慢 | Medium | 自动备份，快速回滚脚本 |

## 实施计划

### Week 1: 小红书 Adapter
- Day 1-2: 调研小红书 API，设计实现方案
- Day 3-4: 实现 XiaohongshuAdapter
- Day 5: 单元测试和集成测试

### Week 2: 微博 Adapter
- Day 1-2: 调研微博 API，设计实现方案
- Day 3-4: 实现 WeiboAdapter
- Day 5: 单元测试和集成测试

### Week 3: 死信队列和 E2E 测试
- Day 1-2: 实现死信队列
- Day 3-5: 编写 E2E 测试

### Week 4: 部署和总结
- Day 1-2: 完善部署脚本
- Day 3-4: 整体测试和修复
- Day 5: 文档完善和总结

## 验证方式

### Adapter 验证
```bash
# 运行 Adapter 集成测试
npm test -- --grep "XiaohongshuAdapter"
npm test -- --grep "WeiboAdapter"

# 手动测试发布
curl -X POST http://localhost:5212/api/publish \
  -H "Content-Type: application/json" \
  -d '{"platform": "xiaohongshu", "content": {...}}'
```

### E2E 测试验证
```bash
# 运行 E2E 测试
npm run test:e2e

# 查看测试报告
open coverage/e2e/index.html
```

### 部署验证
```bash
# 测试部署脚本（到测试环境）
./deploy/deploy.sh test

# 部署到生产环境
./deploy/deploy.sh prod
```

## 参考资料

- **Phase 1-4 文档**: docs/workflows/KR22_IMPLEMENTATION_WORKFLOW.md
- **技术设计**: docs/research/KR22-UNIFIED-PUBLISH-ENGINE.md
- **数据库 Schema**: docs/database/KR22_PUBLISH_ENGINE_SCHEMA.md
- **部署规范**: ~/.claude/CLAUDE.md (网络架构 + 部署规范)

## 下一步

完成 Phase 5 后:
1. 发布 KR2.2 v1.0.0
2. 性能优化和压力测试
3. 监控和告警完善
4. 文档和培训

---

**PRD 状态**: Draft
**审核状态**: Pending gate:prd
**实现优先级**: P0 (KR2.2 最后阶段)
**预估工时**: 4 周
