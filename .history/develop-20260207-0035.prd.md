---
id: prd-failure-classification
version: 1.0.0
created: 2026-02-06
updated: 2026-02-06
changelog:
  - 1.0.0: 初始版本
---

# PRD: 失败分类与智能重试机制

## 需求来源

自动派发任务因 "Spending cap reached resets 11pm" 反复失败 7 次，Brain 无法识别失败类型，
盲目重试（秒失败），触发 ALERT 升级。系统需要 L0 脑干级别的确定性失败分类 + 对应应对策略。

## 功能描述

### A. 失败分类扩展 (`quarantine.js`)

将 `FAILURE_CLASS` 从 3 类（SYSTEMIC/TASK_SPECIFIC/UNKNOWN）扩展为 6 类：

| 类别 | 匹配 pattern | 应对 | Alertness |
|------|-------------|------|-----------|
| BILLING_CAP | "spending cap", "cap reached" | 解析 reset 时间 → next_run_at 定时重试 + 全局暂停派发 | 不升级 |
| RATE_LIMIT | 429, "too many requests", "overloaded" | 指数退避（2min→4min→8min），最多 3 次 | 不升级 |
| AUTH | "permission denied", "unauthorized", "invalid API key" | 不重试，通知人 | 升 EMERGENCY |
| NETWORK | ECONNREFUSED, ETIMEDOUT, socket hang up | 短延迟重试（30s→1min→2min），最多 3 次 | 连续 3 次升级 |
| RESOURCE | OOM, disk full, "no space left" | 不重试，通知人 | 升 EMERGENCY |
| TASK_ERROR | 其他（代码错误、测试失败等） | 正常失败计数，现有逻辑 | 正常计数 |

新增 `classifyFailure()` 返回结构增加 `retry_strategy` 字段。

### B. Callback 智能应对 (`routes.js`)

`/api/brain/execution-callback` 失败路径增加：
1. 从 `result.result` 或 `stderr` 提取错误信息
2. 调用 `classifyFailure()` 分类
3. 按分类执行应对：
   - BILLING_CAP → 解析 "resets Xpm" → `requeueTask()` with `next_run_at`
   - RATE_LIMIT → `requeueTask()` with 指数退避 `next_run_at`
   - AUTH/RESOURCE → 不 requeue，标记 `needs_human_review`
4. 在 payload 写入 `failure_class` + `failure_detail`

### C. Billing Cap 全局暂停 (`tick.js` + `executor.js`)

- `executor.js` 新增 `setBillingPause(resetTime)` / `getBillingPause()` / `clearBillingPause()`
- `tick.js` dispatchNextTask 前检查 billing pause：到 reset 时间前跳过派发
- Reset 时间到了自动清除 pause

### D. Alertness 不升级 (`alertness.js`)

- BILLING_CAP 和 RATE_LIMIT 类失败不计入 alertness 评分
- 在 `evaluateAndUpdate()` 中过滤这两类失败

## 涉及文件

| 文件 | 改动 |
|------|------|
| `brain/src/quarantine.js` | FAILURE_CLASS 扩展 + SYSTEMIC_PATTERNS 细分 + retry_strategy |
| `brain/src/routes.js` | execution-callback 失败路径加分类+应对 |
| `brain/src/executor.js` | billing pause 管理 (setBillingPause/getBillingPause/clearBillingPause) |
| `brain/src/tick.js` | dispatch 前检查 billing pause |
| `brain/src/alertness.js` | 过滤 BILLING_CAP/RATE_LIMIT 不升级 |
| `brain/src/__tests__/failure-classification.test.js` | **新建** 测试 |

## 不做的事

- 不改 cecelia-run（它已正确传回错误信息）
- 不改 L1 丘脑/L2 皮层逻辑（此次只加 L0 脑干的确定性分类）
- 不加 DB migration（用 payload JSONB 存分类结果）
- 不改 watchdog（它有自己的 requeueTask 逻辑）

## 成功标准

1. "Spending cap reached resets 11pm" 正确分类为 BILLING_CAP
2. BILLING_CAP 解析 reset 时间，设 next_run_at 延迟重试
3. BILLING_CAP 触发全局暂停派发，到 reset 时间自动恢复
4. RATE_LIMIT (429) 用指数退避 next_run_at
5. AUTH/RESOURCE 不重试，标记 needs_human_review
6. BILLING_CAP 和 RATE_LIMIT 不升级 alertness
7. 现有 611 测试不回归
