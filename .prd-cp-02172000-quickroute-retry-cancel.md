---
id: prd-cp-02172000-quickroute-retry-cancel
version: 1.1.0
created: 2026-02-17
updated: 2026-02-17
changelog:
  - 1.0.0: 初始版本
  - 1.1.0: 新增 routing/decisions 查询端点任务
---

# PRD: 扩展 quickRoute TASK_FAILED retry>=3 自动隔离 + 路由决策查询 API

## 背景

当前 thalamus.js quickRoute v1.47.0 TASK_FAILED 分支：
- 无复杂原因 + retry<3 → retry_task
- 有复杂原因 OR retry>=3 → return null（Sonnet）

DoD v1.1 增加：无复杂原因 + retry>=3 → cancel_task（自动隔离）

## 实现内容

修改 brain/src/thalamus.js quickRoute() TASK_FAILED 分支：在 !hasComplexReason && !retryExceeded 判断之后，新增 !hasComplexReason && retryExceeded 分支，返回 cancel_task action（task_id, reason: retry_exceeded）。

新增测试（brain/src/__tests__/thalamus.test.js）：
1. should cancel task when retry exceeded and no complex reason (retry=3)
2. should cancel task when retry=4 and no complex reason
3. should still return null for task failed with complex reason even if retry exceeded

## 验收标准

- TASK_FAILED + retry>=3 + !complex → cancel_task
- TASK_FAILED + complex_reason → null（无论 retry 次数）
- npm test 通过
- node scripts/facts-check.mjs 通过
- node scripts/devgate/check-dod-mapping.cjs 通过

## 文件

- brain/src/thalamus.js
- brain/src/__tests__/thalamus.test.js
- brain/package.json (patch bump)

---

## 任务 2: 路由决策查询 API

### 背景

thalamus.js 已通过 recordRoutingDecision() 将路由决策写入 cecelia_events 表（event_type=routing_decision），但目前无任何查询 API，导致路由决策不可观测。

### 实现内容

在 brain/src/routes.js 中新增 `GET /api/brain/routing/decisions` 端点：

**端点规格**:
```
GET /api/brain/routing/decisions
  Query params:
    - limit: 数量限制，默认 50，最大 200
    - route_type: 过滤路由类型（quick_route/llm_route/cortex_route/fallback_route）
    - event_type: 过滤事件类型
    - since: ISO 时间戳，查询该时间之后的记录
  Response: { decisions: [...], total: N }
```

**字段映射** (cecelia_events.payload JSONB):
- route_type: 路由类型
- event_type: 原始事件类型
- confidence: 置信度
- level: 唤醒级别（0/1/2）
- actions_count: 动作数量
- latency_ms: 路由耗时
- timestamp: 事件时间戳

### 验收标准

- GET /api/brain/routing/decisions 返回 200 + JSON
- 支持 limit/route_type/event_type/since 过滤
- 结果按时间倒序排列
- npm test 通过
- facts-check 通过

### 文件

- brain/src/routes.js（新增端点）
- brain/src/__tests__/routing-decisions.test.js（新增测试）
