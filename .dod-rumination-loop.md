---
id: dod-rumination-loop
version: 1.0.0
created: 2026-02-26
updated: 2026-02-26
changelog:
  - 1.0.0: 初始版本
---

## DoD - 反刍回路（Rumination Loop）

### 验收清单

- [ ] **Migration 079**: learnings 表新增 digested BOOLEAN DEFAULT false 列 + idx_learnings_undigested 索引
  - Test: `npm test -- --testPathPattern rumination` 验证 migration SQL 语法正确
- [ ] **rumination.js**: 反刍核心模块 (~150行)，包含条件检查 + 逐条消化 + 写入 memory_stream
  - Test: rumination.test.js — 条件检查（非空闲不反刍、冷却期、预算耗尽）
  - Test: rumination.test.js — 消化流程（取 learnings → callLLM → 写入 memory_stream → 标记 digested）
  - Test: rumination.test.js — 预算控制（每 tick ≤3 条，每日 ≤10 条）
  - Test: rumination.test.js — NotebookLM 降级（不可用时照常运行）
- [ ] **notebook-adapter.js**: NotebookLM CLI 松耦合适配器 (~50行)
  - Test: rumination.test.js — addSource 和 queryNotebook 的 try/catch + 超时
- [ ] **tick.js**: 步骤 10.5 插入 runRumination() 调用，在 daily review 后、desire system 前
  - Test: 通过现有 tick 测试不破坏（npm test）
- [ ] **chat-action-dispatcher.js**: LEARN case 增加 URL 检测 + digested=false + NotebookLM 异步投递
  - Test: rumination.test.js — URL 检测正则 + digested=false 写入
- [ ] **model-registry.js**: 新增 rumination agent（Haiku，brain 层）
  - Test: model-registry 现有测试不破坏
- [ ] **perception.js**: 新增 undigested_knowledge 信号
  - Test: rumination.test.js — 有未消化知识时产生信号
- [ ] **DEFINITION.md**: 更新反刍相关文档（如 facts-check 需要）
- [ ] **所有现有测试通过**: `npm test` 全部绿色
