# PRD: PR Plans API - Layer 2 工程规划层

## 背景

实现三层拆解体系（Initiative → PR Plans → Task）的第二层：**PR Plans（工程规划层）**。

当前 Cecelia 数据模型只有两层：
- Layer 1: Initiative（战略方向，features 表）
- Layer 3: Task（执行任务，tasks 表）

**缺失的 Layer 2**：PR Plans（工程规划层），负责将 Initiative 拆解为具体的 PR。

## 目标

添加 PR Plans 支持，包括：
1. 数据库表结构（迁移脚本已存在）
2. Brain API 端点（CRUD 操作）
3. 单元测试

## 需要做什么

### 1. 数据库迁移

**迁移脚本已经存在**：`brain/migrations/021_add_pr_plans_table.sql`

内容包括：
- pr_plans 表（initiative_id, project_id, title, dod, files, sequence, depends_on, complexity, status）
- tasks 表新增 pr_plan_id 字段
- 一致性约束（Task 的 project_id 必须与 PR Plan 一致）
- 辅助视图（pr_plan_full_context, initiative_pr_progress）

**本次任务需要**：
- 验证迁移脚本正确性
- 执行迁移（在测试环境）
- 更新 selfcheck.js 的 EXPECTED_SCHEMA_VERSION 从 '017' → '021'

### 2. Brain API 端点

在 `brain/src/routes.js` 添加以下端点：

#### POST /api/brain/pr-plans
创建 PR Plan

**Request Body**:
```json
{
  "initiative_id": "uuid",
  "project_id": "uuid",
  "title": "string",
  "description": "string (optional)",
  "dod": "string (required)",
  "files": ["path1", "path2"],
  "sequence": 0,
  "depends_on": ["uuid1", "uuid2"],
  "complexity": "small|medium|large",
  "estimated_hours": 2
}
```

**Response**:
```json
{
  "id": "uuid",
  "initiative_id": "uuid",
  "project_id": "uuid",
  "title": "string",
  "dod": "string",
  "status": "planning",
  "created_at": "timestamp"
}
```

#### GET /api/brain/pr-plans
查询 PR Plans

**Query Parameters**:
- `initiative_id` (optional): 按 Initiative 过滤
- `project_id` (optional): 按 Project 过滤
- `status` (optional): 按状态过滤（planning/in_progress/completed/cancelled）

**Response**:
```json
[
  {
    "id": "uuid",
    "initiative_id": "uuid",
    "project_id": "uuid",
    "title": "string",
    "dod": "string",
    "files": ["path1"],
    "sequence": 1,
    "complexity": "medium",
    "status": "planning",
    "created_at": "timestamp"
  }
]
```

#### GET /api/brain/pr-plans/:id
获取单个 PR Plan

**Response**:
```json
{
  "id": "uuid",
  "initiative_id": "uuid",
  "initiative_title": "string",
  "project_id": "uuid",
  "project_name": "string",
  "repo_path": "/path/to/repo",
  "title": "string",
  "description": "string",
  "dod": "string",
  "files": ["path1"],
  "sequence": 1,
  "depends_on": ["uuid1"],
  "complexity": "medium",
  "estimated_hours": 3,
  "status": "planning",
  "task_id": "uuid (optional)",
  "task_status": "queued (optional)"
}
```

#### PATCH /api/brain/pr-plans/:id
更新 PR Plan

**Request Body** (所有字段可选):
```json
{
  "title": "string",
  "description": "string",
  "dod": "string",
  "files": ["path1"],
  "sequence": 2,
  "depends_on": ["uuid"],
  "complexity": "large",
  "estimated_hours": 5,
  "status": "in_progress"
}
```

#### DELETE /api/brain/pr-plans/:id
删除 PR Plan

**Response**:
```json
{
  "message": "PR Plan deleted successfully"
}
```

### 3. 实现细节

#### 文件结构

创建新文件 `brain/src/api/pr-plans.js`：
```javascript
import pg from 'pg';
import { DB_CONFIG } from '../db-config.js';

const pool = new pg.Pool(DB_CONFIG);

export async function createPrPlan(req, res) {
  // 创建 PR Plan
}

export async function getPrPlans(req, res) {
  // 查询 PR Plans
}

export async function getPrPlanById(req, res) {
  // 获取单个 PR Plan（使用 pr_plan_full_context 视图）
}

export async function updatePrPlan(req, res) {
  // 更新 PR Plan
}

export async function deletePrPlan(req, res) {
  // 删除 PR Plan
}
```

在 `brain/src/routes.js` 注册路由：
```javascript
import { createPrPlan, getPrPlans, getPrPlanById, updatePrPlan, deletePrPlan } from './api/pr-plans.js';

// PR Plans API
app.post('/api/brain/pr-plans', createPrPlan);
app.get('/api/brain/pr-plans', getPrPlans);
app.get('/api/brain/pr-plans/:id', getPrPlanById);
app.patch('/api/brain/pr-plans/:id', updatePrPlan);
app.delete('/api/brain/pr-plans/:id', deletePrPlan);
```

### 4. 测试

创建 `brain/src/__tests__/pr-plans.test.js`：

测试用例：
1. **创建 PR Plan**
   - 成功创建（所有必填字段）
   - 缺少必填字段（dod）
   - initiative_id 不存在
   - project_id 不存在

2. **查询 PR Plans**
   - 查询所有
   - 按 initiative_id 过滤
   - 按 project_id 过滤
   - 按 status 过滤

3. **获取单个 PR Plan**
   - 成功获取（包含 Initiative/Project 信息）
   - ID 不存在

4. **更新 PR Plan**
   - 成功更新（部分字段）
   - 更新状态（planning → in_progress）
   - ID 不存在

5. **删除 PR Plan**
   - 成功删除
   - ID 不存在

6. **一致性约束**
   - 创建 Task 时 pr_plan_id 引用不存在的 PR Plan
   - Task 的 project_id 与 PR Plan 的 project_id 不一致
   - Task 的 initiative_id 与 PR Plan 的 initiative_id 不一致

## 验收标准

- [x] 迁移脚本 `021_add_pr_plans_table.sql` 已存在并正确
- [ ] 迁移脚本在测试数据库执行成功
- [ ] selfcheck.js 更新 EXPECTED_SCHEMA_VERSION = '021'
- [ ] `brain/src/api/pr-plans.js` 实现所有 CRUD 操作
- [ ] `brain/src/routes.js` 注册所有 PR Plans 路由
- [ ] 所有单元测试通过（至少 15 个测试用例）
- [ ] POST 创建时验证必填字段（dod）
- [ ] GET 查询支持多种过滤条件
- [ ] GET /:id 返回完整上下文（使用 pr_plan_full_context 视图）
- [ ] 一致性约束生效（Task 的 project_id 必须与 PR Plan 一致）
- [ ] API 错误处理完整（400/404/500）
- [ ] 代码符合现有风格（ESM, async/await, pg.Pool）

## 技术栈

- Node.js (ESM)
- Express.js
- PostgreSQL (pg 库)
- Vitest (测试)

## 注意事项

1. **命名一致性**：PR Plan 在代码中统一用 `pr_plan`（下划线），API 端点用 `pr-plans`（短横线）
2. **视图优先**：获取详细信息时使用 `pr_plan_full_context` 视图，避免手动 JOIN
3. **错误处理**：所有 API 端点都需要 try-catch，返回合适的 HTTP 状态码
4. **Schema 版本**：迁移后必须更新 selfcheck.js，否则健康检查会失败
5. **测试隔离**：每个测试用例独立创建测试数据，测试后清理

## 相关文件

- `brain/migrations/021_add_pr_plans_table.sql` - 数据库迁移脚本
- `brain/src/api/pr-plans.js` - PR Plans API 实现（新建）
- `brain/src/routes.js` - 路由注册
- `brain/src/__tests__/pr-plans.test.js` - 单元测试（新建）
- `brain/src/selfcheck.js` - Schema 版本检查
- `brain/docs/INITIATIVES-MIGRATION-SUMMARY.md` - 迁移文档参考
