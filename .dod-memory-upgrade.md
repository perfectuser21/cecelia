# DoD - 记忆系统升级 Phase 1: 统一记忆检索器 + Token 预算

## 验收标准

### 功能验收

- [ ] buildMemoryContext() 返回格式化 context block（包含 profile + 语义记忆 + 事件记忆）
      Test: brain/tests/memory-retriever.test.js
- [ ] Token 预算生效：返回内容 estimateTokens ≤ 800（默认）
      Test: brain/tests/memory-retriever.test.js
- [ ] 时间衰减生效：30 天前任务 score ≈ 原始 50%
      Test: brain/tests/memory-retriever.test.js
- [ ] learnings 半衰期 90 天：90 天前 learning score ≈ 原始 50%
      Test: brain/tests/memory-retriever.test.js
- [ ] goals/capabilities 不受时间衰减影响（halfLife=Infinity → decay=1）
      Test: brain/tests/memory-retriever.test.js
- [ ] 简单去重生效：Jaccard > 0.8 的候选被过滤
      Test: brain/tests/memory-retriever.test.js
- [ ] mode 参数影响 modeWeight（plan 模式 OKR 权重 1.5，debug 模式 event 权重 1.5）
      Test: brain/tests/memory-retriever.test.js
- [ ] similarity.js vectorSearch 返回 created_at 字段
      Test: brain/tests/memory-retriever.test.js
- [ ] thalamus.js 使用 buildMemoryContext 替换双注入
      Test: brain/tests/memory-retriever.test.js
- [ ] loadRecentEvents 按时间窗口过滤（execute=24h，debug=72h）
      Test: brain/tests/memory-retriever.test.js
- [ ] loadActiveProfile 返回当前 OKR 焦点（chat 模式返回空）
      Test: brain/tests/memory-retriever.test.js
- [ ] OpenAI API 不可用时 graceful fallback（不 crash）
      Test: brain/tests/memory-retriever.test.js

### 测试验收

- [ ] npm run qa 通过
      Test: contract:C2-001
