# DoD: Capacity-Aware Decomposition（SLOTS 驱动容量管控）

## 验收清单

### 核心模块
- [ ] D1: capacity.js — computeCapacity(SLOTS) 返回 project/initiative/task 各层 max + softMin
- [ ] D2: activation-scorer.js — computeActivationScore() 含 priority + aging + progress + pin + cooldown
- [ ] D3: project-activator.js — activateProjects() 从 pending 按分数激活 + deactivateExcess() 超出降级

### 集成改造
- [ ] D4: initiative-closer.js — MAX_ACTIVE_INITIATIVES 改用 capacity.js 导出值，不再硬编码
- [ ] D5: decomposition-checker.js — 每个 check (1-7) 前调用 isLayerAtCapacity()，满了跳过
- [ ] D6: tick.js — 新增 Section 调用 project-activator 和改造后的 initiative 激活

### 数据清理
- [ ] D7: migration 048 — 清理 active projects 超出 cap 的降为 pending，active initiatives 超出降为 pending

### 版本
- [ ] D8: selfcheck.js EXPECTED_SCHEMA_VERSION 047 → 048
- [ ] D9: 版本号 v1.57.1 → v1.58.0（feat: minor bump）

## Test 映射

| DoD | Test 文件 | Test 名称 |
|-----|-----------|-----------|
| D1 | capacity.test.js | computeCapacity returns correct caps for SLOTS=9 |
| D1 | capacity.test.js | computeCapacity scales with SLOTS=4 and SLOTS=20 |
| D2 | activation-scorer.test.js | P0 scores higher than P1 |
| D2 | activation-scorer.test.js | aging adds score over days |
| D2 | activation-scorer.test.js | cooldown returns -Infinity within window |
| D2 | activation-scorer.test.js | user_pinned dominates score |
| D2 | activation-scorer.test.js | progress bonus for 30-70% range |
| D3 | project-activator.test.js | activateProjects fills empty slots by score |
| D3 | project-activator.test.js | deactivateExcess pauses lowest-score projects |
| D3 | project-activator.test.js | respects cooldown on recently changed projects |
| D4 | initiative-queue.test.js | uses capacity-derived max instead of hardcoded 10 |
| D5 | decomp-capacity-gate.test.js | skips decomposition when layer at capacity |
| D5 | decomp-capacity-gate.test.js | allows decomposition when layer has room |
| D6 | tick-capacity.test.js | tick calls project activator each cycle |
| D7 | (migration verified by selfcheck) | schema version matches 048 |
| D8 | selfcheck.test.js | EXPECTED_SCHEMA_VERSION is 048 |
