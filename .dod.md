# DoD - Protective Brain Runtime

QA: docs/QA-DECISION.md

## 验收标准

### 迁移系统
- [ ] migrate.js 幂等执行所有迁移
      Test: manual:node src/migrate.js 两次，第二次全 SKIP
- [ ] schema_version 表记录 5 条迁移
      Test: manual:SELECT * FROM schema_version
- [ ] brain_config 表包含 region=us
      Test: manual:SELECT * FROM brain_config

### 启动自检
- [ ] selfcheck 6 项全部 PASS
      Test: manual:ENV_REGION=us node src/selfcheck.js
- [ ] selfcheck 单元测试 10/10 通过
      Test: brain/src/__tests__/selfcheck.test.js
- [ ] server.js 启动前执行 migrate + selfcheck
      Test: manual:重启容器观察日志

### Docker 镜像
- [ ] Dockerfile 多阶段构建成功
      Test: manual:docker build -t cecelia-brain:test ./brain
- [ ] 非 root 用户 cecelia
      Test: manual:docker run --rm cecelia-brain:test whoami
- [ ] 镜像 < 200MB
      Test: manual:docker images cecelia-brain

### Compose 分离
- [ ] docker-compose.prod.yml read_only rootfs
      Test: manual:docker exec touch /app/x 应失败
- [ ] docker-compose.yml 添加 ENV_REGION
      Test: manual:grep ENV_REGION docker-compose.yml

### 部署脚本
- [ ] brain-deploy.sh 完整流程执行
      Test: manual:bash scripts/brain-deploy.sh
- [ ] brain-rollback.sh 可回滚
      Test: manual:bash scripts/brain-rollback.sh

### 测试验收
- [ ] 不引入新测试失败
      Test: npx vitest run（selfcheck 10/10，其余无新增失败）
