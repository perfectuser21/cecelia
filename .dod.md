# Definition of Done: Cecelia Brain 架构统一大修复

## 1. 时间维度统一 ✅

- [x] DEFINITION.md 更新（Initiative = 1-2小时）
- [x] MEMORY.md 更新
- [x] brain/src/actions.js JSDoc 注释修复
- [x] brain/src/executor.js prompt 字符串修复
- Test: 搜索所有文件，确认无 "1-3小时" 或 "1-2天" 的错误描述

## 2. type='objective' 全局修复 ✅

- [x] brain/src/focus.js:31,182 - type IN ('global_okr', 'area_okr')
- [x] brain/src/decision-executor.js:95 - 默认 type: 'global_okr'
- [x] brain/src/similarity.js:170 - g.type IN ('global_okr', 'area_okr')
- [x] brain/scripts/query-okr-status.mjs:12,55 - type IN ('global_okr', 'area_okr')
- Test: 搜索所有 .js/.mjs 文件，确认无 `type = 'objective'` 或 `type: 'objective'`

## 3. Exploratory → Dev 流程实现 ✅

- [x] Migration 032: tasks 表新增 phase 字段（exploratory/dev）
- [x] brain/src/planner.js: generateNextTask() 优先调度 exploratory
- [x] brain/src/routes.js: execution-callback 自动创建 dev 任务
- [x] brain/src/__tests__/exploratory-dev-flow.test.js: 5 个测试
- Test: `npm test exploratory-dev-flow.test.js` 全部通过

## 4. recurring_tasks 完整实现 ✅

- [x] brain/src/recurring.js: cron 引擎（matchesCron, calculateNextRunAt, checkRecurringTasks）
- [x] brain/src/tick.js: executeTick() 调用 checkRecurringTasks()
- [x] Migration 032: recurring_tasks 表增强（goal_id, project_id, worker_type, recurrence_type, priority）
- [x] brain/src/__tests__/recurring.test.js: 20 个测试
- Test: `npm test recurring.test.js` 全部通过
- Test: 验证 tick.js 中有 `await checkRecurringTasks()`

## 5. 增强 /okr Skill ✅

- [x] /home/xx/perfect21/cecelia/engine/skills/okr/SKILL.md 重写
- [x] Stage 0: 层级识别（6 层 + 时间维度检测表）
- [x] Stage 1: 逐层拆解规则
- [x] Stage 2: Exploratory 优先策略
- [x] Stage 3: Auto-Link to Parent
- [x] Quick Reference: 4 个常见场景
- Test: 文件存在且包含 "Stage 0: 层级识别"

## 6. 删除死代码和孤儿表 ✅

- [x] 删除 brain/src/alertness-decision.js
- [x] 删除 brain/src/recovery.js
- [x] 删除 brain/src/config-loader.js
- [x] 删除 brain/src/__tests__/config-loader.test.js
- [x] Migration 033: DROP TABLE publishing_tasks, publishing_records, publishing_credentials, system_snapshot
- [x] 删除重复的 GET /decisions 路由（routes.js:2801）
- [x] 删除 /action/create-feature 别名
- [x] 删除 createFeature alias（actions.js:105）
- Test: 确认文件不存在
- Test: 搜索 routes.js，确认只有 1 个 GET /decisions

## 7. 统一 Alertness 系统 ✅

- [x] 删除 brain/src/alertness.js
- [x] 删除 brain/src/__tests__/alertness.test.js
- [x] 删除 brain/src/__tests__/alertness-token-bucket.test.js
- [x] 删除 brain/src/__tests__/tick-token-bucket.test.js
- [x] brain/src/tick.js: 移除旧 alertness import，统一使用新系统
- [x] brain/src/routes.js: 简化 override/clear-override routes
- [x] brain/src/alertness-actions.js: 添加 ACTION_THRESHOLDS 映射
- [x] brain/src/quarantine.js: 更新 dynamic import
- [x] brain/src/alertness/index.js: 新增 canPlan() 函数
- [x] DEFINITION.md: 更新 alertness 描述（4 级 → 5 级）
- Test: 确认旧文件不存在
- Test: `npm test alertness-actions.test.js` 通过

## 8. exploratory task_type DB 约束修复 ✅

- [x] Migration 032: tasks_task_type_check 约束包含 exploratory
- Test: 尝试插入 exploratory task_type，验证不报错

## 全局验证 ✅

- [x] facts-check.mjs: 8/8 facts 一致
- [x] check-version-sync.sh: 版本同步
- [x] selfcheck.js: EXPECTED_SCHEMA_VERSION = '033'
- [x] DEFINITION.md: Schema version 更新到 033
- [x] .brain-versions: 修复重复值
- [x] 所有测试通过（102 + 36 = 138+ 个测试）
- Test: `npm test` 无新增失败
- Test: `node scripts/facts-check.mjs` 通过
- Test: `bash scripts/check-version-sync.sh` 通过

## Migration 检查清单

- [x] Migration 032 存在（exploratory_dev_flow_and_recurring.sql）
- [x] Migration 033 存在（drop_orphan_tables.sql）
- [x] 两个 migration 都有对应的 schema_version INSERT
- Test: `ls brain/migrations/032_*.sql brain/migrations/033_*.sql` 存在

## 文档更新检查清单

- [x] DEFINITION.md: 时间维度表格完整
- [x] DEFINITION.md: Schema version 033
- [x] DEFINITION.md: Alertness 5 级描述
- [x] DEFINITION.md: phase 字段说明
- [x] DEFINITION.md: recurring_tasks 字段说明
- [x] MEMORY.md: 时间维度一行总结
- Test: 读取文档，验证内容正确
