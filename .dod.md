# Definition of Done: Immune System v1 - P1

## Ticket 1: Probation Simulate + Evaluation 记录强化

### 代码改动
- [ ] `brain/src/immune-system.js` 新增 `parsePolicyAction()` 函数 | Test: immune-system.test.js > parsePolicyAction
- [ ] `brain/src/monitor-loop.js` Probation 策略 simulate 逻辑 | Test: monitor-loop.test.js > probation simulate
- [ ] Probation evaluation 记录 `would_do`, `would_apply`, `expected_outcome` | Test: monitor-loop.test.js > evaluation details

### 数据库
- [ ] 无新表（使用现有 policy_evaluations.details JSONB）

### 测试覆盖
- [ ] `parsePolicyAction()` 正确解析 policy_json | Test: immune-system.test.js > parsePolicyAction > parses action type
- [ ] `parsePolicyAction()` 处理缺失字段 | Test: immune-system.test.js > parsePolicyAction > handles missing fields
- [ ] Monitor Loop probation simulate 模式 | Test: monitor-loop.test.js > probation policy simulates
- [ ] Monitor Loop probation 不跳过 RCA | Test: monitor-loop.test.js > probation continues to RCA
- [ ] Evaluation details 包含完整字段 | Test: monitor-loop.test.js > evaluation has would_do details

### 日志和可观测性
- [ ] Probation simulate 输出日志 `[Immune] Probation policy simulated` | Test: 手动验证
- [ ] Active enforce 输出日志 `[Immune] Active policy enforced` | Test: 手动验证

---

## Ticket 2: Promotion Job（10分钟一次）

### 代码改动
- [ ] `brain/src/promotion-job.js` 完整实现 | Test: promotion-job.test.js
- [ ] `brain/server.js` 启动 Promotion Job Loop | Test: server integration
- [ ] `runPromotionJob()` 主函数 | Test: promotion-job.test.js > runPromotionJob
- [ ] `countPromotionsToday()` 每日计数 | Test: promotion-job.test.js > countPromotionsToday
- [ ] `findPromotionCandidates()` 筛选候选 | Test: promotion-job.test.js > findPromotionCandidates
- [ ] `promoteToActive()` 晋升逻辑 | Test: promotion-job.test.js > promoteToActive
- [ ] `findPoliciesToDisable()` 找禁用策略 | Test: promotion-job.test.js > findPoliciesToDisable
- [ ] `disablePolicy()` 禁用逻辑 | Test: promotion-job.test.js > disablePolicy
- [ ] `startPromotionJobLoop()` 定时任务 | Test: promotion-job.test.js > startPromotionJobLoop

### 晋升规则实现
- [ ] Probation → Active: simulate ≥ 2, pass rate ≥ 90%, risk_level=low | Test: promotion-job.test.js > promotion criteria
- [ ] Active → Disabled: verification fail ≥ 1 | Test: promotion-job.test.js > disable active on fail
- [ ] Probation → Disabled: verification fail ≥ 2 | Test: promotion-job.test.js > disable probation on fail
- [ ] Probation → Disabled: 超过 7 天未晋升 | Test: promotion-job.test.js > disable stale probation
- [ ] 每日晋升上限 3 条（硬护栏）| Test: promotion-job.test.js > daily promotion limit

### 测试覆盖
- [ ] `countPromotionsToday()` 正确计数 | Test: promotion-job.test.js > counts today promotions
- [ ] `countPromotionsToday()` 跨天边界 | Test: promotion-job.test.js > counts across day boundary
- [ ] `findPromotionCandidates()` 筛选正确 | Test: promotion-job.test.js > finds qualifying candidates
- [ ] `findPromotionCandidates()` 89% vs 90% 边界 | Test: promotion-job.test.js > respects 90% threshold
- [ ] `findPromotionCandidates()` 只选 low risk | Test: promotion-job.test.js > only low risk
- [ ] `findPromotionCandidates()` 限制数量 | Test: promotion-job.test.js > respects limit
- [ ] `promoteToActive()` 更新状态 | Test: promotion-job.test.js > updates policy status
- [ ] `promoteToActive()` 记录 evaluation | Test: promotion-job.test.js > records promotion event
- [ ] `promoteToActive()` 事务完整性 | Test: promotion-job.test.js > transaction rollback on error
- [ ] `findPoliciesToDisable()` active 失败 | Test: promotion-job.test.js > finds failed active
- [ ] `findPoliciesToDisable()` probation 失败 | Test: promotion-job.test.js > finds failed probation
- [ ] `findPoliciesToDisable()` probation stale | Test: promotion-job.test.js > finds stale probation
- [ ] `disablePolicy()` 更新状态 | Test: promotion-job.test.js > updates disabled status
- [ ] `disablePolicy()` 记录 evaluation | Test: promotion-job.test.js > records disable event
- [ ] `disablePolicy()` 事务完整性 | Test: promotion-job.test.js > transaction rollback on error
- [ ] Daily limit 生效 | Test: promotion-job.test.js > stops at daily limit
- [ ] Daily limit 跨天重置 | Test: promotion-job.test.js > resets after midnight

### 集成测试
- [ ] E2E: failure → probation simulate → promote → active enforce | Test: promotion-job.integration.test.js
- [ ] E2E: failure → probation simulate → fail → disable | Test: promotion-job.integration.test.js
- [ ] E2E: active enforce → fail → disable | Test: promotion-job.integration.test.js

---

## 文档更新

- [ ] `DEFINITION.md` 更新免疫系统状态机图 | Test: Facts Consistency
- [ ] `LEARNINGS.md` 记录 P1 实施经验 | Test: 手动验证

---

## CI DevGate 要求

### DoD 映射检查
- [ ] 每条 DoD 有对应的 Test 字段 | Test: scripts/devgate/check-dod-mapping.cjs

### RCI 覆盖率
- [ ] 新增代码有对应测试 | Test: scripts/devgate/scan-rci-coverage.cjs

### 版本同步
- [ ] `brain/package.json` 版本更新（1.25.0 → 1.26.0, minor bump）| Test: scripts/check-version-sync.sh
- [ ] `brain/package-lock.json` 同步 | Test: scripts/check-version-sync.sh
- [ ] `.brain-versions` 同步 | Test: scripts/check-version-sync.sh
- [ ] `DEFINITION.md` Brain 版本同步 | Test: scripts/check-version-sync.sh
- [ ] `brain/src/selfcheck.js` EXPECTED_SCHEMA_VERSION 保持 025 | Test: Brain tests
- [ ] `brain/src/__tests__/selfcheck.test.js` 测试期望值保持 025 | Test: Brain tests

---

## 质量门禁

### 本地测试
- [ ] 所有单元测试通过（`npm test`）| Test: Vitest
- [ ] 测试覆盖率 ≥ 80% | Test: Vitest coverage

### CI 检查
- [ ] Version Check 通过 | Test: GitHub Actions
- [ ] Facts Consistency 通过 | Test: GitHub Actions
- [ ] Brain (Node.js) 通过 | Test: GitHub Actions
- [ ] Semantic Brain (Python) 通过 | Test: GitHub Actions

---

## 产物清单

### 代码文件（4 个）
1. `brain/src/immune-system.js` - 新增 `parsePolicyAction()`
2. `brain/src/monitor-loop.js` - 增强 probation simulate
3. `brain/src/promotion-job.js` - 完整实现（~200 行）
4. `brain/server.js` - 启动 Promotion Job Loop

### 测试文件（2-3 个）
1. `brain/src/__tests__/immune-system.test.js` - 更新，新增 `parsePolicyAction` 测试
2. `brain/src/__tests__/promotion-job.test.js` - 新建，完整测试套件（~400 行）
3. `brain/src/__tests__/promotion-job.integration.test.js` - 可选，E2E 测试

### 文档文件（2 个）
1. `DEFINITION.md` - 更新状态机图
2. `LEARNINGS.md` - P1 经验记录

---

## 验收标准总结

### 功能完整性
- [ ] Probation 策略只 simulate，不 enforce
- [ ] Evaluation 记录包含 would_do/would_apply/expected_outcome
- [ ] Promotion Job 每 10 分钟运行
- [ ] 晋升规则正确实现（simulate ≥ 2, pass ≥ 90%, low risk）
- [ ] 禁用规则正确实现（active fail 1次, probation fail 2次, stale 7天）
- [ ] 每日晋升上限 3 条生效

### 测试完整性
- [ ] 20+ 单元测试覆盖所有函数
- [ ] 边界条件测试（89% vs 90%, 1次 vs 2次）
- [ ] 事务完整性测试（rollback on error）
- [ ] E2E 测试（可选但推荐）

### 代码质量
- [ ] 无 lint 错误
- [ ] 所有函数有 JSDoc 注释
- [ ] SQL 查询使用参数化（防止注入）
- [ ] 错误处理完整（try-catch + rollback）

### 可观测性
- [ ] Probation simulate 日志清晰
- [ ] Promotion Job 日志包含 promoted/disabled 数量
- [ ] Evaluation 记录完整，便于审计

---

## 预期测试数量

- **Ticket 1**: 5 个测试
- **Ticket 2**: 17 个测试
- **总计**: 22 个新测试 + P0 的 14 个测试 = 36 个 immune system 相关测试

---

## 成功指标

1. **功能验证**：手动创建 probation policy → 插入 simulate evaluations → 运行 Promotion Job → 验证晋升到 active
2. **硬护栏验证**：插入 3 个候选 → 运行 Promotion Job → 验证只晋升 3 个
3. **禁用验证**：插入 active policy + fail evaluation → 运行 Promotion Job → 验证自动禁用
4. **CI 通过**：所有 GitHub Actions checks 绿灯
