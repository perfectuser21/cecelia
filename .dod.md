# Definition of Done: Fix SQL Error in getActiveExecutionPaths()

## 验收清单

### 1. SQL 语法正确 ✓

**要求**：
- [x] 移除 `SELECT DISTINCT`
- [x] 添加 `MAX(t.updated_at) as last_activity` 到 SELECT 列表
- [x] 添加 `GROUP BY p.id, p.name, pkl.kr_id`
- [x] 使用 `ORDER BY last_activity DESC`

**Test**: `brain/src/__tests__/decomposition-checker.test.js` - 单元测试验证 SQL 正确执行

**Evidence**: 代码审查 `decomposition-checker.js:144-158`

---

### 2. 功能验证 ✓

**要求**：
- [x] Brain 启动后日志无 SQL 错误
- [x] `getActiveExecutionPaths()` 返回活跃路径数组
- [x] 返回结果按 `last_activity` 降序排列
- [x] LIMIT 10 生效

**Test**: 集成测试 or 手动验证（Brain 日志）

**Evidence**: Docker logs 无 "execution frontier check failed"

---

### 3. 边界情况测试 ✓

**要求**：
- [x] 无活跃 initiative 时返回空数组
- [x] 单个活跃 initiative 正常返回
- [x] 多个活跃 initiative 正确排序
- [x] 24 小时窗口过滤生效

**Test**: `brain/src/__tests__/decomposition-checker.test.js` - 边界测试

**Evidence**: 测试覆盖率报告

---

### 4. 回归测试 ✓

**要求**：
- [x] 所有现有 decomposition-checker 测试通过
- [x] Brain 核心测试套件全部通过（1244+ tests）
- [x] GoldenPath E2E 测试通过

**Test**: `npm test` + CI pipeline

**Evidence**: CI 绿灯 ✅

---

### 5. 代码质量 ✓

**要求**：
- [x] 代码符合项目风格
- [x] 添加必要注释说明 SQL 修改原因
- [x] 无 console.log 调试代码
- [x] 无 ESLint 警告

**Test**: Lint checks (CI)

**Evidence**: `npm run lint` 通过

---

### 6. 文档更新 ✓

**要求**：
- [x] 函数注释更新（如需要）
- [x] DEFINITION.md 版本号更新
- [x] .brain-versions 更新

**Test**: `scripts/facts-check.mjs`

**Evidence**: Facts check 通过

---

### 7. 版本管理 ✓

**要求**：
- [x] Brain 版本号递增（1.41.1 → 1.41.2, patch）
- [x] brain/package.json 更新
- [x] brain/package-lock.json 同步
- [x] .brain-versions 同步
- [x] DEFINITION.md Brain 版本同步

**Test**: `scripts/check-version-sync.sh`

**Evidence**: Version sync check 通过

---

### 8. 部署验证 ✓

**要求**：
- [x] Docker image 构建成功
- [x] Migration 运行成功（无新 migration）
- [x] Self-check 通过
- [x] Health endpoint 返回 healthy

**Test**: `scripts/brain-deploy.sh`

**Evidence**: 容器启动成功，health check 通过

---

## 测试映射表

| DoD 项 | 测试文件 | 测试用例 |
|--------|----------|----------|
| SQL 语法 | decomposition-checker.test.js | test_getActiveExecutionPaths_sql_syntax |
| 功能验证 | decomposition-checker.test.js | test_getActiveExecutionPaths_returns_paths |
| 无活跃路径 | decomposition-checker.test.js | test_getActiveExecutionPaths_empty |
| 排序正确 | decomposition-checker.test.js | test_getActiveExecutionPaths_sorting |
| 回归测试 | 所有测试 | npm test（1244+ tests）|
| GoldenPath | goldenpath-check.sh | Brain E2E workflow |

---

## 完成标准

**所有 ✓ 标记完成 AND CI 通过 = PR 可合并**

- [ ] 所有 DoD 项完成
- [ ] CI pipeline 绿灯
- [ ] PR approved by reviewer
- [ ] Branch protection rules satisfied
