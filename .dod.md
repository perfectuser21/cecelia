# DoD: Add Monitoring Loop (P0/P1/P2)

## âœ… P0: Rule-Based Auto-Healing (COMPLETED)

### Code Changes
- [x] åˆ›å»º `brain/src/monitor-loop.js` with:
  - [x] `detectStuckRuns()` - æ£€æµ‹å¡ä½çš„ä»»åŠ¡
  - [x] `detectFailureSpike()` - æ£€æµ‹å¤±è´¥ç‡æ¿€å¢
  - [x] `detectResourcePressure()` - æ£€æµ‹èµ„æºå‹åŠ›
  - [x] `handleStuckRun()` - å¤„ç½®å¡ä½ä»»åŠ¡ï¼ˆrestart/retry/quarantineï¼‰
  - [x] `startMonitorLoop()` / `stopMonitorLoop()` - å¯åŠ¨/åœæ­¢å¾ªç¯
  - [x] `getMonitorStatus()` - æŸ¥è¯¢ç›‘æ§çŠ¶æ€

- [x] ä¿®æ”¹ `brain/server.js`:
  - [x] Import monitor-loop
  - [x] Call `startMonitorLoop()` in server startup

- [x] æ·»åŠ  API ç«¯ç‚¹:
  - [x] GET `/api/brain/monitor/status` - æŸ¥çœ‹ç›‘æ§çŠ¶æ€

## âœ… P1: Cortex Intelligent Upgrade (COMPLETED)

### Code Changes
- [x] åˆ›å»º `brain/src/rca-deduplication.js`:
  - [x] `generateErrorSignature()` - ç”Ÿæˆé”™è¯¯ç­¾åï¼ˆSHA256ï¼‰
  - [x] `shouldAnalyzeFailure()` - æ£€æŸ¥æ˜¯å¦éœ€è¦ RCAï¼ˆ24h å»é‡ï¼‰
  - [x] `cacheRcaResult()` - ç¼“å­˜ RCA ç»“æœ
  - [x] `getRcaCacheStats()` - æŸ¥è¯¢ç¼“å­˜ç»Ÿè®¡
  - [x] `cleanOldCache()` - æ¸…ç† 7 å¤©å‰çš„ç¼“å­˜

- [x] åˆ›å»ºæ•°æ®åº“è¿ç§»:
  - [x] `migrations/024_add_rca_cache_table.sql`
  - [x] æ›´æ–° `selfcheck.js` EXPECTED_SCHEMA_VERSION = '024'

- [x] ä¿®æ”¹ `brain/src/monitor-loop.js`:
  - [x] Import rca-deduplication æ¨¡å—
  - [x] `callCortexForRca()` - è°ƒç”¨ Cortex è¿›è¡Œç»“æ„åŒ– RCA
  - [x] `handleFailureSpike()` - é›†æˆ RCA å»é‡ + Cortex åˆ†æ
  - [x] è¾“å‡ºç»“æ„åŒ– RCA ç»“æœï¼ˆroot_cause, proposed_fix, action_plan, confidence, evidenceï¼‰

## ğŸš§ P2: Closed-Loop Fixing (IN PROGRESS)

### Code Changes
- [ ] åˆ›å»º `brain/src/auto-fix.js`:
  - [ ] `shouldAutoFix()` - åˆ¤æ–­æ˜¯å¦è‡ªåŠ¨ä¿®å¤ï¼ˆconfidence > 0.7ï¼‰
  - [ ] `generateFixPrd()` - ä» RCA ç”Ÿæˆ PRD
  - [ ] `dispatchToDevSkill()` - æ´¾å‘åˆ° /dev æ‰§è¡Œä¿®å¤
  - [ ] `verifyFixApplied()` - éªŒè¯ä¿®å¤æ˜¯å¦æˆåŠŸï¼ˆCI + Gateï¼‰

- [ ] ä¿®æ”¹ `brain/src/monitor-loop.js`:
  - [ ] åœ¨ `handleFailureSpike()` ä¸­é›†æˆ `shouldAutoFix()`
  - [ ] é«˜ä¿¡å¿ƒåº¦ RCA â†’ è‡ªåŠ¨æ´¾å‘åˆ° /dev
  - [ ] è·Ÿè¸ªä¿®å¤è¿›åº¦ï¼ˆtask_id + PR + CI statusï¼‰

- [ ] ä¿®æ”¹ `brain/src/actions.js`:
  - [ ] æ·»åŠ  `createTaskFromRca()` - ä» RCA åˆ›å»ºä¿®å¤ä»»åŠ¡
  - [ ] ä»»åŠ¡ç±»å‹: `dev`ï¼ŒæŠ€èƒ½: `/dev`
  - [ ] PRD å†…å®¹æ¥è‡ª RCA çš„ proposed_fix + action_plan

### Closed-Loop Requirements
- [ ] /dev å¿…é¡»å¸¦æµ‹è¯•ï¼ˆéªŒè¯ä¿®å¤æœ‰æ•ˆï¼‰
- [ ] /dev å¿…é¡»å¸¦è¯æ®ï¼ˆæ—¥å¿—/è¿½è¸ªè¯æ˜é—®é¢˜è§£å†³ï¼‰
- [ ] CI + Gate å…¨ç»¿æ‰ç®—ä¿®å¤å®Œæˆ
- [ ] è‡ªåŠ¨æ›´æ–° LEARNINGS.md è®°å½•ä¿®å¤ç»éªŒ

## Testing

### P0 åœºæ™¯æµ‹è¯•
- [ ] å¯åŠ¨ Brainï¼ŒéªŒè¯ç›‘æ§å¾ªç¯è‡ªåŠ¨å¯åŠ¨
- [ ] æ’å…¥ stuck æµ‹è¯•æ•°æ®ï¼ŒéªŒè¯ 30s å†…è¢«å¤„ç†
- [ ] æ£€æŸ¥æ—¥å¿—è¾“å‡ºæ ¼å¼æ­£ç¡®

**Scenario 1: Stuck Task Auto-Restart**
```sql
-- æ’å…¥ stuck ä»»åŠ¡
INSERT INTO run_events (run_id, task_id, span_id, layer, step_name, status, ts_start, heartbeat_ts, executor_host, agent, region, attempt)
VALUES (gen_random_uuid(), '<task_id>', gen_random_uuid(), 'L2_executor', 'test', 'running', NOW() - INTERVAL '10 minutes', NOW() - INTERVAL '10 minutes', 'us-vps', 'executor', 'us', 1);

-- ç­‰å¾… 30 ç§’
-- éªŒè¯ï¼štask status å˜å› queuedï¼Œrun_events æ ‡è®°ä¸º failed
```

**Scenario 2: Repeated Stuck â†’ Quarantine**
```sql
-- è®¾ç½® task.retry_count = 2
UPDATE tasks SET retry_count = 2 WHERE id = '<task_id>';

-- æ’å…¥ stuck run
-- ç­‰å¾… 30 ç§’
-- éªŒè¯ï¼štask è¿›å…¥ quarantined_tasks è¡¨
```

### P1 åœºæ™¯æµ‹è¯•
- [ ] æ’å…¥ç›¸åŒé”™è¯¯ç­¾åçš„å¤±è´¥ï¼ŒéªŒè¯ 24h å†…åª RCA ä¸€æ¬¡
- [ ] æŸ¥è¯¢ rca_cache è¡¨ï¼ŒéªŒè¯ç»“æœæ­£ç¡®å­˜å‚¨
- [ ] éªŒè¯ Cortex è¾“å‡ºç»“æ„åŒ– JSONï¼ˆroot_cause, proposed_fix, confidenceï¼‰

**Scenario 3: RCA Deduplication**
```sql
-- æ’å…¥ç¬¬ä¸€ä¸ªå¤±è´¥
INSERT INTO run_events (run_id, task_id, span_id, layer, step_name, status, reason_code, ts_start, ts_end)
VALUES (gen_random_uuid(), '<task_id>', gen_random_uuid(), 'L2_executor', 'fetch_data', 'failed', 'NETWORK_ERROR', NOW() - INTERVAL '1 hour', NOW() - INTERVAL '59 minutes');

-- æ’å…¥ç¬¬äºŒä¸ªç›¸åŒé”™è¯¯
INSERT INTO run_events (run_id, task_id, span_id, layer, step_name, status, reason_code, ts_start, ts_end)
VALUES (gen_random_uuid(), '<task_id2>', gen_random_uuid(), 'L2_executor', 'fetch_data', 'failed', 'NETWORK_ERROR', NOW() - INTERVAL '30 minutes', NOW() - INTERVAL '29 minutes');

-- è§¦å‘ Failure Spike æ£€æµ‹
-- éªŒè¯ï¼šç¬¬ä¸€ä¸ªè°ƒç”¨ Cortexï¼Œç¬¬äºŒä¸ªä½¿ç”¨ç¼“å­˜
```

### P2 åœºæ™¯æµ‹è¯•
- [ ] æ’å…¥é«˜ä¿¡å¿ƒåº¦ RCAï¼ŒéªŒè¯è‡ªåŠ¨æ´¾å‘åˆ° /dev
- [ ] éªŒè¯ç”Ÿæˆçš„ PRD åŒ…å« RCA çš„ proposed_fix å’Œ action_plan
- [ ] éªŒè¯ /dev åˆ›å»º PR â†’ CI é€šè¿‡ â†’ è‡ªåŠ¨åˆå¹¶
- [ ] éªŒè¯ LEARNINGS.md æ›´æ–°

## Documentation

- [ ] æ›´æ–° DEFINITION.md:
  - [x] æ·»åŠ  Monitoring Loop è¯´æ˜ï¼ˆP0ï¼‰
  - [x] æ·»åŠ åŒå¾ªç¯æ¶æ„ï¼ˆTick + Monitorï¼‰
  - [ ] æ·»åŠ  RCA Deduplication è¯´æ˜ï¼ˆP1ï¼‰
  - [ ] æ·»åŠ  Closed-Loop Fixing è¯´æ˜ï¼ˆP2ï¼‰

- [ ] æ›´æ–° MEMORY.md:
  - [x] è®°å½•ç›‘æ§å¾ªç¯çš„é…ç½®å‚æ•°
  - [x] è®°å½•å¤„ç½®ç­–ç•¥ï¼ˆrestart/retry/quarantineï¼‰
  - [ ] è®°å½• RCA ç¼“å­˜ç­–ç•¥ï¼ˆ24h å»é‡ï¼‰
  - [ ] è®°å½•è‡ªåŠ¨ä¿®å¤æ¡ä»¶ï¼ˆconfidence > 0.7ï¼‰

## Performance

- [x] ç›‘æ§æŸ¥è¯¢åŠ  LIMIT 10ï¼ˆé¿å…å¤„ç†è¿‡å¤šä»»åŠ¡ï¼‰
- [x] æ¯æ¬¡å¾ªç¯ < 5 ç§’ï¼ˆé¿å…å †ç§¯ï¼‰
- [x] å´©æºƒè‡ªåŠ¨æ¢å¤ï¼ˆtry/catch + ä¸‹æ¬¡å¾ªç¯ç»§ç»­ï¼‰
- [ ] RCA æŸ¥è¯¢ä¼˜åŒ–ï¼ˆç´¢å¼• + 24h çª—å£ï¼‰
- [ ] Cortex è°ƒç”¨èŠ‚æµï¼ˆæœ€å¤š 5 æ¬¡/åˆ†é’Ÿï¼‰

## Observability

- [x] ç›‘æ§å¾ªç¯æœ¬èº«çš„æ—¥å¿—æ¸…æ™°
- [x] æ¯æ¬¡å¾ªç¯è¾“å‡ºç»Ÿè®¡ï¼š`[Monitor] Cycle completed in Xms`
- [x] Detector è§¦å‘è¾“å‡ºè¯¦æƒ…ï¼š`[Monitor] Stuck detected: task=xxx, stuck_for=Xmin`
- [x] Handler åŠ¨ä½œè¾“å‡ºæ¸…æ™°ï¼š`[Monitor] Action: RESTART task xxx (1st stuck)`
- [x] RCA æ—¥å¿—ï¼š`[Monitor] Running RCA for signature=xxx`
- [x] RCA ç¼“å­˜ç»Ÿè®¡ï¼š`[Monitor] RCA Cache: X total, Y in 24h`
- [ ] Auto-fix æ—¥å¿—ï¼š`[Monitor] Auto-fix dispatched for task=xxx (confidence=0.85)`

## Rollback Plan

å¦‚æœç›‘æ§å¾ªç¯æœ‰é—®é¢˜ï¼š
1. é‡å¯ Brain â†’ ç›‘æ§å¾ªç¯åœæ­¢
2. æš‚æ—¶ç¦ç”¨ï¼šæ³¨é‡Šæ‰ server.js ä¸­çš„ `startMonitorLoop()`
3. å›æ»š PR

å¦‚æœ RCA å»é‡æœ‰é—®é¢˜ï¼š
1. æ¸…ç©º rca_cache è¡¨ï¼š`TRUNCATE rca_cache;`
2. æš‚æ—¶ç¦ç”¨ï¼šåœ¨ monitor-loop.js ä¸­è·³è¿‡ RCA è°ƒç”¨

å¦‚æœè‡ªåŠ¨ä¿®å¤æœ‰é—®é¢˜ï¼š
1. ç¦ç”¨ï¼šåœ¨ monitor-loop.js ä¸­æ³¨é‡Šæ‰ `shouldAutoFix()` è°ƒç”¨
2. æ‰‹åŠ¨å®¡æŸ¥ï¼šæŸ¥çœ‹ rca_cache è¡¨çš„é«˜ä¿¡å¿ƒåº¦ç»“æœï¼Œæ‰‹åŠ¨æ´¾å‘
