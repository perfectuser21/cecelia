# Definition of Done: 修复 Alertness 系统混用导致的 Dispatch Rate Limiting 失效

## 代码实现

- [ ] 移除 `brain/src/tick.js` 中的 Old System token bucket 检查（第 586-596 行）
  - Test: 读取 `brain/src/tick.js`，验证不包含 `tryConsumeToken('dispatch')` 调用

- [ ] 移除对应的 import（如果不再使用）
  - Test: 检查 `brain/src/tick.js` 开头的 import 语句，如果 `tryConsumeToken` 只在 dispatch 中使用，则移除

## 功能验证

- [ ] Enhanced System dispatch rate 正常工作
  - Test: 手动触发 Tick，在 CALM 状态下应返回 `no_dispatchable_task`（不是 `rate_limited`）
  - Test: 运行 `brain/src/__tests__/tick.test.js` 中的 dispatch 相关测试

- [ ] 不同 Alertness 级别的 dispatch rate 生效
  - Test: 验证 `getDispatchRateEnhanced()` 在不同级别返回正确的百分比
  - Test: CALM=100%, AWARE=70%, ALERT=30%, PANIC=0%

## 单元测试

- [ ] Tick 测试全部通过
  - Test: 运行 `npm test -- brain/src/__tests__/tick.test.js`，所有测试通过

- [ ] Alertness 测试全部通过
  - Test: 运行 `npm test -- brain/src/__tests__/alertness.test.js`，所有测试通过

- [ ] 全部测试通过
  - Test: 运行 `npm test`，所有测试通过（当前基线：1158 passing）

## 版本管理

- [ ] 版本号已更新
  - Test: `brain/package.json` 版本从 1.39.2 → 1.39.3（patch）
  - Reason: fix: 类型，patch increment

- [ ] 版本同步
  - Test: `.brain-versions` 包含 `1.39.3`
  - Test: `DEFINITION.md` Brain 版本字段显示 `1.39.3`

## 文档更新

- [ ] LEARNINGS.md 已更新
  - Test: `docs/LEARNINGS.md` 包含新条目，描述 Alertness 系统混用问题和解决方案

- [ ] DEFINITION.md 版本已更新
  - Test: `DEFINITION.md` 的 "Brain 版本" 字段为 `1.39.3`

## CI/CD

- [ ] Version Check 通过
  - Test: CI job "Version Check" 状态为 success

- [ ] Facts Consistency 通过
  - Test: CI job "Facts Consistency" 状态为 success

- [ ] Brain (Node.js) 测试通过
  - Test: CI job "Brain (Node.js)" 状态为 success

- [ ] Semantic Brain (Python) 通过
  - Test: CI job "Semantic Brain (Python)" 状态为 success

## 部署验证

- [ ] 本地 Brain 容器正常运行
  - Test: `docker ps` 显示 `cecelia-node-brain` 状态为 healthy

- [ ] 手动 Tick 测试
  - Test: 连续 5 次 `curl -X POST http://localhost:5221/api/brain/tick`，在 CALM 状态下全部返回 `no_dispatchable_task`

## 完成标准

- [ ] PR 已创建
- [ ] CI 全部通过
- [ ] PR 已合并到 develop
