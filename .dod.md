# DoD - PR Plans API (Layer 2 工程规划层)

## 验收标准

### 功能验收

#### 数据库迁移
- [ ] 迁移脚本执行成功，pr_plans 表已创建
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] tasks 表新增 pr_plan_id 字段
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] 一致性约束生效（Task 的 project_id 必须与 PR Plan 一致）
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] 辅助视图已创建（pr_plan_full_context, initiative_pr_progress）
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] selfcheck.js 更新 EXPECTED_SCHEMA_VERSION = '021'
      Test: brain/src/__tests__/selfcheck.test.js

#### API 端点 - POST /api/brain/pr-plans
- [ ] 成功创建 PR Plan（所有必填字段）
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] 验证必填字段（dod）- 缺少时返回 400
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] initiative_id 不存在时返回 400/404
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] project_id 不存在时返回 400/404
      Test: brain/src/__tests__/pr-plans.test.js

#### API 端点 - GET /api/brain/pr-plans
- [ ] 查询所有 PR Plans
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] 按 initiative_id 过滤
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] 按 project_id 过滤
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] 按 status 过滤
      Test: brain/src/__tests__/pr-plans.test.js

#### API 端点 - GET /api/brain/pr-plans/:id
- [ ] 成功获取单个 PR Plan（包含 Initiative/Project 信息）
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] 使用 pr_plan_full_context 视图返回完整上下文
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] ID 不存在时返回 404
      Test: brain/src/__tests__/pr-plans.test.js

#### API 端点 - PATCH /api/brain/pr-plans/:id
- [ ] 成功更新 PR Plan（部分字段）
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] 更新状态（planning → in_progress → completed）
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] ID 不存在时返回 404
      Test: brain/src/__tests__/pr-plans.test.js

#### API 端点 - DELETE /api/brain/pr-plans/:id
- [ ] 成功删除 PR Plan
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] ID 不存在时返回 404
      Test: brain/src/__tests__/pr-plans.test.js

#### 错误处理
- [ ] API 错误处理完整（400/404/500）
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] 所有端点都有 try-catch，返回合适的 HTTP 状态码
      Test: brain/src/__tests__/pr-plans.test.js

#### 代码质量
- [ ] 代码符合现有风格（ESM, async/await, pg.Pool）
      Test: manual:代码审查
- [ ] 路由已在 brain/src/routes.js 注册
      Test: brain/src/__tests__/pr-plans.test.js

### 测试验收
- [ ] 所有单元测试通过（至少 15 个测试用例）
      Test: brain/src/__tests__/pr-plans.test.js
- [ ] npm test 执行成功
      Test: contract:C2-001
- [ ] Golden Path 测试通过
      Test: contract:L4-goldenpath

### CI 验收
- [ ] Version Check 通过
      Test: contract:CI-version-check
- [ ] Facts Consistency 通过
      Test: contract:CI-facts-check
- [ ] Brain (Node.js) 测试通过
      Test: contract:CI-brain-tests
