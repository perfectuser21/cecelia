# DoD - 免疫系统前端展示层

## 验收标准

### 6.1 功能完整性

- [ ] Dashboard 页面正确展示 4 个模块（策略统计、隔离区统计、Top 10 失败签名、最近晋升记录）
      Test: manual:访问 /immune/dashboard，验证所有模块正常显示

- [ ] 策略列表支持过滤（All/Active/Probation/Draft/Disabled）和排序（最新创建/最近晋升/成功率）
      Test: manual:在 /immune/policies 测试所有过滤器和排序选项

- [ ] 策略详情页展示完整信息（基本信息、策略内容、评估历史）
      Test: manual:访问 /immune/policies/:id，验证所有字段正确显示

- [ ] 失败签名列表展示统计信息（签名、出现次数、关联策略数）
      Test: manual:访问 /immune/signatures，验证签名列表和统计信息

- [ ] 签名详情页展示关联策略
      Test: manual:访问 /immune/signatures/:signature，验证关联策略列表

### 6.2 API 集成

- [ ] Dashboard API 调用正确（GET /api/brain/immune/dashboard）
      Test: tests/immune/api/dashboard.test.ts

- [ ] 策略列表 API 调用正确（GET /api/brain/policies）
      Test: tests/immune/api/policies.test.ts

- [ ] 策略详情 API 调用正确（GET /api/brain/policies/:id）
      Test: tests/immune/api/policy-detail.test.ts

- [ ] 策略状态更新 API 调用正确（PATCH /api/brain/policies/:id/status）
      Test: tests/immune/api/policy-status.test.ts

- [ ] 失败签名 API 调用正确（GET /api/brain/failures/signatures）
      Test: tests/immune/api/signatures.test.ts

- [ ] 签名详情 API 调用正确（GET /api/brain/failures/signatures/:signature）
      Test: tests/immune/api/signature-detail.test.ts

- [ ] 错误处理覆盖 400/404/500（Toast 通知 + 错误边界）
      Test: tests/immune/error-handling.test.ts

- [ ] 加载状态显示正确（Skeleton Loading）
      Test: tests/immune/loading-states.test.ts

- [ ] 数据刷新机制正常（SWR 自动重新验证）
      Test: manual:等待 5 分钟后验证数据自动刷新

### 6.3 交互体验

- [ ] 点击策略统计卡片跳转到策略列表（自动过滤）
      Test: manual:Dashboard 点击策略统计卡片，验证跳转和过滤

- [ ] 点击失败签名跳转到签名详情页
      Test: manual:Dashboard 点击失败签名，验证跳转正确

- [ ] 点击策略行跳转到策略详情页
      Test: manual:策略列表点击行，验证跳转正确

- [ ] 禁用策略功能正常（含确认对话框）
      Test: manual:策略详情页点击"禁用"，确认对话框显示，确认后状态更新

- [ ] 过滤和排序功能正常（实时更新列表）
      Test: manual:测试所有过滤器和排序选项，验证列表实时更新

- [ ] 分页功能正常（策略列表、评估历史）
      Test: manual:测试分页器，验证翻页正常

### 6.4 代码质量

- [ ] TypeScript 类型完整，无 any（immune.ts）
      Test: manual:运行 tsc --noEmit，验证无类型错误

- [ ] 组件可复用（PolicyCard、StatusBadge、RiskBadge、EvaluationTable）
      Test: tests/immune/components/shared.test.ts

- [ ] API 客户端封装良好（immune-api.ts）
      Test: tests/immune/api/client.test.ts

- [ ] 关键组件有单元测试（PolicyCard、StatusBadge、RiskBadge、EvaluationTable、Dashboard）
      Test: tests/immune/components/*.test.ts

- [ ] 路由配置正确（/immune/* 路由）
      Test: manual:访问所有路由，验证页面正确加载

### 测试验收

- [ ] npm run build 成功
      Test: manual:运行 npm run build，验证无错误

- [ ] 本地开发服务器正常（npm run dev）
      Test: manual:运行 npm run dev，访问 localhost:5173，验证页面正常

---

## 非功能需求验收

### 性能

- [ ] 首屏加载 < 2s（本地环境）
      Test: manual:Chrome DevTools Network，测量首屏加载时间

- [ ] API 响应缓存正常（SWR 缓存 + 5 分钟重新验证）
      Test: manual:Network 面板验证重复请求使用缓存

- [ ] 列表渲染流畅（策略 > 100 条时使用虚拟滚动）
      Test: manual:创建大量测试数据，验证列表渲染流畅

### 兼容性

- [ ] Chrome 最新版兼容
      Test: manual:Chrome 最新版测试所有功能

### 安全性

- [ ] Brain API CORS 正常（localhost:5211 允许访问 localhost:5221）
      Test: manual:Network 面板验证 CORS 头正确

---

## 实现范围确认

### 包含的功能

- ✅ Dashboard 总览页
- ✅ 策略列表页（过滤、排序、分页）
- ✅ 策略详情页（基本信息、策略内容、评估历史）
- ✅ 失败签名列表页
- ✅ 签名详情页（关联策略）
- ✅ API 客户端封装
- ✅ TypeScript 类型定义
- ✅ 共享组件（PolicyCard、StatusBadge、RiskBadge、EvaluationTable）
- ✅ 路由配置
- ✅ 错误处理 + 加载状态

### 不包含的功能

- ❌ 创建策略表单（PRD 中提到但优先级低，后续迭代）
- ❌ 编辑策略功能（PRD 中提到但优先级低，后续迭代）
- ❌ 策略删除功能（暂不实现，手动禁用即可）
- ❌ 虚拟滚动优化（如果策略 < 100 条，暂不需要）
- ❌ Safari/Firefox/Edge 兼容（内部工具，只测 Chrome）

---

## 完成条件

✅ 所有功能验收条目勾选完成
✅ 所有 API 集成条目勾选完成
✅ 所有交互体验条目勾选完成
✅ 所有代码质量条目勾选完成
✅ npm run build 成功

---

## 测试覆盖计划

### 单元测试（Jest + React Testing Library）

1. **API 客户端测试** (`tests/immune/api/`)
   - dashboard.test.ts - Dashboard API
   - policies.test.ts - 策略列表 API
   - policy-detail.test.ts - 策略详情 API
   - policy-status.test.ts - 策略状态更新 API
   - signatures.test.ts - 失败签名 API
   - signature-detail.test.ts - 签名详情 API
   - client.test.ts - API 客户端封装
   - error-handling.test.ts - 错误处理
   - loading-states.test.ts - 加载状态

2. **组件测试** (`tests/immune/components/`)
   - shared.test.ts - 共享组件（PolicyCard、StatusBadge、RiskBadge、EvaluationTable）
   - dashboard.test.ts - Dashboard 页面组件
   - policies.test.ts - 策略列表组件
   - policy-detail.test.ts - 策略详情组件
   - signatures.test.ts - 失败签名列表组件
   - signature-detail.test.ts - 签名详情组件

### 手动测试（Manual）

- Dashboard 页面所有模块显示正确
- 策略列表过滤、排序、分页功能
- 策略详情页所有字段显示
- 失败签名列表和详情页
- 禁用策略功能（含确认对话框）
- 所有跳转链接正确
- 错误处理和加载状态显示
- 性能测试（首屏加载 < 2s）
- CORS 配置正确

---

## 交付物清单

### 核心页面

- ✅ `apps/core/features/system/pages/immune/Dashboard.tsx`
- ✅ `apps/core/features/system/pages/immune/Policies.tsx`
- ✅ `apps/core/features/system/pages/immune/PolicyDetail.tsx`
- ✅ `apps/core/features/system/pages/immune/Signatures.tsx`
- ✅ `apps/core/features/system/pages/immune/SignatureDetail.tsx`

### 共享组件

- ✅ `apps/core/features/system/pages/immune/components/PolicyCard.tsx`
- ✅ `apps/core/features/system/pages/immune/components/StatusBadge.tsx`
- ✅ `apps/core/features/system/pages/immune/components/RiskBadge.tsx`
- ✅ `apps/core/features/system/pages/immune/components/EvaluationTable.tsx`

### API 和类型

- ✅ `apps/core/features/system/api/immune.api.ts`
- ✅ `apps/core/features/system/types/immune.ts`

### 路由

- ✅ 在 `apps/core/features/system-hub/index.tsx` 添加 `/immune/*` 路由

### 测试文件

- ✅ `apps/core/features/system/__tests__/immune/api/*.test.ts` (9 个 API 测试文件)
- ✅ `apps/core/features/system/__tests__/immune/components/*.test.ts` (6 个组件测试文件)

---

## 风险和依赖

### 依赖项

- ✅ Brain API 服务运行（localhost:5221）
- ✅ PostgreSQL 数据库有测试数据
- ✅ CORS 配置正确

### 风险

- ⚠️ Brain API 返回数据格式可能与 PRD 不完全匹配 → 实现时需要验证实际响应
- ⚠️ 测试数据可能不足 → 需要手动创建或导入测试数据
- ⚠️ SWR 缓存策略可能需要调整 → 根据实际使用体验优化

---

## 预估工作量

- **Phase 1 (基础设施)**: 1-2 小时
- **Phase 2 (Dashboard)**: 2-3 小时
- **Phase 3 (策略管理)**: 3-4 小时
- **Phase 4 (失败分析)**: 2-3 小时
- **Phase 5 (测试和优化)**: 1-2 小时

**总计**: 9-14 小时

---

## 完成标志

✅ 所有 DoD 条目勾选完成
✅ PR 提交并合并到 develop
✅ CI 通过（DevGate 检查）
