---
id: dod-thalamus-stability-bugfix
version: 1.0.0
created: 2026-02-18
updated: 2026-02-18
changelog:
  - 1.0.0: 初始版本
---

# DoD: thalamus.js 4 处稳定性 Bug 修复

## 验收清单

- [ ] BUG P1: processEvent(null) 返回 fallback decision，不 crash
  - Test: thalamus.test.js "processEvent returns fallback for null event"
- [ ] BUG P1: processEvent(undefined) 返回 fallback decision，不 crash
  - Test: thalamus.test.js "processEvent returns fallback for undefined event"
- [ ] BUG P3: callSonnet 空 content 数组时抛清晰错误（非 TypeError）
  - Test: thalamus.test.js "callSonnet throws clear error on empty content array"
- [ ] BUG P2: parseDecisionFromResponse 含多个 {} 块时正确解析 JSON
  - Test: thalamus.test.js "parseDecisionFromResponse handles multiple JSON blocks"
- [ ] BUG P4: cortexDecision.actions 为 null 时不抛 TypeError
  - Test: thalamus.test.js "cortex null actions does not throw TypeError"
- [ ] node scripts/facts-check.mjs 全通过（无 FAIL）
- [ ] bash scripts/check-version-sync.sh 全通过
- [ ] 所有现有测试通过（无回归）：npm test
- [ ] version bump patch

## Test 映射

| # | DoD 条目 | Test 映射 | 验证方式 |
|---|---------|-----------|---------|
| 1 | BUG P1: processEvent(null) 返回 fallback decision | brain/src/__tests__/thalamus.test.js - processEvent returns fallback for null event | 单元测试 |
| 2 | BUG P1: processEvent(undefined) 返回 fallback decision | brain/src/__tests__/thalamus.test.js - processEvent returns fallback for undefined event | 单元测试 |
| 3 | BUG P3: callSonnet 空 content 抛清晰错误 | brain/src/__tests__/thalamus.test.js - parseDecisionFromResponse handles multiple JSON blocks | 单元测试 |
| 4 | BUG P2: parseDecisionFromResponse 多 {} 块正确解析 | brain/src/__tests__/thalamus.test.js - parseDecisionFromResponse handles multiple JSON blocks | 单元测试 |
| 5 | BUG P4: cortexDecision.actions null 不抛 TypeError | brain/src/__tests__/thalamus.test.js - cortex null actions does not throw TypeError | 单元测试 |
