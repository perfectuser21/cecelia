# DoD - 最后 20% 稳定性硬护栏

QA: docs/QA-DECISION.md

## 验收标准

### 功能验收

#### P0 - 决策执行事务化
- [ ] 所有 action 执行在数据库事务中完成
      Test: brain/src/__tests__/decision-executor.test.js
- [ ] 失败时完全回滚，无脏状态
      Test: brain/src/__tests__/decision-executor.test.js

#### P0 - 危险动作两阶段提交
- [ ] 创建 pending_actions 表（007 迁移）
      Test: brain/src/__tests__/migrate.test.js
- [ ] dangerous=true 的 action 进入待审批队列
      Test: brain/src/__tests__/decision-executor.test.js
- [ ] GET /api/brain/pending-actions 返回待审批列表
      Test: brain/src/__tests__/routes.test.js
- [ ] POST /api/brain/pending-actions/:id/approve 批准执行
      Test: brain/src/__tests__/routes.test.js
- [ ] POST /api/brain/pending-actions/:id/reject 拒绝执行
      Test: brain/src/__tests__/routes.test.js

#### P1 - 系统性 vs 任务性失败分流
- [ ] classifyFailure() 正确分类 SYSTEMIC/TASK_SPECIFIC/UNKNOWN
      Test: brain/src/__tests__/quarantine.test.js
- [ ] 系统性失败时熔断派发，只允许诊断任务
      Test: brain/src/__tests__/tick.test.js

#### P1 - Alertness 衰减规则
- [ ] Score 每 10 分钟衰减 20%
      Test: brain/src/__tests__/alertness.test.js
- [ ] 恢复门槛：COMA→EMERGENCY (30min)，EMERGENCY→ALERT (15min)，ALERT→NORMAL (10min)
      Test: brain/src/__tests__/alertness.test.js

#### P2 - 事件风暴保护
- [ ] 事件积压超过 50 触发 event_backlog 信号
      Test: brain/src/__tests__/alertness.test.js

#### P2 - LLM 错误分开处理
- [ ] API 错误和输出错误分别统计
      Test: brain/src/__tests__/thalamus.test.js
- [ ] 不同错误类型触发不同保护行为
      Test: brain/src/__tests__/alertness.test.js

### 测试验收
- [ ] npm run test 全部通过
      Test: contract:brain-tests
- [ ] EXPECTED_SCHEMA_VERSION 更新为 '007'
      Test: brain/src/__tests__/selfcheck.test.js
