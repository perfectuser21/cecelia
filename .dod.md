# Definition of Done: 渐进式派发机制（Gradual Ramp-up）

## 验收清单

### 1. 实现 getRampedDispatchMax() 函数 ✓

**要求**：
- [ ] 从 working_memory 读取 dispatch_ramp_state
- [ ] 检查当前负载（checkServerResources, getCurrentAlertness）
- [ ] 根据 pressure 和 alertness 动态调整 rate
- [ ] 保存新 rate 到 working_memory
- [ ] 返回调整后的 rate（0 到 effectiveDispatchMax）

**Test**: `brain/src/__tests__/tick.test.js` - 单元测试

**Evidence**: 代码审查 `tick.js:754-815`

---

### 2. 在 executeTick() 中集成调用 ✓

**要求**：
- [ ] 在计算 effectiveDispatchMax 后调用 getRampedDispatchMax()
- [ ] 获取 rampedDispatchMax 值
- [ ] 用于后续派发逻辑

**Test**: 集成测试

**Evidence**: 代码审查 `tick.js:1141-1143`

---

### 3. 修改两处派发循环使用 rampedDispatchMax ✓

**要求**：
- [ ] 第一处循环（line 1150）改为 rampedDispatchMax
- [ ] 第二处循环（line 1179）改为 rampedDispatchMax
- [ ] 保持其他逻辑不变

**Test**: 集成测试

**Evidence**: 代码审查 `tick.js:1150, 1179`

---

### 4. 添加日志输出 ✓

**要求**：
- [ ] 记录 rate 变化（currentRate → newRate）
- [ ] 记录 pressure 和 alertness 值
- [ ] 记录调整原因

**Test**: 手动验证（Brain 日志）

**Evidence**: Docker logs 包含 "[tick] Ramped dispatch: X → Y"

---

### 5. 编写测试验证渐进增加逻辑 ✓

**要求**：
- [ ] 测试从 0 开始逐步增加
- [ ] 测试高负载时减速
- [ ] 测试 ALERT 时停止
- [ ] 测试低负载时加速

**Test**: `brain/src/__tests__/tick.test.js`

**Evidence**: 测试覆盖率报告

---

### 6. 回归测试 ✓

**要求**：
- [ ] Brain 核心测试套件全部通过
- [ ] Tick 相关测试通过
- [ ] GoldenPath E2E 测试通过

**Test**: `npm test` + CI pipeline

**Evidence**: CI 绿灯 ✅

---

### 7. 代码质量 ✓

**要求**：
- [ ] 代码符合项目风格
- [ ] 添加必要注释
- [ ] 无调试代码
- [ ] 无 ESLint 警告

**Test**: Lint checks (CI)

**Evidence**: `npm run lint` 通过

---

### 8. 版本管理 ✓

**要求**：
- [ ] Brain 版本号递增（patch）
- [ ] brain/package.json 更新
- [ ] brain/package-lock.json 同步
- [ ] .brain-versions 同步
- [ ] DEFINITION.md Brain 版本同步

**Test**: `scripts/check-version-sync.sh`

**Evidence**: Version sync check 通过

---

## 测试映射表

| DoD 项 | 测试文件 | 测试用例 |
|--------|----------|----------|
| getRampedDispatchMax | tick.test.js | test_ramp_dispatch_gradual_increase |
| 高负载减速 | tick.test.js | test_ramp_dispatch_high_pressure_slowdown |
| ALERT 停止 | tick.test.js | test_ramp_dispatch_alert_stop |
| 低负载加速 | tick.test.js | test_ramp_dispatch_low_pressure_speedup |
| 回归测试 | 所有测试 | npm test |

---

## 完成标准

**所有 ✓ 标记完成 AND CI 通过 = PR 可合并**

- [ ] 所有 DoD 项完成
- [ ] CI pipeline 绿灯
- [ ] PR approved by reviewer
- [ ] Branch protection rules satisfied
