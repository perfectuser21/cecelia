# DoD - 修复 OKR 拆解流程的 goal_id 关联

## 验收标准

### 功能验收

- [ ] 定位所有创建任务的函数
      Test: manual:代码审查确认所有函数已找到
      描述: 在 okr-tick.js 中找到所有创建任务的代码路径

- [ ] 修改 createTaskFromKR() 强制 goal_id
      Test: brain/src/__tests__/okr-tick.test.js
      描述: kr.id 缺失时抛出错误，有 kr.id 时正确设置

- [ ] 添加 validateTaskPayload() 验证函数
      Test: brain/src/__tests__/okr-tick.test.js
      描述: goal_id 缺失时抛出错误（除系统任务外）

- [ ] 实现 fixOrphanTasks() 数据修复脚本
      Test: manual:执行脚本并验证结果
      描述: 修复 491 个缺少 goal_id 的失败任务

- [ ] 所有创建任务的函数调用 validateTaskPayload()
      Test: brain/src/__tests__/okr-tick.test.js
      描述: 确保所有路径都经过验证

- [ ] project_id 警告但不阻止
      Test: brain/src/__tests__/okr-tick.test.js
      描述: project_id 缺失时记录警告但继续创建

### 数据修复验收

- [ ] 数据修复脚本成功执行
      Test: manual:运行 fixOrphanTasks() 并记录结果
      描述: 修复成功率 > 90%

- [ ] 修复后数据完整性验证
      Test: manual:查询数据库验证 goal_id 覆盖率
      描述: 失败任务 goal_id 覆盖率 > 95%

- [ ] 修复报告生成
      Test: manual:输出修复统计
      描述: 记录 fixed/skipped/total 数量

### 测试验收

- [ ] 单元测试：goal_id 强制关联
      Test: brain/src/__tests__/okr-tick.test.js
      描述: 测试 createTaskFromKR() 强制 goal_id

- [ ] 单元测试：验证逻辑
      Test: brain/src/__tests__/okr-tick.test.js
      描述: 测试 validateTaskPayload() 各种场景

- [ ] 集成测试：创建任务流程
      Test: brain/src/__tests__/okr-tick.test.js
      描述: 端到端测试 OKR 拆解创建任务

- [ ] CI 通过
      Test: contract:Version Check, Facts Consistency, Brain (Node.js)
      描述: 所有 CI 检查必须通过

### 监控验收

- [ ] 新任务 goal_id 覆盖率 100%
      Test: manual:观察 1 周新创建任务
      描述: 所有新任务都有 goal_id

- [ ] goal_id 缺失率 < 5%
      Test: manual:查询数据库统计
      描述: 从 98.2% 降到 < 5%

### 文档验收

- [ ] 代码注释完整
      Test: manual:代码审查确认注释清晰
      描述: 每个修改的函数都有注释说明

- [ ] 修复脚本使用文档
      Test: manual:检查是否有 README 或注释说明如何运行
      描述: 说明如何执行数据修复脚本
