# DoD - Plan Proposal 系统

QA: 需要单元测试覆盖约束层核心逻辑（DAG 检测、白名单验证、应用/回滚）

## 验收清单

| # | DoD 条目 | Test 映射 | 验证方式 |
|---|---------|-----------|----------|
| 1 | proposals 表已创建 | `proposal.test.js: creates proposal table` | DB schema |
| 2 | POST /api/brain/plan 创建提案 | `proposal.test.js: creates proposal via API` | API 测试 |
| 3 | 约束层拒绝非白名单动作 | `proposal.test.js: rejects invalid action type` | 单元测试 |
| 4 | DAG 环检测阻止循环依赖 | `proposal.test.js: detects dependency cycle` | 单元测试 |
| 5 | 审批后自动应用变更 | `proposal.test.js: applies changes on approve` | 单元测试 |
| 6 | 回滚恢复原始状态 | `proposal.test.js: rollback restores state` | 单元测试 |
| 7 | 批量变更(>5)要求审批 | `proposal.test.js: bulk changes require review` | 单元测试 |
| 8 | thalamus ACTION_WHITELIST 含 create_proposal | `grep create_proposal brain/src/thalamus.js` | 代码检查 |
| 9 | schema_version = 010 | `selfcheck.test.js: EXPECTED_SCHEMA_VERSION = 010` | 单元测试 |
| 10 | Brain 测试不回归 | `cd brain && npx vitest run` | 通过 |
| 11 | DevGate 全绿 | `node scripts/facts-check.mjs && bash scripts/check-version-sync.sh` | 退出码 0 |

## 测试验收

- [ ] `cd brain && npx vitest run` 全部通过（含新测试）
- [ ] `node scripts/facts-check.mjs` 全绿
- [ ] `bash scripts/check-version-sync.sh` 全绿
- [ ] `node scripts/devgate/check-dod-mapping.cjs` 全绿
