# DoD: 统一系统时区为北京时间

## 验收条件

### 1. Docker Compose 配置更新
- [ ] `docker-compose.yml` 添加 `TZ=Asia/Shanghai` 环境变量
- [ ] 挂载 `/etc/localtime` 和 `/etc/timezone` 到容器
- [ ] 配置语法正确，可正常启动

**Test**:
- 检查 docker-compose.yml 文件包含时区配置
- 运行 `docker compose config` 验证语法

### 2. Brain 容器时区正确
- [ ] 容器内 Node.js 显示 `GMT+0800 (China Standard Time)`
- [ ] 容器内 `date` 命令显示 CST 时间
- [ ] 环境变量 `TZ=Asia/Shanghai` 存在

**Test**:
- `docker exec cecelia-node-brain node -e "console.log(new Date().toString())"`
- `docker exec cecelia-node-brain date`
- `docker exec cecelia-node-brain env | grep TZ`

### 3. PostgreSQL 时区设置
- [ ] 数据库 timezone 设置为 `Asia/Shanghai`
- [ ] `SHOW timezone;` 返回 `Asia/Shanghai`
- [ ] `SELECT NOW()` 返回北京时间

**Test**:
- `docker exec cecelia-postgres psql -U cecelia -d cecelia -c "SHOW timezone;"`
- `docker exec cecelia-postgres psql -U cecelia -d cecelia -c "SELECT NOW();"`

### 4. Brain 健康检查
- [ ] Brain 容器启动成功
- [ ] 健康检查通过 (`/api/brain/health`)
- [ ] Tick 循环正常运行
- [ ] 无时区相关错误日志

**Test**:
- `docker ps | grep cecelia-node-brain` 显示 healthy
- `curl -sf http://localhost:5221/api/brain/health | jq .status` 返回 "healthy"
- `curl -sf http://localhost:5221/api/brain/tick/status | jq .loop_running` 返回 true

### 5. 配置持久化
- [ ] 容器重启后时区配置保持
- [ ] 数据库重连后时区配置保持

**Test**:
- `docker restart cecelia-node-brain` 后验证时区
- 重启 Brain 服务后验证数据库连接

## 回归测试

### Brain 核心功能
- [ ] Tick 循环正常执行
- [ ] 任务派发正常
- [ ] API 端点响应正常
- [ ] 日志时间戳正确

**Test**:
- 手动触发 tick: `curl -X POST localhost:5221/api/brain/tick`
- 检查任务队列: `curl -s localhost:5221/api/brain/tasks?status=in_progress`
- 检查日志: `docker logs cecelia-node-brain --tail 20`

### 时间显示一致性
- [ ] 宿主机、容器、数据库时间一致（相差 < 2 秒）
- [ ] API 返回的时间戳可正确转换为北京时间

**Test**:
```bash
echo "宿主机: $(date '+%Y-%m-%d %H:%M:%S')"
echo "容器: $(docker exec cecelia-node-brain date '+%Y-%m-%d %H:%M:%S')"
echo "数据库: $(docker exec cecelia-postgres psql -U cecelia -d cecelia -t -c 'SELECT NOW()::timestamp')"
```

## 非功能需求

- [ ] 修改不影响现有功能
- [ ] API 返回格式不变（仍为 UTC ISO 8601）
- [ ] 无性能影响
- [ ] 文档已更新
