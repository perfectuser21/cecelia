# DoD - 免疫系统 API 接口层

## 验收标准

### 1. Absorption Policies API

- [ ] GET /api/brain/policies 返回策略列表
      Test: brain/src/__tests__/immune-api.test.js

- [ ] GET /api/brain/policies 支持 status 过滤（draft/probation/active/disabled）
      Test: brain/src/__tests__/immune-api.test.js

- [ ] GET /api/brain/policies 支持分页（limit/offset）
      Test: brain/src/__tests__/immune-api.test.js

- [ ] GET /api/brain/policies/:id 返回单个策略详情
      Test: brain/src/__tests__/immune-api.test.js

- [ ] GET /api/brain/policies/:id 包含最近 10 次评估
      Test: brain/src/__tests__/immune-api.test.js

- [ ] GET /api/brain/policies/:id/evaluations 返回评估历史
      Test: brain/src/__tests__/immune-api.test.js

- [ ] PATCH /api/brain/policies/:id/status 更新策略状态
      Test: brain/src/__tests__/immune-api.test.js

- [ ] PATCH /api/brain/policies/:id/status 验证状态枚举
      Test: brain/src/__tests__/immune-api.test.js

### 2. Failure Signatures API

- [ ] GET /api/brain/failures/signatures 返回失败签名统计
      Test: brain/src/__tests__/immune-api.test.js

- [ ] GET /api/brain/failures/signatures 按 count 降序排序
      Test: brain/src/__tests__/immune-api.test.js

- [ ] GET /api/brain/failures/signatures 支持 limit 和 min_count 参数
      Test: brain/src/__tests__/immune-api.test.js

- [ ] GET /api/brain/failures/signatures/:signature 返回单个签名详情
      Test: brain/src/__tests__/immune-api.test.js

- [ ] GET /api/brain/failures/signatures/:signature 包含关联策略
      Test: brain/src/__tests__/immune-api.test.js

### 3. Promotion History API

- [ ] GET /api/brain/policies/promotions 返回晋升历史
      Test: brain/src/__tests__/immune-api.test.js

- [ ] GET /api/brain/policies/promotions 支持 days 参数
      Test: brain/src/__tests__/immune-api.test.js

- [ ] GET /api/brain/policies/promotions 包含 simulations 和 pass_rate
      Test: brain/src/__tests__/immune-api.test.js

### 4. Dashboard API

- [ ] GET /api/brain/immune/dashboard 返回策略统计
      Test: brain/src/__tests__/immune-api.test.js

- [ ] GET /api/brain/immune/dashboard 返回隔离区统计
      Test: brain/src/__tests__/immune-api.test.js

- [ ] GET /api/brain/immune/dashboard 返回 Top 10 失败签名
      Test: brain/src/__tests__/immune-api.test.js

- [ ] GET /api/brain/immune/dashboard 返回最近晋升记录
      Test: brain/src/__tests__/immune-api.test.js

### 5. 错误处理

- [ ] 所有 API 返回统一格式 { success, data/error }
      Test: brain/src/__tests__/immune-api.test.js

- [ ] 404 错误：策略/签名不存在时返回 404
      Test: brain/src/__tests__/immune-api.test.js

- [ ] 400 错误：参数验证失败时返回 400
      Test: brain/src/__tests__/immune-api.test.js

- [ ] 500 错误：数据库错误时返回 500
      Test: brain/src/__tests__/immune-api.test.js

### 6. 测试验收

- [ ] 所有单元测试通过（npm test）
      Test: contract:immune-api-tests

- [ ] Brain 服务能成功启动并响应
      Test: manual:本地启动 Brain，curl 测试 API

- [ ] 所有 API 端点在 Postman/curl 中验证通过
      Test: manual:逐个 API curl 验证

### 7. CI 验收

- [ ] Version Check CI 通过
      Test: contract:CI-version-check

- [ ] Facts Consistency CI 通过
      Test: contract:CI-facts-check

- [ ] Brain (Node.js) CI 通过
      Test: contract:CI-brain-tests

---

## 实现检查清单

### 代码实现

- [ ] brain/src/routes.js 添加所有新 API 路由
      Test: code-review

- [ ] 所有 API 路由正确挂载到 Express app
      Test: brain/src/__tests__/immune-api.test.js

### 测试实现

- [ ] brain/src/__tests__/immune-api.test.js 创建完成
      Test: exists

- [ ] Mock pool.query 返回测试数据
      Test: brain/src/__tests__/immune-api.test.js

- [ ] 至少 20+ 测试用例覆盖所有 API
      Test: brain/src/__tests__/immune-api.test.js

### 文档更新

- [ ] DEFINITION.md 版本号更新（1.28.0 → 1.29.0）
      Test: scripts/facts-check.mjs

- [ ] .brain-versions 同步更新
      Test: scripts/check-version-sync.sh

---

## 验收流程

1. **本地验证**
   - 运行 `npm test` - 所有测试通过
   - 启动 Brain - 服务正常运行
   - curl 测试 - 所有 API 返回正确格式

2. **PR 提交**
   - DoD 映射检查通过
   - Version Check 通过
   - Facts Consistency 通过

3. **CI 验证**
   - 所有 CI checks 绿色
   - 没有 lint 错误
   - 没有测试失败

4. **合并条件**
   - CI 全部通过
   - develop 分支最新
   - 无合并冲突
