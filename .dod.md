# DoD - Cecelia Core 可观测性系统 v1.1.1

## 验收标准

### Phase 1: 数据模型

- [ ] run_events 表创建成功
      Test: brain/src/__tests__/trace.test.js

- [ ] run_artifacts 表创建成功
      Test: brain/src/__tests__/trace.test.js

- [ ] v_active_runs 视图可查询
      Test: brain/src/__tests__/trace.test.js

- [ ] v_run_summary 视图可查询
      Test: brain/src/__tests__/trace.test.js

- [ ] v_run_last_alive_span 视图可查询
      Test: brain/src/__tests__/trace.test.js

- [ ] v_top_failure_reasons 视图可查询
      Test: brain/src/__tests__/trace.test.js

- [ ] detect_stuck_runs() 函数可调用
      Test: brain/src/__tests__/trace.test.js

- [ ] cleanup_expired_runs() 函数可调用
      Test: brain/src/__tests__/trace.test.js

### Phase 2: SDK 实现

- [ ] trace.js 文件创建
      Test: brain/src/__tests__/trace.test.js

- [ ] sanitize() 函数脱敏功能正常
      Test: brain/src/__tests__/trace.test.js

- [ ] classifyError() 分类正确（TRANSIENT/PERSISTENT/RESOURCE/CONFIG）
      Test: brain/src/__tests__/trace.test.js

- [ ] storeArtifact() 存储 artifact_id
      Test: brain/src/__tests__/trace.test.js

- [ ] withSpan() 自动 wrapper 功能正常
      Test: brain/src/__tests__/trace.test.js

- [ ] traceStep.start() 写入 run_events 表
      Test: brain/src/__tests__/trace.test.js

- [ ] traceStep.heartbeat() 更新 heartbeat_ts
      Test: brain/src/__tests__/trace.test.js

- [ ] traceStep.end() 更新状态和输出
      Test: brain/src/__tests__/trace.test.js

### Phase 3: API 端点

- [ ] routes/trace.js 文件创建
      Test: brain/src/__tests__/routes-trace.test.js

- [ ] GET /api/brain/trace/runs/active 可访问
      Test: brain/src/__tests__/routes-trace.test.js

- [ ] GET /api/brain/trace/runs/:run_id 可访问
      Test: brain/src/__tests__/routes-trace.test.js

- [ ] GET /api/brain/trace/runs/:run_id/last-alive 可访问
      Test: brain/src/__tests__/routes-trace.test.js

- [ ] GET /api/brain/trace/failures/top 可访问
      Test: brain/src/__tests__/routes-trace.test.js

- [ ] GET /api/brain/trace/stuck 可访问
      Test: brain/src/__tests__/routes-trace.test.js

- [ ] GET /api/brain/trace/artifacts/:id 代理功能正常
      Test: brain/src/__tests__/routes-trace.test.js

- [ ] server.js 集成 trace routes
      Test: manual:检查 server.js 包含 app.use('/api/brain/trace')

### Phase 4: Executor 集成（示例）

- [ ] executor.js 使用 withSpan()
      Test: manual:检查 executor.js dispatch 函数

- [ ] dispatch 时写入 run_events 表
      Test: brain/src/__tests__/executor-trace.test.js

- [ ] 有 run_id、layer、step_name 记录
      Test: brain/src/__tests__/executor-trace.test.js

### Phase 5: 测试覆盖

- [ ] trace.js 单元测试覆盖率 > 80%
      Test: contract:RCI-TRACE-001

- [ ] API 端点测试覆盖所有路由
      Test: contract:RCI-TRACE-002

- [ ] 集成测试验证 executor → run_events 流程
      Test: contract:RCI-TRACE-003

### CI 检查

- [ ] npm test 通过
      Test: contract:C2-001

- [ ] DevGate 检查通过（DoD 映射、RCI 覆盖率）
      Test: contract:DEVGATE-001

- [ ] Facts Check 通过（版本同步）
      Test: contract:VERSION-SYNC

## 硬边界约定（v1.1.1）

### 代码规范

- [ ] run_id 只在 L0 生成，下游继承
      Test: manual:代码审查

- [ ] 每次执行生成新 span_id
      Test: manual:代码审查

- [ ] artifacts 永远是 {type}_id: uuid 格式
      Test: brain/src/__tests__/trace.test.js

- [ ] executor_host 使用标准枚举
      Test: manual:检查 .env.docker 配置

- [ ] reason_code 来自枚举或 CHECK 约束
      Test: brain/src/__tests__/trace.test.js

### 数据库约束

- [ ] idx_run_events_run_activity 索引存在
      Test: brain/src/__tests__/trace.test.js

- [ ] idx_run_events_status_layer 索引存在
      Test: brain/src/__tests__/trace.test.js

- [ ] idx_run_events_task_run 索引存在
      Test: brain/src/__tests__/trace.test.js

## 非目标（本 PR 不做）

- ❌ Frontend Dashboard（可后续 PR）
- ❌ GC 调度配置（可后续 PR）
- ❌ 改造所有 Brain 代码使用 trace（只改 executor.js 示例）

## 参考文档

- `.observability-implementation-plan.md` - v1.0 方案
- `.observability-v1.1-implementation.md` - v1.1 实施文档
- `.observability-v1.1.1-conventions.md` - v1.1.1 硬边界约定
