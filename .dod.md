# DoD - Cortex 持久记忆系统

## 验收标准

### 数据库验收
- [ ] `cortex_analyses` 表创建成功，Schema version 008→009
      Test: brain/migrations/009_cortex_analyses.sql
- [ ] 表结构包含所有必要字段（root_cause, contributing_factors, mitigations, learnings, strategy_adjustments）
      Test: brain/src/__tests__/cortex-memory.test.js
- [ ] 索引创建成功（task_id, created_at, trigger_event_type, failure_pattern）
      Test: manual:查询 \d cortex_analyses

### 持久化验收
- [ ] `saveCortexAnalysis()` 函数实现并导出
      Test: brain/src/__tests__/cortex-memory.test.js
- [ ] `performRCA()` 完成后自动调用 saveCortexAnalysis()
      Test: brain/src/__tests__/cortex.test.js
- [ ] 分析结果正确保存到数据库，包含完整字段
      Test: brain/src/__tests__/cortex-memory.test.js

### 查询验证
- [ ] `searchRelevantAnalyses()` 函数实现语义检索
      Test: brain/src/__tests__/cortex-memory.test.js
- [ ] 相关性评分正确（failure_class=10, task_type=8, event_type=6, freshness=1-3）
      Test: brain/src/__tests__/cortex-memory.test.js
- [ ] 按相关性分数降序排序
      Test: brain/src/__tests__/cortex-memory.test.js

### API 验证
- [ ] GET /api/brain/cortex/analyses?task_id=xxx 返回正确数据
      Test: brain/src/__tests__/cortex-memory.test.js
- [ ] GET /api/brain/cortex/analyses?failure_class=xxx 返回正确数据
      Test: brain/src/__tests__/cortex-memory.test.js
- [ ] GET /api/brain/cortex/analyses/:id 返回单个分析详情
      Test: brain/src/__tests__/cortex-memory.test.js

### 集成验证
- [ ] `cortex.js` analyzeDeep() 查询历史分析并注入 prompt
      Test: brain/src/__tests__/cortex.test.js
- [ ] 历史分析在 Opus prompt context 中可见
      Test: manual:观察 Cortex 日志输出

### 测试验证
- [ ] 所有现有测试通过（771 tests）
      Test: contract:C2-001
- [ ] 新增测试覆盖所有持久化和查询场景（至少 15 个新测试）
      Test: brain/src/__tests__/cortex-memory.test.js
