---
id: dod-patrol-agent-m2
version: 1.0.0
created: 2026-01-29
updated: 2026-01-29
changelog:
  - 1.0.0: Initial version
---

# DoD: Patrol Agent M2 - cecelia-patrol Script

## Acceptance Checklist

### Script `/home/xx/bin/cecelia-patrol`

- [x] Script is executable (chmod +x)
- [x] Help text with `--help`
- [x] Single patrol with no args
- [x] Daemon mode with `--daemon`
- [x] Dry-run mode with `--dry-run`

### Core Functions

- [x] `fetch_runs()` - Get runs from Core API
- [x] `find_stuck_runs()` - Filter stuck runs (>10 min)
- [x] `diagnose_run()` - Determine diagnosis type
- [x] `decide_action()` - Map diagnosis to action
- [x] `execute_action()` - Execute recovery action
- [x] `patrol_once()` - Output patrol report

### Diagnosis Logic

- [x] Detect process_dead (ps -p $pid)
- [x] Detect ci_timeout (step=9, >30 min)
- [x] Detect stuck_after_skill (log analysis)
- [x] Detect needs_human (fallback)
- [x] Return normal for healthy runs

### Action Logic

- [x] restart: Kill + cecelia-run
- [x] continue: New process to continue
- [x] mark_human: Update Core + notify
- [x] none: No action for normal runs

### Dry-Run Mode

- [x] --dry-run shows what would happen
- [x] --dry-run does NOT execute actions
- [x] --dry-run does NOT modify state

### Daemon Mode

- [x] --daemon runs continuously
- [x] 10-minute interval between patrols (PATROL_INTERVAL env)
- [x] Graceful shutdown with SIGTERM

### Output Format

- [x] JSON output for machine parsing
- [x] Human-readable summary to stderr
- [x] Log actions to ~/logs/cecelia-patrol.log

### Integration

- [x] Works with Core API (:5212)
- [x] Works with existing cecelia-run
- [x] No breaking changes

### Testing

- [x] Script runs without errors
- [x] --dry-run works correctly
- [x] --help text is clear
- [ ] CI passes
- [ ] PR merged to develop
