# DoD - Fix PORT Environment Variable Support in Brain Server

## 验收标准

### 功能验收

- [ ] server.js 优先读取 PORT 环境变量（const PORT = process.env.PORT || process.env.BRAIN_PORT || 5221）
      Test: manual:检查 brain/src/server.js line 16 代码改动

- [ ] 向后兼容 BRAIN_PORT 环境变量（当 PORT 未设置时仍然有效）
      Test: manual:检查代码逻辑：PORT → BRAIN_PORT → 5221

- [ ] 默认端口 5221（当 PORT 和 BRAIN_PORT 都未设置时）
      Test: manual:检查代码默认值

### 版本验收

- [ ] package.json 版本从 1.39.0 升级到 1.39.1
      Test: manual:检查 brain/package.json version 字段

- [ ] package-lock.json 版本同步更新
      Test: manual:npm version 自动同步

- [ ] .brain-versions 文件包含 1.39.1
      Test: manual:检查文件内容为单行 1.39.1

- [ ] DEFINITION.md 中 Brain 版本更新为 1.39.1
      Test: contract:CI-version-check

### 测试验收

- [ ] 本地测试通过（brain 目录）
      Test: brain/src/__tests__/server.test.js (如存在) 或 manual:npm test

- [ ] CI 测试通过（Brain (Node.js) job）
      Test: contract:CI-brain-tests

- [ ] Version Check CI 通过
      Test: contract:CI-version-check

- [ ] Facts Consistency CI 通过（DEFINITION.md 同步检查）
      Test: contract:CI-facts-check

### 集成验收

- [ ] rolling-update.sh 能正确启动 green 容器（PORT=5222）
      Test: manual:执行 rolling-update.sh，观察 green 容器健康检查通过

- [ ] green 容器成功绑定到 5222 端口（无 EADDRINUSE 错误）
      Test: manual:docker logs cecelia-node-brain-green，无端口冲突错误

- [ ] blue 容器继续正常运行（5221 端口）
      Test: manual:curl http://localhost:5221/api/brain/health 返回 200

### 文档验收

- [ ] LEARNINGS.md 记录本次 bug 发现和修复过程
      Test: contract:RCI-dev-learning

## 测试策略

### 手动测试流程

```bash
# 1. 验证代码改动
cat brain/src/server.js | grep -A 1 "const PORT"

# 2. 验证版本同步
cat brain/package.json | jq -r .version
cat .brain-versions
grep "Brain 版本" DEFINITION.md

# 3. 本地测试
cd brain && npm test

# 4. 构建新镜像
bash scripts/brain-build.sh

# 5. 测试 rolling update
bash scripts/rolling-update.sh

# 6. 验证 green 容器健康
curl http://localhost:5222/api/brain/health

# 7. 验证 blue 容器不受影响
curl http://localhost:5221/api/brain/health
```

## 完成条件

**所有验收标准勾选完成 + CI 通过 + PR 合并到 develop**
