# DoD - Connect Immune System Last Mile

## 验收标准

### 功能验收

#### 1. 策略调整读取与应用

- [ ] config-loader.js 创建并导出 readBrainConfig() 函数
      Test: brain/src/__tests__/config-loader.test.js
- [ ] readBrainConfig() 能读取 brain_config 表中的值
      Test: brain/src/__tests__/config-loader.test.js
- [ ] readBrainConfig() 在记录不存在时返回 defaultValue
      Test: brain/src/__tests__/config-loader.test.js
- [ ] tick.js 或相关模块调用 readBrainConfig() 读取配置
      Test: manual:代码审查 tick.js 或 alertness.js
- [ ] 策略调整后，新值能被系统读取并使用
      Test: brain/src/__tests__/config-loader.test.js

#### 2. 重试策略使用

- [ ] executor.js requeueTask() 读取 failure_classification.retry_strategy
      Test: brain/src/__tests__/executor-retry-strategy.test.js
- [ ] 优先使用 retry_strategy.next_run_at 而不是硬编码退避
      Test: brain/src/__tests__/executor-retry-strategy.test.js
- [ ] BILLING_CAP 失败使用 retry_strategy 的 reset_time
      Test: brain/src/__tests__/executor-retry-strategy.test.js
- [ ] RATE_LIMIT 失败使用 retry_strategy 的指数退避
      Test: brain/src/__tests__/executor-retry-strategy.test.js
- [ ] 没有 retry_strategy 时 fallback 到原有逻辑
      Test: brain/src/__tests__/executor-retry-strategy.test.js

#### 3. Token Bucket 调用

- [ ] tick.js dispatchNextTask() 调用 tryConsumeToken('dispatch')
      Test: brain/src/__tests__/tick-token-bucket.test.js
- [ ] allowed=false 时跳过 dispatch 并记录原因
      Test: brain/src/__tests__/tick-token-bucket.test.js
- [ ] allowed=true 时正常 dispatch
      Test: brain/src/__tests__/tick-token-bucket.test.js
- [ ] token 消耗后 remaining 减少
      Test: brain/src/__tests__/tick-token-bucket.test.js

### 代码质量验收

- [ ] 所有新增函数有 JSDoc 注释
      Test: manual:代码审查
- [ ] 所有新增代码通过 ESLint 检查
      Test: contract:C2-001
- [ ] 向后兼容（没有配置时使用默认值）
      Test: brain/src/__tests__/config-loader.test.js

### 测试验收

- [ ] config-loader 测试通过（5+ tests）
      Test: brain/src/__tests__/config-loader.test.js
- [ ] executor retry strategy 测试通过（5+ tests）
      Test: brain/src/__tests__/executor-retry-strategy.test.js
- [ ] tick token bucket 测试通过（4+ tests）
      Test: brain/src/__tests__/tick-token-bucket.test.js
- [ ] 所有现有测试仍然通过（819 tests）
      Test: contract:C2-001

### 文档验收

- [ ] LEARNINGS.md 记录开发经验
      Test: manual:文档审查

### 版本同步验收

- [ ] brain/package.json 版本 1.22.0 → 1.22.1
      Test: contract:C3-001
- [ ] brain/package-lock.json 版本同步
      Test: contract:C3-001
- [ ] .brain-versions 版本同步
      Test: contract:C3-001
- [ ] brain/VERSION 文件同步
      Test: contract:C3-001
- [ ] DEFINITION.md 版本同步
      Test: contract:C3-001
