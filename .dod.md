# DoD: Immune System v1 - P2 (Cortex JSON + Validator)

## Phase 1: Validator Core

### 代码改动
- [ ] `brain/src/policy-validator.js` 导出 5 个函数/常量 | Test: brain/src/__tests__/policy-validator.test.js > exports
- [ ] `validatePolicyJson()` 函数实现完整 | Test: brain/src/__tests__/policy-validator.test.js > validatePolicyJson
- [ ] `isValidAction()` 函数实现 | Test: brain/src/__tests__/policy-validator.test.js > isValidAction
- [ ] `getRequiredParams()` 函数实现 | Test: brain/src/__tests__/policy-validator.test.js > getRequiredParams
- [ ] `ALLOWED_ACTIONS` 常量导出 | Test: brain/src/__tests__/policy-validator.test.js > constants
- [ ] `ACTION_PARAMS_SCHEMA` 常量导出 | Test: brain/src/__tests__/policy-validator.test.js > constants

### 验证逻辑
- [ ] Schema 验证：必需字段存在（action, params, expected_outcome, confidence, reasoning） | Test: brain/src/__tests__/policy-validator.test.js > missing required fields
- [ ] Action 验证：只允许 4 种 action（requeue, skip, adjust_params, kill） | Test: brain/src/__tests__/policy-validator.test.js > invalid action
- [ ] Params 验证：根据 action 类型检查必需参数 | Test: brain/src/__tests__/policy-validator.test.js > invalid params for each action
- [ ] Confidence 验证：0-1 范围，< 0.5 warning | Test: brain/src/__tests__/policy-validator.test.js > confidence validation
- [ ] Reasoning 验证：非空，20-500 字符建议 | Test: brain/src/__tests__/policy-validator.test.js > reasoning validation

### Normalization
- [ ] 默认值填充（requeue.priority='normal', skip.reason='No reason provided'） | Test: brain/src/__tests__/policy-validator.test.js > normalization

### 测试覆盖
- [ ] 36+ 测试用例全部通过 | Test: brain/src/__tests__/policy-validator.test.js > all tests pass
- [ ] Constants validation 测试 | Test: brain/src/__tests__/policy-validator.test.js > constants
- [ ] Valid policies (4 action types) 测试 | Test: brain/src/__tests__/policy-validator.test.js > valid policies
- [ ] Missing required fields 测试 | Test: brain/src/__tests__/policy-validator.test.js > missing fields
- [ ] Invalid action types 测试 | Test: brain/src/__tests__/policy-validator.test.js > invalid action
- [ ] Invalid params (每种 action) 测试 | Test: brain/src/__tests__/policy-validator.test.js > invalid params
- [ ] Confidence validation 测试 | Test: brain/src/__tests__/policy-validator.test.js > confidence
- [ ] Reasoning validation 测试 | Test: brain/src/__tests__/policy-validator.test.js > reasoning
- [ ] JSON parsing 测试 | Test: brain/src/__tests__/policy-validator.test.js > json parsing
- [ ] Normalization 测试 | Test: brain/src/__tests__/policy-validator.test.js > normalization

---

## Phase 2: Cortex Integration

### 代码改动
- [ ] `brain/src/cortex.js` 添加 import validatePolicyJson | Test: brain/src/__tests__/cortex.test.js > imports
- [ ] Cortex Prompt 添加 Policy JSON Schema 说明 | Test: manual:检查 CORTEX_PROMPT 包含 absorption_policy 说明
- [ ] `storeAbsorptionPolicy()` 函数实现 | Test: brain/src/__tests__/cortex.test.js > storeAbsorptionPolicy
- [ ] `analyzeDeep()` 集成 absorption_policy 处理 | Test: brain/src/__tests__/cortex.test.js > analyzeDeep with policy

### Validation 逻辑
- [ ] 调用 validatePolicyJson(policyJson, { strict: true }) | Test: brain/src/__tests__/cortex.test.js > strict validation
- [ ] Validation 失败时 log 到 cecelia_events (event_type='policy_validation_failed') | Test: brain/src/__tests__/cortex.test.js > validation failure logging
- [ ] Validation 成功时存储到 absorption_policies (status='draft') | Test: brain/src/__tests__/cortex.test.js > policy storage
- [ ] Validation 成功时 log 到 cecelia_events (event_type='policy_created') | Test: brain/src/__tests__/cortex.test.js > policy creation logging

### 测试覆盖
- [ ] storeAbsorptionPolicy() 验证有效 policy | Test: brain/src/__tests__/cortex.test.js > valid policy
- [ ] storeAbsorptionPolicy() 拒绝无效 policy | Test: brain/src/__tests__/cortex.test.js > invalid policy
- [ ] Validation failure 记录到 cecelia_events | Test: brain/src/__tests__/cortex.test.js > event logging
- [ ] Normalization 应用默认值 | Test: brain/src/__tests__/cortex.test.js > normalization
- [ ] Strict mode 拒绝低置信度 | Test: brain/src/__tests__/cortex.test.js > low confidence rejection
- [ ] 支持所有 4 种 action 类型 | Test: brain/src/__tests__/cortex.test.js > all action types

---

## Phase 3: Monitor Loop Validation

### 代码改动
- [ ] `brain/src/monitor-loop.js` 添加 import validatePolicyJson | Test: brain/src/__tests__/monitor-loop.test.js > imports
- [ ] Probation policy 读取后添加验证 | Test: brain/src/__tests__/monitor-loop.test.js > probation validation
- [ ] Validation 失败时跳过 policy + log warning | Test: brain/src/__tests__/monitor-loop.test.js > skip invalid policy
- [ ] Validation 失败时记录到 cecelia_events (event_type='probation_policy_validation_failed') | Test: brain/src/__tests__/monitor-loop.test.js > validation failure logging

### 测试覆盖
- [ ] Probation policy 验证通过继续 simulate | Test: brain/src/__tests__/monitor-loop.test.js > valid policy simulate
- [ ] Probation policy 验证失败跳过 | Test: brain/src/__tests__/monitor-loop.test.js > invalid policy skip
- [ ] 验证失败记录到 cecelia_events | Test: brain/src/__tests__/monitor-loop.test.js > event logging

---

## 版本同步

- [ ] `brain/package.json` 版本保持 1.27.0 (P2 是 P1 的延续) | Test: scripts/check-version-sync.sh
- [ ] `brain/package-lock.json` 同步 | Test: scripts/check-version-sync.sh
- [ ] `.brain-versions` 同步 | Test: scripts/check-version-sync.sh
- [ ] `DEFINITION.md` Brain 版本同步 | Test: scripts/check-version-sync.sh
- [ ] `brain/src/selfcheck.js` EXPECTED_SCHEMA_VERSION 保持 025 | Test: brain/src/__tests__/selfcheck.test.js

---

## CI DevGate 要求

### DoD 映射检查
- [ ] 每条 DoD 有对应的 Test 字段 | Test: scripts/devgate/check-dod-mapping.cjs

### 质量门禁

#### 本地测试
- [ ] 所有单元测试通过（npm test in brain/） | Test: contract:Brain-tests-pass
- [ ] Validator 测试：36+ 测试通过 | Test: brain/src/__tests__/policy-validator.test.js
- [ ] Cortex 测试：6+ 测试通过 | Test: brain/src/__tests__/cortex.test.js
- [ ] Monitor Loop 测试：3+ 测试通过 | Test: brain/src/__tests__/monitor-loop.test.js

#### CI 检查
- [ ] Version Check 通过 | Test: contract:GitHub-Actions-version-check
- [ ] Facts Consistency 通过 | Test: contract:GitHub-Actions-facts-check
- [ ] Brain (Node.js) 通过 | Test: contract:GitHub-Actions-brain-tests
- [ ] Semantic Brain (Python) 通过 | Test: contract:GitHub-Actions-semantic-brain-tests

---

## 产物清单

### 代码文件（3 个）
- [ ] `brain/src/policy-validator.js` - 核心验证模块（~180 行） | Test: manual:文件存在且行数 > 150
- [ ] `brain/src/cortex.js` - Cortex 集成（修改现有文件） | Test: manual:git diff 显示添加 storeAbsorptionPolicy
- [ ] `brain/src/monitor-loop.js` - Monitor Loop 验证（修改现有文件） | Test: manual:git diff 显示添加 probation validation

### 测试文件（3 个）
- [ ] `brain/src/__tests__/policy-validator.test.js` - Validator 测试套件（36+ 测试） | Test: manual:文件存在且测试数量 >= 36
- [ ] `brain/src/__tests__/cortex.test.js` - Cortex 测试更新（6+ 新测试） | Test: manual:git diff 显示添加 storeAbsorptionPolicy 测试
- [ ] `brain/src/__tests__/monitor-loop.test.js` - Monitor Loop 测试更新（3+ 新测试） | Test: manual:git diff 显示添加 probation validation 测试

---

## 验收标准总结

### 功能完整性
- [ ] Validator 提供完整的 policy JSON schema 验证 | Test: contract:Validator-functional
- [ ] Cortex 生成 policy 前验证，存储时记录事件 | Test: contract:Cortex-validation-functional
- [ ] Monitor Loop 读取 probation policy 时验证，跳过无效策略 | Test: contract:MonitorLoop-validation-functional
- [ ] 所有 validation 结果记录到 cecelia_events | Test: brain/src/__tests__/*.test.js > event logging tests

### 测试完整性
- [ ] 45+ 单元测试覆盖所有函数和边界条件 | Test: contract:Test-count-45-plus
- [ ] 每个 phase 有独立测试套件 | Test: manual:检查 3 个测试文件都存在

### 代码质量
- [ ] 无 lint 错误 | Test: manual:eslint 通过
- [ ] 所有函数有 JSDoc 注释 | Test: manual:检查函数注释
- [ ] SQL 查询使用参数化（防止注入） | Test: manual:检查 SQL 查询无字符串拼接
- [ ] 错误处理完整（try-catch + logging） | Test: manual:检查 try-catch 块

### 可观测性
- [ ] Validation 失败 log 包含详细错误信息 | Test: manual:检查 console.error 调用
- [ ] Event logging 包含 timestamp, policy_id, validation_errors | Test: manual:检查 cecelia_events payload 格式
- [ ] Probation validation 失败输出 warning log | Test: manual:检查 console.warn 调用

---

## 预期测试数量

- **Phase 1**: 36 个测试（policy-validator.test.js）
- **Phase 2**: 6 个测试（cortex.test.js 新增）
- **Phase 3**: 3 个测试（monitor-loop.test.js 新增）
- **总计**: 45 个新测试

---

## 成功指标

1. **功能验证**：手动调用 validatePolicyJson() → 验证返回格式正确
2. **Cortex 集成验证**：Mock Cortex 生成 policy → 验证存储到 absorption_policies
3. **Monitor Loop 验证**：插入 invalid probation policy → 验证跳过 + 记录事件
4. **CI 通过**：所有 GitHub Actions checks 绿灯
