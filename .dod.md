# DoD: OKR 拆解质量治理 (v1.59.0)

## 验收清单

### P0-1: 拆解深度限制
- [ ] D1: migration 049 — projects 表新增 decomposition_depth 列（integer, default 0），填充现有数据
- [ ] D2: decomposition-checker.js — depth >= 2 时禁止创建子 initiative，只产出 dev task

### P0-2: 任务描述质量门控
- [ ] D3: task-quality-gate.js — validateTaskDescription() 检查 description >= 100 字符 + 包含关键词
- [ ] D4: decomposition-checker.js — 创建 task 时调用质量门控，不合格的 reject

### P1-1: Dev Task 完成必须有 PR
- [ ] D5: routes.js execution-callback — dev task completed 无 pr_url 时 status 改为 completed_no_pr

### P1-2: KR 进度自动更新
- [ ] D6: kr-progress.js — updateKrProgress(pool, krId) 计算并更新 goals.progress
- [ ] D7: initiative-closer.js — 关闭 initiative 后调用 KR 进度更新
- [ ] D8: tick.js — 每小时同步 KR 进度

### P2: 积压清理
- [ ] D9: migration 049 — 清理无子实体的 pending projects/initiatives 为 archived

### 版本
- [ ] D10: selfcheck.js EXPECTED_SCHEMA_VERSION 048 → 049
- [ ] D11: 版本号 v1.58.0 → v1.59.0（feat: minor bump）

## Test 映射

| DoD | Test 文件 | Test 名称 |
|-----|-----------|-----------|
| D1 | decomp-depth.test.js | migration sets correct depth for existing projects |
| D2 | decomp-depth.test.js | depth >= 2 blocks sub-initiative creation |
| D2 | decomp-depth.test.js | depth >= 2 allows dev task creation |
| D3 | task-quality-gate.test.js | rejects description shorter than 100 chars |
| D3 | task-quality-gate.test.js | accepts valid description with keywords |
| D3 | task-quality-gate.test.js | rejects description missing action keywords |
| D4 | task-quality-gate.test.js | integration: decomp-checker uses quality gate |
| D5 | completed-no-pr.test.js | dev task completed without PR → completed_no_pr |
| D5 | completed-no-pr.test.js | dev task completed with PR → completed |
| D5 | completed-no-pr.test.js | exploratory task completed without PR → completed (allowed) |
| D6 | kr-progress.test.js | calculates progress from initiative completion ratio |
| D6 | kr-progress.test.js | handles zero initiatives gracefully |
| D7 | kr-progress.test.js | initiative-closer triggers KR progress update |
| D8 | kr-progress.test.js | tick calls KR progress sync hourly |
| D9 | (migration verified by selfcheck) | schema version matches 049 |
| D10 | selfcheck.test.js | EXPECTED_SCHEMA_VERSION is 049 |
