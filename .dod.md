# DoD - Alertness 响应动作系统

## 功能完整性

### 1. 新文件创建
- [ ] `brain/src/alertness-actions.js` - 响应动作执行器
  - Test: `brain/src/__tests__/alertness-actions.test.js`

### 2. Notification（通知）
- [ ] 实现 `notifyAlert(level, signals)` 函数
- [ ] 控制台输出带颜色警告
- [ ] 记录到 `cecelia_events` 表
  - Test: 验证通知被正确记录

### 3. Escalation（升级分析）
- [ ] 实现 `escalateToAnalysis(signals)` 函数
- [ ] 调用 Cortex RCA 分析（有 fallback）
- [ ] 创建 RCA 任务到数据库
  - Test: 验证 Cortex 被调用、任务被创建

### 4. Auto-Mitigation（自动缓解）
- [ ] 实现 `applyMitigation(signals)` 函数
- [ ] 暂停 P2 任务派发（标记到内存状态）
- [ ] 清理僵尸进程（调用 executor.cleanupOrphanProcesses）
  - Test: 验证 P2 任务被暂停、僵尸进程被清理

### 5. Shutdown Safety（关机保护）
- [ ] 实现 `activateShutdownSafety(signals)` 函数
- [ ] 启用 drain mode（调用 tick.setDrainMode）
- [ ] 保存状态检查点到数据库
  - Test: 验证 drain mode 被启用、检查点被保存

### 6. Recovery（恢复）
- [ ] 实现 `recoverFromLevel(fromLevel, toLevel)` 函数
- [ ] 不同降级路径的恢复逻辑
- [ ] 清理限制状态
  - Test: 验证所有限制被正确清除

### 7. 主入口
- [ ] 实现 `executeResponseActions(fromLevel, toLevel, signals)` 函数
- [ ] 根据等级变化调用正确的响应动作
- [ ] 异常处理和日志记录
  - Test: 验证等级转换触发正确响应

## 集成点

### 8. alertness.js 集成
- [ ] 在 `setLevel()` 中调用 `executeResponseActions()`
- [ ] 传递正确的参数（fromLevel, toLevel, signals）
  - Test: `brain/src/__tests__/alertness-response-integration.test.js`

## 代码质量

### 9. 错误处理
- [ ] 所有异步调用有 try-catch
- [ ] 失败不影响 alertness 评估
- [ ] 错误记录到日志

### 10. 代码规范
- [ ] 所有函数有 JSDoc 注释
- [ ] 导出清晰的 API
- [ ] 无 console.log（使用结构化日志）

## 测试要求

### 11. 单元测试
- [ ] `alertness-actions.test.js` - 每个响应动作独立测试
- [ ] 测试覆盖率 > 90%

### 12. 集成测试
- [ ] `alertness-response-integration.test.js` - 等级转换触发测试
- [ ] 测试所有等级转换路径（0→1, 1→2, 2→3, 降级路径）

### 13. 边界测试
- [ ] 相同等级不触发响应
- [ ] 降级触发恢复
- [ ] 异常情况处理（Cortex 失败、数据库失败等）

## CI 检查

### 14. 测试通过
- [ ] 所有新测试通过
- [ ] 所有现有测试仍通过
- [ ] npm test 无失败

### 15. 代码检查
- [ ] 无 lint 错误
- [ ] 无 TypeScript 类型错误（如有 .d.ts）

### 16. 版本管理
- [ ] 版本号正确递增（1.13.2 → 1.14.0）
- [ ] VERSION 文件同步
- [ ] DEFINITION.md 更新

## 文档

### 17. 代码文档
- [ ] 所有导出函数有 JSDoc
- [ ] 复杂逻辑有内联注释

### 18. 项目文档
- [ ] 更新 ALERTNESS_ANALYSIS.md（补充响应动作章节）
- [ ] 更新 DEFINITION.md（如需要）

## 验收标准

### E2E 场景

**场景 1：NORMAL → ALERT**
```
给定：系统处于 NORMAL 状态
当：信号分数达到 25
则：
  - 等级升级到 ALERT
  - 控制台输出警告
  - cecelia_events 记录通知
```

**场景 2：ALERT → EMERGENCY**
```
给定：系统处于 ALERT 状态
当：信号分数达到 55
则：
  - 等级升级到 EMERGENCY
  - Cortex RCA 被触发
  - P2 任务暂停派发
  - 僵尸进程被清理
```

**场景 3：EMERGENCY → COMA**
```
给定：系统处于 EMERGENCY 状态
当：信号分数达到 85
则：
  - 等级升级到 COMA
  - drain mode 启用
  - 状态检查点保存
  - 控制台输出 COMA 警告
```

**场景 4：COMA → NORMAL 恢复**
```
给定：系统处于 COMA 状态
当：信号分数衰减回 15
则：
  - 等级逐步降回 NORMAL
  - 每次降级输出恢复日志
  - 所有限制清除
  - dispatch 恢复正常
```
