---
id: brain-attach-decision-implementation
version: 1.0.0
created: 2026-02-12
type: feature
priority: P1
estimated_hours: 12
---

# Brain Attachment Decision API 实现

## 目标

实现 Brain 挂载决策 API，让新任务自动找到最合适的挂载点（OKR/Initiative/Task）。

## 背景

当前问题：
- 用户提交新任务时，不知道应该挂载在哪里
- 可能重复创建已存在的任务
- 可能在错误的 Initiative 下创建新 PR Plan
- 没有自动化的相似度匹配机制

## 成功标准

### 1. Similarity Service 实现

**文件**: `brain/src/similarity.js`

**功能**:
- 查询所有活跃实体（Tasks/Initiatives/KRs）
- 计算相似度（Jaccard + 关键词加权 + 状态惩罚）
- 返回 top_k 匹配结果

**输入**:
```javascript
searchSimilar(query, topK = 5)
```

**输出**:
```javascript
{
  matches: [
    {
      level: 'task|initiative|kr|okr',
      id: 'uuid',
      title: 'string',
      status: 'string',
      score: 0.0-1.0,
      metadata: {...}
    }
  ]
}
```

### 2. API Routes

**文件**: `brain/src/routes.js` (添加新 routes)

**端点 1**: `POST /api/brain/search-similar`
```json
Request: {"query": "...", "top_k": 5}
Response: {"matches": [...]}
```

**端点 2**: `POST /api/brain/attach-decision`
```json
Request: {
  "input": "...",
  "matches": [...],
  "context": {...}
}
Response: {
  "attach": {...},
  "route": {...},
  "next_call": {...}
}
```

### 3. LLM Decision Prompt

**文件**: `brain/src/prompts/attach-decision.md`

- 4 种挂载决策的完整提示词
- 短路规则（Task >= 0.85, Initiative >= 0.65）
- 路由决策（exploratory vs direct_dev）
- 统一 JSON 输出格式

### 4. 依赖安装

添加到 `package.json`:
```json
{
  "dependencies": {
    "natural": "^7.0.7"
  }
}
```

## 技术方案

### Phase 0 (本次实现)

使用简单相似度算法：

1. **Jaccard 相似度**: `intersection / union` of tokens
2. **关键词加权**: 提取关键词，匹配时 +0.1
3. **状态惩罚**: completed task -0.1

不使用复杂的 embeddings（Phase 1 再考虑）。

### 数据查询

查询 3 个层级的活跃实体：

```sql
-- Tasks (最近 100 条)
SELECT t.id, t.title, t.description, t.status,
       pp.initiative_id, i.title as initiative_title
FROM tasks t
LEFT JOIN pr_plans pp ON t.pr_plan_id = pp.id
LEFT JOIN features i ON pp.initiative_id = i.id
WHERE t.status IN ('pending', 'in_progress', 'completed')
ORDER BY t.updated_at DESC LIMIT 100

-- Initiatives (最近 50 条)
SELECT i.id, i.title, i.description, i.status,
       kr.id as kr_id, kr.title as kr_title
FROM features i
LEFT JOIN key_results kr ON i.kr_id = kr.id
WHERE i.status IN ('active', 'in_progress')
ORDER BY i.updated_at DESC LIMIT 50

-- KRs (最近 30 条)
SELECT kr.id, kr.title, kr.description, kr.status,
       o.id as okr_id, o.objective
FROM key_results kr
LEFT JOIN okrs o ON kr.okr_id = o.id
WHERE kr.status IN ('active', 'in_progress')
ORDER BY kr.updated_at DESC LIMIT 30
```

### 短路规则

```javascript
// 1. 先查 Task（避免重复最致命）
if (task_score >= 0.85) {
  return { action: 'duplicate_task', target: task }
}

// 2. 再查 Initiative（决定扩展还是新建）
if (initiative_score >= 0.65) {
  return { action: 'extend_initiative', target: initiative }
}

// 3. 查 KR/OKR
if (kr_score >= 0.60) {
  return { action: 'create_initiative_under_kr', target: kr }
}

// 4. 都没找到，创建新的
return { action: 'create_new_okr_kr' }
```

## 文件清单

### 新建文件

1. `brain/src/similarity.js` - Similarity Service
2. `brain/src/prompts/attach-decision.md` - LLM Prompt（从 docs 复制）

### 修改文件

1. `brain/src/routes.js` - 添加 2 个新端点
2. `brain/package.json` - 添加 `natural` 依赖
3. `brain/package-lock.json` - npm install 后自动更新

### 测试文件

1. `brain/src/__tests__/similarity.test.js` - Similarity Service 单元测试
2. `brain/src/__tests__/attach-decision-routes.test.js` - API Routes 测试

## 测试计划

### 单元测试

```javascript
// similarity.test.js
describe('SimilarityService', () => {
  test('should calculate Jaccard similarity', () => {
    const service = new SimilarityService(mockDb);
    const score = service.calculateScore(
      '实现任务优先级算法',
      { text: '实现优先级计算算法' }
    );
    expect(score).toBeGreaterThan(0.7);
  });

  test('should extract keywords correctly', () => {
    const service = new SimilarityService(mockDb);
    const keywords = service.extractKeywords('实现任务优先级算法');
    expect(keywords).toContain('任务');
    expect(keywords).toContain('优先级');
    expect(keywords).toContain('算法');
  });

  test('should apply status penalty for completed tasks', () => {
    // ...
  });
});
```

### 集成测试

```bash
# 启动 Brain
cd /home/xx/perfect21/cecelia/core/brain
npm run dev

# 测试 search-similar
curl -X POST http://localhost:5221/api/brain/search-similar \
  -H "Content-Type: application/json" \
  -d '{"query": "实现任务优先级算法", "top_k": 5}'

# 测试 attach-decision
curl -X POST http://localhost:5221/api/brain/attach-decision \
  -H "Content-Type: application/json" \
  -d '{
    "input": "添加任务优先级的动态调整功能",
    "matches": [...],
    "context": {"user": "test", "mode": "interactive"}
  }'
```

## DoD (Definition of Done)

- [x] `similarity.js` 实现完成
- [x] 单元测试覆盖率 > 80%
- [x] API routes 添加到 `routes.js`
- [x] API 集成测试通过
- [x] `natural` 依赖安装成功
- [x] LLM Prompt 从 docs 复制到 `prompts/`
- [x] 代码通过 CI（linter, tests）
- [x] PR 合并到 develop

## 参考文档

- `docs/brain-attach-decision-api.md` - API 设计文档
- `docs/HIERARCHY-RULES.md` - 系统层级规则
- `docs/okr-exploratory-dev-simplified.md` - 工作流说明

## 依赖

- Brain 数据库必须有以下表：
  - `tasks` (with pr_plan_id)
  - `pr_plans` (with initiative_id, project_id)
  - `features` (Initiative 层，with kr_id)
  - `key_results` (with okr_id)
  - `okrs`

- 数据库 migration 检查：
  ```bash
  psql $DATABASE_URL -c "\d tasks"
  psql $DATABASE_URL -c "\d pr_plans"
  psql $DATABASE_URL -c "\d features"
  ```

## 风险

1. **性能问题**: 每次查询需要扫描大量实体（100+50+30）
   - 缓解：设置合理的 LIMIT
   - 后续优化：添加索引、缓存

2. **相似度不准**: Phase 0 使用简单算法
   - 缓解：阈值可调整（0.85/0.65/0.60）
   - 后续优化：Phase 1 升级到 embeddings

3. **LLM 决策失败**: Anthropic API 可能超时/失败
   - 缓解：添加 retry 机制
   - 降级：返回默认决策（create_new_okr_kr）

## 时间估算

- Similarity Service 实现: 3h
- API Routes 实现: 2h
- LLM Prompt 集成: 2h
- 单元测试: 2h
- 集成测试: 2h
- CI 修复: 1h

**总计**: 12h
