---
id: cecelia-architecture
version: 1.0.0
created: 2026-01-29
updated: 2026-01-29
changelog:
  - 1.0.0: 初始版本
---

# Cecelia 系统架构

## 角色定义

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   Cecelia (塞西莉亚)                                                         │
│   ══════════════════                                                        │
│   嘴巴 · 入口层                                                              │
│   - 语音输入 (实时对话)                                                       │
│   - 文本输入 (聊天框)                                                         │
│   - CLI 输入 (命令行)                                                         │
│   本质: 无头 Claude Code (轻量模型)                                           │
│   职责: 解析意图 → 写 Request → 激活管家                                      │
│                                                                             │
│          │                                                                  │
│          ▼                                                                  │
│                                                                             │
│   Autumnrice (秋米)                                                          │
│   ═════════════════                                                         │
│   管家 · 调度层                                                              │
│   本质: 无头 Claude Code + /orchestrator Skill                               │
│   职责:                                                                     │
│   - 接收 Request                                                            │
│   - 拆解 TRD → Tasks                                                        │
│   - 调度派发                                                                 │
│   - tick 推进状态机                                                          │
│   - 生成 blocker card                                                       │
│                                                                             │
│          │                                                                  │
│     ┌────┴────┐                                                             │
│     ▼         ▼                                                             │
│                                                                             │
│   Caramel (焦糖)              Nobel (诺贝)                                   │
│   ═══════════════             ════════════                                  │
│   编程肌肉                     自动化肌肉                                     │
│   本质: 无头 CC + /dev         本质: N8N Workflow                            │
│   职责:                        职责:                                         │
│   - 写代码                     - 执行自动化流程                               │
│   - 跑测试                     - 触发外部任务                                 │
│   - 提 PR                      - 数据同步                                    │
│   - 修 CI                      - 通知推送                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 数据流

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐                                     │
│  │  语音   │   │  文本   │   │   CLI   │     ← 输入形式                       │
│  └────┬────┘   └────┬────┘   └────┬────┘                                     │
│       │             │             │                                          │
│       └─────────────┼─────────────┘                                          │
│                     │                                                        │
│                     ▼                                                        │
│              ┌──────────────┐                                                │
│              │   Cecelia    │  解析意图                                       │
│              │    (嘴巴)    │  写 Request                                     │
│              └──────┬───────┘                                                │
│                     │                                                        │
│                     ▼                                                        │
│              ┌──────────────┐                                                │
│              │   Core API   │  存储 Request                                  │
│              │     (DB)     │  TRD / Task / Run                              │
│              └──────┬───────┘                                                │
│                     │                                                        │
│        ┌────────────┼────────────┐                                           │
│        │            │            │                                           │
│        ▼            ▼            ▼                                           │
│   ┌─────────┐  ┌─────────┐  ┌─────────┐                                      │
│   │ 主动线  │  │ 被动线  │  │ Webhook │   ← 触发方式                          │
│   │ (你说话)│  │ (tick)  │  │ (事件)  │                                       │
│   └────┬────┘  └────┬────┘  └────┬────┘                                      │
│        │            │            │                                           │
│        └────────────┼────────────┘                                           │
│                     │                                                        │
│                     ▼                                                        │
│              ┌──────────────┐                                                │
│              │  Autumnrice  │  规划拆解                                       │
│              │    (管家)    │  调度派发                                       │
│              └──────┬───────┘                                                │
│                     │                                                        │
│            ┌────────┴────────┐                                               │
│            ▼                 ▼                                               │
│     ┌──────────────┐  ┌──────────────┐                                       │
│     │   Caramel    │  │    Nobel     │                                       │
│     │   (焦糖)     │  │   (诺贝)     │                                        │
│     │  CC + /dev   │  │  N8N Worker  │                                       │
│     └──────┬───────┘  └──────┬───────┘                                       │
│            │                 │                                               │
│            ▼                 ▼                                               │
│     ┌──────────────┐  ┌──────────────┐                                       │
│     │     PR       │  │   自动化     │   ← 产出                              │
│     │   CI 通过    │  │   任务完成   │                                        │
│     └──────────────┘  └──────────────┘                                       │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

## 主动线 vs 被动线

### 主动线（你触发）

```
你说话 / 你输入 / 你敲命令
        │
        ▼
   Cecelia 解析
        │
        ▼
   写 Request 到 DB
        │
        ▼
   激活 Autumnrice
        │
        ▼
   拆解 → 调度 → Worker 执行
```

**特点**: 你主动触发，秒级响应

### 被动线（静默运行）

```
n8n / cron 定时 tick
        │
        ▼
   唤醒 Autumnrice
        │
        ├── 检查依赖解锁
        ├── 派发 ready 任务
        ├── 重试 failed 任务
        ├── 检查 PR/CI 状态
        └── 生成 blocker card
        │
        ▼
   更新 DB 状态
        │
        ▼
   通知推送（如有需要）
```

**特点**: 你不用管，后台自动推进

## 状态机

### TRD (技术需求文档)

```
         ┌─────────────────────────────────┐
         │                                 │
         ▼                                 │
┌───────────────┐    ┌───────────────┐    │
│     DRAFT     │───▶│    PLANNED    │    │
│    (草稿)     │    │   (已规划)    │    │
└───────────────┘    └───────┬───────┘    │
                             │            │
                             ▼            │
                     ┌───────────────┐    │
                     │  IN_PROGRESS  │────┘
                     │   (执行中)    │
                     └───────┬───────┘
                             │
              ┌──────────────┼──────────────┐
              ▼              ▼              ▼
      ┌───────────┐  ┌───────────┐  ┌───────────┐
      │   DONE    │  │  BLOCKED  │  │ CANCELLED │
      │  (完成)   │  │  (阻塞)   │  │  (取消)   │
      └───────────┘  └───────────┘  └───────────┘
```

### Task (任务)

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  QUEUED  │───▶│ ASSIGNED │───▶│ RUNNING  │───▶│   DONE   │
│ (排队中) │    │ (已分配) │    │ (执行中) │    │  (完成)  │
└──────────┘    └──────────┘    └────┬─────┘    └──────────┘
     ▲                               │
     │                               ▼
     │                         ┌──────────┐
     │         retry           │  FAILED  │
     └─────────────────────────│  (失败)  │
       (retry_count < max)     └──────────┘
```

### Run (执行记录)

```
┌──────────┐
│ RUNNING  │
│ (执行中) │
└────┬─────┘
     │
     ├───────────────┬───────────────┬───────────────┐
     ▼               ▼               ▼               ▼
┌─────────┐   ┌─────────┐   ┌─────────┐   ┌───────────┐
│ SUCCESS │   │ FAILED  │   │ TIMEOUT │   │ CANCELLED │
│ (成功)  │   │ (失败)  │   │ (超时)  │   │  (取消)   │
└─────────┘   └─────────┘   └─────────┘   └───────────┘

注意: Run 只写不回退，Task 可以重试产生新 Run
```

## 边界责任

### Cecelia (嘴巴) 做什么

- ✅ 接收语音/文本/CLI 输入
- ✅ 解析用户意图
- ✅ 写 Request 到 DB
- ✅ 激活管家
- ✅ 播报结果/通知
- ❌ 不做规划
- ❌ 不做调度
- ❌ 不写代码

### Autumnrice (管家) 做什么

- ✅ 接收 Request
- ✅ 调用 LLM 拆解 TRD → Tasks
- ✅ 管理状态机转换
- ✅ 调度派发任务给 Worker
- ✅ tick 推进（重试、解锁、检查）
- ✅ 生成 blocker card
- ❌ 不直接写代码
- ❌ 不一直在线（被唤起执行完就退出）

### Caramel (焦糖) 做什么

- ✅ 接收 Task
- ✅ 执行 /dev workflow
- ✅ 写代码、跑测试
- ✅ 提 PR、修 CI
- ✅ 回报结果 (Run complete)
- ❌ 不做调度
- ❌ 不做规划

### Nobel (诺贝) 做什么

- ✅ 接收自动化任务
- ✅ 执行 N8N workflow
- ✅ 数据同步、通知推送
- ✅ 触发外部系统
- ❌ 不写代码
- ❌ 不做规划

### 静默线 (n8n tick) 做什么

- ✅ 定时触发（每 N 秒）
- ✅ 调用 Autumnrice tick
- ✅ 监听 webhook 事件
- ❌ 不做决策（决策由 Autumnrice 做）
- ❌ 不是 Claude（是定时器/事件监听器）

## API 端点

```
Core API (状态存储)
├── POST /orchestrator/v2/trd              创建 TRD
├── POST /orchestrator/v2/trd/:id/plan     规划 TRD → Tasks
├── GET  /orchestrator/v2/next             获取下一个可执行 Task
├── POST /orchestrator/v2/tasks/:id/start  开始执行 Task
├── POST /orchestrator/v2/runs/:id/complete 完成 Run
├── POST /orchestrator/v2/tick             推进状态机
├── POST /orchestrator/v2/workers          注册 Worker
└── GET  /orchestrator/v2/summary          获取概览
```

## 关键原则

1. **状态外置**: 所有状态存 DB，Claude 不保留长期记忆
2. **原子动作**: 每次唤起只做一件事，做完退出
3. **结构化输出**: Claude 输出必须是 JSON，可校验
4. **可恢复**: 任何步骤失败都能从 DB 恢复继续
5. **不常驻**: 没有"一直在线的 Claude"，只有被唤起的 Claude

## 一句话总结

> **Cecelia 接收输入 → Autumnrice 规划调度 → Caramel/Nobel 执行 → 静默线持续推进**
