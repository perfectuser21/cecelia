---
id: dod-whitelist-analysis
version: 1.0.0
created: 2026-02-17
updated: 2026-02-17
changelog:
  - 1.0.0: 初始版本 - 丘脑白名单覆盖率分析报告
---

# 丘脑 ACTION_WHITELIST 覆盖率分析报告

**分析时间**: 2026-02-17
**分析范围**: thalamus.js ACTION_WHITELIST + 历史 DB 数据
**数据时间窗口**: 近 30 天

---

## 一、当前 ACTION_WHITELIST（21 个）

```json
{
  "current_actions": [
    {"type": "dispatch_task",       "category": "task",   "description": "派发任务",                "dangerous": false},
    {"type": "create_task",         "category": "task",   "description": "创建任务",                "dangerous": false},
    {"type": "cancel_task",         "category": "task",   "description": "取消任务",                "dangerous": false},
    {"type": "retry_task",          "category": "task",   "description": "重试任务",                "dangerous": false},
    {"type": "reprioritize_task",   "category": "task",   "description": "调整优先级",              "dangerous": false},
    {"type": "pause_task",          "category": "task",   "description": "暂停任务",                "dangerous": false},
    {"type": "resume_task",         "category": "task",   "description": "恢复任务",                "dangerous": false},
    {"type": "mark_task_blocked",   "category": "task",   "description": "标记任务为阻塞",          "dangerous": false},
    {"type": "quarantine_task",     "category": "task",   "description": "隔离任务",                "dangerous": true},
    {"type": "create_okr",          "category": "okr",    "description": "创建 OKR",               "dangerous": false},
    {"type": "update_okr_progress", "category": "okr",    "description": "更新 OKR 进度",           "dangerous": false},
    {"type": "assign_to_autumnrice","category": "okr",    "description": "交给秋米拆解",            "dangerous": false},
    {"type": "notify_user",         "category": "notify", "description": "通知用户",                "dangerous": false},
    {"type": "log_event",           "category": "system", "description": "记录事件",                "dangerous": false},
    {"type": "escalate_to_brain",   "category": "system", "description": "升级到 Brain LLM (Opus)", "dangerous": false},
    {"type": "request_human_review","category": "system", "description": "请求人工确认",            "dangerous": true},
    {"type": "analyze_failure",     "category": "system", "description": "分析失败原因",            "dangerous": false},
    {"type": "predict_progress",    "category": "okr",    "description": "预测进度（未实现）",       "dangerous": false},
    {"type": "create_proposal",     "category": "system", "description": "创建计划提案",            "dangerous": false},
    {"type": "no_action",           "category": "system", "description": "不需要操作",              "dangerous": false},
    {"type": "fallback_to_tick",    "category": "system", "description": "降级到纯代码 Tick",       "dangerous": false}
  ]
}
```

**分类统计**:
- task 类: 9 个（dispatch/create/cancel/retry/reprioritize/pause/resume/mark_blocked/quarantine）
- okr 类: 4 个（create/update_progress/assign_autumnrice/predict_progress）
- system 类: 6 个（log_event/escalate/request_human/analyze_failure/create_proposal/fallback_to_tick/no_action）
- notify 类: 1 个（notify_user）

---

## 二、Cortex 额外白名单（3 个）

Cortex (Opus 皮层) 有额外 3 个 ACTION，继承 thalamus 所有 + 以下：

| type | dangerous | description |
|------|-----------|-------------|
| `adjust_strategy` | ✅ true | 调整系统策略参数（有完整的安全限制） |
| `record_learning` | false | 记录学习到的经验 |
| `create_rca_report` | false | 创建根因分析报告 |

**关键差异**: `adjust_strategy` 和 `record_learning` 等学习类 Actions 只有 Cortex 能用，丘脑无法独立完成。

---

## 三、历史数据分析

### 3.1 路由决策分布（近 7 天）

| route_type | event_type | count | 说明 |
|------------|------------|-------|------|
| quick_route | tick | 2,816 | 常规 Tick，全部走快速路由 |
| llm_route | - | 0 | **LLM 路由从未触发** |
| cortex_route | - | 0 | **Cortex 路由从未触发** |
| fallback_route | - | 0 | **Fallback 路由从未触发** |

**关键发现**: 系统近期所有路由决策均走 `quick_route`，LLM 层（丘脑/皮层）从未被调用。

### 3.2 任务隔离原因统计（全部历史）

| 隔离原因 | 次数 | 比例 |
|---------|------|------|
| repeated_failure | 1,161 | 40.0% |
| resource_hog | 866 | 29.8% |
| timeout_pattern | 288 | 9.9% |
| manual | 287 | 9.9% |
| unknown_reason | 144 | 5.0% |
| suspicious_input | 144 | 5.0% |

**关键发现**: `repeated_failure` 是最主要的隔离原因，但丘脑没有专门的 action 来区分**失败原因类别**然后决策（如网络失败 vs 代码错误 vs 环境问题）。

### 3.3 其他关键指标

| 指标 | 数值 | 说明 |
|------|------|------|
| 熔断触发次数 | 455 | 均因 failure_threshold_reached |
| LLM API 错误 | 247 | 全部来自 Cortex，事件类型为 rca_request |
| task_quarantined | 2,890 | 隔离后需要大量人工干预（287 次 manual） |
| task_released | 2,134 | 释放次数接近隔离次数，效率较好 |
| decision_log 0-actions | 高频 | Tick 产生的决策均为 0 actions |

---

## 四、覆盖缺口识别

### 4.1 quickRoute 场景 vs 白名单覆盖分析

**已覆盖场景** (quickRoute 中有对应处理):

| 场景 | quickRoute 动作 | 白名单覆盖 |
|------|----------------|-----------|
| HEARTBEAT | no_action | ✅ |
| TICK (正常) | fallback_to_tick | ✅ |
| TASK_COMPLETED (无异常) | dispatch_task | ✅ |
| TASK_FAILED (简单/重试未超限) | retry_task | ✅ |
| TASK_FAILED (重试超限) | cancel_task | ✅ |
| TASK_TIMEOUT | log_event + retry_task | ✅ |
| TASK_CREATED | no_action | ✅ |

**未覆盖/需要 LLM 路由的场景** (quickRoute 返回 null):

| 场景 | 当前处理 | 问题 |
|------|---------|------|
| TASK_FAILED + complex_reason | → Sonnet (LLM) | LLM 从未被触发 → 实际上在 Tick 代码层处理 |
| USER_MESSAGE | → Sonnet | 没有快速路由 |
| USER_COMMAND | → Sonnet | 没有快速路由 |
| OKR_CREATED | → Sonnet | 没有快速路由 |
| OKR_PROGRESS_UPDATE | → Sonnet | 没有快速路由 |
| OKR_BLOCKED | → Sonnet | 没有快速路由 |
| RESOURCE_LOW | → Sonnet | 没有快速路由 |
| DEPARTMENT_REPORT | → Sonnet | 没有快速路由 |
| EXCEPTION_REPORT | → Sonnet | 没有快速路由 |

---

## 五、缺失 Actions 识别

### 5.1 【高优先级】需要新增的 Actions

#### P1: `reset_circuit_breaker`
- **类别**: system
- **场景**: 熔断器触发了 455 次，但没有 action 可以让丘脑主动重置熔断器（当前只能靠代码自动 half-open）
- **价值**: 让丘脑能在分析确认安全后主动恢复熔断，而不是被动等待 30s 自动半开
- **dangerous**: false（已有电路保护）

#### P2: `update_task_metadata`
- **类别**: task
- **场景**: 当任务失败时，丘脑无法在不改变 status 的情况下更新任务的 `payload`（如记录失败类别、错误码）
- **价值**: 支持丰富的任务状态跟踪，便于后续分析
- **dangerous**: false

#### P3: `release_quarantine` (解除隔离)
- **类别**: task
- **场景**: task_released 有 2,134 次，但丘脑没有 action 能主动判断并释放隔离区任务。目前只有自动时间到期释放
- **价值**: 让丘脑在观察到系统恢复时，主动释放合适的隔离任务
- **dangerous**: false (但需要验证)

#### P4: `batch_cancel_tasks`
- **类别**: task
- **场景**: 当熔断发生或资源紧缺时，需要批量取消低优先级任务。目前只有单个 cancel_task
- **价值**: 减少 escalate_to_brain 的使用频率（当前 escalate_to_brain 实现是创建一个 talk 类型任务，效率低）
- **dangerous**: true（影响范围大）

#### P5: `adjust_alertness_level`
- **类别**: system
- **场景**: 丘脑观察到异常（多次隔离/熔断频发）时，没有 action 能主动调整系统警觉等级（ALERTNESS_LEVEL）
- **价值**: 让丘脑参与警觉等级调整，而不是只由脑干代码控制
- **dangerous**: true（影响全局派发行为）

#### P6: `defer_task`（延迟任务）
- **类别**: task
- **场景**: 没有"推迟到特定时间"的 action。当前 pause_task 是无限暂停，无法设置恢复时间
- **价值**: 支持定时任务、夜间批处理等场景
- **dangerous**: false

### 5.2 【中优先级】优化建议

#### `analyze_failure` 实现未完成
- 当前实现仅创建一个 research 类型任务（`task_type: 'research'`），而 research 类型没有对应的 agent（见 tick.js TASK_TYPE_AGENT_MAP: `'research': null`）
- 这意味着 `analyze_failure` 创建的任务永远不会被派发 → **dead action**

#### `predict_progress` 未实现
- 代码注释 `// TODO: 实现进度预测逻辑`，直接返回 `prediction: 'not_implemented'`
- 应该移除或实现

#### `escalate_to_brain` 效率问题
- 当前实现是创建一个 talk 类型任务进队列，等待被派发 → 高延迟
- escalate 的本质应该是同步调用 Cortex，而非异步排队

---

## 六、分析结论

```json
{
  "summary": {
    "total_whitelist_actions": 21,
    "cortex_extra_actions": 3,
    "total_actions": 24,
    "llm_route_usage_7d": 0,
    "quick_route_usage_7d": 2816,
    "llm_utilization_rate": "0%",
    "top_quarantine_reason": "repeated_failure (40%)",
    "circuit_breaker_triggers_30d": 455,
    "dead_actions": ["analyze_failure (创建的 research 任务无 agent)", "predict_progress (TODO 未实现)"]
  },
  "missing_actions": [
    {
      "type": "reset_circuit_breaker",
      "category": "system",
      "use_case": "熔断器触发后 (455次)，丘脑主动分析并在安全时重置，而不是被动等待自动半开",
      "dangerous": false,
      "priority": "high"
    },
    {
      "type": "update_task_metadata",
      "category": "task",
      "use_case": "任务失败时记录失败类别、错误码到 payload，不改变 status，用于后续分析",
      "dangerous": false,
      "priority": "high"
    },
    {
      "type": "release_quarantine",
      "category": "task",
      "use_case": "系统恢复后主动释放适合的隔离任务（当前 2134 次 task_released 均为自动时间触发）",
      "dangerous": false,
      "priority": "medium"
    },
    {
      "type": "batch_cancel_tasks",
      "category": "task",
      "use_case": "熔断/资源紧缺时批量取消低优先级任务，减少 escalate_to_brain 触发频率",
      "dangerous": true,
      "priority": "medium"
    },
    {
      "type": "adjust_alertness_level",
      "category": "system",
      "use_case": "让丘脑参与警觉等级调整（当前仅由脑干代码控制）",
      "dangerous": true,
      "priority": "medium"
    },
    {
      "type": "defer_task",
      "category": "task",
      "use_case": "将任务推迟到指定时间，支持定时任务和夜间批处理（当前 pause_task 无时间限制）",
      "dangerous": false,
      "priority": "low"
    }
  ],
  "defective_actions": [
    {
      "type": "analyze_failure",
      "issue": "创建 task_type=research 的任务，但 research 在 TASK_TYPE_AGENT_MAP 中 value=null，任务永远不会被派发",
      "fix": "改为 task_type=dev 或实现 research agent"
    },
    {
      "type": "predict_progress",
      "issue": "TODO 未实现，直接返回 not_implemented",
      "fix": "实现或从白名单移除"
    },
    {
      "type": "escalate_to_brain",
      "issue": "实现为创建 talk 任务入队列（高延迟），而非同步触发 Cortex",
      "fix": "改为直接调用 cortex.analyzeDeep() 或触发同步决策"
    }
  ],
  "recommendations": "1. 优先修复 analyze_failure 的 dead-action 问题（research 任务无 agent），这是当前最直接的缺陷。2. 新增 reset_circuit_breaker 和 update_task_metadata，覆盖高频系统场景（熔断 455次）。3. LLM 路由从未触发（0次）说明 quickRoute 覆盖了所有实际场景，丘脑 LLM 能力未被利用 — 应考虑扩展 EVENT_TYPES 以利用 LLM 决策能力（如 OKR_BLOCKED、RESOURCE_LOW 等场景）。4. 移除或实现 predict_progress，避免白名单中有无效 action。"
}
```

---

## 七、后续建议任务

基于分析结果，建议创建以下 dev tasks：

1. **[BUG] 修复 analyze_failure dead-action** — 将 task_type 从 research 改为 dev，或实现 research agent 路由
2. **[FEAT] 新增 reset_circuit_breaker action** — 丘脑主动重置熔断器
3. **[FEAT] 新增 update_task_metadata action** — 支持在不改变 status 的情况下更新任务 payload
4. **[REFACTOR] 修复 escalate_to_brain 实现** — 改为同步触发 Cortex，而非创建异步任务

---

*本报告由 /exploratory 技能生成，基于代码静态分析 + DB 历史数据查询。*
