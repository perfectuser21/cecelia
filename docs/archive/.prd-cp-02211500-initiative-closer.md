---
id: prd-cp-02211500-initiative-closer
version: 1.0.0
created: 2026-02-21
updated: 2026-02-21
changelog:
  - 1.0.0: 初始版本
---

# PRD: Initiative 闭环检查器 (cp-02211500)

## 背景

Cecelia Brain 中，`projects` 表存储 Initiative（type='initiative'）。每个 Initiative 下有多个 tasks，tasks.project_id 指向 Initiative。

**问题**：Initiative 的 status 永远停在 `in_progress`，即使它下面所有 Tasks 都完成了。

## 目标

实现 `checkInitiativeCompletion(pool)` 函数，每次 tick 时自动检查并关闭已完成的 Initiative。

## 功能描述

### checkInitiativeCompletion(pool)

1. 查所有 `type='initiative' AND status='in_progress'` 的 projects
2. 对每个 initiative，查它下面的 tasks 状态分布（group by status）
3. 如果：total > 0 AND queued = 0 AND in_progress = 0（没有飞行中的任务）→ 标记完成
4. UPDATE projects SET status='completed', completed_at=NOW() WHERE id=...
5. INSERT INTO cecelia_events (event_type='initiative_completed', payload=...)
6. 返回关闭的 initiative 数量

### 前置 Migration (045)

projects 表缺少 `completed_at` 字段，需要添加：
```sql
ALTER TABLE projects ADD COLUMN IF NOT EXISTS completed_at TIMESTAMPTZ;
```

### tick.js 集成

在 Section 0.8 调用 `checkInitiativeCompletion(pool)`：
- 每次 tick 都检查（SQL 轻量，无 LLM）
- log 输出：`[TICK] Initiative 完成检查: X 个已关闭`

## 成功标准

- Initiative 下所有 tasks 完成后，Initiative 自动变为 completed 状态
- 有飞行中任务（queued/in_progress）的 Initiative 不被提前关闭
- 空 Initiative（无 tasks）不被误关
- 每次 tick 日志有 `[TICK] Initiative 完成检查` 输出

## 技术约束

- 无 LLM 调用，纯 SQL 逻辑
- 非阻塞：发生错误不影响 tick 主流程
- Schema version: 044 → 045

## 版本

- 当前版本：v1.53.5
- 目标版本：v1.54.0（minor bump，feat）
