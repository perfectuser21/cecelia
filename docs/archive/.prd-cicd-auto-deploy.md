---
id: cicd-auto-deploy
version: 1.0.0
created: 2026-02-19
updated: 2026-02-19
changelog:
  - 1.0.0: 初始版本
---

# PRD: CI/CD 自动部署 — develop push 后自动 SSH 部署

## 背景

当前 `develop` 分支 PR 合并后，需要手动在 US VPS 上运行 `bash scripts/brain-deploy.sh` 才能更新生产 Brain。
没有自动化机制，导致代码积压在 develop 而不上线。

## 目标

在 `.github/workflows/ci.yml` 中新增 `deploy` job：
- 触发时机：`push` 到 `develop` 分支
- 前置条件：`brain-test` 和 `facts-check` 都通过
- 执行内容：SSH 到 US VPS → `cd /home/xx/perfect21/cecelia/core && git pull origin develop && bash scripts/brain-deploy.sh`
- 所用 secrets：`DEPLOY_SSH_KEY`、`DEPLOY_HOST`、`DEPLOY_USER`

## 范围

修改文件：
- `.github/workflows/ci.yml`（唯一改动）

## 技术方案

使用 `appleboy/ssh-action@v1.0.0` 执行远程 SSH 命令：

```yaml
deploy:
  name: Deploy to Production
  needs: [brain-test, facts-check]
  if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
  runs-on: ubuntu-latest
  timeout-minutes: 15
  steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        script: |
          set -e
          cd /home/xx/perfect21/cecelia/core
          git pull origin develop
          bash scripts/brain-deploy.sh
        command_timeout: 10m
```

## 验收标准

1. PR 触发的 CI 不受影响（deploy job 的 if 条件保证 PR 时不执行）
2. develop push 后，deploy job 出现在 Actions 列表
3. deploy job 成功后，生产 Brain 版本升级
