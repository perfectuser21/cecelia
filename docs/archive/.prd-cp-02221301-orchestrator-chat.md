---
id: prd-orchestrator-chat
version: 1.0.0
created: 2026-02-22
updated: 2026-02-22
changelog:
  - 1.0.0: 初始版本
---

# PRD: 打通 Cecelia 嘴巴对话链路

## 功能描述

打通 Cecelia 嘴巴（MiniMax）到大脑（Brain）的对话链路。

## 成功标准

- POST /api/brain/orchestrator/chat 可用并返回回复
- 简单查询走嘴巴直接回复，复杂问题升级到丘脑/皮层
- 对话带记忆上下文，重要对话存入事件日志

## 背景

前端 CeceliaChat 和 Dashboard 代理已配好，MiniMax API 已有，但 Brain 端缺少 `/orchestrator/chat` 端点，导致对话链路断开。同时对话过程需要接入现有的记忆系统。

## 目标

在 Brain 中实现 `/orchestrator/chat` 端点，打通 前端 → proxy → Brain → MiniMax → 回复 的完整对话链路，并集成现有的记忆系统和三层大脑路由。

## 功能范围

### Task 1: Brain /orchestrator/chat 端点

- 在 routes.js 中添加 `POST /api/brain/orchestrator/chat` 端点
- 接收 `{ message, context }` 请求
- 调用 MiniMax API 作为嘴巴层
- MiniMax API key 从 `~/.credentials/minimax.json` 读取
- MiniMax 地址用 `HK_MINIMAX_URL`（`http://100.86.118.99:5226`）

### Task 2: 嘴巴 → 大脑路由

- 嘴巴（MiniMax）先判断意图复杂度
- 简单查询 → 嘴巴直接回复（配合 intent.js + DB 查询）
- 需要决策 → 转给 L1 丘脑（`thalamusProcessEvent`）
- 需要深度思考 → L1 自动升级到 L2 皮层（现有机制）
- 用 `USER_MESSAGE` 事件类型走现有三层路由

### Task 3: 对话接入记忆系统

- 对话时调用 Memory API（`/api/brain/memory/search`）拉取相关上下文
- 把相关记忆注入到 MiniMax 的 prompt 中（类似 thalamus 的 `buildMemoryBlock`）
- 对话结束后，重要结论/决策存入 `cecelia_events` 表
- 复用现有的 memory-service 搜索

### Task 4: 端到端测试

- 单元测试覆盖 orchestrator-chat 模块
- 验证 MiniMax 调用、记忆注入、三层路由升级

## 不做的事

- 不改前端（CeceliaChat.tsx 已好）
- 不改代理配置（proxy 已好）
- 不改 MiniMax 执行器（已好）
- 不加新消息平台

## 技术设计

### 新文件

- `brain/src/orchestrator-chat.js` - 对话链路核心逻辑

### 修改文件

- `brain/src/routes.js` - 添加 `/orchestrator/chat` 端点
- `brain/server.js` - 无需修改（路由挂在现有 brainRoutes 下）

### 数据流

```
前端 CeceliaChat → proxy → POST /api/brain/orchestrator/chat
  → 1. Memory 搜索（注入上下文）
  → 2. MiniMax 判断意图
  → 3a. 简单查询 → MiniMax 直接回复
  → 3b. 复杂问题 → thalamusProcessEvent (USER_MESSAGE)
       → L1 Haiku → (可能) L2 Sonnet
       → Decision → 构造回复
  → 4. 记录对话事件
  → 返回 { reply, routing_level, intent }
```
