---
id: prd-fix-dedup-dispatch
version: 1.0.0
created: 2026-02-17
updated: 2026-02-17
changelog:
  - 1.0.0: 初始版本 - 修复重复任务 + 任务状态机 bug
---

# PRD: 修复重复探索任务和任务状态机 Bug (v1.48.2)

## 背景

团队 Agent 调查发现 4 个 Bug，导致：
1. 重复探索续拆任务（5 份相同任务同时运行）
2. 任务卡在 `in_progress` 状态（无执行器时未回滚）
3. 并发派发竞争条件（无原子状态检查）
4. 回调幂等性缺失（重复回调可能损坏状态）

## Bug 清单

### Bug 1（根本原因）: Check 7 payload 缺少 decomposition: 'continue'

**文件**: `brain/src/decomposition-checker.js`

**问题**:
- NOT EXISTS 去重查询检查 `payload->>'decomposition' = 'continue'`
- 但 `createDecompositionTask()` 存储 `{ decomposition: 'true', ...payload }`
- Check 7 的 payload `{ level: 'exploratory_continue', exploratory_source: ... }` 未包含 `decomposition` 字段
- `{ decomposition: 'true', ...payload }` 展开后 `decomposition` = `'true'`，不是 `'continue'`
- NOT EXISTS 永远找不到匹配，每次都创建新任务 → 重复！

**修复**: 在 Check 7 的 payload 中添加 `decomposition: 'continue'`，这样展开后会覆盖 `'true'` → `'continue'`

### Bug 2（中）: 无执行器时任务卡在 in_progress

**文件**: `brain/src/tick.js`

**问题**:
- 第 616 行：将任务更新为 `in_progress` 后，检查 `checkCeceliaRunAvailable()`
- 若无执行器，返回 `dispatched: true, reason: 'no_executor'` 但任务已是 `in_progress`
- 任务会永久卡在 `in_progress`，不会被重新派发

**修复**: 当无执行器时，将任务回滚到 `queued` 状态

### Bug 3（中）: 派发无原子状态检查

**文件**: `brain/src/actions.js` (updateTask)

**问题**:
- `WHERE id = $1` 无 `AND status = 'queued'` 约束
- 极端情况下可能双重派发同一任务

**修复**: `updateTask()` 在 status='in_progress' 时加 `AND status = 'queued'` 原子保护

### Bug 4（低）: 回调缺少幂等性保护

**文件**: `brain/src/routes.js`

**问题**:
- `execution-callback` 的 UPDATE 语句仅 `WHERE id = $1`
- 重复回调会多次更新状态

**修复**: 加 `AND status = 'in_progress'` 保护（已完成的任务不会被覆盖）

## 验收标准

1. 同一探索任务不会创建重复的续拆任务
2. 无执行器时任务自动回滚到 queued
3. 并发派发时同一任务只能被派发一次
4. 重复回调不会改变已完成任务的状态
5. 所有现有测试继续通过
6. 新增测试覆盖上述 4 个场景
