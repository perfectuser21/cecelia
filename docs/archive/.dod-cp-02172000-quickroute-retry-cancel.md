---
id: dod-cp-02172000-quickroute-retry-cancel
version: 1.1.0
created: 2026-02-17
updated: 2026-02-17
changelog:
  - 1.0.0: 初始版本
  - 1.1.0: 新增路由决策查询 API 验收条目
---

# DoD: 扩展 quickRoute TASK_FAILED retry>=3 自动隔离 + 路由决策查询 API

## 验收清单

- [ ] DOD-1: TASK_FAILED + retry>=3 + !complexReason → quickRoute 返回 cancel_task action
  - Test: should cancel task when retry exceeded and no complex reason (retry=3)

- [ ] DOD-2: TASK_FAILED + retry=4 + !complexReason → quickRoute 返回 cancel_task action
  - Test: should cancel task when retry=4 and no complex reason

- [ ] DOD-3: TASK_FAILED + complexReason + retry>=3 → quickRoute 返回 null（走 Sonnet）
  - Test: should still return null for task failed with complex reason even if retry exceeded

- [ ] DOD-4: TASK_FAILED + retry<3 + !complexReason → quickRoute 返回 retry_task（现有行为不变）
  - Test: 现有测试验证

- [ ] DOD-5: npm test 全部通过

- [ ] DOD-6: node scripts/facts-check.mjs 通过

- [ ] DOD-7: node scripts/devgate/check-dod-mapping.cjs 通过

- [ ] DOD-8: brain/package.json patch version bump

## 不在范围内（任务1）

- 不修改 cancel_task action 实现（已在 ACTION_WHITELIST 中）
- 不修改 Sonnet 路径逻辑

---

## 验收清单（任务2: 路由决策查询 API）

- [ ] DOD-9: GET /api/brain/routing/decisions 返回 200 + { decisions: [...], total: N }
  - Test: should return routing decisions with default limit

- [ ] DOD-10: limit 参数生效，默认 50，最大 200
  - Test: should respect limit parameter and cap at 200

- [ ] DOD-11: route_type 过滤生效
  - Test: should filter by route_type

- [ ] DOD-12: event_type 过滤生效
  - Test: should filter by event_type

- [ ] DOD-13: since 参数过滤生效
  - Test: should filter by since timestamp

- [ ] DOD-14: 结果按 created_at 倒序排列
  - Test: should return results in descending order

- [ ] DOD-15: npm test 通过（新测试文件 routing-decisions.test.js）

## 不在范围内（任务2）

- 不修改 cecelia_events 表结构
- 不修改 recordRoutingDecision() 函数
- 不添加写入操作，只读
