---
id: brain-attach-decision-dod
version: 1.0.0
created: 2026-02-12
linked_prd: .prd-brain-attach-decision.md
---

# Brain Attachment Decision API - Definition of Done

## Code Implementation

### 1. Similarity Service

- [ ] 创建 `brain/src/similarity.js`
      Test: brain/src/__tests__/similarity.test.js
  - [ ] `SimilarityService` class
        Test: brain/src/__tests__/similarity.test.js > SimilarityService constructor
  - [ ] `searchSimilar(query, topK)` 方法
        Test: brain/src/__tests__/similarity.test.js > searchSimilar
  - [ ] `getAllActiveEntities()` 方法
        Test: brain/src/__tests__/similarity.test.js > getAllActiveEntities
  - [ ] `calculateScore(query, entity)` 方法
        Test: brain/src/__tests__/similarity.test.js > calculateScore
  - [ ] `tokenize(text)` 方法
        Test: brain/src/__tests__/similarity.test.js > tokenize
  - [ ] `extractKeywords(text)` 方法
        Test: brain/src/__tests__/similarity.test.js > extractKeywords

### 2. API Routes

- [ ] 修改 `brain/src/routes.js`
      Test: brain/src/__tests__/attach-decision-routes.test.js
  - [ ] 添加 `POST /api/brain/search-similar` route
        Test: brain/src/__tests__/attach-decision-routes.test.js > POST /api/brain/search-similar
  - [ ] 添加 `POST /api/brain/attach-decision` route
        Test: brain/src/__tests__/attach-decision-routes.test.js > POST /api/brain/attach-decision
  - [ ] Request 验证（body 参数）
        Test: brain/src/__tests__/attach-decision-routes.test.js > request validation
  - [ ] Error handling（try-catch）
        Test: brain/src/__tests__/attach-decision-routes.test.js > error handling

### 3. LLM Prompt

- [ ] 创建 `brain/src/prompts/` 目录（如果不存在）
      Test: manual:verify-dir-exists
- [ ] 复制 `docs/brain-attach-decision-api.md` 中的 Prompt 到 `prompts/attach-decision.md`
      Test: manual:verify-file-content

### 4. Dependencies

- [ ] 添加 `natural` 到 `brain/package.json`
      Test: manual:check-package-json
- [ ] 运行 `npm install`
      Test: manual:verify-node-modules
- [ ] 验证 `package-lock.json` 已更新
      Test: manual:check-package-lock

## Testing

### 5. Unit Tests

- [ ] 创建 `brain/src/__tests__/similarity.test.js`
      Test: brain/src/__tests__/similarity.test.js
  - [ ] `calculateScore()` 测试
        Test: brain/src/__tests__/similarity.test.js > calculateScore tests
  - [ ] `tokenize()` 测试
        Test: brain/src/__tests__/similarity.test.js > tokenize tests
  - [ ] `extractKeywords()` 测试
        Test: brain/src/__tests__/similarity.test.js > extractKeywords tests
  - [ ] `getAllActiveEntities()` 测试（mock DB）
        Test: brain/src/__tests__/similarity.test.js > getAllActiveEntities tests
  - [ ] 测试覆盖率 > 80%
        Test: contract:C2-001

### 6. Integration Tests

- [ ] 创建 `brain/src/__tests__/attach-decision-routes.test.js`
      Test: brain/src/__tests__/attach-decision-routes.test.js
  - [ ] `POST /api/brain/search-similar` 测试
        Test: brain/src/__tests__/attach-decision-routes.test.js > search-similar endpoint
  - [ ] `POST /api/brain/attach-decision` 测试
        Test: brain/src/__tests__/attach-decision-routes.test.js > attach-decision endpoint
  - [ ] Error cases 测试（missing params, invalid input）
        Test: brain/src/__tests__/attach-decision-routes.test.js > error cases

### 7. Manual Testing

- [ ] 启动 Brain: `npm run dev`
      Test: manual:start-brain
- [ ] 测试 `search-similar` endpoint with curl
      Test: manual:curl-search-similar
  - [ ] 查询 Task 相似度
        Test: manual:query-task-similarity
  - [ ] 查询 Initiative 相似度
        Test: manual:query-initiative-similarity
  - [ ] 查询 KR 相似度
        Test: manual:query-kr-similarity
- [ ] 测试 `attach-decision` endpoint with curl
      Test: manual:curl-attach-decision
  - [ ] duplicate_task 场景
        Test: manual:test-duplicate-task
  - [ ] extend_initiative 场景
        Test: manual:test-extend-initiative
  - [ ] create_initiative_under_kr 场景
        Test: manual:test-create-under-kr
  - [ ] create_new_okr_kr 场景
        Test: manual:test-create-new

## Code Quality

### 8. Linting

- [ ] 代码通过 ESLint（如果配置）
      Test: contract:C1-001
- [ ] 代码格式符合项目规范
      Test: manual:code-review
- [ ] 没有 console.log 调试代码
      Test: manual:grep-console-log

### 9. Documentation

- [ ] 函数有 JSDoc 注释
      Test: manual:check-jsdoc
- [ ] 复杂逻辑有内联注释
      Test: manual:code-review
- [ ] API endpoint 有说明注释
      Test: manual:check-api-comments

## Database

### 10. Schema Verification

- [ ] 验证 `tasks` 表有 `pr_plan_id` 字段
      Test: manual:psql-check-tasks-schema
- [ ] 验证 `pr_plans` 表有 `initiative_id`, `project_id` 字段
      Test: manual:psql-check-pr-plans-schema
- [ ] 验证 `features` 表有 `kr_id` 字段
      Test: manual:psql-check-features-schema
- [ ] 验证 `key_results` 表有 `okr_id` 字段
      Test: manual:psql-check-key-results-schema
- [ ] 验证 `okrs` 表存在
      Test: manual:psql-check-okrs-table

## CI/CD

### 11. CI Checks

- [ ] 所有测试通过
      Test: contract:C2-001
- [ ] Linter 检查通过
      Test: contract:C1-001
- [ ] Build 成功
      Test: contract:C3-001

### 12. PR

- [ ] 创建 PR 到 `develop` 分支
      Test: manual:gh-pr-create
- [ ] PR 标题包含 `[FEATURE]` prefix
      Test: manual:check-pr-title
- [ ] PR 描述包含：
      Test: manual:check-pr-description
  - [ ] 功能说明
        Test: manual:pr-description-feature
  - [ ] 测试方法
        Test: manual:pr-description-testing
  - [ ] API 使用示例
        Test: manual:pr-description-api-example
- [ ] CI 绿色通过
      Test: contract:C3-001
- [ ] PR 合并到 develop
      Test: manual:gh-pr-merge

## Deployment

### 13. Production Readiness

- [ ] Brain 重启后服务正常
      Test: manual:docker-restart-check
- [ ] API endpoints 可访问
      Test: manual:curl-health-check
- [ ] 性能测试：查询 100 条实体 < 500ms
      Test: manual:performance-test
- [ ] 错误日志没有异常
      Test: manual:check-logs

## Final Checklist

- [ ] 所有代码已提交
      Test: manual:git-status-clean
- [ ] 所有测试已通过
      Test: contract:C2-001
- [ ] PR 已合并
      Test: manual:gh-pr-status
- [ ] 临时文件已清理
      Test: manual:check-temp-files
- [ ] `.prd` 和 `.dod` 文件已删除
      Test: manual:check-prd-dod-removed
