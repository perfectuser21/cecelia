---
id: dod-quickroute-task-events
version: 1.1.0
created: 2026-02-17
updated: 2026-02-17
changelog:
  - 1.0.0: 初始版本
  - 1.1.0: 新增 TASK_FAILED retry>=3 !complex → cancel_task 自动隔离路由
---

# DoD: 扩展 quickRoute - 任务状态类事件（含自动隔离）

## 验收清单

- [ ] quickRoute 对 TASK_FAILED（无复杂原因/重试次数未超限）返回 retry_task action
  - Test: `thalamus.test.js: "should retry task on simple task failed (no complex reason)"`
- [ ] quickRoute 对 TASK_FAILED（无复杂原因/重试次数>=3）返回 cancel_task（自动隔离）
  - Test: `thalamus.test.js: "should cancel task when retry exceeded and no complex reason"`
- [ ] quickRoute 对 TASK_FAILED（有复杂原因）返回 null（交给 Sonnet）
  - Test: `thalamus.test.js: "should return null for task failed with complex reason (needs Sonnet)"`
- [ ] quickRoute 对 TASK_FAILED（有复杂原因+重试超限）返回 null（仍交给 Sonnet）
  - Test: `thalamus.test.js: "should return null for task failed with complex reason even if retry exceeded"`
- [ ] quickRoute 对 TASK_TIMEOUT 返回 log_event + retry_task（降级重试）
  - Test: `thalamus.test.js: "should log and retry on task timeout"`
- [ ] quickRoute 对 TASK_CREATED 返回 no_action（事件驱动下游消费）
  - Test: `thalamus.test.js: "should return no_action for task created event"`
- [ ] 现有测试（TASK_FAILED null 基础测试）更新为正确场景（retry=0 → retry_task）
  - Test: `thalamus.test.js: 更新现有 "should return null for task failed"`
- [ ] 不破坏现有 quickRoute 测试（heartbeat/tick/task_completed）
  - Test: `thalamus.test.js: 现有测试通过`
- [ ] facts-check 通过（action_count 无变化，使用已有 actions）
  - Verify: `node scripts/facts-check.mjs`
- [ ] 所有现有测试通过（无回归）
  - Verify: `npm test`
