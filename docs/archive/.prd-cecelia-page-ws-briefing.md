---
id: prd-cecelia-page-ws-briefing
version: 1.0.0
created: 2026-02-25
updated: 2026-02-25
changelog:
  - 1.0.0: 初始版本
---

# PRD: CeceliaPage V2 Phase 1 — WebSocket 增强 + Briefing API

## 需求来源

CeceliaPage 重设计方案 Phase 1（`docs/design-cecelia-page-v2.md`）。
当前前端靠 30-60s 轮询获取数据，缺乏实时感。
本 PR 为 workspace 前端重写提供 Core API 基础管道。

## 功能描述

### 1. WebSocket 新增 4 个事件类型

在 `brain/src/websocket.js` 的 `WS_EVENTS` 中新增：

| 事件 | 触发时机 | Payload |
|------|----------|---------|
| `alertness:changed` | alertness 等级变化时 | `{ level, previous, label, timestamp }` |
| `desire:created` | 新 desire 插入时 | `{ id, type, urgency, summary, timestamp }` |
| `desire:updated` | desire 状态变更时 | `{ id, status, previous_status, timestamp }` |
| `tick:executed` | 每次 tick 完成时 | `{ tick_number, duration_ms, actions_taken, next_tick_at, timestamp }` |

在对应代码路径添加 `broadcast()` 调用：
- `alertness.js` → 等级变化时
- desires 相关路由 → 创建/更新时
- `tick.js` → tick 完成时

### 2. Briefing API

新端点 `GET /api/brain/briefing`，聚合以下数据：

- 问候语（根据时段）
- 上次访问后的事件摘要（完成/失败/排队数 + 事件列表）
- 待决策 desires
- 今日焦点
- Token 费用

纯数据聚合，不调 LLM。

### 3. WebSocket 服务端心跳

当前只有客户端 ping → 服务端 pong。
新增服务端主动 ping 探测（30s 间隔），清理僵尸连接。

## 涉及文件

| 文件 | 变更 |
|------|------|
| `brain/src/websocket.js` | 新增 4 个事件 + 服务端心跳 |
| `brain/src/events/taskEvents.js` | 新增 publish 函数 |
| `brain/src/alertness.js` | 添加 broadcast 调用 |
| `brain/src/routes.js` | 添加 briefing 端点 + desires broadcast |
| `brain/src/tick.js` | 添加 tick:executed broadcast |
| `brain/src/briefing.js` | 新文件，briefing 数据聚合逻辑 |
| `brain/src/__tests__/websocket-events.test.js` | WebSocket 新事件测试 |
| `brain/src/__tests__/briefing.test.js` | Briefing API 测试 |

## 成功标准

1. WebSocket 客户端能收到 alertness/desire/tick 事件
2. GET /api/brain/briefing 返回完整简报数据
3. 僵尸 WebSocket 连接被自动清理
4. 所有新功能有测试覆盖
5. 现有测试不受影响

## 非目标

- 不改前端（那是 Workspace Phase 2）
- 不改 orchestrator-chat（流式输出是独立工作项）
- 不改 migration（076 已在 PR #548 完成）
