---
id: prd-cp-02211400-layer2-health-monitor
version: 1.0.0
created: 2026-02-21
updated: 2026-02-21
changelog:
  - 1.0.0: 初始版本
---

# PRD：Layer 2 运行健康监控（health-monitor.js）

## 功能描述

在 cecelia-core Brain 中加入 Layer 2 运行健康监控，每小时触发一次（复用 CLEANUP_INTERVAL_MS 逻辑），纯 SQL 查询运行数据，对比阈值，将结果写入 cecelia_events 表（type='layer2_health'）。不需要 LLM，纯代码逻辑。

### 背景

Cecelia 免疫系统分为 4 层：
- Layer 1：每次 tick（5min），ping 类检查，纯代码，已存在
- **Layer 2（本 PRD）**：每小时，SQL 运行数据 vs 阈值，纯代码
- Layer 3：每 20h，Codex CLI 全量测试分析，外部专家
- Layer 4：每周，趋势分析，LLM

## 成功标准

1. `health-monitor.js` 导出 `runLayer2HealthCheck(pool)` 函数
2. tick.js 中每小时调用一次（基于 `_lastCleanupTime` 类似逻辑）
3. 检查 4 项指标，每项有阈值和健康等级
4. 结果写入 `cecelia_events` 表（type='layer2_health'）
5. 所有逻辑有单元测试覆盖
6. facts-check、version-sync DevGate 通过

## 检查项

| 指标 | SQL 查询范围 | 警告阈值 | 说明 |
|------|------------|---------|------|
| `dispatched_1h` | 过去 1 小时 completed 任务数 | < 1（且系统运行 > 3h）→ warning | 系统是否在正常出活 |
| `stuck_tasks` | in_progress 超过 2 小时的任务数 | > 3 → warning；> 10 → critical | 卡住的任务 |
| `last_success_ago_min` | 距最后一次成功完成的分钟数 | > 360min → warning | 上次成功的时间 |
| `queue_depth` | 当前 queued 任务数 | > 50 → warning | 队列是否堆积 |

## 健康等级

- `healthy`：所有检查通过
- `warning`：1-2 项异常
- `critical`：3+ 项异常 OR stuck_tasks > 10

## 实现方案

### 新建文件

`brain/src/health-monitor.js`：
- `runLayer2HealthCheck(pool)` — 主函数，运行 4 项 SQL 检查
- `calculateHealthLevel(checks)` — 根据异常数量计算等级
- `recordHealthEvent(pool, result)` — 写入 cecelia_events

### 修改文件

`brain/src/tick.js`：
- 在 Section 0.6（Codex 免疫检查后）加 Section 0.7
- 复用 `_lastCleanupTime` 机制，增加 `_lastHealthCheckTime` 变量
- 每 `CLEANUP_INTERVAL_MS`（1h）触发一次

### 触发逻辑

```javascript
// Section 0.7: Layer 2 运行健康监控（每小时一次）
if (Date.now() - _lastHealthCheckTime >= CLEANUP_INTERVAL_MS) {
  _lastHealthCheckTime = Date.now();
  await runLayer2HealthCheck(pool).catch(err => console.error('[Layer2Health] error:', err));
}
```

## 技术约束

- 纯 SQL，不调用 LLM，不调用外部 API
- 异常时 catch + log，不影响主 tick 流程
- `cecelia_events` 表已存在（migration 041），type 字段支持 layer2_health
