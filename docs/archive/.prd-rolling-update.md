# PRD: 蓝绿部署脚本（Rolling Update）

## 功能概述

实现一个蓝绿部署脚本 `scripts/rolling-update.sh`，用于 Brain 服务的零停机热更新。支持从 develop 分支合并到 main 后，在不停止当前运行的 Brain 容器的情况下，启动新版本容器、健康检查、流量切换、停止旧容器的完整流程。

## 背景

**问题**：
- 当前 `brain-deploy.sh` 部署流程会停止旧容器再启动新容器，导致服务中断
- Cecelia Brain 运行在 main 分支，需要持续运行不间断
- develop → main 的代码更新需要一种热更新机制

**资源情况**（已评估）：
- 服务器总内存：15.61 GiB
- 可用内存：8.5 GiB
- Brain 单容器常态占用：32 MB
- 双容器峰值估计：400 MB（占可用内存 4.7%）
- **结论**：资源充裕，可以安全运行蓝绿部署

**用户需求**：
- Cecelia 在 main 分支持续运行
- 开发在 develop 分支进行
- develop 更新能热更新到 main，Cecelia 不停机

## 目标

1. **零停机时间**：停机窗口 < 5 秒
2. **自动回滚**：健康检查失败时自动回滚到旧版本
3. **安全保障**：等待当前 Tick 完成后再切换容器
4. **资源友好**：双容器运行时间 < 5 分钟

## 功能需求

### 1. 蓝绿部署流程

```
1. Build 新镜像（基于当前 brain/package.json version）
2. 启动新容器（green）到临时端口 5222
3. 健康检查（最多等待 60 秒）
4. 等待旧容器 Tick 完成（避免中断任务）
5. 停止旧容器（blue）
6. 将新容器重启到正式端口 5221
7. 验证服务正常
```

### 2. 健康检查

- 端点：`GET http://localhost:5222/api/brain/health`
- 超时：60 秒（12 次重试，每次 5 秒）
- 失败处理：自动回滚（停止 green，保留 blue）

### 3. Tick 保护

- 调用 `GET /api/brain/tick/status` 获取下一个 tick 时间
- 等待至少 10 秒确保当前 tick 完成
- 避免在 tick 执行中途切换容器

### 4. 自动回滚

触发条件：
- green 容器健康检查失败
- green 容器启动失败
- Migration 失败

回滚操作：
- 停止并删除 green 容器
- 保留 blue 容器继续运行
- 退出脚本（exit 1）

## 技术要求

### 1. 脚本位置

```
scripts/rolling-update.sh
```

### 2. 依赖脚本

- `scripts/brain-build.sh` - 构建镜像
- `scripts/brain-deploy.sh` - 参考 migration 逻辑

### 3. 环境变量

```bash
ENV_REGION=${ENV_REGION:-us}  # 继承现有环境变量
```

### 4. 容器命名

- 旧容器（blue）：`cecelia-node-brain`
- 新容器（green，临时）：`cecelia-node-brain-green`

### 5. 端口分配

- blue（生产）：5221
- green（预热）：5222

### 6. Docker 配置

与现有 `docker-compose.yml` 保持一致：
- `--network host`
- `--env-file .env.docker`
- `--restart unless-stopped`
- 无资源限制（memory: 0, cpus: 0）

## 验收标准

### 功能验收

- [ ] 脚本成功构建新镜像
- [ ] green 容器在 5222 端口启动成功
- [ ] 健康检查通过（200 OK）
- [ ] 流量切换后，5221 端口返回正确响应
- [ ] 旧容器成功停止和删除
- [ ] 新容器以正确名称运行

### 安全验收

- [ ] 健康检查失败时自动回滚
- [ ] 回滚后旧容器仍在运行
- [ ] Migration 失败时阻止部署

### 性能验收

- [ ] 双容器运行时间 < 5 分钟
- [ ] 停机窗口 < 5 秒
- [ ] green 容器内存峰值 < 500 MB

### 兼容性验收

- [ ] 继承 `ENV_REGION` 环境变量
- [ ] 与现有 CI/CD 流程兼容
- [ ] 不破坏现有 `brain-deploy.sh` 功能

## 使用方式

### 开发流程

```bash
# 1. 在 develop 开发完成
git checkout develop
# ... 开发 ...
git commit -m "feat: new feature"

# 2. PR merge 到 main
gh pr create --base main
gh pr merge --merge

# 3. 切换到 main，触发热更新
git checkout main
git pull
bash scripts/rolling-update.sh
```

### 输出示例

```
=== Rolling Update: v1.38.1 ===

[1/6] Building new image...
  ✅ cecelia-brain:1.38.1 built

[2/6] Starting new container on port 5222...
  ✅ cecelia-node-brain-green started

[3/6] Health check...
  Waiting... (1/12)
  Waiting... (2/12)
  ✅ New container healthy

[4/6] Waiting for old tick to complete...
  ✅ Tick complete

[5/6] Switching containers...
  ✅ Old container stopped

[6/6] Restarting on port 5221...
  ✅ New container running

✅ Rolling update complete!
{
  "status": "healthy",
  "version": "1.38.1"
}
```

## 风险评估

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 健康检查误报 | 低 | 高 | 多次重试（12 次 × 5s） |
| 内存不足 | 极低 | 中 | 资源已评估（8.5 GB 可用） |
| Tick 中断 | 低 | 中 | 等待 Tick 完成后切换 |
| Migration 失败 | 中 | 高 | 在 green 启动前先跑 migration |

## 后续优化（可选）

1. **多副本蓝绿**：支持多个 Brain 副本的滚动更新
2. **流量渐进切换**：通过 nginx 逐步切换流量（10% → 50% → 100%）
3. **性能监控**：集成 Prometheus 监控部署过程
4. **自动化测试**：集成到 CI，自动触发蓝绿部署测试

## 参考文档

- 现有部署脚本：`scripts/brain-deploy.sh`
- Docker Compose 配置：`docker-compose.yml`
- Brain API 文档：`DEFINITION.md`
- 资源评估记录：会话 2026-02-14
