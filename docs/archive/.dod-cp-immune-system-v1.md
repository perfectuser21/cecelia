# DoD: 免疫系统 v1 - 学得稳（可控演化）

## 数据库 Schema

### 1. Migration 025 创建
- [x] `brain/migrations/025_immune_system_v1.sql` 文件存在
- [x] 包含 3 张新表：failure_signatures, absorption_policies, policy_evaluations
- [x] rca_cache 表保留不变
- [x] 所有表有正确的索引
- [x] 所有约束（CHECK, FOREIGN KEY）正确
- [x] 更新 schema_version = '025'
- **Test**: `psql` 执行 migration 成功，`\d+` 显示表结构正确

### 2. Selfcheck 更新
- [x] `brain/src/selfcheck.js` 中 `EXPECTED_SCHEMA_VERSION = '025'`
- **Test**: `node src/selfcheck.js` 通过

## 代码实现

### 3. 免疫系统模块
- [x] `brain/src/immune-system.js` 文件存在
- [x] 导出函数：
  - `updateFailureSignature(signature, failure)` - 更新签名计数
  - `findActivePolicy(signature)` - 查询 active policy
  - `recordPolicyEvaluation(evaluation)` - 记录审计
  - `shouldPromoteToProbation(signature)` - 判断是否晋升
- [x] 所有函数有 JSDoc 注释
- [x] 所有函数有错误处理
- **Test**: `immune-system.test.js` 覆盖所有函数

### 4. Monitor Loop 改造
- [x] `brain/src/monitor-loop.js` 导入 `immune-system.js`
- [x] `handleFailureSpike()` 中添加优先查询 active policy 逻辑
- [x] 无 policy 时调用 `updateFailureSignature()`
- [x] 有 policy 时调用 `recordPolicyEvaluation()`
- [x] 日志输出显示 policy 执行路径
- **Test**: `monitor-loop.test.js` 新增测试场景

## 测试覆盖

### 5. 单元测试
- [x] `brain/src/__tests__/immune-system.test.js`
  - 测试 `updateFailureSignature()`：首次/重复调用，计数递增
  - 测试 `findActivePolicy()`：有/无 active policy
  - 测试 `recordPolicyEvaluation()`：写入成功
  - 测试 `shouldPromoteToProbation()`：满足/不满足条件
- **Test**: `npm test immune-system.test.js` 全绿

### 6. 集成测试
- [x] `brain/src/__tests__/monitor-immune-integration.test.js`
  - 插入 draft policy → probation
  - 触发 failure → Monitor 查询 probation policy
  - 写入 policy_evaluations 审计记录
  - `failure_signatures` 计数正确
- **Test**: `npm test monitor-immune-integration.test.js` 全绿

### 7. E2E 测试
- [x] 启动 Brain，插入测试失败数据
- [x] 手动插入 active policy
- [x] Monitor 检测到失败，优先执行 policy
- [x] 查询 `policy_evaluations` 有记录
- [x] 查询 `failure_signatures` 计数正确
- **Test**: `/tmp/brain-immune-e2e.log` 记录完整流程

## 日志和监控

### 8. 日志输出
- [x] Monitor 输出：`[Immune] Checking active policy for signature=...`
- [x] Monitor 输出：`[Immune] Found active policy: {policy_id}`
- [x] Monitor 输出：`[Immune] No active policy, updating failure_signatures`
- [x] Monitor 输出：`[Immune] Policy evaluation recorded: mode={mode} decision={decision}`
- **Test**: `tail /tmp/brain-output-new.log` 显示日志

### 9. API 端点（可选，方便调试）
- [x] `GET /api/brain/immune/policies?status=active` - 查询 active policies
- [x] `GET /api/brain/immune/signatures?top=10` - 查询高频签名
- [x] `GET /api/brain/immune/evaluations?policy_id={id}` - 查询审计记录
- **Test**: `curl` 测试返回正确数据

## 文档更新

### 10. DEFINITION.md 更新
- [x] 添加 "Immune System" 章节
- [x] 说明 4 张表的用途
- [x] 说明规则状态机
- [x] 更新 schema_version = '025'
- **Test**: Facts Check 通过

### 11. LEARNINGS.md 记录
- [x] 记录免疫系统设计决策
- [x] 记录 Simulate First 原则
- [x] 记录状态机晋升条件
- **Test**: 文件存在，内容完整

## CI / DevGate

### 12. Version Sync
- [x] `brain/package.json` version bump (minor)
- [x] `brain/package-lock.json` 同步
- [x] `.brain-versions` 更新
- [x] `DEFINITION.md` 中版本号同步
- **Test**: `bash scripts/check-version-sync.sh` 通过

### 13. Facts Check
- [x] `scripts/facts-check.mjs` 通过
- [x] `schema_version` 正确
- [x] `brain_version` 正确
- **Test**: `node scripts/facts-check.mjs` 通过

### 14. DoD Mapping
- [x] 每条 DoD 有对应测试
- [x] `scripts/devgate/check-dod-mapping.cjs` 通过
- **Test**: CI 检查通过

### 15. RCI Update
- [x] 新增功能有 RCI 条目（如需要）
- [x] `scripts/devgate/require-rci-update-if-p0p1.sh` 通过
- **Test**: CI 检查通过

## Git & PR

### 16. 分支和提交
- [x] 在 `cp-immune-system-v1` 分支
- [x] 提交信息：`feat: add Immune System v1 (P0 - registry + state machine + evaluations)`
- [x] 所有文件已提交
- **Test**: `git status` clean

### 17. PR 创建
- [x] PR 标题：`feat: Immune System v1 - 学得稳（可控演化）P0`
- [x] PR 描述包含 PRD 链接
- [x] PR 通过 CI
- **Test**: GitHub PR 显示绿色 ✓

### 18. PR 合并
- [x] PR 合并到 develop
- [x] develop 分支 CI 通过
- **Test**: `git log develop` 显示合并记录

---

## 验收清单汇总

**数据库**：
- [x] 3 张新表创建成功
- [x] Schema version = 025

**代码**：
- [x] immune-system.js 实现完整
- [x] monitor-loop.js 集成完成

**测试**：
- [x] 单元测试覆盖所有函数
- [x] 集成测试验证 Monitor + Immune 联动
- [x] E2E 测试验证真实流程

**文档**：
- [x] DEFINITION.md 更新
- [x] LEARNINGS.md 记录

**CI**：
- [x] Version Sync 通过
- [x] Facts Check 通过
- [x] DoD Mapping 通过

**Git**：
- [x] PR 创建 + 合并

---

**完成标志**：所有 [x] 打勾，CI 全绿，PR 合并到 develop ✅
