---
id: prd-cp-02182200-dispatch-stats
version: 1.0.0
created: 2026-02-18
updated: 2026-02-18
changelog:
  - 1.0.0: 初始版本
---

# PRD: 实现派发成功率统计

## 需求来源
当前 cecelia-core 的任务派发系统没有任何成功率统计。仅有熔断器在内存中计数失败次数，无全局 metrics。监控系统无法知道「过去1小时派发成功率是多少」。

## 功能描述
在 tick.js 的 dispatchNextTask 函数中，记录每次派发的成功/失败事件，并在 working_memory 中维护 1 小时滚动窗口统计，通过 `dispatch_stats` key 存储。

## 成功标准
- 每次派发（成功/失败）后，working_memory 的 `dispatch_stats` 都被更新
- 1 小时窗口内的成功率、失败原因分类均可查询

## 目标
在 executor.js/tick.js 的派发路径上，记录每次派发的成功/失败，并在 working_memory 中维护滚动窗口统计。

## 实现方案

### 1. 在 working_memory 中维护 dispatch_stats（不新建 DB 表）
在 tick.js 的 dispatchNextTask 函数中，每次派发成功或失败后，更新 working_memory key: `dispatch_stats`：

```json
{
  "window_1h": {
    "total": 100,
    "success": 95,
    "failed": 5,
    "rate": 0.95,
    "last_updated": "2026-02-18T05:00:00Z",
    "failure_reasons": {
      "circuit_breaker_open": 2,
      "pre_flight_failed": 1,
      "server_overloaded": 1,
      "bridge_error": 1
    }
  }
}
```

### 2. 在 tick.js 的 dispatchNextTask 中记录失败原因
当 dispatched: false 时，记录失败 reason 到 dispatch_stats。
当 dispatched: true 时，记录成功到 dispatch_stats。

### 3. 失败原因分类
- `circuit_breaker_open`: 熔断器打开
- `pool_exhausted`: 槽位耗尽
- `server_overloaded`: 服务器资源不足
- `pre_flight_failed`: pre-flight 检查失败
- `no_task_available`: 无可派发任务（非错误，正常情况）
- `bridge_error`: Bridge 调用失败
- `billing_pause`: 计费暂停
- `draining`: 引流模式

## 扩展需求：initTickLoop 启动重试机制

### 问题
当前 `initTickLoop` 在 DB 连接失败等情况下，catch 后仅打印错误，tick 不会启动。没有重试机制，也没有记录启动错误到 working_memory。

### 实现方案
在 `initTickLoop` 函数中增加：

1. **重试次数**：可配置（默认3次，通过 `CECELIA_INIT_RETRY_COUNT` 环境变量），间隔10秒
2. **记录 startup_errors 到 working_memory**：每次失败记录时间戳、错误信息
3. **重试耗尽后发出 critical 事件**：通过 `emit('init_failed', 'tick', {...})` 通知

### 数据格式（working_memory key: startup_errors）
```json
{
  "errors": [
    {
      "ts": "2026-02-18T05:00:00Z",
      "error": "connection refused",
      "attempt": 1
    }
  ],
  "last_error_at": "2026-02-18T05:00:30Z",
  "total_failures": 3
}
```

### 约束
- 重试逻辑仅包裹 initTickLoop 的主体（DB 依赖部分），不影响 alertness/orphan 等子步骤的独立 try/catch
- 如果 DB 完全不可用，最多等待 3×10s=30s 后放弃并发出 critical 事件
- 纯监控，不改变现有派发/tick 行为

## 参考文件
- brain/src/tick.js: dispatchNextTask 函数 / initTickLoop 函数
- brain/src/executor.js: triggerCeceliaRun 函数
- brain/src/circuit-breaker.js: isAllowed/recordFailure
- brain/src/event-bus.js: emit 函数
