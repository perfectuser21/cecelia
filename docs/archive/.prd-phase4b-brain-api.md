---
id: phase4b-brain-feedback-api
version: 1.0.0
created: 2026-02-08
updated: 2026-02-08
project: cecelia-core (Brain)
phase: Phase 4b
related_prs:
  - engine#552 (Phase 4a)
changelog:
  - 1.0.0: 初始版本 - Brain 侧反馈 API 实现
---

# Phase 4b: Brain Feedback API Implementation

## 项目背景

**OKR 迭代拆解 Roadmap** 的 Phase 4b - 实现 Brain 侧的反馈接收和任务状态同步 API。

### Phase 4a 已完成（Engine 侧）

- ✅ `upload-feedback.sh` - 上传反馈到 Brain
- ✅ `update-task-status.sh` - 同步任务状态
- ✅ Step 1 集成 - Task 启动时更新状态为 `in_progress`
- ✅ Step 10 集成 - 完成时上传反馈 + 更新状态为 `completed`
- ✅ 版本: engine v12.17.0, PR #552

### Phase 4b 目标（Brain 侧）

实现两个 API 端点，接收 Engine 发送的反馈和状态更新：

1. **POST /api/brain/tasks/:task_id/feedback** - 接收并存储执行反馈
2. **PATCH /api/brain/tasks/:task_id** - 更新任务状态

---

## 功能需求

### 1. POST /api/brain/tasks/:task_id/feedback

**功能**: 接收 Engine 上传的任务执行反馈报告

**请求格式**:
```http
POST /api/brain/tasks/:task_id/feedback
Content-Type: application/json

{
  "status": "completed",          // 必需: completed | failed
  "summary": "...",                // 必需: 执行摘要
  "metrics": {                     // 可选: 度量数据
    "duration_seconds": 4800,
    "commits": 3,
    "files_changed": 8,
    "lines_added": 326,
    "lines_removed": 31
  },
  "artifacts": {                   // 可选: 产物信息
    "pr_url": "https://...",
    "pr_number": 552,
    "branch": "cp-...",
    "commits": ["sha1", "sha2"]
  },
  "issues": [],                    // 可选: 遇到的问题
  "learnings": []                  // 可选: 经验教训
}
```

**响应格式**:
```json
{
  "success": true,
  "task_id": "...",
  "feedback_id": "...",            // 新增: 反馈记录 ID
  "received_at": "2026-02-08T10:30:00Z"
}
```

**错误响应**:
```json
{
  "success": false,
  "error": "Task not found",
  "code": "TASK_NOT_FOUND"
}
```

**业务逻辑**:

1. **验证 Task ID**:
   - Task 必须存在
   - Task 必须属于当前用户/系统
   - Task 状态必须是 `in_progress` 或 `completed`

2. **验证请求体**:
   - `status` 必需，且只能是 `completed` 或 `failed`
   - `summary` 必需，且不能为空
   - `metrics`, `artifacts`, `issues`, `learnings` 可选
   - JSON 结构必须有效

3. **存储反馈**:
   - 将反馈存储到 `tasks` 表的 `feedback` 字段（JSONB）
   - 如果已有反馈，追加到数组（支持多次反馈）
   - 记录接收时间

4. **更新任务元数据**:
   - 更新 `updated_at` 时间戳
   - 如果 status 是 `completed`，考虑自动更新任务状态
   - 记录反馈次数

5. **返回响应**:
   - 返回成功状态
   - 返回 feedback_id（用于后续查询）
   - 返回接收时间

**错误处理**:

| 错误码 | HTTP 状态 | 说明 |
|--------|-----------|------|
| TASK_NOT_FOUND | 404 | 任务不存在 |
| INVALID_STATUS | 400 | 状态值无效 |
| MISSING_FIELD | 400 | 缺少必需字段 |
| INVALID_JSON | 400 | JSON 格式错误 |
| DATABASE_ERROR | 500 | 数据库错误 |

---

### 2. PATCH /api/brain/tasks/:task_id

**功能**: 更新任务状态（Engine 调用）

**请求格式**:
```http
PATCH /api/brain/tasks/:task_id
Content-Type: application/json

{
  "status": "in_progress"    // 必需: in_progress | completed | failed
}
```

**响应格式**:
```json
{
  "success": true,
  "task_id": "...",
  "status": "in_progress",
  "updated_at": "2026-02-08T10:30:00Z"
}
```

**业务逻辑**:

1. **验证 Task ID**:
   - Task 必须存在
   - Task 必须属于当前用户/系统

2. **验证状态值**:
   - 只允许: `in_progress`, `completed`, `failed`
   - 不允许: `pending`, `quarantined` 等其他状态（由系统控制）

3. **状态转换规则**:
   ```
   pending → in_progress ✅
   in_progress → completed ✅
   in_progress → failed ✅
   completed → * ❌ (已完成不可更改)
   failed → * ❌ (已失败不可更改)
   ```

4. **记录状态历史**:
   - 在 `status_history` 字段记录状态变更
   - 每条记录包含: 旧状态, 新状态, 变更时间, 来源 (engine)

5. **触发事件**:
   - 状态变更时触发 `task_status_changed` 事件
   - 可用于通知、统计、触发下游任务等

**错误处理**:

| 错误码 | HTTP 状态 | 说明 |
|--------|-----------|------|
| TASK_NOT_FOUND | 404 | 任务不存在 |
| INVALID_STATUS | 400 | 状态值无效 |
| INVALID_TRANSITION | 400 | 状态转换不允许 |
| TASK_LOCKED | 409 | 任务已锁定（已完成或失败）|
| DATABASE_ERROR | 500 | 数据库错误 |

---

## 数据库 Schema 变更

### 1. tasks 表扩展

**新增字段**:

```sql
-- 反馈数据 (JSONB 数组，支持多次反馈)
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS feedback JSONB DEFAULT '[]'::jsonb;

-- 状态历史 (JSONB 数组)
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS status_history JSONB DEFAULT '[]'::jsonb;

-- 反馈次数（冗余字段，方便查询）
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS feedback_count INTEGER DEFAULT 0;

-- 索引优化
CREATE INDEX IF NOT EXISTS idx_tasks_feedback ON tasks USING gin(feedback);
CREATE INDEX IF NOT EXISTS idx_tasks_status_history ON tasks USING gin(status_history);
CREATE INDEX IF NOT EXISTS idx_tasks_feedback_count ON tasks(feedback_count);
```

**feedback 字段结构**:

```json
[
  {
    "id": "feedback_uuid",
    "status": "completed",
    "summary": "...",
    "metrics": {...},
    "artifacts": {...},
    "issues": [],
    "learnings": [],
    "received_at": "2026-02-08T10:30:00Z"
  }
]
```

**status_history 字段结构**:

```json
[
  {
    "from": "pending",
    "to": "in_progress",
    "changed_at": "2026-02-08T10:00:00Z",
    "source": "engine",
    "metadata": {}
  },
  {
    "from": "in_progress",
    "to": "completed",
    "changed_at": "2026-02-08T14:30:00Z",
    "source": "engine",
    "metadata": {
      "pr_url": "...",
      "pr_number": 552
    }
  }
]
```

### 2. Migration 脚本

创建迁移脚本: `brain/migrations/YYYYMMDDHHMMSS_add_feedback_and_status_history.sql`

**回滚支持**:
```sql
-- Rollback
ALTER TABLE tasks DROP COLUMN IF EXISTS feedback;
ALTER TABLE tasks DROP COLUMN IF EXISTS status_history;
ALTER TABLE tasks DROP COLUMN IF EXISTS feedback_count;
DROP INDEX IF EXISTS idx_tasks_feedback;
DROP INDEX IF EXISTS idx_tasks_status_history;
DROP INDEX IF EXISTS idx_tasks_feedback_count;
```

---

## 代码实现位置

### 文件结构（建议）

```
brain/
├── routes/
│   └── tasks.js                    # 修改: 添加两个端点
├── controllers/
│   └── taskController.js           # 修改: 添加两个控制器方法
├── services/
│   ├── taskService.js              # 修改: 添加业务逻辑
│   └── feedbackService.js          # 新增: 反馈处理服务
├── validators/
│   └── taskValidators.js           # 修改: 添加请求验证
├── migrations/
│   └── YYYYMMDD_add_feedback.sql   # 新增: 数据库迁移
└── tests/
    ├── routes/tasks.test.js        # 修改: 添加端点测试
    └── services/feedback.test.js   # 新增: 服务测试
```

### 具体实现点

#### 1. 路由层 (routes/tasks.js)

```javascript
// POST /api/brain/tasks/:task_id/feedback
router.post('/:task_id/feedback',
  validateTaskId,
  validateFeedbackBody,
  taskController.receiveFeedback
);

// PATCH /api/brain/tasks/:task_id
router.patch('/:task_id',
  validateTaskId,
  validateStatusUpdate,
  taskController.updateStatus
);
```

#### 2. 控制器层 (controllers/taskController.js)

```javascript
async receiveFeedback(req, res) {
  try {
    const { task_id } = req.params;
    const feedbackData = req.body;

    const result = await feedbackService.storeFeedback(task_id, feedbackData);

    res.json({
      success: true,
      task_id,
      feedback_id: result.feedback_id,
      received_at: result.received_at
    });
  } catch (error) {
    // 错误处理
  }
}

async updateStatus(req, res) {
  try {
    const { task_id } = req.params;
    const { status } = req.body;

    const result = await taskService.updateTaskStatus(task_id, status, 'engine');

    res.json({
      success: true,
      task_id,
      status: result.status,
      updated_at: result.updated_at
    });
  } catch (error) {
    // 错误处理
  }
}
```

#### 3. 服务层 (services/feedbackService.js)

```javascript
class FeedbackService {
  async storeFeedback(taskId, feedbackData) {
    // 1. 验证 Task 存在
    const task = await db.query('SELECT * FROM tasks WHERE id = $1', [taskId]);
    if (!task.rows[0]) {
      throw new Error('TASK_NOT_FOUND');
    }

    // 2. 构造反馈对象
    const feedback = {
      id: uuidv4(),
      ...feedbackData,
      received_at: new Date().toISOString()
    };

    // 3. 追加到 feedback 数组
    await db.query(`
      UPDATE tasks
      SET
        feedback = feedback || $1::jsonb,
        feedback_count = feedback_count + 1,
        updated_at = NOW()
      WHERE id = $2
    `, [JSON.stringify([feedback]), taskId]);

    // 4. 返回结果
    return {
      feedback_id: feedback.id,
      received_at: feedback.received_at
    };
  }
}
```

#### 4. 状态更新服务 (services/taskService.js)

```javascript
async updateTaskStatus(taskId, newStatus, source = 'engine') {
  // 1. 获取当前任务
  const task = await this.getTaskById(taskId);
  if (!task) {
    throw new Error('TASK_NOT_FOUND');
  }

  // 2. 验证状态转换
  if (!this.isValidTransition(task.status, newStatus)) {
    throw new Error('INVALID_TRANSITION');
  }

  // 3. 构造状态历史记录
  const historyEntry = {
    from: task.status,
    to: newStatus,
    changed_at: new Date().toISOString(),
    source
  };

  // 4. 更新数据库
  const result = await db.query(`
    UPDATE tasks
    SET
      status = $1,
      status_history = status_history || $2::jsonb,
      updated_at = NOW()
    WHERE id = $3
    RETURNING status, updated_at
  `, [newStatus, JSON.stringify([historyEntry]), taskId]);

  // 5. 触发事件
  this.emit('task_status_changed', {
    task_id: taskId,
    from: task.status,
    to: newStatus,
    source
  });

  return result.rows[0];
}

isValidTransition(from, to) {
  const allowedTransitions = {
    'pending': ['in_progress'],
    'in_progress': ['completed', 'failed'],
    'completed': [],  // 已完成不可更改
    'failed': []      // 已失败不可更改
  };

  return allowedTransitions[from]?.includes(to) || false;
}
```

---

## 测试要求

### 单元测试

#### 1. feedbackService.test.js

```javascript
describe('FeedbackService', () => {
  test('storeFeedback - success', async () => {
    const feedbackData = {
      status: 'completed',
      summary: 'Test summary',
      metrics: { duration_seconds: 100 }
    };

    const result = await feedbackService.storeFeedback('task_id', feedbackData);

    expect(result.feedback_id).toBeDefined();
    expect(result.received_at).toBeDefined();
  });

  test('storeFeedback - task not found', async () => {
    await expect(
      feedbackService.storeFeedback('invalid_id', {})
    ).rejects.toThrow('TASK_NOT_FOUND');
  });

  test('storeFeedback - missing required fields', async () => {
    await expect(
      feedbackService.storeFeedback('task_id', { status: 'completed' })
    ).rejects.toThrow('MISSING_FIELD');
  });
});
```

#### 2. taskService.test.js (状态更新)

```javascript
describe('TaskService.updateTaskStatus', () => {
  test('updateStatus - valid transition', async () => {
    const result = await taskService.updateTaskStatus(
      'task_id',
      'in_progress',
      'engine'
    );

    expect(result.status).toBe('in_progress');
    expect(result.updated_at).toBeDefined();
  });

  test('updateStatus - invalid transition', async () => {
    await expect(
      taskService.updateTaskStatus('completed_task_id', 'pending')
    ).rejects.toThrow('INVALID_TRANSITION');
  });
});
```

### 集成测试

#### 1. POST /feedback 端点测试

```javascript
describe('POST /api/brain/tasks/:task_id/feedback', () => {
  test('应该接收并存储反馈', async () => {
    const response = await request(app)
      .post('/api/brain/tasks/task_123/feedback')
      .send({
        status: 'completed',
        summary: 'Task completed successfully',
        metrics: { duration_seconds: 4800 }
      });

    expect(response.status).toBe(200);
    expect(response.body.success).toBe(true);
    expect(response.body.feedback_id).toBeDefined();
  });

  test('应该拒绝无效的 task_id', async () => {
    const response = await request(app)
      .post('/api/brain/tasks/invalid_id/feedback')
      .send({ status: 'completed', summary: 'Test' });

    expect(response.status).toBe(404);
    expect(response.body.error).toBe('Task not found');
  });
});
```

#### 2. PATCH /status 端点测试

```javascript
describe('PATCH /api/brain/tasks/:task_id', () => {
  test('应该更新任务状态', async () => {
    const response = await request(app)
      .patch('/api/brain/tasks/task_123')
      .send({ status: 'in_progress' });

    expect(response.status).toBe(200);
    expect(response.body.status).toBe('in_progress');
  });

  test('应该记录状态历史', async () => {
    await request(app)
      .patch('/api/brain/tasks/task_123')
      .send({ status: 'completed' });

    const task = await db.query('SELECT status_history FROM tasks WHERE id = $1', ['task_123']);
    expect(task.rows[0].status_history.length).toBeGreaterThan(0);
  });
});
```

---

## 验收标准 (DoD)

### 功能完整性

- [ ] POST /feedback 端点正常工作
- [ ] PATCH /status 端点正常工作
- [ ] 反馈数据正确存储到数据库
- [ ] 状态历史正确记录
- [ ] 状态转换规则正确实施
- [ ] 错误处理完整

### 数据库

- [ ] Migration 脚本可正常执行
- [ ] Rollback 脚本可正常回滚
- [ ] 索引正确创建
- [ ] 字段类型和约束正确

### 测试

- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试覆盖所有端点
- [ ] 错误场景测试完整
- [ ] 性能测试通过（< 100ms 响应）

### 文档

- [ ] API 文档完整（Swagger/OpenAPI）
- [ ] README 更新
- [ ] Migration 说明文档
- [ ] 错误码文档

### 集成

- [ ] 与 Engine Phase 4a 端到端测试通过
- [ ] upload-feedback.sh 可正常调用
- [ ] update-task-status.sh 可正常调用
- [ ] 降级处理验证（Brain 不可用时 Engine 继续工作）

---

## 性能要求

| 指标 | 要求 |
|------|------|
| POST /feedback 响应时间 | < 100ms (P95) |
| PATCH /status 响应时间 | < 50ms (P95) |
| 并发支持 | 10 req/s |
| 数据库查询 | < 20ms |

---

## 安全考虑

1. **认证**:
   - Engine 调用需要内部认证（shared secret 或 JWT）
   - 或仅允许 localhost 访问

2. **授权**:
   - 验证 Task 属于当前用户/系统
   - 防止跨用户访问

3. **输入验证**:
   - 严格验证所有输入字段
   - 防止 SQL 注入
   - 防止 JSON 注入

4. **速率限制**:
   - 每个 Task 每分钟最多 10 次状态更新
   - 每个 Task 最多 100 次反馈

---

## 风险和依赖

### 技术风险

| 风险 | 缓解措施 |
|------|----------|
| 数据库迁移失败 | 完整的 rollback 脚本 + 备份策略 |
| 并发更新冲突 | 使用数据库事务 + 乐观锁 |
| JSONB 性能问题 | 适当的索引 + 查询优化 |

### 依赖

- PostgreSQL JSONB 支持（需要 9.4+）
- Node.js pg 库支持
- Engine Phase 4a 已完成（PR #552）

---

## 实现优先级

### P0 (必须完成)

1. ✅ 数据库 Schema 变更
2. ✅ POST /feedback 端点
3. ✅ PATCH /status 端点
4. ✅ 基本错误处理
5. ✅ 单元测试

### P1 (应该完成)

6. ✅ 集成测试
7. ✅ API 文档
8. ✅ 状态转换规则完整实现
9. ✅ 与 Engine 端到端测试

### P2 (可选)

10. ⏳ 前端展示（Task 详情页）
11. ⏳ 状态历史时间线可视化
12. ⏳ Metrics 图表
13. ⏳ 高级查询 API（按反馈内容搜索等）

---

## 成功标准

**Phase 4b 完成的标志**:

1. ✅ Engine 可以成功上传反馈到 Brain
2. ✅ Engine 可以成功同步状态到 Brain
3. ✅ Brain 数据库正确存储反馈和状态历史
4. ✅ 所有测试通过（单元 + 集成）
5. ✅ 与 Engine Phase 4a 端到端测试通过
6. ✅ API 文档完整
7. ✅ CI 通过

**验证方式**:

```bash
# 在 Engine 项目运行 /dev 完整流程
cd /home/xx/perfect21/cecelia/engine
# (假设 Brain 服务运行在 localhost:5221)

# 1. /dev 启动 → Step 1 调用 update-task-status.sh
# 预期: Brain 数据库 tasks 表中状态更新为 in_progress

# 2. /dev 完成 → Step 10 调用 upload-feedback.sh
# 预期: Brain 数据库 tasks 表中 feedback 字段有数据

# 3. 查询 Brain API 验证
curl http://localhost:5221/api/brain/tasks/$TASK_ID | jq '.feedback'
# 预期: 返回反馈数据

curl http://localhost:5221/api/brain/tasks/$TASK_ID | jq '.status_history'
# 预期: 返回状态历史
```

---

## 相关资源

- **Phase 4a PR**: perfectuser21/cecelia-engine#552
- **Phase 4a Learning**: `/home/xx/perfect21/cecelia/engine/docs/learning/dev-feedback-upload-phase4a-learning.md`
- **Engine Scripts**:
  - `/home/xx/perfect21/cecelia/engine/skills/dev/scripts/upload-feedback.sh`
  - `/home/xx/perfect21/cecelia/engine/skills/dev/scripts/update-task-status.sh`
- **Brain 项目**: `/home/xx/perfect21/cecelia/core`
- **Brain API Base**: `http://localhost:5221/api/brain`

---

**创建时间**: 2026-02-08
**目标项目**: cecelia-core (Brain)
**依赖项目**: cecelia-engine (Engine) Phase 4a
**预计工时**: 2-3 小时（核心功能）
