# DoD - 修复 Embeddings 生成无限重试

## 验收标准

### 功能验收

#### 1. Quota 超限时快速失败
- [ ] OpenAI quota exceeded 错误被检测并立即退出（exit 1）
      Test: brain/src/__tests__/generate-capability-embeddings.test.js
- [ ] 脚本在 5 秒内退出，不继续处理剩余 capabilities
      Test: brain/src/__tests__/generate-capability-embeddings.test.js
- [ ] 输出清晰的错误信息（包含 "quota exceeded" 关键字）
      Test: brain/src/__tests__/generate-capability-embeddings.test.js

#### 2. 连续失败限制
- [ ] 连续 3 个 capabilities 失败后脚本退出（exit 1）
      Test: brain/src/__tests__/generate-capability-embeddings.test.js
- [ ] 不会无限循环处理所有 23 个 capabilities
      Test: brain/src/__tests__/generate-capability-embeddings.test.js

#### 3. 正常成功场景
- [ ] OpenAI API 正常时，所有 capabilities 成功生成 embeddings
      Test: brain/src/__tests__/generate-capability-embeddings.test.js
- [ ] 脚本正常退出（exit 0）
      Test: brain/src/__tests__/generate-capability-embeddings.test.js

#### 4. 部分成功场景
- [ ] 前 N 个成功，后续失败时，成功的 embeddings 已保存到数据库
      Test: brain/src/__tests__/generate-capability-embeddings.test.js
- [ ] 连续 3 次失败后退出，不继续尝试剩余
      Test: brain/src/__tests__/generate-capability-embeddings.test.js

### 性能验收

- [ ] 模拟 quota exceeded 时，脚本在 5 秒内退出
      Test: brain/src/__tests__/generate-capability-embeddings.test.js
- [ ] 运行时 CPU 使用率不超过 50%（防止无限重试）
      Test: manual:监控 CPU 使用率
- [ ] PostgreSQL 连接正常，无连接池耗尽
      Test: manual:检查 PostgreSQL 日志

### 代码质量验收

- [ ] openai-client.js 正确区分临时错误（网络）和永久错误（quota）
      Test: brain/src/__tests__/openai-client.test.js
- [ ] 现有测试全部通过
      Test: contract:C2-001
- [ ] 新增测试覆盖 quota 错误、连续失败等场景
      Test: brain/src/__tests__/generate-capability-embeddings.test.js

### 测试验收

- [ ] npm test 通过
      Test: contract:C2-001
- [ ] 本地运行脚本验证（模拟 quota 错误）
      Test: manual:运行 node brain/src/generate-capability-embeddings.mjs
