---
id: dod-capability-driven-dev
version: 1.0.0
created: 2026-02-14
changelog:
  - 1.0.0: 初始 DoD
---

# DoD: Capability-Driven Development Framework (Phase 1: Core)

## 快速验收清单

- [ ] Migration 030 创建 capabilities 表（23 条种子数据）
- [ ] Migration 030 修改 pr_plans 表（4 个新字段 + CHECK 约束）
- [ ] Brain API GET /api/brain/capabilities 返回 23 条
- [ ] Brain API GET /api/brain/capabilities/:id 正常工作
- [ ] Brain API PATCH /api/brain/capabilities/:id 更新 stage
- [ ] Brain API POST /api/brain/capabilities 创建新 capability
- [ ] selfcheck.js EXPECTED_SCHEMA_VERSION = '030'
- [ ] DEFINITION.md 同步（版本号 1.36.0 + schema 030 + 新端点）
- [ ] 所有测试通过（migration-030.test.js + capabilities-api.test.js）
- [ ] CI DevGate 通过（Version Check + Facts Consistency）

## 详细验收标准

### 1. Migration 030 - capabilities 表创建 ✓

**验收标准**：
```sql
-- 表存在且结构正确
SELECT table_name FROM information_schema.tables
WHERE table_schema = 'public' AND table_name = 'capabilities';

-- 23 条种子数据已灌入
SELECT count(*) FROM capabilities; -- 期望: 23
```

**测试文件**：
- `brain/src/__tests__/migration-030.test.js`
- 测试内容：表结构、字段类型、约束、种子数据完整性

---

### 2. Migration 030 - pr_plans 新字段 ✓

**验收标准**：
```sql
-- 新字段存在
SELECT column_name, data_type FROM information_schema.columns
WHERE table_name = 'pr_plans'
  AND column_name IN ('capability_id', 'from_stage', 'to_stage', 'evidence_required');

-- 外键约束存在
SELECT constraint_name FROM information_schema.table_constraints
WHERE table_name = 'pr_plans' AND constraint_type = 'FOREIGN KEY';

-- stage 推进约束存在
SELECT constraint_name FROM information_schema.table_constraints
WHERE table_name = 'pr_plans' AND constraint_name = 'chk_stage_progression';
```

**测试文件**：
- `brain/src/__tests__/migration-030.test.js`
- 测试内容：外键约束、CHECK 约束、拒绝 from_stage >= to_stage

---

### 3. Migration 030 - 约束验证 ✓

**验收标准**：
```sql
-- 测试：插入合法数据成功
INSERT INTO pr_plans (capability_id, from_stage, to_stage, ...)
VALUES ('autonomous-task-scheduling', 2, 3, ...);  -- 应该成功

-- 测试：拒绝 from_stage >= to_stage
INSERT INTO pr_plans (from_stage, to_stage, ...)
VALUES (3, 2, ...);  -- 应该报错

INSERT INTO pr_plans (from_stage, to_stage, ...)
VALUES (3, 3, ...);  -- 应该报错
```

**测试文件**：
- `brain/src/__tests__/pr-plans-stage-constraints.test.js`

---

### 4. Brain API - GET /api/brain/capabilities ✓

**验收标准**：
```bash
curl -s http://localhost:5221/api/brain/capabilities | jq 'length'
# 期望: 23

curl -s http://localhost:5221/api/brain/capabilities | jq '.[0]' | jq 'keys'
# 期望包含: id, name, description, current_stage, related_repos, related_skills, key_tables
```

**测试文件**：
- `brain/src/__tests__/capabilities-api.test.js`
- 测试内容：列出所有 capabilities、返回字段完整性、分页（如有）

---

### 5. Brain API - GET /api/brain/capabilities/:id ✓

**验收标准**：
```bash
curl -s http://localhost:5221/api/brain/capabilities/autonomous-task-scheduling | jq '.id'
# 期望: "autonomous-task-scheduling"

curl -s http://localhost:5221/api/brain/capabilities/nonexistent | jq '.error'
# 期望: 404 错误
```

**测试文件**：
- `brain/src/__tests__/capabilities-api.test.js`
- 测试内容：单个 capability 查询、不存在时返回 404

---

### 6. Brain API - PATCH /api/brain/capabilities/:id ✓

**验收标准**：
```bash
# 更新 stage
curl -X PATCH http://localhost:5221/api/brain/capabilities/autonomous-task-scheduling \
  -H "Content-Type: application/json" \
  -d '{"current_stage": 4, "evidence": "连续 7 天成功率 > 95%"}'

# 验证更新成功
curl -s http://localhost:5221/api/brain/capabilities/autonomous-task-scheduling | jq '.current_stage'
# 期望: 4

# 拒绝非法 stage
curl -X PATCH http://localhost:5221/api/brain/capabilities/autonomous-task-scheduling \
  -d '{"current_stage": 5}'
# 期望: 400 错误
```

**测试文件**：
- `brain/src/__tests__/capabilities-api.test.js`
- 测试内容：更新 stage、更新 evidence、拒绝非法值、并发更新

---

### 7. Brain API - POST /api/brain/capabilities ✓

**验收标准**：
```bash
# 创建新 capability（从 proposal 审批后）
curl -X POST http://localhost:5221/api/brain/capabilities \
  -H "Content-Type: application/json" \
  -d '{
    "id": "test-capability",
    "name": "测试能力",
    "description": "用于测试的能力",
    "current_stage": 1
  }'

# 验证创建成功
curl -s http://localhost:5221/api/brain/capabilities/test-capability | jq '.id'
# 期望: "test-capability"

# 拒绝重复 ID
curl -X POST http://localhost:5221/api/brain/capabilities \
  -d '{"id": "test-capability", ...}'
# 期望: 409 冲突错误
```

**测试文件**：
- `brain/src/__tests__/capabilities-api.test.js`
- 测试内容：创建 capability、必填字段校验、ID 唯一性

---

### 8. selfcheck - schema_version 同步 ✓

**验收标准**：
```bash
# selfcheck.js 中 EXPECTED_SCHEMA_VERSION 已更新
grep "EXPECTED_SCHEMA_VERSION = '030'" brain/src/selfcheck.js

# Brain 启动后健康检查通过
curl -s http://localhost:5221/api/brain/health | jq '.status'
# 期望: "healthy"
```

**测试文件**：
- `brain/src/__tests__/selfcheck.test.js`
- 测试内容：schema_version 匹配检查

---

### 9. DEFINITION.md 同步 ✓

**验收标准**：
```bash
# Brain 版本号已更新
grep "Brain 版本: 1.36.0" DEFINITION.md

# Schema 版本已更新
grep "Schema 版本: 030" DEFINITION.md

# 新增 API 端点已文档化
grep "/api/brain/capabilities" DEFINITION.md | wc -l
# 期望: 至少 4 条（4 个端点）
```

**测试文件**：
- `scripts/facts-check.mjs`（CI 自动检查）

---

### 10. 23 个种子数据完整性 ✓

**验收标准**：
```sql
-- 所有 23 个能力都有 id, name, current_stage
SELECT id, name, current_stage FROM capabilities ORDER BY id;

-- 每个能力的 related_repos 非空
SELECT id FROM capabilities WHERE related_repos IS NULL OR cardinality(related_repos) = 0;
-- 期望: 空结果

-- 每个能力的 current_stage 在 1-4 范围内
SELECT id, current_stage FROM capabilities WHERE current_stage NOT BETWEEN 1 AND 4;
-- 期望: 空结果
```

**测试文件**：
- `brain/src/__tests__/capabilities-seed-data.test.js`
- 测试内容：种子数据数量、字段完整性、引用有效性

---

## 测试覆盖率要求

- Migration 测试：100%（表结构、约束、种子数据）
- API 端点测试：100%（CRUD 四个端点 × 正常/异常路径）
- 集成测试：pr_plans 与 capabilities 的外键关系

---

## 不包含的内容（Engine PR）

以下内容属于 Phase 2（Engine PR），不在本次 DoD 范围：
- ❌ validate-okr.py 升级
- ❌ store-to-database.sh 修改
- ❌ /okr SKILL.md 规则更新
- ❌ Workspace Capability Map Dashboard

---

## CI DevGate 检查项

1. **Version Check**：brain/package.json version 同步
2. **Facts Consistency**：DEFINITION.md 与代码一致（schema_version, brain_port, endpoints）
3. **Brain Tests**：所有新增测试通过
4. **DoD Mapping**：每条 DoD 对应测试文件存在

---

## 完成标志

```bash
# 所有测试通过
npm test -- migration-030
npm test -- capabilities-api
npm test -- pr-plans-stage-constraints

# selfcheck 通过
curl http://localhost:5221/api/brain/health | jq '.status' # "healthy"

# 种子数据验证
curl http://localhost:5221/api/brain/capabilities | jq 'length' # 23

# CI 通过
gh run list --repo perfectuser21/core --branch cp-02140001-capability-driven-dev --limit 1 | grep "completed.*success"
```
