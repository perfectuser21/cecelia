---
id: prd-cp-02211200-idle-session-cleanup
version: 1.0.0
created: 2026-02-21
updated: 2026-02-21
changelog:
  - 1.0.0: 初始版本
---

# PRD: Brain Watchdog 空闲交互式 Claude 会话自动清理

## 背景

Brain watchdog 目前只监控 Brain 派发的后台任务（通过 slot lock 文件管理）。
用户的交互式 Claude Code 会话（前台 `claude` 进程）不受任何监控，即使用户已经
关闭了终端，孤立进程仍然占用 CPU slot 和内存，导致资源浪费。

## 问题

- 用户关闭 tmux session 或浏览器 tab 后，`claude` 进程变为僵尸/孤立进程
- 这些进程占用 CPU slot（Brain 认为 slot 满了，不再派发新任务）
- 实际上这些进程空闲（CPU < 1%），无法自动恢复
- 用户需要手动 `kill` 才能释放 slot

## 功能描述与成功标准

在 Brain watchdog 中添加空闲交互式 Claude 会话检测与自动清理：

1. 扫描系统中所有 `claude`（前台交互式）进程
2. 排除 Brain slot 锁管理的进程（那些是 `claude -p` 后台任务）
3. 跟踪每个前台进程的 CPU 使用历史
4. 如果一个进程持续 **2 小时内 CPU < 1%**，自动发送 SIGTERM（60秒后 SIGKILL）

## 关键设计决策

### 进程识别
- 扫描 `/proc/*/cmdline` 找到所有 `claude` 进程
- 排除 `claude -p ...`（后台任务，Brain 管理）
- 排除 `bash -c ...` 等包装进程
- 排除已在 Brain slot lock 中的 PID

### 空闲判定
- 跟踪 `lastHighCpuTs`：最后一次 CPU >= 1% 的时间戳
- 初次见到 PID 时，设 `lastHighCpuTs = Date.now()`（给宽限期）
- 每个 tick（5s）采样一次 CPU
- 如果 `Date.now() - lastHighCpuTs > 2h` → 判定为空闲，发起清理

### 清理方式
- SIGTERM → 等 60s → SIGKILL（两阶段，与 `killProcessTwoStage` 一致）
- 记录日志：`[tick] idle-session kill: pid=X reason=...`
- 不涉及 Brain 任务状态更新（这不是 Brain 管理的任务）

## 验收条件

1. `scanInteractiveClaude(managedPids)` 正确识别前台 claude 进程
2. 排除 `claude -p`、`bash -c`、Brain slot 管理的 PID
3. `checkIdleSessions()` 跟踪 CPU 历史，返回超时进程的 kill action
4. tick.js 集成后，idle session 会被自动清理
5. 所有新函数有对应的 vitest 单元测试
