---
id: prd-knowledge-system-upgrade
version: 1.0.0
created: 2026-02-26
updated: 2026-02-26
changelog:
  - 1.0.0: 初始版本
---

# PRD: 知识系统全面升级 — 从"有能力"到"能感知"

## 背景

Cecelia 已具备完整的知识系统基础设施（memory_stream、learnings、rumination、desire system），但用户反馈"感觉不出强大"。深度分析发现 7 个断裂点：

1. **Learnings = 垃圾场**：889 条中 99.9% 是重复的 `failure_pattern`（Task Failure: watchdog-kill），0 条真正的用户知识
2. **反刍 = 浅层摘要**：用 Haiku 做"1-2句洞察"，逐条处理无法发现模式
3. **反思被脏数据淹没**：memory_stream 93% 是重复感知信号，反思每次产出几乎一样
4. **欲望系统只会报警**：60 个 desires 全是 inform/warn，0 个 act/propose/celebrate
5. **记忆是隐性的**：记忆注入 prompt 但用户看不到，感知不到智能
6. **聊天和后台完全割裂**：聊天同步完成，反刍结果不推送到对话
7. **去重基础设施是摆设**：content_hash/version/parent_id 列存在但无代码使用

## 目标

让知识系统的智能**可感知**：用户能看到 Cecelia "学到了什么"、"想到了什么"、"在研究什么"。

## 成功标准

1. Learnings 表去重可用：相似内容自动合并，不再无限积累
2. 反刍用 Opus 深度思考，批量处理发现跨知识模式
3. 反思输入去重：memory_stream 同质信号合并后再反思
4. 垃圾清理：888 条无用 failure_pattern 标记归档
5. 所有模块有测试覆盖

## 功能清单

### F1: 垃圾清理 + Learnings 去重（P0）
- Migration 081: 批量归档 888 条重复 failure_pattern learnings（digested=true, archived=true）
- recordLearning() 插入前计算 content_hash（SHA256 of title+content），重复则 version++
- chat-action-dispatcher LEARN case 同样启用 content_hash 去重
- EXPECTED_SCHEMA_VERSION 079 → 081

### F2: 反刍升级 — Opus + 批量（P0）
- model-registry.js: rumination agent recommended_model → claude-opus-4-6, allowed_models 增加 opus
- rumination.js: 批量消化（取 N 条相似 learnings 一起处理，而非逐条）
- Prompt 重写：从"1-2句洞察"→"深度思考：模式发现 + 关联分析 + 可执行建议"
- DAILY_BUDGET 10→20, MAX_PER_TICK 3→5

### F3: memory_stream 去重（P1）
- reflection.js 取 50 条记忆前，先对内容做 Jaccard 去重（复用 memory-retriever 的 simpleDedup）
- 保证反思看到的是多样化信号而非 50 条重复

### F4: 欲望多样性（P1）
- desire-formation.js prompt 调整：强调在任务完成、进度推进时选 celebrate/propose
- perception.js 新增 task_milestone 信号（任务完成率达到某阈值时触发）

### F5: 聊天异步研究流（P1）
- LEARN 意图增加异步研究：前端秒回"好的，去看了"，后台 NotebookLM 研究 → 结果写入 learnings+memory_stream
- 研究完成后通过 Desire System 自然推送到前端（不需要新机制，复用 DESIRE_EXPRESSED WebSocket）

## 不做的事

- 前端页面改动（Dashboard Knowledge 页面已在 Phase 2 做了）
- NotebookLM 容器修复（已有 bridge 降级方案）
- 新增 API 端点（已有 /learnings, /rumination/status）
