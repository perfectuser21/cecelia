# DoD - Phase 4b Brain Feedback API

## 验收标准

### 功能验收

#### 数据库 Schema
- [ ] `feedback` 字段 (JSONB 数组) 已添加到 tasks 表
      Test: brain/src/__tests__/migrations/feedback-schema.test.js
- [ ] `status_history` 字段 (JSONB 数组) 已添加到 tasks 表
      Test: brain/src/__tests__/migrations/feedback-schema.test.js
- [ ] `feedback_count` 字段 (INTEGER) 已添加到 tasks 表
      Test: brain/src/__tests__/migrations/feedback-schema.test.js
- [ ] GIN 索引已创建（idx_tasks_feedback, idx_tasks_status_history）
      Test: brain/src/__tests__/migrations/feedback-schema.test.js

#### POST /api/brain/tasks/:task_id/feedback API
- [ ] 接受正确格式的反馈请求（status, summary, metrics, artifacts）
      Test: brain/src/__tests__/routes/tasks-feedback.test.js
- [ ] 拒绝缺少必需字段的请求（status, summary）
      Test: brain/src/__tests__/routes/tasks-feedback.test.js
- [ ] 拒绝不存在的 task_id
      Test: brain/src/__tests__/routes/tasks-feedback.test.js
- [ ] 正确存储反馈到 feedback 字段（JSONB 数组）
      Test: brain/src/__tests__/routes/tasks-feedback.test.js
- [ ] 支持多次反馈追加（不覆盖已有反馈）
      Test: brain/src/__tests__/routes/tasks-feedback.test.js
- [ ] 更新 feedback_count 字段
      Test: brain/src/__tests__/routes/tasks-feedback.test.js
- [ ] 返回正确的响应格式（success, task_id, feedback_id, received_at）
      Test: brain/src/__tests__/routes/tasks-feedback.test.js

#### PATCH /api/brain/tasks/:task_id API
- [ ] 接受正确的状态更新请求（in_progress, completed, failed）
      Test: brain/src/__tests__/routes/tasks-status.test.js
- [ ] 拒绝不允许的状态转换（completed→pending, failed→in_progress）
      Test: brain/src/__tests__/routes/tasks-status.test.js
- [ ] 记录状态历史到 status_history 字段
      Test: brain/src/__tests__/routes/tasks-status.test.js
- [ ] 验证 pending→in_progress 转换成功
      Test: brain/src/__tests__/routes/tasks-status.test.js
- [ ] 验证 in_progress→completed 转换成功
      Test: brain/src/__tests__/routes/tasks-status.test.js
- [ ] 验证 in_progress→failed 转换成功
      Test: brain/src/__tests__/routes/tasks-status.test.js
- [ ] 返回正确的响应格式（success, task_id, status, updated_at）
      Test: brain/src/__tests__/routes/tasks-status.test.js

#### 错误处理
- [ ] 404 错误：Task 不存在
      Test: brain/src/__tests__/routes/tasks-feedback.test.js
- [ ] 400 错误：无效的 status 值
      Test: brain/src/__tests__/routes/tasks-status.test.js
- [ ] 400 错误：缺少必需字段
      Test: brain/src/__tests__/routes/tasks-feedback.test.js
- [ ] 409 错误：不允许的状态转换
      Test: brain/src/__tests__/routes/tasks-status.test.js

### 集成验收
- [ ] 与 Engine Phase 4a 端到端测试通过（upload-feedback.sh）
      Test: manual:运行 Engine /dev 完整流程验证反馈上传
- [ ] 与 Engine Phase 4a 端到端测试通过（update-task-status.sh）
      Test: manual:运行 Engine /dev 完整流程验证状态更新

### 测试验收
- [ ] 单元测试覆盖率 > 80%
      Test: contract:C2-001
- [ ] 所有测试通过（npm test）
      Test: contract:C2-001
- [ ] Migration 脚本可正常执行和回滚
      Test: brain/src/__tests__/migrations/feedback-schema.test.js

### 文档验收
- [ ] API 文档已更新（DEFINITION.md）
      Test: manual:检查 DEFINITION.md 包含新 API 端点
- [ ] Migration 说明文档已添加
      Test: manual:检查 brain/migrations/ 目录包含迁移文件和说明

### CI/CD
- [ ] CI 通过（Version Check, Facts Consistency, Brain Tests, Semantic Brain）
      Test: contract:C1-001
- [ ] Facts Check 通过（版本、端口、action 数量一致）
      Test: contract:C1-002
