---
id: dod-websocket-status-push
version: 1.0.0
created: 2026-02-06
updated: 2026-02-06
changelog:
  - 1.0.0: 初始版本
---

# DoD - WebSocket 状态推送

QA: docs/QA-DECISION.md

## 验收标准

### 功能验收

#### WebSocket 服务器
- [ ] WebSocket 服务在 Brain 端口 5221 上正常启动
      Test: brain/tests/websocket.test.ts
- [ ] 服务器在启动时输出 WebSocket 端点信息
      Test: manual:检查启动日志
- [ ] 服务器支持多个客户端同时连接
      Test: brain/tests/websocket.test.ts

#### 连接管理
- [ ] 客户端可以成功连接到 ws://localhost:5221/ws
      Test: brain/tests/websocket.test.ts
- [ ] 断开连接后客户端状态被正确清理
      Test: brain/tests/websocket.test.ts
- [ ] 服务器维护所有活跃连接的列表
      Test: brain/tests/websocket.test.ts

#### 状态推送
- [ ] 当 runs 表的 status 更新时，所有连接的客户端收到推送
      Test: brain/tests/runs-websocket.test.ts
- [ ] 当 runs 表的 progress 更新时，所有连接的客户端收到推送
      Test: brain/tests/runs-websocket.test.ts
- [ ] 推送消息格式符合定义的 WSMessage 接口
      Test: brain/tests/websocket.test.ts
- [ ] 推送消息包含完整的任务信息（id, status, progress 等）
      Test: brain/tests/runs-websocket.test.ts

#### 消息格式
- [ ] 消息包含正确的 type 字段（run_update/run_complete/run_failed）
      Test: brain/tests/websocket.test.ts
- [ ] 消息包含完整的 data 对象
      Test: brain/tests/websocket.test.ts
- [ ] 消息包含 ISO 格式的 timestamp
      Test: brain/tests/websocket.test.ts

#### 错误处理
- [ ] 客户端连接失败时不影响其他客户端
      Test: brain/tests/websocket.test.ts
- [ ] 推送失败时不阻塞数据库操作
      Test: brain/tests/runs-websocket.test.ts
- [ ] 无效消息被正确处理和记录
      Test: brain/tests/websocket.test.ts

### 测试验收
- [ ] npm run test 通过
      Test: contract:RCI-WS-001
- [ ] 使用 wscat 手动测试连接成功
      Test: manual:使用 wscat -c ws://localhost:5221/ws 连接并接收消息
- [ ] 手动更新数据库验证推送
      Test: manual:UPDATE runs SET status='running' 后客户端收到消息

### 代码质量
- [ ] TypeScript 类型定义完整
      Test: brain/tests/websocket.test.ts
- [ ] 无 TypeScript 编译错误
      Test: npm run build
- [ ] 代码符合项目风格规范
      Test: npm run lint

### 文档验收
- [ ] WebSocket 消息格式有完整的 TypeScript 接口定义
      Test: brain/src/types/websocket.ts
- [ ] 关键函数有注释说明
      Test: manual:代码审查
