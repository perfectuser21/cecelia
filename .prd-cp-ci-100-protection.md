# PRD: CI 100% 防护能力修复 (cp-ci-100-protection)
# PRD: CI 100% 防护能力修复 (cp-ci-100-protection)

## 目标

修复 zenithjoy-engine CI 系统的所有已知漏洞，达到 100% 防护能力，确保 CI 作为最后一道防线不可被绕过。

**分支**: cp-ci-100-protection
**日期**: 2026-02-03

## 背景

当前 CI 系统存在多个 CRITICAL 级别的漏洞和架构问题，防护能力仅约 55%。前端已有 100% 自由度，必须完全依靠 CI 防护。

## 需要修复的问题

### P0 - CRITICAL（阻塞性）

1. **ci-passed 不等待回归测试**
   - 问题：ci-passed job 在 regression-pr/release-check 还在运行时就返回 success
   - 后果：PR 可以在回归测试完成前合并
   - 修复：添加到 needs 依赖链，修改 if 条件

2. **back-merge workflow 权限不足**
   - 问题：`permissions: contents: read` 无法执行 merge
   - 后果：back-merge 100% 失败，分支长期分叉
   - 修复：改为 `contents: write`，移除 `|| true` 错误吞掉

3. **Evidence 系统可被完全伪造**
   - 问题：可以本地创建假 checks，生成证据，通过验证
   - 后果：所有质量检查形同虚设
   - 修复：强制 checks 目录存在，添加 CI run ID 验证，添加数字签名

4. **L2B 证据可以编造**
   - 问题：纯文本 markdown，无法验证真实性
   - 后果：手动验证可以随意伪造
   - 修复：要求 CI job URL、artifact 链接等可验证证据

### P1 - HIGH（高优先级）

5. **DevGate glob regex bug**
   - 位置：`scan-rci-coverage.cjs:301-312`
   - 问题：替换顺序错误，`**` 递归通配符失效

6. **shell 转义不完整**
   - 位置：`snapshot-prd-dod.sh:168-171`
   - 问题：缺少 backtick 和 `$()` 转义

7. **nightly workflow 失败**
   - 问题：git push 被分支保护阻止，100% 失败
   - 修复：改为 artifact 上传

8. **缺少超时配置**
   - 问题：impact-check 没有超时，默认 360 分钟
   - 修复：添加 `timeout-minutes: 5`

### P2 - MEDIUM（架构改进）

9. **Evidence 存储在 git 中**
   - 问题：可以修改历史
   - 修复：移到 Notion 等 immutable storage

10. **Manual verification 无签名**
    - 问题：可以随意伪造
    - 修复：改为 GitHub Issue + approval

## 实现方案

### 阶段 1：立即修复（今天）

1. 修复 ci-passed 依赖链
2. 修复 back-merge 权限
3. 强制 Evidence checks 验证
4. 添加超时配置
5. 修复 DevGate 脚本 bug

### 阶段 2：加固 Evidence（本周）

6. 添加 CI run ID 验证
7. 添加数字签名
8. 添加时间戳验证
9. 重构 L2B Evidence

### 阶段 3：架构重构（后续）

10. Evidence 移到 immutable storage
11. Manual verification 改为 GitHub Issue

## 验收标准

- ✅ 所有 P0 问题修复
- ✅ 所有 P1 问题修复
- ✅ CI 测试通过
- ✅ 防护能力达到 97%+
- ✅ 无法通过本地伪造绕过 CI

## 技术栈

- GitHub Actions workflow
- Shell scripts
- Node.js (DevGate scripts)
- GPG/数字签名

## 风险

- 修改 CI workflow 可能影响现有 PR
- Evidence 系统重构需要兼容旧格式
- 需要充分测试避免破坏现有功能
