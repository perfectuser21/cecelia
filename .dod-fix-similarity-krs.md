# DoD: Fix similarity.js KRs Query

## Code Changes

### similarity.js Line 163-172
- [ ] 更新 SQL 查询：`LEFT JOIN okrs` → `LEFT JOIN goals`
- [ ] 更新 JOIN 条件：`kr.okr_id = o.id` → `kr.goal_id = g.id AND g.type = 'objective'`
- [ ] 更新 SELECT 字段：
  - [ ] `o.id as okr_id` → `g.id as goal_id`
  - [ ] `o.objective` → `g.title as goal_title`
  - [ ] 添加 `kr.target_value, kr.current_value, kr.unit`

### similarity.js Line 174-186
- [ ] 更新 metadata 字段名：
  - [ ] `okr_id` → `goal_id`
  - [ ] `okr_objective` → `goal_title`
- [ ] 添加新 metadata 字段：`target_value`, `current_value`, `unit`
- [ ] 更新 description 生成逻辑（使用 target/current values）

## Unit Tests

- [ ] `npm test -- similarity.test.js` 全部通过
- [ ] 确认没有引入新的测试失败

## Integration Tests

- [ ] Brain 启动成功（selfcheck 通过）
- [ ] POST /api/brain/search-similar 不报 "okrs does not exist" 错误
- [ ] 返回结果包含 level='kr' 的实体（如果 DB 有 KR 数据）
- [ ] KRs 的 metadata 包含 goal_id 字段

## Manual Tests

- [ ] 创建测试数据：
  ```sql
  INSERT INTO goals (id, title, type, status) VALUES
    ('test-obj-1', 'Test Objective', 'objective', 'active');
  INSERT INTO key_results (id, goal_id, title, target_value, current_value, unit, status) VALUES
    ('test-kr-1', 'test-obj-1', 'Test KR', 100, 50, '%', 'in_progress');
  ```
- [ ] 调用 API:
  ```bash
  curl -X POST http://localhost:5221/api/brain/search-similar \
    -H "Content-Type: application/json" \
    -d '{"query": "test", "topK": 5}'
  ```
- [ ] 验证返回结果包含 test-kr-1
- [ ] 验证 metadata.goal_id = 'test-obj-1'

## Version Sync

- [ ] 版本号 patch bump: 1.31.3 → 1.31.4
- [ ] `brain/package.json` 更新
- [ ] `brain/package-lock.json` 同步
- [ ] `brain/VERSION` 文件同步
- [ ] `.brain-versions` 文件同步
- [ ] `DEFINITION.md` brain_version 同步

## CI/CD

- [ ] 所有测试通过
- [ ] Facts Consistency check 通过
- [ ] Version Sync check 通过
- [ ] PR 创建并合并到 develop
