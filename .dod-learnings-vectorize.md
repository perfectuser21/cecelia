# DoD - Learnings 向量化 (Phase 2)

## 验收标准

### 功能验收

- [ ] Migration 053: learnings 表新增 embedding vector(1536) 列 + HNSW 索引
      Test: brain/src/__tests__/learnings-vectorize.test.js
- [ ] embedding-service.js: 新增 generateLearningEmbeddingAsync() fire-and-forget
      Test: brain/src/__tests__/learnings-vectorize.test.js
- [ ] learning.js recordLearning(): INSERT 后 fire-and-forget 调用 generateLearningEmbeddingAsync
      Test: brain/src/__tests__/learnings-vectorize.test.js
- [ ] learning.js searchRelevantLearnings(): 优先向量搜索，fallback 关键词匹配
      Test: brain/src/__tests__/learnings-vectorize.test.js
- [ ] 向量搜索 SQL: 使用 cosine distance (<=>) + embedding IS NOT NULL 过滤
      Test: brain/src/__tests__/learnings-vectorize.test.js
- [ ] 关键词 boost: 向量结果叠加 task_type/failure_class/event_type 匹配加分
      Test: brain/src/__tests__/learnings-vectorize.test.js
- [ ] OpenAI API 不可用时 graceful fallback 到关键词匹配
      Test: brain/src/__tests__/learnings-vectorize.test.js
- [ ] backfill 脚本: 批量处理存量 learnings（每批 50 条，sleep 1s）
      Test: brain/src/__tests__/learnings-vectorize.test.js
- [ ] selfcheck.js EXPECTED_SCHEMA_VERSION 052 → 053
      Test: brain/src/__tests__/learnings-vectorize.test.js

### 测试验收

- [ ] npm run qa 通过
      Test: contract:C2-001
