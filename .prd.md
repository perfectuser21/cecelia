---
id: prd-thalamus-memory-inject
version: 1.0.0
created: 2026-02-19
updated: 2026-02-19
changelog:
  - 1.0.0: 初始版本
---

# PRD: thalamus 决策前注入 Memory API 语义搜索结果

## 需求来源

在 thalamus.js 的 analyzeEvent() 函数中，在构建 prompt 前额外调用 Memory API 语义搜索，将相关的历史任务上下文注入到决策 prompt 中，使 thalamus 决策更具历史上下文感知。

## 功能描述

在 thalamus.js 的 `analyzeEvent()` 函数中，于构建 LLM prompt 之前，调用 Memory API 进行语义搜索，将相关历史任务上下文（tasks/projects/goals）注入到决策 prompt 中。

当前状态：
- thalamus.js 已有 learnings（失败经验）注入
- 缺少 Memory API 向量语义搜索（tasks/projects/goals 历史）

新增逻辑：
1. 从 event.payload 中提取搜索 query（title/description）
2. 调用 Memory API（GET /api/memory/search?q=...&limit=3）
3. 将结果格式化后注入 prompt（最多 3 条，每条 150 字符）
4. Memory 搜索失败时使用空结果（graceful fallback）

## 涉及文件

- brain/src/thalamus.js（主要修改 - analyzeEvent() 函数）
- brain/src/__tests__/thalamus-memory-injection.test.js（新增单元测试）

## 成功标准

- analyzeEvent() 在决策前调用 Memory 搜索
- prompt 中包含 Memory 搜索结果段落
- Memory 搜索失败时不影响主流程（graceful fallback）
- 单元测试覆盖新逻辑（至少 3 个测试用例）
- facts-check.mjs 通过

## 非目标

- 不修改 Memory API 本身
- 不修改 prompt 的其他部分结构
- 不改变 analyzeEvent() 的返回结构
- 不修改 learnings 注入逻辑
