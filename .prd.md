---
id: prd-thalamus-stability-bugfix
version: 1.0.0
created: 2026-02-18
updated: 2026-02-18
changelog:
  - 1.0.0: 初始版本
---

# PRD: thalamus.js 4 处稳定性 Bug 修复

## 需求来源

thalamus.js 存在 4 处会导致运行时崩溃的 Bug，需修复以提升系统稳定性。

## Bug 清单

### BUG P1 (line 777) — Critical
`processEvent(null/undefined)` 直接 crash：`event.type` 无 null guard。
修复：入口加 guard，null event 返回 fallback decision。

### BUG P3 (line 445 callSonnet) — High
`data.content[0].text` — API 返回空 content 数组时 TypeError。
修复：用 `content.find(b => b.type==='text')` 替代 `content[0]`，找不到时 throw 清晰错误。

### BUG P2 (line 455 parseDecisionFromResponse) — High
贪婪正则在 Sonnet 回复含多个 `{}` 块时解析错误。
修复：优先匹配 markdown code block 中的 JSON，再 fallback 原正则。

### BUG P4 (line 807) — Medium
`cortexDecision.actions.map()` 无 null guard。
修复：`(cortexDecision.actions || []).map(a => a.type).join(",")`

## 成功标准

- processEvent(null) 返回 fallback decision，不 crash
- callSonnet 空 content 时抛清晰错误（非 TypeError）
- parseDecisionFromResponse 多 JSON block 正确解析
- cortex actions null 不抛 TypeError
- npm test 全通过
- facts-check 通过
- version bump patch
