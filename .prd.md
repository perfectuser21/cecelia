## PRD - Plan Proposal 系统

**需求来源**: Brain 当前任务编排是纯算法（priority + depends_on + focus），缺少 LLM 智能规划和人类手动编排入口。需要在现有调度器外面加一层"提案系统"。

**功能描述**:
在不修改现有 planner/dispatcher 的前提下，新增 Plan Proposal 系统：
1. **proposals 表**：存储结构化提案（LLM 生成或用户手动创建）
2. **proposal.js**：提案生成、验证、应用逻辑 + 约束层
3. **/api/brain/plan 统一入口**：接收 LLM 提案和用户 UI 操作
4. **约束层**：白名单字段检查、DAG 环检测、速率限制、批量审批

**核心设计原则**：
- LLM 只出方案（proposal），不直接改队列
- 调度器只读 priority/depends_on/next_run_at/focus（不动）
- 所有变更可审计、可回滚

**proposals 表结构**：
- id, source (llm_proposal | user_ui), type (project_plan | reorder | optimization)
- scope (objective | kr | project | feature)
- changes (jsonb - 结构化变更集合)
- risk_level (low | medium | high)
- status (draft | pending_review | approved | applied | rejected | rolled_back)
- approved_at, approved_by, applied_at, rolled_back_at
- created_at, updated_at

**changes 白名单动作**：
- create_tasks（带 priority, depends_on, estimated_minutes, skill）
- update_task（priority / next_run_at / scheduled_for）
- set_focus（每日焦点）
- add_dependency（depends_on）
- remove_dependency
- split_task / merge_tasks

**约束层硬规则**：
1. 只允许白名单字段变更
2. 依赖不能成环（DAG 检测）
3. 速率限制（每分钟最多 20 次 priority 变更）
4. 批量变更（>5 条 task）必须审批

**涉及文件**:
- `brain/migrations/010_proposals.sql` — 新建 proposals 表
- `brain/src/proposal.js` — 提案逻辑（生成 / 验证 / 应用 / 回滚）
- `brain/src/routes.js` — 新增 /api/brain/plan 等端点
- `brain/src/selfcheck.js` — EXPECTED_SCHEMA_VERSION → 010
- `brain/src/thalamus.js` — 新增 create_proposal 到 ACTION_WHITELIST

**成功标准**:
1. POST /api/brain/plan 能创建提案（source=llm_proposal 或 user_ui）
2. 提案必须经过约束层验证（白名单 + DAG + 速率）
3. POST /api/brain/proposals/:id/approve 审批后自动应用变更
4. 应用的变更被调度器正常吸收（priority/depends_on/focus 生效）
5. POST /api/brain/proposals/:id/rollback 可回滚
6. Brain 测试不回归 + DevGate 全绿

**非目标**:
- 不修改 planner.js 评分算法
- 不修改 tick.js 派发逻辑
- 不做前端 UI（那是 workspace 仓库的事）
- 不做 LLM 自动生成提案的触发（那是后续 Feature，先做基础设施）
