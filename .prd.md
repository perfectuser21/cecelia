---
id: prd-planner-content-aware-score
version: 1.0.0
created: 2026-02-18
updated: 2026-02-18
changelog:
  - 1.0.0: 初始版本
---

# PRD: planner.js 内容感知排序

## 需求来源

探索调研（task 4da2a503）确认：planner.js 当前 scoreKRs() 只基于 progress/priority/wait_time 打分，不感知 task 的 task_type 和 payload 内容。当队列中同时有 exploratory（调研类）和 dev（实现类）任务时，无法区分优先级差异，可能导致调研任务和实现任务错序执行。

## 功能描述

在 planner.js 的任务评分逻辑中增加 task_type 内容感知权重：
- exploratory task：+10 分（调研先行）
- dev task with payload.wait_for_exploratory=true：-20 分（等待调研完成再执行）
- dev task with payload.decomposition_mode=known：+5 分（已知方案优先）

## 涉及文件

- brain/src/planner.js（增加 applyContentAwareScore 函数，集成到评分流程）
- brain/src/__tests__/planner-content-aware.test.js（新增测试文件）

## 成功标准

- applyContentAwareScore() 函数存在并正确计算 _content_score_bonus
- exploratory task: +10 分
- wait_for_exploratory=true dev task: -20 分
- decomposition_mode=known dev task: +5 分
- 无 payload 的 task 不受影响（bonus=0）
- 可观测性日志（debug 级别）
- 3个 vitest 测试全部通过
- facts-check.mjs 通过
- check-version-sync.sh 通过（patch bump）

## 非目标

不修改现有 scoreKRs() 的基础评分逻辑，只作为辅助排序参考。
