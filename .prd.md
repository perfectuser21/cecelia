## PRD - Task System + Quality System Integration (Complete MVP)

**需求来源**: "需要系统架构师 + DevOps 工程师 + 智能体工程专家，设计完整的任务系统与质检系统集成架构"

**核心目标**:
将 Quality System (现有) 与 Task System (Gateway MVP) 完全集成，形成统一的自驱动开发平台。

**架构原则**:
- VPS = 大脑（任务管理 + 执行调度 + 证据写入 + 状态机）
- Notion = UI（展示层，单向同步）
- QA = 免疫系统（在大脑内部运行）
- CloudCode = 工人（Worker召唤，非常驻）

---

## 1. 系统架构

### 现有系统 (Quality System)

```
Control Plane (控制平面)
├── repo-registry.yaml    - 仓库注册表
├── qa-policy.yaml        - QA 策略配置
└── schemas/              - 数据结构定义

Contracts (质量契约)
├── regression-contract.yaml  - RCI + Golden Paths 定义
└── validators/               - 契约验证器

Executor (执行器)
├── qa-run-all.sh    - 全量质检
├── qa-run-rci.sh    - 回归契约检查
└── qa-run-gp.sh     - Golden Path 验证
```

### 新增系统 (Task System)

```
Gateway (统一入口)
├── gateway.sh           - CLI 入口
├── gateway-http.js      - HTTP 服务器
└── task-schema.json     - 任务格式定义

Queue (任务队列)
└── queue.jsonl          - FIFO + Priority

Worker (工作器)
├── worker.sh            - 队列消费者
└── executors/           - Intent 执行器

State (状态机)
├── state.json           - 全局状态
└── runs/<runId>/        - 执行记录

Heartbeat (自主监控)
├── heartbeat.sh         - 定时检查脚本
└── heartbeat.n8n.json   - n8n workflow 版本

Database (持久化)
└── db/
    ├── cecelia.db       - SQLite 数据库
    └── schema.sql       - 表结构定义
```

---

## 2. 核心功能

### 2.1 Database (SQLite)

**表结构**:
- `areas` - 领域（work, personal, health）
- `projects` - 项目（cecelia-quality, zenithjoy-engine）
- `tasks` - 任务（inbox, todo, doing, blocked, done）
- `runs` - 执行记录（queued, running, succeeded, failed）
- `evidence` - 证据（qa_report, audit_report, test_result）
- `inbox` - 收件箱（原始输入）
- `system_state` - 系统状态（健康度、队列长度）
- `notion_sync` - Notion 同步追踪

**视图**:
- `active_tasks` - 活跃任务视图
- `recent_runs` - 最近运行视图
- `system_health` - 系统健康视图

### 2.2 Gateway (统一入口)

**CLI 模式**:
```bash
./gateway/gateway.sh add <source> <intent> [priority] [payload]
./gateway/gateway.sh enqueue <json>
./gateway/gateway.sh status
```

**HTTP 模式**:
```bash
POST http://localhost:5680/enqueue
GET  http://localhost:5680/status
GET  http://localhost:5680/health
```

### 2.3 Worker (CloudCode 无头调用)

**Intent 路由**:
- `runQA` → 调用 orchestrator/qa-run.sh
- `fixBug` → 调用 `claude -p "Fix bug..." --output-format json`
- `refactor` → 调用 `claude -p "Refactor..." --output-format json`
- `review` → 代码审查逻辑
- `summarize` → 会话总结
- `optimizeSelf` → 自我优化

**执行流程**:
1. Dequeue 任务（优先级排序）
2. 创建 runs/<runId>/ 目录
3. 根据 intent 调用对应执行器
4. 收集证据到 evidence/ 目录
5. 生成 summary.json
6. 更新 state.json

### 2.4 Heartbeat (自主监控)

**Cron 版本**:
```bash
*/5 * * * * /path/to/heartbeat.sh >> /var/log/cecelia-heartbeat.log 2>&1
```

**n8n 版本**:
- Workflow: Cecelia Heartbeat
- Trigger: Schedule (every 5 minutes)
- Actions:
  1. Check system state
  2. Detect anomalies (high failure rate, stale queue)
  3. Auto-enqueue recovery tasks
  4. Trigger worker if queue not empty

### 2.5 Notion Integration

**System State Table** (单向同步):
- Health Status (健康状态)
- Queue Length (队列长度)
- Last Run (最后运行)
- Success Rate (成功率)

**System Runs Table** (单向同步):
- Run ID
- Task Title
- Status (queued, running, succeeded, failed)
- Started At
- Duration
- Evidence (链接)

---

## 3. 任务生命周期

```
┌─────────────────────────────────────────────────────────────┐
│                    Task Lifecycle                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  输入源 (Notion/CloudCode/n8n/Webhook/Heartbeat)            │
│      ↓                                                      │
│  Gateway (统一入口)                                          │
│      ↓                                                      │
│  Inbox (原始数据)                                            │
│      ↓                                                      │
│  Task Parser (解析 + 入库)                                   │
│      ↓                                                      │
│  Queue (优先级排队)                                          │
│      ↓                                                      │
│  Worker (消费队列)                                           │
│      │                                                      │
│      ├─ runQA → QA Orchestrator → Evidence                  │
│      ├─ fixBug → CloudCode Headless → PR                    │
│      ├─ refactor → CloudCode Headless → PR                  │
│      └─ ...                                                 │
│      ↓                                                      │
│  Evidence Collection (runs/<runId>/evidence/)               │
│      ↓                                                      │
│  State Update (state.json + DB)                             │
│      ↓                                                      │
│  Notion Sync (Mirror to UI)                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. QA 系统集成

### 集成方式

**QA 作为 Worker 的一个执行器**:

```bash
# Worker 调用 QA
execute_qa() {
  local task_json="$1"
  local run_dir="$2"

  # 提取参数
  local project branch scope
  project=$(echo "$task_json" | jq -r '.payload.project')
  branch=$(echo "$task_json" | jq -r '.payload.branch')
  scope=$(echo "$task_json" | jq -r '.payload.scope')

  # 调用 QA Orchestrator
  bash orchestrator/qa-run.sh "$project" "$branch" "$scope" \
    > "$run_dir/evidence/qa-report.json"

  # 记录证据
  echo '{"type":"qa_report","path":"evidence/qa-report.json"}' \
    >> "$run_dir/summary.json"
}
```

### QA 产物自动归档

- QA-DECISION.md → runs/<runId>/evidence/qa-decision.md
- AUDIT-REPORT.md → runs/<runId>/evidence/audit-report.md
- test-results.xml → runs/<runId>/evidence/test-results.xml

---

## 5. 交付物清单

### 5.1 ✅ Database Schema
- `db/schema.sql` - 完整的 SQLite 表结构

### 5.2 ✅ File Formats
- `docs/FILE_FORMATS.md` - 所有文件格式定义

### 5.3 Gateway 实现
- `gateway/gateway-http.js` - HTTP 服务器（新增）
- `gateway/gateway-cli.sh` - CLI 入口（重构）

### 5.4 Worker 实现
- `worker/worker.sh` - 增强版（CloudCode 无头调用）
- `worker/executors/` - 各 Intent 执行器

### 5.5 Heartbeat 实现
- `heartbeat/heartbeat.sh` - Cron 版本（增强）
- `heartbeat/heartbeat.n8n.json` - n8n Workflow 导出

### 5.6 Notion Integration
- `scripts/notion-sync.sh` - Notion 同步脚本
- `docs/NOTION_INTEGRATION.md` - 集成文档

### 5.7 State Machine
- `docs/STATE_MACHINE.md` - 完整状态机定义

### 5.8 QA Integration
- `docs/QA_INTEGRATION.md` - QA 系统集成文档

### 5.9 Directory Structure
- `docs/DIRECTORY_STRUCTURE.md` - 最终目录结构参考

### 5.10 Demo Script
- `scripts/demo.sh` - 一键演示脚本

---

## 成功标准

- [ ] SQLite 数据库可正常初始化
- [ ] Gateway HTTP/CLI 都能接收任务
- [ ] Worker 能消费队列并调用 CloudCode 无头
- [ ] Heartbeat 能定时检查并自动入队任务
- [ ] Notion 能单向同步显示系统状态
- [ ] QA 系统能作为 Worker 执行器运行
- [ ] 端到端演示：Notion 创建任务 → Gateway → Queue → Worker → QA → Evidence → Notion 同步
- [ ] `bash scripts/demo.sh` 能一键演示完整流程
