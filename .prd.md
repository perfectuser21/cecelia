# PRD: 修复 Migration 036 后的 KR 类型兼容性问题

## 问题描述

**Migration 036** 引入了新的 KR 类型（`global_kr`, `area_kr`），替代了原来的 `kr` 类型。但是以下代码文件仍然使用旧的类型查询，导致无法找到任何 KR：

1. **brain/src/planner.js:23** - `getGlobalState()` 只查询 `type = 'kr'`
2. **brain/src/similarity.js:140** - JOIN 条件使用 `kr.type = 'kr'`
3. **brain/src/__tests__/planner.test.js:175** - 测试代码过滤 `type === 'kr'`

## 影响

**严重性：P0 - 系统完全无法自动运行**

- ❌ `planNextTask()` 返回 `no_active_kr`，无法生成任务
- ❌ Brain 无法实现 24/7 自动化
- ❌ 所有依赖 KR 的功能失效

## 解决方案

### 1. 修复 planner.js

```javascript
// 修改前（第 21-25 行）
pool.query(`
  SELECT * FROM goals
  WHERE type = 'kr' AND status NOT IN ('completed', 'cancelled')
  ...
`),

// 修改后
pool.query(`
  SELECT * FROM goals
  WHERE type IN ('kr', 'global_kr', 'area_kr') AND status NOT IN ('completed', 'cancelled')
  ...
`),
```

### 2. 修复 similarity.js

```javascript
// 修改前（第 140 行）
LEFT JOIN goals kr ON pkl.kr_id = kr.id AND kr.type = 'kr'

// 修改后
LEFT JOIN goals kr ON pkl.kr_id = kr.id AND kr.type IN ('kr', 'global_kr', 'area_kr')
```

### 3. 修复 planner.test.js

```javascript
// 修改前（第 175 行）
if (g.type === 'kr') testKRIds.push(g.id);

// 修改后
if (['kr', 'global_kr', 'area_kr'].includes(g.type)) testKRIds.push(g.id);
```

## 验收标准

- [ ] planner.js 能正确查询所有类型的 KRs
- [ ] similarity.js 能正确关联所有类型的 KRs
- [ ] planner.test.js 测试通过
- [ ] Brain 能自动生成 KR decomposition 任务
- [ ] 所有现有测试通过
- [ ] CI 通过

## 测试计划

1. 单元测试：验证 planner.js 的 `getGlobalState()` 返回所有 KR 类型
2. 集成测试：验证 `planNextTask()` 能找到 KRs 并生成任务
3. E2E 测试：清空任务队列，触发 tick，验证自动创建任务

## 回归风险

**低** - 只是扩展了查询条件，向后兼容旧的 `kr` 类型

## 相关 Migration

- Migration 036: 引入了 `global_kr` 和 `area_kr` 类型
- 本次修复是 Migration 036 的必要后续工作
