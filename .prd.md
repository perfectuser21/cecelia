## PRD - 任务执行状态零漂移：进程存活与 DB 状态 100% 一致

**需求来源**: OKR 拆解任务 — 目标 ID: 3ea27ea3-4a11-4daf-85d8-8388c877d7ef
**父目标**: 可靠的工作流编排系统 (20c4e844-e049-46cc-ab6c-1370e28416ba)

**功能描述**: 消除 Brain 中进程实际状态与数据库记录状态之间的漂移，确保任何时刻 DB 中 `in_progress` 的任务都有对应的活跃进程，反之亦然。

## 现状分析

当前存在 5 个状态漂移源：

| # | 漂移场景 | 根因 | 影响 |
|---|---------|------|------|
| 1 | 进程死亡但 DB 仍 in_progress | 回调未到达（网络/崩溃），仅靠 60 分钟超时 | 任务卡住最长 60 分钟 |
| 2 | Brain 重启后丢失进程信息 | activeProcesses 是内存 Map，重启清零 | 孤儿进程 + DB 状态不一致 |
| 3 | 回调处理中间态 | removeActiveProcess 和 DB update 非原子 | tick 可能重复派发 |
| 4 | 派发窗口期 | DB 标 in_progress 到 executor 实际启动之间 | 短暂不一致 |
| 5 | Bridge 模式无 PID | cecelia-bridge 执行，pid=null 无法检活 | 无法验证进程存活 |

## 修复方案

### 1. 进程存活探测器 (Process Liveness Probe)
- 在每次 tick 中主动检测 in_progress 任务的进程是否存活
- Bridge 模式：检查 cecelia-run 进程是否在系统进程列表中（通过 run_id 匹配）
- 直接模式：通过 PID 检查 `kill -0`
- 探测失败 → 等待一次确认周期（避免误判）→ 确认死亡 → 标记 failed

### 2. 状态同步守卫 (State Sync Guard)
- Brain 启动时扫描所有 in_progress 任务，与实际系统进程对比
- 无匹配进程 → 标记 failed + 记录 `error_details.type = 'orphan_detected'`
- 有进程但无 activeProcesses 条目 → 重建条目

### 3. 回调可靠性增强
- 回调处理改为 DB 事务内完成（原子性）
- 添加回调重试机制：cecelia-run 端失败重试 3 次
- 添加回调超时检测：如果派发后 5 分钟无任何回调/心跳 → 主动探测

### 4. 心跳机制 (Heartbeat)
- cecelia-run 每 60 秒发送心跳到 Brain：POST /api/brain/heartbeat
- Brain 记录 last_heartbeat 到任务 payload
- tick 检查：in_progress + 最后心跳超过 3 分钟 → 触发存活探测

## 涉及文件

**Brain 代码（本仓库）:**
- `brain/src/executor.js` — 进程存活探测、activeProcesses 重建
- `brain/src/tick.js` — tick 中添加存活探测调用、心跳检查
- `brain/src/routes.js` — 添加 heartbeat 端点、回调事务化
- `brain/src/db.js` — 无变更（已有 pool）

**主机脚本（仓库外，不修改）:**
- `/home/xx/bin/cecelia-run` — 心跳发送（将来单独任务）

## 成功标准
- [ ] 进程死亡后 5 分钟内 DB 状态同步为 failed（而非 60 分钟）
- [ ] Brain 重启后自动检测并修复所有孤儿任务状态
- [ ] 回调处理为原子操作，无中间态窗口
- [ ] 每次 tick 主动验证 in_progress 任务的进程存活性
- [ ] 添加 heartbeat API 端点供未来心跳使用

## 非目标
- 不修改 cecelia-run/cecelia-bridge（仓库外代码）
- 不改变现有 60 分钟超时作为最终兜底
- 不引入外部消息队列或分布式锁
- 不修改前端代码

## KR 拆解（将通过 API 创建）

| KR | 衡量标准 | 目标值 |
|----|---------|--------|
| KR1: 进程存活探测 — tick 级别主动检测 | 每次 tick 验证 in_progress 任务进程存活 | 100% 覆盖 |
| KR2: 启动时状态同步 — Brain 重启零残留 | 启动后扫描修复孤儿任务 | 0 个孤儿 |
| KR3: 回调原子化 — 消除中间态窗口 | 回调处理在单个事务内完成 | 0 个竞态条件 |
| KR4: 心跳端点就绪 — 为心跳机制铺路 | heartbeat API 端点可用 | 端点上线 |
