---
id: cp-02240015-code-review-task-type
version: 1.0.0
created: 2026-02-24
updated: 2026-02-24
changelog:
  - 1.0.0: 初始版本
---

# PRD - code_review task type + 每日自动调度

## 需求来源

需要在 Brain 中添加 `code_review` task type，让 Cecelia 每天自动对所有活跃仓库进行代码审查。
统一整合原有的 qa/audit/review/codex_qa 等分散的质检功能。

## 功能描述

### 1. task-router.js — 添加 code_review 路由
- LOCATION_MAP 添加 `'code_review': 'us'`
- isValidTaskType 添加 `'code_review'`

### 2. migration 072 — DB 约束更新
- tasks_task_type_check 约束添加 `'code_review'`
- schema_version 写入 '072'

### 3. executor.js — code_review 执行处理
- skillMap 添加 `'code_review': '/code-review'`
- permissionMode 设为 `bypassPermissions`（需要写 report 文件）
- preparePrompt 传入 repo_path + since_hours 参数

### 4. daily-review-scheduler.js — 每日调度
- 每天 02:00 UTC（5 分钟窗口）触发
- 从 projects 表读取活跃 repo 列表（有 repo_path 的 project）
- 同一天同一 repo 不重复创建（幂等）
- Fallback 到硬编码列表（DB 空时）

### 5. tick.js — 集成调度器
- 在 tick Step 10 调用 triggerDailyReview()
- 返回值包含 daily_review 统计

### 6. selfcheck.js + DEFINITION.md — 版本同步
- EXPECTED_SCHEMA_VERSION 更新为 '072'
- DEFINITION.md 版本/schema/task_types 同步

## 成功标准

- `code_review` 出现在 isValidTaskType 中
- Migration 072 能正常运行
- 每天 02:00 UTC 自动创建 code_review 任务
- 同一天同一 repo 不重复
- 测试覆盖：scheduler 16 个 + router 4 个
