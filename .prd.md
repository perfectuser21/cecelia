---
id: orchestrator-execution-layer
version: 1.0.0
created: 2026-01-30
updated: 2026-01-30
changelog:
  - 1.0.0: Initial version
---

# PRD: Orchestrator 执行层

## 功能描述

为 Orchestrator 添加真正的任务执行能力，让 /tick 能实际运行 queued 任务。

## 当前问题

```
/tick 现状：只更新状态，不执行任务
Worker Pool：空壳，没有真正执行
```

## 目标架构

```
/tick 调用
    │
    ▼
资源检查（内存/CPU/并发数）
    │
    ▼
Worker Pool（动态调整）
    │
    ├─ Worker 1: claude -p "/dev ..."
    ├─ Worker 2: claude -p "/dev ..."
    └─ Worker 3: claude -p "/dev ..."
```

## 关键功能

### 1. 资源监控
- 检查可用内存（阈值：2GB per worker）
- 检查当前 Claude 进程数
- 动态计算可用 worker 数量

### 2. Worker 执行器
- 实际调用 `claude -p "/dev {task.prd_content}"`
- 捕获输出和状态
- 更新 Run 记录

### 3. 并发控制
- 默认最大 3 个并发 worker
- 内存不足时自动降级
- 单个 worker 同时只执行 1 个任务

### 4. /tick 增强
- 检查资源 → 分配任务 → 启动执行 → 更新状态

## API

```python
# 获取系统资源状态
GET /orchestrator/v2/resources
{
  "memory_available_gb": 8.5,
  "memory_per_worker_gb": 2.0,
  "max_workers": 3,
  "current_workers": 1,
  "can_spawn_more": true
}

# 手动触发执行（可选指定并发数）
POST /orchestrator/v2/execute
{
  "max_concurrent": 2  // optional, default: auto
}
```

## 成功标准

1. /tick 能实际执行 queued 任务
2. 动态资源检测工作
3. 并发控制生效
4. 测试通过
5. 构建通过
