# PRD - Alertness 响应动作系统

## 背景

Alertness 免疫系统已完成核心功能：
- ✅ 4级自动评估（NORMAL/ALERT/EMERGENCY/COMA）
- ✅ 9种健康信号采集
- ✅ 指数衰减自动恢复
- ✅ Token bucket 速率限制

但缺少关键的最后一环：**响应动作（Response Actions）**。

当前问题：等级变化时，系统只是被动调整参数（dispatch_rate、planning_enabled），不会主动采取措施保护自己。

## 目标

实现自主响应机制，让 Brain 在检测到健康问题时能够：
1. 主动通知和记录
2. 自动升级分析
3. 采取缓解措施
4. 安全关机保护
5. 恢复正常运作

## 功能需求

### 1. Notification（通知）- ALERT 及以上

**触发条件**：等级升级到 ALERT（分数 20+）

**动作**：
- 控制台警告输出（带颜色、时间戳）
- 记录到 `cecelia_events` 表（event_type: 'alertness_notification'）
- 包含当前信号详情、触发原因

**未来扩展**（本 PR 不实现）：
- Slack/Discord webhook 通知
- Email 告警

### 2. Escalation（升级分析）- EMERGENCY 及以上

**触发条件**：等级升级到 EMERGENCY（分数 50+）

**动作**：
- 自动调用 Cortex（L2 大脑）进行深度分析
- 创建 RCA（根因分析）任务
- 记录分析结果到决策日志
- 可能的策略调整建议

### 3. Auto-Mitigation（自动缓解）- EMERGENCY 及以上

**触发条件**：等级升级到 EMERGENCY（分数 50+）

**动作**：
- 暂停低优先级任务（P2）的派发
- 清理僵尸进程（孤儿进程扫描）
- 释放资源（取消排队中的非关键任务）
- 限制并发数（降低资源压力）

### 4. Shutdown Safety（关机保护）- COMA

**触发条件**：等级升级到 COMA（分数 80+）

**动作**：
- 启用 drain mode（只完成运行中任务，不派发新任务）
- 保存状态检查点到数据库
- 记录当前所有信号和指标
- 控制台输出警告："Brain entering COMA mode - system protection activated"

### 5. Recovery（恢复）- 降级时

**触发条件**：等级从高等级降回低等级

**动作**：
- COMA → EMERGENCY：记录恢复开始
- EMERGENCY → ALERT：重新启用 planning
- ALERT → NORMAL：清除所有限制，恢复正常派发
- 控制台输出："Brain recovering to [LEVEL] - restrictions lifted"

## 实现方案

### 新文件：`brain/src/alertness-actions.js`

响应动作执行器，导出：
- `executeResponseActions(fromLevel, toLevel, signals)` - 主入口
- `notifyAlert(level, signals)` - 通知
- `escalateToAnalysis(signals)` - 升级分析
- `applyMitigation(signals)` - 自动缓解
- `activateShutdownSafety(signals)` - 关机保护
- `recoverFromLevel(fromLevel, toLevel)` - 恢复

### 修改：`brain/src/alertness.js`

在 `setLevel()` 函数中，等级变化后调用：
```javascript
import { executeResponseActions } from './alertness-actions.js';

// After level change
if (newLevel !== oldLevel) {
  await executeResponseActions(oldLevel, newLevel, signals);
}
```

### 修改：`brain/src/tick.js`（可选集成）

在每个 tick 周期检查是否需要执行周期性缓解动作。

### 数据库集成

使用现有的 `cecelia_events` 表记录所有响应动作：
```sql
INSERT INTO cecelia_events (event_type, source, payload)
VALUES ('alertness_action', 'alertness', $1)
```

## 成功标准

### 代码实现
- [ ] `alertness-actions.js` 实现所有 5 类响应动作
- [ ] `alertness.js/setLevel()` 集成响应触发
- [ ] 所有响应动作有错误处理
- [ ] 导出清晰的 API

### 测试
- [ ] 单元测试：每个响应动作独立测试
- [ ] 集成测试：等级转换触发正确响应
- [ ] 边界测试：相同等级不触发、降级触发恢复
- [ ] 测试覆盖率 > 90%

### 文档
- [ ] 代码注释清晰
- [ ] 更新 ALERTNESS_ANALYSIS.md
- [ ] API 文档（JSDoc）

### CI
- [ ] 所有测试通过
- [ ] 无 lint 错误
- [ ] 版本号正确递增（minor: 1.13.2 → 1.14.0）

## 非目标（Not in Scope）

本 PR **不包含**：
- ❌ Slack/Discord/Email 外部通知（预留接口）
- ❌ Cortex 策略调整的实际执行（只创建任务）
- ❌ 复杂的任务优先级调度算法
- ❌ Web UI 展示响应动作历史

这些功能留待后续 PR。

## 风险和依赖

### 风险
- Cortex 调用可能失败 → 需要 fallback 和错误处理
- 暂停任务可能影响关键功能 → 只暂停 P2，保留 P0/P1

### 依赖
- 依赖现有 `cortex.js` 的 RCA 功能
- 依赖现有 `executor.js` 的进程管理
- 依赖现有 `tick.js` 的 drain mode
