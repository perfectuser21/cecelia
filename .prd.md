---
id: prd-phase4-metrics
version: 1.0.0
created: 2026-01-22
updated: 2026-01-22
changelog:
  - 1.0.0: 初始版本
---

# PRD: Phase 4 - DevGate Metrics 指标面板

## 背景

Phase 1-3 完成了 DevGate 闭环机制，但缺乏可量化的指标：
1. **无法验证覆盖率** - P0/P1 修复是否真的 100% 更新了 RCI？
2. **无法追踪增长** - 本月新增了多少 RCI？
3. **闭环效果不可见** - "感觉上闭环了"但没有数据支撑

## 功能描述

实现 DevGate 指标面板（CLI）：**收集数据 → 计算指标 → 输出报告 → 接入 Nightly**

### 核心指标

1. **P0/P1 PR 数**（本月）
   - 数据源：`.history/*.dod.md` 的 meta 中 `priority:P0|P1`

2. **P0/P1 RCI 覆盖率**（本月）
   - 分母：本月所有 P0/P1 PR 数
   - 分子：这些 PR 中更新了 `regression-contract.yaml` 的数量
   - 目标：100%

3. **新增 RCI 数**（本月）
   - 通过 git diff 统计新增的 RCI ID（如 H2-007）

4. **DoD 条目数**（可选）
   - 统计 `.history/*.dod.md` 中的验收条目

### 前置改进

1. **快照 meta 增强**
   - 添加 `priority:P0|P1|NONE`
   - 添加 `title:"..."`
   - 添加 `merged:<sha>`（合并后更新）

## 成功标准

1. `bash scripts/devgate/metrics.sh` 输出完整报告
2. `--format json` 输出可解析的 JSON
3. P0/P1 覆盖率低于 100% 时有明确警告
4. Nightly CI 集成

## 交付物

### 新增文件
- `scripts/devgate/metrics.sh` - 入口脚本
- `scripts/devgate/metrics.cjs` - 核心逻辑（Node.js）
- `tests/hooks/metrics.test.ts` - 测试文件

### 修改文件
- `scripts/devgate/snapshot-prd-dod.sh` - 添加完整 meta
- `.github/workflows/nightly.yml` - 接入指标收集
- `regression-contract.yaml` - 新增 H4-001

## 不做

- Web UI 面板
- 历史趋势图
- 自动发送报告到 Slack/飞书

## 技术要点

- 时间解析用 Node.js（跨平台兼容）
- Bash 只做 glue
- JSON 输出方便后续扩展
