# PRD: Cortex Quality Assessment System

## 功能描述

为 Cortex RCA 分析实现质量评估系统，包括：
- 4 维度质量评分（完整性、有效性、时效性、独特性）
- 基于 SHA256 的相似度检测和去重（>80% 相似度复用现有 RCA）
- 策略采纳效果追踪
- 质量统计和反馈循环

## Background

Currently Cortex performs RCA (Root Cause Analysis) but lacks quality evaluation and deduplication mechanisms. This leads to:
1. Duplicate RCA analyses for similar failures
2. No quality tracking or improvement feedback loop
3. No measurement of RCA effectiveness

## Goals

Implement a comprehensive quality assessment system for Cortex RCA analyses with:
1. **Quality Scoring**: 4-dimension evaluation (Completeness, Effectiveness, Timeliness, Uniqueness)
2. **Similarity Detection**: SHA256-based deduplication (>80% similarity reuses existing RCA)
3. **Effect Tracking**: Monitor strategy adoption and effectiveness
4. **Feedback Loop**: Aggregate stats for continuous improvement

## Features

### 1. Quality Scoring System (100 points total)

- **Completeness (30 points)**
  - Root cause clarity: 15 points
  - Contributing factors (≥3): 10 points
  - Strategy updates with reasoning: 5 points

- **Effectiveness (40 points)**
  - Initially: 0 points (needs feedback)
  - Updated after strategy adoption: 0-40 based on success rate

- **Timeliness (15 points)**
  - Analysis within 5min: 15 points
  - 5-15min: 10 points
  - 15-30min: 5 points
  - >30min: 0 points

- **Uniqueness (15 points)**
  - Original insight: 15 points
  - Duplicate (>80% similar): 0 points

### 2. Similarity Detection

- Generate SHA256 hash from: task_type + reason + root_cause (first 200 chars)
- Find similar analyses: cosine similarity on root_cause text
- If >80% similar: reuse existing RCA, mark as duplicate_of

### 3. Database Schema

#### cortex_analyses table (add columns)
```sql
ALTER TABLE cortex_analyses ADD COLUMN quality_score INTEGER;
ALTER TABLE cortex_analyses ADD COLUMN quality_dimensions JSONB;
ALTER TABLE cortex_analyses ADD COLUMN similarity_hash TEXT;
ALTER TABLE cortex_analyses ADD COLUMN duplicate_of UUID REFERENCES cortex_analyses(id);
```

#### cortex_quality_reports table (new)
```sql
CREATE TABLE cortex_quality_reports (
  id UUID PRIMARY KEY,
  report_period_start TIMESTAMPTZ,
  report_period_end TIMESTAMPTZ,
  total_rcas INTEGER,
  avg_quality_score NUMERIC(5,2),
  top_quality_analyses JSONB,
  low_quality_analyses JSONB,
  aggregation_stats JSONB,
  adoption_stats JSONB,
  created_at TIMESTAMPTZ
);
```

#### strategy_adoptions table (new)
```sql
CREATE TABLE strategy_adoptions (
  id UUID PRIMARY KEY,
  analysis_id UUID REFERENCES cortex_analyses(id),
  strategy_key TEXT,
  old_value TEXT,
  new_value TEXT,
  adopted_at TIMESTAMPTZ,
  adopted_by TEXT,
  effectiveness_score INTEGER,
  evaluated_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ
);
```

### 4. API Endpoints

- `POST /api/brain/cortex/evaluate-quality` - Evaluate quality for an analysis
- `POST /api/brain/cortex/check-similarity` - Check if RCA should be created or reused
- `GET /api/brain/cortex/quality-stats?days=7` - Get quality statistics

## Implementation Plan

1. **Migration 015**: Add quality columns and tables
2. **cortex-quality.js**: Core quality evaluation module
3. **cortex.js integration**: Add similarity checking and quality evaluation
4. **routes.js**: Add 3 new API endpoints
5. **Tests**: 19 new tests (12 cortex-quality + 7 migration-015)
6. **selfcheck.js**: Update EXPECTED_SCHEMA_VERSION to '015'
7. **Version bump**: 1.20.0 → 1.21.0

## 成功标准

- 所有 19 个新测试通过
- Migration 015 成功运行
- 质量分数计算正确（100 分制）
- 重复检测工作正常（>80% 相似度阈值）
- API 端点返回预期数据
- 版本号在 package.json, .brain-versions, DEFINITION.md 中同步

## Success Criteria

- All 19 new tests pass
- Migration 015 runs successfully
- Quality scores calculated correctly (100-point scale)
- Duplicate detection works (>80% similarity threshold)
- API endpoints return expected data
- Version synced across package.json, .brain-versions, DEFINITION.md
