# PRD - Fix PORT Environment Variable Support in Brain Server

## 需求摘要

**需求来源**: Rolling update 部署测试中发现 Brain server 不识别标准 PORT 环境变量
**功能描述**: 修改 server.js 支持 PORT 环境变量（优先级：PORT > BRAIN_PORT > 5221）
**涉及文件**: brain/server.js (line 16)
**成功标准**: rolling-update.sh 能成功启动 green 容器在 5222 端口，无 EADDRINUSE 错误
**非目标**: 不改动 docker-compose.yml 或 .env.docker，不删除 BRAIN_PORT 支持

## Background

During rolling update deployment test (v1.39.0), the green container health check failed because Brain server doesn't recognize the standard `PORT` environment variable.

**Root Cause**:
- `brain/src/server.js` line 16: `const PORT = process.env.BRAIN_PORT || 5221;`
- `scripts/rolling-update.sh` sets: `-e "PORT=5222"`
- Brain ignores `PORT`, defaults to 5221, causing EADDRINUSE conflict with blue container

**Error**:
```
[FATAL] Uncaught Exception: Error: listen EADDRINUSE: address already in use :::5221
```

## Goals

1. Make Brain server compatible with standard Docker `PORT` environment variable
2. Maintain backward compatibility with existing `BRAIN_PORT` variable
3. Enable rolling-update.sh to work correctly with green container on port 5222

## Requirements

### Functional Requirements

1. **PORT variable priority**:
   - Check `PORT` first (standard Docker convention)
   - Fallback to `BRAIN_PORT` (legacy compatibility)
   - Default to `5221` if neither is set

2. **Backward compatibility**:
   - Existing deployments using `BRAIN_PORT` must continue to work
   - No changes required to existing `.env.docker` files

3. **Logging**:
   - Log which environment variable was used (for debugging)
   - Clear error message if port binding fails

### Technical Requirements

1. **File to modify**: `brain/src/server.js` line 16
2. **Code change**:
   ```javascript
   // Before:
   const PORT = process.env.BRAIN_PORT || 5221;

   // After:
   const PORT = process.env.PORT || process.env.BRAIN_PORT || 5221;
   ```

3. **Version bump**: `fix:` commit → patch version (1.39.0 → 1.39.1)

### Testing Requirements

1. **Unit tests** (if applicable):
   - Test PORT takes precedence when both are set
   - Test BRAIN_PORT works when PORT is not set
   - Test default 5221 when neither is set

2. **Integration test**:
   - Verify rolling-update.sh works with PORT=5222
   - Verify blue container still works with BRAIN_PORT (or no env var)

3. **Backward compatibility test**:
   - Verify existing docker-compose.yml (no PORT/BRAIN_PORT) still binds to 5221
   - Verify .env.docker with BRAIN_PORT=5221 still works

## Acceptance Criteria

1. ✅ server.js checks PORT before BRAIN_PORT
2. ✅ Backward compatibility maintained for BRAIN_PORT
3. ✅ Version bumped to 1.39.1
4. ✅ Tests pass (local + CI)
5. ✅ rolling-update.sh successfully deploys green container on port 5222
6. ✅ No regression in blue container deployment

## Out of Scope

- Changing docker-compose.yml or .env.docker (not needed)
- Removing BRAIN_PORT support (keep for backward compatibility)
- Modifying rolling-update.sh (already correct, uses standard PORT)

## Success Metrics

- Green container starts successfully on port 5222 during rolling update
- Zero-downtime deployment completes without EADDRINUSE error
- Existing deployments continue to work without changes
