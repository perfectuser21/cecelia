# PRD: 修复 Token Bucket Rate Limiting 配置

## 问题描述

Brain 的 token bucket rate limiting 配置存在缺陷，导致 Tick Loop 无法派发任务。

**当前配置问题**：
- Tick Loop 频率：每 5 秒触发一次 = 12 次/分钟
- Token 消耗：每次 Tick 消耗 1 个 dispatch token = 12 tokens/分钟
- Token 补充：10 tokens/分钟（NORMAL 级别）
- **净结果**：每分钟净消耗 2 个 token → token bucket 持续耗尽

**影响**：
- 所有 Tick 的 dispatch 尝试都被 rate_limited 阻塞
- Brain 无法派发任务，即使队列中有待执行任务
- 系统功能完全失效

## 需求摘要

**需求来源**：生产环境 Bug - Brain 无法派发任务
**功能描述**：调整 alertness.js 中的 token bucket 配置，让 refillRate ≥ Tick Loop 频率
**涉及文件**：brain/src/alertness.js
**成功标准**：
1. Token bucket 不再持续耗尽
2. Brain 能够正常派发 queued 任务
3. Rate limiting 仍能保护系统（在 ALERT/EMERGENCY 级别降速）

**非目标**：
- 不修改 Tick Loop 的频率（5 秒）
- 不移除 rate limiting 机制
- 不影响 Alertness 系统的其他功能

## 技术方案

### 修改文件

brain/src/alertness.js

**当前配置**（第 10-11 行）：
```javascript
const _tokenBucket = {
  dispatch: { tokens: 10, maxTokens: 10, refillRate: 10, lastRefill: Date.now() },
  // ...
};
```

**修改为**：
```javascript
const _tokenBucket = {
  dispatch: { tokens: 20, maxTokens: 20, refillRate: 15, lastRefill: Date.now() },
  // ...
};
```

**参数说明**：
- maxTokens: 20 - 最大容量（允许 20 次连续 dispatch，约 100 秒的 burst）
- refillRate: 15 - 每分钟补充 15 个（> 12 次/分钟的消耗）
- tokens: 20 - 初始值与 maxTokens 一致

### 同步修改 LEVEL_TOKEN_RATES

**当前配置**（第 14-19 行）：
```javascript
const LEVEL_TOKEN_RATES = {
  [ALERTNESS_LEVELS.NORMAL]: { dispatch: 10, l1: 20, l2: 5 },
  [ALERTNESS_LEVELS.ALERT]: { dispatch: 5, l1: 10, l2: 3 },
  [ALERTNESS_LEVELS.EMERGENCY]: { dispatch: 2, l1: 5, l2: 1 },
  [ALERTNESS_LEVELS.COMA]: { dispatch: 0, l1: 0, l2: 0 },
};
```

**修改为**：
```javascript
const LEVEL_TOKEN_RATES = {
  [ALERTNESS_LEVELS.NORMAL]: { dispatch: 15, l1: 20, l2: 5 },      // 15/min > 12/min
  [ALERTNESS_LEVELS.ALERT]: { dispatch: 8, l1: 10, l2: 3 },        // 降速到 8/min（仍 > 0）
  [ALERTNESS_LEVELS.EMERGENCY]: { dispatch: 4, l1: 5, l2: 1 },     // 进一步降速
  [ALERTNESS_LEVELS.COMA]: { dispatch: 0, l1: 0, l2: 0 },          // 完全停止
};
```

## 验证方法

1. **修改后重启 Brain**
2. **观察 token bucket 状态**：
   - 手动触发多次 Tick（模拟 burst）
   - 验证不再持续 rate_limited
3. **验证 queued 任务被派发**：
   - 检查队列中的 3 个任务是否被派发
   - 验证任务状态从 queued → in_progress
4. **验证 Alertness 级别切换**：
   - 在不同 Alertness 级别下，dispatch rate 应该相应调整

## 回滚方案

如果修改导致问题，恢复原配置：
```javascript
dispatch: { tokens: 10, maxTokens: 10, refillRate: 10, lastRefill: Date.now() }
```

并修改 Tick Loop 频率为 10 秒（临时方案）。

## 依赖

- Brain 版本：1.39.1
- 需要重启 Brain 才能生效
