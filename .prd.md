# PRD - ä¿®å¤ OKR æ‹†è§£æµç¨‹çš„ goal_id å…³è”

**éœ€æ±‚æ¥æº**: Task #11 - P0 ä¿®å¤å»ºè®®ï¼Œæ¥è‡ª 610 ä¸ªå¤±è´¥ä»»åŠ¡æ ¹å› åˆ†æ

**ä¼˜å…ˆçº§**: P0

## èƒŒæ™¯

ä» Task #3 çš„æ ¹å› åˆ†æå‘ç°ï¼š
- **491/500** (98.2%) å¤±è´¥ä»»åŠ¡æ²¡æœ‰ `goal_id`
- **441/500** (88.2%) å¤±è´¥ä»»åŠ¡æ²¡æœ‰ `project_id`
- è¿™äº›ä»»åŠ¡ä¸»è¦æ˜¯ OKR æ‹†è§£è¿‡ç¨‹ä¸­åˆ›å»ºçš„

**å½±å“**ï¼š
- ä»»åŠ¡å˜æˆ"å­¤å„¿"ï¼Œæ— æ³•è¢«æ­£ç¡®è°ƒåº¦
- æ— æ³•è¿½æº¯ä»»åŠ¡å±äºå“ªä¸ª OKR ç›®æ ‡
- å½±å“ä»»åŠ¡ä¼˜å…ˆçº§è¯„åˆ†å’Œ KR è½®è½¬

## é—®é¢˜æè¿°

**ç—‡çŠ¶**:
- OKR æ‹†è§£ä»»åŠ¡ï¼ˆæ ‡é¢˜åŒ…å« "Area OKR æ‹†è§£"ï¼‰ç¼ºå°‘ `goal_id`
- éƒ¨åˆ†ä»»åŠ¡ä¹Ÿç¼ºå°‘ `project_id`

**æ ¹æœ¬åŸå› **:
- `okr-tick.js` åœ¨åˆ›å»ºä»»åŠ¡æ—¶æœªå¼ºåˆ¶è¦æ±‚ `goal_id` å‚æ•°
- åˆ›å»ºé€»è¾‘æœªéªŒè¯ `goal_id` å¿…å¡«
- å¯èƒ½åœ¨æŸäº›ä»£ç è·¯å¾„ä¸‹è·³è¿‡äº† `goal_id` èµ‹å€¼

## åŠŸèƒ½æè¿°

### 1. å®šä½é—®é¢˜ä»£ç 

åœ¨ `brain/src/okr-tick.js` ä¸­æ‰¾åˆ°æ‰€æœ‰åˆ›å»ºä»»åŠ¡çš„å‡½æ•°ï¼š
- `createTaskFromKR()` - ä» KR åˆ›å»ºä»»åŠ¡
- `createDecompositionTask()` - åˆ›å»ºæ‹†è§£ä»»åŠ¡
- å…¶ä»–å¯èƒ½åˆ›å»ºä»»åŠ¡çš„å‡½æ•°

### 2. ä¿®å¤åˆ›å»ºé€»è¾‘

**å¼ºåˆ¶ goal_id å…³è”**ï¼š

```javascript
async function createTaskFromKR(kr) {
  // å¼ºåˆ¶æ£€æŸ¥ goal_id
  if (!kr.id) {
    throw new Error('KR must have id for goal_id association');
  }

  // åˆ›å»ºä»»åŠ¡æ—¶å¼ºåˆ¶è®¾ç½® goal_id
  return await createTask({
    title: `Area OKR æ‹†è§£: ${kr.title}`,
    goal_id: kr.id,  // ğŸ”§ å¼ºåˆ¶å…³è”
    project_id: kr.project_id || null,
    task_type: 'dev',
    priority: kr.priority || 'P1',
    ...
  });
}
```

### 3. æ·»åŠ éªŒè¯å‡½æ•°

**åˆ›å»ºå‰éªŒè¯**ï¼š

```javascript
function validateTaskPayload(payload) {
  const errors = [];

  // goal_id å¿…å¡«ï¼ˆé™¤éæ˜¯ç‰¹æ®Šç±»å‹ä»»åŠ¡ï¼‰
  if (!payload.goal_id && !isSystemTask(payload)) {
    errors.push('goal_id is required for user tasks');
  }

  // project_id æ¨èä½†ä¸å¼ºåˆ¶
  if (!payload.project_id) {
    console.warn(`Task "${payload.title}" has no project_id`);
  }

  if (errors.length > 0) {
    throw new Error(`Task validation failed: ${errors.join(', ')}`);
  }

  return true;
}

function isSystemTask(payload) {
  // ç³»ç»Ÿä»»åŠ¡ï¼ˆå¦‚ decompositionï¼‰å¯èƒ½æ²¡æœ‰ goal_id
  const systemTypes = ['decomposition', 'system'];
  return systemTypes.includes(payload.task_type);
}
```

### 4. æ•°æ®ä¿®å¤è„šæœ¬

**ä¿®å¤ç°æœ‰ 491 ä¸ªä»»åŠ¡**ï¼š

```javascript
async function fixOrphanTasks() {
  // 1. æŸ¥æ‰¾æ‰€æœ‰ç¼ºå°‘ goal_id çš„ä»»åŠ¡
  const orphans = await pool.query(`
    SELECT id, title, project_id
    FROM tasks
    WHERE goal_id IS NULL
      AND status = 'failed'
      AND title LIKE '%Area OKR æ‹†è§£%'
    ORDER BY created_at DESC
  `);

  console.log(`Found ${orphans.rows.length} orphan tasks`);

  let fixed = 0;
  let skipped = 0;

  for (const task of orphans.rows) {
    // 2. ä»æ ‡é¢˜æå– Goal åç§°
    // "Area OKR æ‹†è§£: XXX" â†’ æŸ¥æ‰¾ title = "XXX" çš„ goal
    const match = task.title.match(/Area OKR æ‹†è§£:\s*(.+)/);
    if (!match) {
      skipped++;
      continue;
    }

    const goalTitle = match[1].trim();

    // 3. æŸ¥æ‰¾åŒ¹é…çš„ Goal
    const goalResult = await pool.query(
      'SELECT id, project_id FROM goals WHERE title = $1 LIMIT 1',
      [goalTitle]
    );

    if (goalResult.rows.length === 0) {
      console.warn(`No goal found for "${goalTitle}"`);
      skipped++;
      continue;
    }

    const goal = goalResult.rows[0];

    // 4. æ›´æ–°ä»»åŠ¡
    await pool.query(
      'UPDATE tasks SET goal_id = $1, project_id = COALESCE(project_id, $2) WHERE id = $3',
      [goal.id, goal.project_id, task.id]
    );

    fixed++;
  }

  console.log(`Fixed: ${fixed}, Skipped: ${skipped}`);
  return { fixed, skipped, total: orphans.rows.length };
}
```

## æ¶‰åŠæ–‡ä»¶

- `brain/src/okr-tick.js` - ä¸»è¦ä¿®æ”¹æ–‡ä»¶
  - ä¿®æ”¹ `createTaskFromKR()` - å¼ºåˆ¶ goal_id
  - æ·»åŠ  `validateTaskPayload()` - éªŒè¯å‡½æ•°
  - æ·»åŠ  `fixOrphanTasks()` - æ•°æ®ä¿®å¤è„šæœ¬

- `brain/src/__tests__/okr-tick.test.js` - æµ‹è¯•æ–‡ä»¶
  - æµ‹è¯• goal_id å¼ºåˆ¶å…³è”
  - æµ‹è¯•éªŒè¯é€»è¾‘
  - æµ‹è¯•æ•°æ®ä¿®å¤

## æˆåŠŸæ ‡å‡†

### DoD (Definition of Done)

1. âœ… **ä»£ç ä¿®å¤**:
   - æ‰€æœ‰åˆ›å»ºä»»åŠ¡çš„å‡½æ•°å¼ºåˆ¶è®¾ç½® goal_id
   - æ·»åŠ  validateTaskPayload() éªŒè¯
   - goal_id ç¼ºå¤±æ—¶æŠ›å‡ºæ˜ç¡®é”™è¯¯

2. âœ… **æ•°æ®ä¿®å¤**:
   - ä¿®å¤ç°æœ‰ 491 ä¸ªä»»åŠ¡çš„ goal_id
   - æä¾›ä¿®å¤è„šæœ¬å’Œæ‰§è¡ŒæŠ¥å‘Š
   - éªŒè¯ä¿®å¤åçš„æ•°æ®å®Œæ•´æ€§

3. âœ… **æµ‹è¯•è¦†ç›–**:
   - å•å…ƒæµ‹è¯•ï¼šéªŒè¯ goal_id å¼ºåˆ¶å…³è”
   - é›†æˆæµ‹è¯•ï¼šéªŒè¯åˆ›å»ºä»»åŠ¡æµç¨‹
   - æµ‹è¯•éªŒè¯é€»è¾‘æ­£ç¡®æ€§

4. âœ… **ç›‘æ§éªŒè¯**:
   - è§‚å¯Ÿ 1 å‘¨ï¼Œgoal_id ç¼ºå¤±ç‡ < 5%
   - æ–°åˆ›å»ºä»»åŠ¡ 100% æœ‰ goal_id

### éªŒæ”¶æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ |
|-----|------|------|
| goal_id ç¼ºå¤±ç‡ | 98.2% | < 5% |
| æ–°ä»»åŠ¡ goal_id è¦†ç›– | æœªçŸ¥ | 100% |
| æ•°æ®ä¿®å¤æˆåŠŸç‡ | 0% | > 90% |

## éç›®æ ‡

- âŒ ä¸ä¿®æ”¹ project_id é€»è¾‘ï¼ˆå…è®¸ä¸ºç©ºï¼Œåªæ˜¯è­¦å‘Šï¼‰
- âŒ ä¸ä¿®æ”¹å·²å®Œæˆä»»åŠ¡çš„ goal_idï¼ˆåªä¿®å¤å¤±è´¥ä»»åŠ¡ï¼‰
- âŒ ä¸ä¿®æ”¹ watchdog æˆ– executorï¼ˆé‚£æ˜¯å…¶ä»– Taskï¼‰

## æŠ€æœ¯è¦ç‚¹

### 1. ä»æ ‡é¢˜æå– Goal åç§°

```javascript
// æ ‡é¢˜æ ¼å¼: "Area OKR æ‹†è§£: {Goal Title}"
const match = title.match(/Area OKR æ‹†è§£:\s*(.+)/);
if (match) {
  const goalTitle = match[1].trim();
  // æŸ¥è¯¢ goals è¡¨...
}
```

### 2. æ‰¹é‡æ›´æ–°æ€§èƒ½

```javascript
// ä½¿ç”¨äº‹åŠ¡æ‰¹é‡æ›´æ–°
await pool.query('BEGIN');
try {
  for (const task of tasks) {
    await pool.query('UPDATE tasks SET goal_id = $1 WHERE id = $2', [goalId, task.id]);
  }
  await pool.query('COMMIT');
} catch (err) {
  await pool.query('ROLLBACK');
  throw err;
}
```

### 3. å‘åå…¼å®¹

```javascript
// å¯¹äºè€ä»£ç è·¯å¾„ï¼Œæä¾› fallback
const goalId = kr.id || kr.goal_id || extractGoalIdFromContext();
if (!goalId) {
  throw new Error('Cannot determine goal_id');
}
```

## é¢„æœŸæ•ˆæœ

- âœ… æ‰€æœ‰æ–°ä»»åŠ¡éƒ½æœ‰ goal_id
- âœ… 491 ä¸ªå†å²ä»»åŠ¡å¾—åˆ°ä¿®å¤
- âœ… ä»»åŠ¡è°ƒåº¦æ¢å¤æ­£å¸¸
- âœ… KR è½®è½¬ç®—æ³•å¯ä»¥æ­£ç¡®å·¥ä½œ
