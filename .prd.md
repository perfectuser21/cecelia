# PRD - Cecelia Core 可观测性系统 v1.1.1

**需求来源**: 用户提出 Cecelia Core 缺乏统一的运行态事实层，无法回答"卡在哪一层/哪一步？为什么卡？哪些是垃圾？"

**功能描述**: 实施完整的可观测性系统，包括：
1. 统一事件流（run_events 表）记录所有执行步骤
2. 8 个硬边界约定（防止实施时走神）
3. 多层追踪（L0→L1→L2→L3→L4）
4. 失败原因分类（TRANSIENT/PERSISTENT/RESOURCE/CONFIG）
5. Artifacts 管理（代理访问）
6. Dashboard 可视化（卡死检测、失败聚合、时间线）

**涉及文件**:
- `brain/migrations/023_add_run_events_observability_v1.1.sql` - 数据库 schema
- `brain/src/trace.js` - SDK（脱敏、分类、artifacts）
- `brain/src/routes/trace.js` - API 端点（新建）
- `brain/src/server.js` - 集成 trace routes
- `brain/src/executor.js` - 使用 withSpan()
- `brain/scripts/gc-runs.js` - GC 脚本（新建）

**成功标准**:
1. ✅ Migration 执行成功，run_events + run_artifacts 表创建
2. ✅ trace.js 实现完整（sanitize + classifyError + storeArtifact）
3. ✅ API 端点可访问（8 个端点）
4. ✅ executor.js 集成 withSpan()，有 run_events 记录
5. ✅ 测试通过（trace.js + API）
6. ✅ CI 通过（DevGate 检查）

**非目标**:
- ❌ 不实施 Frontend Dashboard（可后续 PR）
- ❌ 不实施 GC 调度配置（可后续 PR）
- ❌ 不改造所有 Brain 代码使用 trace（只改 executor.js 作为示例）

**实施范围（本 PR）**:
- ✅ Phase 1: 数据模型（Migration v1.1）
- ✅ Phase 2: SDK（trace.js v1.1.1）
- ✅ Phase 3: API 端点（routes/trace.js）
- ✅ Phase 4: 集成示例（executor.js）
- ✅ Phase 5: 测试

**参考文档**:
- `.observability-implementation-plan.md` - v1.0 方案
- `.observability-v1.1-implementation.md` - v1.1 实施文档
- `.observability-v1.1.1-conventions.md` - v1.1.1 硬边界约定
