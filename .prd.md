---
id: fix-dept-heartbeat-dispatch
version: 1.0.0
created: 2026-02-23
updated: 2026-02-23
changelog:
  - 1.0.0: 初始版本
---

# PRD - dept-heartbeat dispatch 两处修复

## 需求来源

dept_heartbeat 任务被 Cecelia 创建后无法被 tick 派发，经调查发现两个根因：
1. `dept-heartbeat.js` 创建任务时 `goal_id = null`，而 dispatchNextTask 的 SQL `WHERE t.goal_id = ANY($1)` 过滤掉了无 goal_id 的任务
2. `pre-flight-check.js` 对空 description 拒绝派发，而 dept_heartbeat 是系统内部任务，不需要 PRD

## 功能描述

### Fix 1: dept-heartbeat.js — 自动绑定 goal_id + 设置 description

新增 `lookupDeptPrimaryGoal(pool, dept_name)` 函数：
- 查询 `goals` 表中 `metadata->>'dept' = dept_name` 且 status NOT IN (completed/cancelled) 的第一条
- 若无匹配返回 null（降级，不报错）

在 `createDeptHeartbeatTask` 中调用该函数并设置：
- `goal_id` = 查询结果
- `description` = `"[dept-heartbeat] ${dept_name}: analyze OKR progress and report to Cecelia"`

### Fix 2: pre-flight-check.js — 系统任务类型白名单

在 `preFlightCheck` 开头添加系统任务豁免：系统生成的任务（dept_heartbeat、codex_qa、initiative_verify）跳过 description 检查

## 成功标准

- [ ] `dept-heartbeat.js` createDeptHeartbeatTask 创建的任务有 description 字段
- [ ] `dept-heartbeat.js` createDeptHeartbeatTask 创建的任务 goal_id 已绑定（当 goals 表有匹配时）
- [ ] `pre-flight-check.js` 对 dept_heartbeat/codex_qa/initiative_verify 不检查 description
- [ ] npm test 全部通过
