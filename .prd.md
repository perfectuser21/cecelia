---
id: dedup-drain
version: 1.0.0
created: 2026-02-07
updated: 2026-02-07
changelog:
  - 1.0.0: 初始版本
---

## PRD - Task dedup + Graceful drain mode

**需求来源**: 秋米创建了重复的 "Create complete frontend src directory structure" 任务（相隔 16 秒），暴露了 createTask() 无去重的问题。同时用户需要 drain 模式让正在执行的任务完成后再停止系统。

**功能描述**:

### Fix 1: createTask() SQL dedup
- 在 `brain/src/actions.js` 的 `createTask()` 函数中，INSERT 前增加 SQL 精确匹配去重
- 匹配条件：`goal_id + project_id + title` 在 `queued/in_progress` 状态，或 24h 内 completed
- 如果已存在，返回 `{ success: true, task: existingTask, deduplicated: true }` 而不是报错
- 保持向后兼容：调用方不需要修改

### Fix 2: Graceful drain mode
- 在 `brain/src/tick.js` 添加 drain 状态管理
  - `drainTick()` — 设置 drain 标志，停止新任务派发，但保持 tick loop 运行来监控 in_progress 任务
  - `getDrainStatus()` — 返回 drain 状态 + in_progress 任务列表
  - `cancelDrain()` — 取消 drain 模式，恢复正常派发
- 在 `dispatchNextTask()` 开头检查 drain 标志，如果 draining 则跳过派发
- 在 `brain/src/routes.js` 添加 3 个 API 端点：
  - `POST /api/brain/tick/drain` — 启动 drain
  - `GET /api/brain/tick/drain-status` — 查询 drain 状态
  - `POST /api/brain/tick/drain-cancel` — 取消 drain
- drain 完成条件：所有 in_progress 任务变成 completed/failed 后自动 disable tick

**涉及文件**:
- `brain/src/actions.js` — createTask() 增加 dedup
- `brain/src/tick.js` — drain 状态管理 + dispatchNextTask guard
- `brain/src/routes.js` — 新增 drain API 端点

**成功标准**:
1. createTask() 调用同 title + goal_id + project_id 不会创建重复任务
2. POST /api/brain/tick/drain 后不再派发新任务
3. in_progress 任务自然完成后 drain 状态自动结束
4. 所有现有测试通过
5. DevGate 全绿

**非目标**:
- LLM 语义去重（二期）
- createFeature/createGoal 去重（独立 PR）
- 前端 drain 按钮 UI（前端 PR）
