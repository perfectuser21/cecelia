# PRD - Cortex 持久记忆系统

## 需求来源
免疫系统优化 - P0 关键缺口修复

## 问题背景
当前 Cortex RCA 分析结果只保存在 `cecelia_events` 表中（event_type='cortex_rca_complete'），导致：
1. **查询困难**：cecelia_events 是通用事件表，查询历史 RCA 需要复杂 filter
2. **结构不清晰**：RCA 结果存在 JSONB payload 中，缺少索引和类型约束
3. **无法回看**：Thalamus/Cortex 决策时无法方便地查询"上次遇到类似问题时的分析结论"
4. **学习闭环不完整**：虽然 strategy_adjustments 被应用，但深度分析结果（root_cause, contributing_factors, mitigations）未持久化

## 功能描述
实现 Cortex 持久记忆系统，将 RCA 分析结果结构化存储，并提供查询接口供 Thalamus/Cortex 决策时参考。

## 核心功能

### 1. 数据库表设计

创建 `cortex_analyses` 表：

```sql
CREATE TABLE cortex_analyses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 关联信息
  task_id UUID REFERENCES tasks(id),
  event_id UUID REFERENCES cecelia_events(id),
  trigger_event_type VARCHAR(50),  -- systemic_failure, rca_request, etc.

  -- RCA 核心结果
  root_cause TEXT NOT NULL,
  contributing_factors JSONB,      -- [{factor, impact, evidence}]
  mitigations JSONB,                -- [{action, expected_impact, priority}]

  -- 失败上下文
  failure_pattern JSONB,            -- {class, task_type, frequency, severity}
  affected_systems JSONB,           -- [system_name, ...]

  -- 学习与策略
  learnings JSONB,                  -- 提取的关键经验
  strategy_adjustments JSONB,       -- 建议的策略调整

  -- 元数据
  analysis_depth VARCHAR(20),       -- quick, standard, deep
  confidence_score NUMERIC(3,2),    -- 0.00-1.00
  analyst VARCHAR(20) DEFAULT 'cortex',

  created_at TIMESTAMP DEFAULT NOW(),
  metadata JSONB
);

-- 索引
CREATE INDEX idx_cortex_analyses_task_id ON cortex_analyses(task_id);
CREATE INDEX idx_cortex_analyses_created_at ON cortex_analyses(created_at DESC);
CREATE INDEX idx_cortex_analyses_trigger ON cortex_analyses(trigger_event_type);
CREATE INDEX idx_cortex_analyses_failure_pattern ON cortex_analyses USING GIN (failure_pattern);
```

### 2. 持久化接口

在 `cortex.js` 中新增持久化函数：

```javascript
/**
 * 保存 Cortex 分析结果到持久化存储
 * @param {Object} analysis - RCA 分析结果
 * @param {Object} context - 分析上下文（task, event, etc.）
 * @returns {Promise<UUID>} - 分析记录 ID
 */
async function saveCortexAnalysis(analysis, context)
```

在 `performRCA()` 完成后自动调用 `saveCortexAnalysis()`。

### 3. 查询接口

在 `cortex.js` 中新增查询函数：

```javascript
/**
 * 搜索相关的历史 RCA 分析
 * @param {Object} context - 搜索上下文
 * @param {string} context.task_type - 任务类型
 * @param {string} context.failure_class - 失败类别
 * @param {string} context.trigger_event - 触发事件类型
 * @param {number} limit - 返回数量
 * @returns {Promise<Array>} - 按相关性排序的历史分析
 */
async function searchRelevantAnalyses(context, limit = 5)
```

评分策略（类似 learning semantic search）：
- 失败类别匹配（权重 10）
- 任务类型匹配（权重 8）
- 触发事件匹配（权重 6）
- 时间新鲜度（权重 1-3）

### 4. API 端点

新增 REST API：

```
GET /api/brain/cortex/analyses?task_id=xxx         # 查询任务相关分析
GET /api/brain/cortex/analyses?failure_class=xxx   # 查询失败类别相关分析
GET /api/brain/cortex/analyses/:id                 # 获取单个分析详情
```

在 `routes.js` 中实现。

### 5. 集成到决策流程

修改 `cortex.js` 的 `analyzeDeep()`：
- 调用 `searchRelevantAnalyses()` 获取历史分析
- 将历史分析注入到 Opus prompt 的 context 中
- 提示："参考以下历史类似问题的分析结论..."

修改 `thalamus.js` 的 `analyzeEvent()`：
- 对于 EMERGENCY 级别事件，也查询历史 Cortex 分析
- 快速判断是否为已知问题，避免重复深度分析

## 实现方案

### Phase 1: 数据库设计与迁移
1. 创建迁移文件 `brain/migrations/009_cortex_analyses.sql`
2. 定义表结构和索引
3. 运行迁移

### Phase 2: 持久化实现
1. 在 `cortex.js` 实现 `saveCortexAnalysis()`
2. 修改 `performRCA()` 自动保存结果
3. 更新 `tick.js` 的 `processCortexTask()` 确保保存

### Phase 3: 查询接口
1. 实现 `searchRelevantAnalyses()` 语义检索
2. 实现 API 端点 (`routes.js`)
3. 添加单元测试

### Phase 4: 集成到决策流程
1. 修改 `cortex.js` analyzeDeep() 注入历史分析
2. 修改 `thalamus.js` analyzeEvent() 查询历史（可选，快速判断）
3. 集成测试

## 涉及文件
- `brain/migrations/009_cortex_analyses.sql` - 数据库迁移
- `brain/src/cortex.js` - 持久化 + 查询函数
- `brain/src/routes.js` - API 端点
- `brain/src/__tests__/cortex-memory.test.js` - 新增测试文件
- `brain/src/__tests__/cortex.test.js` - 更新现有测试

## 成功标准
- [ ] `cortex_analyses` 表创建成功，Schema version 008→009
- [ ] `saveCortexAnalysis()` 实现并在 performRCA 后自动调用
- [ ] `searchRelevantAnalyses()` 实现语义检索
- [ ] API 端点实现并返回正确数据
- [ ] Cortex analyzeDeep() 能查询并使用历史分析
- [ ] 测试覆盖所有持久化和查询场景
- [ ] 所有现有测试通过（771 tests）

## 非目标
- 不实现 Cortex 分析的版本控制（v1/v2/v3）
- 不实现分析结果的自动过期清理（手动清理即可）
- 不修改现有 cecelia_events 表结构
- 不在本 PR 实现 Decision Log 回看（那是下一个 P0）

## 验收标准

**数据库**：
```sql
-- 迁移成功
SELECT version FROM schema_version ORDER BY applied_at DESC LIMIT 1;
-- Expected: 009

-- 表存在
\d cortex_analyses

-- 能插入和查询
INSERT INTO cortex_analyses (...) VALUES (...);
SELECT * FROM cortex_analyses WHERE task_id = ...;
```

**代码**：
```javascript
// performRCA 自动保存
const result = await cortex.performRCA(event);
const analyses = await cortex.searchRelevantAnalyses({ failure_class: 'NETWORK' });
// analyses.length > 0
```

**API**：
```bash
curl -s localhost:5221/api/brain/cortex/analyses?failure_class=NETWORK | jq
# 返回历史分析列表
```
