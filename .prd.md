# PRD - 免疫系统 API 接口层

**需求来源**: 用户原话："是的开始吧"，要求补充免疫系统 API 接口，为 P3（前端展示层）准备数据接口

**功能描述**:
P0-P2 已完成后端逻辑（监控、试用期、策略标准化），但缺少完整的 REST API 供前端调用。本任务补充 API 接口层，让 workspace 前端能够展示免疫系统数据。

**涉及文件**:
- `brain/src/routes.js` - 添加新的 API 路由

**成功标准**:
1. **Absorption Policies API** - 策略管理
   - `GET /api/brain/policies` - 列表（支持 `?status=draft/probation/active/disabled` 过滤）
   - `GET /api/brain/policies/:id` - 单个策略详情
   - `GET /api/brain/policies/:id/evaluations` - 策略评估历史
   - `PATCH /api/brain/policies/:id/status` - 更新策略状态（draft→probation→active→disabled）

2. **Failure Signatures API** - 失败分析
   - `GET /api/brain/failures/signatures` - 失败签名统计（按频率排序）
   - `GET /api/brain/failures/signatures/:signature` - 单个签名详情 + 关联策略

3. **Promotion History API** - 晋升记录
   - `GET /api/brain/policies/promotions` - 晋升历史（probation→active 的记录）

4. **Dashboard API** - 免疫系统总览
   - `GET /api/brain/immune/dashboard` - 汇总数据：
     * 策略统计（按状态分类）
     * 隔离区统计（复用现有 `/quarantine/stats`）
     * 失败签名 Top 10
     * 最近晋升记录

5. **API 文档和验证**
   - 所有 API 返回统一格式：`{ success: true/false, data/error, ... }`
   - 错误处理：400/404/500
   - 测试覆盖：至少测试核心 GET 接口

**非目标**:
- ❌ 不做前端界面（前端在 workspace 仓库）
- ❌ 不修改现有 API（只新增，不破坏兼容性）
- ❌ 不做复杂权限控制（Brain 内部 API，暂不需要认证）

---

## API 设计细节

### 1. Absorption Policies API

#### GET /api/brain/policies
查询策略列表，支持过滤。

**Query Parameters**:
- `status` - 可选，过滤状态（draft/probation/active/disabled）
- `limit` - 可选，默认 50
- `offset` - 可选，默认 0

**Response**:
```json
{
  "success": true,
  "data": [
    {
      "policy_id": 123,
      "signature": "error-type-network-timeout",
      "status": "active",
      "policy_json": { "action": "requeue", "params": {...}, ... },
      "created_at": "2026-02-12T10:00:00Z",
      "promoted_at": "2026-02-13T15:30:00Z",
      "risk_level": "low",
      "success_count": 15,
      "failure_count": 0
    }
  ],
  "total": 100
}
```

#### GET /api/brain/policies/:id
获取单个策略详情。

**Response**:
```json
{
  "success": true,
  "data": {
    "policy_id": 123,
    "signature": "error-type-network-timeout",
    "status": "active",
    "policy_json": { "action": "requeue", "params": {...}, ... },
    "created_at": "2026-02-12T10:00:00Z",
    "promoted_at": "2026-02-13T15:30:00Z",
    "risk_level": "low",
    "success_count": 15,
    "failure_count": 0,
    "evaluations": [  // 最近 10 次评估
      {
        "eval_id": 456,
        "task_id": "task-123",
        "mode": "simulate",
        "result": "would_succeed",
        "evaluated_at": "2026-02-13T14:00:00Z"
      }
    ]
  }
}
```

#### GET /api/brain/policies/:id/evaluations
获取策略的评估历史（分页）。

**Query Parameters**:
- `limit` - 可选，默认 20
- `offset` - 可选，默认 0

**Response**:
```json
{
  "success": true,
  "data": [
    {
      "eval_id": 456,
      "task_id": "task-123",
      "mode": "simulate",
      "result": "would_succeed",
      "evaluated_at": "2026-02-13T14:00:00Z",
      "details": { "would_do": "requeue", ... }
    }
  ],
  "total": 50
}
```

#### PATCH /api/brain/policies/:id/status
更新策略状态（手动控制）。

**Request Body**:
```json
{
  "status": "disabled",
  "reason": "手动禁用，策略效果不佳"
}
```

**Response**:
```json
{
  "success": true,
  "message": "Policy status updated to disabled"
}
```

---

### 2. Failure Signatures API

#### GET /api/brain/failures/signatures
获取失败签名统计，按频率排序。

**Query Parameters**:
- `limit` - 可选，默认 20
- `min_count` - 可选，最小出现次数，默认 1

**Response**:
```json
{
  "success": true,
  "data": [
    {
      "signature": "error-type-network-timeout",
      "count": 45,
      "first_seen": "2026-02-10T08:00:00Z",
      "last_seen": "2026-02-12T14:30:00Z",
      "active_policies": 2,  // 关联的 active 策略数
      "probation_policies": 1  // 关联的 probation 策略数
    }
  ]
}
```

#### GET /api/brain/failures/signatures/:signature
获取单个签名详情 + 关联策略。

**Response**:
```json
{
  "success": true,
  "data": {
    "signature": "error-type-network-timeout",
    "count": 45,
    "first_seen": "2026-02-10T08:00:00Z",
    "last_seen": "2026-02-12T14:30:00Z",
    "policies": [
      {
        "policy_id": 123,
        "status": "active",
        "policy_json": { "action": "requeue", ... },
        "success_count": 15,
        "failure_count": 0
      }
    ]
  }
}
```

---

### 3. Promotion History API

#### GET /api/brain/policies/promotions
获取晋升历史（probation→active 的记录）。

**Query Parameters**:
- `limit` - 可选，默认 20
- `days` - 可选，最近 N 天，默认 7

**Response**:
```json
{
  "success": true,
  "data": [
    {
      "policy_id": 123,
      "signature": "error-type-network-timeout",
      "promoted_at": "2026-02-13T15:30:00Z",
      "simulations": 5,  // 试用期模拟次数
      "pass_rate": 1.0,  // 100%
      "risk_level": "low"
    }
  ]
}
```

---

### 4. Dashboard API

#### GET /api/brain/immune/dashboard
免疫系统总览，汇总关键数据。

**Response**:
```json
{
  "success": true,
  "data": {
    "policies": {
      "draft": 5,
      "probation": 3,
      "active": 12,
      "disabled": 8,
      "total": 28
    },
    "quarantine": {
      "total": 15,
      "by_reason": {
        "failure_threshold": 10,
        "manual": 3,
        "resource_hog": 2
      }
    },
    "failures": {
      "top_signatures": [
        {
          "signature": "error-type-network-timeout",
          "count": 45
        }
      ]
    },
    "recent_promotions": [
      {
        "policy_id": 123,
        "signature": "error-type-network-timeout",
        "promoted_at": "2026-02-13T15:30:00Z"
      }
    ]
  }
}
```

---

## 数据库查询

所有 API 从现有表读取：
- `absorption_policies` - 策略数据
- `policy_evaluations` - 评估记录
- `failure_signatures` - 失败签名
- `tasks` (quarantine_*) - 隔离区数据

**不修改数据库 schema**，只查询现有数据。

---

## 测试策略

1. **单元测试** - 关键 API 路由
   - 测试 GET /api/brain/policies（有数据/无数据）
   - 测试 GET /api/brain/failures/signatures
   - 测试 GET /api/brain/immune/dashboard

2. **Mock 数据库** - 使用 vi.mock
   - Mock pool.query 返回测试数据

3. **E2E 测试**（可选）- 本地启动 Brain + 真实数据库
   - 手动验证 API 返回格式正确

---

## 实现顺序

1. Policies API（核心）
2. Failures Signatures API
3. Promotions API
4. Dashboard API（汇总前面三个）
5. 测试
