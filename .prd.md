# PRD: 审计发现的 P1 Bug 修复（v1.52.2）

## 背景

2026-02-20 系统性审计发现 4 个 P1 级 Bug，均在核心调度路径上。本次 patch 统一修复。

## 修复列表

### Fix 1: tick.js — global fallback 时规划器不触发（P1）

**位置**: `brain/src/tick.js` L1400
**问题**: `krIds.length > 0` 导致规划器在无日常焦点时永不调用
**修复**: 改为 `allGoalIds.length > 0`，global fallback 时传 allGoalIds 给 planNextTask

### Fix 2: tick.js — 空 allGoalIds 时 SQL 返回全部任务（P1）

**位置**: `brain/src/tick.js` L1301
**问题**: `OR $1 = '{}'` 在空数组时为 true → 返回所有任务（跨 OKR 污染）
**修复**: allGoalIds 为空时 early return no_active_goals，移除 OR 条件

### Fix 3: executor.js — requeueTask 不更新 learnings（P1）

**位置**: `brain/src/executor.js` requeueTask 函数
**问题**: 任务失败重排后 learnings 表无记录，planner 看不到失败历史
**修复**: requeueTask 中调用 recordLearning 记录失败信息

### Fix 4: decomp-checker.js — null kr_id 抛异常（P2 降级）

**位置**: `brain/src/decomposition-checker.js`
**问题**: initiative.kr_id 为 null 时 createDecompositionTask 抛异常，中断整个分解流程
**修复**: 改为 graceful skip + warning log

## 验收标准

- tick.js hasFocus=false 且队列空时能触发 planNextTask
- tick.js allGoalIds=[] 时返回 no_active_goals 而非查询全部任务
- requeueTask 失败后 learnings 有记录
- decomp-checker null kr_id initiative 被跳过不崩溃
- 全量测试通过，DevGate 通过
- patch bump: 1.52.1 → 1.52.2
