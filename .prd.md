# PRD - Connect Immune System Last Mile

## 背景

免疫系统的核心功能已经实现95%，但最后5%的连接缺失导致功能无法发挥作用：

1. **策略调整** - Cortex 生成调整 → 写入 brain_config → **但从未被读取和应用**
2. **重试策略** - classifyFailure() 精密分类 → 计算 retry_strategy → **但 requeueTask() 忽略它**
3. **Token bucket** - tryConsumeToken() 完整实现 → **但 dispatch 从未调用它**

## 目标

修复3个断链，让已实现的功能真正工作起来。

## 功能需求

### 1. 策略调整读取与应用

**问题**：
- `applyStrategyAdjustments()` 写入 brain_config 表
- 但 alertness.js, executor.js 等文件里的参数都是硬编码
- 调整后的参数从未被读取

**解决方案**：
- 创建 `config-loader.js` 模块
- 提供 `readBrainConfig(key, defaultValue)` 函数
- 在系统启动时或 tick 时读取最新配置
- 应用到内存中的阈值（alertness, executor 等）

**影响范围**：
- 新建：brain/src/config-loader.js
- 修改：brain/src/tick.js (调用 config loader)
- 可选修改：brain/src/alertness.js, executor.js (使用动态配置)

### 2. 重试策略使用

**问题**：
- `classifyFailure()` 计算精确的 retry_strategy（包括 next_run_at）
- 存入 `tasks.payload.failure_classification.retry_strategy`
- 但 `requeueTask()` 使用硬编码的指数退避公式

**解决方案**：
- 在 `requeueTask()` 中读取 `payload.failure_classification.retry_strategy`
- 优先使用 `retry_strategy.next_run_at`
- 只在没有 retry_strategy 时才 fallback 到硬编码退避

**影响范围**：
- 修改：brain/src/executor.js requeueTask() 函数

### 3. Token Bucket 调用

**问题**：
- `tryConsumeToken()` 已实现并 import 到 tick.js
- 但从未在 dispatch 逻辑中被调用
- 限流机制形同虚设

**解决方案**：
- 在 `dispatchNextTask()` 调用前检查 token
- 如果 `allowed: false`，跳过本次 dispatch
- 记录 rate_limited 原因

**影响范围**：
- 修改：brain/src/tick.js dispatchNextTask() 函数

## 非功能需求

- 不破坏现有功能
- 向后兼容（没有 brain_config 记录时使用默认值）
- 测试覆盖所有3个修复

## 验收标准

见 .dod.md

## 技术约束

- Migration 不需要（表结构已存在）
- 只修改业务逻辑代码
- 保持现有 API 接口不变
