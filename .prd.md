---
id: fix-execution-callback-sql-type
version: 1.0.0
created: 2026-02-20
updated: 2026-02-20
changelog:
  - 1.0.0: 初始版本
---

# PRD: 修复 execution-callback SQL 类型 Bug（P0）

## 背景

Brain 的 `execution-callback` 端点在每次任务完成时被调用，用于更新任务状态。
但由于 UPDATE SQL 中存在参数类型推断冲突，事务每次都 ROLLBACK，导致任务状态永远无法从 `in_progress` 更新为 `completed`，系统无法 24/7 正常运行。

## 根本原因

`routes.js` 的 UPDATE tasks 语句中，`$2` 参数在两处被推断为不兼容的类型：

```sql
SET status = $2,              -- $2 推断为 character varying(50)
...
CASE WHEN $2 = 'completed'    -- $2 推断为 text
```

PostgreSQL 报错：`inconsistent types deduced for parameter $2 (text versus character varying)`

## 修复方案

在 CASE WHEN 中对 `$2` 添加显式类型转换：

```sql
CASE WHEN $2::text = 'completed' THEN NOW() ELSE completed_at END
```

## 影响范围

- 文件：`brain/src/routes.js`
- 函数：`router.post('/execution-callback', ...)`
- 改动量：1 行

## 验收标准

1. `execution-callback` 调用后，任务状态能正确更新为 `completed` 或 `failed`
2. Brain 日志不再出现 `inconsistent types deduced for parameter $2` 错误
3. SQL PREPARE 测试通过（不再报 inconsistent types）
4. 全量测试通过，版本 patch bump
