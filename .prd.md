---
id: prd-agent-monitor-m1
version: 1.0.0
created: 2026-01-29
updated: 2026-01-29
changelog:
  - 1.0.0: M1 - 实时监控 API + 数据模型
---

# PRD: Agent Monitor M1 - 实时监控

## Overview

| 项目 | 信息 |
|------|------|
| **目标仓库** | cecelia-semantic-brain |
| **依赖** | Patrol Agent M1 (已完成) |
| **优先级** | P1 |
| **里程碑** | M1 |

## Background

M1 implemented the Patrol API in Brain, but discovered an architecture issue:
- `cecelia_runs` data is in Core (:5212)
- Patrol API is in Brain (:5220)

Patrol Agent 提供"事后巡逻"能力（定期检测 stale 任务），但缺少"过程中实时可见性"。

需要一个实时监控系统：
- Dashboard 能看到当前有哪些 Agent 在跑
- 每个 Agent 当前执行什么工具
- 工具调用历史（timeline）
- Run 结束后落库供复盘

---

## 架构定位

```
/api/patrol/*  - 事后巡逻（定期检测 + 诊断恢复）   ← 已有
/api/agents/*  - 实时监控（过程可见性 + 事件流）   ← 本 PRD
```

两者互补，不冲突。

## Features

### 数据模型

#### agent_runs 表（实时状态快照）

```sql
CREATE TABLE agent_runs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id TEXT NOT NULL UNIQUE,
    output_file TEXT UNIQUE NOT NULL,
    project TEXT,
    source TEXT DEFAULT 'claude_code',
    status TEXT DEFAULT 'running',
    current_tool TEXT,
    last_result TEXT,
    last_seq INT DEFAULT 0,
    turn_count INT DEFAULT 0,
    last_heartbeat_at TIMESTAMPTZ DEFAULT NOW(),
    started_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ,
    cecelia_run_id UUID
);
```

#### agent_events 表（统一事件流）

```sql
CREATE TABLE agent_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    run_id UUID NOT NULL,
    seq INT NOT NULL,
    type TEXT NOT NULL,
    tool_name TEXT,
    payload JSONB NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT agent_events_run_seq_unique UNIQUE (run_id, seq)
);
```

### 事件类型映射

| Output type | 特征 | → event.type |
|-------------|------|--------------|
| user | content 是字符串 | user_message |
| user | content[].type=="tool_result" | tool_result |
| assistant | content[].type=="text" | text |
| assistant | content[].type=="tool_use" | tool_use |
| progress | data.type=="hook_progress" | hook_progress |

### API 端点

```
GET  /api/agents/runs              - 列出 runs
GET  /api/agents/runs/:id          - 获取 run 详情
GET  /api/agents/runs/:id/events   - 获取事件列表
GET  /api/agents/runs/active       - 获取活跃 runs
GET  /api/agents/runs/summary      - 获取统计摘要
```

## 成功标准

1. `pytest tests/test_agent_monitor.py -v` 通过
2. API 能返回正确的 runs 和 events
3. Parser 能正确解析 output 文件格式
4. CI 通过，PR 合并
