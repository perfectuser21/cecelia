---
id: prd-brain-consolidation-m1
version: 1.0.0
created: 2026-01-29
updated: 2026-01-29
changelog:
  - 1.0.0: M1 数据库连接 + Focus 迁移
---

# PRD: M1 Database Connection + Focus Migration

## 📋 项目信息

| 项目 | 信息 |
|------|------|
| **名称** | Brain Consolidation - M1 |
| **目标仓库** | cecelia-semantic-brain |
| **源仓库** | cecelia-workspace/apps/core/src/brain |
| **端口** | 5220（统一） |
| **技术栈** | Python + FastAPI + asyncpg |

---

## 🎯 目标

**M1: 添加 PostgreSQL 数据库连接 + 迁移 Focus 功能**

### 本次 PR 范围

1. **数据库连接层**
   - 添加 asyncpg 依赖
   - 创建 Database 类（连接池管理）
   - 支持环境变量配置

2. **Focus 功能迁移**
   - 从 Node.js 迁移 focus.js 到 Python
   - 实现 select_daily_focus()
   - 实现 set/clear focus override

3. **API 路由**
   - GET /api/brain/focus
   - POST /api/brain/focus/set
   - POST /api/brain/focus/clear

---

## 📦 涉及文件

### 新增

| 文件 | 功能 |
|------|------|
| `src/db/__init__.py` | 模块导出 |
| `src/db/pool.py` | 数据库连接池 |
| `src/state/__init__.py` | 模块导出 |
| `src/state/focus.py` | Focus 逻辑 |
| `src/api/state_routes.py` | State API 路由 |
| `tests/test_db.py` | 数据库测试 |
| `tests/test_focus.py` | Focus 测试 |
| `tests/test_state_api.py` | API 测试 |

### 修改

| 文件 | 修改内容 |
|------|----------|
| `requirements.txt` | 添加 asyncpg |
| `src/api/main.py` | 注册 state 路由 |

---

## 🔧 技术细节

### 数据库连接 (Python)

```python
# src/db/pool.py
import asyncpg
from contextlib import asynccontextmanager

class Database:
    def __init__(self, dsn: str):
        self.dsn = dsn
        self.pool = None

    async def connect(self):
        self.pool = await asyncpg.create_pool(self.dsn)

    async def disconnect(self):
        await self.pool.close()

    @asynccontextmanager
    async def connection(self):
        async with self.pool.acquire() as conn:
            yield conn
```

### Focus 迁移

从 Node.js 迁移以下功能：
- `selectDailyFocus()` - 选择今日焦点
- `getDailyFocus()` - 获取焦点详情
- `setDailyFocus()` - 手动设置焦点
- `clearDailyFocus()` - 清除手动设置

---

## ✅ 成功标准

- [ ] asyncpg 依赖已添加
- [ ] Database 类能连接 PostgreSQL
- [ ] 连接池正常工作
- [ ] GET /api/brain/focus 返回 OKR 焦点
- [ ] POST /api/brain/focus/set 设置手动焦点
- [ ] POST /api/brain/focus/clear 清除手动焦点
- [ ] 所有测试通过

---

## 🔗 依赖

- asyncpg >= 0.29.0
- PostgreSQL 数据库（5432 端口）
- 现有 goals 和 working_memory 表
