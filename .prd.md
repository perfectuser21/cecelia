# PRD - Learning 语义检索

## 需求来源
免疫系统优化 - P0 关键缺口修复

## 问题背景
当前 `getRecentLearnings()` 按时间排序获取最近 N 条经验，导致：
1. **相关性差**：注入到 Thalamus/Cortex 的经验可能全是过时的或不相关的
2. **浪费 context**：无效经验占用 prompt 空间
3. **学习效果差**：大脑无法利用真正相关的历史经验

## 功能描述
实现基于语义的 Learning 检索机制，根据任务类型和失败模式匹配相关经验。

## 核心功能

### 1. 语义匹配函数
```javascript
/**
 * 搜索相关 learnings
 * @param {Object} context - 搜索上下文
 * @param {string} context.task_type - 任务类型 (dev/review/qa/audit/research/talk/data)
 * @param {string} context.failure_class - 失败类别 (NETWORK/BILLING_CAP/RATE_LIMIT/RESOURCE/etc)
 * @param {string} context.event_type - 事件类型 (systemic_failure/rca_request/etc)
 * @param {number} limit - 返回数量
 * @returns {Promise<Array>} - 按相关性排序的 learnings
 */
async function searchRelevantLearnings(context, limit = 10)
```

### 2. 相关性评分策略

| 匹配维度 | 权重 | 说明 |
|----------|------|------|
| **任务类型完全匹配** | 10 | metadata.task_type = context.task_type |
| **失败类别完全匹配** | 8 | content 包含相同 failure_class |
| **事件类型匹配** | 6 | trigger_event = context.event_type |
| **分类相同** | 4 | category = 'failure_pattern' |
| **时间新鲜度** | 1-3 | 7 天内 +3，30 天内 +2，其他 +1 |

**总分 = 各维度得分之和，按总分降序排序**

### 3. 替换现有调用

**修改位置**：
- `brain/src/thalamus.js` - `analyzeEvent()` 中的 `getRecentLearnings()`
- `brain/src/cortex.js` - `analyzeDeep()` 中的 `getRecentLearnings()`

**替换逻辑**：
```javascript
// Before
const learnings = await getRecentLearnings();

// After
const learnings = await searchRelevantLearnings({
  task_type: event.task?.task_type,
  failure_class: event.failure_info?.class,
  event_type: event.type
});
```

## 实现方案

### Phase 1: 实现语义检索函数
1. 在 `learning.js` 中实现 `searchRelevantLearnings()`
2. 实现相关性评分逻辑
3. 保留 `getRecentLearnings()` 作为 fallback

### Phase 2: 替换调用点
1. 修改 `thalamus.js` 使用语义检索
2. 修改 `cortex.js` 使用语义检索
3. 传入完整 context 信息

### Phase 3: 测试验证
1. 单元测试：验证评分逻辑正确
2. 集成测试：验证检索结果相关性
3. 对比测试：新旧方法结果对比

## 涉及文件
- `brain/src/learning.js` - 新增 `searchRelevantLearnings()`
- `brain/src/thalamus.js` - 替换 `getRecentLearnings()` 调用
- `brain/src/cortex.js` - 替换 `getRecentLearnings()` 调用
- `brain/src/__tests__/learning-search.test.js` - 新增测试文件

## 成功标准
- [ ] `searchRelevantLearnings()` 实现并导出
- [ ] 相关性评分逻辑按权重计算
- [ ] thalamus.js 使用语义检索
- [ ] cortex.js 使用语义检索
- [ ] 测试覆盖所有评分维度
- [ ] 测试验证相关性优于时间排序
- [ ] 所有现有测试通过

## 非目标
- 不实现 embedding 向量搜索（过度复杂）
- 不修改 learnings 表结构
- 不改变 learning 记录逻辑
- 保持 API 向后兼容（getRecentLearnings 保留）
