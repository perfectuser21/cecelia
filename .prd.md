# PRD: 修复 5 大脑器官缺口

## 背景

免疫系统已完成（PR #182），但 Brain 的 5 个核心器官存在缺口，导致 Brain 无法完整自主运作。

**不要先修 Brain 启动问题** - 先把器官修好，再启动。

---

## 问题清单

### 1. Cortex 空壳（L2 皮层）

**现状**：
- `brain/src/cortex.js` 存在但是空壳实现
- Cortex 应该是 L2 皮层（Opus），负责深度分析、RCA、战略调整
- 现在只有框架，没有实际功能

**期望**：
- Cortex 能接收 RCA 任务（如 Alertness Emergency 时创建的 RCA 任务）
- 执行深度分析：Root cause identification, Contributing factors, Recommended mitigations
- 输出 strategy adjustments（调整 alertness 阈值、行为参数等）
- 结果保存到 `cecelia_events` 或 `decisions` 表

**验收标准**：
- [ ] cortex.js 有完整的 RCA 分析逻辑
- [ ] 能处理 `task.payload.requires_cortex = true` 的任务
- [ ] 分析结果包含：root_cause, contributing_factors, mitigations, strategy_adjustments
- [ ] 测试：创建 RCA 任务 → Cortex 分析 → 验证输出

---

### 2. Planner 不自动生成任务

**现状**：
- `brain/src/planner.js` 的 `planNextTask()` 只评分选任务
- 不会自动生成新任务（注释说"Task creation is 秋米's responsibility via /okr"）
- 但 tick.js Step 6b/6c 已经自动创建 KR 拆解任务，说明 planner 可以生成任务

**期望**：
- Planner 能根据 KR 状态自动生成 Task
- 当 KR 没有 queued tasks 时，自动创建"下一步任务"
- 不依赖外部 agent（秋米）也能保证 Brain 持续运作

**验收标准**：
- [ ] planNextTask() 能检测 KR 缺少 Task 的情况
- [ ] 自动生成合理的"下一步任务"（可以是简单的 placeholder 任务，等待秋米细化）
- [ ] 生成的任务有 `auto_generated: true` 标记
- [ ] 测试：KR 无 Task → planner 自动生成 → 验证任务内容

---

### 3. Feature Tick 断裂

**现状**：
- `migrations/003_feature_tick_system.sql` 创建了 `features` 和 `recurring_tasks` 表
- 但 tick.js 中没有对 Feature 的处理逻辑
- Feature tick 系统没有运行

**期望**：
- tick.js 能定期检查 features 表
- 根据 feature 配置生成 recurring_tasks
- Feature tick 与 KR tick 并行运行

**验收标准**：
- [ ] tick.js 新增 Feature tick 逻辑
- [ ] 能处理 recurring_tasks（定期任务）
- [ ] Feature 状态正确更新（last_tick_at, next_tick_at）
- [ ] 测试：创建 feature → tick → 验证 recurring_tasks 生成

---

### 4. 没有学习闭环

**现状**：
- 有 `docs/LEARNINGS.md` 手动记录
- 但 Brain 不会自动从失败中学习
- 没有"失败 → 分析 → 调整策略"的闭环

**期望**：
- Brain 检测到 systemic failure 时，自动触发学习
- Cortex 分析失败模式
- 调整策略参数（如 alertness 阈值、retry 策略、resource limits）
- 策略调整记录到 `brain_config` 或新表 `learnings`

**验收标准**：
- [ ] 失败检测 → 自动创建 learning 任务
- [ ] Cortex 分析 → 输出 strategy adjustments
- [ ] 策略自动应用到 brain_config
- [ ] 测试：触发 systemic failure → 验证策略调整

---

### 5. Alertness 评估没写完

**现状**：
- `brain/src/alertness.js` 有评估框架
- 但某些信号采集不完整，阈值可能不合理
- 评估逻辑需要完善

**期望**：
- 所有 9 种信号都正确采集
- 阈值经过验证（可能需要调整）
- 评估逻辑清晰、可测试

**验收标准**：
- [ ] 9 种信号全部实现并测试
- [ ] 阈值有文档说明（为什么是这个值）
- [ ] 评估逻辑有完整测试覆盖
- [ ] 测试：模拟各种信号 → 验证等级变化

---

## 实现顺序建议

**优先级**：P0（阻塞）> P1（重要）> P2（优化）

| 问题 | 优先级 | 原因 |
|------|--------|------|
| 1. Cortex 空壳 | **P0** | Alertness Emergency 已创建 RCA 任务，但没人处理 |
| 2. Planner 自动生成 | **P1** | KR 没 Task 时 Brain 会空转 |
| 3. Feature Tick | **P2** | 功能完整性，但不影响主流程 |
| 4. 学习闭环 | **P1** | 自我进化的关键 |
| 5. Alertness 评估 | **P2** | 优化，当前基本可用 |

**建议顺序**：1 → 4 → 2 → 5 → 3

---

## 实现策略

每个问题独立 PR：
1. 每个问题一个分支（`cp-0207-cortex`, `cp-0207-learning-loop` 等）
2. 每个 PR 有独立的 DoD 和测试
3. 按优先级顺序合并

---

## 成功标准

**5 个 PR 全部合并后**：
- ✅ Cortex 能处理 RCA 任务
- ✅ Planner 能自动生成任务
- ✅ Feature Tick 正常运行
- ✅ Brain 能从失败中学习
- ✅ Alertness 评估完整可靠

**然后**：修复 Brain 启动问题，启动 Brain，验证完整闭环。

---

## 参考资料

- `brain/src/cortex.js` - L2 皮层框架
- `brain/src/planner.js` - 任务规划器
- `brain/src/tick.js` - Tick 循环（Step 6b/6c 是 KR 拆解）
- `brain/src/alertness.js` - 警觉评估系统
- `migrations/003_feature_tick_system.sql` - Feature Tick 数据库
- `docs/LEARNINGS.md` - 手动学习记录

---

**注意**：新窗口开始时，先读这个 PRD，理解全貌，然后按优先级逐个攻克。
