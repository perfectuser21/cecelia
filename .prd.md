---
id: prd-semantic-brain-mvp
version: 1.0.1
created: 2026-01-28
updated: 2026-01-28
changelog:
  - 1.0.1: Started MVP implementation
  - 1.0.0: Initial PRD for Cecelia Semantic Brain
---

# PRD: Cecelia Semantic Brain

## 📋 项目信息

| 项目 | 信息 |
|------|------|
| **名称** | Cecelia Semantic Brain |
| **仓库** | cecelia-semantic-brain |
| **定位** | 私人知识检索层，为所有 Cecelia 系统提供语义搜索能力 |
| **部署** | VPS（美国，与数据源同地） |
| **端口** | 5220 |
| **技术栈** | Python + FastAPI + Chroma + OpenAI API |

---

## 🎯 项目目标

**核心价值**：让 AI（Claude Code、Realtime）拥有"记忆"，能理解你的：
- 项目历史
- 开发决策
- 文档内容
- 任务状态
- 代码演进

**具体场景**：
- Claude Code: "上次这个 bug 是怎么修的？"
- Realtime: "autopilot 最新版本有哪些功能？"
- Dashboard: 智能搜索所有项目文档

---

## 📐 系统架构

```
┌─────────────────────────────────────────────────────┐
│              VPS 文件系统（数据源）                   │
│  /home/xx/dev/                                      │
│    ├── cecelia-workspace/  (Core + Autopilot)      │
│    ├── cecelia-quality/    (Hooks + Gates)         │
│    ├── zenithjoy-engine/   (Skills + Contracts)    │
│    └── ...                                          │
└──────────────────┬──────────────────────────────────┘
                   │ 监听
                   ▼
┌─────────────────────────────────────────────────────┐
│           Cecelia Semantic Brain                    │
│                                                     │
│  ┌─────────────┐                                   │
│  │  Watcher    │  监听文件变化                      │
│  │  (inotify)  │  → .md, .ts, .js, .yaml           │
│  └──────┬──────┘                                   │
│         │                                           │
│         ▼                                           │
│  ┌─────────────┐                                   │
│  │  Chunker    │  文本切块                          │
│  │             │  → 500 tokens/chunk               │
│  └──────┬──────┘                                   │
│         │                                           │
│         ▼                                           │
│  ┌─────────────┐                                   │
│  │  Embedder   │  向量化                            │
│  │  (OpenAI)   │  → text-embedding-3-small         │
│  └──────┬──────┘                                   │
│         │                                           │
│         ▼                                           │
│  ┌─────────────┐                                   │
│  │  Chroma DB  │  向量存储                          │
│  │  (SQLite)   │  → 本地持久化                      │
│  └──────┬──────┘                                   │
│         │                                           │
│         ▼                                           │
│  ┌─────────────┐                                   │
│  │ Fusion API  │  HTTP 查询接口                     │
│  │  (FastAPI)  │  → POST /fusion                   │
│  └─────────────┘                                   │
│         │                                           │
└─────────┼───────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────┐
│                    调用方                            │
│  - Claude Code (MCP)                                │
│  - Claude Realtime (WebSocket)                      │
│  - Dashboard (HTTP)                                 │
│  - n8n Workflows (HTTP)                             │
└─────────────────────────────────────────────────────┘
```

---

## 🎨 功能需求

### 阶段 1: 最小可用版本（MVP）

**目标**：能查询、能用、能验证价值

| 功能 | 描述 | 优先级 |
|------|------|--------|
| **SoR 配置** | 定义监听哪些目录和文件类型 | P0 |
| **手动索引** | 一次性扫描所有文件并生成向量 | P0 |
| **Chunker** | 按 500 tokens 切块，保留上下文 | P0 |
| **Embedder** | 调用 OpenAI API 生成向量 | P0 |
| **Chroma 存储** | 本地向量数据库 | P0 |
| **CLI 查询** | 命令行测试查询功能 | P0 |
| **基础元数据** | 文件路径、修改时间、chunk_id | P0 |

**产物**：
```bash
# 索引
python src/cli.py index --path /home/xx/dev

# 查询
python src/cli.py search "autopilot 最新功能"
```

**验收标准**：
- [ ] 能索引 /home/xx/dev 下所有 .md 文件
- [ ] 查询 "autopilot" 能返回相关文档片段
- [ ] 响应时间 < 100ms（本地查询）

---

### 阶段 2: 自动化（Auto-sync）

**目标**：文件改动自动更新，无需手动触发

| 功能 | 描述 | 优先级 |
|------|------|--------|
| **文件监听** | watchdog 监听配置目录 | P0 |
| **增量更新** | 只更新变化的文件 | P0 |
| **删除同步** | 文件删除时清理向量 | P1 |
| **后台服务** | systemd/Docker 自动启动 | P0 |
| **日志记录** | 记录所有索引操作 | P1 |

**产物**：
```bash
# 启动后台服务
docker-compose up -d semantic-brain

# 自动监听，文件改动实时更新
```

**验收标准**：
- [ ] 修改一个 .md 文件后 5 秒内索引更新
- [ ] 服务崩溃后自动重启
- [ ] 日志可查询最近的索引操作

---

### 阶段 3: Fusion API（生产就绪）

**目标**：提供 HTTP 接口，支持所有调用方

| 功能 | 描述 | 优先级 |
|------|------|--------|
| **POST /fusion** | 语义搜索接口 | P0 |
| **GET /health** | 健康检查 | P0 |
| **GET /stats** | 索引统计信息 | P1 |
| **结果排序** | 按相似度 + 时间排序 | P0 |
| **结果摘要** | 自动总结前 N 个片段 | P1 |
| **过滤器** | 按项目、日期、文件类型过滤 | P2 |
| **权限控制** | API Token 验证（简单版） | P2 |

**API 设计**：

```bash
# 查询接口
POST http://localhost:5220/fusion
Content-Type: application/json

{
  "query": "autopilot 最新版本功能",
  "top_k": 10,
  "filters": {
    "project": "cecelia-workspace",
    "file_type": ".md",
    "after": "2026-01-01"
  }
}

# 响应
{
  "results": [
    {
      "chunk_id": "abc123",
      "text": "Autopilot v2.0 新增功能：...",
      "similarity": 0.89,
      "metadata": {
        "file_path": "/home/xx/dev/cecelia-workspace/CHANGELOG.md",
        "line_range": [45, 60],
        "modified_at": "2026-01-25T10:30:00Z"
      }
    }
  ],
  "summary": "Autopilot 最新版本是 v2.0，主要新增了...",
  "total": 10,
  "query_time_ms": 23
}

# 健康检查
GET http://localhost:5220/health
→ {"status": "healthy", "indexed_chunks": 5432}

# 统计信息
GET http://localhost:5220/stats
→ {
    "total_chunks": 5432,
    "total_files": 234,
    "last_updated": "2026-01-28T12:00:00Z",
    "db_size_mb": 45.2
  }
```

**验收标准**：
- [ ] API 响应时间 < 50ms（P99）
- [ ] 支持 10 并发请求
- [ ] 错误返回标准 HTTP 状态码

---

## 🗂️ 数据结构

### SoR 配置 (sor/config.yaml)

```yaml
sources:
  - name: cecelia-workspace
    path: /home/xx/dev/cecelia-workspace
    include:
      - "**/*.md"
      - "**/*.ts"
      - "**/CLAUDE.md"
      - "**/README.md"
      - "**/.prd*.md"
      - "**/.dod*.md"
    exclude:
      - "**/node_modules/**"
      - "**/dist/**"
      - "**/.git/**"
    priority: high

  - name: cecelia-quality
    path: /home/xx/dev/cecelia-quality
    include:
      - "**/*.md"
      - "**/*.sh"
      - "**/*.yaml"
    exclude:
      - "**/node_modules/**"
    priority: high

  - name: zenithjoy-engine
    path: /home/xx/dev/zenithjoy-engine
    include:
      - "**/*.md"
      - "hooks/**/*"
      - "skills/**/*"
    priority: medium

chunk_size: 500  # tokens
chunk_overlap: 50  # tokens
```

### Chunk 元数据

```json
{
  "chunk_id": "abc123",
  "text": "实际文本内容...",
  "embedding": [0.123, 0.456, ...],  // 1536 维向量
  "metadata": {
    "file_path": "/home/xx/dev/cecelia-workspace/README.md",
    "project": "cecelia-workspace",
    "file_type": ".md",
    "line_range": [10, 25],
    "chunk_index": 2,
    "total_chunks": 8,
    "created_at": "2026-01-28T12:00:00Z",
    "modified_at": "2026-01-28T12:00:00Z",
    "file_size": 12345,
    "git_commit": "abc123def"  // 可选
  }
}
```

---

## 🛠️ 技术选型

| 组件 | 技术 | 理由 |
|------|------|------|
| **文件监听** | Python watchdog | 跨平台，稳定，事件驱动 |
| **文本切块** | langchain TextSplitter | 成熟库，支持多种策略 |
| **Embedding** | OpenAI text-embedding-3-small | 性价比高（$0.00002/1K tokens），1536 维 |
| **向量库** | Chroma | 开箱即用，SQLite 底层，支持元数据过滤 |
| **API 框架** | FastAPI | 高性能，异步，自动文档，类型安全 |
| **部署** | Docker + docker-compose | 隔离环境，易管理 |
| **日志** | Python logging + 文件轮转 | 标准库，可靠 |

### 依赖版本

```txt
# requirements.txt
fastapi==0.109.0
uvicorn[standard]==0.27.0
chromadb==0.4.22
openai==1.10.0
watchdog==4.0.0
langchain==0.1.5
pydantic==2.5.3
python-dotenv==1.0.0
pyyaml==6.0.1
```

---

## 📊 资源预估

| 指标 | 估算值 |
|------|--------|
| **文件数量** | 200-500 |
| **总文本量** | 5-10 MB |
| **Chunk 数量** | 3,000-8,000 |
| **向量数据大小** | 50-100 MB |
| **内存占用** | 200-500 MB |
| **CPU 占用** | <5% (idle), 30% (indexing) |
| **索引时间** | 2-5 分钟（首次） |
| **查询延迟** | 10-50 ms |

### 成本预估

**OpenAI API 费用**：

| 操作 | Token 数 | 费用 |
|------|---------|------|
| 首次索引（8000 chunks × 500 tokens） | 4M tokens | $0.08 |
| 每日增量更新（50 chunks） | 25K tokens | $0.0005 |
| 每月总计 | - | **< $1** |

极低成本。

---

## 🚀 部署方案

### Docker 部署（推荐）

**Dockerfile**:
```dockerfile
FROM python:3.11-slim

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制代码
COPY src/ ./src/
COPY sor/ ./sor/

# 创建数据目录
RUN mkdir -p /data/chroma

# 环境变量
ENV CHROMA_DB_PATH=/data/chroma
ENV OPENAI_API_KEY=""
ENV LOG_LEVEL=INFO

# 暴露端口
EXPOSE 5220

# 启动命令
CMD ["python", "-m", "uvicorn", "src.api.main:app", "--host", "0.0.0.0", "--port", "5220"]
```

**docker-compose.yml**:
```yaml
version: '3.8'

services:
  semantic-brain:
    build: .
    container_name: cecelia-semantic-brain
    network_mode: host
    volumes:
      # 挂载数据源（只读）
      - /home/xx/dev:/mnt/dev:ro
      # 持久化向量数据
      - ./data/chroma:/data/chroma
      # 日志
      - ./logs:/app/logs
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - CHROMA_DB_PATH=/data/chroma
      - SOR_CONFIG_PATH=/app/sor/config.yaml
      - LOG_LEVEL=INFO
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5220/health"]
      interval: 30s
      timeout: 5s
      retries: 3
```

### 启动流程

```bash
# 1. 创建仓库
cd /home/xx/dev
git clone <repo-url> cecelia-semantic-brain
cd cecelia-semantic-brain

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env，填入 OPENAI_API_KEY

# 3. 首次索引
docker-compose run --rm semantic-brain python src/cli.py index

# 4. 启动服务
docker-compose up -d

# 5. 测试
curl http://localhost:5220/health
curl -X POST http://localhost:5220/fusion \
  -H "Content-Type: application/json" \
  -d '{"query": "autopilot 功能"}'
```

---

## 📈 成功指标

### 技术指标

| 指标 | 目标 | 验证方式 |
|------|------|----------|
| **索引覆盖率** | 95% 目标文件 | 手动抽查 |
| **查询准确率** | Top 5 结果相关度 > 80% | 测试 20 个查询 |
| **响应延迟** | P99 < 100ms | 压测 |
| **服务可用性** | > 99% | 监控 7 天 |
| **内存占用** | < 500MB | Docker stats |

### 业务指标

| 指标 | 目标 |
|------|------|
| **Claude Code 调用次数** | > 10 次/天 |
| **查询满意度** | 主观感觉"有用" |
| **节省时间** | 每次查询节省 2-5 分钟（vs 手动翻文件）|

---

## 🔐 安全考虑

| 风险 | 缓解措施 |
|------|---------|
| **API 滥用** | 1. 简单 Token 验证 2. Rate limiting（后续）|
| **数据泄漏** | 1. 只监听本地文件 2. 不上传到外部 3. Docker 隔离 |
| **OpenAI API Key 泄漏** | 1. 环境变量 2. .env 不提交 git |
| **磁盘占满** | 1. 日志轮转 2. 定期清理旧向量 |

---

## 🧪 测试策略

### 单元测试

```python
# tests/test_chunker.py
def test_chunk_markdown():
    text = "# Title\n\nContent..."
    chunks = chunker.split(text, chunk_size=500)
    assert len(chunks) > 0
    assert all(len(c) <= 500 for c in chunks)

# tests/test_embedder.py
def test_embed_text():
    vector = embedder.embed("test text")
    assert len(vector) == 1536

# tests/test_api.py
def test_fusion_api():
    response = client.post("/fusion", json={"query": "test"})
    assert response.status_code == 200
    assert "results" in response.json()
```

### 集成测试

```bash
# 端到端测试
1. 创建测试文件 /tmp/test.md
2. 触发索引
3. 查询该文件内容
4. 验证能返回
5. 删除文件
6. 验证向量也删除
```

---

## 📅 里程碑

### Milestone 1: MVP（3-5 天）

- [x] 仓库创建
- [ ] SoR 配置
- [ ] Chunker + Embedder
- [ ] Chroma 集成
- [ ] CLI 工具
- [ ] 手动索引测试
- [ ] 查询测试

**交付物**：可用的命令行工具

---

### Milestone 2: 自动化（2-3 天）

- [ ] Watcher 实现
- [ ] 增量更新
- [ ] Docker 部署
- [ ] 后台服务
- [ ] 日志系统

**交付物**：自动同步的后台服务

---

### Milestone 3: API（2-3 天）

- [ ] FastAPI 实现
- [ ] /fusion 接口
- [ ] 健康检查
- [ ] 错误处理
- [ ] API 文档
- [ ] 集成测试

**交付物**：生产就绪的 HTTP API

---

### Milestone 4: MCP 集成（1-2 天）

- [ ] MCP Server 实现
- [ ] Claude Code 集成测试
- [ ] Realtime 集成测试

**交付物**：Claude 可直接调用的 MCP 工具

---

## 🔄 后续优化（可选）

### Phase 2 Features

- [ ] 本地 embedding 模型（Ollama nomic-embed-text）
- [ ] 知识图谱可视化
- [ ] 多模态支持（图片、PDF）
- [ ] 历史版本追踪（Git integration）
- [ ] 智能摘要生成
- [ ] 相关文档推荐
- [ ] Web UI（查询界面）

### Phase 3 Features

- [ ] 分布式部署（VPS + Mac mini）
- [ ] Redis 缓存层
- [ ] 更高级的 RAG（检索增强生成）
- [ ] Fine-tuned embedding 模型
- [ ] A/B 测试框架

---

## 📚 参考资料

- [Chroma Documentation](https://docs.trychroma.com/)
- [OpenAI Embeddings Guide](https://platform.openai.com/docs/guides/embeddings)
- [FastAPI Best Practices](https://fastapi.tiangolo.com/tutorial/)
- [LangChain Text Splitters](https://python.langchain.com/docs/modules/data_connection/document_transformers/)

---

## ✅ DoD（Definition of Done）

MVP 完成的标准：

- [ ] 仓库创建，README 完善
- [ ] 能索引 /home/xx/dev 下所有配置的文件
- [ ] CLI 查询功能正常
- [ ] 查询 10 个测试问题，准确率 > 80%
- [ ] 响应时间 < 100ms
- [ ] Docker 部署成功
- [ ] API 健康检查正常
- [ ] 单元测试覆盖率 > 60%
- [ ] 文档完整（README + API docs）

---

**Owner**: Claude Code
**Reviewers**: Alex
**Estimated Effort**: 10-15 天（分三阶段）
**Risk Level**: Low（技术成熟，架构简单）
