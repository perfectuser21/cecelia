---
id: prd-vector-memory-ops
version: 1.0.0
created: 2026-02-17
updated: 2026-02-17
changelog:
  - 1.0.0: 初始版本
---

# PRD: Vector Memory 运维补齐

## 背景

Vector memory 已工作（1031 tasks + 25 capabilities 有 embeddings），但有两个运维缺口：
1. rolling-update.sh 部署后容器没有 OPENAI_API_KEY，vector search 退回 Jaccard
2. 新 task 创建后没有 embedding，memory search 逐渐失效

## 目标

1. **rolling-update.sh 传 OPENAI_API_KEY** — 部署后容器自动有 key，vector search 持续有效
2. **新 task 自动生成 embedding** — task 创建/完成时异步触发 embedding 生成，不阻塞主流程

## 方案

### Issue 1: rolling-update.sh

在两处 `docker run` 命令里加 `-e "OPENAI_API_KEY=${OPENAI_API_KEY}"`（passthrough，不写实际 key）。

### Issue 2: 自动 embedding

在 `brain/src/routes.js` 的 `execution-callback` 处理里，task 变为 `completed` 后，fire-and-forget 异步生成该 task 的 embedding：

```javascript
// 不 await，失败静默
generateTaskEmbeddingAsync(taskId, title, description).catch(() => {});
```

新增 `brain/src/embedding-service.js`：
- `generateTaskEmbeddingAsync(taskId, title, description)` — 调用 openai-client.js 生成并写入 DB
- 有 OPENAI_API_KEY 才运行，否则 no-op
- 失败静默（不影响任何现有流程）

## 不在范围

- 不改 capability embedding（已有手动脚本）
- 不改 pgvector schema（已在 migration 028）
- 不影响任何现有测试

## 完成标准

1. `bash scripts/rolling-update.sh` 后，新容器有 OPENAI_API_KEY（`docker exec ... env | grep OPENAI` 验证）
2. 创建一个新 task 后，等 10s，该 task 的 embedding 不为 null（API 验证）
3. 所有现有测试通过
