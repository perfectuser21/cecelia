---
id: fix-trigger-source
version: 1.0.0
created: 2026-02-07
updated: 2026-02-07
changelog:
  - 1.0.0: 初始版本
---

# Fix: trigger_source 区分执行者

## 问题

tasks 表有 trigger_source 列（migration 004），但所有 INSERT 都没有设置它，全部走默认值 'auto'。无法区分 task 是用户前台创建还是 Brain 自动派发。

## 修复方案

在所有 INSERT INTO tasks 的位置加上 trigger_source 字段：

| trigger_source | 含义 | 创建位置 |
|---------------|------|---------|
| `brain_auto` | Brain 自动拆解/派发 | planner.js, feature-tick.js, nightly-tick.js, tick.js, actions.js(默认) |
| `user_headed` | 用户前台操作 | routes.js intent-to-tasks |
| `proposal` | Proposal 系统 | proposal.js |

## 涉及文件

- `brain/src/actions.js` — createTask() 加 trigger_source 参数
- `brain/src/planner.js` — 传 brain_auto
- `brain/src/feature-tick.js` — 传 brain_auto
- `brain/src/nightly-tick.js` — 传 brain_auto
- `brain/src/tick.js` — 传 brain_auto
- `brain/src/proposal.js` — 传 proposal
- `brain/src/intent.js` — 传 user_headed
- `brain/migrations/011_trigger_source_values.sql` — 更新现有 auto → brain_auto

## 成功标准

1. 新建 task 带正确的 trigger_source
2. 现有 auto 数据迁移为 brain_auto
3. Brain 测试不回归 + DevGate 全绿
