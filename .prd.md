# PRD: Cecelia Brain 架构统一大修复

## 问题背景

通过 team agents 全面审查发现，Cecelia Brain 存在多个严重的架构不一致问题：

### P0 - Critical 问题
1. **type='objective' 迁移不完整** - Migration 029 改用 global_okr/area_okr，但至少 4 个文件未更新，导致功能失效
2. **exploratory task_type 不在 DB 约束中** - 代码使用但 DB 会拒绝插入

### P1 - 重要功能缺失
3. **Exploratory → Dev 流程缺失** - Initiative 应该先探索再开发，但完全没实现
4. **recurring_tasks 从未实现** - Migration 003 就创建了表，但 3 年来从未使用过
5. **时间维度定义混乱** - Initiative 在不同文档中是 1-2小时/1-2天/1-3小时
6. **~1,100 行死代码** - alertness-decision.js, recovery.js, config-loader.js 等从未使用
7. **双 Alertness 系统冲突** - 旧 4 级系统和新 5 级系统并存，可能矛盾
8. **/okr Skill 缺少层级识别** - 无法判断用户说的是 Global OKR 还是 Initiative

## 解决方案

### 1. 统一时间维度（最终确认）
- Global OKR: 3个月（季度）
- Area OKR: 1个月（月度）
- Project: 1-2周
- **Initiative: 1-2小时**
- Task: 20分钟

### 2. 修复 type='objective' 全局不一致
- focus.js, decision-executor.js, similarity.js, query-okr-status.mjs
- 统一使用 Migration 029 的类型

### 3. 实现 Exploratory → Dev 流程
- Migration 032: tasks 表新增 phase 字段（exploratory/dev）
- planner.js: 优先调度 exploratory 任务
- routes.js: exploratory 完成后自动创建 dev 任务

### 4. 实现 recurring_tasks 完整功能
- 纯 JS cron 引擎（无新依赖）
- tick.js 每次 tick 检查
- Migration 032: 增强 recurring_tasks 表（goal_id, project_id, worker_type 等）

### 5. 增强 /okr Skill
- 6 层层级识别（Global OKR → Area OKR → KR → Project → Initiative → Task）
- 时间维度检测表
- Exploratory 优先策略
- Auto-Link to Parent

### 6. 删除死代码和孤儿表
- 删除 3 个文件：alertness-decision.js, recovery.js, config-loader.js
- Migration 033: 删除 4 张孤儿表
- 删除重复 routes 和旧别名

### 7. 统一 Alertness 系统
- 删除旧 alertness.js
- 统一到新 5 级系统（SLEEPING/CALM/AWARE/ALERT/PANIC）
- 迁移所有使用者

## 成功标准

- 所有测试通过（138+ 个）
- facts-check 一致（8/8）
- version-sync 同步
- DEFINITION.md 更新
- Schema version → 033

## 影响范围

- Brain 核心代码：~20 个文件
- Migrations: 2 个新 migration（032, 033）
- Skills: /okr 重写
- 测试：新增 25 个，删除 3 个旧测试
- 文档：DEFINITION.md, MEMORY.md 更新
