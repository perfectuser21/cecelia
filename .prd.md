---
id: prd-decomp-quality-governance
version: 1.0.0
created: 2026-02-22
updated: 2026-02-22
changelog:
  - 1.0.0: 初始版本
---

# PRD: OKR 拆解质量治理 (v1.59.0)

## 背景

当前 OKR 拆解体系存在严重的系统性问题：
- 拆解无终点：拆解任务执行后产出更多拆解任务，形成无限递归
- 任务描述质量差：任务缺少具体的验收标准，执行时不知道做什么
- completed 无 PR：15 个已完成任务中 0 个有 PR，没有代码落地
- KR 进度不更新：所有 KR progress 为 0，无法衡量进展
- 过度拆解积压：234 pending projects + 368 pending initiatives

## 需要解决的问题

### P0-1: 拆解深度限制

**现象**：秋米拆出 Initiative → 拆解任务执行 → 又拆出 Initiative → 无限循环
**方案**：
1. projects 表新增 `decomposition_depth` 字段（integer, default 0）
2. Project depth=0, Initiative depth=1, sub-Initiative depth=2
3. decomposition-checker.js：depth >= 2 的 initiative 禁止再拆出子 initiative，只能产出 dev task
4. 拆解任务创建时自动计算 depth = parent.depth + 1

### P0-2: 任务描述质量门控

**现象**：拆解产出的 task description 模糊，执行时不知道改什么文件
**方案**：
1. 新增 `brain/src/task-quality-gate.js`：验证 task description 质量
2. 最低要求：description >= 100 字符，包含"文件"或"修改"或"实现"等关键词
3. decomposition-checker.js 创建 task 时调用质量门控
4. 不合格的标记 `quality_rejected: true` 在 metadata 中，不入队

### P1-1: Dev Task 完成必须有 PR

**现象**：15 个 completed 任务中 0 个有 PR
**方案**：
1. routes.js execution-callback：dev task completed 但 payload 无 pr_url → 不改为 completed，改为 `completed_no_pr`
2. 新增 task status `completed_no_pr`（语义：做完了但没有代码产出，需要人工审查）
3. 保留 completed 状态只给真正有 PR 的 dev task 和非 dev task（exploratory/decomposition）

### P1-2: KR 进度自动更新

**现象**：所有 KR progress 为 0
**方案**：
1. 新增 `brain/src/kr-progress.js`：计算 KR 进度
2. 进度公式：completed_initiatives / total_initiatives * 100（只算 active + completed，不算 pending）
3. initiative-closer.js 关闭 initiative 后自动调用更新
4. tick.js 每小时同步一次 KR 进度

### P2: 积压清理

**方案**：
1. migration 049：将 pending projects/initiatives 中无任何子实体的标记为 archived
2. 保留有 active children 或 in_progress tasks 的
3. 事件记录

## 技术设计

### 新增文件
- `brain/src/task-quality-gate.js` - 任务质量门控
- `brain/src/kr-progress.js` - KR 进度计算
- `brain/migrations/049_decomp_quality_governance.sql` - Schema + 清理

### 修改文件
- `brain/src/decomposition-checker.js` - 拆解深度限制 + 质量门控集成
- `brain/src/initiative-closer.js` - 关闭后触发 KR 进度更新
- `brain/src/routes.js` - execution-callback PR 检查
- `brain/src/tick.js` - KR 进度定时同步
- `brain/src/selfcheck.js` - schema version 048 → 049

## 涉及文件

新建：
- brain/src/task-quality-gate.js
- brain/src/kr-progress.js
- brain/migrations/049_decomp_quality_governance.sql

修改：
- brain/src/decomposition-checker.js
- brain/src/initiative-closer.js
- brain/src/routes.js
- brain/src/tick.js
- brain/src/selfcheck.js

## 成功标准

1. depth >= 2 的 initiative 不再产出子 initiative
2. 描述少于 100 字符的 task 被 reject
3. dev task completed 无 PR 时标记为 completed_no_pr
4. initiative 关闭后自动更新 KR progress
5. migration 清理积压的 pending 实体
6. 全部现有测试通过 + 新测试覆盖

## 非目标

- 不修改秋米 skill 本身（那是 skill 层面的问题）
- 不做 billing cap 优化（用户用 MiniMax 解决）
- 不做前端界面（Core 职责）
