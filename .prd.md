---
id: prd-facts-check-cleanup
version: 1.0.0
created: 2026-02-06
updated: 2026-02-06
changelog:
  - 1.0.0: 初始版本
---

# PRD: Facts 一致性检查 + 代码清理

## 需求来源

多轮 subagent 扫描发现：
1. DEFINITION.md 里的数字（action 数量、tick 间隔）与代码不一致
2. 11 处生产代码仍引用已废弃的 `automation` 任务类型（早已改为 `talk`）
3. 测试文件中有 6 处旧路径 `/home/xx/dev/` 应为 `/home/xx/perfect21/`
4. 没有自动化手段防止文档与代码漂移

核心原则：**能自动校验的，不允许靠自觉。**

## 功能描述

### A. Facts 一致性检查脚本

**新建 `scripts/facts-check.mjs`**

从代码源文件自动提取关键事实，与 DEFINITION.md 对照，报告不一致：

| 事实 | 代码来源 | DEFINITION.md 位置 |
|------|----------|-------------------|
| Brain 端口 | server.js `PORT` | 端口声明 |
| 版本号 | package.json `version` | 版本声明 |
| Tick 循环间隔 | tick.js `TICK_LOOP_INTERVAL_MS` | Tick 描述 |
| Tick 执行间隔 | tick.js `TICK_INTERVAL_MINUTES` | Tick 描述 |
| 任务类型列表 | task-router.js `getValidTaskTypes()` | 任务类型表 |
| Action 白名单数 | thalamus.js `ACTION_WHITELIST` | L1 描述 |
| Cortex action 数 | cortex.js actions | L2 描述 |
| Schema 版本 | selfcheck.js `EXPECTED_SCHEMA_VERSION` | Schema 描述 |

**输出格式**：
```
✓ brain_port: 5221 (server.js:17)
✓ version: 1.9.3 (package.json:3)
✗ action_count: code=16 (thalamus.js:45) ≠ doc="17个" (DEFINITION.md:302)
```

退出码：0 = 全部一致，1 = 有不一致

### B. CI 集成

在 `.github/workflows/ci.yml` 增加 `Facts Consistency` job：
- 运行 `node scripts/facts-check.mjs`
- 非零退出码 → CI 失败

### C. 代码清理：automation → talk

11 处生产代码 + 4 处测试代码中的 `automation` 引用改为 `talk`：

**生产代码**（6 文件）：
- `tick.js:37` — TASK_TYPE_AGENT_MAP 键
- `executor.js:478,836` — 注释
- `routes.js:1934,3501` — HK 路由列表 + 帮助文本
- `task-router.js:89` — JSDoc 注释
- `minimax-executor.js:4,140,231` — 模块注释 + skill map + switch case
- `okr-tick.js:110` — 注释
- `actions.js:17` — JSDoc 注释

**测试代码**（1 文件）：
- `tick.test.js:15-57` — automation 测试用例改为 talk

### D. 测试路径清理

6 处 `/home/xx/dev/` → `/home/xx/perfect21/`：
- `executor.js:32` — WORK_DIR 默认值
- `templates.test.js:469,479,938,947`
- `planner.test.js:287`
- `execution-status.test.js:150,181,182`

## 影响范围

**新增文件**（1 个）：
- `scripts/facts-check.mjs` — 一致性检查脚本

**修改生产代码**（7 个文件）：
- `brain/src/tick.js` — TASK_TYPE_AGENT_MAP 键 automation→talk
- `brain/src/executor.js` — WORK_DIR 默认路径 + 注释清理
- `brain/src/routes.js` — HK 路由列表 + 帮助文本
- `brain/src/task-router.js` — JSDoc 注释
- `brain/src/minimax-executor.js` — 模块注释 + skill map + switch case
- `brain/src/okr-tick.js` — 注释
- `brain/src/actions.js` — JSDoc 注释

**修改测试代码**（4 个文件）：
- `brain/src/__tests__/tick.test.js` — automation 测试改为 talk
- `brain/src/__tests__/templates.test.js` — 路径修正
- `brain/src/__tests__/planner.test.js` — 路径修正
- `brain/src/__tests__/execution-status.test.js` — 路径修正

**修改 CI 配置**（1 个文件）：
- `.github/workflows/ci.yml` — 新增 Facts Consistency job

## 不做的事

- 不做文档自动生成/覆写（DEFINITION.md 由人维护，脚本只检查）
- 不做 FACTS.yaml 清单（直接从代码提取，不增加维护负担）
- 不改 CLAUDE.md/MEMORY.md（不在 CI 管辖范围）
- 不改任何业务逻辑

## 成功标准

1. `node scripts/facts-check.mjs` 退出码 0，每行输出 `✓ fact_name: value (source:line)`
2. `.github/workflows/ci.yml` 包含 `Facts Consistency` job，运行 `node scripts/facts-check.mjs`
3. `grep -r "automation" brain/src/ --include="*.js"` 零结果（代码+注释全清）
4. `grep -r "/home/xx/dev/" brain/src/ --include="*.js"` 零结果
5. `cd brain && npx vitest run` 通过数不低于当前基线 668/673（5 个 DouyinAdapter 失败为预存）
