# PRD: 修复 Alertness 系统混用导致的 Dispatch Rate Limiting 失效

## 问题描述

Brain 存在**两个 Alertness 系统并存**的架构问题，导致 dispatch rate limiting 机制失效。

### 当前架构

1. **Old System** (`brain/src/alertness.js`)
   - 使用 token bucket 机制
   - 4 个级别：NORMAL=0, ALERT=1, EMERGENCY=2, COMA=3
   - Token refillRate 依赖于当前级别

2. **Enhanced System** (`brain/src/alertness/index.js`)
   - 使用百分比速率控制
   - 5 个级别：SLEEPING=0, CALM=1, AWARE=2, ALERT=3, PANIC=4
   - Dispatch rate 为 0%-100% 的百分比

### 架构混乱

**tick.js 混用两个系统**：

```javascript
// 使用 Enhanced System 判断是否可以 dispatch
if (!canDispatchEnhanced()) { ... }
const dispatchRate = getDispatchRateEnhanced();  // 获取百分比速率

// 但 dispatchNextTask() 内部使用 Old System 的 token bucket
const tokenResult = tryConsumeToken('dispatch');  // Old System!
if (!tokenResult.allowed) {
  return { reason: 'rate_limited' };
}
```

### 问题影响

- PR #268 修复了 Old System 的 token bucket 配置（refillRate=15）
- 但由于两个系统不同步：
  - Enhanced System: CALM (100% dispatch rate)
  - Old System: 可能仍在 ALERT (refillRate=8/min < 12/min)
- 导致即使 Enhanced System 允许 dispatch，Old System 的 token bucket 仍然 rate_limited

### 症状

手动触发 Tick 时，间歇性返回 `rate_limited`：
```json
{
  "dispatch": {
    "reason": "rate_limited",
    "detail": "rate_limited"
  }
}
```

## 解决方案

### 最小改动方案（推荐）

**移除 dispatchNextTask() 中的 Old System token bucket 检查**。

**文件**：`brain/src/tick.js`

**位置**：第 586-596 行

**移除代码**：
```javascript
// 2a. P1 FIX: Token bucket rate limiting check
const tokenResult = tryConsumeToken('dispatch');
if (!tokenResult.allowed) {
  return {
    dispatched: false,
    reason: 'rate_limited',
    detail: tokenResult.reason,
    remaining: tokenResult.remaining,
    actions
  };
}
```

**理由**：
1. tick.js 已经在使用 Enhanced System 的 dispatch rate 控制（第 1206-1210 行）
2. Old System 的 token bucket 检查是多余的，且与 Enhanced System 冲突
3. Enhanced System 的百分比速率 + slot budget 已经足够控制 dispatch 频率

### 影响范围

- **修改文件**：`brain/src/tick.js`（1 个文件）
- **删除行数**：11 行
- **影响功能**：dispatch rate limiting（改为完全依赖 Enhanced System）
- **测试**：现有 tick 测试应该通过

## 验收标准

### 功能验收

- [ ] 移除 Old System token bucket 检查后，手动 Tick 不再返回 `rate_limited`（当 Enhanced System 允许 dispatch 时）
- [ ] Enhanced System 的 dispatch rate 仍然生效：
  - CALM (level=1) → 100% dispatch rate → 可以 dispatch
  - AWARE (level=2) → 70% dispatch rate → 可以 dispatch，但有限制
  - ALERT (level=3) → 30% dispatch rate → dispatch 受限
  - PANIC (level=4) → 0% dispatch rate → 完全禁止 dispatch
- [ ] 连续 5 次手动 Tick，在 CALM 状态下应全部返回 `no_dispatchable_task`（不是 `rate_limited`）

### 测试验收

- [ ] `brain/src/__tests__/tick.test.js` 全部通过
- [ ] `brain/src/__tests__/alertness.test.js` 全部通过
- [ ] 本地运行 `npm test` 全部通过

### CI 验收

- [ ] Version Check 通过
- [ ] Facts Consistency 通过
- [ ] Brain (Node.js) 测试通过
- [ ] Semantic Brain (Python) 通过

## 优先级

**P0 - Critical**

原因：
- 影响 Brain 核心功能（task dispatch）
- 导致 PR #268 的修复无效
- 阻塞 Brain 正常运行

## 风险评估

### 低风险

- 只删除代码，不添加新逻辑
- Enhanced System 已经在生产环境运行
- Old System 的 token bucket 在这里是多余的保护

### 回滚方案

如果出现问题，可以：
1. Revert 这个 commit
2. 或手动重新添加 token bucket 检查

## 相关上下文

- **PR #268**：修复 Old System token bucket 配置（refillRate=15）
- **Migration 029**：引入 Enhanced Alertness System
- **Issue**：两个系统并存但不同步
