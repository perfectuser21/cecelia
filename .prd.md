---
id: prd-devgate-unify
version: 1.0.0
created: 2026-02-06
updated: 2026-02-06
changelog:
  - 1.0.0: 初始版本
---

# PRD: DevGate 统一 + CORE_DEV_PROMPT 落地

## 需求来源

Engine 仓库已有完整的 DevGate 体系（version-sync、dod-mapping、impact-check、evidence-gate），
Core 仓库只有 `facts-check.mjs`。用户要求全局统一 DevGate 模式，补齐 Core 缺失的 2 个脚本，
并将 CORE_DEV_PROMPT 作为项目级指令落地。

核心原则：**两个仓库用同一套 DevGate 模式，脚本按仓库适配。**

## 功能描述

### A. `scripts/check-version-sync.sh`

从 Engine 的 `ci/scripts/check-version-sync.sh` 适配，检查 Core 的版本文件同步：

| 文件 | 角色 |
|------|------|
| `brain/package.json` | 基准版本（SSOT） |
| `brain/package-lock.json` | npm lock |
| `.brain-versions` | 部署版本记录 |
| `DEFINITION.md` 中 `Brain 版本: X.Y.Z` | 文档版本声明 |

不一致 → 退出码 1 + 修复指引。

### B. `scripts/devgate/check-dod-mapping.cjs`

从 Engine 简化适配（Core 没有 regression-contract / evidence 系统）：

- 读取 `.dod.md`，解析验收清单表格
- 每行必须有 `Test 映射` 列且不为空
- 支持：`vitest 文件路径` / `grep 验证` / `node 脚本` / `手动验证`
- 缺失映射 → 退出码 1

### C. CI 集成

在 `.github/workflows/ci.yml` 的 `facts-check` job 中追加两个 step：
- `Check version sync`: `bash scripts/check-version-sync.sh`
- `Check DoD mapping`: `node scripts/devgate/check-dod-mapping.cjs`

### D. `.brain-versions` 同步

当前 `.brain-versions` 内容是 `1.9.1`，实际版本 `1.9.4`。修正。

### E. CORE_DEV_PROMPT 落地

将用户提供的 CORE_DEV_PROMPT 保存到 `.claude/CLAUDE.md`（项目级指令），
让后续 Claude Code 会话自动加载。

## 影响范围

**新增文件**（3 个）：
- `scripts/check-version-sync.sh`
- `scripts/devgate/check-dod-mapping.cjs`
- `.claude/CLAUDE.md`

**修改文件**（2 个）：
- `.github/workflows/ci.yml` — facts-check job 追加 2 个 step
- `.brain-versions` — 版本修正

## 不做的事

- 不搬 Engine 的 impact-check / evidence-gate（Core 没有 feature-registry）
- 不改 facts-check.mjs（已经工作正常）
- 不改业务代码

## 成功标准

1. `bash scripts/check-version-sync.sh` 退出码 0（所有版本同步）
2. `node scripts/devgate/check-dod-mapping.cjs` 退出码 0（当前 DoD 有映射）
3. `node scripts/facts-check.mjs` 退出码 0（仍然全绿）
4. `.claude/CLAUDE.md` 包含 CORE_DEV_PROMPT 全部 6 节内容
5. CI 通过
6. `cd brain && npx vitest run` 无回归（>= 668 pass）
