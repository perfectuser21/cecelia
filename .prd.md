# PRD: 免疫系统完整连接

## 功能描述

连接 Cecelia Brain 所有免疫系统组件，让以下功能真正运转起来：

1. **Feature Tick 自动运行** - 启动 Feature 状态机循环，让 Feature 自动推进状态
2. **策略调整效果监控** - 追踪策略调整后的任务成功率变化，评估调整是否有效
3. **Quality feedback 反馈循环** - 基于用户反馈和重现率更新 RCA 质量评分

## Background

深度搜索发现大部分免疫系统组件已经完整实现，但存在 3 个关键断链：

1. **Feature Tick 未启动** - `feature-tick.js` 有完整状态机，但 `startFeatureTick()` 没被调用
2. **策略调整无效果评估** - `applyStrategyAdjustments()` 应用了策略，但没监控是否有效
3. **Quality effectiveness 固定为 0** - 质量评分的 effectiveness 维度缺少反馈更新机制

## Goals

1. 启动 Feature Tick 循环，让 Feature 状态自动推进（15分钟工作量）
2. 实现策略调整效果追踪系统（1个 PR 工作量）
3. 实现 Quality 反馈循环（1个 PR 工作量）

## Features

### 1. Feature Tick 启动

**文件**: `brain/src/server.js`

```javascript
// 在 server.listen() 后添加
import { startFeatureTick } from './feature-tick.js';
startFeatureTick();
console.log('[Server] Feature Tick started (30s interval)');
```

### 2. 策略调整效果监控

**新表**: `strategy_effectiveness`

```sql
CREATE TABLE IF NOT EXISTS strategy_effectiveness (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  adoption_id UUID REFERENCES strategy_adoptions(id) ON DELETE CASCADE,
  strategy_key TEXT NOT NULL,
  baseline_success_rate NUMERIC(5,2),  -- 调整前成功率
  post_adjustment_success_rate NUMERIC(5,2),  -- 调整后成功率
  sample_size INTEGER,  -- 样本数
  evaluation_period_days INTEGER DEFAULT 7,
  is_effective BOOLEAN,  -- 是否有效（成功率提升 >5%）
  evaluated_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**新函数**: `learning.js`

```javascript
/**
 * 评估策略调整效果
 * @param {string} strategyKey - 策略键（如 'retry.max_attempts'）
 * @param {number} days - 评估天数
 */
export async function evaluateStrategyEffectiveness(strategyKey, days = 7) {
  // 1. 找到策略调整时间
  // 2. 计算调整前后任务成功率
  // 3. 判断是否有效（提升 >5%）
  // 4. 保存到 strategy_effectiveness 表
}
```

### 3. Quality Feedback 循环

**新列**: `cortex_analyses` 表

```sql
ALTER TABLE cortex_analyses ADD COLUMN user_feedback INTEGER;  -- 1-5 星评分
ALTER TABLE cortex_analyses ADD COLUMN reoccurrence_count INTEGER DEFAULT 0;  -- 重现次数
ALTER TABLE cortex_analyses ADD COLUMN last_reoccurrence_at TIMESTAMPTZ;
```

**新函数**: `cortex-quality.js`

```javascript
/**
 * 记录用户反馈
 * @param {string} analysisId - 分析 ID
 * @param {number} rating - 1-5 星评分
 * @param {string} comment - 可选评论
 */
export async function recordQualityFeedback(analysisId, rating, comment = null) {
  // 更新 user_feedback 字段
  // 触发 effectiveness 重新计算
}

/**
 * 更新 effectiveness 分数（基于反馈和重现率）
 * @param {string} analysisId
 */
export async function updateEffectivenessScore(analysisId) {
  // effectiveness = (user_feedback * 8) + (reoccurrence_penalty)
  // 5星 = 40分，4星 = 32分，3星 = 24分，2星 = 16分，1星 = 8分
  // reoccurrence_penalty: 重现1次 -5分，2次 -10分，3次+ -20分
}
```

**新端点**: `routes.js`

```javascript
// POST /api/brain/cortex/feedback
router.post('/cortex/feedback', async (req, res) => {
  const { analysis_id, rating, comment } = req.body;
  await recordQualityFeedback(analysis_id, rating, comment);
  await updateEffectivenessScore(analysis_id);
  res.json({ success: true });
});

// POST /api/brain/learning/evaluate-strategy
router.post('/learning/evaluate-strategy', async (req, res) => {
  const { strategy_key, days = 7 } = req.body;
  const result = await evaluateStrategyEffectiveness(strategy_key, days);
  res.json({ success: true, ...result });
});
```

## Implementation Plan

1. **Migration 016**: `strategy_effectiveness` 表 + `cortex_analyses` 新列
2. **server.js**: 启动 Feature Tick
3. **learning.js**: `evaluateStrategyEffectiveness()` 函数
4. **cortex-quality.js**: `recordQualityFeedback()` + `updateEffectivenessScore()` 函数
5. **routes.js**: 2 个新端点
6. **Tests**: 测试 Feature Tick 启动、策略效果评估、质量反馈循环
7. **Version bump**: 1.21.0 → 1.22.0

## 成功标准

1. Feature Tick 每 30 秒自动执行（通过日志或 `/api/brain/features` 验证）
2. 策略调整后，系统自动评估效果并记录到数据库
3. 提供 `/cortex/feedback` API，可接收 1-5 星评分
4. effectiveness_score 基于反馈和重现率自动更新
5. 所有新增功能有测试覆盖
6. 版本号在 package.json, .brain-versions, DEFINITION.md 中同步
