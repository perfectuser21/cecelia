---
id: prd-dual-capacity-model
version: 1.0.0
created: 2026-02-22
updated: 2026-02-22
changelog:
  - 1.0.0: 初始版本
---

# PRD: 双层容量模型 — 真实 CPU% + 物理/预算分离

## 功能描述

Brain executor 当前使用 `os.loadavg()` 判断 CPU 压力，但 Claude 进程大部分时间等待 API I/O，虚增 load average（实际 CPU 33% 时 load average 显示 7.71 → 压力 1.17 → 硬停）。需要改用 `/proc/stat` 真实 CPU% 替代 load average，并将物理容量（硬件天花板）与预算帽（API 花销控制）分离。

### 核心功能

1. **CPU 采样器**：从 `/proc/stat` delta 采样真实 CPU%，替代 load average
2. **双层容量**：Layer 1 物理容量（CPU+内存硬件天花板）+ Layer 2 预算帽（用户可控 API 花销限制）
3. **Effective = min(Physical, Budget)**：生效容量取两者较小值
4. **运行时 API**：PUT /api/brain/budget-cap 端点动态调整预算帽
5. **Slot Allocator 联动**：三池分配使用动态容量

### FALLBACK 策略

非 Linux 系统（无 /proc/stat）时 cpuPressure=0（不做 CPU 节流），仅依赖内存和 swap 压力。

## 成功标准

- CPU 33% 时不再误停派发（旧 load average 7.71 会触发硬停，真实 CPU% 33 不会）
- 用户可通过 API 设置预算帽，独立于物理容量
- GET /api/brain/slots 返回 physical/budget/effective 三层数据

## 技术方案

- executor.js: sampleCpuUsage + checkServerResources 使用真实 CPU% + 双层容量常量和函数
- slot-allocator.js: 使用 getEffectiveMaxSeats() 动态容量
- routes.js: PUT /api/brain/budget-cap 端点
