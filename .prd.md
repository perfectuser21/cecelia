# PRD: Brain 状态可视化系统

## 📋 基本信息

- **产品名称**: Brain Status Dashboard
- **版本**: 1.0.0
- **优先级**: P0
- **类型**: Feature (新功能)
- **负责人**: Brain 团队
- **创建时间**: 2026-02-07
- **目标上线**: 2026-02-08

---

## 🎯 背景与目标

### 问题描述

Cecelia Brain 已正式上线自主运行，但当前缺少直观的状态可视化：
- ❌ 无法快速了解 Brain 健康状态
- ❌ 无法实时看到任务进度
- ❌ 无法追踪 OKR 执行情况
- ❌ 需要手动执行多个 API 命令才能获取完整状态

### 目标

**核心目标**: 让用户一眼看懂 Brain 在做什么、状态如何

**具体目标**:
1. 实时显示 Brain 核心状态（健康、警觉、资源）
2. 可视化当前聚焦的 OKR 和任务进度
3. 展示历史活动和趋势（今日/本周/本月）
4. 提供告警和异常通知
5. 支持多种访问方式（Web/CLI/API）

---

## 👥 用户故事

### 主要用户

1. **系统管理员**（你）
   - 需要快速检查 Brain 是否正常运行
   - 需要监控资源使用和性能指标
   - 需要及时发现和处理异常

2. **开发团队**
   - 需要了解当前开发任务进度
   - 需要查看 Brain 自主学习效果
   - 需要调试和优化系统

### 用户场景

**场景 1: 早晨检查**
```
用户: 早上起床，想知道 Brain 昨晚做了什么
操作: 打开 Dashboard / 运行 brain-status 命令
看到:
  - 昨晚执行了 47 次 tick
  - 完成了 3 个任务
  - 触发了 1 次 RCA，自动调整了重试参数
  - 当前聚焦在 "Brain 自我进化" 目标
```

**场景 2: 异常告警**
```
用户: 收到飞书通知 "Brain 警觉等级升至 EMERGENCY"
操作: 打开 Dashboard 查看详情
看到:
  - 资源压力 0.85，CPU 负载高
  - 3 个任务连续失败
  - 熔断器已打开 cecelia-run 服务
  - 建议操作: 检查 cecelia-run 服务状态
```

**场景 3: 进度追踪**
```
用户: 想知道 OKR 进度
操作: 查看 Dashboard OKR 面板
看到:
  - 当前 Objective: "Brain 自我进化" (P0, 进度 15%)
  - KR4: "Alertness 信号通路完善" (in_progress, 4/10 任务完成)
  - 预计完成时间: 2026-02-10
```

---

## 📐 功能需求

### 1. 核心状态面板（P0）

**显示内容**:
```
┌─────────────────────────────────────────────────────────────┐
│ Cecelia Brain 状态                    [刷新] [设置]          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🟢 健康状态: Healthy                                        │
│  ⏰ 北京时间: 2026-02-07 22:15:30                           │
│  🔄 上次 Tick: 2 分钟前 (22:13:46)                          │
│  ⏭️  下次 Tick: 3 分钟后 (22:18:46)                          │
│  📊 今日活动: 8,352 次                                      │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│ 三大器官                                                     │
│                                                             │
│  🧠 L0 脑干 (调度器)                                         │
│     状态: ✅ Running                                         │
│     并发: 4 / 12 (有效槽位: 8)                              │
│                                                             │
│  🧠 L1 丘脑 (快速决策)                                       │
│     状态: ✅ Active                                          │
│     今日决策: 127 次                                         │
│                                                             │
│  🧠 L2 皮层 (深度分析)                                       │
│     状态: ✅ Standby                                         │
│     RCA 触发: 1 次 (本周)                                    │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│ 保护系统                                                     │
│                                                             │
│  🚦 警觉等级: NORMAL (0/3)                                  │
│     行为: 正常运行，全速派发                                 │
│     信号: CPU 0.41 | Mem 0.32 | API Errors 0                │
│                                                             │
│  🔌 熔断器: All Closed                                      │
│     cecelia-run: ✅ CLOSED (0 failures)                     │
│                                                             │
│  🔒 隔离区: 0 任务                                          │
│                                                             │
│  👁️ 看门狗: Active                                          │
│     RSS 阈值: 1800 / 2400 MB                                │
│     CPU 阈值: 95% 持续 6 ticks                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**数据来源**:
- `/api/brain/health`
- `/api/brain/tick/status`
- `/api/brain/alertness`
- `/api/brain/watchdog`

**刷新频率**: 5 秒自动刷新

---

### 2. OKR 进度面板（P0）

**显示内容**:
```
┌─────────────────────────────────────────────────────────────┐
│ 当前聚焦 (每日焦点)                                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🎯 Objective (P0)                                          │
│  "Cecelia Brain 自我进化 — 完成免疫系统 + 高阶能力"           │
│                                                             │
│  进度: ████░░░░░░░ 15% (2/12 KR 完成)                       │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Key Results (12 个)                                  │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │                                                     │   │
│  │ ✅ KR1: 免疫系统链路修复                    100% ✓  │   │
│  │ ✅ KR2: Cortex 皮层完成                     100% ✓  │   │
│  │ 🚧 KR3: Planner 自动生成                    40% →  │   │
│  │ 🚧 KR4: Alertness 信号通路完善 (当前聚焦)    60% →  │   │
│  │    └─ 任务: 6/10 完成                              │   │
│  │ ⏸️  KR5: ...                                  0%    │   │
│  │ ⏸️  KR6: ...                                  0%    │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  📌 选择原因: 手动设置的焦点                                 │
│  🎲 轮转评分: 每 5 分钟自动评估                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**交互功能**:
- 点击 KR 展开查看关联任务
- 点击任务查看详细信息
- 手动切换聚焦 Objective

**数据来源**: `/api/brain/focus`

---

### 3. 任务队列面板（P0）

**显示内容**:
```
┌─────────────────────────────────────────────────────────────┐
│ 任务队列                              [按状态] [按优先级]    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  统计:                                                      │
│  ⏳ Queued: 1        🚧 In Progress: 4      ✅ Completed: 23 │
│  ❌ Failed: 0        🔒 Quarantined: 0                      │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ In Progress (4)                                     │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │                                                     │   │
│  │ [P0] 🚧 Implement health signal collection          │   │
│  │      开始: 14:43  已执行: 7h 32m                    │   │
│  │      Run ID: run-a501d823                           │   │
│  │                                                     │   │
│  │ [P0] 🚧 Build self-diagnosis capabilities           │   │
│  │      开始: 14:44  已执行: 7h 31m                    │   │
│  │                                                     │   │
│  │ [P1] 🚧 Create health visualization dashboard       │   │
│  │      开始: 14:45  已执行: 7h 30m                    │   │
│  │                                                     │   │
│  │ [P1] 🚧 Implement chaos engineering                 │   │
│  │      开始: 14:46  已执行: 7h 29m                    │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Queued (1)                                          │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │                                                     │   │
│  │ [P1] ⏳ Alertness RCA - System Health Degradation   │   │
│  │      排队: 5h 17m                                   │   │
│  │      原因: 资源满载，等待空闲槽位                     │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**交互功能**:
- 点击任务查看日志
- 手动暂停/恢复任务
- 手动调整优先级
- 查看任务执行历史

**数据来源**:
- `/api/brain/tasks?status=queued`
- `/api/brain/tasks?status=in_progress`

---

### 4. 学习记录面板（P1）

**显示内容**:
```
┌─────────────────────────────────────────────────────────────┐
│ 学习与优化                                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📚 Learnings (本周)                                        │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  │ 🧠 RCA Learning: 资源压力导致派发失败                │   │
│  │    时间: 2026-02-06 03:24                           │   │
│  │    根因: CPU 负载持续 > 0.8，触发限流                │   │
│  │    策略调整:                                         │   │
│  │      ✅ retry.max_attempts: 3 → 5 (已应用)          │   │
│  │      ✅ alertness.emergency_threshold: 0.7 → 0.75   │   │
│  │    效果: 7 天后评估                                  │   │
│  │                                                     │   │
│  │ 🧠 RCA Learning: API 限流导致任务失败                │   │
│  │    时间: 2026-02-05 14:52                           │   │
│  │    根因: Anthropic API 触发 rate limit               │   │
│  │    策略调整:                                         │   │
│  │      ✅ retry.base_delay_minutes: 1 → 3 (已应用)    │   │
│  │    效果: ✅ 成功率提升 18% (有效)                    │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  📊 策略调整统计                                             │
│    本周应用: 3 次                                           │
│    有效策略: 2 / 3 (67%)                                    │
│    平均提升: +15% 成功率                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**数据来源**:
- `/api/brain/learnings` (需要实现)
- `learnings` 表

---

### 5. 资源监控面板（P1）

**显示内容**:
```
┌─────────────────────────────────────────────────────────────┐
│ 资源与性能                                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🖥️  系统资源                                                │
│                                                             │
│  CPU 负载:   ████░░░░░░ 41%  (3.31 / 8 cores)              │
│  内存使用:   ████░░░░░░ 40%  (6.1Gi / 15Gi)                │
│  Swap:       ██░░░░░░░░ 21%                                 │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Brain 容器                                          │   │
│  │ CPU:    0.00%     内存: 21.86 MiB                   │   │
│  │ 状态:   Running   启动: 5 天前                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ PostgreSQL 容器                                     │   │
│  │ CPU:    0.02%     内存: 97.43 MiB                   │   │
│  │ 状态:   Running   连接数: 12                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  📈 性能指标                                                 │
│    Tick 平均延迟:    342 ms                                 │
│    任务派发成功率:   98.7%                                   │
│    数据库查询延迟:   12 ms (P95)                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**数据来源**:
- `/api/brain/watchdog`
- `docker stats`
- 系统 `/proc` 信息

---

### 6. 历史活动面板（P2）

**显示内容**:
- 今日 Tick 执行曲线图
- 任务完成趋势（7 天）
- 警觉等级变化历史
- RCA 触发频率

**数据来源**:
- `decision_log` 表
- `system_snapshot` 表

---

## 🎨 技术方案

### 方案 A: Web Dashboard（推荐）

**技术栈**:
- 前端: React + Ant Design / Tailwind CSS
- 实时更新: Server-Sent Events (SSE) 或 WebSocket
- 图表: ECharts / Chart.js
- 部署: 集成到现有 `frontend` 容器

**优点**:
- ✅ 可视化效果好
- ✅ 支持交互操作
- ✅ 可多人同时访问
- ✅ 可扩展性强

**缺点**:
- ⚠️ 开发成本较高
- ⚠️ 需要前端构建

**访问方式**: `http://localhost:5211/brain-status`

---

### 方案 B: CLI 命令（快速实现）

**技术栈**:
- Bash 脚本 + curl + jq
- 或 Node.js CLI 工具（blessed / ink）

**优点**:
- ✅ 快速实现（1-2 小时）
- ✅ 无依赖，直接运行
- ✅ 适合命令行用户

**缺点**:
- ⚠️ 可视化效果有限
- ⚠️ 不支持复杂交互

**示例命令**:
```bash
# 安装
npm install -g @cecelia/brain-status

# 运行
brain-status           # 完整状态
brain-status --watch   # 实时刷新
brain-status --okr     # 只显示 OKR
brain-status --tasks   # 只显示任务
```

---

### 方案 C: 混合方案（推荐）

**Phase 1 (立即)**:
- 实现 CLI 工具（1-2 小时）
- 满足基本监控需求

**Phase 2 (本周)**:
- 实现 Web Dashboard
- 集成到现有前端

**Phase 3 (下周)**:
- 添加告警推送（飞书/邮件）
- 添加历史趋势分析

---

## 🧪 验收标准

### Phase 1: CLI 工具（P0）

**验收条件**:
- [ ] 运行 `brain-status` 显示核心状态（健康、Tick、警觉、资源）
- [ ] 运行 `brain-status --okr` 显示当前聚焦和 KR 进度
- [ ] 运行 `brain-status --tasks` 显示任务队列
- [ ] 运行 `brain-status --watch` 每 5 秒自动刷新
- [ ] 支持北京时间显示（不是 UTC）
- [ ] 彩色输出，状态用表情符号标识（🟢🟡🔴）
- [ ] 执行时间 < 1 秒

### Phase 2: Web Dashboard（P0）

**验收条件**:
- [ ] 访问 `localhost:5211/brain-status` 显示完整 Dashboard
- [ ] 自动刷新（5 秒间隔）
- [ ] 显示核心状态面板（健康、器官、保护系统）
- [ ] 显示 OKR 进度面板（当前聚焦、KR 列表、进度条）
- [ ] 显示任务队列面板（queued、in_progress、按优先级排序）
- [ ] 响应式设计，支持移动端访问
- [ ] 加载时间 < 2 秒

### Phase 3: 告警系统（P1）

**验收条件**:
- [ ] 警觉等级升至 ALERT 时推送飞书通知
- [ ] 任务连续失败 3 次推送告警
- [ ] 熔断器打开时推送告警
- [ ] 资源压力 > 0.9 推送预警
- [ ] 支持告警静默期（避免刷屏）

---

## 📅 开发计划

### Sprint 1: CLI 工具（1-2 天）

**Day 1**:
- [ ] 实现核心状态显示 (`brain-status`)
- [ ] 实现 OKR 显示 (`brain-status --okr`)
- [ ] 实现任务队列显示 (`brain-status --tasks`)

**Day 2**:
- [ ] 添加实时刷新 (`--watch`)
- [ ] 优化输出格式（对齐、彩色、表情）
- [ ] 编写使用文档
- [ ] 打包发布

### Sprint 2: Web Dashboard（3-5 天）

**Day 1-2**:
- [ ] 设计 UI/UX
- [ ] 实现核心状态面板

**Day 3-4**:
- [ ] 实现 OKR 进度面板
- [ ] 实现任务队列面板

**Day 5**:
- [ ] 实现自动刷新
- [ ] 测试和优化

### Sprint 3: 告警系统（2-3 天）

- [ ] 实现飞书 Webhook 集成
- [ ] 实现告警规则引擎
- [ ] 实现告警静默逻辑
- [ ] 测试和调优

---

## 🔗 相关资源

**API 文档**:
- Brain API: `http://localhost:5221/api/brain/*`
- 现有端点列表: `brain/src/routes.js`

**现有前端**:
- Cecelia Workspace: `http://localhost:5211`
- ZenithJoy Dashboard: `http://localhost:5212`

**参考设计**:
- Grafana Dashboard
- Kubernetes Dashboard
- Anthropic Console

---

## ✅ 立即开始

**优先实现 CLI 工具**（最快满足需求）

**下一步**:
1. 创建 `scripts/brain-status.sh` 脚本
2. 调用现有 Brain API 获取数据
3. 使用 `jq` 格式化输出
4. 添加彩色和表情符号
5. 测试验证

**预计时间**: 1-2 小时完成基础版本

---

## 📝 备注

- 所有时间显示使用北京时间（Asia/Shanghai）
- API 返回的 UTC 时间戳需要转换显示
- Dashboard 需要考虑多实例支持（US/HK）
- 告警推送需要避免刷屏（设置静默期）
