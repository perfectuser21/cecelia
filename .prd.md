# PRD: Fix decomposition-checker infinite loop bug

## 问题描述

decomposition-checker.js 导致拆解任务无限循环创建，造成：
- 902 个拆解任务被创建（实际只需 154 个）
- 845 个任务失败
- 大量 Token 消耗（每个任务都调用 Opus API）
- Brain 在昨晚停止运行，用户睡一觉起来发现什么都没干

## 根本原因

**去重查询逻辑不完整**：

```javascript
// brain/src/decomposition-checker.js:40-42
AND (
  status IN ('queued', 'in_progress')
  OR (status = 'completed' AND completed_at > NOW() - INTERVAL '24 hours')
)
```

**问题**：去重查询**没有包含 'failed' 状态**

**循环过程**：
```
创建拆解任务 → 派发 → Claude 进程卡住 → Watchdog kill → 标记 failed
  ↓
下个 tick（5分钟后）
  ↓
去重查询没找到（因为是 failed 状态）
  ↓
又创建相同的任务 → 又失败 → 无限循环
```

## 解决方案

在去重查询中添加 failed 任务的 24 小时窗口去重：

```javascript
AND (
  status IN ('queued', 'in_progress')
  OR (status = 'completed' AND completed_at > NOW() - INTERVAL '24 hours')
  OR (status = 'failed' AND created_at > NOW() - INTERVAL '24 hours')  // 新增
)
```

## 验收标准 (DoD)

1. ✅ **代码修复**：去重查询包含 failed 任务
2. ✅ **测试覆盖**：添加测试验证 failed 任务会被去重
3. ✅ **CI 通过**：所有测试通过
4. ✅ **版本号更新**：patch 版本（1.40.9 → 1.40.10）

## 影响范围

- **文件**：`brain/src/decomposition-checker.js`
- **风险**：低（只是添加一个去重条件）
- **回滚**：安全（可以直接 revert commit）

## 测试计划

1. **单元测试**：验证 hasExistingDecompositionTask() 对 failed 任务的去重
2. **集成测试**：创建 failed 拆解任务 → 运行 checker → 验证不会重复创建

## 上线计划

1. 修复代码
2. CI 通过
3. 合并到 develop
4. （可选）部署新版本 Brain，观察是否还有重复创建
