# PRD - Brain 学习闭环

## 需求来源

用户需求：实现 Brain 学习闭环 - 自动从失败中学习并调整策略

来自 `.prd-5-brain-organs.md` 问题 #4

## 功能描述

实现完整的学习闭环系统，让 Brain 能够：
1. 自动检测系统性失败模式
2. 触发 Cortex 深度分析
3. 生成策略调整建议
4. 自动应用策略参数
5. 记录学习经验供未来参考

## 当前状态

- ✅ 有 `docs/LEARNINGS.md` 手动记录
- ✅ Cortex RCA 分析功能已实现（PR #184）
- ❌ Brain 不会自动从失败中学习
- ❌ 没有"失败 → 分析 → 调整策略"的闭环

## 实现方案

### 1. 数据库 Schema

创建 `learnings` 表存储学习记录：

```sql
CREATE TABLE learnings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(255) NOT NULL,
  category VARCHAR(50),
  trigger_event VARCHAR(100),
  content TEXT,
  strategy_adjustments JSONB,
  applied BOOLEAN DEFAULT false,
  applied_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  metadata JSONB
);
```

### 2. 失败检测触发

在 `quarantine.js` 的 `handleTaskFailure()` 中检测系统性失败：
- 当检测到 systemic failure 时
- 创建带 `requires_cortex=true` 和 `requires_learning=true` 的任务
- Cortex 分析失败模式并生成策略调整

### 3. Cortex 分析增强

扩展 `cortex.js` 的 `performRCA()` 输出：
- 已有：root_cause, contributing_factors, mitigations
- 新增：strategy_adjustments (具体的参数调整建议)

### 4. 策略自动应用

创建 `brain/src/learning.js` 模块：
- `recordLearning(analysis)` - 保存学习记录到 learnings 表
- `applyStrategyAdjustments(adjustments)` - 应用策略到 brain_config
- `getRecentLearnings(category, limit)` - 查询最近学习

### 5. Brain Config 更新

通过 `brain_config` 表动态调整参数：
- Alertness 阈值
- Retry 策略
- Resource limits

## 涉及文件

**新建**：
- `brain/migrations/012_learnings_table.sql`
- `brain/src/learning.js`
- `brain/src/__tests__/learning.test.js`

**修改**：
- `brain/src/quarantine.js`
- `brain/src/cortex.js`
- `brain/src/tick.js`
- `brain/src/selfcheck.js`

## 成功标准

- [ ] 失败检测自动创建 learning 任务
- [ ] Cortex 分析输出 strategy_adjustments
- [ ] 策略自动应用到 brain_config
- [ ] Learning 记录保存到 learnings 表
- [ ] 所有现有测试通过
