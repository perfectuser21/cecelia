---
id: kr-auto-decomp
version: 1.0.0
created: 2026-02-07
updated: 2026-02-07
changelog:
  - 1.0.0: 初始版本
---

# Fix: Auto-create KR decomposition tasks on needs_planning

## 问题

Tick loop 的 planNextTask() 对 KR 返回 `needs_planning`，但之后什么都不做。
系统只对 Objective 没有 KR 的情况自动创建拆解任务（Step 6b），
但对 KR 没有 Task 的情况（Step 6 返回 needs_planning）没有自动创建任务。
导致 0 queued tasks，秋米永远不被触发。

## 修复方案

在 tick.js Step 6 的 `needs_planning` 分支中，新增 Step 6c：
自动创建 KR 拆解任务（decomposition='continue'），由 dispatcher 派给秋米执行。

### 去重逻辑

同一个 KR 不重复创建：
- 已有 queued/in_progress 的拆解任务 → 跳过
- 24 小时内已有 completed 的拆解任务 → 跳过

## 涉及文件

- `brain/src/tick.js` — 在 needs_planning 分支添加 6c 自动创建 KR 拆解任务
- `brain/src/__tests__/tick-kr-decomp.test.js` — 新增测试

## 成功标准

1. planNextTask 返回 needs_planning 时，自动创建 KR 拆解任务
2. 去重：不重复创建
3. 任务 payload 包含 `decomposition: 'continue'`, `kr_id`
4. trigger_source = 'brain_auto'
5. 测试通过，DevGate 全绿
