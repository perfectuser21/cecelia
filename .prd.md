# PRD - Memory API 与递进式搜索

**需求来源**: 测试验证通过（/tmp/test-progressive-search.mjs + test-unified-headless.mjs），实现 Memory 功能的 API 层和业务服务层

**功能描述**:
实现 Memory Service 和 HTTP API，提供递进式（summary → detail → related）历史记忆搜索功能。基于已有的 OpenAI embeddings + pgvector 向量搜索基础设施（migration 028），封装为业务 API。

**核心特性**:
1. **渐进式搜索**：三层递进（summary → detail → related）
   - Summary: 只返回 id, title, similarity
   - Detail: 返回完整信息（description, metadata, status）
   - Related: 基于当前任务搜索相关内容

2. **统一逻辑**：有头/无头模式使用同一套 API
   - API 只提供数据，不关心调用者模式
   - 决策逻辑在调用方（Skill）

**涉及文件**:
- `brain/src/services/memory-service.js` (新建) - Memory 业务服务
- `brain/src/routes/memory.js` (新建) - Memory HTTP API 路由
- `brain/src/server.js` (修改) - 挂载 /api/brain/memory/* 路由

**API 设计**:

### 1. POST /api/brain/memory/search
搜索相关历史（Summary 层）

Request:
```json
{
  "query": "用户登录验证",
  "topK": 5,
  "mode": "summary"
}
```

Response:
```json
{
  "matches": [
    {
      "id": "abc-123",
      "level": "task",
      "title": "feat(auth): cross-subdomain cookie auth",
      "similarity": 0.32,
      "preview": "用 cookie 替代 localStorage..."
    }
  ]
}
```

### 2. GET /api/brain/memory/detail/:id
查看完整详情（Detail 层）

Response:
```json
{
  "id": "abc-123",
  "level": "task",
  "title": "feat(auth): cross-subdomain cookie auth",
  "description": "完整描述...",
  "status": "completed",
  "metadata": {
    "repo": "cecelia-workspace",
    "pr_number": 6
  },
  "created_at": "2024-01-15"
}
```

### 3. POST /api/brain/memory/search-related
搜索相关任务（Related 层）

Request:
```json
{
  "base_id": "abc-123",
  "topK": 5,
  "exclude_self": true
}
```

Response: 同 /search 格式

**成功标准**:
1. ✅ Memory Service 正确封装 similarity.js 的 searchWithVectors()
2. ✅ 三个 API 端点都能正常工作
3. ✅ 返回数据格式符合设计
4. ✅ 测试覆盖：unit tests for service, integration tests for API
5. ✅ CI 通过（DevGate 检查 DoD 映射和 RCI 覆盖率）

**非目标**:
- ❌ 前端界面（属于 cecelia/workspace）
- ❌ Bash 脚本（memory-search.sh 等，留到 Phase 2）
- ❌ /okr Skill 集成（留到 Phase 2）
- ❌ 数据清理策略（optional，暂不实现）

**技术依赖**:
- ✅ migration 028 已运行（pgvector + embedding columns）
- ✅ embeddings 已回填（1017 条，backfill-embeddings.js）
- ✅ similarity.js 已有 searchWithVectors() 方法
- ✅ OpenAI API Key 已配置（~/.credentials/openai.env）

**实现要点**:
1. Memory Service 不重复造轮子，直接调用 similarity.js
2. API 路由使用标准 Express router 模式
3. 错误处理：OpenAI API 失败时降级到 Jaccard（已在 similarity.js 实现）
4. 测试：模拟 OpenAI API（mocked）+ 真实 PostgreSQL
