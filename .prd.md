# PRD: Immune System v1 - P2 (Cortex JSON + Validator)

**版本**: P2
**创建时间**: 2026-02-12
**状态**: 待开发

---

## 背景

P0 建立了免疫系统基础设施，P1 实现了自动晋升机制。但 Cortex 生成的 policy JSON 格式不统一，缺少验证：

1. **格式不一致** - Cortex 每次生成的 JSON 结构可能不同
2. **无验证保障** - 存储前不检查格式，可能存入无效策略
3. **难以解析** - `parsePolicyAction()` 需要容错各种格式
4. **信心缺失** - 不知道 Cortex 对策略的置信度

**P2 目标**：标准化 policy JSON 格式 + 验证机制。

---

## Policy JSON Schema

```json
{
  "action": "requeue",
  "params": { "delay_minutes": 30, "priority": "low" },
  "expected_outcome": "Task will retry after 30 min with lower priority",
  "confidence": 0.85,
  "reasoning": "Error pattern suggests transient failure"
}
```

**字段**：
- `action`: `requeue` | `skip` | `adjust_params` | `kill`
- `params`: 根据 action 不同
- `expected_outcome`: 预期效果（string）
- `confidence`: 0-1（number）
- `reasoning`: 推理过程（20-500 字符）

**Action Params**：
- `requeue`: `delay_minutes` (required), `priority` (optional: high/normal/low)
- `skip`: `reason` (optional)
- `adjust_params`: `adjustments` (required, object), `merge_strategy` (optional)
- `kill`: `reason` (required, string), `notify` (optional, boolean)

---

## 实现方案

### Phase 1: Validator Core

**文件**: `brain/src/policy-validator.js`

**导出函数**：
```javascript
export function validatePolicyJson(policyJson, options = {})
export function isValidAction(action)
export function getRequiredParams(action)
export const ALLOWED_ACTIONS
export const ACTION_PARAMS_SCHEMA
```

**验证规则**：
1. Schema: 必需字段存在（action, params, expected_outcome, confidence, reasoning）
2. Action: 枚举检查（只允许 4 种 action）
3. Params: 根据 action 类型检查必需参数
4. Confidence: 0-1 范围，< 0.5 warning
5. Reasoning: 非空，20-500 字符建议

**Normalization**：
- 添加默认值（requeue.priority='normal', skip.reason='No reason provided'）
- 返回 normalized JSON 供存储使用

**返回格式**：
```javascript
{
  valid: boolean,
  errors: Array<{field: string, message: string}>,
  warnings: Array<{field: string, message: string}>,
  normalized: Object | null
}
```

### Phase 2: Cortex Integration

**文件**: `brain/src/cortex.js`

**Prompt 更新**：
- 添加 Absorption Policy Generation 说明
- 包含完整的 Policy JSON Schema
- 说明何时生成 policy（可选字段）

**函数添加**：
```javascript
async function storeAbsorptionPolicy(policyJson, context)
```

**逻辑**：
1. 调用 `validatePolicyJson(policyJson, { strict: true })`
2. 如果失败：log 到 `cecelia_events` (event_type='policy_validation_failed')，返回 null
3. 如果成功：存储到 `absorption_policies` 表 (status='draft')
4. Log 成功到 `cecelia_events` (event_type='policy_created')

**Integration Point**：
在 `analyzeDeep()` 函数中，record learnings 之后，检查 `decision.absorption_policy`，如果存在则调用 `storeAbsorptionPolicy()`。

### Phase 3: Monitor Loop Validation

**文件**: `brain/src/monitor-loop.js`

**修改点**：
在读取 probation policy 后（`findProbationPolicy()`），添加验证：
1. 调用 `validatePolicyJson(policy_json, { strict: false })`
2. 如果失败：log warning + 跳过此 policy + log 到 `cecelia_events`
3. 如果成功：继续原有的 simulate 逻辑

---

## 测试策略

### Validator Tests (30+ cases)
- Constants validation
- isValidAction() / getRequiredParams()
- Valid policies (4 action types)
- Missing required fields
- Invalid action types
- Invalid params (每种 action)
- Confidence validation (< 0, > 1, < 0.5)
- Reasoning validation (empty, too short)
- JSON parsing (string input, invalid JSON)
- Normalization (default values)

### Cortex Tests (6+ cases)
- storeAbsorptionPolicy() 验证有效 policy
- storeAbsorptionPolicy() 拒绝无效 policy
- Validation failure 记录到 cecelia_events
- Normalization 应用默认值
- Strict mode 拒绝低置信度
- 支持所有 4 种 action 类型

### Monitor Loop Tests (3+ cases)
- Probation policy 验证通过继续 simulate
- Probation policy 验证失败跳过
- 验证失败记录到 cecelia_events

---

## 验收标准

- [ ] Validator: 5 个函数导出，30+ 测试全部通过
- [ ] Cortex: prompt 更新，storeAbsorptionPolicy() 实现，6+ 测试通过
- [ ] Monitor Loop: validation 集成，invalid policies 跳过
- [ ] Event logging: 所有 validation 结果记录到 cecelia_events
- [ ] CI: 所有检查通过（Version Check, Facts Consistency, Brain tests）

---

## 版本

- 当前: 1.27.0
- 目标: 1.27.0 (minor feature，P2 是 P1 的延续，使用相同版本)

---

**优先级**: P2
**预计工时**: 5-7 小时
**依赖**: P0 (基础设施), P1 (probation/promotion)
