---
id: prd-patrol-agent-m1
version: 1.0.0
created: 2026-01-29
updated: 2026-01-29
changelog:
  - 1.0.0: M1 - API 端点 + 数据库表
---

# PRD: Patrol Agent M1 - API 端点 + 数据库表

## 项目信息

| 项目 | 信息 |
|------|------|
| **目标仓库** | cecelia-semantic-brain |
| **依赖** | Core API (cecelia_runs 表) |
| **优先级** | P1 |
| **里程碑** | M1 |

---

## 背景

无头 Cecelia 在执行开发任务时可能卡住：
- Skill 调用后停顿（已知问题）
- CI 等待超时
- 进程崩溃
- 其他未知原因

需要一个智能巡逻机制，定期检查并自动修复。

---

## M1 范围

### 数据库表

```sql
CREATE TABLE patrol_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_id UUID,
    diagnosis TEXT NOT NULL,
    action TEXT,
    action_result TEXT,
    details JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API 端点

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/patrol/stale` | GET | 获取卡住的任务列表 |
| `/api/patrol/diagnose/:id` | POST | 记录诊断结果 |
| `/api/patrol/action/:id` | POST | 记录采取的行动 |
| `/api/patrol/logs` | GET | 巡逻日志列表 |
| `/api/patrol/summary` | GET | 巡逻统计摘要 |

---

## 涉及文件

### 新增

| 文件 | 功能 |
|------|------|
| `src/state/patrol.py` | Patrol 状态逻辑 |
| `src/api/patrol_routes.py` | Patrol API 路由 |
| `tests/test_patrol_api.py` | API 测试 |

### 修改

| 文件 | 修改内容 |
|------|----------|
| `src/api/main.py` | 注册 patrol_routes |
| `src/state/__init__.py` | 导出 patrol 模块 |

---

## 验收标准

- [ ] `GET /api/patrol/stale` 返回卡住任务列表
- [ ] `POST /api/patrol/diagnose/:id` 记录诊断
- [ ] `POST /api/patrol/action/:id` 记录行动
- [ ] `GET /api/patrol/logs` 返回巡逻日志
- [ ] `GET /api/patrol/summary` 返回统计
- [ ] 所有测试通过

---

## 测试计划

| 测试 | 命令 |
|------|------|
| API 端点 | `pytest tests/test_patrol_api.py -v` |
| 全部测试 | `pytest tests/ -v` |
