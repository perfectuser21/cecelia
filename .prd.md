# PRD: Planner KR 轮转 + Executor repo_path 解析

## 背景

系统自查发现两个阻塞 go-live 的问题：

1. **Planner 只试一个 KR**：`planNextTask()` 选择评分最高的 KR，如果该 KR 的所有任务候选都已完成（exhausted），就返回 `needs_planning` 放弃。但其他 KR 可能有未完成的候选。
2. **Executor repo_path 不解析 Feature 父链**：任务的 `project_id` 指向 Feature（子项目），Feature 没有 `repo_path`。Executor 应该向上遍历 `parent_id` 找到有 `repo_path` 的父 Project。

## 目标

1. Planner 遍历所有已评分的 KR，直到某个 KR 成功产出任务，或所有 KR 都尝试过
2. Executor 在 Feature 无 `repo_path` 时，向上查找父 Project 的 `repo_path`

## 方案

### 1. planner.js — planNextTask() 改为循环

当前逻辑：
```
selectTargetKR → selectTargetProject → generateNextTask → 成功/失败
```

改为：
```
scored = 排序所有 KR
for (kr of scored):
  project = selectTargetProject(kr)
  if (!project) continue
  task = generateNextTask(kr, project)
  if (task) return planned
return needs_planning
```

### 2. executor.js — resolveRepoPath() 遍历父链

当前逻辑：
```
SELECT repo_path FROM projects WHERE id = task.project_id
```

改为：
```
function resolveRepoPath(projectId):
  while projectId:
    project = SELECT repo_path, parent_id FROM projects WHERE id = projectId
    if (project.repo_path) return project.repo_path
    projectId = project.parent_id
  return null
```

## 影响范围

- `brain/src/planner.js` — `planNextTask()` 函数
- `brain/src/executor.js` — repo_path 解析逻辑
- `brain/src/__tests__/planner.test.js` — 补充 KR 轮转测试
- `brain/src/__tests__/executor.test.js` — 补充 repo_path 遍历测试

## 非目标

- 不改 KR_STRATEGIES 内容（策略匹配）
- 不改 selectTargetKR 的评分算法
- 不改 autoGenerateTask 的任务生成逻辑
- 不加新的 DB migration

## 验收标准

- [ ] planner 在 top KR exhausted 时自动尝试下一个 KR
- [ ] executor 解析 Feature 的 repo_path 时向上遍历到父 Project
- [ ] 现有测试全量通过（640/645，5 个 DouyinAdapter 预期失败）
- [ ] 新增测试覆盖 KR 轮转和 repo_path 遍历
