---
id: patrol-agent-m2
version: 1.0.0
created: 2026-01-29
updated: 2026-01-29
changelog:
  - 1.0.0: Initial version
---

# Patrol Agent M2: cecelia-patrol Script

## Overview

Create a standalone `cecelia-patrol` script that monitors running Cecelia tasks and automatically recovers stuck processes.

## Background

M1 implemented the Patrol API in Brain, but discovered an architecture issue:
- `cecelia_runs` data is in Core (:5212)
- Patrol API is in Brain (:5220)

M2 solves this by creating a script that directly calls Core API.

## Goals

1. Create `/home/xx/bin/cecelia-patrol` script
2. Implement patrol logic to detect stuck tasks
3. Implement automatic recovery actions

## Features

### CLI Interface

```bash
cecelia-patrol              # Execute patrol once
cecelia-patrol --daemon     # Run continuously (every 10 minutes)
cecelia-patrol --dry-run    # Check only, no actions
```

### Patrol Logic

1. Call `curl localhost:5212/api/cecelia/overview` to get tasks
2. Find tasks with status=running/in_progress and updated_at > 10 minutes ago
3. For each stuck task:
   - Read /tmp/cecelia-{task_id}.log if exists
   - Diagnose reason
   - Decide action
   - Execute action
4. Output patrol report

### Diagnosis Rules

| Diagnosis | Condition |
|-----------|-----------|
| process_dead | ps -p $pid does not exist |
| ci_timeout | current_step=9 and > 30 minutes |
| stuck_after_skill | Log ends with Skill output |
| needs_human | Cannot determine |
| normal | updated_at < 10 minutes |

### Action Rules

| Diagnosis | Action |
|-----------|--------|
| process_dead | restart (use cecelia-run to restart) |
| ci_timeout | continue (start new process to check CI) |
| stuck_after_skill | continue (start new process to continue) |
| needs_human | mark_human (record to Core, send notification) |
| normal | none |

## Dependencies

- curl (call Core API)
- jq (parse JSON)
- ps (check process)

## Success Criteria

1. Script is executable
2. --dry-run does not execute actual actions
3. Output format is correct
4. Can detect stuck tasks
5. Can execute recovery actions
