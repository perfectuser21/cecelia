---
id: prd-brain-security-hardening
version: 1.0.0
created: 2026-02-26
updated: 2026-02-26
changelog:
  - 1.0.0: Brain 安全加固三项修复
---

# PRD: Brain 安全加固

## 背景

代码审查发现 3 个安全问题需要修复：
1. `/api/brain/credentials` 端点暴露凭据文件路径
2. tasks 表并发创建无 DB 级去重约束（竞态条件）
3. executor.js 中 shell 命令拼接无输入验证

## 目标

修复以上 3 个安全问题，提升 Brain 的防御深度。

## 具体需求

### 修复 1: Credentials 端点去除路径泄露
- 删除 `/api/brain/credentials` 返回中的 `path` 字段
- 前端改为显示 `provider` 而非 `path`

### 修复 2: Tasks 表并发去重约束
- 新增 partial unique index 防止并发创建重复任务
- INSERT 加 ON CONFLICT DO NOTHING
- 保留应用层 SELECT 去重（覆盖 completed 24h 窗口）

### 修复 3: Executor 命令注入防御
- 新增 assertSafeId() / assertSafePid() 验证函数
- 在所有 execSync 调用前校验输入格式

### 全局变更
- Brain 版本 bump 1.99.2 → 1.99.3
- Schema 版本 076 → 077
- DEFINITION.md 同步更新

## 成功标准
- credentials API 不返回 path 字段
- 并发创建同名任务不会产生重复
- 非法 ID/PID 格式被拒绝并抛出错误
- 所有测试通过，DevGate 通过
