# PRD: Fix SQL Error in getActiveExecutionPaths()

## 问题描述

Brain 1.41.1 部署后，`decomposition-checker.js` 的 `getActiveExecutionPaths()` 函数抛出 SQL 错误：

```
[decomp-checker] Execution frontier check failed: for SELECT DISTINCT, ORDER BY expressions must appear in select list
```

**影响**：
- Execution Frontier Model 无法检测活跃路径
- 无法进行库存补充（inventory replenishment）
- 拆解任务生成受阻

**优先级**：P0 - Critical（阻塞生产功能）

## 根本原因

`getActiveExecutionPaths()` 的 SQL 查询（第 144-155 行）：

```sql
SELECT DISTINCT p.id, p.name, pkl.kr_id
...
ORDER BY MAX(t.updated_at) DESC
```

**PostgreSQL 规则违反**：
1. 使用了 `SELECT DISTINCT`
2. `ORDER BY MAX(t.updated_at)` 使用了聚合函数
3. 但 `MAX(t.updated_at)` 不在 SELECT 列表中
4. 且没有使用 `GROUP BY`

PostgreSQL 要求：**使用 SELECT DISTINCT 时，ORDER BY 的表达式必须出现在 SELECT 列表中**。

## 解决方案

### SQL 修复

将查询改为：

```sql
SELECT p.id, p.name, pkl.kr_id, MAX(t.updated_at) as last_activity
FROM projects p
INNER JOIN tasks t ON t.project_id = p.id
LEFT JOIN project_kr_links pkl ON pkl.project_id = p.parent_id
WHERE p.type = 'initiative'
  AND p.status = 'active'
  AND t.updated_at > NOW() - INTERVAL '24 hours'
  AND t.status IN ('in_progress', 'completed', 'queued')
GROUP BY p.id, p.name, pkl.kr_id
ORDER BY last_activity DESC
LIMIT 10
```

**关键变化**：
1. 移除 `DISTINCT`（不需要，因为有 GROUP BY）
2. 添加 `MAX(t.updated_at) as last_activity` 到 SELECT
3. 添加 `GROUP BY p.id, p.name, pkl.kr_id`
4. `ORDER BY last_activity DESC`（使用别名）

### 代码位置

文件：`brain/src/decomposition-checker.js`
函数：`getActiveExecutionPaths()`
行号：144-158

## 验收标准

### DoD

1. **SQL 语法正确**
   - 移除 DISTINCT
   - 添加 GROUP BY
   - 添加 last_activity 到 SELECT
   - ORDER BY 使用别名

2. **功能验证**
   - Brain 日志不再出现 SQL 错误
   - `getActiveExecutionPaths()` 返回正确的活跃路径列表
   - Execution Frontier Model 正常工作

3. **测试覆盖**
   - 添加或更新单元测试验证 SQL 正确性
   - 测试边界情况（无活跃路径、多个路径等）

4. **回归测试**
   - 所有现有测试通过
   - CI/CD 流水线成功

## 技术细节

### SQL 语法规则（PostgreSQL）

当使用聚合函数（如 MAX, COUNT, SUM）时：
- 要么所有列都是聚合函数
- 要么使用 GROUP BY 列出非聚合列

**错误**：
```sql
SELECT DISTINCT a, b ORDER BY MAX(c)  -- ❌ MAX(c) 不在 SELECT
```

**正确**：
```sql
SELECT a, b, MAX(c) as max_c GROUP BY a, b ORDER BY max_c  -- ✅
```

### 为什么移除 DISTINCT

使用 GROUP BY 后，结果已经是唯一的（每个 initiative 一行），不需要 DISTINCT。

DISTINCT + GROUP BY 是冗余的，并且：
- GROUP BY 更明确（指定分组列）
- GROUP BY 允许使用聚合函数
- DISTINCT 会限制 ORDER BY 的使用

## 风险评估

### 风险

1. **语义变化**？
   - **否** - GROUP BY 保证了与原意相同的结果（每个 initiative 一行）
   - 实际上更正确，因为原查询无法执行

2. **性能影响**？
   - **无** - GROUP BY 有索引支持，性能与 DISTINCT 相当或更好
   - LIMIT 10 限制了结果集大小

3. **向后兼容**？
   - **N/A** - 原函数根本无法执行，没有"旧行为"需要兼容

### 回滚计划

如果部署后有问题：
1. 回滚到 Brain 1.41.0（在 PR #291 之前的版本）
2. 暂时禁用 Execution Frontier（环境变量控制）

## 参考

- PostgreSQL文档：[SELECT DISTINCT](https://www.postgresql.org/docs/current/sql-select.html#SQL-DISTINCT)
- 原始实现：PR #291（Brain 1.41.1）
- 相关 Learning：`docs/LEARNINGS/2026-02-16-ci-not-triggered-due-to-merge-conflict.md`
