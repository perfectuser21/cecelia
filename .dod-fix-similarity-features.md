# DoD: 修复 similarity.js 查询已删除的 features 表

## 验收清单

### 代码修改

- [ ] `brain/src/similarity.js` Line 95-106: Tasks 查询改用 projects 表
- [ ] `brain/src/similarity.js` Line 108-132: Tasks 结果映射更新字段
- [ ] `brain/src/similarity.js` Line 134-159: Initiatives 查询改用 projects + project_kr_links
- [ ] `brain/src/similarity.js` Line 146-158: Initiatives 结果映射更新字段
- [ ] 代码中无 `FROM features` 或 `JOIN features`（除了测试 mock）

### 测试

- [ ] 运行 `npm test` - 所有测试通过
- [ ] `brain/src/__tests__/similarity.test.js` - 通过
- [ ] `brain/src/__tests__/learning-search.test.js` - 通过
- [ ] 新增测试：searchSimilar 返回 Initiatives (level='initiative')

### API 测试

- [ ] 启动 Brain: `docker-compose up -d`
- [ ] 健康检查: `curl http://localhost:5221/api/brain/health` → 200 OK
- [ ] 创建测试 Initiative（Sub-Project）
- [ ] 调用 `POST /api/brain/search-similar` with query="JWT 认证"
- [ ] 验证返回：
  - [ ] 状态码 200
  - [ ] `success: true`
  - [ ] `matches` 数组包含 `level='initiative'` 的结果
  - [ ] `matches[0].title` 是 projects.name (不是 features.title)

### 数据验证

- [ ] 确认 projects 表有 Sub-Projects（parent_id IS NOT NULL）
- [ ] 确认 project_kr_links 表有数据（关联 Projects 和 KRs）
- [ ] 搜索结果包含正确的 metadata:
  - [ ] `kr_id` 来自 project_kr_links
  - [ ] `kr_title` 来自 goals 表

### 兼容性

- [ ] API 返回格式未改变（向后兼容）
- [ ] `initiative_id` 字段仍然存在（映射到 project_id）
- [ ] 现有调用方不受影响

### 文档

- [ ] 更新 INTEGRATION_GAPS.md：标记 Bug #1 为已修复
- [ ] 如果发现其他文件也查询 features 表，记录到 LEARNINGS.md

### CI

- [ ] PR 创建
- [ ] CI 通过（Version Check, Facts Consistency, Brain Tests）
- [ ] PR 合并到 develop

## 回归测试

如果修改后发现其他问题，需要检查：

- [ ] `brain/src/cortex.js` - 是否也在查询 features 表？
- [ ] `brain/src/actions.js` - deduplication 是否受影响？
- [ ] `brain/src/rca-deduplication.js` - 是否需要更新？

## 完成标准

**所有上述清单项都勾选后**，且：

1. `npm test` 全部通过
2. API 手动测试通过
3. PR 合并到 develop

→ Task #9 完成 ✅
