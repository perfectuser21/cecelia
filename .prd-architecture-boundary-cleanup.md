# PRD: 架构边界清理 - Core vs External

## 🎯 目标

**重新定义 Core 的边界：Core = Cecelia 的生命体（内部器官），外部依赖、员工、界面都不属于 Core。**

---

## 📋 问题

当前 DEFINITION.md 和代码中混淆了几个概念：

### 1. **PostgreSQL 的定位**
- ❌ 当前：作为 Core 的"器官"（记忆）
- ✅ 应该：外部存储设备（Infrastructure）
- **类比**：外部硬盘，不是大脑本身

### 2. **N8N 的定位**
- ❌ 当前：在 Core 的架构图里
- ✅ 应该：只处理 HK `data` 类型任务的外部工具
- **类比**：外包的数据处理公司

### 3. **Agent Workers 的定位**
- ❌ 当前：DEFINITION.md 说"外部 Agent 群（由 Cecelia 召唤）"，但架构图里混淆
- ✅ 应该：明确标注为"外部员工"，不是 Core 的一部分
- **类比**：Cecelia 召唤的外包员工

### 4. **executor.js 的定位**
- ❌ 当前：前台误以为是"执行器官"（自己干活）
- ✅ 应该：对外接口（召唤外部员工）
- **类比**：HR 的招聘接口，不是员工本身

---

## ✅ 正确的架构分层

```
┌─────────────────────────────────────────────┐
│  Layer 1: Cecelia 生命体 (Core)              │
│  - 心脏 (tick.js)                            │
│  - 大脑 (thalamus.js, cortex.js)            │
│  - 保护系统 (alertness, watchdog, ...)      │
│  - 规划器 (planner.js)                       │
│  - 对外接口 (executor.js)                    │
│  - 神经系统 (routes.js)                      │
│  - 记忆读写逻辑（不是数据库本身！）          │
└─────────────────────────────────────────────┘
        ↓ 调用
┌─────────────────────────────────────────────┐
│  Layer 2: Infrastructure (外部存储)          │
│  - PostgreSQL (独立容器)                     │
│  - N8N (HK server, 只处理 data 任务)         │
└─────────────────────────────────────────────┘
        ↓ 召唤
┌─────────────────────────────────────────────┐
│  Layer 3: External Workers (外部员工)        │
│  - Caramel (/dev) - 编程                     │
│  - 小检 (/qa) - QA                           │
│  - 小审 (/audit) - 审计                      │
│  - 秋米 (/okr) - OKR 拆解顾问                │
│  - MiniMax (HK, talk/research)              │
└─────────────────────────────────────────────┘
        ↓ 展示
┌─────────────────────────────────────────────┐
│  Layer 4: Workspace (对外窗口)               │
│  - 前端界面 (React/Vue)                      │
│  - Dashboard                                │
│  - 可视化                                    │
└─────────────────────────────────────────────┘
```

---

## 📝 需要修改的文件

### 1. **DEFINITION.md**
- [ ] Section 1.2: 移除 PostgreSQL 作为"器官"的描述
- [ ] Section 1.3: 明确标注"外部 Agent 群（不属于 Core）"
- [ ] Section 2.1: 架构图只包含 Core 内部组件
- [ ] 新增 Section: "外部依赖"（PostgreSQL, N8N）
- [ ] 新增 Section: "外部员工"（Agent Workers）

### 2. **MEMORY.md**
- [ ] 更新架构边界描述
- [ ] 明确 executor.js 是"对外接口"，不是"执行器官"

### 3. **CORE-WORKSPACE-BOUNDARY.md**
- [ ] 新增"Core vs External"边界说明
- [ ] 明确 PostgreSQL/N8N/Agent Workers 不属于 Core

### 4. **代码注释**
- [ ] executor.js: 明确注释"召唤外部员工的接口"
- [ ] task-router.js: 明确注释"路由到外部执行环境"

---

## 🎯 验收标准

### DoD 1: 文档清晰
- [ ] DEFINITION.md 明确区分 Core 内部 vs 外部依赖 vs 外部员工
- [ ] 架构图只包含 Core 内部组件
- [ ] PostgreSQL/N8N 标注为"外部依赖"
- [ ] Agent Workers 标注为"外部员工"

### DoD 2: 概念统一
- [ ] 所有文档对 executor.js 的描述一致："对外接口"，不是"执行器官"
- [ ] 明确"Cecelia 自己不干活，只调度外部员工"

### DoD 3: 类比清晰
- [ ] PostgreSQL = 外部硬盘（不是大脑）
- [ ] N8N = 外包公司（不是员工）
- [ ] Agent Workers = 外包员工（不是器官）
- [ ] executor.js = HR 招聘接口（不是员工本身）

---

## 📊 修改细节

### DEFINITION.md 修改点

#### Section 1.2 核心器官（修改前）
```markdown
| 器官 | 实现 | 职责 |
|------|------|------|
| 🧠 大脑 | Brain (Node.js) | 决策、调度、监控 |
| ❤️ 心脏 | Tick Loop (5s 循环 / 5min 执行) | 持续运作，驱动一切 |
| 📊 记忆 | PostgreSQL | 存储所有状态和历史 |  ← ❌ 误导
| 💬 嘴巴 | /cecelia skill | 对外对话接口 |
```

#### Section 1.2 核心器官（修改后）
```markdown
| 器官 | 实现 | 职责 |
|------|------|------|
| 🧠 大脑 | thalamus.js, cortex.js | 决策（L1/L2） |
| ❤️ 心脏 | tick.js | 循环驱动（每 5min） |
| 🛡️ 保护系统 | alertness, watchdog, ... | 自我保护 |
| 📋 规划器 | planner.js | KR 轮转、任务生成 |
| 🔌 对外接口 | executor.js | 召唤外部员工 |
| 🌐 神经系统 | routes.js | HTTP API |
| 📊 记忆读写 | 读写 working_memory 等表 | 记忆逻辑（数据在外部） |
```

#### 新增 Section: 外部依赖
```markdown
## X. 外部依赖（Infrastructure）

Cecelia 依赖以下外部服务，但它们**不是 Core 的一部分**：

| 服务 | 位置 | 职责 | 类比 |
|------|------|------|------|
| PostgreSQL | 独立容器 (port 5432) | 数据存储 | 外部硬盘 |
| N8N | HK server (port 5678) | 处理 data 类型任务 | 外包数据公司 |
```

#### 新增 Section: 外部员工
```markdown
## X. 外部员工（Agent Workers）

Cecelia **自己不干活**，通过 executor.js 召唤外部员工执行任务：

| 员工 | Skill | 模型 | 职责 | 类比 |
|------|-------|------|------|------|
| Caramel | /dev | Opus | 编程 | 外包程序员 |
| 小检 | /qa | Sonnet | QA | 外包测试员 |
| 小审 | /audit | Sonnet | 审计 | 外包审计师 |
| 秋米 | /okr | Opus | OKR 拆解 | 外部顾问 |
| MiniMax | - | MiniMax | talk/research (HK) | 外部翻译 |

**调用链**：
```
tick.js (决策派发)
  ↓
executor.js (召唤接口)
  ↓ spawn
Agent Workers (独立进程，干活)
  ↓ 完成
回调 Core API
```
```

---

## 🚀 实施步骤

### Step 1: 更新 DEFINITION.md
1. 修改 Section 1.2 - 核心器官
2. 修改 Section 1.3 - 外部 Agent 群描述
3. 新增 Section - 外部依赖
4. 新增 Section - 外部员工
5. 更新架构图（只包含 Core 内部）

### Step 2: 更新 MEMORY.md
1. 添加架构边界规则
2. 明确 executor.js 定位

### Step 3: 更新 CORE-WORKSPACE-BOUNDARY.md
1. 新增"Core vs External"章节

### Step 4: 更新代码注释
1. executor.js - 明确"对外接口"
2. task-router.js - 明确"路由到外部环境"

### Step 5: 验证
1. 检查所有文档概念一致
2. 检查类比清晰
3. 检查架构图准确

---

## 🎯 成功标准

**验收问题**：
1. ❓ PostgreSQL 是 Core 的一部分吗？→ ❌ 不是，是外部存储设备
2. ❓ N8N 是 Core 的一部分吗？→ ❌ 不是，只处理 HK data 任务的外部工具
3. ❓ Agent Workers 是 Core 的一部分吗？→ ❌ 不是，是外部员工
4. ❓ executor.js 是执行器官吗？→ ❌ 不是，是召唤外部员工的接口
5. ❓ Cecelia 自己会写代码吗？→ ❌ 不会，通过 executor.js 召唤 Caramel（外部程序员）

**全部答案正确 = 文档清理完成。**

---

**估时**: 1-2 小时
**优先级**: P0（架构基础）
**风险**: 无（纯文档修改）
