# PRD: Add exploratory Task Type Support

## What

**功能描述**：在 Brain 的任务路由系统中添加 `exploratory` 任务类型支持，使 Brain 能够正确派发 exploratory tasks 到 /exploratory skill。

## Why

**需求来源**：OKR 执行循环集成（INTEGRATION_GAPS.md Bug #5）

当前问题：
- `task-router.js` 的 `LOCATION_MAP` 缺少 exploratory 类型
- `isValidTaskType()` 验证列表缺少 exploratory
- `executor.js` 的 `getSkillForTaskType()` 缺少 exploratory 映射
- `executor.js` 的 `getPermissionModeForTaskType()` 缺少 exploratory 权限配置

导致后果：
- 创建 exploratory task 时会被 `isValidTaskType()` 拒绝
- 即使创建成功，executor 也不知道调用哪个 skill
- Brain Tick Loop 无法正确派发 exploratory tasks

## How

### 修改 1: task-router.js

**文件**: `brain/src/task-router.js`

**Line 44-52**: 在 LOCATION_MAP 添加 exploratory
```javascript
const LOCATION_MAP = {
  'dev': 'us',        // 写代码 → US (Nobel + Opus + /dev)
  'review': 'us',     // 代码审查 → US (Sonnet + /review)
  'qa': 'us',         // QA → US (Sonnet)
  'audit': 'us',      // 审计 → US (Sonnet)
  'exploratory': 'us', // 探索性验证 → US (Opus + /exploratory)  ← 新增
  'talk': 'hk',       // 对话 → HK (MiniMax)
  'research': 'hk',   // 调研 → HK (MiniMax)
  'data': 'hk',       // 数据处理 → HK (N8N)
};
```

**Line 163**: 在 isValidTaskType() 添加 exploratory
```javascript
function isValidTaskType(taskType) {
  const validTypes = ['dev', 'review', 'talk', 'data', 'qa', 'audit', 'research', 'exploratory'];
  return validTypes.includes(taskType?.toLowerCase());
}
```

### 修改 2: executor.js

**文件**: `brain/src/executor.js`

**Line 556-567**: 在 getSkillForTaskType() 添加 exploratory
```javascript
function getSkillForTaskType(taskType) {
  const skillMap = {
    'dev': '/dev',           // 写代码：Opus
    'review': '/review',     // 审查：Sonnet，Plan Mode
    'qa_init': '/review init', // QA 初始化：设置 CI 和分支保护
    'exploratory': '/exploratory', // 探索性验证：Opus  ← 新增
    'talk': '/talk',         // 对话：写文档，不改代码
    'research': null,        // 研究：完全只读
    // 兼容旧类型
    'qa': '/review',
    'audit': '/review',
  };
  return skillMap[taskType] || '/dev';
}
```

**Line 600-610**: 在 getPermissionModeForTaskType() 添加 exploratory
```javascript
function getPermissionModeForTaskType(taskType) {
  const modeMap = {
    'dev': 'bypassPermissions',        // 写代码
    'review': 'plan',                  // 只读分析（唯一用 plan 的）
    'exploratory': 'bypassPermissions', // 探索性验证：需要读写文件  ← 新增
    'talk': 'bypassPermissions',       // 要调 API 写数据库
    'research': 'bypassPermissions',   // 要调 API
    // 兼容旧类型
    'qa': 'plan',
    'audit': 'plan',
  };
  return modeMap[taskType] || 'bypassPermissions';
}
```

## Success Criteria

**验收标准**：

1. **task-router.js**:
   - ✅ LOCATION_MAP 包含 `'exploratory': 'us'`
   - ✅ isValidTaskType() 验证列表包含 `'exploratory'`
   - ✅ getTaskLocation('exploratory') 返回 `'us'`

2. **executor.js**:
   - ✅ getSkillForTaskType('exploratory') 返回 `'/exploratory'`
   - ✅ getPermissionModeForTaskType('exploratory') 返回 `'bypassPermissions'`

3. **集成测试**:
   - ✅ 创建 exploratory task 不会被 isValidTaskType() 拒绝
   - ✅ Brain 能正确派发 exploratory task 到 US server
   - ✅ 执行时调用 `/exploratory` skill
   - ✅ 权限模式为 bypassPermissions（能读写文件）

## Files Changed

- `brain/src/task-router.js` - 添加 exploratory 类型路由
- `brain/src/executor.js` - 添加 exploratory skill 映射和权限配置

## Version

Patch bump: 1.31.2 → 1.31.3
