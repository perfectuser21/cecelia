# PRD: Cecelia 丘脑 (Thalamus) - 仿人脑事件路由器

## 背景

当前 Cecelia Brain 架构存在问题：
- Tick 是纯代码逻辑，不调用 LLM
- Brain LLM 只有用户主动聊天时才被调用
- 缺少"事件路由器"来决定什么时候唤醒 LLM

需要实现仿人脑的架构：
- 丘脑 (Thalamus) = 事件路由器，用 Sonnet 判断事件复杂度
- 脑干 (Tick) = 自动反射，纯代码处理简单事件
- 大脑皮层 (Brain LLM) = 深度思考，Opus 处理复杂决策

## 目标

实现 Cecelia 丘脑模块，让 LLM 成为真正的中枢。

**核心原则**：LLM 只能下"指令"，不能直接改世界。

## 功能描述

### 1. Decision Schema

```typescript
interface Decision {
  level: 0 | 1 | 2;  // 0=脑干, 1=快速判断, 2=深度思考
  actions: Action[];  // 要执行的动作列表
  rationale: string;  // 决策原因
  confidence: number; // 0-1 置信度
  safety: boolean;    // 是否需要人确认
}

interface Action {
  type: string;  // 必须在白名单内
  params: object;
}
```

### 2. Action 白名单

- dispatch_task: 派发任务
- create_task: 创建任务
- cancel_task: 取消任务
- retry_task: 重试任务
- reprioritize_task: 调整优先级
- create_okr: 创建 OKR
- update_okr_progress: 更新 OKR 进度
- assign_to_autumnrice: 交给秋米拆解
- notify_user: 通知用户
- log_event: 记录事件
- escalate_to_brain: 升级到 Brain LLM
- request_human_review: 请求人工确认
- analyze_failure: 分析失败原因
- predict_progress: 预测进度
- no_action: 不需要操作
- fallback_to_tick: 降级到纯代码

### 3. 事件类型

- TASK_COMPLETED: 任务完成
- TASK_FAILED: 任务失败
- TASK_TIMEOUT: 任务超时
- USER_MESSAGE: 用户消息
- TICK: 定时触发
- OKR_CREATED: OKR 创建
- DEPARTMENT_REPORT: 部门汇报
- EXCEPTION_REPORT: 异常上报

### 4. 三层处理

| 级别 | 处理者 | 触发条件 |
|------|--------|----------|
| 0 | 脑干 (代码) | 心跳、简单派发 |
| 1 | 快速反应 (Sonnet) | 需要判断但不复杂 |
| 2 | 深度思考 (Opus) | 复杂决策、异常分析 |

### 5. Validator

验证 Decision 合法性：
- 字段完整性检查
- Action 白名单检查
- 权限检查（危险操作需 safety: true）

### 6. Executor

执行 Decision 中的 actions：
- 调用对应的 handler
- 记录执行日志
- 返回执行报告

### 7. 降级机制

Sonnet 调用失败时：
- 返回 fallback_to_tick 决策
- 让纯代码 Tick 接管

## 验收标准

- [ ] thalamus.js 实现事件分析
- [ ] decision-executor.js 实现决策执行
- [ ] Validator 验证 Decision 合法性
- [ ] 快速路由处理简单事件（不调 LLM）
- [ ] 降级机制：Sonnet 失败时回退到代码
- [ ] 单元测试覆盖核心逻辑
- [ ] 接入 Tick 事件流

## 技术要点

1. 调用 Sonnet API (claude-sonnet-4-20250514)
2. JSON schema 严格验证
3. 白名单限制 actions
4. 执行日志写入 decision_log 表
