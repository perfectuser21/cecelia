# PRD: 修复 similarity.js 查询已删除的 features 表

## Why

Migration 027 已删除 `features` 表，将 Initiative 迁移到 `projects` 表（作为 Sub-Project）。但 `similarity.js` 仍在查询 `features` 表，导致记忆搜索功能失败。

**影响**:
- API `/api/brain/search-similar` 报错
- 无法搜索相似的 Initiatives
- OKR 闭环中的记忆搜索功能不可用

## What

**功能描述**：修复 `brain/src/similarity.js` 的表查询，从 `features` 改为 `projects`。

**修改位置**:

1. **Line 95-106**: Tasks 查询
   ```sql
   -- ❌ 旧代码
   LEFT JOIN pr_plans pp ON t.pr_plan_id = pp.id
   LEFT JOIN features f ON pp.initiative_id = f.id  ← features 表不存在

   -- ✅ 新代码
   LEFT JOIN pr_plans pp ON t.pr_plan_id = pp.id
   LEFT JOIN projects p ON pp.project_id = p.id     ← 使用 projects 表
   ```

2. **Line 108-132**: Tasks 结果映射
   ```javascript
   // ❌ 旧字段
   initiative_id: task.initiative_id
   initiative_title: task.initiative_title

   // ✅ 新字段
   initiative_id: task.project_id  // project_id = initiative_id
   initiative_title: task.project_name
   ```

3. **Line 134-159**: Initiatives 查询
   ```sql
   -- ❌ 旧代码
   FROM features f
   LEFT JOIN key_results kr ON f.kr_id = kr.id

   -- ✅ 新代码
   FROM projects p
   LEFT JOIN project_kr_links pkl ON p.id = pkl.project_id
   LEFT JOIN goals kr ON pkl.kr_id = kr.id AND kr.type = 'key_result'
   WHERE p.parent_id IS NOT NULL  ← 只选择 Sub-Projects (Initiatives)
   ```

4. **Line 146-158**: Initiatives 结果映射
   ```javascript
   // ❌ 旧字段
   level: 'initiative'
   id: initiative.id
   title: initiative.title
   description: initiative.description || ''

   // ✅ 新字段
   level: 'initiative'
   id: initiative.id
   title: initiative.name          ← projects.name
   description: initiative.description || ''
   ```

## How

### 实现步骤

1. 修改 `getAllActiveEntities()` 方法的 SQL 查询
2. 修改字段映射（features → projects）
3. 运行测试确保兼容性
4. 手动测试 API 端点

### 数据库 Schema 参考

**projects 表**（Initiatives = Sub-Projects）:
```sql
CREATE TABLE projects (
  id UUID PRIMARY KEY,
  name VARCHAR(255),           -- 对应 features.title
  description TEXT,
  repo_path VARCHAR(500),
  parent_id UUID,              -- NULL = Project, NOT NULL = Sub-Project (Initiative)
  status VARCHAR(50),
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

**project_kr_links 表**（多对多关联）:
```sql
CREATE TABLE project_kr_links (
  project_id UUID,
  kr_id UUID,
  PRIMARY KEY (project_id, kr_id)
);
```

### 兼容性

- ✅ 向后兼容：API 返回格式不变
- ✅ 字段映射：`initiative_id` → `project_id`（语义相同）
- ✅ 测试覆盖：existing tests should pass

## Outcome

- ✅ API `/api/brain/search-similar` 正常工作
- ✅ 能搜索到 Initiatives (from projects table)
- ✅ 测试覆盖率保持（similarity.test.js 通过）
- ✅ 记忆搜索功能恢复，支持 OKR 闭环

## Dependencies

- PostgreSQL schema (migration 027)
- No new npm packages needed

## Risks

- **Migration 不完整**：如果有其他地方也在查询 features 表，需要一并修复
  - Mitigation: 运行 `grep -r "FROM features\|JOIN features" brain/src` 检查

## Testing

### Unit Tests

```javascript
// brain/src/__tests__/similarity.test.js
test('searchSimilar returns initiatives from projects table', async () => {
  // 创建测试 Initiative (Sub-Project)
  await createTestProject({ name: 'Test Initiative', parent_id: projectId });

  // 搜索
  const result = await service.searchSimilar('Test Initiative', 5);

  // 验证
  expect(result.matches.some(m => m.level === 'initiative')).toBe(true);
});
```

### Manual Test

```bash
# 1. 创建测试数据
curl -X POST http://localhost:5221/api/brain/projects \
  -H "Content-Type: application/json" \
  -d '{"name":"JWT 认证系统","description":"实现 JWT 认证","repo_path":"/home/xx/perfect21/cecelia/core"}'

# 记录返回的 project_id
PROJECT_ID="<uuid>"

# 2. 创建 Sub-Project (Initiative)
psql -U cecelia -d cecelia -c "
  INSERT INTO projects (name, description, parent_id, status)
  VALUES ('JWT 认证 Initiative', 'Initiative for JWT auth', '$PROJECT_ID', 'active')
"

# 3. 测试搜索
curl -X POST http://localhost:5221/api/brain/search-similar \
  -H "Content-Type: application/json" \
  -d '{"query":"JWT 认证","top_k":5}'

# 预期：返回包含 level='initiative' 的结果
```

## Acceptance Criteria

- [ ] similarity.js 不再查询 features 表
- [ ] 使用 projects 表查询 Initiatives
- [ ] API 返回格式不变（向后兼容）
- [ ] existing tests pass (npm test)
- [ ] 手动测试通过（能搜索到 Initiatives）
