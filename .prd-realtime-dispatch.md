---
id: prd-realtime-dispatch
version: 1.1.0
created: 2026-02-04
updated: 2026-02-04
changelog:
  - 1.1.0: 简化 Seats 模型（总 6 席，预留 1 给人工，自动派发最多 5）
  - 1.0.0: 初始版本
---

# PRD: Brain 实时派发 + Seats 分类

## 背景

当前 Brain Tick 每 2 分钟运行一次，任务从队列到派发延迟 1-3 分钟。对于图片生成等短任务，这个延迟太长。

经分析，Tick 不消耗 LLM tokens（只是数据库查询），可以改成实时派发。

## 目标

1. **实时派发**：任务进队列后秒级派发（5-10秒内）
2. **Seats 分类**：预留 2 个 slots 给短任务，避免被长任务占满

## 当前状态

```
CECELIA_MAX_CONCURRENT = 3
TICK_LOOP_INTERVAL_MS = 2 * 60 * 1000  // 2分钟
DISPATCH_COOLDOWN_MS = 60 * 1000       // 1分钟冷却
```

## 目标状态

```
CECELIA_MAX_CONCURRENT = 6             // 总席位 6
CECELIA_RESERVED_SLOTS = 1             // 预留 1 个给人工
CECELIA_AUTO_DISPATCH_MAX = 5          // 自动派发最多 5 个
TICK_LOOP_INTERVAL_MS = 5 * 1000       // 5秒检查
DISPATCH_COOLDOWN_MS = 5 * 1000        // 5秒冷却
```

## Seats 模型

```
总席位: 6
├── 自动派发: 最多 5
└── 预留给人工: 1（动态维持）
```

**动态预留**: 不管谁占用，系统始终保持 1 个空位给人工介入。

## 任务类型自动判定

Brain 根据 skill 来源自动标记 task_type：

| Skill / 来源 | task_type |
|--------------|-----------|
| `/dev`, `/audit` | long |
| `/luxury-card-generator`, `/quote-card-generator` | short |
| 其他 | 默认 long |

## 改动范围

### 1. tick.js - 修改 Tick 间隔

**文件**: `/home/xx/dev/cecelia-core/brain/src/tick.js`

```javascript
// 改动 1: 缩短 Tick 间隔
// 旧:
const TICK_LOOP_INTERVAL_MS = 2 * 60 * 1000;
// 新:
const TICK_LOOP_INTERVAL_MS = 5 * 1000;  // 5秒

// 改动 2: 缩短派发冷却（或短任务无冷却）
// 旧:
const DISPATCH_COOLDOWN_MS = 60 * 1000;
// 新:
const DISPATCH_COOLDOWN_MS = 5 * 1000;   // 5秒
const SHORT_TASK_COOLDOWN_MS = 0;        // 短任务无冷却
```

### 2. tick.js - 修改并发检查逻辑

**位置**: `dispatchNextTask()` 函数（约 330 行）

```javascript
// 旧: 检查总并发
const activeCount = Math.max(dbActiveCount, processActiveCount);
if (activeCount >= MAX_CONCURRENT_TASKS) {
  return { dispatched: false, reason: 'max_concurrent_reached' };
}

// 新: 预留 1 个给人工
const RESERVED_SLOTS = parseInt(process.env.CECELIA_RESERVED_SLOTS || '1');
const AUTO_DISPATCH_MAX = MAX_CONCURRENT_TASKS - RESERVED_SLOTS;  // 6 - 1 = 5

if (activeCount >= AUTO_DISPATCH_MAX) {
  return { dispatched: false, reason: 'reserved_slot_kept', active: activeCount, limit: AUTO_DISPATCH_MAX };
}

// 继续派发...
```

### 3. 任务类型自动判定

**位置**: 创建任务时（executor.js 或 API 入口）

```javascript
// 根据 skill 自动判定 task_type
function inferTaskType(skill) {
  const SHORT_SKILLS = [
    'luxury-card-generator',
    'quote-card-generator',
    'batch-luxury-card-generator'
  ];
  return SHORT_SKILLS.includes(skill) ? 'short' : 'long';
}

// 创建任务时自动设置
const taskType = inferTaskType(skill);
payload.task_type = taskType;
```

## 环境变量

**新增到 `.env`**:

```bash
# Seats 配置
CECELIA_MAX_CONCURRENT=6      # 总席位 6
CECELIA_RESERVED_SLOTS=1      # 预留 1 个给人工

# Tick 配置
CECELIA_TICK_INTERVAL_MS=5000
CECELIA_DISPATCH_COOLDOWN_MS=5000
```

## 测试计划

1. **实时派发测试**
   - 创建一个任务
   - 验证 5-10 秒内被派发

2. **预留 Slot 测试**
   - 创建 5 个任务（应该全部派发）
   - 创建第 6 个任务（应该排队，预留给人工）
   - 人工介入 1 个任务 → 第 6 个仍排队（保持预留）

3. **任务类型自动判定测试**
   - 创建 `/dev` 任务 → task_type = long
   - 创建 `/luxury-card-generator` 任务 → task_type = short

## 验收标准

- [ ] 任务从队列到派发 < 10 秒
- [ ] 自动派发最多 5 个
- [ ] 始终预留 1 个 slot 给人工
- [ ] 总并发不超过 6
- [ ] task_type 根据 skill 自动判定

## 风险

| 风险 | 影响 | 缓解 |
|------|------|------|
| 5秒 Tick 数据库压力 | 低 | PostgreSQL 轻松处理 |
| 并发计数不准 | 中 | 同时检查 DB 和进程数 |

## 时间线

- Phase 1: 修改 Tick 间隔和冷却（5分钟）
- Phase 2: 添加预留逻辑（10分钟）
- Phase 3: 添加 task_type 自动判定（10分钟）
- Phase 4: 测试验证（15分钟）
