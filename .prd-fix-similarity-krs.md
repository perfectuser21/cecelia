# PRD: Fix similarity.js KRs Query - Replace okrs with goals

## What

**功能描述**：修复 `brain/src/similarity.js` 中 KRs 查询引用不存在的 `okrs` 表的 bug。

**错误位置**: Line 163-172

**问题现象**:
```
POST /api/brain/search-similar 返回错误:
{
  "success": false,
  "error": "Failed to search similar entities",
  "details": "relation \"okrs\" does not exist"
}
```

## Why

**需求来源**: Task #11 - 测试记忆搜索 API 端到端时发现

**根本原因**:
- 数据模型已变更：`okrs` 表已删除，改用 `goals` 表 + `type` 字段区分 Objective/KR
- `key_results` 表的外键字段从 `okr_id` 改为 `goal_id`
- similarity.js 代码未同步更新，仍然引用旧的 `okrs` 表

**Schema 对比**:
```sql
-- OLD (不存在)
LEFT JOIN okrs o ON kr.okr_id = o.id

-- NEW (正确)
LEFT JOIN goals g ON kr.goal_id = g.id AND g.type = 'objective'
```

## How

### 修改位置

**文件**: `brain/src/similarity.js`

**Line 163-172**: 更新 KRs 查询

```javascript
// BEFORE (Line 163-172)
const krsResult = await this.db.query(`
  SELECT
    kr.id, kr.title, kr.description, kr.status,
    o.id as okr_id, o.objective
  FROM key_results kr
  LEFT JOIN okrs o ON kr.okr_id = o.id
  WHERE kr.status IN ('active', 'in_progress')
  ORDER BY kr.updated_at DESC
  LIMIT 30
`);

// AFTER
const krsResult = await this.db.query(`
  SELECT
    kr.id, kr.title, kr.target_value, kr.current_value, kr.unit, kr.status,
    g.id as goal_id, g.title as goal_title
  FROM key_results kr
  LEFT JOIN goals g ON kr.goal_id = g.id AND g.type = 'objective'
  WHERE kr.status IN ('active', 'in_progress')
  ORDER BY kr.updated_at DESC
  LIMIT 30
`);
```

**Line 174-186**: 更新实体构建逻辑

```javascript
// BEFORE
krsResult.rows.forEach(kr => {
  entities.push({
    level: 'kr',
    id: kr.id,
    title: kr.title,
    description: kr.description || '',
    status: kr.status,
    text: `${kr.title} ${kr.description || ''}`,
    metadata: {
      okr_id: kr.okr_id,
      okr_objective: kr.objective
    }
  });
});

// AFTER
krsResult.rows.forEach(kr => {
  // Build text: combine title with target/current values
  const valueText = kr.target_value ?
    `target: ${kr.current_value || 0}/${kr.target_value} ${kr.unit || ''}` : '';

  entities.push({
    level: 'kr',
    id: kr.id,
    title: kr.title,
    description: valueText,
    status: kr.status,
    text: `${kr.title} ${valueText}`,
    metadata: {
      goal_id: kr.goal_id,
      goal_title: kr.goal_title,
      target_value: kr.target_value,
      current_value: kr.current_value,
      unit: kr.unit
    }
  });
});
```

## Success Criteria

**验收标准**：

1. **代码修改**:
   - ✅ SQL 查询不再引用 `okrs` 表
   - ✅ 正确 JOIN `goals` 表并过滤 `type = 'objective'`
   - ✅ 字段映射更新：`okr_id → goal_id`, `objective → goal_title`

2. **功能测试**:
   - ✅ POST /api/brain/search-similar 不报错
   - ✅ 返回结果包含 KRs（如果数据库有数据）
   - ✅ KRs 的 metadata 包含 goal_id 和 goal_title

3. **单元测试**:
   - ✅ similarity.test.js 全部通过

4. **集成测试**:
   - ✅ 创建测试 KR 数据
   - ✅ 调用 search-similar API 能找到 KR
   - ✅ 相似度评分合理

## Files Changed

- `brain/src/similarity.js` - 修复 KRs 查询引用不存在的 okrs 表

## Version

Patch bump: 1.31.3 → 1.31.4
