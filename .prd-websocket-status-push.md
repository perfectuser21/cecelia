---
id: prd-websocket-status-push
version: 1.0.0
created: 2026-02-06
updated: 2026-02-06
changelog:
  - 1.0.0: 初始版本
---

# PRD: 添加 WebSocket 状态推送

## 需求来源

Cecelia 自动化任务：为 Brain 添加 WebSocket 支持,实现任务状态的实时推送到前端

## 功能描述

当前 Brain 通过轮询 API 获取任务状态，延迟明显。需要添加 WebSocket 支持，在任务状态变化时主动推送到前端，实现：

1. **任务状态实时推送**：任务创建、开始、进度更新、完成、失败时推送
2. **Executor 资源状态推送**：可用席位、活跃任务数实时更新
3. **客户端自动重连**：断线后自动重连
4. **多客户端支持**：支持多个前端同时连接

## 涉及文件

### 新增文件

- `brain/src/websocket.js` - WebSocket 服务器
- `brain/src/events/taskEvents.js` - 任务事件发布器
- `frontend/src/services/websocket.ts` - 前端 WebSocket 客户端
- `frontend/src/hooks/useTaskStatus.ts` - React Hook for real-time task status

### 修改文件

- `brain/src/index.js` - 集成 WebSocket 服务器
- `brain/src/tick.js` - 添加事件发布（任务状态变化时）
- `brain/src/executor.js` - 添加事件发布
- `frontend/src/pages/CommandCenter/components/ExecutionStatusPanel.tsx` - 使用 WebSocket 数据

## 技术方案

### 后端架构

```javascript
// WebSocket 服务器（使用 ws 库）
const WebSocket = require('ws');

// 事件类型
const EVENTS = {
  TASK_CREATED: 'task:created',
  TASK_STARTED: 'task:started',
  TASK_PROGRESS: 'task:progress',
  TASK_COMPLETED: 'task:completed',
  TASK_FAILED: 'task:failed',
  EXECUTOR_STATUS: 'executor:status'
};

// 广播到所有连接的客户端
function broadcast(event, data) {
  wss.clients.forEach(client => {
    if (client.readyState === WebSocket.OPEN) {
      client.send(JSON.stringify({ event, data, timestamp: new Date().toISOString() }));
    }
  });
}
```

### 前端架构

```typescript
// WebSocket 客户端（自动重连）
class WebSocketClient {
  private ws: WebSocket | null = null;
  private reconnectTimer: NodeJS.Timeout | null = null;

  connect() {
    this.ws = new WebSocket(`ws://localhost:5221/ws`);

    this.ws.onmessage = (event) => {
      const { event: type, data } = JSON.parse(event.data);
      this.handleMessage(type, data);
    };

    this.ws.onclose = () => {
      this.reconnect();
    };
  }

  reconnect() {
    this.reconnectTimer = setTimeout(() => this.connect(), 3000);
  }
}

// React Hook
function useTaskStatus(taskId?: string) {
  const [tasks, setTasks] = useState<Task[]>([]);

  useEffect(() => {
    const ws = new WebSocketClient();
    ws.on('task:created', (task) => {
      setTasks(prev => [...prev, task]);
    });
    // ...
  }, []);

  return { tasks };
}
```

### 集成点

1. **tick.js** - 任务派发后发布 `task:started` 事件
2. **executor.js** - 任务完成/失败时发布事件
3. **API endpoints** - 创建任务时发布 `task:created` 事件

## 消息格式

```typescript
interface WebSocketMessage {
  event: string;
  data: {
    taskId?: string;
    runId?: string;
    status?: 'queued' | 'running' | 'completed' | 'failed';
    progress?: number;  // 0-100
    activeCount?: number;
    availableSlots?: number;
  };
  timestamp: string;
}
```

## 成功标准

1. 前端连接后能收到任务状态推送
2. 任务从 queued → running → completed 全程实时显示
3. 断网后重连能恢复接收推送
4. 多客户端同时连接正常工作
5. ExecutionStatusPanel 使用 WebSocket 数据（不再轮询）

## 非目标

- 不实现房间/频道机制（所有客户端收到所有消息）
- 不实现客户端认证（内网使用，暂无需）
- 不实现消息持久化（只推送实时状态）
- 不实现 Socket.IO（使用原生 WebSocket）

## 环境变量

```bash
# .env
CECELIA_WS_PORT=5221  # 与 HTTP 端口共用或单独端口
CECELIA_WS_ENABLED=true
```

## 测试计划

1. **单客户端测试**
   - 前端连接 WebSocket
   - 创建一个任务
   - 验证收到 task:created, task:started, task:completed 事件

2. **多客户端测试**
   - 2 个浏览器窗口同时打开
   - 在一个窗口创建任务
   - 验证两个窗口都收到推送

3. **重连测试**
   - 连接后重启 Brain
   - 验证客户端自动重连

4. **并发测试**
   - 同时创建 5 个任务
   - 验证所有状态变化都被推送

## 验收清单

- [ ] WebSocket 服务器启动并监听
- [ ] 任务创建时发送 task:created 事件
- [ ] 任务状态变化时发送对应事件
- [ ] 前端能接收并显示实时状态
- [ ] 断线后自动重连成功
- [ ] ExecutionStatusPanel 不再使用轮询

## 风险

| 风险 | 影响 | 缓解 |
|------|------|------|
| WebSocket 连接不稳定 | 中 | 实现自动重连 + 心跳检测 |
| 消息风暴（大量任务同时推送） | 低 | 后期可添加消息合并 |
| 内存泄漏（客户端连接累积） | 中 | 定期清理僵尸连接 |

## 参考

- [ws 库文档](https://github.com/websockets/ws)
- 已有实现：ExecutionStatusPanel 目前使用轮询（可对比优化）
