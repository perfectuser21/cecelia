---
id: prd-websocket-status-push
version: 1.0.0
created: 2026-02-06
updated: 2026-02-06
changelog:
  - 1.0.0: 初始版本
---

# PRD - WebSocket 状态推送

## 需求来源

任务来自 Brain 自动调度，需要实现后端通过 WebSocket 推送执行进度变更到前端。

## 功能描述

在 Brain 后端实现 WebSocket 服务，当任务执行状态发生变化时，主动推送更新到所有连接的客户端。

### 核心功能

1. **WebSocket 服务器** - 在 Brain (5221) 上启动 WebSocket 服务
2. **状态推送** - 当 runs 表的 status/progress 更新时，自动推送到客户端
3. **连接管理** - 管理多个客户端连接，支持断线重连
4. **消息格式** - 统一的 JSON 消息格式

## 涉及文件

**Backend (Brain - Node.js)**:
- `src/services/websocket.ts` - 新建 WebSocket 服务
- `src/services/runs.ts` - 修改，添加状态变更时的推送逻辑
- `src/server.ts` - 修改，集成 WebSocket 服务
- `src/types/websocket.ts` - 新建 WebSocket 消息类型定义

**API Endpoint**:
- `ws://localhost:5221/ws` - WebSocket 连接端点

## 成功标准

- [ ] WebSocket 服务正常启动在 Brain 端口 (5221)
- [ ] 客户端可以连接到 `/ws` 端点
- [ ] 当任务状态更新时，所有连接的客户端收到推送
- [ ] 支持多客户端同时连接
- [ ] 断线重连机制工作正常
- [ ] 消息格式清晰，包含完整的任务信息

## 非目标

- 不实现前端 WebSocket 客户端（前端在其他 PR 中处理）
- 不实现历史消息回放（仅推送实时更新）
- 不实现认证/鉴权（后续迭代）

## 技术方案

### WebSocket 库

使用 `ws` 库（Node.js 标准 WebSocket 实现）：

```bash
npm install ws
npm install --save-dev @types/ws
```

### 消息格式

```typescript
interface WSMessage {
  type: 'run_update' | 'run_complete' | 'run_failed';
  data: {
    id: string;
    status: 'queued' | 'running' | 'completed' | 'failed';
    progress?: number;
    task_id?: string;
    agent?: string;
    started_at?: string;
    completed_at?: string;
    error?: string;
  };
  timestamp: string;
}
```

### 集成点

在 `runs.ts` 中，每次更新状态时调用 WebSocket 推送：

```typescript
// 更新数据库后
await db.query('UPDATE runs SET status=$1 WHERE id=$2', [status, id]);

// 推送到 WebSocket 客户端
websocketService.broadcast({
  type: 'run_update',
  data: runData,
  timestamp: new Date().toISOString()
});
```

### 架构

```
Brain Server (5221)
  ├── HTTP API (/api/...)
  └── WebSocket (/ws)
        ├── Connection Manager
        ├── Message Broadcaster
        └── Event Listeners (runs 表变更)
```

## 验收清单

1. WebSocket 服务在 5221 端口正常启动
2. 使用 `wscat` 或浏览器测试连接成功
3. 手动更新 runs 表状态，客户端收到推送
4. 多个客户端同时连接，都能收到消息
5. 客户端断开重连后能继续接收消息
6. 无内存泄漏（长时间运行稳定）

## 测试方案

### 手动测试

```bash
# 1. 启动 Brain
npm start

# 2. 连接 WebSocket（新终端）
npx wscat -c ws://localhost:5221/ws

# 3. 手动触发状态变更（新终端）
psql -h localhost -U cecelia cecelia -c "UPDATE runs SET status='running' WHERE id='test-run-1'"

# 4. 验证 wscat 收到消息
```

### 自动化测试

创建 `tests/websocket.test.ts`：
- 测试连接建立
- 测试消息推送
- 测试多客户端
- 测试断线重连

## 安全考虑

- 当前版本不实现认证（内网使用）
- 仅允许本地或内网 IP 连接
- 未来版本添加 JWT 认证

## 性能考虑

- 使用消息队列避免推送阻塞数据库操作
- 限制每个客户端的连接数
- 实现消息限流（避免推送风暴）
