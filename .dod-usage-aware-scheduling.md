---
id: dod-usage-aware-scheduling
version: 1.0.0
created: 2026-02-27
updated: 2026-02-27
changelog:
  - 1.0.0: 初始版本
---

# DoD：Claude Max 账号用量感知调度

## 验收清单

### 数据库
- [ ] migration 085_account_usage_cache.sql 已创建
- [ ] `account_usage_cache` 表包含字段：account_id, five_hour_pct, seven_day_pct, resets_at, extra_used, fetched_at
  - Test: `SELECT * FROM account_usage_cache;` 不报错

### 新模块 account-usage.js
- [ ] `getAccountUsage()` 能读取3个账号的用量并缓存到 DB
  - Test: 调用后 account_usage_cache 表有3行数据
- [ ] 缓存 TTL 10分钟，TTL 内不重复调用 Anthropic API
  - Test: 连续调用两次，第二次不发 HTTP 请求
- [ ] API 调用失败时降级使用旧缓存，不抛出异常
  - Test: token 无效时返回旧数据或默认值
- [ ] `selectBestAccount()` 返回用量最低的账号
  - Test: account1=50%, account2=10%, account3=30% → 返回 'account2'
- [ ] 所有账号 >= 80% 时返回 null（触发 MiniMax 降级）
  - Test: 三个账号均设为 90% → 返回 null

### executor.js 修改
- [ ] provider=anthropic 且无固定 credentials 配置时，自动调用 selectBestAccount()
  - Test: 派发任务后 log 显示 "[account-usage] Selected accountX"
- [ ] selectBestAccount() 返回 null 时，provider 自动切换为 minimax
  - Test: 三个账号模拟满载 → provider 切为 minimax

### Brain API
- [ ] `GET /api/brain/account-usage` 返回3个账号的实时用量
  - Test: `curl localhost:5221/api/brain/account-usage` 返回 JSON
- [ ] `POST /api/brain/account-usage/refresh` 强制刷新缓存
  - Test: 调用后 fetched_at 更新到当前时间

### 测试
- [ ] `npm test` 通过（无新增失败）
