name: Brain CI

on:
  push:
    branches: [main]
    paths:
      - 'packages/brain/**'
      - 'scripts/**'
      - 'DEFINITION.md'
      - '.brain-versions'
  pull_request:
    branches: [main]
    paths:
      - 'packages/brain/**'
      - 'scripts/**'
      - 'DEFINITION.md'
      - '.brain-versions'
  workflow_dispatch:

concurrency:
  group: brain-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'push' }}

jobs:
  version-check:
    if: github.event_name == 'pull_request'
    name: Version Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check brain/package.json version updated
        run: |
          set -e
          PKGJSON="packages/brain/package.json"

          if [ ! -f "$PKGJSON" ]; then
            echo "No $PKGJSON found, skipping"
            exit 0
          fi

          BASE_VERSION=$(git show origin/${{ github.base_ref }}:$PKGJSON 2>/dev/null | jq -r '.version' || echo "")

          if [ -z "$BASE_VERSION" ] || [ "$BASE_VERSION" = "null" ]; then
            echo "Could not read base branch version, skipping check"
            exit 0
          fi

          CURRENT_VERSION=$(jq -r '.version' "$PKGJSON")

          echo "Base branch version: $BASE_VERSION"
          echo "Current version: $CURRENT_VERSION"

          if [ "$BASE_VERSION" = "$CURRENT_VERSION" ]; then
            echo "Version not updated in $PKGJSON"
            exit 1
          else
            echo "Version updated: $BASE_VERSION -> $CURRENT_VERSION"
          fi

  facts-check:
    name: Facts Consistency
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check facts consistency
        run: node scripts/facts-check.mjs

      - name: Check version sync
        run: bash scripts/check-version-sync.sh

  brain-test:
    name: Brain Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read

    services:
      postgres:
        image: pgvector/pgvector:pg15
        env:
          POSTGRES_DB: cecelia
          POSTGRES_USER: cecelia
          POSTGRES_PASSWORD: cecelia_ci
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DB_HOST: localhost
      DB_PORT: 5432
      DB_NAME: cecelia
      DB_USER: cecelia
      DB_PASSWORD: cecelia_ci
      ENV_REGION: us

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: packages/brain
        run: npm ci

      - name: Run migrations
        working-directory: packages/brain
        run: node src/migrate.js

      - name: Run Brain tests with coverage
        working-directory: packages/brain
        run: npx vitest run --exclude='src/__tests__/blocks.test.js' --reporter=verbose --coverage

      - name: GoldenPath E2E
        working-directory: packages/brain
        run: bash scripts/goldenpath-check.sh

  ci-passed:
    needs: [version-check, facts-check, brain-test]
    if: >-
      github.event_name == 'pull_request' && always()
      && needs.brain-test.result == 'success'
      && needs.facts-check.result == 'success'
      && (needs.version-check.result == 'success' || needs.version-check.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Brain CI Passed
        run: echo "Brain CI checks passed"
