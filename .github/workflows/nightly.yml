name: Nightly Regression

on:
  schedule:
    # ÊØèÂ§© UTC 18:00 (Âåó‰∫¨Êó∂Èó¥ 02:00)
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'ÊµãËØïÊ®°Âºè'
        required: false
        default: 'nightly'
        type: choice
        options:
          - nightly
          - release
          - pr

jobs:
  regression:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Regression Tests
        run: |
          MODE="${{ github.event.inputs.mode || 'nightly' }}"
          bash scripts/run-regression.sh "$MODE"

      - name: DevGate Metrics
        id: metrics
        run: |
          # Êî∂ÈõÜÊú¨Êúà DevGate ÊåáÊ†á
          MONTH=$(date +%Y-%m)
          echo "üìä Collecting DevGate Metrics for $MONTH"

          # ÁîüÊàê JSON Êä•Âëä
          bash scripts/devgate/metrics.sh --month "$MONTH" --format json > devgate-metrics.json || true

          # ËæìÂá∫‰∫∫Á±ªÂèØËØªÊ†ºÂºè
          bash scripts/devgate/metrics.sh --month "$MONTH" || true

          # ‰∏ä‰º†‰∏∫ artifact
          echo "metrics_month=$MONTH" >> "$GITHUB_OUTPUT"

      - name: Upload Metrics
        uses: actions/upload-artifact@v4
        with:
          name: devgate-metrics-${{ steps.metrics.outputs.metrics_month }}
          path: devgate-metrics.json
          retention-days: 90

  notify:
    needs: [regression]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Notify Result
        env:
          REGRESSION_RESULT: ${{ needs.regression.result }}
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          if [ -z "$FEISHU_WEBHOOK" ]; then
            echo "‚ö†Ô∏è FEISHU_WEBHOOK not configured, skipping notification"
            exit 0
          fi

          if [ "$REGRESSION_RESULT" = "success" ]; then
            TITLE="‚úÖ Nightly Regression ÈÄöËøá"
            COLOR="green"
          else
            TITLE="‚ùå Nightly Regression Â§±Ë¥•"
            COLOR="red"
          fi

          curl -s -X POST "$FEISHU_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "interactive",
              "card": {
                "header": {
                  "title": {"tag": "plain_text", "content": "'"$TITLE"'"},
                  "template": "'"$COLOR"'"
                },
                "elements": [
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**Repo**: ${{ github.repository }}\n**Branch**: ${{ github.ref_name }}\n**Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                    }
                  }
                ]
              }
            }'

          echo "üì® Notification sent to Feishu"
