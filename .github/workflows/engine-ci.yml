name: Engine CI/CD

on:
  push:
    branches: [main, develop, "cp-*", "feature/*"]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy after successful build'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '18'
  BRAIN_URL: 'http://localhost:5221'

jobs:
  # Quality Gates - Run in parallel
  typecheck:
    name: TypeScript Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript check
        run: npm run typecheck

  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check Prettier formatting
        run: npm run format:check

  test:
    name: Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-type: [unit, integration, e2e]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ${{ matrix.test-type }} tests
        run: npm run test:${{ matrix.test-type }}

      - name: Upload coverage
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: engine-coverage

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level=moderate

      - name: Check for vulnerable dependencies
        run: npm run deps:audit

  # Build after all quality gates pass
  build:
    name: Build
    needs: [typecheck, lint, test, security]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build all packages
        run: npm run build:all

      - name: Build CLI
        run: |
          cd cli && npm run build
          cd ..

      - name: Build SDK
        run: |
          cd sdk && npm run build
          cd ..

      - name: Build Utils
        run: |
          cd utils && npm run build
          cd ..

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: engine-build
          path: |
            cli/dist/
            sdk/dist/
            utils/dist/
            dist/

      - name: Bundle size check
        run: npm run build:analyze

  # Documentation generation
  docs:
    name: Generate Documentation
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate API docs
        run: npm run docs:generate

      - name: Upload documentation
        uses: actions/upload-artifact@v3
        with:
          name: engine-docs
          path: docs/api/

  # Integration with Brain
  brain-integration:
    name: Brain Integration Test
    needs: build
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: cecelia_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start Brain mock server
        run: |
          cd tests/mocks
          npm run brain:mock &
          sleep 5

      - name: Test Brain SDK
        run: npm run test:brain-integration

      - name: Test CLI Brain commands
        run: npm run test:cli-brain

  # Performance benchmarks
  benchmark:
    name: Performance Benchmarks
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run benchmarks
        run: npm run benchmark

      - name: Store benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: benchmark-results.json

      - name: Compare with baseline
        run: npm run benchmark:compare

  # Release preparation
  release-prep:
    name: Prepare Release
    if: github.ref == 'refs/heads/main'
    needs: [build, docs, brain-integration, benchmark]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should-release: ${{ steps.check.outputs.should-release }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Check if release needed
        id: check
        run: |
          # Check for version changes
          if git diff HEAD~1 VERSION | grep -q '^+'; then
            echo "should-release=true" >> $GITHUB_OUTPUT
          else
            echo "should-release=false" >> $GITHUB_OUTPUT
          fi

      - name: Get version
        id: version
        run: echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Generate changelog
        if: steps.check.outputs.should-release == 'true'
        run: npm run changelog:generate

  # Deploy if requested
  deploy:
    name: Deploy
    if: |
      (github.event.inputs.deploy == 'true' || github.ref == 'refs/heads/main') &&
      needs.release-prep.outputs.should-release == 'true'
    needs: release-prep
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: engine-build

      - name: Setup deployment
        run: |
          echo "Deploying version ${{ needs.release-prep.outputs.version }}"
          # Add deployment scripts here

      - name: Notify Brain of deployment
        run: |
          curl -X POST ${{ env.BRAIN_URL }}/api/brain/deployment \
            -H "Content-Type: application/json" \
            -d '{
              "component": "cecelia-engine",
              "version": "${{ needs.release-prep.outputs.version }}",
              "environment": "production",
              "status": "completed"
            }'

  # Report results to Brain
  report-to-brain:
    name: Report CI Results to Brain
    if: always()
    needs: [typecheck, lint, test, security, build]
    runs-on: ubuntu-latest
    steps:
      - name: Collect job results
        run: |
          echo "Collecting CI results..."
          echo "TypeScript: ${{ needs.typecheck.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Build: ${{ needs.build.result }}"

      - name: Send results to Brain
        run: |
          curl -X POST ${{ env.BRAIN_URL }}/api/brain/ci-results \
            -H "Content-Type: application/json" \
            -d '{
              "repository": "cecelia-engine",
              "branch": "${{ github.ref_name }}",
              "commit": "${{ github.sha }}",
              "results": {
                "typecheck": "${{ needs.typecheck.result }}",
                "lint": "${{ needs.lint.result }}",
                "test": "${{ needs.test.result }}",
                "security": "${{ needs.security.result }}",
                "build": "${{ needs.build.result }}"
              },
              "timestamp": "'$(date -Iseconds)'"
            }'