---
id: dod-cp-02280916-memory-closure-chain
version: 1.0.0
created: 2026-02-28
updated: 2026-02-28
changelog:
  - 1.0.0: 初始版本
---

# DoD：memory_stream → learning → task 三段闭环

## 验收清单

- [ ] **MC-1** migration 090 创建，memory_stream 新增 status / resolved_by_task_id / resolved_at 三字段
  - Test: SELECT column_name FROM information_schema.columns WHERE table_name='memory_stream' AND column_name IN ('status','resolved_by_task_id','resolved_at')

- [ ] **MC-2** migration 090 创建，learnings 新增 source_memory_id 字段（UUID，指向 memory_stream.id）
  - Test: SELECT column_name FROM information_schema.columns WHERE table_name='learnings' AND column_name='source_memory_id'

- [ ] **MC-3** `recordLearning()` 写 failure_pattern learning 时，同步在 memory_stream 插入一条 status='active' 记录，并将 id 存入 learning.source_memory_id
  - Test: 调用 recordLearning 后，learnings.source_memory_id 非 NULL，对应 memory_stream 记录 status='active'

- [ ] **MC-4** execution-callback：dev 任务 completed 后，根据 task title 在 failure_pattern learnings 中做关键词匹配，找到相关条目，将对应 memory_stream 记录标记为 resolved
  - Test: 模拟 dev 任务完成 → 相关 memory_stream.status = 'resolved'，resolved_by_task_id = task.id

- [ ] **MC-5** selfcheck.js EXPECTED_SCHEMA_VERSION 更新为 '090'
  - Test: node src/selfcheck.js 输出 PASS

- [ ] **MC-6** 所有新增单元测试通过（npm test）
  - Test: npm test 全绿

- [ ] **MC-7** facts-check 和 version-sync 通过
  - Test: node scripts/facts-check.mjs && bash scripts/check-version-sync.sh
