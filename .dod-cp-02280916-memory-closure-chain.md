---
id: dod-cp-02280916-memory-closure-chain
version: 1.1.0
created: 2026-02-28
updated: 2026-02-28
changelog:
  - 1.1.0: 补充 Test 字段，通过 DevGate 映射检查
  - 1.0.0: 初始版本
---

# DoD：memory_stream → learning → task 三段闭环

## 验收清单

- [ ] **MC-1** migration 090 创建，memory_stream 新增 status / resolved_by_task_id / resolved_at 三字段
  - Test: packages/brain/migrations/090_memory_closure_chain.sql 存在且含 ADD COLUMN status / resolved_by_task_id / resolved_at

- [ ] **MC-2** migration 090 创建，learnings 新增 source_memory_id 字段（UUID，指向 memory_stream.id）
  - Test: packages/brain/migrations/090_memory_closure_chain.sql 含 ADD COLUMN source_memory_id

- [ ] **MC-3** recordLearning() 写 failure_pattern learning 时，同步在 memory_stream 插入一条 status=active 记录，并将 id 存入 learning.source_memory_id
  - Test: src/__tests__/memory-closure-chain.test.js MC-3-1 / MC-3-2

- [ ] **MC-4** execution-callback：dev 任务 completed 后，根据 task title 在 failure_pattern learnings 中做关键词匹配，找到相关条目，将对应 memory_stream 记录标记为 resolved
  - Test: src/__tests__/memory-closure-chain.test.js MC-4-1 / MC-4-2 / MC-4-3 / MC-4-4 / MC-4-5

- [ ] **MC-5** selfcheck.js EXPECTED_SCHEMA_VERSION 更新为 090
  - Test: src/__tests__/selfcheck.test.js 断言 EXPECTED_SCHEMA_VERSION 为 090

- [ ] **MC-6** 所有新增单元测试通过（npm test）
  - Test: src/__tests__/memory-closure-chain.test.js 7 个测试全部通过

- [ ] **MC-7** facts-check 和 version-sync 通过
  - Test: node scripts/facts-check.mjs 输出 All facts consistent
