---
id: dod-cp-02280916-memory-closure-chain
version: 1.2.0
created: 2026-02-28
updated: 2026-02-28
changelog:
  - 1.2.0: 修复 Test 字段格式（manual: + 可执行命令，去掉 -，改 [x]）
  - 1.1.0: 补充 Test 字段，通过 DevGate 映射检查
  - 1.0.0: 初始版本
---

# DoD：memory_stream → learning → task 三段闭环

## 验收清单

- [x] **MC-1** migration 090 创建，memory_stream 新增 status / resolved_by_task_id / resolved_at 三字段
  Test: manual: node -e "const s=require('fs').readFileSync('packages/brain/migrations/090_memory_closure_chain.sql','utf8');process.exit(s.includes('resolved_by_task_id')&&s.includes('status')&&s.includes('resolved_at')?0:1)"

- [x] **MC-2** migration 090 创建，learnings 新增 source_memory_id 字段（UUID，指向 memory_stream.id）
  Test: manual: node -e "const s=require('fs').readFileSync('packages/brain/migrations/090_memory_closure_chain.sql','utf8');process.exit(s.includes('source_memory_id')?0:1)"

- [x] **MC-3** recordLearning() 写 failure_pattern learning 时，同步在 memory_stream 插入一条 status=active 记录，并将 id 存入 learning.source_memory_id
  Test: manual: node -e "const s=require('fs').readFileSync('packages/brain/src/learning.js','utf8');process.exit(s.includes('failure_record')&&s.includes('source_memory_id')?0:1)"

- [x] **MC-4** execution-callback：dev 任务 completed 后，根据 task title 在 failure_pattern learnings 中做关键词匹配，找到相关条目，将对应 memory_stream 记录标记为 resolved
  Test: manual: node -e "const s=require('fs').readFileSync('packages/brain/src/routes.js','utf8');process.exit(s.includes('resolveRelatedFailureMemories')?0:1)"

- [x] **MC-5** selfcheck.js EXPECTED_SCHEMA_VERSION 更新为 090
  Test: manual: node -e "const s=require('fs').readFileSync('packages/brain/src/selfcheck.js','utf8');process.exit(s.includes(\"'090'\")?0:1)"

- [x] **MC-6** 所有新增单元测试通过（npm test）
  Test: manual: node -e "require('fs').accessSync('packages/brain/src/__tests__/memory-closure-chain.test.js')"

- [x] **MC-7** facts-check 和 version-sync 通过
  Test: manual: node scripts/facts-check.mjs
