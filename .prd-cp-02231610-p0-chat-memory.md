---
id: prd-p0-chat-memory
version: 1.0.0
created: 2026-02-23
updated: 2026-02-23
changelog:
  - 1.0.0: 初始版本
---

# PRD: P0 Cecelia 聊天记忆修复

## 背景

Cecelia 前端聊天存在两个 P0 缺陷，导致"不认识人、不知道目标"：

1. **OKR 盲区**：`memory-retriever.js` 的 `loadActiveProfile` 在 `chat` 模式下直接 `return ''`，
   Cecelia 聊天时完全不知道当前 OKR 是什么目标。

2. **多轮历史未生效**：PR #465 已合并到 develop，multi-turn messages 逻辑已在代码里，
   但当前 pm2 跑的分支不包含这些改动。通过基于 develop 创建新分支，确保这些改动生效。

## 改动内容

### 改动 1：memory-retriever.js — 修 chat 模式 OKR 盲区

删除 `loadActiveProfile` 里的 `if (mode === 'chat') return ''` 这行，
让 chat 模式也能注入当前 OKR goals 摘要（top-3）。

### 改动 2（已在 develop）：orchestrator-chat.js — 多轮历史

PR #465 已经实现：
- `callMiniMax` 接受 `historyMessages` 参数，注入到 MiniMax messages 数组
- `handleChat` 接受第三个参数 `messages = []`
- `buildStatusSummary` 每次都调用（不只限 QUERY_STATUS/QUESTION）
- `recordChatEvent` 存完整 user_message（不截断）

## 完成标准

1. `chat` 模式调用 `buildMemoryContext` 时，返回的 block 包含 OKR goals 信息
2. `handleChat(msg, ctx, messages)` 正确把历史传给 MiniMax
3. `buildStatusSummary` 每次都调用
4. 现有测试全部通过
5. PR 合并后 pm2 restart 生效
