# DoD: Vector Search Phase 1 Implementation

**ç‰ˆæœ¬**: 1.0.0
**å¯¹åº” PRD**: .prd-vector-search-phase1.md

---

## âœ… éªŒæ”¶æ¸…å•

### 1. æ•°æ®åº“è¿ç§» (DB Agent)

#### 1.1 Migration æ–‡ä»¶
- [ ] æ–‡ä»¶åˆ›å»ºï¼š`brain/migrations/028_add_embeddings.sql`
- [ ] åŒ…å« `CREATE EXTENSION vector`
- [ ] åŒ…å«ä¸‰ä¸ªè¡¨çš„ `ALTER TABLE ... ADD COLUMN embedding vector(3072)`
- [ ] åŒ…å«ä¸‰ä¸ªå‘é‡ç´¢å¼•çš„åˆ›å»ºè¯­å¥
- [ ] Test: Migration å¯ä»¥æˆåŠŸæ‰§è¡Œï¼ˆ`npm run migrate`ï¼‰

#### 1.2 pgvector æ‰©å±•
- [ ] Docker é•œåƒåŒ…å« pgvector
- [ ] `docker exec cecelia-postgres psql -U cecelia -d cecelia -c "SELECT * FROM pg_extension WHERE extname='vector'"`
- [ ] Test: æ‰©å±•æŸ¥è¯¢è¿”å›ç»“æœ

#### 1.3 Schema éªŒè¯
- [ ] `\d tasks` æ˜¾ç¤º `embedding vector(3072)` åˆ—
- [ ] `\d projects` æ˜¾ç¤º `embedding vector(3072)` åˆ—
- [ ] `\d goals` æ˜¾ç¤º `embedding vector(3072)` åˆ—
- [ ] Test: Schema æ£€æŸ¥è„šæœ¬é€šè¿‡

---

### 2. Core ä»£ç æ”¹é€  (Core Agent)

#### 2.1 OpenAI é›†æˆ
- [ ] æ–‡ä»¶åˆ›å»ºï¼š`brain/src/openai-client.js`
- [ ] å¯¼å‡º `generateEmbedding(text)` æ–¹æ³•
- [ ] ä½¿ç”¨ `text-embedding-3-large` æ¨¡å‹
- [ ] å¤„ç† API é”™è¯¯ï¼ˆtry-catch + fallbackï¼‰
- [ ] Test: `openai-client.test.js` é€šè¿‡

#### 2.2 similarity.js æ”¹é€ 
- [ ] æ–°å¢æ–¹æ³•ï¼š`searchWithVectors(query, options)`
- [ ] æ”¯æŒ repo/repos/status/dateFrom/dateTo è¿‡æ»¤
- [ ] å®ç°æ··åˆæ£€ç´¢ï¼ˆ70% vector + 30% Jaccardï¼‰
- [ ] å‘é‡æœç´¢ä½¿ç”¨ `<=>` æ“ä½œç¬¦
- [ ] Test: `similarity-vectors.test.js` é€šè¿‡

#### 2.3 API ç«¯ç‚¹
- [ ] è·¯ç”±æ·»åŠ ï¼š`POST /api/brain/similarity/search`
- [ ] Request éªŒè¯ï¼ˆJoi schemaï¼‰
- [ ] Response æ ¼å¼æ­£ç¡®
- [ ] Error handlingï¼ˆOpenAI API å¤±è´¥é™çº§åˆ° Jaccardï¼‰
- [ ] Test: API é›†æˆæµ‹è¯•é€šè¿‡

---

### 3. æ•°æ®å›å¡« (Backfill Agent)

#### 3.1 å›å¡«è„šæœ¬
- [ ] æ–‡ä»¶åˆ›å»ºï¼š`brain/scripts/backfill-embeddings.js`
- [ ] æ‰¹é‡å¤„ç†ï¼ˆæ¯æ‰¹ 100 æ¡ï¼‰
- [ ] è¿›åº¦è®°å½•ï¼ˆconsole.log æ¯ 100 æ¡ï¼‰
- [ ] é”™è¯¯å¤„ç†ï¼ˆå¤±è´¥çš„è®°å½•è®°å½•åˆ°æ—¥å¿—ï¼‰
- [ ] Test: æ‰§è¡Œ `node brain/scripts/backfill-embeddings.js` æˆåŠŸ

#### 3.2 æ•°æ®å®Œæ•´æ€§
- [ ] æ‰€æœ‰ tasks çš„ `embedding IS NOT NULL`
- [ ] æ‰€æœ‰ projects çš„ `embedding IS NOT NULL`
- [ ] æ‰€æœ‰ goals çš„ `embedding IS NOT NULL`
- [ ] Test: `SELECT COUNT(*) FROM tasks WHERE embedding IS NULL` è¿”å› 0

---

### 4. æµ‹è¯• (Test Agent)

#### 4.1 å•å…ƒæµ‹è¯•
- [ ] æ–‡ä»¶åˆ›å»ºï¼š`brain/src/__tests__/openai-client.test.js`
- [ ] æ–‡ä»¶åˆ›å»ºï¼š`brain/src/__tests__/similarity-vectors.test.js`
- [ ] è¦†ç›–ç‡ > 80%
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ`npm test`ï¼‰
- [ ] Test: CI æµ‹è¯•é€šè¿‡

#### 4.2 é›†æˆæµ‹è¯•
- [ ] ç«¯åˆ°ç«¯æµç¨‹ï¼šç”¨æˆ·æŸ¥è¯¢ â†’ å‘é‡æ£€ç´¢ â†’ è¿”å›ç»“æœ
- [ ] Metadata è¿‡æ»¤æµ‹è¯•ï¼ˆrepo, status, dateï¼‰
- [ ] Fallback æµ‹è¯•ï¼ˆOpenAI API å¤±è´¥æ—¶é™çº§ï¼‰
- [ ] Test: E2E æµ‹è¯•é€šè¿‡

#### 4.3 æ€§èƒ½æµ‹è¯•
- [ ] æŸ¥è¯¢æ—¶é—´ < 500msï¼ˆ10,000 æ¡æ•°æ®ï¼‰
- [ ] å¹¶å‘æµ‹è¯•ï¼ˆ10 ä¸ªå¹¶å‘æŸ¥è¯¢ï¼‰
- [ ] Test: æ€§èƒ½åŸºå‡†æµ‹è¯•é€šè¿‡

---

### 5. æ–‡æ¡£ (Doc Agent)

#### 5.1 DEFINITION.md
- [ ] æ–°å¢ç« èŠ‚ï¼šã€ŒVector Search (Phase 1)ã€
- [ ] è®°å½•æ¶æ„ï¼šå•åº“ + repo è¿‡æ»¤
- [ ] è®°å½•æ¨¡å‹ï¼štext-embedding-3-large (3072 ç»´)
- [ ] è®°å½•æˆæœ¬ï¼š~$2.14/year
- [ ] Test: Facts Check é€šè¿‡

#### 5.2 MEMORY.md
- [ ] æ–°å¢æ¡ç›®ï¼šVector Search Phase 1 å®æ–½ç»†èŠ‚
- [ ] è®°å½•å…³é”®å†³ç­–ï¼ˆä¸ºä»€ä¹ˆé€‰ large æ¨¡å‹ï¼‰
- [ ] è®°å½•å‘ç‚¹ï¼ˆå¦‚æœ‰ï¼‰
- [ ] Test: æ‰‹åŠ¨å®¡æŸ¥

#### 5.3 API æ–‡æ¡£
- [ ] æ–‡ä»¶æ›´æ–°ï¼š`docs/API.md`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
- [ ] è®°å½•æ–°ç«¯ç‚¹ï¼š`POST /api/brain/similarity/search`
- [ ] ç¤ºä¾‹ Request/Response
- [ ] Test: æ‰‹åŠ¨å®¡æŸ¥

---

### 6. CI/CD

#### 6.1 Version Sync
- [ ] `brain/package.json` ç‰ˆæœ¬å·²æ›´æ–°ï¼ˆ1.31.4 â†’ 1.31.5ï¼‰
- [ ] `brain/package-lock.json` ç‰ˆæœ¬å·²åŒæ­¥
- [ ] `.brain-versions` æ–‡ä»¶å·²æ›´æ–°
- [ ] `DEFINITION.md` ä¸­ Brain ç‰ˆæœ¬å·²æ›´æ–°
- [ ] Test: `bash scripts/check-version-sync.sh` é€šè¿‡

#### 6.2 Facts Check
- [ ] `node scripts/facts-check.mjs` é€šè¿‡
- [ ] æ‰€æœ‰ code facts ä¸ DEFINITION.md ä¸€è‡´
- [ ] Test: CI Facts Check é€šè¿‡

#### 6.3 æµ‹è¯•è¦†ç›–
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] Test: CI Brain (Node.js) é€šè¿‡

---

## ğŸ¯ æœ€ç»ˆéªŒæ”¶

### åŠŸèƒ½éªŒæ”¶
```bash
# 1. å¯åŠ¨ Brain
docker-compose up -d

# 2. æµ‹è¯•å‘é‡æœç´¢ API
curl -X POST http://localhost:5221/api/brain/similarity/search \
  -H "Content-Type: application/json" \
  -d '{
    "query": "ç”¨æˆ·ç™»å½•åŠŸèƒ½",
    "topK": 5,
    "filters": {"repo": "cecelia/core"}
  }'

# é¢„æœŸï¼šè¿”å›ç›¸å…³ tasksï¼Œscore > 0.5
```

### æ€§èƒ½éªŒæ”¶
```bash
# æŸ¥è¯¢æ—¶é—´ < 500ms
time curl -X POST http://localhost:5221/api/brain/similarity/search \
  -H "Content-Type: application/json" \
  -d '{"query": "ç”¨æˆ·ç™»å½•åŠŸèƒ½", "topK": 5}'
```

### æ•°æ®å®Œæ•´æ€§éªŒæ”¶
```bash
# æ‰€æœ‰æ•°æ®å·²å›å¡«
docker exec cecelia-postgres psql -U cecelia -d cecelia -c \
  "SELECT COUNT(*) FROM tasks WHERE embedding IS NULL"
# é¢„æœŸï¼š0

docker exec cecelia-postgres psql -U cecelia -d cecelia -c \
  "SELECT COUNT(*) FROM tasks WHERE embedding IS NOT NULL"
# é¢„æœŸï¼š> 0
```

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•æ€»ç»“

- [ ] **DB**: Migration 028 + pgvector + Schema éªŒè¯
- [ ] **Core**: OpenAI é›†æˆ + similarity.js + API ç«¯ç‚¹
- [ ] **Backfill**: å›å¡«è„šæœ¬ + æ•°æ®å®Œæ•´æ€§
- [ ] **Test**: å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• + æ€§èƒ½æµ‹è¯•
- [ ] **Doc**: DEFINITION.md + MEMORY.md + API.md
- [ ] **CI**: Version Sync + Facts Check + æµ‹è¯•è¦†ç›–

**å…¨éƒ¨å‹¾é€‰åï¼ŒPR å¯ä»¥åˆå¹¶åˆ° developã€‚**
