---
id: prd-memory-retriever-quota
version: 1.0.0
created: 2026-03-01
updated: 2026-03-01
changelog:
  - 1.0.0: 初始版本
---

# PRD: 优化记忆检索系统（source 最小配额 + token 预算提升 + 动态权重调节）

## 背景

实测发现 47 个候选只注入了 12 个全是 conversation 类型，tasks/learnings/OKR 被挤出。
根本原因：
1. token 预算 1000 太小，导致截断
2. 无 source 配额限制，conversation 文档短，分数高，抢占全部 slot

## 目标

优化 `packages/brain/src/memory-retriever.js`，使记忆注入更均衡、更有用。

## 功能需求

### 1. Token 预算提升
- chat 模式 token 预算：1000 → 2500
- orchestrator-chat.js 传入 tokenBudget 也相应更新

### 2. Source 最小配额（quota-aware MMR）
- conversation：最多 4 条（上限，不是下限）
- tasks：至少 2 条（如果有候选的话）
- learnings：至少 2 条（如果有候选的话）
- OKR：至少 1 条（如果有候选的话）

实现思路：
- 先满足每个 source 的最小配额（按分数取 top-N）
- 剩余 token 按全局分数排序填充
- 配额已满的 source 不再参与抢位

### 3. 动态权重调节（query-aware）
在 MODE_WEIGHT 基础上叠加：

| 意图分类 | 关键词 | 权重调节 |
|----------|--------|----------|
| 任务类 | 任务/KR/进展/目标/工作/完成/派发/执行 | task×1.5, okr×1.5, conversation×0.6 |
| 情绪类 | 感受/情绪/想法/心情/觉得/开心/难过/压力 | conversation×1.5, learning×1.2, task×0.6 |
| 学习类 | 学到/记录/经验/总结/教训/发现/洞察 | learning×2.0, conversation×0.8 |
| 默认 | 其他 | 保持 MODE_WEIGHT 不变 |

实现：buildMemoryContext() 新增可选 query 参数，做简单关键词分类，动态调整得分权重。

## 验收标准

1. chat 模式 tokenBudget 变为 2500
2. 注入的记忆中 conversation 条数 ≤ 4
3. 有 tasks 候选时，至少注入 2 条 task
4. 有 learnings 候选时，至少注入 2 条 learning
5. 有 OKR 候选时，至少注入 1 条 OKR
6. 关键词意图分类正确触发不同权重
7. 所有现有测试通过（npm test --workspace packages/brain）

## 范围

- `packages/brain/src/memory-retriever.js` — 核心改动
- `packages/brain/src/orchestrator-chat.js` — tokenBudget 更新
- `packages/brain/package.json` — patch 版本 bump

## 不在范围

- learnings 向量搜索升级（Phase 2）
- docker-compose.yml OPENAI_API_KEY 读取修复（单独 PR）
