# PRD: Blocks API - 类 Notion Page Content 功能

## 背景

Cecelia 的 OKR 系统需要支持类似 Notion 的 Page Content 功能，让 Goal、Task、Project 等实体可以包含丰富的内容块（标题、段落、代码、待办等）。

数据库 `blocks` 表已创建（见 `perfect21-platform/docs/database/migrations/003_blocks.sql`）。

## 目标

在 cecelia-core/brain 添加 Blocks API，提供完整的 CRUD 接口。

## 功能需求

### 1. API 端点

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/blocks/:parentType/:parentId | 获取某实体的所有 blocks |
| POST | /api/blocks | 创建 block |
| PUT | /api/blocks/:id | 更新 block |
| DELETE | /api/blocks/:id | 删除 block |
| PUT | /api/blocks/reorder | 批量重排序 |

### 2. Block 类型

支持以下 block 类型：
- `paragraph` - 段落
- `heading_1/2/3` - 标题
- `bulleted_list` - 无序列表
- `numbered_list` - 有序列表
- `to_do` - 待办项
- `code` - 代码块
- `quote` - 引用
- `callout` - 提示框
- `divider` - 分割线
- `image` - 图片
- `toggle` - 折叠块

### 3. 数据结构

```typescript
interface Block {
  id: string;           // UUID
  parent_id: string;    // 父级 ID
  parent_type: string;  // 'goal' | 'task' | 'project' | 'block'
  type: string;         // block 类型
  content: object;      // 块内容（JSON）
  order_index: number;  // 排序索引
  created_at: string;
  updated_at: string;
}
```

### 4. 请求/响应示例

**创建 Block**
```json
POST /api/blocks
{
  "parent_id": "goal-uuid",
  "parent_type": "goal",
  "type": "heading_1",
  "content": {"text": "项目背景"},
  "order_index": 0
}
```

**获取 Blocks**
```json
GET /api/blocks/goal/goal-uuid

Response:
{
  "blocks": [
    {"id": "...", "type": "heading_1", "content": {"text": "项目背景"}, "order_index": 0},
    {"id": "...", "type": "paragraph", "content": {"text": "..."}, "order_index": 1}
  ]
}
```

## 非功能需求

- 响应时间 < 100ms
- 支持嵌套 blocks（toggle 内的子块）

## 验收标准

1. [ ] 所有 CRUD 接口正常工作
2. [ ] 支持按 parent_id 和 parent_type 查询
3. [ ] 支持批量重排序
4. [ ] 有基本的参数校验
5. [ ] 有单元测试覆盖

## 技术方案

在 `brain/src/routes.js` 添加 blocks 相关路由，复用现有的数据库连接（`db.js`）。

## 数据库引用

Schema 定义：`perfect21-platform/docs/database/SCHEMA.md`
Migration：`perfect21-platform/docs/database/migrations/003_blocks.sql`
