================================================================================
Cecelia Core - Tick 启动稳定性与可观测性分析
================================================================================

分析时间: 2026-02-18
分析工具: Claude Code + File Search + Grep
分析范围: /home/xx/perfect21/cecelia/core

================================================================================
执行摘要
================================================================================

✅ 现状：启动有重试机制（3 次，10 秒间隔）
❌ 问题：缺少 API 可观测性

关键发现：
1. initTickLoop() 将启动错误记录到 working_memory.startup_errors
2. 没有 API 端点直接暴露这些错误
3. /api/brain/tick/status 不显示启动状态
4. 无法快速诊断启动失败原因

================================================================================
启动流程分析（6 个步骤）
================================================================================

Step 1: Alertness 初始化 (代码行: tick.js L259)
  - 失败原因: collectMetrics 失败
  - 处理: try/catch，失败不阻断
  - 可观测性: 无 DB 记录

Step 2: 孤儿进程清理 (代码行: tick.js L266)
  - 失败原因: ps 命令失败、权限问题
  - 处理: try/catch，失败不阻断
  - 可观测性: 无 DB 记录

Step 3: 孤儿任务同步 (代码行: tick.js L271)
  - 失败原因: DB 查询失败、逻辑错误
  - 处理: try/catch，失败不阻断
  - 可观测性: 无 DB 记录

Step 4: 事件表初始化 (代码行: tick.js L284)
  - 失败原因: DB 不可用、Schema 不对
  - 处理: 重试 3 次，每次 10 秒
  - 可观测性: 记录到 startup_errors

Step 5: 环境变量检查 (代码行: tick.js L287)
  - 检查: CECELIA_TICK_ENABLED=true
  - 处理: 同上（重试）
  - 可观测性: 同上（DB 记录）

Step 6: 启动 Tick Loop (代码行: tick.js L297)
  - 失败原因: 同 Step 4-5
  - 处理: 同上（重试）
  - 可观测性: 同上（DB 记录）

================================================================================
startup_errors 数据结构
================================================================================

存储位置: working_memory 表，key = 'startup_errors'

JSON 格式:
{
  "errors": [
    {"ts": "2026-02-18T...", "error": "...", "attempt": 1}
  ],
  "last_error_at": "2026-02-18T...",
  "total_failures": 3
}

特点：
✓ 保留最近 20 条错误
✓ 累计计数（total_failures）
✗ 没有 TTL（永久保存）
✗ 没有 API 暴露

写入逻辑: _recordStartupError(attempt, errMessage) [tick.js L227]
- 读取现有 startup_errors
- 追加新错误
- 保留最近 20 条
- 写回数据库
- 失败不阻断重试

================================================================================
可观测性缺口（6 个）
================================================================================

缺口 1: 无 API 暴露启动错误
  现象: 无法通过 HTTP API 查询启动失败原因
  影响: 需要直接查 DB，无法监控面板展示
  建议: Task 1 - /api/brain/startup/diagnostics 端点

缺口 2: 启动状态不在 tick/status 中
  现象: /api/brain/tick/status 不显示启动是否成功
  影响: 无法一键了解系统启动状态
  建议: Task 2 - 增强 tick/status 返回 startup 字段

缺口 3: 无主动告警机制
  现象: 启动失败发出事件，但没有告警 API
  影响: 启动失败可能被忽略
  建议: Task 3 - 启动失败告警 API

缺口 4: 启动日志无持久化
  现象: 启动信息只在日志中，无数据库记录
  影响: 重启后丢失历史，无法长期追踪
  建议: Task 4 - 创建 startup_history 表

缺口 5: 无启动预检机制
  现象: 启动时未预检 DB 连接、schema 等
  影响: 启动失败才发现问题，浪费 30 秒
  建议: Task 5 - /api/brain/startup/health-check 端点

缺口 6: 错误分类不足
  现象: startup_errors 只记录错误信息，无分类
  影响: 无法区分错误类型，无自动修复建议
  建议: Task 6 - 错误分类与自动修复建议

================================================================================
建议 Tasks（优先级）
================================================================================

P0 优先级（立即做，共 3 小时）

  Task 1: 添加 /api/brain/startup/diagnostics 端点 (2h)
    文件: routes.js, tick.js
    返回: 最后启动时间、状态、最近 5 条错误、建议修复步骤
    重要性: 关键可观测性

  Task 2: 增强 tick/status 返回启动信息 (1h)
    文件: tick.js (L80-139 getTickStatus)
    返回: 启动成功时间、最后尝试时间、最近失败次数
    重要性: 启动监控

P1 优先级（本周做，共 5 小时）

  Task 4: 启动日志持久化 (3h)
    创建: startup_history 表
    记录: 每次启动尝试、状态、错误、时长
    重要性: 长期追踪

  Task 5: 启动健康检查 Probe (2h)
    文件: routes.js, 新建 startup-health-check.js
    检查: DB 连接、Schema、working_memory、孤儿进程
    重要性: 主动诊断

P2 优先级（本月做，共 5 小时）

  Task 3: 启动失败告警 API (2h)
    文件: routes.js, 新建 startup-alerts.js
    功能: 配置告警阈值、目标、自动恢复建议
    重要性: 及时感知

  Task 6: 错误分类与自动修复建议 (3h)
    文件: 新建 startup-error-classifier.js
    功能: 分类错误类型，返回修复建议
    重要性: 自愈能力

================================================================================
现有测试覆盖
================================================================================

已覆盖 (init-tick-retry.test.js):
✓ _recordStartupError 写入第一条错误
✓ _recordStartupError 累积 total_failures
✓ _recordStartupError 超过 20 条时自动裁剪
✓ _recordStartupError DB 写入失败不抛出
✓ initTickLoop 启动成功时不重试
✓ initTickLoop 第 1 次失败第 2 次成功时
✓ initTickLoop 重试 3 次后放弃
✓ initTickLoop 重试耗尽时发出 init_failed 事件
✓ 环境变量可配置重试次数
✓ emit 失败时不影响进程

缺失 (未覆盖):
✗ Alertness 初始化失败的影响
✗ 孤儿进程清理失败的影响
✗ 孤儿任务同步失败的影响
✗ ensureEventsTable() 失败处理
✗ 网络中断中途重试的行为
✗ 启动过程中 tick loop 状态

================================================================================
快速诊断步骤
================================================================================

问题：启动失败

1. 查询启动错误
   SELECT value_json FROM working_memory WHERE key = 'startup_errors';

2. 检查最后一条错误
   value_json -> 'errors' -> -1

3. 查询 DB 连接状态
   SELECT version();

4. 查询 tick 状态
   curl http://localhost:5221/api/brain/tick/status | jq '.enabled'

================================================================================
相关文件位置
================================================================================

核心逻辑:
  - tick.js: initTickLoop() [L257], _recordStartupError() [L227]
  - routes.js: GET /api/brain/tick/status [L699]
  - executor.js: cleanupOrphanProcesses() [L558]
  - alertness/index.js: initAlertness()

测试:
  - __tests__/init-tick-retry.test.js

文档:
  - DEFINITION.md: Brain 定义
  - CLAUDE.md: 项目规则

================================================================================
关键数字（重要）
================================================================================

最大重试次数: 3 (环境变量 CECELIA_INIT_RETRY_COUNT)
重试间隔: 10 秒 (环境变量 CECELIA_INIT_RETRY_DELAY_MS)
最大启动失败时间: 30 秒 (3 次 * 10 秒)
保留错误数: 20 条 (errors.slice(-20))
TTL: 无 (永久保存)

环境变量:
  CECELIA_INIT_RETRY_COUNT: 最大重试次数 (默认: 3)
  CECELIA_INIT_RETRY_DELAY_MS: 重试间隔毫秒 (默认: 10000)
  CECELIA_TICK_ENABLED: 启动时自动启用 (默认: 无)

================================================================================
重要发现
================================================================================

1. 启动机制完整，但可观测性缺失
   - 错误记录到 DB，但无 API 暴露
   - 没有启动历史表
   - 无启动预检

2. 重试范围不完全
   - Step 1-3（Alertness、孤儿）不重试
   - Step 4-6（DB 依赖）才重试
   - 可能 Step 1-3 失败后启动不完整

3. 测试覆盖重试逻辑，但缺非重试部分
   - 已覆盖 Step 4-6 的重试
   - 缺 Step 1-3 失败的处理测试

4. dispatch-stats 已有可观测性示例
   - working_memory 存储滚动窗口统计
   - 可作为 startup_history 的参考

================================================================================
后续行动
================================================================================

立即：
  1. 阅读完整分析: .claude/TICK_STARTUP_ANALYSIS.md
  2. 阅读快速参考: .claude/TICK_STARTUP_QUICK_REFERENCE.md

短期 (P0):
  1. 实现 Task 1 + Task 2 (共 3h)
  2. 提交 PR，覆盖启动诊断和监控

中期 (P1):
  1. 实现 Task 4 + Task 5 (共 5h)
  2. 添加持久化和健康检查

长期 (P2):
  1. 实现 Task 3 + Task 6 (共 5h)
  2. 完善告警和自动修复建议

================================================================================
