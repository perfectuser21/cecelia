---
id: prd-capability-driven-dev
version: 1.1.0
created: 2026-02-14
updated: 2026-02-14
changelog:
  - 1.1.0: 修订版 — 拆清仓库边界(core/engine)、补 DB 约束、明确 ID 策略、规则归属修正
  - 1.0.0: 初始版本
---

# PRD: Capability-Driven Development Framework

## 1. 问题陈述

### 现状（Before）

当前 OKR 拆解流程：

```
OKR → KR → Feature/Initiative → PR Plans → Tasks → PR
```

**核心问题**：KR 拆解直接产出 Feature/Task，没有"能力锚点"。导致：

| 症状 | 原因 | 实际案例 |
|------|------|----------|
| 任务做完不知道推进了什么 | Task 不知道属于哪个系统能力 | Brain 的 top_tasks 多个 P0 failed，无法判断哪个能力受损 |
| 同一能力反复部分完成 | 没有 Stage 追踪，不知道已经到哪 | 免疫系统 absorption_policies 24KB 数据存在，但 strategy_effectiveness 只有 16KB，闭环未完成 |
| 新功能和优化混在一起 | 没有"推进已有"和"创建新能力"的区分 | 交易系统 8 张表建了但 0 数据，和 Brain 调度优化混在同一轮 OKR |
| OKR 拆解凭灵感 | 缺少结构化约束 | validate-okr.py 只校验格式分(0-40)，不校验能力绑定 |

### 现有数据层（可以复用的）

```
goals        → OKR 目标（不动）
projects     → 仓库/子项目（不动）
pr_plans     → 工程拆解层（加字段）
tasks        → 执行单元（不动）
```

**缺失的层**：`capabilities`（能力注册表 + 成熟度追踪）

---

## 2. 目标状态（After）

### 新流程

```
OKR → KR → 选择/新建 Capability → 定义 Stage 推进 → Initiatives → PR Plans → Tasks → PR
              ↑                        ↑
          能力注册表              Stage 1→2→3→4
        （23个已有 +              成熟度路径
          未来新增）
```

### 新的数据模型

```
capabilities (新表)
  ├── id, name, description
  ├── current_stage (1-4)
  ├── stage_definitions (JSON: 每个 stage 的验收标准)
  ├── related_repos (关联仓库)
  ├── related_skills (关联技能)
  ├── key_tables (关键数据表)
  └── owner, created_at, updated_at

pr_plans (加字段)
  ├── capability_id → capabilities(id)    ← 新增
  ├── from_stage (1-4)                    ← 新增
  ├── to_stage (1-4)                      ← 新增
  └── evidence_required (text)            ← 新增
```

### ID 策略说明

`capabilities.id` 使用 `VARCHAR(60)` 人可读 slug（如 `autonomous-task-scheduling`），而非现有表通用的 uuid。原因：
- 种子数据需要稳定、可预测的 ID（不能每次 seed 生成不同 uuid）
- /okr 输出的 `capability_id` 字段需要人可读（AI 和人都能直接引用）
- 文档、CLAUDE.md、Skill 定义中可直接引用（无需查表转换）

### Stage 定义标准（全局统一）

| Stage | 名称 | 定义 | 验收标准 |
|-------|------|------|----------|
| 1 | Prototype | 代码存在，能跑 | 有代码 + 能手动执行一次 |
| 2 | Working | 端到端可用，但需人工触发 | 有输入/输出 + 手动测试通过 |
| 3 | Semi-Auto | 自动派发，偶尔需介入 | Brain 能调度 + 有监控 + 有错误处理 |
| 4 | Production | 7x24 稳定运行，自愈 | 连续 7 天无人工介入 + 有告警 + 有自愈 |

---

## 3. Before → After 对比

### 3.1 OKR 拆解输出格式变化

**Before（现有 output.json）**:
```json
{
  "features": [
    {
      "title": "优化任务优先级算法",
      "tasks": [
        { "title": "改进评分算法", "priority": "P0" }
      ]
    }
  ]
}
```

**After（升级后 output.json）**:
```json
{
  "initiatives": [
    {
      "title": "优化任务优先级算法",
      "capability_id": "autonomous-task-scheduling",
      "capability_name": "自主任务调度与派发",
      "from_stage": 3,
      "to_stage": 4,
      "evidence_required": "连续 7 天自动派发成功率 > 95%，无需人工重启",
      "pr_plans": [
        {
          "title": "PR #1: 改进评分算法",
          "dod": "...",
          "tasks": [
            { "title": "实现加权评分", "priority": "P0" }
          ]
        }
      ]
    }
  ]
}
```

**变化量**：Initiative 层加 4 个必填字段，其余不变。

### 3.2 验证逻辑变化

> **注意**：validate-okr.py 位于 `cecelia/engine/skills/okr/scripts/`，修改在 Engine PR 中进行。

**Before（validate-okr.py）**:
```
form_score (0-40):
  - 有 features? +10
  - 每个 feature 有 tasks? +10
  - tasks 有 priority? +10
  - 格式正确? +10
```

**After（validate-okr.py 升级）**:
```
form_score (0-40):
  - 有 initiatives? +5
  - 每个 initiative 有 capability_id? +10    ← 新增（权重最高）
  - capability_id 存在于 capabilities 表? +5  ← 新增
  - 有 from_stage / to_stage? +5              ← 新增
  - from_stage < to_stage? +5                 ← 新增
  - 有 evidence_required? +5                  ← 新增
  - pr_plans 有 tasks? +5
```

### 3.3 数据库变化

**新增表**：

```sql
CREATE TABLE capabilities (
  id VARCHAR(60) PRIMARY KEY,           -- 例: autonomous-task-scheduling
  name VARCHAR(200) NOT NULL,           -- 自主任务调度与派发
  description TEXT,                     -- 系统能从 PostgreSQL 队列中...
  current_stage INTEGER DEFAULT 1       -- 当前成熟度 1-4
    CHECK (current_stage BETWEEN 1 AND 4),
  stage_definitions JSONB,              -- 每个 stage 的验收标准
  related_repos TEXT[],                 -- 关联仓库路径
  related_skills TEXT[],                -- 关联技能名
  key_tables TEXT[],                    -- 关键数据表名
  evidence TEXT,                        -- 当前 stage 的证据
  owner VARCHAR(100) DEFAULT 'system',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**修改表（pr_plans 加字段 + 表级约束）**：

```sql
ALTER TABLE pr_plans ADD COLUMN capability_id VARCHAR(60)
  REFERENCES capabilities(id);
ALTER TABLE pr_plans ADD COLUMN from_stage INTEGER
  CHECK (from_stage BETWEEN 1 AND 4);
ALTER TABLE pr_plans ADD COLUMN to_stage INTEGER
  CHECK (to_stage BETWEEN 1 AND 4);
ALTER TABLE pr_plans ADD COLUMN evidence_required TEXT;

-- 表级约束：阶段只能向前推进
ALTER TABLE pr_plans ADD CONSTRAINT chk_stage_progression
  CHECK (from_stage IS NULL OR to_stage IS NULL OR from_stage < to_stage);
```

**种子数据**：灌入 23 个已有能力（来源：2026-02-14 系统扫描结果）。

### 3.4 /okr Skill 变化

> **注意**：/okr Skill 及其脚本位于 `cecelia/engine/skills/okr/`，修改在 Engine PR 中进行。

| 环节 | Before | After |
|------|--------|-------|
| 输出结构 | features[] | initiatives[]（含 capability_id） |
| 验证脚本 | 只校验格式 | 校验格式 + 能力绑定 + stage 合理性 |
| 存储脚本 | store-to-database.sh 写 goals/projects/tasks | 同上 + 写 pr_plans.capability_id 等字段 |
| 新建能力 | 无流程 | 输出 capability_proposal → 审批后创建 |

### 3.5 Brain API 变化

**新增端点**（4 个）：

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/brain/capabilities` | GET | 列出所有能力 + 当前 stage |
| `/api/brain/capabilities/:id` | GET | 单个能力详情 + 历史 stage 变更 |
| `/api/brain/capabilities/:id` | PATCH | 更新 stage（需 evidence） |
| `/api/brain/capabilities` | POST | 新建能力（capability_proposal 审批后） |

### 3.6 Workspace Dashboard 变化

**新增视图**（1 个页面，不在本次范围）：

Capability Map — 展示 23 个能力的成熟度矩阵：

```
┌─────────────────────────────┬────┬────┬────┬────┐
│ Capability                  │ S1 │ S2 │ S3 │ S4 │
├─────────────────────────────┼────┼────┼────┼────┤
│ 自主任务调度                │ ## │ ## │ ## │ :: │ ← Stage 3-4
│ 三层大脑决策                │ ## │ ## │ ## │    │ ← Stage 3
│ 自愈免疫系统                │ ## │ :: │    │    │ ← Stage 2-3
│ 多平台内容发布              │ ## │ ## │ ## │ ## │ ← Stage 4
│ AI 驱动交易                 │ :: │    │    │    │ ← Stage 1-2
│ ...                         │    │    │    │    │
└─────────────────────────────┴────┴────┴────┴────┘
```

---

## 4. 变更范围总结（按仓库拆分）

### Phase 1: Core PR（cecelia/core）

| 组件 | 变更类型 | 工作量 |
|------|----------|--------|
| Migration 030 | 新建 capabilities 表 + pr_plans 加 4 字段 + chk_stage_progression 约束 | 小 |
| 种子数据（Migration 030 内） | 灌入 23 个能力 + current_stage | 小（数据已有） |
| Brain routes.js | 加 4 个 capability CRUD 端点 | 中 |
| selfcheck.js | EXPECTED_SCHEMA_VERSION → '030' | 小 |
| DEFINITION.md | 同步 schema_version + 新端点文档 | 小 |

### Phase 2: Engine PR（cecelia/engine）

| 组件 | 变更类型 | 工作量 |
|------|----------|--------|
| validate-okr.py | 加 capability_id/from_stage/to_stage/evidence_required 校验与打分 | 小 |
| store-to-database.sh | 向 Brain API 传 capability_id 等新字段到 pr_plans | 小 |
| /okr SKILL.md | 更新输出格式说明 + 加"开工前必问：推进已有 vs 新建 capability"规则 | 小 |

### 不在本次范围

| 组件 | 说明 |
|------|------|
| Workspace 前端 | Capability Map 页面（后续 initiative） |
| 全局 CLAUDE.md | 不加规则，"开工前必问"放 /okr SKILL.md |

**不动的**：goals / projects / tasks 表、/dev 工作流、CI/DevGate、现有 140+ API 端点。

---

## 5. Capability 治理规则

> 本规则落在 `cecelia/engine/skills/okr/SKILL.md`，不放全局 CLAUDE.md。

1. /okr 输出的每个 initiative / pr_plan **必须**包含 `capability_id`
2. 默认**绑定已有 capability**（90% 场景）
3. 若无法映射到现有 capability，/okr 必须输出 `capability_proposal`（而不是直接创建）
4. `capability_proposal` 需人工审批后才可进入 capabilities registry（通过 `POST /api/brain/capabilities`）
5. pr_plans 必须满足 `from_stage < to_stage`（DB 约束 + validator 双重保障）

---

## 6. 验收标准（DoD）

### Phase 1: Core

| # | 验收项 | 如何验证 |
|---|--------|----------|
| 1 | capabilities 表存在且有 23 条种子数据 | `SELECT count(*) FROM capabilities` = 23 |
| 2 | pr_plans 支持 capability_id 外键 | `INSERT INTO pr_plans (capability_id, ...) VALUES ('autonomous-task-scheduling', ...)` 成功 |
| 3 | pr_plans 拒绝 from_stage >= to_stage | `INSERT INTO pr_plans (from_stage, to_stage) VALUES (3, 2)` 报错 |
| 4 | Brain API 能 CRUD capabilities | `curl GET /api/brain/capabilities` 返回 23 条 |
| 5 | selfcheck 通过（schema_version = 030） | `curl GET /api/brain/health` 返回 healthy |

### Phase 2: Engine

| # | 验收项 | 如何验证 |
|---|--------|----------|
| 6 | /okr 输出包含 capability_id | 运行 /okr，检查 output.json 每个 initiative 有 capability_id |
| 7 | validate-okr.py 拒绝缺少 capability_id 的输出 | 去掉 capability_id 后 form_score < 通过线 |
| 8 | /okr SKILL.md 包含"开工前必问"规则 | Skill 定义中有 Capability 选择流程 |

---

## 7. 不做的事（明确排除）

- 不重构现有 goals/projects/tasks 表
- 不改 /dev 工作流（PR Plan → Tasks → PR 不变）
- 不改 CI/DevGate 逻辑
- 不做 Capability 自动评估（Stage 由人工/LLM 手动更新）
- 不做历史数据回填（现有 pr_plans 的 capability_id 留 NULL）
- Dashboard Capability Map 不在本次范围（可作为后续 initiative）
- 不改全局 CLAUDE.md（规则放 /okr SKILL.md）

---

## 8. 风险

| 风险 | 概率 | 缓解 |
|------|------|------|
| 23 个能力定义不准确 | 中 | 种子数据基于实际代码扫描，后续可 PATCH 修正 |
| Stage 评估主观性 | 中 | 要求 evidence 字段，有据可查 |
| /okr 已有拆解习惯被打破 | 低 | 只加字段，不删旧字段；旧格式仍可解析 |
| Engine PR 依赖 Core PR 先合并 | 低 | Phase 1 先合并，Phase 2 才能校验 capability_id 存在性 |

---

## 9. 实施顺序

```
Phase 1 (Core PR)
  ├── Migration 030 + seed 23 capabilities
  ├── Brain API: 4 CRUD endpoints
  ├── selfcheck + DEFINITION.md 同步
  └── 合并到 develop → main
        ↓
Phase 2 (Engine PR, 依赖 Phase 1)
  ├── validate-okr.py 升级
  ├── store-to-database.sh 新字段
  ├── /okr SKILL.md 加治理规则
  └── 合并到 develop → main
        ↓
Phase 3 (Workspace, 后续)
  └── Capability Map Dashboard 页面
```
