# PRD: 免疫系统 v1 - 学得稳（可控演化）

## 来源 / Context

**手动创建**：从 P1（RCA去重）+ P2（Auto-Fix）进化到可学习的免疫系统。

**目标**：
- 系统可以学习（规则增长）
- 不会失控（默认不自动启用）
- LLM 调用会下降（同类问题被 L1 吸收）
- 每条规则可审计、可回滚、可禁用

## 功能描述 / Goal

### 三个新概念

1. **Failure Registry（失败模式注册表）**
   - 记录每个错误签名的出现频次
   - 判断是否值得投入 Cortex 分析
   - 决定何时晋升规则

2. **Probation（观察期规则）**
   - 新规则先模拟执行
   - 验证有效性后才真正执行
   - 防止误判规则直接上线

3. **Promotion（晋升）**
   - 基于频次 + 验证成功率
   - 自动晋升 probation → active
   - 自动降级 active → disabled（失败时）

### 规则状态机

```
draft（Cortex刚产出）
  ↓ 同签名 24h≥2次 or 7d≥3次
probation（观察期，只模拟）
  ↓ 模拟命中≥2次 且 验证成功率≥90%
active（L1自动执行）
  ↓ 验证失败 or 人工禁用
disabled（禁用）
```

### 执行策略：Simulate First

**probation 期间**：
- `mode=simulate`：只记录"会怎么做"
- 写入 `policy_evaluations` 审计
- 不实际影响系统

**active 期间**：
- `risk_level=low`：自动执行
- `risk_level=medium/high`：需人工授权

## P0 任务范围（本次实施）

### 1. 数据表设计（4张表）

#### (1) failure_signatures
```sql
CREATE TABLE failure_signatures (
  signature VARCHAR(16) PRIMARY KEY,
  first_seen_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_seen_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  count_24h INTEGER DEFAULT 1,
  count_7d INTEGER DEFAULT 1,
  count_total INTEGER DEFAULT 1,
  latest_run_id UUID,
  latest_reason_code VARCHAR(50),
  latest_layer VARCHAR(50),
  latest_step_name VARCHAR(100)
);
CREATE INDEX idx_failure_signatures_last_seen ON failure_signatures(last_seen_at);
```

#### (2) rca_cache（已存在，保留）

#### (3) absorption_policies
```sql
CREATE TABLE absorption_policies (
  policy_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  signature VARCHAR(16) NOT NULL,
  status VARCHAR(20) NOT NULL CHECK (status IN ('draft', 'probation', 'active', 'disabled', 'retired')),
  policy_type VARCHAR(50) NOT NULL,
  policy_json JSONB NOT NULL,
  risk_level VARCHAR(10) NOT NULL CHECK (risk_level IN ('low', 'medium', 'high')),
  created_by VARCHAR(20) NOT NULL,
  version INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  rollback_json JSONB,
  verification_query TEXT,
  notes TEXT
);
CREATE INDEX idx_absorption_policies_signature_status ON absorption_policies(signature, status);
CREATE INDEX idx_absorption_policies_status ON absorption_policies(status);
```

#### (4) policy_evaluations
```sql
CREATE TABLE policy_evaluations (
  evaluation_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  policy_id UUID NOT NULL REFERENCES absorption_policies(policy_id),
  run_id UUID,
  signature VARCHAR(16) NOT NULL,
  mode VARCHAR(20) NOT NULL CHECK (mode IN ('simulate', 'enforce')),
  decision VARCHAR(20) NOT NULL CHECK (decision IN ('applied', 'skipped', 'failed')),
  verification_result VARCHAR(20) CHECK (verification_result IN ('pass', 'fail', 'unknown')),
  latency_ms INTEGER,
  details JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_policy_evaluations_policy_id ON policy_evaluations(policy_id);
CREATE INDEX idx_policy_evaluations_created_at ON policy_evaluations(created_at);
```

### 2. Monitor Loop 改造

**新流程**：

```
Monitor 检测到异常（signature）
  ↓
优先查询 active policy
  ↓ 有
  执行 policy + 写 evaluation + 验证
  ↓ 无
更新 failure_signatures 计数
  ↓
检查是否达到晋升门槛
  ↓ 是
  有 draft → 升 probation；无 → 触发 Cortex 生成 draft
  ↓ 否
  走 Thalamus 通用处置（重启/隔离）
```

### 3. 审计记录（policy_evaluations）

每次 Monitor 命中规则（active 或 probation）都必须写审计：

```javascript
await recordPolicyEvaluation({
  policy_id: policy.policy_id,
  run_id: failure.run_id,
  signature: signature,
  mode: policy.status === 'active' ? 'enforce' : 'simulate',
  decision: 'applied',
  verification_result: 'pass', // 稍后验证
  latency_ms: elapsed,
  details: { /* 执行细节 */ }
});
```

## 成功标准 / Acceptance Criteria

- [x] 4 张表创建成功（migration 025）
- [x] selfcheck 期望 schema_version = '025'
- [x] `failure_signatures` 自动更新计数
- [x] Monitor 优先查 active policy（有则执行，写 evaluation）
- [x] Monitor 无 policy 时更新 failure_signatures
- [x] `policy_evaluations` 记录完整
- [x] 测试：插入 draft policy → probation → 命中时写 evaluation
- [x] CI + DevGate 全绿

## 证据要求 / Evidence Required

1. 数据库表结构验证（`\d+ absorption_policies`）
2. Monitor 日志显示优先查询 policy
3. `policy_evaluations` 表有审计记录
4. `failure_signatures` 计数正确递增
5. 测试覆盖：插入 policy → 触发 Monitor → 写 evaluation

## Technical Details

### 依赖
- PostgreSQL schema_version = 025
- monitor-loop.js 已有 RCA 去重逻辑

### 新增模块
- `brain/src/immune-system.js`：免疫系统核心逻辑
  - `updateFailureSignature(signature, failure)`
  - `findActivePolicy(signature)`
  - `recordPolicyEvaluation(evaluation)`
  - `shouldPromoteToProbation(signature)`

### Migration 025
- 创建 3 张新表（failure_signatures, absorption_policies, policy_evaluations）
- rca_cache 保留不变

### Monitor Loop 改造
- 在 `handleFailureSpike()` 中添加：
  1. 优先查 active policy
  2. 无 policy 时更新 failure_signatures
  3. 记录 policy_evaluations

## Risks

- 新表字段设计可能需要调整 → migration 可迭代
- policy 执行逻辑需要严格沙箱 → P0 只做记录，P1 才执行
- 验证逻辑复杂 → P0 先写 'unknown'，P1 实现验证

## 后续阶段（P1/P2）

**P1（半天级）**：
- Probation 默认 simulate
- Promotion Job：定期晋升规则

**P2（1天级）**：
- Cortex 输出 draft policy JSON
- Validator + 重试逻辑

## 自动派发标记

**此任务手动创建**，现在启动 /dev 流程。

---

**版本**: v1.0.0
**创建时间**: 2026-02-12
**优先级**: P0
