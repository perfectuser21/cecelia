# PRD: Update Golden Path with PR Plans Coverage

## 背景

Golden Path (`brain/scripts/goldenpath-check.sh`) 是 CI 中的快速烟雾测试，验证 Brain 核心生命周期：
- 启动 → 健康检查 → 状态查询 → 手动 tick → tick 状态

当前设计：最小化、无数据依赖、< 30秒完成

## 问题

PR Plans 功能已经实现（PR #1/2/3），但 Golden Path 没有覆盖 PR Plans 相关端点。

## 目标

在保持 Golden Path **最小化**原则的前提下，增加 PR Plans API 的基本可用性检查。

## 非目标

- ❌ 不做完整的 PR Plans 业务逻辑测试（那是 E2E 测试的职责）
- ❌ 不创建测试数据（Objectives, KRs, Initiatives）
- ❌ 不测试 PR Plans dispatch 流程
- ❌ 不测试依赖处理
- ❌ 不测试自动完成

**原因**：Golden Path 必须保持快速（< 30s）且无外部依赖。

## 需求

### 方案 A：轻量级端点检查（推荐）

在现有 Golden Path 中增加一个步骤，检查 PR Plans API 端点可用性：

```bash
# [6/6] Check PR Plans API endpoints
echo "[6/6] Checking PR Plans API..."

# GET /api/brain/pr-plans (should return empty array or valid JSON)
PR_PLANS=$(curl -sf "http://localhost:$PORT/api/brain/pr-plans" || echo "")
if [ -z "$PR_PLANS" ]; then
  fail "PR Plans endpoint returned empty response"
else
  if echo "$PR_PLANS" | jq -e 'type == "array"' > /dev/null 2>&1; then
    pass "PR Plans API responds with valid array"
  else
    fail "PR Plans API returned invalid structure"
  fi
fi
```

**优点**：
- 简单、快速（+1s）
- 验证端点可访问性
- 符合 Golden Path 最小化原则

**缺点**：
- 不测试业务逻辑

### 方案 B：文档化（备选）

不修改 Golden Path 代码，只在注释中说明：

```bash
# L4 GoldenPath: Brain Minimal Life Loop
#
# Verifies core lifecycle. For PR Plans end-to-end testing,
# see: brain/src/__tests__/three-layer-decomposition-e2e.test.js
```

**优点**：
- 不增加执行时间
- 引导到正确的测试文件

**缺点**：
- 没有实际的 PR Plans 检查

## 决策

推荐 **方案 A**：增加轻量级端点检查。

理由：
1. Golden Path 的职责是验证**核心系统可用性**
2. PR Plans 是核心功能，应该有基本的可用性检查
3. 端点检查非常轻量（< 1s），不违反最小化原则
4. 完整的业务逻辑测试由 E2E test 覆盖

## 实现细节

修改 `brain/scripts/goldenpath-check.sh`：

1. 在 Step 5 (Tick status) 之后增加 Step 6 (PR Plans API)
2. 检查 `GET /api/brain/pr-plans` 返回有效 JSON 数组
3. 可选：检查 `GET /api/brain/initiatives` 返回有效 JSON 数组
4. 更新总步骤数：5/5 → 6/6
5. 保持总执行时间 < 35s

## 验收标准（DoD）

1. ✅ Golden Path 增加 PR Plans API 检查
2. ✅ 检查 `/api/brain/pr-plans` 端点返回有效 JSON 数组
3. ✅ Golden Path 总执行时间 < 35s
4. ✅ CI 中 Golden Path 测试通过
5. ✅ 注释说明完整测试在 E2E test 中

## 测试计划

### 本地测试

```bash
cd /home/xx/perfect21/cecelia/core/brain
ENV_REGION=us bash scripts/goldenpath-check.sh
```

### CI 测试

GoldenPath 会在 CI 的 "Brain (Node.js)" job 中自动运行。

## 优先级

P1 - 重要但不紧急。PR Plans 功能已经有 E2E 测试覆盖，Golden Path 更新是锦上添花。

## 预估时间

30 分钟（修改脚本 + 测试 + PR）
