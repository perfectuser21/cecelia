---
id: dod-cp-02211200-idle-session-cleanup
version: 1.0.0
created: 2026-02-21
updated: 2026-02-21
changelog:
  - 1.0.0: 初始版本
---

# DoD: Brain Watchdog 空闲交互式 Claude 会话自动清理

## 验收清单

- [ ] watchdog.js 新增 `scanInteractiveClaude(managedPids)` 函数
  - 正确扫描 /proc 找到所有 claude 进程
  - 排除 claude -p（后台任务）
  - 排除 bash -c 包装进程
  - 排除 managedPids 中的 PID（Brain slot 管理）

- [ ] watchdog.js 新增 `checkIdleSessions()` 函数
  - 返回 `{ actions: [{pid, action: 'kill'|'warn', reason}] }`
  - 正确跟踪 CPU 历史（lastHighCpuTs 机制）
  - 空闲 2 小时后返回 kill action

- [ ] tick.js 集成 `checkIdleSessions()`
  - 在 watchdog 区块后添加 idle-session 检测
  - kill action 触发 SIGTERM → SIGKILL 两阶段清理
  - 日志输出：`[tick] idle-session kill: pid=X reason=...`

- [ ] watchdog.js 导出新函数和常量
  - `scanInteractiveClaude`, `checkIdleSessions` 已导出
  - `IDLE_KILL_HOURS`, `IDLE_CPU_PCT_THRESHOLD`, `_idleMetrics` 已导出（测试用）

- [ ] 单元测试覆盖 watchdog.test.js
  - `scanInteractiveClaude` 正确过滤进程
  - `checkIdleSessions` 空闲超时触发 kill
  - `checkIdleSessions` 活跃进程不被 kill
  - 所有测试通过

## CI 检查映射

| DoD 条目 | CI 检查 |
|---------|---------|
| 新函数实现 | npm run build (TypeScript/ESM 编译通过) |
| 单元测试 | vitest 所有测试通过 |
| 导出完整 | 导入测试验证 |
