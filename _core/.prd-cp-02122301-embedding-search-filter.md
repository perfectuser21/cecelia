---
id: prd-embedding-search-filter
version: 1.0.0
created: 2026-02-12
changelog:
  - 1.0.0: 初始版本 - Embedding 搜索过滤功能
---

## PRD - Embedding 搜索过滤功能

**需求来源**: 用户反馈 - "embeding这个东西，那我们说的应该是一个大库里面有好几个小库分别的小库还是什么。然后他搜索的时候可以自定义化的做这个东西"

**功能描述**:
增强 similarity.js 的搜索功能，支持自定义过滤条件，实现"大库中的小库"概念：
1. 移除 LIMIT 100 限制 - 当前只搜索最近 100 个任务，但实际已导入 963 个 PR，需要搜索全部
2. 添加 repo 过滤 - 支持按 repository 名称过滤（例如只搜索 cecelia-workspace 的 PR）
3. 添加 project 过滤 - 支持按 project_id 过滤
4. 添加日期范围过滤 - 支持按创建/更新时间范围过滤
5. 更新 API 路由 - /api/brain/search-similar 支持新的过滤参数

**涉及文件**:
- `brain/src/similarity.js` - 修改 getAllActiveEntities() 方法，添加过滤逻辑
- `brain/src/routes.js` - 更新 /search-similar 端点，接受过滤参数
- `brain/src/similarity.test.js` - 添加过滤功能的单元测试（如果存在）

**成功标准**:
1. getAllActiveEntities() 可以接受可选的过滤参数对象
2. LIMIT 100 限制被移除或改为可配置参数（默认 1000）
3. API 支持以下请求格式：
   ```json
   {
     "query": "search text",
     "top_k": 5,
     "filters": {
       "repo": "cecelia-workspace",
       "project_id": 123,
       "date_from": "2026-01-01",
       "date_to": "2026-02-12"
     }
   }
   ```
4. 过滤逻辑在 SQL 查询中实现（WHERE 子句），不是在内存中过滤
5. 向后兼容 - 不传 filters 参数时保持原有行为（搜索所有，最多 1000 条）

**非目标**:
- 不修改 Jaccard 相似度算法本身
- 不引入 OpenAI Embeddings（Phase 1 是另一个任务）
- 不修改前端 UI（本次只改后端 API）
- 不添加全文搜索（仍使用 Jaccard 算法）

**技术方案**:
1. 修改 getAllActiveEntities() 签名：
   ```javascript
   async getAllActiveEntities(filters = {}) {
     const { repo, project_id, date_from, date_to, limit = 1000 } = filters;
     // 构建动态 WHERE 子句
   }
   ```
2. 使用参数化查询防止 SQL 注入
3. 在 routes.js 中提取并验证过滤参数
4. 添加 JSDoc 文档说明参数格式

**影响范围**:
- 后端 API 接口变更（新增可选参数，向后兼容）
- 数据库查询性能提升（减少无关数据）
- 为前端提供更精准的搜索结果

**依赖**:
- PostgreSQL 数据库已有 tasks 表的 metadata->>'repo' 字段
- 963 个 PR 已导入（由 import-all-prs.js 完成）
