## PRD: 集成 Pre-flight Checks

### 需求来源
User request to integrate Pre-flight Checks into the task dispatch flow

### 目标
将 Pre-flight Checks 集成到任务派发流程中。

### 功能描述

#### 1. 修改 dispatchNextTask()
在 tick.js 的 dispatchNextTask() 函数中集成 Pre-flight Check：

```javascript
async function dispatchNextTask() {
  const nextTask = await planNextTask();
  if (!nextTask) return { dispatched: false };

  // === 新增：Pre-flight Check ===
  const checkResult = await preFlightCheck(nextTask);
  if (!checkResult.passed) {
    console.warn(`[dispatch] Pre-flight check failed for task ${nextTask.id}:`, checkResult.issues);
    // 记录失败原因到 metadata
    await pool.query(
      `UPDATE tasks SET metadata = COALESCE(metadata, '{}'::jsonb) || $2::jsonb WHERE id = $1`,
      [nextTask.id, JSON.stringify({
        pre_flight_failed: true,
        pre_flight_issues: checkResult.issues,
        pre_flight_suggestions: checkResult.suggestions,
        failed_at: new Date().toISOString()
      })]
    );
    // 不派发，返回 false
    return { dispatched: false, reason: 'pre_flight_check_failed', issues: checkResult.issues };
  }
  // === Pre-flight Check 通过，继续派发 ===

  const execResult = await triggerCeceliaRun(nextTask);
  // ...
}
```

#### 2. 记录统计指标
- 每次 Pre-flight Check 的结果存入 working_memory
- 统计：通过率、失败原因分布
- 用于计算 KR4 进度

### 涉及文件
- brain/tick.js - dispatchNextTask() 函数
- brain/pre-flight-check.js - Pre-flight Check 逻辑（假设已存在）

### 成功标准
1. dispatchNextTask() 调用 preFlightCheck()
2. 失败任务记录到 task.metadata
3. 统计指标记录到 working_memory
4. 低质量任务被拦截
5. 通过 CI 所有检查

### 非目标
- 不修改 preFlightCheck() 内部逻辑
- 不修改任务创建流程
