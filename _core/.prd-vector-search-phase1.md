# PRD: Vector Search Phase 1 Implementation

**ç‰ˆæœ¬**: 1.0.0
**åˆ›å»ºæ—¶é—´**: 2026-02-13
**è´Ÿè´£äºº**: Agent Team (vector-search-phase1)

---

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### ç›®æ ‡
ä¸º Cecelia Brain æ·»åŠ å‘é‡æ£€ç´¢èƒ½åŠ›ï¼Œæ”¯æŒåŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦çš„ä»»åŠ¡/é¡¹ç›®/ç›®æ ‡æœç´¢ã€‚

### èƒŒæ™¯
- **å½“å‰çŠ¶æ€** (Phase 0): Jaccard similarityï¼ˆçº¯æ–‡æœ¬ token åŒ¹é…ï¼‰
- **ç›®æ ‡çŠ¶æ€** (Phase 1): OpenAI embeddings + pgvectorï¼ˆè¯­ä¹‰ç†è§£ï¼‰
- **æ¶æ„**: å•åº“ + repo è¿‡æ»¤ï¼ˆæ”¯æŒè·¨ repo æœç´¢ï¼‰

---

## ğŸ¯ åŠŸèƒ½éœ€æ±‚

### 1. å‘é‡å­˜å‚¨

**æ•°æ®åº“ Schema**:
```sql
-- tasks è¡¨
ALTER TABLE tasks ADD COLUMN embedding vector(3072);

-- projects è¡¨
ALTER TABLE projects ADD COLUMN embedding vector(3072);

-- goals è¡¨
ALTER TABLE goals ADD COLUMN embedding vector(3072);

-- å‘é‡ç´¢å¼•ï¼ˆivfflatï¼‰
CREATE INDEX tasks_embedding_idx ON tasks USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
CREATE INDEX projects_embedding_idx ON projects USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
CREATE INDEX goals_embedding_idx ON goals USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
```

### 2. Embedding ç”Ÿæˆ

**OpenAI API**:
- Model: `text-embedding-3-large`
- Dimensions: 3072
- Input: æœ€å¤š 8000 characters
- Cost: $0.13/1M tokens

**å®ç°**:
```javascript
async generateEmbedding(text) {
  const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
  const response = await openai.embeddings.create({
    model: 'text-embedding-3-large',
    input: text.substring(0, 8000)
  });
  return response.data[0].embedding;
}
```

### 3. æ··åˆæ£€ç´¢

**ç®—æ³•**:
- 70% å‘é‡ç›¸ä¼¼åº¦ï¼ˆcosine similarityï¼‰
- 30% Jaccard ç›¸ä¼¼åº¦ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰

**API**:
```javascript
POST /api/brain/similarity/search
Body: {
  "query": "ç”¨æˆ·ç™»å½•åŠŸèƒ½",
  "topK": 5,
  "filters": {
    "repo": "cecelia/core",        // å¯é€‰ï¼šå• repo è¿‡æ»¤
    "repos": ["core", "workspace"], // å¯é€‰ï¼šå¤š repo è¿‡æ»¤
    "status": "completed",          // å¯é€‰ï¼šçŠ¶æ€è¿‡æ»¤
    "dateFrom": "2026-01-01",      // å¯é€‰ï¼šæ—¶é—´èŒƒå›´
    "dateTo": "2026-02-13"
  }
}

Response: {
  "matches": [
    {
      "level": "task",
      "id": "task-123",
      "title": "å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½",
      "score": 0.85,
      "metadata": {
        "repo": "cecelia/core",
        "pr_number": 228
      }
    },
    ...
  ]
}
```

### 4. æ•°æ®å›å¡«

**è„šæœ¬**: `brain/scripts/backfill-embeddings.js`

**é€»è¾‘**:
1. æŸ¥è¯¢æ‰€æœ‰ `embedding IS NULL` çš„è®°å½•
2. ç”Ÿæˆ embeddingï¼ˆæ‰¹é‡ï¼Œæ¯æ‰¹ 100 æ¡ï¼‰
3. æ›´æ–°æ•°æ®åº“
4. è®°å½•è¿›åº¦

**æ‰§è¡Œ**:
```bash
node brain/scripts/backfill-embeddings.js
```

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•°æ®æµ

```
ç”¨æˆ·æŸ¥è¯¢: "ç”¨æˆ·ç™»å½•åŠŸèƒ½"
    â†“
Brain API: POST /api/brain/similarity/search
    â†“
SimilarityService.searchWithVectors()
    â†“
1. generateEmbedding(query) â†’ OpenAI API
    â†“
2. vectorSearch(embedding, filters)
   â†’ PostgreSQL: SELECT ... ORDER BY embedding <=> $1
    â†“
3. jaccardSearch(query, filters)
   â†’ ç°æœ‰ Jaccard ç®—æ³•
    â†“
4. mergeResults(vectorResults, jaccardResults, weight=0.7)
    â†“
è¿”å› top K ç»“æœ
```

### æ¶æ„åˆ†å±‚

```
ç¾å›½ PostgreSQLï¼ˆçƒ­æ•°æ®ï¼Œå¿«é€Ÿæ£€ç´¢ï¼‰
  â”œâ”€â”€ tasks (embedding vector(3072), metadata->>'repo')
  â”œâ”€â”€ projects (embedding vector(3072), repo_path)
  â””â”€â”€ goals (embedding vector(3072))

NASï¼ˆå†·æ•°æ®ï¼Œå¤‡ä»½ï¼‰
  â”œâ”€â”€ åŸå§‹ git repos
  â””â”€â”€ å‘é‡æ•°æ®å¤‡ä»½ï¼ˆæ¯å¤© 3amï¼‰
```

---

## âœ… éªŒæ”¶æ ‡å‡† (DoD)

### 1. æ•°æ®åº“è¿ç§»
- [ ] Migration 028 åˆ›å»ºæˆåŠŸ
- [ ] pgvector æ‰©å±•å·²å®‰è£…
- [ ] ä¸‰ä¸ªè¡¨çš„ embedding åˆ—å­˜åœ¨
- [ ] å‘é‡ç´¢å¼•åˆ›å»ºæˆåŠŸ

### 2. Core ä»£ç 
- [ ] similarity.js æ·»åŠ  `searchWithVectors()` æ–¹æ³•
- [ ] OpenAI é›†æˆæ­£å¸¸å·¥ä½œ
- [ ] æ··åˆæ£€ç´¢ç®—æ³•å®ç°
- [ ] Metadata è¿‡æ»¤ï¼ˆrepo, status, dateï¼‰æ­£å¸¸

### 3. æ•°æ®å›å¡«
- [ ] å›å¡«è„šæœ¬è¿è¡ŒæˆåŠŸ
- [ ] æ‰€æœ‰å†å²æ•°æ®å·²ç”Ÿæˆ embedding
- [ ] æ—  OpenAI API é”™è¯¯

### 4. æµ‹è¯•
- [ ] å•å…ƒæµ‹è¯•ï¼š`similarity-vectors.test.js` é€šè¿‡
- [ ] é›†æˆæµ‹è¯•ï¼šç«¯åˆ°ç«¯æ£€ç´¢æµç¨‹é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•ï¼šæœç´¢ < 500ms

### 5. æ–‡æ¡£
- [ ] DEFINITION.md æ›´æ–°ï¼ˆæ–°å¢ vector search ç« èŠ‚ï¼‰
- [ ] MEMORY.md æ›´æ–°ï¼ˆè®°å½•å®æ–½ç»†èŠ‚ï¼‰
- [ ] API.md æ›´æ–°ï¼ˆæ–°å¢ API ç«¯ç‚¹æ–‡æ¡£ï¼‰

### 6. CI/CD
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] Facts Check é€šè¿‡
- [ ] Version åŒæ­¥

---

## ğŸ“Š æˆæœ¬ä¼°ç®—

### OpenAI API
```
Embeddingsï¼ˆå›å¡«å†å²æ•°æ®ï¼‰:
  å‡è®¾ 5,000 æ¡å†å²è®°å½• Ã— 200 tokens = 1M tokens
  æˆæœ¬: $0.13ï¼ˆä¸€æ¬¡æ€§ï¼‰

Embeddingsï¼ˆæ—¥å¸¸æ–°å¢ï¼‰:
  100 tasks/day Ã— 200 tokens Ã— $0.13/1M = $0.0026/day
  â†’ $0.95/year

Searchï¼ˆæ¯æ¬¡æŸ¥è¯¢ï¼‰:
  500 queries/day Ã— 50 tokens Ã— $0.13/1M = $0.00325/day
  â†’ $1.19/year

æ€»æˆæœ¬: ~$2.14/year + $0.13 ä¸€æ¬¡æ€§ âœ…
```

### å­˜å‚¨
```
å‘é‡æ•°æ®:
  10,000 tasks Ã— 3072 dimensions Ã— 4 bytes = 122 MB
  1,000 projects Ã— 3072 Ã— 4 = 12 MB
  100 goals Ã— 3072 Ã— 4 = 1.2 MB

  æ€»è®¡: ~135 MBï¼ˆå¯å¿½ç•¥ï¼‰
```

---

## ğŸš¨ é£é™©ä¸ç¼“è§£

### é£é™© 1: OpenAI API å¤±è´¥
- **ç¼“è§£**: é™çº§åˆ° Phase 0 Jaccard similarity
- **å®ç°**: try-catch + fallback logic

### é£é™© 2: pgvector å®‰è£…å¤±è´¥
- **ç¼“è§£**: Docker é•œåƒé¢„è£… pgvector
- **éªŒè¯**: Selfcheck æ£€æŸ¥æ‰©å±•å­˜åœ¨

### é£é™© 3: æ•°æ®å›å¡«æ—¶é—´è¿‡é•¿
- **ç¼“è§£**: æ‰¹é‡å¤„ç† + è¿›åº¦è®°å½•
- **ä¼°ç®—**: 5000 æ¡ Ã— 0.2s/æ¡ â‰ˆ 17 åˆ†é’Ÿ

### é£é™© 4: å‘é‡ç´¢å¼•æ€§èƒ½ä¸è¶³
- **ç¼“è§£**: è°ƒæ•´ ivfflat lists å‚æ•°
- **ç›‘æ§**: æŸ¥è¯¢æ—¶é—´ < 500ms

---

## ğŸ“… å®æ–½è®¡åˆ’

### Agent Teams åˆ†å·¥

| Agent | èŒè´£ | äº§å‡º |
|-------|------|------|
| **DB Agent** | PostgreSQL è¿ç§» + pgvector | `brain/migrations/028_add_embeddings.sql` |
| **Core Agent** | similarity.js æ”¹é€  | `brain/src/similarity.js` (updated)<br>`brain/src/openai-client.js` (new) |
| **Backfill Agent** | æ•°æ®å›å¡«è„šæœ¬ | `brain/scripts/backfill-embeddings.js` |
| **Test Agent** | æµ‹è¯•è¦†ç›– | `brain/src/__tests__/similarity-vectors.test.js` |
| **Doc Agent** | æ–‡æ¡£åŒæ­¥ | `DEFINITION.md`, `MEMORY.md`, `docs/API.md` |

### æ—¶é—´ä¼°ç®—
- DB Agent: 30 åˆ†é’Ÿ
- Core Agent: 60 åˆ†é’Ÿ
- Backfill Agent: 30 åˆ†é’Ÿ
- Test Agent: 45 åˆ†é’Ÿ
- Doc Agent: 15 åˆ†é’Ÿ

**æ€»è®¡**: ~2-3 å°æ—¶ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰

---

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

1. **åŠŸèƒ½æ€§**: æœç´¢ "ç”¨æˆ·ç™»å½•" è¿”å›ç›¸å…³ tasks
2. **æ€§èƒ½**: æŸ¥è¯¢æ—¶é—´ < 500ms
3. **å‡†ç¡®æ€§**: Top 5 ç»“æœç›¸å…³æ€§ > 80%
4. **ç¨³å®šæ€§**: æ—  OpenAI API é”™è¯¯
5. **å¯ç»´æŠ¤æ€§**: ä»£ç è¦†ç›–ç‡ > 80%

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- OpenAI Embeddings API: https://platform.openai.com/docs/guides/embeddings
- pgvector GitHub: https://github.com/pgvector/pgvector
- infrastructure/docs/database/embeddings.md: Phase 0/1 æ¶æ„æ–‡æ¡£
