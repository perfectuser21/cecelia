# PRD: planner.js 集成 learnings 失败历史权重惩罚

## 背景
当前 planner.js 的 scoreKRs() 函数仅基于 progress/priority/wait_time 打分，不考虑历史失败记录。learnings 表存储了各类失败经验，但未集成到派发决策中，导致相同类型的任务反复失败。

## 目标
在 planner.js 的任务评分逻辑中，查询 learnings 表的 failure_class 记录，对近期有失败历史的相同 task_type 任务降低优先级（或跳过），实现从历史中学习。

## 实现步骤

### Step 1: 查询 learnings 数据结构
```sql
-- 确认 learnings 表字段
SELECT column_name, data_type FROM information_schema.columns
WHERE table_name = 'learnings' ORDER BY ordinal_position;

-- 查看样本数据
SELECT failure_class, task_type, created_at FROM learnings
ORDER BY created_at DESC LIMIT 10;
```

### Step 2: 修改 planner.js
位置: brain/src/planner.js

在 scoreKRs() 或 selectTargetProject() 中添加历史失败惩罚：
```javascript
// 查询近 24h 内同类型任务的失败次数
const recentFailures = await db.query(
  `SELECT COUNT(*) as cnt FROM learnings
   WHERE task_type = $1 AND created_at > NOW() - INTERVAL '24 hours'
   AND failure_class IS NOT NULL`,
  [task.task_type]
);
const failurePenalty = Math.min(recentFailures.rows[0].cnt * 5, 30); // 最多扣 30 分
score -= failurePenalty;
```

### Step 3: 添加可观测性日志
在评分时记录惩罚原因，便于调试：
```javascript
if (failurePenalty > 0) {
  logger.info(`[Planner] task ${task.id} penalized -${failurePenalty} due to ${recentFailures.rows[0].cnt} recent failures`);
}
```

### Step 4: 测试覆盖
- 创建 brain/src/__tests__/planner-learnings.test.js
- Mock learnings 表有记录时，验证评分降低
- Mock learnings 表无记录时，验证评分不变

## 验收标准（DoD）
- [ ] planner.js scoreKRs/selectTargetProject 集成 learnings 查询
- [ ] 有失败历史的任务评分降低
- [ ] 添加可观测性日志
- [ ] vitest 测试覆盖（至少 2 个测试用例）
- [ ] facts-check.mjs 通过
- [ ] check-version-sync.sh 通过（patch bump）

## 预计工时
20 分钟
