---
id: dod-memory-retriever-quota
version: 1.1.0
created: 2026-03-01
updated: 2026-03-01
changelog:
  - 1.0.0: 初始版本
  - 1.1.0: 修复 Test 字段格式，标记已验证项
---

# DoD: 优化记忆检索系统（source 最小配额 + token 预算提升 + 动态权重调节）

## 验收清单

- [x] CHAT_TOKEN_BUDGET = 2500 常量定义
  Test: manual:node -e "const s=require('fs').readFileSync('packages/brain/src/memory-retriever.js','utf8'); if(!s.includes('CHAT_TOKEN_BUDGET = 2500')) throw new Error('missing'); console.log('ok');"

- [x] fetchMemoryContext 传入 CHAT_TOKEN_BUDGET（2500）
  Test: manual:node -e "const s=require('fs').readFileSync('packages/brain/src/orchestrator-chat.js','utf8'); if(!s.includes('CHAT_TOKEN_BUDGET')) throw new Error('missing'); console.log('ok');"

- [x] SOURCE_QUOTA conversation.max = 4
  Test: manual:npm run test --workspace packages/brain -- --run src/__tests__/memory-retriever-quota.test.js

- [x] SOURCE_QUOTA task.min = 2，quotaAwareSelect 保证最小配额
  Test: manual:npm run test --workspace packages/brain -- --run src/__tests__/memory-retriever-quota.test.js

- [x] SOURCE_QUOTA learning.min = 2，quotaAwareSelect 保证最小配额
  Test: manual:npm run test --workspace packages/brain -- --run src/__tests__/memory-retriever-quota.test.js

- [x] classifyQueryIntent 意图关键词分类正确（task/emotion/learning/default）
  Test: manual:npm run test --workspace packages/brain -- --run src/__tests__/memory-retriever-quota.test.js

- [x] 动态权重倍数 INTENT_WEIGHT_MULTIPLIER 正确配置
  Test: manual:npm run test --workspace packages/brain -- --run src/__tests__/memory-retriever-quota.test.js

- [x] 所有 Brain 测试通过（包含新增 29 个配额/权重测试）
  Test: manual:npm run test --workspace packages/brain -- --run src/__tests__/memory-retriever-quota.test.js

- [x] Brain patch 版本 bump 至 1.141.2
  Test: manual:node -e "const v=require('./packages/brain/package.json').version; if(v!=='1.141.2') throw new Error('version mismatch: '+v); console.log('ok');"
