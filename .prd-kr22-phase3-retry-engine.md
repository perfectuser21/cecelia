# PRD - Phase 3: 重试引擎与状态管理 - KR2.2

## 需求来源
任务来自 Brain 自动调度。功能描述：实现智能重试机制和发布状态管理 API，提升发布成功率。包含 3 个 Task: RetryEngine、状态管理 API、BullMQ 集成

## 功能描述
实现 KR2.2（统一发布引擎）的 Phase 3 核心功能，包括：

### 1. RetryEngine（重试引擎）
智能重试机制，处理发布失败场景：
- 失败检测：识别可重试的错误类型（网络超时、临时服务不可用等）
- 重试策略：指数退避（exponential backoff）算法，避免雪崩
- 重试限制：最大重试次数、超时时间配置
- 状态追踪：记录每次重试的结果和原因

### 2. 状态管理 API
提供发布状态查询和管理能力：
- GET /api/publish/status/:taskId - 查询任务状态
- GET /api/publish/tasks - 列出所有发布任务
- POST /api/publish/retry/:taskId - 手动触发重试
- PATCH /api/publish/cancel/:taskId - 取消发布任务
- WebSocket 推送：实时状态变更通知

### 3. BullMQ 集成
使用 BullMQ 管理发布队列：
- 任务队列：publish-queue（发布任务）、retry-queue（重试任务）
- 持久化：Redis 存储任务状态
- 并发控制：限制同时执行的发布任务数
- 优先级：支持任务优先级设置（P0/P1/P2）

## 涉及文件
**新建文件**：
- `backend/src/services/retry/RetryEngine.ts` - 重试引擎核心逻辑
- `backend/src/services/retry/strategies.ts` - 重试策略（指数退避等）
- `backend/src/services/publish/StateManager.ts` - 发布状态管理
- `backend/src/routes/publish.ts` - 发布 API 路由
- `backend/src/queues/publish-queue.ts` - BullMQ 发布队列配置
- `backend/src/types/publish.ts` - 发布相关类型定义

**修改文件**：
- `backend/src/server.ts` - 注册 publish 路由和队列
- `backend/package.json` - 添加 bullmq 和 ioredis 依赖
- `backend/src/config/redis.ts` - Redis 配置（如不存在则新建）

## 成功标准
- [ ] RetryEngine 能够检测可重试错误并执行指数退避重试
- [ ] 重试次数和间隔可配置（环境变量或配置文件）
- [ ] 状态管理 API 所有端点正常工作，返回正确数据格式
- [ ] BullMQ 队列正确配置，任务持久化到 Redis
- [ ] 并发控制生效：同时最多执行 N 个发布任务（N 可配置）
- [ ] WebSocket 能够推送状态变更事件
- [ ] 所有功能有对应的单元测试，覆盖率 > 80%
- [ ] API 文档更新（OpenAPI/Swagger）

## 非目标
- 不实现前端 UI（仅后端 API）
- 不实现完整的发布流程（Phase 4/5 负责）
- 不实现复杂的错误分类算法（使用简单的错误码/消息匹配）
- 不实现分布式锁（单节点场景，Redis 队列已足够）

## 技术约束
- 使用 TypeScript
- 使用 BullMQ 5.x（最新稳定版）
- Redis 6.x 或以上
- 遵循项目现有的代码风格和架构模式
