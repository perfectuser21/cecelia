# DoD - Progress Ledger inner loop

## 验收标准

### 数据库设计
- [ ] 创建迁移 087：progress_ledger 和 progress_ledger_review 表
      Test: packages/brain/migrations/087_progress_ledger.sql
- [ ] progress_ledger 表包含 18 个字段（task_id, run_id, step_sequence, step_name, step_type, status, started_at, completed_at, duration_ms, input_summary, output_summary, findings, error_code, error_message, retry_count, artifacts, metadata, confidence_score）
      Test: tests/progress-ledger.test.js
- [ ] progress_ledger_review 表包含 10 个字段（task_id, run_id, ledger_entry_id, tick_id, tick_number, review_action, review_reason, risk_assessment, ai_model, ai_decision）
      Test: tests/progress-ledger.test.js
- [ ] 创建 8 个索引和 2 个 SQL 视图（v_task_progress_summary, v_latest_progress_step）
      Test: tests/progress-ledger.test.js
- [ ] 迁移脚本正常执行并通过数据库完整性检查
      Test: contract:C2-001

### Progress Ledger 核心模块
- [ ] 创建 packages/brain/src/progress-ledger.js 包含 6 个核心函数
      Test: tests/progress-ledger.test.js
- [ ] recordProgressStep() 函数支持原子写入和冲突处理
      Test: tests/progress-ledger.test.js
- [ ] getTaskProgressSummary() 函数返回完成率和总耗时
      Test: tests/progress-ledger.test.js
- [ ] evaluateProgressInTick() 函数实现 3 类异常检测算法
      Test: tests/progress-ledger.test.js
- [ ] 所有函数有完整的 JSDoc 注释和错误处理
      Test: tests/progress-ledger.test.js

### Execution Callback 集成
- [ ] 在 routes.js execution-callback 原子操作中集成 recordProgressStep()
      Test: tests/routes.test.js
- [ ] execution-callback 支持 task_id 和 run_id 关联
      Test: tests/routes.test.js
- [ ] 错误处理不影响现有的任务状态更新流程
      Test: tests/routes.test.js

### Tick 循环集成
- [ ] 在 tick.js periodic cleanup 阶段集成 evaluateProgressInTick()
      Test: tests/tick.test.js
- [ ] Tick 评估每小时执行一次，与现有 CLEANUP_INTERVAL_MS 同步
      Test: tests/tick.test.js
- [ ] 评估结果写入 progress_ledger_review 表
      Test: tests/tick.test.js
- [ ] 高风险任务触发警觉度提升机制
      Test: tests/tick.test.js

### API 端点
- [ ] GET /api/brain/progress/:task_id 返回完整任务进展历史
      Test: tests/routes.test.js
- [ ] GET /api/brain/progress/latest?limit=20 返回最新进展步骤
      Test: tests/routes.test.js
- [ ] GET /api/brain/progress/anomalies?hours=1 返回异常任务列表
      Test: tests/routes.test.js
- [ ] POST /api/brain/progress/record 支持手动记录步骤（测试用）
      Test: tests/routes.test.js
- [ ] 所有 API 端点有适当的错误处理和输入验证
      Test: tests/routes.test.js

### 异常检测和策略调整
- [ ] 实现 3 类异常检测：进展停滞、步骤过慢、失败重试过多
      Test: tests/progress-ledger.test.js
- [ ] 异常检测算法使用可配置的时间阈值（默认：1h 停滞、2x 估计时间过慢、3 次重试上限）
      Test: tests/progress-ledger.test.js
- [ ] 高风险任务触发 alertnessResult.score += 10 机制
      Test: tests/tick.test.js
- [ ] 评估结果记录到 progress_ledger_review 表，包含 AI 决策理由
      Test: tests/progress-ledger.test.js

### 与现有系统兼容
- [ ] Progress Ledger 与现有 run_events 表共存，无冲突
      Test: tests/integration.test.js
- [ ] 不影响现有的 PR Plans 完成检查和 Initiative 闭环检查
      Test: tests/tick.test.js
- [ ] 与现有的健康监控（4 项 SQL 检查）协调工作
      Test: tests/tick.test.js
- [ ] 兼容现有的 trace.js SDK，支持 run_id 传递
      Test: tests/integration.test.js

### 测试覆盖
- [ ] progress-ledger.js 所有 6 个函数的单元测试，覆盖率 > 90%
      Test: tests/progress-ledger.test.js
- [ ] API 端点的单元测试，包含正常流程和错误场景
      Test: tests/routes.test.js
- [ ] Tick 集成的单元测试，验证评估逻辑
      Test: tests/tick.test.js
- [ ] 数据库迁移和索引的集成测试
      Test: tests/integration.test.js
- [ ] 端到端测试：Agent 完成任务 → 记录步骤 → Tick 评估 → 生成 Review
      Test: tests/e2e.test.js

### 文档和质量
- [ ] 所有函数有详细的 JSDoc 注释（包含参数、返回值、异常）
      Test: manual:代码审查
- [ ] DEFINITION.md 更新 Progress Ledger 相关架构说明
      Test: manual:文档检查
- [ ] 代码符合项目编码规范（ESLint 通过）
      Test: contract:C2-001
- [ ] npm run qa 完全通过，包含新增的测试用例
      Test: contract:C2-001

## 验收标准
所有 checkbox 都必须完成，且功能在本地环境测试通过。特别是数据库迁移必须能够在现有的 PostgreSQL 数据库上成功执行，不影响现有的 Brain 服务正常运行。