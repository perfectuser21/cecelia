---
id: dod-mmr-observability
version: 1.0.0
created: 2026-02-22
updated: 2026-02-22
changelog:
  - 1.0.0: 初始版本
---

# DoD: MMR 精排 + 可观测性 (Phase 3)

## 功能验收

| # | 验收条件 | Test |
|---|---------|------|
| 1 | mmrRerank() 替代 simpleDedup()，lambda=0.7 平衡相关性与多样性 | mmr-observability.test.js |
| 2 | mmrRerank 输出 topK 条结果，不超过候选总数 | mmr-observability.test.js |
| 3 | mmrRerank 空输入返回空数组 | mmr-observability.test.js |
| 4 | mmrRerank 高多样性：相似内容不同时出现在 top 结果 | mmr-observability.test.js |
| 5 | buildMemoryContext 使用 mmrRerank 替代 simpleDedup | mmr-observability.test.js |
| 6 | thalamus analyzeEvent 完成后写入 memory_retrieval 事件到 cecelia_events | mmr-observability.test.js |
| 7 | memory_retrieval 事件包含：query、mode、candidates_count、injected_count、token_used、token_budget、injected_sources | mmr-observability.test.js |
| 8 | 可观测性事件写入失败不影响 thalamus 决策主流程 | mmr-observability.test.js |
| 9 | simpleDedup 函数保留导出（向后兼容） | memory-retriever.test.js 回归 |

## 测试验收

| # | 验收条件 |
|---|---------|
| 1 | mmr-observability.test.js 所有测试通过 |
| 2 | memory-retriever.test.js 回归测试全部通过 |
| 3 | thalamus.test.js 回归测试全部通过 |
| 4 | thalamus-memory-injection.test.js 回归测试全部通过 |
