---
id: quality-activation
version: 1.0.0
created: 2026-01-29
updated: 2026-01-29
changelog:
  - 1.0.0: 初始版本
---

# PRD: Quality 激活计划 - 让质检系统真正运作起来

## 背景

当前 Quality 系统只是一个"静态注册表"：
- 有 `repo-registry.yaml` 但没有 API 暴露
- 有 `contracts/*.yaml` 但没有执行机制
- 各仓库 CI 独立运行，不经过 Quality
- 没有自动发现、没有统一入口、没有结果聚合

**现状**：7 个 Git 仓库，只有 3 个手动注册，Quality 形同虚设。

## 目标

让 Quality 成为**真正的中央质检平台**：

```
任何仓库 PR → 触发 Quality → 执行 RCI 检查 → 统一报告
```

## 功能模块

### M1: Registry API（仓库注册）

暴露 `repo-registry.yaml` 为 API：

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/repos` | GET | 列出所有已注册仓库 |
| `/api/repos/:id` | GET | 获取单个仓库详情 |
| `/api/repos` | POST | 注册新仓库 |
| `/api/repos/:id` | DELETE | 移除仓库 |
| `/api/repos/discover` | POST | 自动发现本地仓库 |

**自动发现逻辑**：
```javascript
// 扫描 /home/xx/dev/ 下所有 .git 目录
// 检查是否已注册
// 返回未注册列表，支持一键注册
```

### M2: Contract API（契约管理）

暴露 `contracts/*.yaml` 为 API：

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/contracts` | GET | 列出所有契约 |
| `/api/contracts/:repoId` | GET | 获取仓库的 RCI 列表 |
| `/api/contracts/:repoId/rci/:rciId` | GET | 获取单个 RCI 详情 |
| `/api/contracts/:repoId` | PUT | 更新仓库契约 |

### M3: Execution Engine（执行引擎）

**核心功能**：远程执行 RCI 检查

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/execute` | POST | 触发仓库质检 |
| `/api/execute/all` | POST | 触发全量质检 |
| `/api/execute/:runId` | GET | 获取执行状态 |

**执行流程**：
```
POST /api/execute { repoId: "cecelia-semantic-brain" }
    ↓
Quality 读取 repo-registry.yaml 找到仓库路径
    ↓
Quality 读取 contracts/cecelia-semantic-brain.regression-contract.yaml
    ↓
Quality 在仓库目录执行: PYTHONPATH=. pytest tests/ -v
    ↓
Quality 收集结果，映射到 RCI
    ↓
返回 { runId, status, rciResults: [...] }
```

### M4: Webhook 接入（CI 集成）

让各仓库 CI 触发 Quality：

| 端点 | 方法 | 功能 |
|------|------|------|
| `/webhook/ci` | POST | 接收 GitHub Actions 回调 |
| `/webhook/pr` | POST | 接收 PR 事件 |

**GitHub Actions 集成**（各仓库添加）：
```yaml
# .github/workflows/ci.yml
- name: Notify Quality
  if: always()
  run: |
    curl -X POST http://quality-server:5681/webhook/ci \
      -H "Content-Type: application/json" \
      -d '{
        "repo": "${{ github.repository }}",
        "branch": "${{ github.ref_name }}",
        "sha": "${{ github.sha }}",
        "status": "${{ job.status }}",
        "run_id": "${{ github.run_id }}"
      }'
```

### M5: Dashboard 数据（前端支持）

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/dashboard/overview` | GET | 所有仓库健康概览 |
| `/api/dashboard/repo/:id` | GET | 单仓库详情 |
| `/api/dashboard/history` | GET | 历史趋势 |

**Overview 返回**：
```json
{
  "repos": [
    {
      "id": "cecelia-semantic-brain",
      "name": "Cecelia Semantic Brain",
      "health": "green",
      "lastRun": "2026-01-29T07:18:13Z",
      "rciTotal": 9,
      "rciPassed": 9,
      "rciFailed": 0
    }
  ],
  "summary": {
    "totalRepos": 7,
    "healthyRepos": 5,
    "failingRepos": 2,
    "lastFullScan": "2026-01-29T06:00:00Z"
  }
}
```

## 实现优先级

| 阶段 | 模块 | 说明 |
|------|------|------|
| **P0** | M1 Registry API | 先让注册表可用 |
| **P0** | M2 Contract API | 让契约可查询 |
| **P1** | M3 Execution Engine | 核心：能执行检查 |
| **P1** | M5 Dashboard 数据 | 前端能展示 |
| **P2** | M4 Webhook 接入 | CI 自动触发 |

## 验收标准

### P0 验收
1. `GET /api/repos` 返回所有注册仓库
2. `POST /api/repos/discover` 能发现未注册仓库
3. `GET /api/contracts/cecelia-semantic-brain` 返回 9 个 RCI

### P1 验收
1. `POST /api/execute { repoId: "cecelia-semantic-brain" }` 能触发测试
2. 执行完成后返回每个 RCI 的 pass/fail 状态
3. `GET /api/dashboard/overview` 返回所有仓库健康状态

### P2 验收
1. 各仓库 CI 添加 webhook 通知
2. Quality 接收并记录 CI 结果
3. Dashboard 展示实时状态

## 技术约束

- API 框架：Express.js（已有）
- 数据存储：YAML 文件 + JSON 状态文件（保持简单）
- 执行方式：子进程 spawn（本地执行）
- 端口：5681（API）/ 5680（Gateway）

## 文件变更预估

```
api/server.js           - 添加 M1/M2/M3/M5 端点
api/lib/registry.js     - 新建：Registry 操作
api/lib/contracts.js    - 新建：Contract 操作
api/lib/executor.js     - 新建：执行引擎
api/lib/dashboard.js    - 新建：Dashboard 聚合
```

## 成功指标

Quality 激活后：
- [ ] 所有 7 个仓库都注册到 Quality
- [ ] 任意仓库可通过 API 触发质检
- [ ] Dashboard 能看到全局健康状态
- [ ] CI 失败时 Quality 有记录
