---
id: prd-kr22-unified-publish-impl
version: 1.0.0
created: 2026-02-06
updated: 2026-02-06
changelog:
  - 1.0.0: Initial PRD for KR2.2 implementation
---

# PRD - KR2.2: 统一发布引擎核心实现

## 需求来源

**任务来源**: Brain 自动调度 (Retry 任务)
**任务类型**: dev - 核心功能实现
**前置工作**: 技术调研已完成 (docs/research/KR22-UNIFIED-PUBLISH-ENGINE.md)

## 背景

根据技术调研文档,KR2.2 目标是建立统一发布引擎,实现一键发布功能,成功率达到 95% 以上。调研阶段已完成架构设计、技术选型和实现路线规划。

本任务实现**核心基础架构**（Phase 1-2 的关键部分），为后续完整实现奠定基础。

## 目标项目与决策

**当前位置**: `cecelia-core` 项目 (worktree)
**目标项目**: `/home/xx/dev/zenithjoy-autopilot`

**决策**: 本任务在 `cecelia-core` 创建**跨项目协调文档和接口定义**，实际实现代码在 `zenithjoy-autopilot` 项目中完成。

### 为什么在 cecelia-core？

根据 CLAUDE.md 架构：
- Cecelia = 管家系统，负责任务调度和协调
- ZenithJoy = 业务系统，包含实际业务逻辑

本次在 cecelia-core 完成：
1. **任务协调文档**: 记录 KR2.2 实现任务的规划
2. **接口定义**: 定义 Cecelia Brain 如何调度发布任务
3. **集成方案**: 说明 Cecelia 如何与 ZenithJoy Publish Engine 集成

实际的 Publish Engine 代码将在后续任务中在 zenithjoy-autopilot 实现。

## 功能描述

基于技术调研文档 (docs/research/KR22-UNIFIED-PUBLISH-ENGINE.md)，本任务创建**实现规划和集成文档**:

### 1. KR2.2 实现工作流文档

创建详细的实现工作流文档，记录:
- Phase 划分和每个 Phase 的具体任务
- 每个任务的负责人和时间估算
- 任务间的依赖关系
- 验收标准和测试计划

**位置**: `docs/workflows/KR22_IMPLEMENTATION_WORKFLOW.md`

### 2. Cecelia-ZenithJoy 集成接口定义

定义 Cecelia Brain 如何调度 ZenithJoy Publish Engine:
- Brain 如何触发发布任务
- 状态查询和回调机制
- 失败处理和重试策略
- 监控和告警集成

**位置**: `docs/AGENT_ROUTING.md` (更新现有文档)

### 3. 数据库 Schema 准备文档

准备数据库迁移脚本的文档:
- 完整的 SQL 迁移脚本 (基于调研文档 Section 3.1.2)
- 索引优化说明
- 数据迁移计划 (如果有现有数据)
- 回滚脚本

**位置**: `docs/database/KR22_PUBLISH_ENGINE_SCHEMA.md`

### 4. 后续任务创建

在 Cecelia Tasks 系统中创建后续实现任务:
- Task 1: 在 zenithjoy-autopilot 实现数据库 Schema
- Task 2: 实现 Platform Adapter 接口和 DouyinAdapter
- Task 3: 实现 Retry Engine
- Task 4: 实现状态管理 API
- Task 5: 集成测试和部署

**执行方式**: 通过 Cecelia Brain API 创建任务

## 涉及文件

### 新增文件 (在 cecelia-core)

```
cecelia-core/
├── docs/
│   ├── workflows/
│   │   └── KR22_IMPLEMENTATION_WORKFLOW.md  # 实现工作流
│   └── database/
│       └── KR22_PUBLISH_ENGINE_SCHEMA.md    # 数据库 Schema 文档
```

### 修改文件 (在 cecelia-core)

```
cecelia-core/
├── docs/
│   └── AGENT_ROUTING.md  # 添加 Publish Engine 路由规则
└── docs/research/
    └── KR22-UNIFIED-PUBLISH-ENGINE.md  # 引用和关联
```

## 非目标 (Not in Scope)

本次任务**不包括**:
- ❌ 在 zenithjoy-autopilot 中实际编写代码 (后续任务)
- ❌ 数据库迁移脚本的实际执行 (后续任务)
- ❌ API 端点的实际实现 (后续任务)
- ❌ 测试代码的编写 (后续任务)
- ❌ 部署和上线 (后续任务)

**本次只做**:
- ✅ 文档和规划
- ✅ 接口定义
- ✅ 任务拆分
- ✅ 集成方案设计

## 成功标准 (DoD)

### 文档验收

- [ ] KR22_IMPLEMENTATION_WORKFLOW.md 包含完整的 5 个 Phase 任务分解
- [ ] 每个 Phase 有明确的负责人、时间估算、验收标准
- [ ] KR22_PUBLISH_ENGINE_SCHEMA.md 包含完整的 SQL 迁移脚本
- [ ] Schema 文档包含索引优化和回滚脚本
- [ ] AGENT_ROUTING.md 更新了 Publish Engine 的路由规则

### 集成方案验收

- [ ] 定义了 Cecelia Brain 如何触发发布任务的 API 接口
- [ ] 定义了状态查询和回调机制
- [ ] 定义了失败处理和重试策略
- [ ] 定义了监控和告警集成方案

### 任务创建验收

- [ ] 在 Cecelia Tasks 系统中创建了至少 5 个后续任务
- [ ] 每个任务有明确的 title、description、priority
- [ ] 任务之间的依赖关系已正确设置
- [ ] 任务关联到正确的 Goal (KR2.2)

### 质量验收

- [ ] 所有文档通过 Markdown lint
- [ ] 所有文档有版本号和 changelog
- [ ] SQL 脚本语法正确 (通过 pg 语法检查)
- [ ] 通过代码审计 (Audit Report)

## 技术约束

### 文档规范

- 所有文档使用 Markdown 格式
- 文档包含 frontmatter (version, created, updated, changelog)
- SQL 脚本使用 PostgreSQL 15+ 语法
- 代码示例使用 TypeScript

### API 规范

- RESTful API 设计原则
- 使用 JSON 格式
- HTTP 状态码标准化
- 错误响应统一格式

### 数据库规范

- 使用 UUID 作为主键
- 表名使用 snake_case
- 索引命名: `idx_<table>_<column>`
- 外键命名: `fk_<table>_<ref_table>`

## 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 文档与实际实现不一致 | Medium | 后续实现时持续更新文档 |
| 任务估时不准确 | Medium | 使用保守估算，留 20% 缓冲 |
| 跨项目协调困难 | Low | 明确接口定义，减少依赖 |
| SQL 脚本在实际环境执行失败 | Low | 提供测试脚本，验证语法 |

## 验证方式

### 文档完整性验证

```bash
# 检查所有文档是否存在
ls -la docs/workflows/KR22_IMPLEMENTATION_WORKFLOW.md
ls -la docs/database/KR22_PUBLISH_ENGINE_SCHEMA.md

# 检查文档格式
markdownlint docs/workflows/KR22_IMPLEMENTATION_WORKFLOW.md
markdownlint docs/database/KR22_PUBLISH_ENGINE_SCHEMA.md
```

### SQL 语法验证

```bash
# 使用 psql 验证 SQL 脚本语法
psql -U postgres -d test_db --dry-run -f docs/database/KR22_PUBLISH_ENGINE_SCHEMA.md
```

### 任务创建验证

```bash
# 查询 Cecelia Tasks API 确认任务已创建
curl -s http://localhost:5221/api/tasks/tasks | jq '.[] | select(.title | contains("KR2.2"))'

# 验证任务关联到正确的 Goal
curl -s http://localhost:5221/api/tasks/goals | jq '.[] | select(.title | contains("KR2.2"))'
```

## 参考资料

- **技术设计文档**: docs/research/KR22-UNIFIED-PUBLISH-ENGINE.md
- **学习记录**: docs/LEARNING-KR22-RESEARCH.md
- **审计报告**: docs/AUDIT-REPORT-KR22-RESEARCH.md

## 下一步 (后续迭代)

完成本 PRD 的文档和规划后，后续任务:

### Phase 1: 数据库基础 (2 周)
- Task 1.1: 在 zenithjoy-autopilot 创建数据库迁移脚本
- Task 1.2: 执行迁移并验证表结构

### Phase 2: 接口实现 (3 周)
- Task 2.1: 实现 Platform Adapter 接口和基类
- Task 2.2: 实现 DouyinAdapter
- Task 2.3: 实现重试引擎

### Phase 3: API 层 (2 周)
- Task 3.1: 实现状态管理 API (CRUD)
- Task 3.2: 集成 BullMQ 任务队列

### Phase 4: 测试和监控 (2 周)
- Task 4.1: 编写单元测试和集成测试
- Task 4.2: 添加 Prometheus 监控

### Phase 5: 扩展和优化 (3 周)
- Task 5.1: 实现小红书、微博 Adapter
- Task 5.2: 熔断器和死信队列
- Task 5.3: E2E 测试和压力测试

## 关键决策

### 决策 1: 任务范围调整

**问题**: 当前在 cecelia-core worktree，但 KR2.2 属于 zenithjoy 项目
**决策**: 本次只做文档和规划，不写实际代码
**理由**:
- 避免跨项目混乱
- 清晰的职责分离
- 为后续实现提供明确指导

### 决策 2: 使用 Cecelia Tasks 系统管理后续任务

**问题**: 如何追踪 KR2.2 的 10 周实现进度？
**决策**: 创建 5 个 Phase 对应的任务，关联到 KR2.2 Goal
**理由**:
- 利用现有的任务管理系统
- 可视化进度追踪
- 支持自动调度

---

**PRD 状态**: Draft
**审核状态**: Pending
**批准人**: 待定
**实现优先级**: P0 (核心功能)
