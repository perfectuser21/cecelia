---
id: prd-fix-brain-proxy-order
version: 1.0.0
created: 2026-02-25
updated: 2026-02-25
changelog:
  - 1.0.0: 初始版本
---

# PRD: 修复 Brain Proxy 中间件顺序

## 问题

`apps/api/src/dashboard/server.ts` 中 Brain proxy (`/api/brain`) 注册在 `express.json()` 之后，
导致 request body stream 被 body parser 消费，http-proxy-middleware 无法转发请求体，返回 504。

## 根因

Express 中间件执行顺序：
1. compression, CORS
2. quality/orchestrator/autumnrice proxy（在 express.json 之前 ✅）
3. `express.json()` ← 消费 body stream
4. brain proxy ← body stream 已空，POST/PUT 请求 504 ❌

## 修复方案

将 brain proxy 移到 `express.json()` 之前，与其他 proxy 放在一起。
移除 `proxyReq` body rewrite hack（不再需要）。

## 成功标准

- `curl localhost:5211/api/brain/tick/status` 返回 200（不再 504）
- `curl -X POST localhost:5211/api/brain/tick` 能正常转发
- WebSocket `/api/brain/ws` 仍然工作
- 其他 proxy（quality, orchestrator, autumnrice）不受影响
