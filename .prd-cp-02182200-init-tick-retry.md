---
id: prd-cp-02182200-init-tick-retry
version: 1.0.0
created: 2026-02-18
updated: 2026-02-18
changelog:
  - 1.0.0: 初始版本
---

# PRD: Tick 启动失败后台自动重试

## 目标
当 initTickLoop() 所有重试耗尽仍失败时，不能就此放弃 — 启动一个后台定时器，每隔 N 分钟继续尝试启动 tick loop。

## 当前问题
initTickLoop 最多重试 3 次后放弃，发出 init_failed 事件后系统进入「Tick 永久不可用」状态，除非人工重启 Brain 进程。

## 实现内容

### 后台恢复机制
在 initTickLoop 所有重试耗尽后，启动后台恢复 loop：

```js
const INIT_RECOVERY_INTERVAL_MS = parseInt(
  process.env.CECELIA_INIT_RECOVERY_INTERVAL_MS || String(5 * 60 * 1000)
);

setInterval(async () => {
  if (_loopTimer) return; // 已经启动，停止恢复
  await tryRecoverTickLoop();
}, INIT_RECOVERY_INTERVAL_MS);
```

### 恢复状态记录
写入 working_memory recovery_attempts 字段，记录恢复历史。

## 测试要求
- [ ] 所有重试耗尽后，后台恢复 timer 被注册
- [ ] 恢复成功后停止后台 timer
- [ ] 恢复尝试历史可通过 API 查询
- [ ] CECELIA_INIT_RECOVERY_INTERVAL_MS 环境变量可配置
