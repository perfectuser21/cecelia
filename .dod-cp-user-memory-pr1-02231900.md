---
id: dod-user-memory-pr1
version: 1.0.0
created: 2026-02-23
updated: 2026-02-23
---

# DoD：Cecelia 用户记忆系统 PR1

## 验收清单

### D1：Migration 065 — user_profiles 表
- [ ] `brain/migrations/065_user_profiles.sql` 存在
- [ ] 包含 `user_profiles` 表 DDL（id, user_id UNIQUE, display_name, focus_area, preferred_style, timezone, raw_facts, timestamps）
- [ ] 包含种子数据：owner / 徐啸 Alex Xu / Cecelia / detailed / Asia/Shanghai
- [ ] `EXPECTED_SCHEMA_VERSION` 更新为 `'065'`
- [ ] Test：schema 版本一致性测试通过

### D2：user-profile.js 模块
- [ ] `brain/src/user-profile.js` 存在
- [ ] `loadUserProfile(pool, userId)` — 返回 profile 对象或 null
- [ ] `upsertUserProfile(pool, userId, facts)` — 合并更新，不覆盖空字段
- [ ] `extractAndSaveUserFacts(pool, userId, messages, reply)` — 调 MiniMax 提取事实后 upsert
- [ ] Test：D2-1 loadUserProfile 有数据时返回正确对象，D2-2 没有数据时返回 null，D2-3 upsert 合并逻辑正确

### D3：memory-retriever.js 注入用户画像
- [ ] `loadActiveProfile()` 在 Profile 层同时加载 user_profiles
- [ ] 格式化为：`你正在和 {display_name} 对话。TA 目前的重点方向是：{focus_area}。...`
- [ ] owner 无 profile 时降级（不注入，不报错）
- [ ] Test：D3-1 有 profile 时 block 包含用户姓名，D3-2 无 profile 时 block 不含 "正在和" 片段

### D4：orchestrator-chat.js 对话后学习钩子
- [ ] `handleChat()` 在 `recordChatEvent` 之后触发 fire-and-forget 提取
- [ ] 使用 `setImmediate` 或 `Promise.resolve().then()`，不 await，不阻塞 chat 响应
- [ ] 提取失败不影响 chat 返回值
- [ ] Test：D4-1 handleChat 返回时钩子已入队（不等待完成），D4-2 提取失败时 handleChat 仍正常返回

### D5：API 端点
- [ ] `GET /api/brain/user/profile` 返回 `{ profile: {...} }` 或 `{ profile: null }`
- [ ] `PUT /api/brain/user/profile` 接受 `{ display_name, focus_area, preferred_style, timezone }` 更新
- [ ] Test：D5-1 GET 返回 owner profile，D5-2 PUT 更新后 GET 可读到新值

## 排除范围
- 不测试 MiniMax 实际调用（mock 即可）
- 不测试 workspace 前端
