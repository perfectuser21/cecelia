## DoD: 集成 Pre-flight Checks

### 验收标准

#### 1. dispatchNextTask() 集成 Pre-flight Check
- [ ] dispatchNextTask() 在派发前调用 preFlightCheck()
  - Test: 单元测试验证 preFlightCheck 被调用
  - Evidence: `brain/tick.test.js` 或集成测试

- [ ] Pre-flight Check 失败时不派发任务
  - Test: 单元测试模拟 checkResult.passed = false
  - Evidence: 测试验证 dispatched = false

#### 2. 失败任务记录到 metadata
- [ ] Pre-flight Check 失败时更新 task.metadata
  - Test: 单元测试验证 UPDATE tasks SQL 被执行
  - Evidence: metadata 包含 pre_flight_failed、issues、suggestions、failed_at

- [ ] metadata 格式正确
  - Test: JSON 格式验证测试
  - Evidence: metadata 可被正确解析

#### 3. 返回值正确
- [ ] Pre-flight Check 失败时返回 { dispatched: false, reason: 'pre_flight_check_failed', issues }
  - Test: 单元测试验证返回值格式
  - Evidence: 测试覆盖所有返回字段

#### 4. 统计指标记录（可选）
- [ ] 记录 Pre-flight Check 统计到 working_memory
  - Test: 验证统计数据写入
  - Evidence: working_memory 包含通过率、失败原因分布

#### 5. CI 检查
- [ ] 所有测试通过
  - Test: npm run qa
  - Evidence: CI 成功

- [ ] 代码覆盖率满足要求
  - Test: Coverage report
  - Evidence: 新代码覆盖率 > 80%

### 验证方式

#### 手动测试
```bash
# 1. 创建一个低质量任务
curl -X POST http://localhost:5221/api/brain/tasks \
  -H "Content-Type: application/json" \
  -d '{"title": "test task", "description": "x"}'

# 2. 触发 tick
curl -X POST http://localhost:5221/api/brain/tick

# 3. 验证任务未被派发
curl http://localhost:5221/api/brain/tasks?status=queued

# 4. 验证 metadata 记录了失败原因
curl http://localhost:5221/api/brain/tasks/<id> | jq '.metadata'
```

#### 自动化测试
- 单元测试：brain/tick.test.js 或新建测试文件
- 集成测试：end-to-end 测试验证完整流程

### 非目标
- 不修改 preFlightCheck() 内部逻辑
- 不修改任务创建流程
- 不影响现有派发逻辑（Pre-flight Check 通过时）
